(function(){const u=document.createElement("link").relList;if(u&&u.supports&&u.supports("modulepreload"))return;for(const A of document.querySelectorAll('link[rel="modulepreload"]'))E(A);new MutationObserver(A=>{for(const z of A)if(z.type==="childList")for(const U of z.addedNodes)U.tagName==="LINK"&&U.rel==="modulepreload"&&E(U)}).observe(document,{childList:!0,subtree:!0});function m(A){const z={};return A.integrity&&(z.integrity=A.integrity),A.referrerPolicy&&(z.referrerPolicy=A.referrerPolicy),A.crossOrigin==="use-credentials"?z.credentials="include":A.crossOrigin==="anonymous"?z.credentials="omit":z.credentials="same-origin",z}function E(A){if(A.ep)return;A.ep=!0;const z=m(A);fetch(A.href,z)}})();function J2(x){return x&&x.__esModule&&Object.prototype.hasOwnProperty.call(x,"default")?x.default:x}var z0={exports:{}},a_={},F0={exports:{}},Dr={};/**
 * @license React
 * react.production.min.js
 *
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var Vb;function uA(){if(Vb)return Dr;Vb=1;var x=Symbol.for("react.element"),u=Symbol.for("react.portal"),m=Symbol.for("react.fragment"),E=Symbol.for("react.strict_mode"),A=Symbol.for("react.profiler"),z=Symbol.for("react.provider"),U=Symbol.for("react.context"),s=Symbol.for("react.forward_ref"),ee=Symbol.for("react.suspense"),ne=Symbol.for("react.memo"),Ie=Symbol.for("react.lazy"),qe=Symbol.iterator;function Xe(Qe){return Qe===null||typeof Qe!="object"?null:(Qe=qe&&Qe[qe]||Qe["@@iterator"],typeof Qe=="function"?Qe:null)}var St={isMounted:function(){return!1},enqueueForceUpdate:function(){},enqueueReplaceState:function(){},enqueueSetState:function(){}},$t=Object.assign,ct={};function wt(Qe,Gt,ji){this.props=Qe,this.context=Gt,this.refs=ct,this.updater=ji||St}wt.prototype.isReactComponent={},wt.prototype.setState=function(Qe,Gt){if(typeof Qe!="object"&&typeof Qe!="function"&&Qe!=null)throw Error("setState(...): takes an object of state variables to update or a function which returns an object of state variables.");this.updater.enqueueSetState(this,Qe,Gt,"setState")},wt.prototype.forceUpdate=function(Qe){this.updater.enqueueForceUpdate(this,Qe,"forceUpdate")};function Nt(){}Nt.prototype=wt.prototype;function Ti(Qe,Gt,ji){this.props=Qe,this.context=Gt,this.refs=ct,this.updater=ji||St}var Ei=Ti.prototype=new Nt;Ei.constructor=Ti,$t(Ei,wt.prototype),Ei.isPureReactComponent=!0;var en=Array.isArray,Hn=Object.prototype.hasOwnProperty,_n={current:null},rt={key:!0,ref:!0,__self:!0,__source:!0};function De(Qe,Gt,ji){var Un,zn={},zi=null,Ji=null;if(Gt!=null)for(Un in Gt.ref!==void 0&&(Ji=Gt.ref),Gt.key!==void 0&&(zi=""+Gt.key),Gt)Hn.call(Gt,Un)&&!rt.hasOwnProperty(Un)&&(zn[Un]=Gt[Un]);var on=arguments.length-2;if(on===1)zn.children=ji;else if(1<on){for(var er=Array(on),Pn=0;Pn<on;Pn++)er[Pn]=arguments[Pn+2];zn.children=er}if(Qe&&Qe.defaultProps)for(Un in on=Qe.defaultProps,on)zn[Un]===void 0&&(zn[Un]=on[Un]);return{$$typeof:x,type:Qe,key:zi,ref:Ji,props:zn,_owner:_n.current}}function je(Qe,Gt){return{$$typeof:x,type:Qe.type,key:Gt,ref:Qe.ref,props:Qe.props,_owner:Qe._owner}}function Ke(Qe){return typeof Qe=="object"&&Qe!==null&&Qe.$$typeof===x}function We(Qe){var Gt={"=":"=0",":":"=2"};return"$"+Qe.replace(/[=:]/g,function(ji){return Gt[ji]})}var ut=/\/+/g;function Oe(Qe,Gt){return typeof Qe=="object"&&Qe!==null&&Qe.key!=null?We(""+Qe.key):Gt.toString(36)}function kn(Qe,Gt,ji,Un,zn){var zi=typeof Qe;(zi==="undefined"||zi==="boolean")&&(Qe=null);var Ji=!1;if(Qe===null)Ji=!0;else switch(zi){case"string":case"number":Ji=!0;break;case"object":switch(Qe.$$typeof){case x:case u:Ji=!0}}if(Ji)return Ji=Qe,zn=zn(Ji),Qe=Un===""?"."+Oe(Ji,0):Un,en(zn)?(ji="",Qe!=null&&(ji=Qe.replace(ut,"$&/")+"/"),kn(zn,Gt,ji,"",function(Pn){return Pn})):zn!=null&&(Ke(zn)&&(zn=je(zn,ji+(!zn.key||Ji&&Ji.key===zn.key?"":(""+zn.key).replace(ut,"$&/")+"/")+Qe)),Gt.push(zn)),1;if(Ji=0,Un=Un===""?".":Un+":",en(Qe))for(var on=0;on<Qe.length;on++){zi=Qe[on];var er=Un+Oe(zi,on);Ji+=kn(zi,Gt,ji,er,zn)}else if(er=Xe(Qe),typeof er=="function")for(Qe=er.call(Qe),on=0;!(zi=Qe.next()).done;)zi=zi.value,er=Un+Oe(zi,on++),Ji+=kn(zi,Gt,ji,er,zn);else if(zi==="object")throw Gt=String(Qe),Error("Objects are not valid as a React child (found: "+(Gt==="[object Object]"?"object with keys {"+Object.keys(Qe).join(", ")+"}":Gt)+"). If you meant to render a collection of children, use an array instead.");return Ji}function $n(Qe,Gt,ji){if(Qe==null)return Qe;var Un=[],zn=0;return kn(Qe,Un,"","",function(zi){return Gt.call(ji,zi,zn++)}),Un}function wn(Qe){if(Qe._status===-1){var Gt=Qe._result;Gt=Gt(),Gt.then(function(ji){(Qe._status===0||Qe._status===-1)&&(Qe._status=1,Qe._result=ji)},function(ji){(Qe._status===0||Qe._status===-1)&&(Qe._status=2,Qe._result=ji)}),Qe._status===-1&&(Qe._status=0,Qe._result=Gt)}if(Qe._status===1)return Qe._result.default;throw Qe._result}var Gn={current:null},wi={transition:null},Ui={ReactCurrentDispatcher:Gn,ReactCurrentBatchConfig:wi,ReactCurrentOwner:_n};function Ai(){throw Error("act(...) is not supported in production builds of React.")}return Dr.Children={map:$n,forEach:function(Qe,Gt,ji){$n(Qe,function(){Gt.apply(this,arguments)},ji)},count:function(Qe){var Gt=0;return $n(Qe,function(){Gt++}),Gt},toArray:function(Qe){return $n(Qe,function(Gt){return Gt})||[]},only:function(Qe){if(!Ke(Qe))throw Error("React.Children.only expected to receive a single React element child.");return Qe}},Dr.Component=wt,Dr.Fragment=m,Dr.Profiler=A,Dr.PureComponent=Ti,Dr.StrictMode=E,Dr.Suspense=ee,Dr.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED=Ui,Dr.act=Ai,Dr.cloneElement=function(Qe,Gt,ji){if(Qe==null)throw Error("React.cloneElement(...): The argument must be a React element, but you passed "+Qe+".");var Un=$t({},Qe.props),zn=Qe.key,zi=Qe.ref,Ji=Qe._owner;if(Gt!=null){if(Gt.ref!==void 0&&(zi=Gt.ref,Ji=_n.current),Gt.key!==void 0&&(zn=""+Gt.key),Qe.type&&Qe.type.defaultProps)var on=Qe.type.defaultProps;for(er in Gt)Hn.call(Gt,er)&&!rt.hasOwnProperty(er)&&(Un[er]=Gt[er]===void 0&&on!==void 0?on[er]:Gt[er])}var er=arguments.length-2;if(er===1)Un.children=ji;else if(1<er){on=Array(er);for(var Pn=0;Pn<er;Pn++)on[Pn]=arguments[Pn+2];Un.children=on}return{$$typeof:x,type:Qe.type,key:zn,ref:zi,props:Un,_owner:Ji}},Dr.createContext=function(Qe){return Qe={$$typeof:U,_currentValue:Qe,_currentValue2:Qe,_threadCount:0,Provider:null,Consumer:null,_defaultValue:null,_globalName:null},Qe.Provider={$$typeof:z,_context:Qe},Qe.Consumer=Qe},Dr.createElement=De,Dr.createFactory=function(Qe){var Gt=De.bind(null,Qe);return Gt.type=Qe,Gt},Dr.createRef=function(){return{current:null}},Dr.forwardRef=function(Qe){return{$$typeof:s,render:Qe}},Dr.isValidElement=Ke,Dr.lazy=function(Qe){return{$$typeof:Ie,_payload:{_status:-1,_result:Qe},_init:wn}},Dr.memo=function(Qe,Gt){return{$$typeof:ne,type:Qe,compare:Gt===void 0?null:Gt}},Dr.startTransition=function(Qe){var Gt=wi.transition;wi.transition={};try{Qe()}finally{wi.transition=Gt}},Dr.unstable_act=Ai,Dr.useCallback=function(Qe,Gt){return Gn.current.useCallback(Qe,Gt)},Dr.useContext=function(Qe){return Gn.current.useContext(Qe)},Dr.useDebugValue=function(){},Dr.useDeferredValue=function(Qe){return Gn.current.useDeferredValue(Qe)},Dr.useEffect=function(Qe,Gt){return Gn.current.useEffect(Qe,Gt)},Dr.useId=function(){return Gn.current.useId()},Dr.useImperativeHandle=function(Qe,Gt,ji){return Gn.current.useImperativeHandle(Qe,Gt,ji)},Dr.useInsertionEffect=function(Qe,Gt){return Gn.current.useInsertionEffect(Qe,Gt)},Dr.useLayoutEffect=function(Qe,Gt){return Gn.current.useLayoutEffect(Qe,Gt)},Dr.useMemo=function(Qe,Gt){return Gn.current.useMemo(Qe,Gt)},Dr.useReducer=function(Qe,Gt,ji){return Gn.current.useReducer(Qe,Gt,ji)},Dr.useRef=function(Qe){return Gn.current.useRef(Qe)},Dr.useState=function(Qe){return Gn.current.useState(Qe)},Dr.useSyncExternalStore=function(Qe,Gt,ji){return Gn.current.useSyncExternalStore(Qe,Gt,ji)},Dr.useTransition=function(){return Gn.current.useTransition()},Dr.version="18.3.1",Dr}var Ub;function wv(){return Ub||(Ub=1,F0.exports=uA()),F0.exports}/**
 * @license React
 * react-jsx-runtime.production.min.js
 *
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var jb;function hA(){if(jb)return a_;jb=1;var x=wv(),u=Symbol.for("react.element"),m=Symbol.for("react.fragment"),E=Object.prototype.hasOwnProperty,A=x.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.ReactCurrentOwner,z={key:!0,ref:!0,__self:!0,__source:!0};function U(s,ee,ne){var Ie,qe={},Xe=null,St=null;ne!==void 0&&(Xe=""+ne),ee.key!==void 0&&(Xe=""+ee.key),ee.ref!==void 0&&(St=ee.ref);for(Ie in ee)E.call(ee,Ie)&&!z.hasOwnProperty(Ie)&&(qe[Ie]=ee[Ie]);if(s&&s.defaultProps)for(Ie in ee=s.defaultProps,ee)qe[Ie]===void 0&&(qe[Ie]=ee[Ie]);return{$$typeof:u,type:s,key:Xe,ref:St,props:qe,_owner:A.current}}return a_.Fragment=m,a_.jsx=U,a_.jsxs=U,a_}var Gb;function dA(){return Gb||(Gb=1,z0.exports=hA()),z0.exports}var ii=dA(),Ot=wv(),Dg={},O0={exports:{}},Yl={},B0={exports:{}},N0={};/**
 * @license React
 * scheduler.production.min.js
 *
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var Hb;function fA(){return Hb||(Hb=1,(function(x){function u(wi,Ui){var Ai=wi.length;wi.push(Ui);e:for(;0<Ai;){var Qe=Ai-1>>>1,Gt=wi[Qe];if(0<A(Gt,Ui))wi[Qe]=Ui,wi[Ai]=Gt,Ai=Qe;else break e}}function m(wi){return wi.length===0?null:wi[0]}function E(wi){if(wi.length===0)return null;var Ui=wi[0],Ai=wi.pop();if(Ai!==Ui){wi[0]=Ai;e:for(var Qe=0,Gt=wi.length,ji=Gt>>>1;Qe<ji;){var Un=2*(Qe+1)-1,zn=wi[Un],zi=Un+1,Ji=wi[zi];if(0>A(zn,Ai))zi<Gt&&0>A(Ji,zn)?(wi[Qe]=Ji,wi[zi]=Ai,Qe=zi):(wi[Qe]=zn,wi[Un]=Ai,Qe=Un);else if(zi<Gt&&0>A(Ji,Ai))wi[Qe]=Ji,wi[zi]=Ai,Qe=zi;else break e}}return Ui}function A(wi,Ui){var Ai=wi.sortIndex-Ui.sortIndex;return Ai!==0?Ai:wi.id-Ui.id}if(typeof performance=="object"&&typeof performance.now=="function"){var z=performance;x.unstable_now=function(){return z.now()}}else{var U=Date,s=U.now();x.unstable_now=function(){return U.now()-s}}var ee=[],ne=[],Ie=1,qe=null,Xe=3,St=!1,$t=!1,ct=!1,wt=typeof setTimeout=="function"?setTimeout:null,Nt=typeof clearTimeout=="function"?clearTimeout:null,Ti=typeof setImmediate<"u"?setImmediate:null;typeof navigator<"u"&&navigator.scheduling!==void 0&&navigator.scheduling.isInputPending!==void 0&&navigator.scheduling.isInputPending.bind(navigator.scheduling);function Ei(wi){for(var Ui=m(ne);Ui!==null;){if(Ui.callback===null)E(ne);else if(Ui.startTime<=wi)E(ne),Ui.sortIndex=Ui.expirationTime,u(ee,Ui);else break;Ui=m(ne)}}function en(wi){if(ct=!1,Ei(wi),!$t)if(m(ee)!==null)$t=!0,wn(Hn);else{var Ui=m(ne);Ui!==null&&Gn(en,Ui.startTime-wi)}}function Hn(wi,Ui){$t=!1,ct&&(ct=!1,Nt(De),De=-1),St=!0;var Ai=Xe;try{for(Ei(Ui),qe=m(ee);qe!==null&&(!(qe.expirationTime>Ui)||wi&&!We());){var Qe=qe.callback;if(typeof Qe=="function"){qe.callback=null,Xe=qe.priorityLevel;var Gt=Qe(qe.expirationTime<=Ui);Ui=x.unstable_now(),typeof Gt=="function"?qe.callback=Gt:qe===m(ee)&&E(ee),Ei(Ui)}else E(ee);qe=m(ee)}if(qe!==null)var ji=!0;else{var Un=m(ne);Un!==null&&Gn(en,Un.startTime-Ui),ji=!1}return ji}finally{qe=null,Xe=Ai,St=!1}}var _n=!1,rt=null,De=-1,je=5,Ke=-1;function We(){return!(x.unstable_now()-Ke<je)}function ut(){if(rt!==null){var wi=x.unstable_now();Ke=wi;var Ui=!0;try{Ui=rt(!0,wi)}finally{Ui?Oe():(_n=!1,rt=null)}}else _n=!1}var Oe;if(typeof Ti=="function")Oe=function(){Ti(ut)};else if(typeof MessageChannel<"u"){var kn=new MessageChannel,$n=kn.port2;kn.port1.onmessage=ut,Oe=function(){$n.postMessage(null)}}else Oe=function(){wt(ut,0)};function wn(wi){rt=wi,_n||(_n=!0,Oe())}function Gn(wi,Ui){De=wt(function(){wi(x.unstable_now())},Ui)}x.unstable_IdlePriority=5,x.unstable_ImmediatePriority=1,x.unstable_LowPriority=4,x.unstable_NormalPriority=3,x.unstable_Profiling=null,x.unstable_UserBlockingPriority=2,x.unstable_cancelCallback=function(wi){wi.callback=null},x.unstable_continueExecution=function(){$t||St||($t=!0,wn(Hn))},x.unstable_forceFrameRate=function(wi){0>wi||125<wi?console.error("forceFrameRate takes a positive int between 0 and 125, forcing frame rates higher than 125 fps is not supported"):je=0<wi?Math.floor(1e3/wi):5},x.unstable_getCurrentPriorityLevel=function(){return Xe},x.unstable_getFirstCallbackNode=function(){return m(ee)},x.unstable_next=function(wi){switch(Xe){case 1:case 2:case 3:var Ui=3;break;default:Ui=Xe}var Ai=Xe;Xe=Ui;try{return wi()}finally{Xe=Ai}},x.unstable_pauseExecution=function(){},x.unstable_requestPaint=function(){},x.unstable_runWithPriority=function(wi,Ui){switch(wi){case 1:case 2:case 3:case 4:case 5:break;default:wi=3}var Ai=Xe;Xe=wi;try{return Ui()}finally{Xe=Ai}},x.unstable_scheduleCallback=function(wi,Ui,Ai){var Qe=x.unstable_now();switch(typeof Ai=="object"&&Ai!==null?(Ai=Ai.delay,Ai=typeof Ai=="number"&&0<Ai?Qe+Ai:Qe):Ai=Qe,wi){case 1:var Gt=-1;break;case 2:Gt=250;break;case 5:Gt=1073741823;break;case 4:Gt=1e4;break;default:Gt=5e3}return Gt=Ai+Gt,wi={id:Ie++,callback:Ui,priorityLevel:wi,startTime:Ai,expirationTime:Gt,sortIndex:-1},Ai>Qe?(wi.sortIndex=Ai,u(ne,wi),m(ee)===null&&wi===m(ne)&&(ct?(Nt(De),De=-1):ct=!0,Gn(en,Ai-Qe))):(wi.sortIndex=Gt,u(ee,wi),$t||St||($t=!0,wn(Hn))),wi},x.unstable_shouldYield=We,x.unstable_wrapCallback=function(wi){var Ui=Xe;return function(){var Ai=Xe;Xe=Ui;try{return wi.apply(this,arguments)}finally{Xe=Ai}}}})(N0)),N0}var qb;function pA(){return qb||(qb=1,B0.exports=fA()),B0.exports}/**
 * @license React
 * react-dom.production.min.js
 *
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var $b;function mA(){if($b)return Yl;$b=1;var x=wv(),u=pA();function m(f){for(var g="https://reactjs.org/docs/error-decoder.html?invariant="+f,S=1;S<arguments.length;S++)g+="&args[]="+encodeURIComponent(arguments[S]);return"Minified React error #"+f+"; visit "+g+" for the full message or use the non-minified dev environment for full errors and additional helpful warnings."}var E=new Set,A={};function z(f,g){U(f,g),U(f+"Capture",g)}function U(f,g){for(A[f]=g,f=0;f<g.length;f++)E.add(g[f])}var s=!(typeof window>"u"||typeof window.document>"u"||typeof window.document.createElement>"u"),ee=Object.prototype.hasOwnProperty,ne=/^[:A-Z_a-z\u00C0-\u00D6\u00D8-\u00F6\u00F8-\u02FF\u0370-\u037D\u037F-\u1FFF\u200C-\u200D\u2070-\u218F\u2C00-\u2FEF\u3001-\uD7FF\uF900-\uFDCF\uFDF0-\uFFFD][:A-Z_a-z\u00C0-\u00D6\u00D8-\u00F6\u00F8-\u02FF\u0370-\u037D\u037F-\u1FFF\u200C-\u200D\u2070-\u218F\u2C00-\u2FEF\u3001-\uD7FF\uF900-\uFDCF\uFDF0-\uFFFD\-.0-9\u00B7\u0300-\u036F\u203F-\u2040]*$/,Ie={},qe={};function Xe(f){return ee.call(qe,f)?!0:ee.call(Ie,f)?!1:ne.test(f)?qe[f]=!0:(Ie[f]=!0,!1)}function St(f,g,S,k){if(S!==null&&S.type===0)return!1;switch(typeof g){case"function":case"symbol":return!0;case"boolean":return k?!1:S!==null?!S.acceptsBooleans:(f=f.toLowerCase().slice(0,5),f!=="data-"&&f!=="aria-");default:return!1}}function $t(f,g,S,k){if(g===null||typeof g>"u"||St(f,g,S,k))return!0;if(k)return!1;if(S!==null)switch(S.type){case 3:return!g;case 4:return g===!1;case 5:return isNaN(g);case 6:return isNaN(g)||1>g}return!1}function ct(f,g,S,k,j,K,fe){this.acceptsBooleans=g===2||g===3||g===4,this.attributeName=k,this.attributeNamespace=j,this.mustUseProperty=S,this.propertyName=f,this.type=g,this.sanitizeURL=K,this.removeEmptyString=fe}var wt={};"children dangerouslySetInnerHTML defaultValue defaultChecked innerHTML suppressContentEditableWarning suppressHydrationWarning style".split(" ").forEach(function(f){wt[f]=new ct(f,0,!1,f,null,!1,!1)}),[["acceptCharset","accept-charset"],["className","class"],["htmlFor","for"],["httpEquiv","http-equiv"]].forEach(function(f){var g=f[0];wt[g]=new ct(g,1,!1,f[1],null,!1,!1)}),["contentEditable","draggable","spellCheck","value"].forEach(function(f){wt[f]=new ct(f,2,!1,f.toLowerCase(),null,!1,!1)}),["autoReverse","externalResourcesRequired","focusable","preserveAlpha"].forEach(function(f){wt[f]=new ct(f,2,!1,f,null,!1,!1)}),"allowFullScreen async autoFocus autoPlay controls default defer disabled disablePictureInPicture disableRemotePlayback formNoValidate hidden loop noModule noValidate open playsInline readOnly required reversed scoped seamless itemScope".split(" ").forEach(function(f){wt[f]=new ct(f,3,!1,f.toLowerCase(),null,!1,!1)}),["checked","multiple","muted","selected"].forEach(function(f){wt[f]=new ct(f,3,!0,f,null,!1,!1)}),["capture","download"].forEach(function(f){wt[f]=new ct(f,4,!1,f,null,!1,!1)}),["cols","rows","size","span"].forEach(function(f){wt[f]=new ct(f,6,!1,f,null,!1,!1)}),["rowSpan","start"].forEach(function(f){wt[f]=new ct(f,5,!1,f.toLowerCase(),null,!1,!1)});var Nt=/[\-:]([a-z])/g;function Ti(f){return f[1].toUpperCase()}"accent-height alignment-baseline arabic-form baseline-shift cap-height clip-path clip-rule color-interpolation color-interpolation-filters color-profile color-rendering dominant-baseline enable-background fill-opacity fill-rule flood-color flood-opacity font-family font-size font-size-adjust font-stretch font-style font-variant font-weight glyph-name glyph-orientation-horizontal glyph-orientation-vertical horiz-adv-x horiz-origin-x image-rendering letter-spacing lighting-color marker-end marker-mid marker-start overline-position overline-thickness paint-order panose-1 pointer-events rendering-intent shape-rendering stop-color stop-opacity strikethrough-position strikethrough-thickness stroke-dasharray stroke-dashoffset stroke-linecap stroke-linejoin stroke-miterlimit stroke-opacity stroke-width text-anchor text-decoration text-rendering underline-position underline-thickness unicode-bidi unicode-range units-per-em v-alphabetic v-hanging v-ideographic v-mathematical vector-effect vert-adv-y vert-origin-x vert-origin-y word-spacing writing-mode xmlns:xlink x-height".split(" ").forEach(function(f){var g=f.replace(Nt,Ti);wt[g]=new ct(g,1,!1,f,null,!1,!1)}),"xlink:actuate xlink:arcrole xlink:role xlink:show xlink:title xlink:type".split(" ").forEach(function(f){var g=f.replace(Nt,Ti);wt[g]=new ct(g,1,!1,f,"http://www.w3.org/1999/xlink",!1,!1)}),["xml:base","xml:lang","xml:space"].forEach(function(f){var g=f.replace(Nt,Ti);wt[g]=new ct(g,1,!1,f,"http://www.w3.org/XML/1998/namespace",!1,!1)}),["tabIndex","crossOrigin"].forEach(function(f){wt[f]=new ct(f,1,!1,f.toLowerCase(),null,!1,!1)}),wt.xlinkHref=new ct("xlinkHref",1,!1,"xlink:href","http://www.w3.org/1999/xlink",!0,!1),["src","href","action","formAction"].forEach(function(f){wt[f]=new ct(f,1,!1,f.toLowerCase(),null,!0,!0)});function Ei(f,g,S,k){var j=wt.hasOwnProperty(g)?wt[g]:null;(j!==null?j.type!==0:k||!(2<g.length)||g[0]!=="o"&&g[0]!=="O"||g[1]!=="n"&&g[1]!=="N")&&($t(g,S,j,k)&&(S=null),k||j===null?Xe(g)&&(S===null?f.removeAttribute(g):f.setAttribute(g,""+S)):j.mustUseProperty?f[j.propertyName]=S===null?j.type===3?!1:"":S:(g=j.attributeName,k=j.attributeNamespace,S===null?f.removeAttribute(g):(j=j.type,S=j===3||j===4&&S===!0?"":""+S,k?f.setAttributeNS(k,g,S):f.setAttribute(g,S))))}var en=x.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED,Hn=Symbol.for("react.element"),_n=Symbol.for("react.portal"),rt=Symbol.for("react.fragment"),De=Symbol.for("react.strict_mode"),je=Symbol.for("react.profiler"),Ke=Symbol.for("react.provider"),We=Symbol.for("react.context"),ut=Symbol.for("react.forward_ref"),Oe=Symbol.for("react.suspense"),kn=Symbol.for("react.suspense_list"),$n=Symbol.for("react.memo"),wn=Symbol.for("react.lazy"),Gn=Symbol.for("react.offscreen"),wi=Symbol.iterator;function Ui(f){return f===null||typeof f!="object"?null:(f=wi&&f[wi]||f["@@iterator"],typeof f=="function"?f:null)}var Ai=Object.assign,Qe;function Gt(f){if(Qe===void 0)try{throw Error()}catch(S){var g=S.stack.trim().match(/\n( *(at )?)/);Qe=g&&g[1]||""}return`
`+Qe+f}var ji=!1;function Un(f,g){if(!f||ji)return"";ji=!0;var S=Error.prepareStackTrace;Error.prepareStackTrace=void 0;try{if(g)if(g=function(){throw Error()},Object.defineProperty(g.prototype,"props",{set:function(){throw Error()}}),typeof Reflect=="object"&&Reflect.construct){try{Reflect.construct(g,[])}catch(Ft){var k=Ft}Reflect.construct(f,[],g)}else{try{g.call()}catch(Ft){k=Ft}f.call(g.prototype)}else{try{throw Error()}catch(Ft){k=Ft}f()}}catch(Ft){if(Ft&&k&&typeof Ft.stack=="string"){for(var j=Ft.stack.split(`
`),K=k.stack.split(`
`),fe=j.length-1,Ne=K.length-1;1<=fe&&0<=Ne&&j[fe]!==K[Ne];)Ne--;for(;1<=fe&&0<=Ne;fe--,Ne--)if(j[fe]!==K[Ne]){if(fe!==1||Ne!==1)do if(fe--,Ne--,0>Ne||j[fe]!==K[Ne]){var Je=`
`+j[fe].replace(" at new "," at ");return f.displayName&&Je.includes("<anonymous>")&&(Je=Je.replace("<anonymous>",f.displayName)),Je}while(1<=fe&&0<=Ne);break}}}finally{ji=!1,Error.prepareStackTrace=S}return(f=f?f.displayName||f.name:"")?Gt(f):""}function zn(f){switch(f.tag){case 5:return Gt(f.type);case 16:return Gt("Lazy");case 13:return Gt("Suspense");case 19:return Gt("SuspenseList");case 0:case 2:case 15:return f=Un(f.type,!1),f;case 11:return f=Un(f.type.render,!1),f;case 1:return f=Un(f.type,!0),f;default:return""}}function zi(f){if(f==null)return null;if(typeof f=="function")return f.displayName||f.name||null;if(typeof f=="string")return f;switch(f){case rt:return"Fragment";case _n:return"Portal";case je:return"Profiler";case De:return"StrictMode";case Oe:return"Suspense";case kn:return"SuspenseList"}if(typeof f=="object")switch(f.$$typeof){case We:return(f.displayName||"Context")+".Consumer";case Ke:return(f._context.displayName||"Context")+".Provider";case ut:var g=f.render;return f=f.displayName,f||(f=g.displayName||g.name||"",f=f!==""?"ForwardRef("+f+")":"ForwardRef"),f;case $n:return g=f.displayName||null,g!==null?g:zi(f.type)||"Memo";case wn:g=f._payload,f=f._init;try{return zi(f(g))}catch{}}return null}function Ji(f){var g=f.type;switch(f.tag){case 24:return"Cache";case 9:return(g.displayName||"Context")+".Consumer";case 10:return(g._context.displayName||"Context")+".Provider";case 18:return"DehydratedFragment";case 11:return f=g.render,f=f.displayName||f.name||"",g.displayName||(f!==""?"ForwardRef("+f+")":"ForwardRef");case 7:return"Fragment";case 5:return g;case 4:return"Portal";case 3:return"Root";case 6:return"Text";case 16:return zi(g);case 8:return g===De?"StrictMode":"Mode";case 22:return"Offscreen";case 12:return"Profiler";case 21:return"Scope";case 13:return"Suspense";case 19:return"SuspenseList";case 25:return"TracingMarker";case 1:case 0:case 17:case 2:case 14:case 15:if(typeof g=="function")return g.displayName||g.name||null;if(typeof g=="string")return g}return null}function on(f){switch(typeof f){case"boolean":case"number":case"string":case"undefined":return f;case"object":return f;default:return""}}function er(f){var g=f.type;return(f=f.nodeName)&&f.toLowerCase()==="input"&&(g==="checkbox"||g==="radio")}function Pn(f){var g=er(f)?"checked":"value",S=Object.getOwnPropertyDescriptor(f.constructor.prototype,g),k=""+f[g];if(!f.hasOwnProperty(g)&&typeof S<"u"&&typeof S.get=="function"&&typeof S.set=="function"){var j=S.get,K=S.set;return Object.defineProperty(f,g,{configurable:!0,get:function(){return j.call(this)},set:function(fe){k=""+fe,K.call(this,fe)}}),Object.defineProperty(f,g,{enumerable:S.enumerable}),{getValue:function(){return k},setValue:function(fe){k=""+fe},stopTracking:function(){f._valueTracker=null,delete f[g]}}}}function ao(f){f._valueTracker||(f._valueTracker=Pn(f))}function Bo(f){if(!f)return!1;var g=f._valueTracker;if(!g)return!0;var S=g.getValue(),k="";return f&&(k=er(f)?f.checked?"true":"false":f.value),f=k,f!==S?(g.setValue(f),!0):!1}function Yo(f){if(f=f||(typeof document<"u"?document:void 0),typeof f>"u")return null;try{return f.activeElement||f.body}catch{return f.body}}function Bs(f,g){var S=g.checked;return Ai({},g,{defaultChecked:void 0,defaultValue:void 0,value:void 0,checked:S??f._wrapperState.initialChecked})}function Ut(f,g){var S=g.defaultValue==null?"":g.defaultValue,k=g.checked!=null?g.checked:g.defaultChecked;S=on(g.value!=null?g.value:S),f._wrapperState={initialChecked:k,initialValue:S,controlled:g.type==="checkbox"||g.type==="radio"?g.checked!=null:g.value!=null}}function Di(f,g){g=g.checked,g!=null&&Ei(f,"checked",g,!1)}function cn(f,g){Di(f,g);var S=on(g.value),k=g.type;if(S!=null)k==="number"?(S===0&&f.value===""||f.value!=S)&&(f.value=""+S):f.value!==""+S&&(f.value=""+S);else if(k==="submit"||k==="reset"){f.removeAttribute("value");return}g.hasOwnProperty("value")?Zn(f,g.type,S):g.hasOwnProperty("defaultValue")&&Zn(f,g.type,on(g.defaultValue)),g.checked==null&&g.defaultChecked!=null&&(f.defaultChecked=!!g.defaultChecked)}function wr(f,g,S){if(g.hasOwnProperty("value")||g.hasOwnProperty("defaultValue")){var k=g.type;if(!(k!=="submit"&&k!=="reset"||g.value!==void 0&&g.value!==null))return;g=""+f._wrapperState.initialValue,S||g===f.value||(f.value=g),f.defaultValue=g}S=f.name,S!==""&&(f.name=""),f.defaultChecked=!!f._wrapperState.initialChecked,S!==""&&(f.name=S)}function Zn(f,g,S){(g!=="number"||Yo(f.ownerDocument)!==f)&&(S==null?f.defaultValue=""+f._wrapperState.initialValue:f.defaultValue!==""+S&&(f.defaultValue=""+S))}var fr=Array.isArray;function Rn(f,g,S,k){if(f=f.options,g){g={};for(var j=0;j<S.length;j++)g["$"+S[j]]=!0;for(S=0;S<f.length;S++)j=g.hasOwnProperty("$"+f[S].value),f[S].selected!==j&&(f[S].selected=j),j&&k&&(f[S].defaultSelected=!0)}else{for(S=""+on(S),g=null,j=0;j<f.length;j++){if(f[j].value===S){f[j].selected=!0,k&&(f[j].defaultSelected=!0);return}g!==null||f[j].disabled||(g=f[j])}g!==null&&(g.selected=!0)}}function ar(f,g){if(g.dangerouslySetInnerHTML!=null)throw Error(m(91));return Ai({},g,{value:void 0,defaultValue:void 0,children:""+f._wrapperState.initialValue})}function vs(f,g){var S=g.value;if(S==null){if(S=g.children,g=g.defaultValue,S!=null){if(g!=null)throw Error(m(92));if(fr(S)){if(1<S.length)throw Error(m(93));S=S[0]}g=S}g==null&&(g=""),S=g}f._wrapperState={initialValue:on(S)}}function Qo(f,g){var S=on(g.value),k=on(g.defaultValue);S!=null&&(S=""+S,S!==f.value&&(f.value=S),g.defaultValue==null&&f.defaultValue!==S&&(f.defaultValue=S)),k!=null&&(f.defaultValue=""+k)}function Fa(f){var g=f.textContent;g===f._wrapperState.initialValue&&g!==""&&g!==null&&(f.value=g)}function Sr(f){switch(f){case"svg":return"http://www.w3.org/2000/svg";case"math":return"http://www.w3.org/1998/Math/MathML";default:return"http://www.w3.org/1999/xhtml"}}function Lr(f,g){return f==null||f==="http://www.w3.org/1999/xhtml"?Sr(g):f==="http://www.w3.org/2000/svg"&&g==="foreignObject"?"http://www.w3.org/1999/xhtml":f}var da,fa=(function(f){return typeof MSApp<"u"&&MSApp.execUnsafeLocalFunction?function(g,S,k,j){MSApp.execUnsafeLocalFunction(function(){return f(g,S,k,j)})}:f})(function(f,g){if(f.namespaceURI!=="http://www.w3.org/2000/svg"||"innerHTML"in f)f.innerHTML=g;else{for(da=da||document.createElement("div"),da.innerHTML="<svg>"+g.valueOf().toString()+"</svg>",g=da.firstChild;f.firstChild;)f.removeChild(f.firstChild);for(;g.firstChild;)f.appendChild(g.firstChild)}});function pa(f,g){if(g){var S=f.firstChild;if(S&&S===f.lastChild&&S.nodeType===3){S.nodeValue=g;return}}f.textContent=g}var xs={animationIterationCount:!0,aspectRatio:!0,borderImageOutset:!0,borderImageSlice:!0,borderImageWidth:!0,boxFlex:!0,boxFlexGroup:!0,boxOrdinalGroup:!0,columnCount:!0,columns:!0,flex:!0,flexGrow:!0,flexPositive:!0,flexShrink:!0,flexNegative:!0,flexOrder:!0,gridArea:!0,gridRow:!0,gridRowEnd:!0,gridRowSpan:!0,gridRowStart:!0,gridColumn:!0,gridColumnEnd:!0,gridColumnSpan:!0,gridColumnStart:!0,fontWeight:!0,lineClamp:!0,lineHeight:!0,opacity:!0,order:!0,orphans:!0,tabSize:!0,widows:!0,zIndex:!0,zoom:!0,fillOpacity:!0,floodOpacity:!0,stopOpacity:!0,strokeDasharray:!0,strokeDashoffset:!0,strokeMiterlimit:!0,strokeOpacity:!0,strokeWidth:!0},Xs=["Webkit","ms","Moz","O"];Object.keys(xs).forEach(function(f){Xs.forEach(function(g){g=g+f.charAt(0).toUpperCase()+f.substring(1),xs[g]=xs[f]})});function Oa(f,g,S){return g==null||typeof g=="boolean"||g===""?"":S||typeof g!="number"||g===0||xs.hasOwnProperty(f)&&xs[f]?(""+g).trim():g+"px"}function ma(f,g){f=f.style;for(var S in g)if(g.hasOwnProperty(S)){var k=S.indexOf("--")===0,j=Oa(S,g[S],k);S==="float"&&(S="cssFloat"),k?f.setProperty(S,j):f[S]=j}}var Ba=Ai({menuitem:!0},{area:!0,base:!0,br:!0,col:!0,embed:!0,hr:!0,img:!0,input:!0,keygen:!0,link:!0,meta:!0,param:!0,source:!0,track:!0,wbr:!0});function Na(f,g){if(g){if(Ba[f]&&(g.children!=null||g.dangerouslySetInnerHTML!=null))throw Error(m(137,f));if(g.dangerouslySetInnerHTML!=null){if(g.children!=null)throw Error(m(60));if(typeof g.dangerouslySetInnerHTML!="object"||!("__html"in g.dangerouslySetInnerHTML))throw Error(m(61))}if(g.style!=null&&typeof g.style!="object")throw Error(m(62))}}function Rl(f,g){if(f.indexOf("-")===-1)return typeof g.is=="string";switch(f){case"annotation-xml":case"color-profile":case"font-face":case"font-face-src":case"font-face-uri":case"font-face-format":case"font-face-name":case"missing-glyph":return!1;default:return!0}}var nr=null;function Ml(f){return f=f.target||f.srcElement||window,f.correspondingUseElement&&(f=f.correspondingUseElement),f.nodeType===3?f.parentNode:f}var Dl=null,gs=null,Jo=null;function Ac(f){if(f=th(f)){if(typeof Dl!="function")throw Error(m(280));var g=f.stateNode;g&&(g=ih(g),Dl(f.stateNode,f.type,g))}}function No(f){gs?Jo?Jo.push(f):Jo=[f]:gs=f}function gt(){if(gs){var f=gs,g=Jo;if(Jo=gs=null,Ac(f),g)for(f=0;f<g.length;f++)Ac(g[f])}}function Vo(f,g){return f(g)}function eu(){}var _a=!1;function vn(f,g,S){if(_a)return f(g,S);_a=!0;try{return Vo(f,g,S)}finally{_a=!1,(gs!==null||Jo!==null)&&(eu(),gt())}}function ke(f,g){var S=f.stateNode;if(S===null)return null;var k=ih(S);if(k===null)return null;S=k[g];e:switch(g){case"onClick":case"onClickCapture":case"onDoubleClick":case"onDoubleClickCapture":case"onMouseDown":case"onMouseDownCapture":case"onMouseMove":case"onMouseMoveCapture":case"onMouseUp":case"onMouseUpCapture":case"onMouseEnter":(k=!k.disabled)||(f=f.type,k=!(f==="button"||f==="input"||f==="select"||f==="textarea")),f=!k;break e;default:f=!1}if(f)return null;if(S&&typeof S!="function")throw Error(m(231,g,typeof S));return S}var Q=!1;if(s)try{var J={};Object.defineProperty(J,"passive",{get:function(){Q=!0}}),window.addEventListener("test",J,J),window.removeEventListener("test",J,J)}catch{Q=!1}function ce(f,g,S,k,j,K,fe,Ne,Je){var Ft=Array.prototype.slice.call(arguments,3);try{g.apply(S,Ft)}catch(ai){this.onError(ai)}}var be=!1,de=null,Ae=!1,$e=null,Re={onError:function(f){be=!0,de=f}};function Ge(f,g,S,k,j,K,fe,Ne,Je){be=!1,de=null,ce.apply(Re,arguments)}function Ct(f,g,S,k,j,K,fe,Ne,Je){if(Ge.apply(this,arguments),be){if(be){var Ft=de;be=!1,de=null}else throw Error(m(198));Ae||(Ae=!0,$e=Ft)}}function lt(f){var g=f,S=f;if(f.alternate)for(;g.return;)g=g.return;else{f=g;do g=f,(g.flags&4098)!==0&&(S=g.return),f=g.return;while(f)}return g.tag===3?S:null}function ri(f){if(f.tag===13){var g=f.memoizedState;if(g===null&&(f=f.alternate,f!==null&&(g=f.memoizedState)),g!==null)return g.dehydrated}return null}function yi(f){if(lt(f)!==f)throw Error(m(188))}function Ri(f){var g=f.alternate;if(!g){if(g=lt(f),g===null)throw Error(m(188));return g!==f?null:f}for(var S=f,k=g;;){var j=S.return;if(j===null)break;var K=j.alternate;if(K===null){if(k=j.return,k!==null){S=k;continue}break}if(j.child===K.child){for(K=j.child;K;){if(K===S)return yi(j),f;if(K===k)return yi(j),g;K=K.sibling}throw Error(m(188))}if(S.return!==k.return)S=j,k=K;else{for(var fe=!1,Ne=j.child;Ne;){if(Ne===S){fe=!0,S=j,k=K;break}if(Ne===k){fe=!0,k=j,S=K;break}Ne=Ne.sibling}if(!fe){for(Ne=K.child;Ne;){if(Ne===S){fe=!0,S=K,k=j;break}if(Ne===k){fe=!0,k=K,S=j;break}Ne=Ne.sibling}if(!fe)throw Error(m(189))}}if(S.alternate!==k)throw Error(m(190))}if(S.tag!==3)throw Error(m(188));return S.stateNode.current===S?f:g}function Ki(f){return f=Ri(f),f!==null?Vi(f):null}function Vi(f){if(f.tag===5||f.tag===6)return f;for(f=f.child;f!==null;){var g=Vi(f);if(g!==null)return g;f=f.sibling}return null}var Yi=u.unstable_scheduleCallback,Xn=u.unstable_cancelCallback,tn=u.unstable_shouldYield,Nr=u.unstable_requestPaint,Fn=u.unstable_now,ns=u.unstable_getCurrentPriorityLevel,jn=u.unstable_ImmediatePriority,dn=u.unstable_UserBlockingPriority,rr=u.unstable_NormalPriority,br=u.unstable_LowPriority,Tr=u.unstable_IdlePriority,us=null,rs=null;function Ns(f){if(rs&&typeof rs.onCommitFiberRoot=="function")try{rs.onCommitFiberRoot(us,f,void 0,(f.current.flags&128)===128)}catch{}}var Ks=Math.clz32?Math.clz32:tu,ws=Math.log,ol=Math.LN2;function tu(f){return f>>>=0,f===0?32:31-(ws(f)/ol|0)|0}var Ll=64,kl=4194304;function al(f){switch(f&-f){case 1:return 1;case 2:return 2;case 4:return 4;case 8:return 8;case 16:return 16;case 32:return 32;case 64:case 128:case 256:case 512:case 1024:case 2048:case 4096:case 8192:case 16384:case 32768:case 65536:case 131072:case 262144:case 524288:case 1048576:case 2097152:return f&4194240;case 4194304:case 8388608:case 16777216:case 33554432:case 67108864:return f&130023424;case 134217728:return 134217728;case 268435456:return 268435456;case 536870912:return 536870912;case 1073741824:return 1073741824;default:return f}}function zl(f,g){var S=f.pendingLanes;if(S===0)return 0;var k=0,j=f.suspendedLanes,K=f.pingedLanes,fe=S&268435455;if(fe!==0){var Ne=fe&~j;Ne!==0?k=al(Ne):(K&=fe,K!==0&&(k=al(K)))}else fe=S&~j,fe!==0?k=al(fe):K!==0&&(k=al(K));if(k===0)return 0;if(g!==0&&g!==k&&(g&j)===0&&(j=k&-k,K=g&-g,j>=K||j===16&&(K&4194240)!==0))return g;if((k&4)!==0&&(k|=S&16),g=f.entangledLanes,g!==0)for(f=f.entanglements,g&=k;0<g;)S=31-Ks(g),j=1<<S,k|=f[S],g&=~j;return k}function Jl(f,g){switch(f){case 1:case 2:case 4:return g+250;case 8:case 16:case 32:case 64:case 128:case 256:case 512:case 1024:case 2048:case 4096:case 8192:case 16384:case 32768:case 65536:case 131072:case 262144:case 524288:case 1048576:case 2097152:return g+5e3;case 4194304:case 8388608:case 16777216:case 33554432:case 67108864:return-1;case 134217728:case 268435456:case 536870912:case 1073741824:return-1;default:return-1}}function ga(f,g){for(var S=f.suspendedLanes,k=f.pingedLanes,j=f.expirationTimes,K=f.pendingLanes;0<K;){var fe=31-Ks(K),Ne=1<<fe,Je=j[fe];Je===-1?((Ne&S)===0||(Ne&k)!==0)&&(j[fe]=Jl(Ne,g)):Je<=g&&(f.expiredLanes|=Ne),K&=~Ne}}function So(f){return f=f.pendingLanes&-1073741825,f!==0?f:f&1073741824?1073741824:0}function go(){var f=Ll;return Ll<<=1,(Ll&4194240)===0&&(Ll=64),f}function Vs(f){for(var g=[],S=0;31>S;S++)g.push(f);return g}function Ys(f,g,S){f.pendingLanes|=g,g!==536870912&&(f.suspendedLanes=0,f.pingedLanes=0),f=f.eventTimes,g=31-Ks(g),f[g]=S}function Ir(f,g){var S=f.pendingLanes&~g;f.pendingLanes=g,f.suspendedLanes=0,f.pingedLanes=0,f.expiredLanes&=g,f.mutableReadLanes&=g,f.entangledLanes&=g,g=f.entanglements;var k=f.eventTimes;for(f=f.expirationTimes;0<S;){var j=31-Ks(S),K=1<<j;g[j]=0,k[j]=-1,f[j]=-1,S&=~K}}function lo(f,g){var S=f.entangledLanes|=g;for(f=f.entanglements;S;){var k=31-Ks(S),j=1<<k;j&g|f[k]&g&&(f[k]|=g),S&=~j}}var Kn=0;function Va(f){return f&=-f,1<f?4<f?(f&268435455)!==0?16:536870912:4:1}var ya,Fl,Ol,ec,ju,iu=!1,ys=[],bs=null,Uo=null,Io=null,tc=new Map,va=new Map,ea=[],xn="mousedown mouseup touchcancel touchend touchstart auxclick dblclick pointercancel pointerdown pointerup dragend dragstart drop compositionend compositionstart keydown keypress keyup input textInput copy cut paste click change contextmenu reset submit".split(" ");function nu(f,g){switch(f){case"focusin":case"focusout":bs=null;break;case"dragenter":case"dragleave":Uo=null;break;case"mouseover":case"mouseout":Io=null;break;case"pointerover":case"pointerout":tc.delete(g.pointerId);break;case"gotpointercapture":case"lostpointercapture":va.delete(g.pointerId)}}function Qs(f,g,S,k,j,K){return f===null||f.nativeEvent!==K?(f={blockedOn:g,domEventName:S,eventSystemFlags:k,nativeEvent:K,targetContainers:[j]},g!==null&&(g=th(g),g!==null&&Fl(g)),f):(f.eventSystemFlags|=k,g=f.targetContainers,j!==null&&g.indexOf(j)===-1&&g.push(j),f)}function ru(f,g,S,k,j){switch(g){case"focusin":return bs=Qs(bs,f,g,S,k,j),!0;case"dragenter":return Uo=Qs(Uo,f,g,S,k,j),!0;case"mouseover":return Io=Qs(Io,f,g,S,k,j),!0;case"pointerover":var K=j.pointerId;return tc.set(K,Qs(tc.get(K)||null,f,g,S,k,j)),!0;case"gotpointercapture":return K=j.pointerId,va.set(K,Qs(va.get(K)||null,f,g,S,k,j)),!0}return!1}function vd(f){var g=mu(f.target);if(g!==null){var S=lt(g);if(S!==null){if(g=S.tag,g===13){if(g=ri(S),g!==null){f.blockedOn=g,ju(f.priority,function(){Ol(S)});return}}else if(g===3&&S.stateNode.current.memoizedState.isDehydrated){f.blockedOn=S.tag===3?S.stateNode.containerInfo:null;return}}}f.blockedOn=null}function xa(f){if(f.blockedOn!==null)return!1;for(var g=f.targetContainers;0<g.length;){var S=ul(f.domEventName,f.eventSystemFlags,g[0],f.nativeEvent);if(S===null){S=f.nativeEvent;var k=new S.constructor(S.type,S);nr=k,S.target.dispatchEvent(k),nr=null}else return g=th(S),g!==null&&Fl(g),f.blockedOn=S,!1;g.shift()}return!0}function wa(f,g,S){xa(f)&&S.delete(g)}function ll(){iu=!1,bs!==null&&xa(bs)&&(bs=null),Uo!==null&&xa(Uo)&&(Uo=null),Io!==null&&xa(Io)&&(Io=null),tc.forEach(wa),va.forEach(wa)}function jo(f,g){f.blockedOn===g&&(f.blockedOn=null,iu||(iu=!0,u.unstable_scheduleCallback(u.unstable_NormalPriority,ll)))}function Ua(f){function g(j){return jo(j,f)}if(0<ys.length){jo(ys[0],f);for(var S=1;S<ys.length;S++){var k=ys[S];k.blockedOn===f&&(k.blockedOn=null)}}for(bs!==null&&jo(bs,f),Uo!==null&&jo(Uo,f),Io!==null&&jo(Io,f),tc.forEach(g),va.forEach(g),S=0;S<ea.length;S++)k=ea[S],k.blockedOn===f&&(k.blockedOn=null);for(;0<ea.length&&(S=ea[0],S.blockedOn===null);)vd(S),S.blockedOn===null&&ea.shift()}var ja=en.ReactCurrentBatchConfig,ic=!0;function Yr(f,g,S,k){var j=Kn,K=ja.transition;ja.transition=null;try{Kn=1,Gu(f,g,S,k)}finally{Kn=j,ja.transition=K}}function nc(f,g,S,k){var j=Kn,K=ja.transition;ja.transition=null;try{Kn=4,Gu(f,g,S,k)}finally{Kn=j,ja.transition=K}}function Gu(f,g,S,k){if(ic){var j=ul(f,g,S,k);if(j===null)Cd(f,g,k,cl,S),nu(f,k);else if(ru(j,f,g,S,k))k.stopPropagation();else if(nu(f,k),g&4&&-1<xn.indexOf(f)){for(;j!==null;){var K=th(j);if(K!==null&&ya(K),K=ul(f,g,S,k),K===null&&Cd(f,g,k,cl,S),K===j)break;j=K}j!==null&&k.stopPropagation()}else Cd(f,g,k,null,S)}}var cl=null;function ul(f,g,S,k){if(cl=null,f=Ml(k),f=mu(f),f!==null)if(g=lt(f),g===null)f=null;else if(S=g.tag,S===13){if(f=ri(g),f!==null)return f;f=null}else if(S===3){if(g.stateNode.current.memoizedState.isDehydrated)return g.tag===3?g.stateNode.containerInfo:null;f=null}else g!==f&&(f=null);return cl=f,null}function ba(f){switch(f){case"cancel":case"click":case"close":case"contextmenu":case"copy":case"cut":case"auxclick":case"dblclick":case"dragend":case"dragstart":case"drop":case"focusin":case"focusout":case"input":case"invalid":case"keydown":case"keypress":case"keyup":case"mousedown":case"mouseup":case"paste":case"pause":case"play":case"pointercancel":case"pointerdown":case"pointerup":case"ratechange":case"reset":case"resize":case"seeked":case"submit":case"touchcancel":case"touchend":case"touchstart":case"volumechange":case"change":case"selectionchange":case"textInput":case"compositionstart":case"compositionend":case"compositionupdate":case"beforeblur":case"afterblur":case"beforeinput":case"blur":case"fullscreenchange":case"focus":case"hashchange":case"popstate":case"select":case"selectstart":return 1;case"drag":case"dragenter":case"dragexit":case"dragleave":case"dragover":case"mousemove":case"mouseout":case"mouseover":case"pointermove":case"pointerout":case"pointerover":case"scroll":case"toggle":case"touchmove":case"wheel":case"mouseenter":case"mouseleave":case"pointerenter":case"pointerleave":return 4;case"message":switch(ns()){case jn:return 1;case dn:return 4;case rr:case br:return 16;case Tr:return 536870912;default:return 16}default:return 16}}var ds=null,Cc=null,Ao=null;function hl(){if(Ao)return Ao;var f,g=Cc,S=g.length,k,j="value"in ds?ds.value:ds.textContent,K=j.length;for(f=0;f<S&&g[f]===j[f];f++);var fe=S-f;for(k=1;k<=fe&&g[S-k]===j[K-k];k++);return Ao=j.slice(f,1<k?1-k:void 0)}function Js(f){var g=f.keyCode;return"charCode"in f?(f=f.charCode,f===0&&g===13&&(f=13)):f=g,f===10&&(f=13),32<=f||f===13?f:0}function Ga(){return!0}function Pc(){return!1}function eo(f){function g(S,k,j,K,fe){this._reactName=S,this._targetInst=j,this.type=k,this.nativeEvent=K,this.target=fe,this.currentTarget=null;for(var Ne in f)f.hasOwnProperty(Ne)&&(S=f[Ne],this[Ne]=S?S(K):K[Ne]);return this.isDefaultPrevented=(K.defaultPrevented!=null?K.defaultPrevented:K.returnValue===!1)?Ga:Pc,this.isPropagationStopped=Pc,this}return Ai(g.prototype,{preventDefault:function(){this.defaultPrevented=!0;var S=this.nativeEvent;S&&(S.preventDefault?S.preventDefault():typeof S.returnValue!="unknown"&&(S.returnValue=!1),this.isDefaultPrevented=Ga)},stopPropagation:function(){var S=this.nativeEvent;S&&(S.stopPropagation?S.stopPropagation():typeof S.cancelBubble!="unknown"&&(S.cancelBubble=!0),this.isPropagationStopped=Ga)},persist:function(){},isPersistent:Ga}),g}var un={eventPhase:0,bubbles:0,cancelable:0,timeStamp:function(f){return f.timeStamp||Date.now()},defaultPrevented:0,isTrusted:0},Bl=eo(un),Go=Ai({},un,{view:0,detail:0}),xd=eo(Go),di,Nl,Ha,Ta=Ai({},Go,{screenX:0,screenY:0,clientX:0,clientY:0,pageX:0,pageY:0,ctrlKey:0,shiftKey:0,altKey:0,metaKey:0,getModifierState:Ho,button:0,buttons:0,relatedTarget:function(f){return f.relatedTarget===void 0?f.fromElement===f.srcElement?f.toElement:f.fromElement:f.relatedTarget},movementX:function(f){return"movementX"in f?f.movementX:(f!==Ha&&(Ha&&f.type==="mousemove"?(di=f.screenX-Ha.screenX,Nl=f.screenY-Ha.screenY):Nl=di=0,Ha=f),di)},movementY:function(f){return"movementY"in f?f.movementY:Nl}}),co=eo(Ta),su=Ai({},Ta,{dataTransfer:0}),rc=eo(su),ni=Ai({},Go,{relatedTarget:0}),bn=eo(ni),Mn=Ai({},un,{animationName:0,elapsedTime:0,pseudoElement:0}),Cs=eo(Mn),qa=Ai({},un,{clipboardData:function(f){return"clipboardData"in f?f.clipboardData:window.clipboardData}}),On=eo(qa),ou=Ai({},un,{data:0}),sc=eo(ou),Vl={Esc:"Escape",Spacebar:" ",Left:"ArrowLeft",Up:"ArrowUp",Right:"ArrowRight",Down:"ArrowDown",Del:"Delete",Win:"OS",Menu:"ContextMenu",Apps:"ContextMenu",Scroll:"ScrollLock",MozPrintableKey:"Unidentified"},Vr={8:"Backspace",9:"Tab",12:"Clear",13:"Enter",16:"Shift",17:"Control",18:"Alt",19:"Pause",20:"CapsLock",27:"Escape",32:" ",33:"PageUp",34:"PageDown",35:"End",36:"Home",37:"ArrowLeft",38:"ArrowUp",39:"ArrowRight",40:"ArrowDown",45:"Insert",46:"Delete",112:"F1",113:"F2",114:"F3",115:"F4",116:"F5",117:"F6",118:"F7",119:"F8",120:"F9",121:"F10",122:"F11",123:"F12",144:"NumLock",145:"ScrollLock",224:"Meta"},ss={Alt:"altKey",Control:"ctrlKey",Meta:"metaKey",Shift:"shiftKey"};function wd(f){var g=this.nativeEvent;return g.getModifierState?g.getModifierState(f):(f=ss[f])?!!g[f]:!1}function Ho(){return wd}var R=Ai({},Go,{key:function(f){if(f.key){var g=Vl[f.key]||f.key;if(g!=="Unidentified")return g}return f.type==="keypress"?(f=Js(f),f===13?"Enter":String.fromCharCode(f)):f.type==="keydown"||f.type==="keyup"?Vr[f.keyCode]||"Unidentified":""},code:0,location:0,ctrlKey:0,shiftKey:0,altKey:0,metaKey:0,repeat:0,locale:0,getModifierState:Ho,charCode:function(f){return f.type==="keypress"?Js(f):0},keyCode:function(f){return f.type==="keydown"||f.type==="keyup"?f.keyCode:0},which:function(f){return f.type==="keypress"?Js(f):f.type==="keydown"||f.type==="keyup"?f.keyCode:0}}),W=eo(R),ie=Ai({},Ta,{pointerId:0,width:0,height:0,pressure:0,tangentialPressure:0,tiltX:0,tiltY:0,twist:0,pointerType:0,isPrimary:0}),Se=eo(ie),pt=Ai({},Go,{touches:0,targetTouches:0,changedTouches:0,altKey:0,metaKey:0,ctrlKey:0,shiftKey:0,getModifierState:Ho}),Mt=eo(pt),vi=Ai({},un,{propertyName:0,elapsedTime:0,pseudoElement:0}),Yn=eo(vi),fs=Ai({},Ta,{deltaX:function(f){return"deltaX"in f?f.deltaX:"wheelDeltaX"in f?-f.wheelDeltaX:0},deltaY:function(f){return"deltaY"in f?f.deltaY:"wheelDeltaY"in f?-f.wheelDeltaY:"wheelDelta"in f?-f.wheelDelta:0},deltaZ:0,deltaMode:0}),ui=eo(fs),Vt=[9,13,27,32],Ur=s&&"CompositionEvent"in window,_i=null;s&&"documentMode"in document&&(_i=document.documentMode);var gr=s&&"TextEvent"in window&&!_i,dl=s&&(!Ur||_i&&8<_i&&11>=_i),gi=" ",au=!1;function lu(f,g){switch(f){case"keyup":return Vt.indexOf(g.keyCode)!==-1;case"keydown":return g.keyCode!==229;case"keypress":case"mousedown":case"focusout":return!0;default:return!1}}function oc(f){return f=f.detail,typeof f=="object"&&"data"in f?f.data:null}var cu=!1;function $a(f,g){switch(f){case"compositionend":return oc(g);case"keypress":return g.which!==32?null:(au=!0,gi);case"textInput":return f=g.data,f===gi&&au?null:f;default:return null}}function Co(f,g){if(cu)return f==="compositionend"||!Ur&&lu(f,g)?(f=hl(),Ao=Cc=ds=null,cu=!1,f):null;switch(f){case"paste":return null;case"keypress":if(!(g.ctrlKey||g.altKey||g.metaKey)||g.ctrlKey&&g.altKey){if(g.char&&1<g.char.length)return g.char;if(g.which)return String.fromCharCode(g.which)}return null;case"compositionend":return dl&&g.locale!=="ko"?null:g.data;default:return null}}var Ph={color:!0,date:!0,datetime:!0,"datetime-local":!0,email:!0,month:!0,number:!0,password:!0,range:!0,search:!0,tel:!0,text:!0,time:!0,url:!0,week:!0};function Ms(f){var g=f&&f.nodeName&&f.nodeName.toLowerCase();return g==="input"?!!Ph[f.type]:g==="textarea"}function bd(f,g,S,k){No(k),g=pu(g,"onChange"),0<g.length&&(S=new Bl("onChange","change",null,S,k),f.push({event:S,listeners:g}))}var ta=null,Ds=null;function Rh(f){zf(f,0)}function Td(f){var g=Oc(f);if(Bo(g))return f}function vm(f,g){if(f==="change")return g}var ac=!1;if(s){var Rc;if(s){var lc="oninput"in document;if(!lc){var uu=document.createElement("div");uu.setAttribute("oninput","return;"),lc=typeof uu.oninput=="function"}Rc=lc}else Rc=!1;ac=Rc&&(!document.documentMode||9<document.documentMode)}function Mf(){ta&&(ta.detachEvent("onpropertychange",Mh),Ds=ta=null)}function Mh(f){if(f.propertyName==="value"&&Td(Ds)){var g=[];bd(g,Ds,f,Ml(f)),vn(Rh,g)}}function Df(f,g,S){f==="focusin"?(Mf(),ta=g,Ds=S,ta.attachEvent("onpropertychange",Mh)):f==="focusout"&&Mf()}function Mc(f){if(f==="selectionchange"||f==="keyup"||f==="keydown")return Td(Ds)}function xm(f,g){if(f==="click")return Td(g)}function Tp(f,g){if(f==="input"||f==="change")return Td(g)}function wm(f,g){return f===g&&(f!==0||1/f===1/g)||f!==f&&g!==g}var Wa=typeof Object.is=="function"?Object.is:wm;function Hu(f,g){if(Wa(f,g))return!0;if(typeof f!="object"||f===null||typeof g!="object"||g===null)return!1;var S=Object.keys(f),k=Object.keys(g);if(S.length!==k.length)return!1;for(k=0;k<S.length;k++){var j=S[k];if(!ee.call(g,j)||!Wa(f[j],g[j]))return!1}return!0}function Ed(f){for(;f&&f.firstChild;)f=f.firstChild;return f}function cc(f,g){var S=Ed(f);f=0;for(var k;S;){if(S.nodeType===3){if(k=f+S.textContent.length,f<=g&&k>=g)return{node:S,offset:g-f};f=k}e:{for(;S;){if(S.nextSibling){S=S.nextSibling;break e}S=S.parentNode}S=void 0}S=Ed(S)}}function Lf(f,g){return f&&g?f===g?!0:f&&f.nodeType===3?!1:g&&g.nodeType===3?Lf(f,g.parentNode):"contains"in f?f.contains(g):f.compareDocumentPosition?!!(f.compareDocumentPosition(g)&16):!1:!1}function kf(){for(var f=window,g=Yo();g instanceof f.HTMLIFrameElement;){try{var S=typeof g.contentWindow.location.href=="string"}catch{S=!1}if(S)f=g.contentWindow;else break;g=Yo(f.document)}return g}function qu(f){var g=f&&f.nodeName&&f.nodeName.toLowerCase();return g&&(g==="input"&&(f.type==="text"||f.type==="search"||f.type==="tel"||f.type==="url"||f.type==="password")||g==="textarea"||f.contentEditable==="true")}function Dc(f){var g=kf(),S=f.focusedElem,k=f.selectionRange;if(g!==S&&S&&S.ownerDocument&&Lf(S.ownerDocument.documentElement,S)){if(k!==null&&qu(S)){if(g=k.start,f=k.end,f===void 0&&(f=g),"selectionStart"in S)S.selectionStart=g,S.selectionEnd=Math.min(f,S.value.length);else if(f=(g=S.ownerDocument||document)&&g.defaultView||window,f.getSelection){f=f.getSelection();var j=S.textContent.length,K=Math.min(k.start,j);k=k.end===void 0?K:Math.min(k.end,j),!f.extend&&K>k&&(j=k,k=K,K=j),j=cc(S,K);var fe=cc(S,k);j&&fe&&(f.rangeCount!==1||f.anchorNode!==j.node||f.anchorOffset!==j.offset||f.focusNode!==fe.node||f.focusOffset!==fe.offset)&&(g=g.createRange(),g.setStart(j.node,j.offset),f.removeAllRanges(),K>k?(f.addRange(g),f.extend(fe.node,fe.offset)):(g.setEnd(fe.node,fe.offset),f.addRange(g)))}}for(g=[],f=S;f=f.parentNode;)f.nodeType===1&&g.push({element:f,left:f.scrollLeft,top:f.scrollTop});for(typeof S.focus=="function"&&S.focus(),S=0;S<g.length;S++)f=g[S],f.element.scrollLeft=f.left,f.element.scrollTop=f.top}}var Dh=s&&"documentMode"in document&&11>=document.documentMode,yo=null,Lh=null,Ul=null,Lc=!1;function Sd(f,g,S){var k=S.window===S?S.document:S.nodeType===9?S:S.ownerDocument;Lc||yo==null||yo!==Yo(k)||(k=yo,"selectionStart"in k&&qu(k)?k={start:k.selectionStart,end:k.selectionEnd}:(k=(k.ownerDocument&&k.ownerDocument.defaultView||window).getSelection(),k={anchorNode:k.anchorNode,anchorOffset:k.anchorOffset,focusNode:k.focusNode,focusOffset:k.focusOffset}),Ul&&Hu(Ul,k)||(Ul=k,k=pu(Lh,"onSelect"),0<k.length&&(g=new Bl("onSelect","select",null,g,S),f.push({event:g,listeners:k}),g.target=yo)))}function hu(f,g){var S={};return S[f.toLowerCase()]=g.toLowerCase(),S["Webkit"+f]="webkit"+g,S["Moz"+f]="moz"+g,S}var uo={animationend:hu("Animation","AnimationEnd"),animationiteration:hu("Animation","AnimationIteration"),animationstart:hu("Animation","AnimationStart"),transitionend:hu("Transition","TransitionEnd")},$u={},zt={};s&&(zt=document.createElement("div").style,"AnimationEvent"in window||(delete uo.animationend.animation,delete uo.animationiteration.animation,delete uo.animationstart.animation),"TransitionEvent"in window||delete uo.transitionend.transition);function Wu(f){if($u[f])return $u[f];if(!uo[f])return f;var g=uo[f],S;for(S in g)if(g.hasOwnProperty(S)&&S in zt)return $u[f]=g[S];return f}var kh=Wu("animationend"),zh=Wu("animationiteration"),Zu=Wu("animationstart"),kc=Wu("transitionend"),Ea=new Map,Fh="abort auxClick cancel canPlay canPlayThrough click close contextMenu copy cut drag dragEnd dragEnter dragExit dragLeave dragOver dragStart drop durationChange emptied encrypted ended error gotPointerCapture input invalid keyDown keyPress keyUp load loadedData loadedMetadata loadStart lostPointerCapture mouseDown mouseMove mouseOut mouseOver mouseUp paste pause play playing pointerCancel pointerDown pointerMove pointerOut pointerOver pointerUp progress rateChange reset resize seeked seeking stalled submit suspend timeUpdate touchCancel touchEnd touchStart volumeChange scroll toggle touchMove waiting wheel".split(" ");function qo(f,g){Ea.set(f,g),z(g,[f])}for(var du=0;du<Fh.length;du++){var Sa=Fh[du],fn=Sa.toLowerCase(),bm=Sa[0].toUpperCase()+Sa.slice(1);qo(fn,"on"+bm)}qo(kh,"onAnimationEnd"),qo(zh,"onAnimationIteration"),qo(Zu,"onAnimationStart"),qo("dblclick","onDoubleClick"),qo("focusin","onFocus"),qo("focusout","onBlur"),qo(kc,"onTransitionEnd"),U("onMouseEnter",["mouseout","mouseover"]),U("onMouseLeave",["mouseout","mouseover"]),U("onPointerEnter",["pointerout","pointerover"]),U("onPointerLeave",["pointerout","pointerover"]),z("onChange","change click focusin focusout input keydown keyup selectionchange".split(" ")),z("onSelect","focusout contextmenu dragend focusin keydown keyup mousedown mouseup selectionchange".split(" ")),z("onBeforeInput",["compositionend","keypress","textInput","paste"]),z("onCompositionEnd","compositionend focusout keydown keypress keyup mousedown".split(" ")),z("onCompositionStart","compositionstart focusout keydown keypress keyup mousedown".split(" ")),z("onCompositionUpdate","compositionupdate focusout keydown keypress keyup mousedown".split(" "));var fu="abort canplay canplaythrough durationchange emptied encrypted ended error loadeddata loadedmetadata loadstart pause play playing progress ratechange resize seeked seeking stalled suspend timeupdate volumechange waiting".split(" "),Tm=new Set("cancel close invalid load scroll toggle".split(" ").concat(fu));function Id(f,g,S){var k=f.type||"unknown-event";f.currentTarget=S,Ct(k,g,void 0,f),f.currentTarget=null}function zf(f,g){g=(g&4)!==0;for(var S=0;S<f.length;S++){var k=f[S],j=k.event;k=k.listeners;e:{var K=void 0;if(g)for(var fe=k.length-1;0<=fe;fe--){var Ne=k[fe],Je=Ne.instance,Ft=Ne.currentTarget;if(Ne=Ne.listener,Je!==K&&j.isPropagationStopped())break e;Id(j,Ne,Ft),K=Je}else for(fe=0;fe<k.length;fe++){if(Ne=k[fe],Je=Ne.instance,Ft=Ne.currentTarget,Ne=Ne.listener,Je!==K&&j.isPropagationStopped())break e;Id(j,Ne,Ft),K=Je}}}if(Ae)throw f=$e,Ae=!1,$e=null,f}function rn(f,g){var S=g[Fc];S===void 0&&(S=g[Fc]=new Set);var k=f+"__bubble";S.has(k)||(Ep(g,f,2,!1),S.add(k))}function Ff(f,g,S){var k=0;g&&(k|=4),Ep(S,f,k,g)}var Ad="_reactListening"+Math.random().toString(36).slice(2);function Oh(f){if(!f[Ad]){f[Ad]=!0,E.forEach(function(S){S!=="selectionchange"&&(Tm.has(S)||Ff(S,!1,f),Ff(S,!0,f))});var g=f.nodeType===9?f:f.ownerDocument;g===null||g[Ad]||(g[Ad]=!0,Ff("selectionchange",!1,g))}}function Ep(f,g,S,k){switch(ba(g)){case 1:var j=Yr;break;case 4:j=nc;break;default:j=Gu}S=j.bind(null,g,S,f),j=void 0,!Q||g!=="touchstart"&&g!=="touchmove"&&g!=="wheel"||(j=!0),k?j!==void 0?f.addEventListener(g,S,{capture:!0,passive:j}):f.addEventListener(g,S,!0):j!==void 0?f.addEventListener(g,S,{passive:j}):f.addEventListener(g,S,!1)}function Cd(f,g,S,k,j){var K=k;if((g&1)===0&&(g&2)===0&&k!==null)e:for(;;){if(k===null)return;var fe=k.tag;if(fe===3||fe===4){var Ne=k.stateNode.containerInfo;if(Ne===j||Ne.nodeType===8&&Ne.parentNode===j)break;if(fe===4)for(fe=k.return;fe!==null;){var Je=fe.tag;if((Je===3||Je===4)&&(Je=fe.stateNode.containerInfo,Je===j||Je.nodeType===8&&Je.parentNode===j))return;fe=fe.return}for(;Ne!==null;){if(fe=mu(Ne),fe===null)return;if(Je=fe.tag,Je===5||Je===6){k=K=fe;continue e}Ne=Ne.parentNode}}k=k.return}vn(function(){var Ft=K,ai=Ml(S),hi=[];e:{var ci=Ea.get(f);if(ci!==void 0){var Oi=Bl,qi=f;switch(f){case"keypress":if(Js(S)===0)break e;case"keydown":case"keyup":Oi=W;break;case"focusin":qi="focus",Oi=bn;break;case"focusout":qi="blur",Oi=bn;break;case"beforeblur":case"afterblur":Oi=bn;break;case"click":if(S.button===2)break e;case"auxclick":case"dblclick":case"mousedown":case"mousemove":case"mouseup":case"mouseout":case"mouseover":case"contextmenu":Oi=co;break;case"drag":case"dragend":case"dragenter":case"dragexit":case"dragleave":case"dragover":case"dragstart":case"drop":Oi=rc;break;case"touchcancel":case"touchend":case"touchmove":case"touchstart":Oi=Mt;break;case kh:case zh:case Zu:Oi=Cs;break;case kc:Oi=Yn;break;case"scroll":Oi=xd;break;case"wheel":Oi=ui;break;case"copy":case"cut":case"paste":Oi=On;break;case"gotpointercapture":case"lostpointercapture":case"pointercancel":case"pointerdown":case"pointermove":case"pointerout":case"pointerover":case"pointerup":Oi=Se}var Wi=(g&4)!==0,$s=!Wi&&f==="scroll",yt=Wi?ci!==null?ci+"Capture":null:ci;Wi=[];for(var st=Ft,Pt;st!==null;){Pt=st;var xi=Pt.stateNode;if(Pt.tag===5&&xi!==null&&(Pt=xi,yt!==null&&(xi=ke(st,yt),xi!=null&&Wi.push(Bh(st,xi,Pt)))),$s)break;st=st.return}0<Wi.length&&(ci=new Oi(ci,qi,null,S,ai),hi.push({event:ci,listeners:Wi}))}}if((g&7)===0){e:{if(ci=f==="mouseover"||f==="pointerover",Oi=f==="mouseout"||f==="pointerout",ci&&S!==nr&&(qi=S.relatedTarget||S.fromElement)&&(mu(qi)||qi[ql]))break e;if((Oi||ci)&&(ci=ai.window===ai?ai:(ci=ai.ownerDocument)?ci.defaultView||ci.parentWindow:window,Oi?(qi=S.relatedTarget||S.toElement,Oi=Ft,qi=qi?mu(qi):null,qi!==null&&($s=lt(qi),qi!==$s||qi.tag!==5&&qi.tag!==6)&&(qi=null)):(Oi=null,qi=Ft),Oi!==qi)){if(Wi=co,xi="onMouseLeave",yt="onMouseEnter",st="mouse",(f==="pointerout"||f==="pointerover")&&(Wi=Se,xi="onPointerLeave",yt="onPointerEnter",st="pointer"),$s=Oi==null?ci:Oc(Oi),Pt=qi==null?ci:Oc(qi),ci=new Wi(xi,st+"leave",Oi,S,ai),ci.target=$s,ci.relatedTarget=Pt,xi=null,mu(ai)===Ft&&(Wi=new Wi(yt,st+"enter",qi,S,ai),Wi.target=Pt,Wi.relatedTarget=$s,xi=Wi),$s=xi,Oi&&qi)t:{for(Wi=Oi,yt=qi,st=0,Pt=Wi;Pt;Pt=Xu(Pt))st++;for(Pt=0,xi=yt;xi;xi=Xu(xi))Pt++;for(;0<st-Pt;)Wi=Xu(Wi),st--;for(;0<Pt-st;)yt=Xu(yt),Pt--;for(;st--;){if(Wi===yt||yt!==null&&Wi===yt.alternate)break t;Wi=Xu(Wi),yt=Xu(yt)}Wi=null}else Wi=null;Oi!==null&&Of(hi,ci,Oi,Wi,!1),qi!==null&&$s!==null&&Of(hi,$s,qi,Wi,!0)}}e:{if(ci=Ft?Oc(Ft):window,Oi=ci.nodeName&&ci.nodeName.toLowerCase(),Oi==="select"||Oi==="input"&&ci.type==="file")var nn=vm;else if(Ms(ci))if(ac)nn=Tp;else{nn=Mc;var In=Df}else(Oi=ci.nodeName)&&Oi.toLowerCase()==="input"&&(ci.type==="checkbox"||ci.type==="radio")&&(nn=xm);if(nn&&(nn=nn(f,Ft))){bd(hi,nn,S,ai);break e}In&&In(f,ci,Ft),f==="focusout"&&(In=ci._wrapperState)&&In.controlled&&ci.type==="number"&&Zn(ci,"number",ci.value)}switch(In=Ft?Oc(Ft):window,f){case"focusin":(Ms(In)||In.contentEditable==="true")&&(yo=In,Lh=Ft,Ul=null);break;case"focusout":Ul=Lh=yo=null;break;case"mousedown":Lc=!0;break;case"contextmenu":case"mouseup":case"dragend":Lc=!1,Sd(hi,S,ai);break;case"selectionchange":if(Dh)break;case"keydown":case"keyup":Sd(hi,S,ai)}var An;if(Ur)e:{switch(f){case"compositionstart":var qn="onCompositionStart";break e;case"compositionend":qn="onCompositionEnd";break e;case"compositionupdate":qn="onCompositionUpdate";break e}qn=void 0}else cu?lu(f,S)&&(qn="onCompositionEnd"):f==="keydown"&&S.keyCode===229&&(qn="onCompositionStart");qn&&(dl&&S.locale!=="ko"&&(cu||qn!=="onCompositionStart"?qn==="onCompositionEnd"&&cu&&(An=hl()):(ds=ai,Cc="value"in ds?ds.value:ds.textContent,cu=!0)),In=pu(Ft,qn),0<In.length&&(qn=new sc(qn,f,null,S,ai),hi.push({event:qn,listeners:In}),An?qn.data=An:(An=oc(S),An!==null&&(qn.data=An)))),(An=gr?$a(f,S):Co(f,S))&&(Ft=pu(Ft,"onBeforeInput"),0<Ft.length&&(ai=new sc("onBeforeInput","beforeinput",null,S,ai),hi.push({event:ai,listeners:Ft}),ai.data=An))}zf(hi,g)})}function Bh(f,g,S){return{instance:f,listener:g,currentTarget:S}}function pu(f,g){for(var S=g+"Capture",k=[];f!==null;){var j=f,K=j.stateNode;j.tag===5&&K!==null&&(j=K,K=ke(f,S),K!=null&&k.unshift(Bh(f,K,j)),K=ke(f,g),K!=null&&k.push(Bh(f,K,j))),f=f.return}return k}function Xu(f){if(f===null)return null;do f=f.return;while(f&&f.tag!==5);return f||null}function Of(f,g,S,k,j){for(var K=g._reactName,fe=[];S!==null&&S!==k;){var Ne=S,Je=Ne.alternate,Ft=Ne.stateNode;if(Je!==null&&Je===k)break;Ne.tag===5&&Ft!==null&&(Ne=Ft,j?(Je=ke(S,K),Je!=null&&fe.unshift(Bh(S,Je,Ne))):j||(Je=ke(S,K),Je!=null&&fe.push(Bh(S,Je,Ne)))),S=S.return}fe.length!==0&&f.push({event:g,listeners:fe})}var Bf=/\r\n?/g,Pd=/\u0000|\uFFFD/g;function Rd(f){return(typeof f=="string"?f:""+f).replace(Bf,`
`).replace(Pd,"")}function jl(f,g,S){if(g=Rd(g),Rd(f)!==g&&S)throw Error(m(425))}function uc(){}var Ku=null,Yu=null;function zc(f,g){return f==="textarea"||f==="noscript"||typeof g.children=="string"||typeof g.children=="number"||typeof g.dangerouslySetInnerHTML=="object"&&g.dangerouslySetInnerHTML!==null&&g.dangerouslySetInnerHTML.__html!=null}var Md=typeof setTimeout=="function"?setTimeout:void 0,Nf=typeof clearTimeout=="function"?clearTimeout:void 0,Vf=typeof Promise=="function"?Promise:void 0,Qu=typeof queueMicrotask=="function"?queueMicrotask:typeof Vf<"u"?function(f){return Vf.resolve(null).then(f).catch(Dd)}:Md;function Dd(f){setTimeout(function(){throw f})}function Ju(f,g){var S=g,k=0;do{var j=S.nextSibling;if(f.removeChild(S),j&&j.nodeType===8)if(S=j.data,S==="/$"){if(k===0){f.removeChild(j),Ua(g);return}k--}else S!=="$"&&S!=="$?"&&S!=="$!"||k++;S=j}while(S);Ua(g)}function Gl(f){for(;f!=null;f=f.nextSibling){var g=f.nodeType;if(g===1||g===3)break;if(g===8){if(g=f.data,g==="$"||g==="$!"||g==="$?")break;if(g==="/$")return null}}return f}function Nh(f){f=f.previousSibling;for(var g=0;f;){if(f.nodeType===8){var S=f.data;if(S==="$"||S==="$!"||S==="$?"){if(g===0)return f;g--}else S==="/$"&&g++}f=f.previousSibling}return null}var Hl=Math.random().toString(36).slice(2),fl="__reactFiber$"+Hl,eh="__reactProps$"+Hl,ql="__reactContainer$"+Hl,Fc="__reactEvents$"+Hl,Sp="__reactListeners$"+Hl,Uf="__reactHandles$"+Hl;function mu(f){var g=f[fl];if(g)return g;for(var S=f.parentNode;S;){if(g=S[ql]||S[fl]){if(S=g.alternate,g.child!==null||S!==null&&S.child!==null)for(f=Nh(f);f!==null;){if(S=f[fl])return S;f=Nh(f)}return g}f=S,S=f.parentNode}return null}function th(f){return f=f[fl]||f[ql],!f||f.tag!==5&&f.tag!==6&&f.tag!==13&&f.tag!==3?null:f}function Oc(f){if(f.tag===5||f.tag===6)return f.stateNode;throw Error(m(33))}function ih(f){return f[eh]||null}var Vh=[],hc=-1;function $l(f){return{current:f}}function jr(f){0>hc||(f.current=Vh[hc],Vh[hc]=null,hc--)}function os(f,g){hc++,Vh[hc]=f.current,f.current=g}var Ia={},Us=$l(Ia),vo=$l(!1),Ls=Ia;function Bc(f,g){var S=f.type.contextTypes;if(!S)return Ia;var k=f.stateNode;if(k&&k.__reactInternalMemoizedUnmaskedChildContext===g)return k.__reactInternalMemoizedMaskedChildContext;var j={},K;for(K in S)j[K]=g[K];return k&&(f=f.stateNode,f.__reactInternalMemoizedUnmaskedChildContext=g,f.__reactInternalMemoizedMaskedChildContext=j),j}function xo(f){return f=f.childContextTypes,f!=null}function Nc(){jr(vo),jr(Us)}function Uh(f,g,S){if(Us.current!==Ia)throw Error(m(168));os(Us,g),os(vo,S)}function Ld(f,g,S){var k=f.stateNode;if(g=g.childContextTypes,typeof k.getChildContext!="function")return S;k=k.getChildContext();for(var j in k)if(!(j in g))throw Error(m(108,Ji(f)||"Unknown",j));return Ai({},S,k)}function nh(f){return f=(f=f.stateNode)&&f.__reactInternalMemoizedMergedChildContext||Ia,Ls=Us.current,os(Us,f),os(vo,vo.current),!0}function jh(f,g,S){var k=f.stateNode;if(!k)throw Error(m(169));S?(f=Ld(f,g,Ls),k.__reactInternalMemoizedMergedChildContext=f,jr(vo),jr(Us),os(Us,f)):jr(vo),os(vo,S)}var Za=null,_u=!1,dc=!1;function kd(f){Za===null?Za=[f]:Za.push(f)}function jf(f){_u=!0,kd(f)}function fc(){if(!dc&&Za!==null){dc=!0;var f=0,g=Kn;try{var S=Za;for(Kn=1;f<S.length;f++){var k=S[f];do k=k(!0);while(k!==null)}Za=null,_u=!1}catch(j){throw Za!==null&&(Za=Za.slice(f+1)),Yi(jn,fc),j}finally{Kn=g,dc=!1}}return null}var pl=[],gu=0,Gh=null,zd=0,Xa=[],Ka=0,Wl=null,ml=1,_l="";function Vc(f,g){pl[gu++]=zd,pl[gu++]=Gh,Gh=f,zd=g}function yu(f,g,S){Xa[Ka++]=ml,Xa[Ka++]=_l,Xa[Ka++]=Wl,Wl=f;var k=ml;f=_l;var j=32-Ks(k)-1;k&=~(1<<j),S+=1;var K=32-Ks(g)+j;if(30<K){var fe=j-j%5;K=(k&(1<<fe)-1).toString(32),k>>=fe,j-=fe,ml=1<<32-Ks(g)+j|S<<j|k,_l=K+f}else ml=1<<K|S<<j|k,_l=f}function Hh(f){f.return!==null&&(Vc(f,1),yu(f,1,0))}function Fd(f){for(;f===Gh;)Gh=pl[--gu],pl[gu]=null,zd=pl[--gu],pl[gu]=null;for(;f===Wl;)Wl=Xa[--Ka],Xa[Ka]=null,_l=Xa[--Ka],Xa[Ka]=null,ml=Xa[--Ka],Xa[Ka]=null}var ia=null,Po=null,Gr=!1,Aa=null;function pc(f,g){var S=pr(5,null,null,0);S.elementType="DELETED",S.stateNode=g,S.return=f,g=f.deletions,g===null?(f.deletions=[S],f.flags|=16):g.push(S)}function mc(f,g){switch(f.tag){case 5:var S=f.type;return g=g.nodeType!==1||S.toLowerCase()!==g.nodeName.toLowerCase()?null:g,g!==null?(f.stateNode=g,ia=f,Po=Gl(g.firstChild),!0):!1;case 6:return g=f.pendingProps===""||g.nodeType!==3?null:g,g!==null?(f.stateNode=g,ia=f,Po=null,!0):!1;case 13:return g=g.nodeType!==8?null:g,g!==null?(S=Wl!==null?{id:ml,overflow:_l}:null,f.memoizedState={dehydrated:g,treeContext:S,retryLane:1073741824},S=pr(18,null,null,0),S.stateNode=g,S.return=f,f.child=S,ia=f,Po=null,!0):!1;default:return!1}}function rh(f){return(f.mode&1)!==0&&(f.flags&128)===0}function Od(f){if(Gr){var g=Po;if(g){var S=g;if(!mc(f,g)){if(rh(f))throw Error(m(418));g=Gl(S.nextSibling);var k=ia;g&&mc(f,g)?pc(k,S):(f.flags=f.flags&-4097|2,Gr=!1,ia=f)}}else{if(rh(f))throw Error(m(418));f.flags=f.flags&-4097|2,Gr=!1,ia=f}}}function Gf(f){for(f=f.return;f!==null&&f.tag!==5&&f.tag!==3&&f.tag!==13;)f=f.return;ia=f}function vu(f){if(f!==ia)return!1;if(!Gr)return Gf(f),Gr=!0,!1;var g;if((g=f.tag!==3)&&!(g=f.tag!==5)&&(g=f.type,g=g!=="head"&&g!=="body"&&!zc(f.type,f.memoizedProps)),g&&(g=Po)){if(rh(f))throw qh(),Error(m(418));for(;g;)pc(f,g),g=Gl(g.nextSibling)}if(Gf(f),f.tag===13){if(f=f.memoizedState,f=f!==null?f.dehydrated:null,!f)throw Error(m(317));e:{for(f=f.nextSibling,g=0;f;){if(f.nodeType===8){var S=f.data;if(S==="/$"){if(g===0){Po=Gl(f.nextSibling);break e}g--}else S!=="$"&&S!=="$!"&&S!=="$?"||g++}f=f.nextSibling}Po=null}}else Po=ia?Gl(f.stateNode.nextSibling):null;return!0}function qh(){for(var f=Po;f;)f=Gl(f.nextSibling)}function xu(){Po=ia=null,Gr=!1}function $h(f){Aa===null?Aa=[f]:Aa.push(f)}var wu=en.ReactCurrentBatchConfig;function bu(f,g,S){if(f=S.ref,f!==null&&typeof f!="function"&&typeof f!="object"){if(S._owner){if(S=S._owner,S){if(S.tag!==1)throw Error(m(309));var k=S.stateNode}if(!k)throw Error(m(147,f));var j=k,K=""+f;return g!==null&&g.ref!==null&&typeof g.ref=="function"&&g.ref._stringRef===K?g.ref:(g=function(fe){var Ne=j.refs;fe===null?delete Ne[K]:Ne[K]=fe},g._stringRef=K,g)}if(typeof f!="string")throw Error(m(284));if(!S._owner)throw Error(m(290,f))}return f}function Wh(f,g){throw f=Object.prototype.toString.call(g),Error(m(31,f==="[object Object]"?"object with keys {"+Object.keys(g).join(", ")+"}":f))}function Hf(f){var g=f._init;return g(f._payload)}function _c(f){function g(yt,st){if(f){var Pt=yt.deletions;Pt===null?(yt.deletions=[st],yt.flags|=16):Pt.push(st)}}function S(yt,st){if(!f)return null;for(;st!==null;)g(yt,st),st=st.sibling;return null}function k(yt,st){for(yt=new Map;st!==null;)st.key!==null?yt.set(st.key,st):yt.set(st.index,st),st=st.sibling;return yt}function j(yt,st){return yt=po(yt,st),yt.index=0,yt.sibling=null,yt}function K(yt,st,Pt){return yt.index=Pt,f?(Pt=yt.alternate,Pt!==null?(Pt=Pt.index,Pt<st?(yt.flags|=2,st):Pt):(yt.flags|=2,st)):(yt.flags|=1048576,st)}function fe(yt){return f&&yt.alternate===null&&(yt.flags|=2),yt}function Ne(yt,st,Pt,xi){return st===null||st.tag!==6?(st=Wo(Pt,yt.mode,xi),st.return=yt,st):(st=j(st,Pt),st.return=yt,st)}function Je(yt,st,Pt,xi){var nn=Pt.type;return nn===rt?ai(yt,st,Pt.props.children,xi,Pt.key):st!==null&&(st.elementType===nn||typeof nn=="object"&&nn!==null&&nn.$$typeof===wn&&Hf(nn)===st.type)?(xi=j(st,Pt.props),xi.ref=bu(yt,st,Pt),xi.return=yt,xi):(xi=no(Pt.type,Pt.key,Pt.props,null,yt.mode,xi),xi.ref=bu(yt,st,Pt),xi.return=yt,xi)}function Ft(yt,st,Pt,xi){return st===null||st.tag!==4||st.stateNode.containerInfo!==Pt.containerInfo||st.stateNode.implementation!==Pt.implementation?(st=aa(Pt,yt.mode,xi),st.return=yt,st):(st=j(st,Pt.children||[]),st.return=yt,st)}function ai(yt,st,Pt,xi,nn){return st===null||st.tag!==7?(st=qs(Pt,yt.mode,xi,nn),st.return=yt,st):(st=j(st,Pt),st.return=yt,st)}function hi(yt,st,Pt){if(typeof st=="string"&&st!==""||typeof st=="number")return st=Wo(""+st,yt.mode,Pt),st.return=yt,st;if(typeof st=="object"&&st!==null){switch(st.$$typeof){case Hn:return Pt=no(st.type,st.key,st.props,null,yt.mode,Pt),Pt.ref=bu(yt,null,st),Pt.return=yt,Pt;case _n:return st=aa(st,yt.mode,Pt),st.return=yt,st;case wn:var xi=st._init;return hi(yt,xi(st._payload),Pt)}if(fr(st)||Ui(st))return st=qs(st,yt.mode,Pt,null),st.return=yt,st;Wh(yt,st)}return null}function ci(yt,st,Pt,xi){var nn=st!==null?st.key:null;if(typeof Pt=="string"&&Pt!==""||typeof Pt=="number")return nn!==null?null:Ne(yt,st,""+Pt,xi);if(typeof Pt=="object"&&Pt!==null){switch(Pt.$$typeof){case Hn:return Pt.key===nn?Je(yt,st,Pt,xi):null;case _n:return Pt.key===nn?Ft(yt,st,Pt,xi):null;case wn:return nn=Pt._init,ci(yt,st,nn(Pt._payload),xi)}if(fr(Pt)||Ui(Pt))return nn!==null?null:ai(yt,st,Pt,xi,null);Wh(yt,Pt)}return null}function Oi(yt,st,Pt,xi,nn){if(typeof xi=="string"&&xi!==""||typeof xi=="number")return yt=yt.get(Pt)||null,Ne(st,yt,""+xi,nn);if(typeof xi=="object"&&xi!==null){switch(xi.$$typeof){case Hn:return yt=yt.get(xi.key===null?Pt:xi.key)||null,Je(st,yt,xi,nn);case _n:return yt=yt.get(xi.key===null?Pt:xi.key)||null,Ft(st,yt,xi,nn);case wn:var In=xi._init;return Oi(yt,st,Pt,In(xi._payload),nn)}if(fr(xi)||Ui(xi))return yt=yt.get(Pt)||null,ai(st,yt,xi,nn,null);Wh(st,xi)}return null}function qi(yt,st,Pt,xi){for(var nn=null,In=null,An=st,qn=st=0,bo=null;An!==null&&qn<Pt.length;qn++){An.index>qn?(bo=An,An=null):bo=An.sibling;var $r=ci(yt,An,Pt[qn],xi);if($r===null){An===null&&(An=bo);break}f&&An&&$r.alternate===null&&g(yt,An),st=K($r,st,qn),In===null?nn=$r:In.sibling=$r,In=$r,An=bo}if(qn===Pt.length)return S(yt,An),Gr&&Vc(yt,qn),nn;if(An===null){for(;qn<Pt.length;qn++)An=hi(yt,Pt[qn],xi),An!==null&&(st=K(An,st,qn),In===null?nn=An:In.sibling=An,In=An);return Gr&&Vc(yt,qn),nn}for(An=k(yt,An);qn<Pt.length;qn++)bo=Oi(An,yt,qn,Pt[qn],xi),bo!==null&&(f&&bo.alternate!==null&&An.delete(bo.key===null?qn:bo.key),st=K(bo,st,qn),In===null?nn=bo:In.sibling=bo,In=bo);return f&&An.forEach(function(yh){return g(yt,yh)}),Gr&&Vc(yt,qn),nn}function Wi(yt,st,Pt,xi){var nn=Ui(Pt);if(typeof nn!="function")throw Error(m(150));if(Pt=nn.call(Pt),Pt==null)throw Error(m(151));for(var In=nn=null,An=st,qn=st=0,bo=null,$r=Pt.next();An!==null&&!$r.done;qn++,$r=Pt.next()){An.index>qn?(bo=An,An=null):bo=An.sibling;var yh=ci(yt,An,$r.value,xi);if(yh===null){An===null&&(An=bo);break}f&&An&&yh.alternate===null&&g(yt,An),st=K(yh,st,qn),In===null?nn=yh:In.sibling=yh,In=yh,An=bo}if($r.done)return S(yt,An),Gr&&Vc(yt,qn),nn;if(An===null){for(;!$r.done;qn++,$r=Pt.next())$r=hi(yt,$r.value,xi),$r!==null&&(st=K($r,st,qn),In===null?nn=$r:In.sibling=$r,In=$r);return Gr&&Vc(yt,qn),nn}for(An=k(yt,An);!$r.done;qn++,$r=Pt.next())$r=Oi(An,yt,qn,$r.value,xi),$r!==null&&(f&&$r.alternate!==null&&An.delete($r.key===null?qn:$r.key),st=K($r,st,qn),In===null?nn=$r:In.sibling=$r,In=$r);return f&&An.forEach(function(j_){return g(yt,j_)}),Gr&&Vc(yt,qn),nn}function $s(yt,st,Pt,xi){if(typeof Pt=="object"&&Pt!==null&&Pt.type===rt&&Pt.key===null&&(Pt=Pt.props.children),typeof Pt=="object"&&Pt!==null){switch(Pt.$$typeof){case Hn:e:{for(var nn=Pt.key,In=st;In!==null;){if(In.key===nn){if(nn=Pt.type,nn===rt){if(In.tag===7){S(yt,In.sibling),st=j(In,Pt.props.children),st.return=yt,yt=st;break e}}else if(In.elementType===nn||typeof nn=="object"&&nn!==null&&nn.$$typeof===wn&&Hf(nn)===In.type){S(yt,In.sibling),st=j(In,Pt.props),st.ref=bu(yt,In,Pt),st.return=yt,yt=st;break e}S(yt,In);break}else g(yt,In);In=In.sibling}Pt.type===rt?(st=qs(Pt.props.children,yt.mode,xi,Pt.key),st.return=yt,yt=st):(xi=no(Pt.type,Pt.key,Pt.props,null,yt.mode,xi),xi.ref=bu(yt,st,Pt),xi.return=yt,yt=xi)}return fe(yt);case _n:e:{for(In=Pt.key;st!==null;){if(st.key===In)if(st.tag===4&&st.stateNode.containerInfo===Pt.containerInfo&&st.stateNode.implementation===Pt.implementation){S(yt,st.sibling),st=j(st,Pt.children||[]),st.return=yt,yt=st;break e}else{S(yt,st);break}else g(yt,st);st=st.sibling}st=aa(Pt,yt.mode,xi),st.return=yt,yt=st}return fe(yt);case wn:return In=Pt._init,$s(yt,st,In(Pt._payload),xi)}if(fr(Pt))return qi(yt,st,Pt,xi);if(Ui(Pt))return Wi(yt,st,Pt,xi);Wh(yt,Pt)}return typeof Pt=="string"&&Pt!==""||typeof Pt=="number"?(Pt=""+Pt,st!==null&&st.tag===6?(S(yt,st.sibling),st=j(st,Pt),st.return=yt,yt=st):(S(yt,st),st=Wo(Pt,yt.mode,xi),st.return=yt,yt=st),fe(yt)):S(yt,st)}return $s}var Uc=_c(!0),Bd=_c(!1),Zl=$l(null),Tu=null,Ca=null,Zh=null;function gc(){Zh=Ca=Tu=null}function Eu(f){var g=Zl.current;jr(Zl),f._currentValue=g}function Xh(f,g,S){for(;f!==null;){var k=f.alternate;if((f.childLanes&g)!==g?(f.childLanes|=g,k!==null&&(k.childLanes|=g)):k!==null&&(k.childLanes&g)!==g&&(k.childLanes|=g),f===S)break;f=f.return}}function Su(f,g){Tu=f,Zh=Ca=null,f=f.dependencies,f!==null&&f.firstContext!==null&&((f.lanes&g)!==0&&(zs=!0),f.firstContext=null)}function na(f){var g=f._currentValue;if(Zh!==f)if(f={context:f,memoizedValue:g,next:null},Ca===null){if(Tu===null)throw Error(m(308));Ca=f,Tu.dependencies={lanes:0,firstContext:f}}else Ca=Ca.next=f;return g}var ra=null;function Iu(f){ra===null?ra=[f]:ra.push(f)}function Kt(f,g,S,k){var j=g.interleaved;return j===null?(S.next=S,Iu(g)):(S.next=j.next,j.next=S),g.interleaved=S,Ya(f,k)}function Ya(f,g){f.lanes|=g;var S=f.alternate;for(S!==null&&(S.lanes|=g),S=f,f=f.return;f!==null;)f.childLanes|=g,S=f.alternate,S!==null&&(S.childLanes|=g),S=f,f=f.return;return S.tag===3?S.stateNode:null}var Qa=!1;function gl(f){f.updateQueue={baseState:f.memoizedState,firstBaseUpdate:null,lastBaseUpdate:null,shared:{pending:null,interleaved:null,lanes:0},effects:null}}function Ro(f,g){f=f.updateQueue,g.updateQueue===f&&(g.updateQueue={baseState:f.baseState,firstBaseUpdate:f.firstBaseUpdate,lastBaseUpdate:f.lastBaseUpdate,shared:f.shared,effects:f.effects})}function fi(f,g){return{eventTime:f,lane:g,tag:0,payload:null,callback:null,next:null}}function Xl(f,g,S){var k=f.updateQueue;if(k===null)return null;if(k=k.shared,(v&2)!==0){var j=k.pending;return j===null?g.next=g:(g.next=j.next,j.next=g),k.pending=g,Ya(f,S)}return j=k.interleaved,j===null?(g.next=g,Iu(k)):(g.next=j.next,j.next=g),k.interleaved=g,Ya(f,S)}function Nd(f,g,S){if(g=g.updateQueue,g!==null&&(g=g.shared,(S&4194240)!==0)){var k=g.lanes;k&=f.pendingLanes,S|=k,g.lanes=S,lo(f,S)}}function Ip(f,g){var S=f.updateQueue,k=f.alternate;if(k!==null&&(k=k.updateQueue,S===k)){var j=null,K=null;if(S=S.firstBaseUpdate,S!==null){do{var fe={eventTime:S.eventTime,lane:S.lane,tag:S.tag,payload:S.payload,callback:S.callback,next:null};K===null?j=K=fe:K=K.next=fe,S=S.next}while(S!==null);K===null?j=K=g:K=K.next=g}else j=K=g;S={baseState:k.baseState,firstBaseUpdate:j,lastBaseUpdate:K,shared:k.shared,effects:k.effects},f.updateQueue=S;return}f=S.lastBaseUpdate,f===null?S.firstBaseUpdate=g:f.next=g,S.lastBaseUpdate=g}function Au(f,g,S,k){var j=f.updateQueue;Qa=!1;var K=j.firstBaseUpdate,fe=j.lastBaseUpdate,Ne=j.shared.pending;if(Ne!==null){j.shared.pending=null;var Je=Ne,Ft=Je.next;Je.next=null,fe===null?K=Ft:fe.next=Ft,fe=Je;var ai=f.alternate;ai!==null&&(ai=ai.updateQueue,Ne=ai.lastBaseUpdate,Ne!==fe&&(Ne===null?ai.firstBaseUpdate=Ft:Ne.next=Ft,ai.lastBaseUpdate=Je))}if(K!==null){var hi=j.baseState;fe=0,ai=Ft=Je=null,Ne=K;do{var ci=Ne.lane,Oi=Ne.eventTime;if((k&ci)===ci){ai!==null&&(ai=ai.next={eventTime:Oi,lane:0,tag:Ne.tag,payload:Ne.payload,callback:Ne.callback,next:null});e:{var qi=f,Wi=Ne;switch(ci=g,Oi=S,Wi.tag){case 1:if(qi=Wi.payload,typeof qi=="function"){hi=qi.call(Oi,hi,ci);break e}hi=qi;break e;case 3:qi.flags=qi.flags&-65537|128;case 0:if(qi=Wi.payload,ci=typeof qi=="function"?qi.call(Oi,hi,ci):qi,ci==null)break e;hi=Ai({},hi,ci);break e;case 2:Qa=!0}}Ne.callback!==null&&Ne.lane!==0&&(f.flags|=64,ci=j.effects,ci===null?j.effects=[Ne]:ci.push(Ne))}else Oi={eventTime:Oi,lane:ci,tag:Ne.tag,payload:Ne.payload,callback:Ne.callback,next:null},ai===null?(Ft=ai=Oi,Je=hi):ai=ai.next=Oi,fe|=ci;if(Ne=Ne.next,Ne===null){if(Ne=j.shared.pending,Ne===null)break;ci=Ne,Ne=ci.next,ci.next=null,j.lastBaseUpdate=ci,j.shared.pending=null}}while(!0);if(ai===null&&(Je=hi),j.baseState=Je,j.firstBaseUpdate=Ft,j.lastBaseUpdate=ai,g=j.shared.interleaved,g!==null){j=g;do fe|=j.lane,j=j.next;while(j!==g)}else K===null&&(j.shared.lanes=0);$|=fe,f.lanes=fe,f.memoizedState=hi}}function Kh(f,g,S){if(f=g.effects,g.effects=null,f!==null)for(g=0;g<f.length;g++){var k=f[g],j=k.callback;if(j!==null){if(k.callback=null,k=S,typeof j!="function")throw Error(m(191,j));j.call(k)}}}var sh={},Pa=$l(sh),Yh=$l(sh),Qh=$l(sh);function js(f){if(f===sh)throw Error(m(174));return f}function Jh(f,g){switch(os(Qh,g),os(Yh,f),os(Pa,sh),f=g.nodeType,f){case 9:case 11:g=(g=g.documentElement)?g.namespaceURI:Lr(null,"");break;default:f=f===8?g.parentNode:g,g=f.namespaceURI||null,f=f.tagName,g=Lr(g,f)}jr(Pa),os(Pa,g)}function ks(){jr(Pa),jr(Yh),jr(Qh)}function yc(f){js(Qh.current);var g=js(Pa.current),S=Lr(g,f.type);g!==S&&(os(Yh,f),os(Pa,S))}function Vd(f){Yh.current===f&&(jr(Pa),jr(Yh))}var ps=$l(0);function oh(f){for(var g=f;g!==null;){if(g.tag===13){var S=g.memoizedState;if(S!==null&&(S=S.dehydrated,S===null||S.data==="$?"||S.data==="$!"))return g}else if(g.tag===19&&g.memoizedProps.revealOrder!==void 0){if((g.flags&128)!==0)return g}else if(g.child!==null){g.child.return=g,g=g.child;continue}if(g===f)break;for(;g.sibling===null;){if(g.return===null||g.return===f)return null;g=g.return}g.sibling.return=g.return,g=g.sibling}return null}var ed=[];function Ud(){for(var f=0;f<ed.length;f++)ed[f]._workInProgressVersionPrimary=null;ed.length=0}var Ra=en.ReactCurrentDispatcher,Wn=en.ReactCurrentBatchConfig,yl=0,hs=null,Ts=null,to=null,td=!1,Ja=!1,vl=0,xl=0;function _t(){throw Error(m(321))}function Wt(f,g){if(g===null)return!1;for(var S=0;S<g.length&&S<f.length;S++)if(!Wa(f[S],g[S]))return!1;return!0}function jc(f,g,S,k,j,K){if(yl=K,hs=g,g.memoizedState=null,g.updateQueue=null,g.lanes=0,Ra.current=f===null||f.memoizedState===null?qc:uh,f=S(k,j),Ja){K=0;do{if(Ja=!1,vl=0,25<=K)throw Error(m(301));K+=1,to=Ts=null,g.updateQueue=null,Ra.current=Zd,f=S(k,j)}while(Ja)}if(Ra.current=Do,g=Ts!==null&&Ts.next!==null,yl=0,to=Ts=hs=null,td=!1,g)throw Error(m(300));return f}function Fr(){var f=vl!==0;return vl=0,f}function Le(){var f={memoizedState:null,baseState:null,baseQueue:null,queue:null,next:null};return to===null?hs.memoizedState=to=f:to=to.next=f,to}function Ma(){if(Ts===null){var f=hs.alternate;f=f!==null?f.memoizedState:null}else f=Ts.next;var g=to===null?hs.memoizedState:to.next;if(g!==null)to=g,Ts=f;else{if(f===null)throw Error(m(310));Ts=f,f={memoizedState:Ts.memoizedState,baseState:Ts.baseState,baseQueue:Ts.baseQueue,queue:Ts.queue,next:null},to===null?hs.memoizedState=to=f:to=to.next=f}return to}function vc(f,g){return typeof g=="function"?g(f):g}function Cu(f){var g=Ma(),S=g.queue;if(S===null)throw Error(m(311));S.lastRenderedReducer=f;var k=Ts,j=k.baseQueue,K=S.pending;if(K!==null){if(j!==null){var fe=j.next;j.next=K.next,K.next=fe}k.baseQueue=j=K,S.pending=null}if(j!==null){K=j.next,k=k.baseState;var Ne=fe=null,Je=null,Ft=K;do{var ai=Ft.lane;if((yl&ai)===ai)Je!==null&&(Je=Je.next={lane:0,action:Ft.action,hasEagerState:Ft.hasEagerState,eagerState:Ft.eagerState,next:null}),k=Ft.hasEagerState?Ft.eagerState:f(k,Ft.action);else{var hi={lane:ai,action:Ft.action,hasEagerState:Ft.hasEagerState,eagerState:Ft.eagerState,next:null};Je===null?(Ne=Je=hi,fe=k):Je=Je.next=hi,hs.lanes|=ai,$|=ai}Ft=Ft.next}while(Ft!==null&&Ft!==K);Je===null?fe=k:Je.next=Ne,Wa(k,g.memoizedState)||(zs=!0),g.memoizedState=k,g.baseState=fe,g.baseQueue=Je,S.lastRenderedState=k}if(f=S.interleaved,f!==null){j=f;do K=j.lane,hs.lanes|=K,$|=K,j=j.next;while(j!==f)}else j===null&&(S.lanes=0);return[g.memoizedState,S.dispatch]}function Gc(f){var g=Ma(),S=g.queue;if(S===null)throw Error(m(311));S.lastRenderedReducer=f;var k=S.dispatch,j=S.pending,K=g.memoizedState;if(j!==null){S.pending=null;var fe=j=j.next;do K=f(K,fe.action),fe=fe.next;while(fe!==j);Wa(K,g.memoizedState)||(zs=!0),g.memoizedState=K,g.baseQueue===null&&(g.baseState=K),S.lastRenderedState=K}return[K,k]}function jd(){}function id(f,g){var S=hs,k=Ma(),j=g(),K=!Wa(k.memoizedState,j);if(K&&(k.memoizedState=j,zs=!0),k=k.queue,qd(Ap.bind(null,S,k,f),[f]),k.getSnapshot!==g||K||to!==null&&to.memoizedState.tag&1){if(S.flags|=2048,ah(9,wl.bind(null,S,k,j,g),void 0,null),b===null)throw Error(m(349));(yl&30)!==0||Pu(S,g,j)}return j}function Pu(f,g,S){f.flags|=16384,f={getSnapshot:g,value:S},g=hs.updateQueue,g===null?(g={lastEffect:null,stores:null},hs.updateQueue=g,g.stores=[f]):(S=g.stores,S===null?g.stores=[f]:S.push(f))}function wl(f,g,S,k){g.value=S,g.getSnapshot=k,Gd(g)&&nd(f)}function Ap(f,g,S){return S(function(){Gd(g)&&nd(f)})}function Gd(f){var g=f.getSnapshot;f=f.value;try{var S=g();return!Wa(f,S)}catch{return!0}}function nd(f){var g=Ya(f,1);g!==null&&Te(g,f,1,-1)}function Hd(f){var g=Le();return typeof f=="function"&&(f=f()),g.memoizedState=g.baseState=f,f={pending:null,interleaved:null,lanes:0,dispatch:null,lastRenderedReducer:vc,lastRenderedState:f},g.queue=f,f=f.dispatch=$f.bind(null,hs,f),[g.memoizedState,f]}function ah(f,g,S,k){return f={tag:f,create:g,destroy:S,deps:k,next:null},g=hs.updateQueue,g===null?(g={lastEffect:null,stores:null},hs.updateQueue=g,g.lastEffect=f.next=f):(S=g.lastEffect,S===null?g.lastEffect=f.next=f:(k=S.next,S.next=f,f.next=k,g.lastEffect=f)),f}function qf(){return Ma().memoizedState}function Ru(f,g,S,k){var j=Le();hs.flags|=f,j.memoizedState=ah(1|g,S,void 0,k===void 0?null:k)}function Hc(f,g,S,k){var j=Ma();k=k===void 0?null:k;var K=void 0;if(Ts!==null){var fe=Ts.memoizedState;if(K=fe.destroy,k!==null&&Wt(k,fe.deps)){j.memoizedState=ah(g,S,K,k);return}}hs.flags|=f,j.memoizedState=ah(1|g,S,K,k)}function Mu(f,g){return Ru(8390656,8,f,g)}function qd(f,g){return Hc(2048,8,f,g)}function Cp(f,g){return Hc(4,2,f,g)}function ho(f,g){return Hc(4,4,f,g)}function Pp(f,g){if(typeof g=="function")return f=f(),g(f),function(){g(null)};if(g!=null)return f=f(),g.current=f,function(){g.current=null}}function lh(f,g,S){return S=S!=null?S.concat([f]):null,Hc(4,4,Pp.bind(null,g,f),S)}function _r(){}function hn(f,g){var S=Ma();g=g===void 0?null:g;var k=S.memoizedState;return k!==null&&g!==null&&Wt(g,k[1])?k[0]:(S.memoizedState=[f,g],f)}function $d(f,g){var S=Ma();g=g===void 0?null:g;var k=S.memoizedState;return k!==null&&g!==null&&Wt(g,k[1])?k[0]:(f=f(),S.memoizedState=[f,g],f)}function Mo(f,g,S){return(yl&21)===0?(f.baseState&&(f.baseState=!1,zs=!0),f.memoizedState=S):(Wa(S,g)||(S=go(),hs.lanes|=S,$|=S,f.baseState=!0),g)}function ch(f,g){var S=Kn;Kn=S!==0&&4>S?S:4,f(!0);var k=Wn.transition;Wn.transition={};try{f(!1),g()}finally{Kn=S,Wn.transition=k}}function Du(){return Ma().memoizedState}function Lu(f,g,S){var k=ze(f);if(S={lane:k,action:S,hasEagerState:!1,eagerState:null,next:null},Wd(f))rd(g,S);else if(S=Kt(f,g,S,k),S!==null){var j=mt();Te(S,f,k,j),sd(S,g,k)}}function $f(f,g,S){var k=ze(f),j={lane:k,action:S,hasEagerState:!1,eagerState:null,next:null};if(Wd(f))rd(g,j);else{var K=f.alternate;if(f.lanes===0&&(K===null||K.lanes===0)&&(K=g.lastRenderedReducer,K!==null))try{var fe=g.lastRenderedState,Ne=K(fe,S);if(j.hasEagerState=!0,j.eagerState=Ne,Wa(Ne,fe)){var Je=g.interleaved;Je===null?(j.next=j,Iu(g)):(j.next=Je.next,Je.next=j),g.interleaved=j;return}}catch{}finally{}S=Kt(f,g,j,k),S!==null&&(j=mt(),Te(S,f,k,j),sd(S,g,k))}}function Wd(f){var g=f.alternate;return f===hs||g!==null&&g===hs}function rd(f,g){Ja=td=!0;var S=f.pending;S===null?g.next=g:(g.next=S.next,S.next=g),f.pending=g}function sd(f,g,S){if((S&4194240)!==0){var k=g.lanes;k&=f.pendingLanes,S|=k,g.lanes=S,lo(f,S)}}var Do={readContext:na,useCallback:_t,useContext:_t,useEffect:_t,useImperativeHandle:_t,useInsertionEffect:_t,useLayoutEffect:_t,useMemo:_t,useReducer:_t,useRef:_t,useState:_t,useDebugValue:_t,useDeferredValue:_t,useTransition:_t,useMutableSource:_t,useSyncExternalStore:_t,useId:_t,unstable_isNewReconciler:!1},qc={readContext:na,useCallback:function(f,g){return Le().memoizedState=[f,g===void 0?null:g],f},useContext:na,useEffect:Mu,useImperativeHandle:function(f,g,S){return S=S!=null?S.concat([f]):null,Ru(4194308,4,Pp.bind(null,g,f),S)},useLayoutEffect:function(f,g){return Ru(4194308,4,f,g)},useInsertionEffect:function(f,g){return Ru(4,2,f,g)},useMemo:function(f,g){var S=Le();return g=g===void 0?null:g,f=f(),S.memoizedState=[f,g],f},useReducer:function(f,g,S){var k=Le();return g=S!==void 0?S(g):g,k.memoizedState=k.baseState=g,f={pending:null,interleaved:null,lanes:0,dispatch:null,lastRenderedReducer:f,lastRenderedState:g},k.queue=f,f=f.dispatch=Lu.bind(null,hs,f),[k.memoizedState,f]},useRef:function(f){var g=Le();return f={current:f},g.memoizedState=f},useState:Hd,useDebugValue:_r,useDeferredValue:function(f){return Le().memoizedState=f},useTransition:function(){var f=Hd(!1),g=f[0];return f=ch.bind(null,f[1]),Le().memoizedState=f,[g,f]},useMutableSource:function(){},useSyncExternalStore:function(f,g,S){var k=hs,j=Le();if(Gr){if(S===void 0)throw Error(m(407));S=S()}else{if(S=g(),b===null)throw Error(m(349));(yl&30)!==0||Pu(k,g,S)}j.memoizedState=S;var K={value:S,getSnapshot:g};return j.queue=K,Mu(Ap.bind(null,k,K,f),[f]),k.flags|=2048,ah(9,wl.bind(null,k,K,S,g),void 0,null),S},useId:function(){var f=Le(),g=b.identifierPrefix;if(Gr){var S=_l,k=ml;S=(k&~(1<<32-Ks(k)-1)).toString(32)+S,g=":"+g+"R"+S,S=vl++,0<S&&(g+="H"+S.toString(32)),g+=":"}else S=xl++,g=":"+g+"r"+S.toString(32)+":";return f.memoizedState=g},unstable_isNewReconciler:!1},uh={readContext:na,useCallback:hn,useContext:na,useEffect:qd,useImperativeHandle:lh,useInsertionEffect:Cp,useLayoutEffect:ho,useMemo:$d,useReducer:Cu,useRef:qf,useState:function(){return Cu(vc)},useDebugValue:_r,useDeferredValue:function(f){var g=Ma();return Mo(g,Ts.memoizedState,f)},useTransition:function(){var f=Cu(vc)[0],g=Ma().memoizedState;return[f,g]},useMutableSource:jd,useSyncExternalStore:id,useId:Du,unstable_isNewReconciler:!1},Zd={readContext:na,useCallback:hn,useContext:na,useEffect:qd,useImperativeHandle:lh,useInsertionEffect:Cp,useLayoutEffect:ho,useMemo:$d,useReducer:Gc,useRef:qf,useState:function(){return Gc(vc)},useDebugValue:_r,useDeferredValue:function(f){var g=Ma();return Ts===null?g.memoizedState=f:Mo(g,Ts.memoizedState,f)},useTransition:function(){var f=Gc(vc)[0],g=Ma().memoizedState;return[f,g]},useMutableSource:jd,useSyncExternalStore:id,useId:Du,unstable_isNewReconciler:!1};function sa(f,g){if(f&&f.defaultProps){g=Ai({},g),f=f.defaultProps;for(var S in f)g[S]===void 0&&(g[S]=f[S]);return g}return g}function $c(f,g,S,k){g=f.memoizedState,S=S(k,g),S=S==null?g:Ai({},g,S),f.memoizedState=S,f.lanes===0&&(f.updateQueue.baseState=S)}var bl={isMounted:function(f){return(f=f._reactInternals)?lt(f)===f:!1},enqueueSetState:function(f,g,S){f=f._reactInternals;var k=mt(),j=ze(f),K=fi(k,j);K.payload=g,S!=null&&(K.callback=S),g=Xl(f,K,j),g!==null&&(Te(g,f,j,k),Nd(g,f,j))},enqueueReplaceState:function(f,g,S){f=f._reactInternals;var k=mt(),j=ze(f),K=fi(k,j);K.tag=1,K.payload=g,S!=null&&(K.callback=S),g=Xl(f,K,j),g!==null&&(Te(g,f,j,k),Nd(g,f,j))},enqueueForceUpdate:function(f,g){f=f._reactInternals;var S=mt(),k=ze(f),j=fi(S,k);j.tag=2,g!=null&&(j.callback=g),g=Xl(f,j,k),g!==null&&(Te(g,f,k,S),Nd(g,f,k))}};function Xd(f,g,S,k,j,K,fe){return f=f.stateNode,typeof f.shouldComponentUpdate=="function"?f.shouldComponentUpdate(k,K,fe):g.prototype&&g.prototype.isPureReactComponent?!Hu(S,k)||!Hu(j,K):!0}function Tl(f,g,S){var k=!1,j=Ia,K=g.contextType;return typeof K=="object"&&K!==null?K=na(K):(j=xo(g)?Ls:Us.current,k=g.contextTypes,K=(k=k!=null)?Bc(f,j):Ia),g=new g(S,K),f.memoizedState=g.state!==null&&g.state!==void 0?g.state:null,g.updater=bl,f.stateNode=g,g._reactInternals=f,k&&(f=f.stateNode,f.__reactInternalMemoizedUnmaskedChildContext=j,f.__reactInternalMemoizedMaskedChildContext=K),g}function Kd(f,g,S,k){f=g.state,typeof g.componentWillReceiveProps=="function"&&g.componentWillReceiveProps(S,k),typeof g.UNSAFE_componentWillReceiveProps=="function"&&g.UNSAFE_componentWillReceiveProps(S,k),g.state!==f&&bl.enqueueReplaceState(g,g.state,null)}function hh(f,g,S,k){var j=f.stateNode;j.props=S,j.state=f.memoizedState,j.refs={},gl(f);var K=g.contextType;typeof K=="object"&&K!==null?j.context=na(K):(K=xo(g)?Ls:Us.current,j.context=Bc(f,K)),j.state=f.memoizedState,K=g.getDerivedStateFromProps,typeof K=="function"&&($c(f,g,K,S),j.state=f.memoizedState),typeof g.getDerivedStateFromProps=="function"||typeof j.getSnapshotBeforeUpdate=="function"||typeof j.UNSAFE_componentWillMount!="function"&&typeof j.componentWillMount!="function"||(g=j.state,typeof j.componentWillMount=="function"&&j.componentWillMount(),typeof j.UNSAFE_componentWillMount=="function"&&j.UNSAFE_componentWillMount(),g!==j.state&&bl.enqueueReplaceState(j,j.state,null),Au(f,S,j,k),j.state=f.memoizedState),typeof j.componentDidMount=="function"&&(f.flags|=4194308)}function El(f,g){try{var S="",k=g;do S+=zn(k),k=k.return;while(k);var j=S}catch(K){j=`
Error generating stack: `+K.message+`
`+K.stack}return{value:f,source:g,stack:j,digest:null}}function Wc(f,g,S){return{value:f,source:null,stack:S??null,digest:g??null}}function yr(f,g){try{console.error(g.value)}catch(S){setTimeout(function(){throw S})}}var dh=typeof WeakMap=="function"?WeakMap:Map;function Yd(f,g,S){S=fi(-1,S),S.tag=3,S.payload={element:null};var k=g.value;return S.callback=function(){ye||(ye=!0,we=k),yr(f,g)},S}function Qd(f,g,S){S=fi(-1,S),S.tag=3;var k=f.type.getDerivedStateFromError;if(typeof k=="function"){var j=g.value;S.payload=function(){return k(j)},S.callback=function(){yr(f,g)}}var K=f.stateNode;return K!==null&&typeof K.componentDidCatch=="function"&&(S.callback=function(){yr(f,g),typeof k!="function"&&(me===null?me=new Set([this]):me.add(this));var fe=g.stack;this.componentDidCatch(g.value,{componentStack:fe!==null?fe:""})}),S}function Zc(f,g,S){var k=f.pingCache;if(k===null){k=f.pingCache=new dh;var j=new Set;k.set(g,j)}else j=k.get(g),j===void 0&&(j=new Set,k.set(g,j));j.has(S)||(j.add(S),f=Qn.bind(null,f,g,S),g.then(f,f))}function Jd(f){do{var g;if((g=f.tag===13)&&(g=f.memoizedState,g=g!==null?g.dehydrated!==null:!0),g)return f;f=f.return}while(f!==null);return null}function fh(f,g,S,k,j){return(f.mode&1)===0?(f===g?f.flags|=65536:(f.flags|=128,S.flags|=131072,S.flags&=-52805,S.tag===1&&(S.alternate===null?S.tag=17:(g=fi(-1,1),g.tag=2,Xl(S,g,1))),S.lanes|=1),f):(f.flags|=65536,f.lanes=j,f)}var Wf=en.ReactCurrentOwner,zs=!1;function wo(f,g,S,k){g.child=f===null?Bd(g,null,S,k):Uc(g,f.child,S,k)}function ef(f,g,S,k,j){S=S.render;var K=g.ref;return Su(g,j),k=jc(f,g,S,k,K,j),S=Fr(),f!==null&&!zs?(g.updateQueue=f.updateQueue,g.flags&=-2053,f.lanes&=~j,xc(f,g,j)):(Gr&&S&&Hh(g),g.flags|=1,wo(f,g,k,j),g.child)}function od(f,g,S,k,j){if(f===null){var K=S.type;return typeof K=="function"&&!ts(K)&&K.defaultProps===void 0&&S.compare===null&&S.defaultProps===void 0?(g.tag=15,g.type=K,ku(f,g,K,k,j)):(f=no(S.type,null,k,g,g.mode,j),f.ref=g.ref,f.return=g,g.child=f)}if(K=f.child,(f.lanes&j)===0){var fe=K.memoizedProps;if(S=S.compare,S=S!==null?S:Hu,S(fe,k)&&f.ref===g.ref)return xc(f,g,j)}return g.flags|=1,f=po(K,k),f.ref=g.ref,f.return=g,g.child=f}function ku(f,g,S,k,j){if(f!==null){var K=f.memoizedProps;if(Hu(K,k)&&f.ref===g.ref)if(zs=!1,g.pendingProps=k=K,(f.lanes&j)!==0)(f.flags&131072)!==0&&(zs=!0);else return g.lanes=f.lanes,xc(f,g,j)}return ld(f,g,S,k,j)}function tf(f,g,S){var k=g.pendingProps,j=k.children,K=f!==null?f.memoizedState:null;if(k.mode==="hidden")if((g.mode&1)===0)g.memoizedState={baseLanes:0,cachePool:null,transitions:null},os(B,L),L|=S;else{if((S&1073741824)===0)return f=K!==null?K.baseLanes|S:S,g.lanes=g.childLanes=1073741824,g.memoizedState={baseLanes:f,cachePool:null,transitions:null},g.updateQueue=null,os(B,L),L|=f,null;g.memoizedState={baseLanes:0,cachePool:null,transitions:null},k=K!==null?K.baseLanes:S,os(B,L),L|=k}else K!==null?(k=K.baseLanes|S,g.memoizedState=null):k=S,os(B,L),L|=k;return wo(f,g,j,S),g.child}function ad(f,g){var S=g.ref;(f===null&&S!==null||f!==null&&f.ref!==S)&&(g.flags|=512,g.flags|=2097152)}function ld(f,g,S,k,j){var K=xo(S)?Ls:Us.current;return K=Bc(g,K),Su(g,j),S=jc(f,g,S,k,K,j),k=Fr(),f!==null&&!zs?(g.updateQueue=f.updateQueue,g.flags&=-2053,f.lanes&=~j,xc(f,g,j)):(Gr&&k&&Hh(g),g.flags|=1,wo(f,g,S,j),g.child)}function Zf(f,g,S,k,j){if(xo(S)){var K=!0;nh(g)}else K=!1;if(Su(g,j),g.stateNode===null)of(f,g),Tl(g,S,k),hh(g,S,k,j),k=!0;else if(f===null){var fe=g.stateNode,Ne=g.memoizedProps;fe.props=Ne;var Je=fe.context,Ft=S.contextType;typeof Ft=="object"&&Ft!==null?Ft=na(Ft):(Ft=xo(S)?Ls:Us.current,Ft=Bc(g,Ft));var ai=S.getDerivedStateFromProps,hi=typeof ai=="function"||typeof fe.getSnapshotBeforeUpdate=="function";hi||typeof fe.UNSAFE_componentWillReceiveProps!="function"&&typeof fe.componentWillReceiveProps!="function"||(Ne!==k||Je!==Ft)&&Kd(g,fe,k,Ft),Qa=!1;var ci=g.memoizedState;fe.state=ci,Au(g,k,fe,j),Je=g.memoizedState,Ne!==k||ci!==Je||vo.current||Qa?(typeof ai=="function"&&($c(g,S,ai,k),Je=g.memoizedState),(Ne=Qa||Xd(g,S,Ne,k,ci,Je,Ft))?(hi||typeof fe.UNSAFE_componentWillMount!="function"&&typeof fe.componentWillMount!="function"||(typeof fe.componentWillMount=="function"&&fe.componentWillMount(),typeof fe.UNSAFE_componentWillMount=="function"&&fe.UNSAFE_componentWillMount()),typeof fe.componentDidMount=="function"&&(g.flags|=4194308)):(typeof fe.componentDidMount=="function"&&(g.flags|=4194308),g.memoizedProps=k,g.memoizedState=Je),fe.props=k,fe.state=Je,fe.context=Ft,k=Ne):(typeof fe.componentDidMount=="function"&&(g.flags|=4194308),k=!1)}else{fe=g.stateNode,Ro(f,g),Ne=g.memoizedProps,Ft=g.type===g.elementType?Ne:sa(g.type,Ne),fe.props=Ft,hi=g.pendingProps,ci=fe.context,Je=S.contextType,typeof Je=="object"&&Je!==null?Je=na(Je):(Je=xo(S)?Ls:Us.current,Je=Bc(g,Je));var Oi=S.getDerivedStateFromProps;(ai=typeof Oi=="function"||typeof fe.getSnapshotBeforeUpdate=="function")||typeof fe.UNSAFE_componentWillReceiveProps!="function"&&typeof fe.componentWillReceiveProps!="function"||(Ne!==hi||ci!==Je)&&Kd(g,fe,k,Je),Qa=!1,ci=g.memoizedState,fe.state=ci,Au(g,k,fe,j);var qi=g.memoizedState;Ne!==hi||ci!==qi||vo.current||Qa?(typeof Oi=="function"&&($c(g,S,Oi,k),qi=g.memoizedState),(Ft=Qa||Xd(g,S,Ft,k,ci,qi,Je)||!1)?(ai||typeof fe.UNSAFE_componentWillUpdate!="function"&&typeof fe.componentWillUpdate!="function"||(typeof fe.componentWillUpdate=="function"&&fe.componentWillUpdate(k,qi,Je),typeof fe.UNSAFE_componentWillUpdate=="function"&&fe.UNSAFE_componentWillUpdate(k,qi,Je)),typeof fe.componentDidUpdate=="function"&&(g.flags|=4),typeof fe.getSnapshotBeforeUpdate=="function"&&(g.flags|=1024)):(typeof fe.componentDidUpdate!="function"||Ne===f.memoizedProps&&ci===f.memoizedState||(g.flags|=4),typeof fe.getSnapshotBeforeUpdate!="function"||Ne===f.memoizedProps&&ci===f.memoizedState||(g.flags|=1024),g.memoizedProps=k,g.memoizedState=qi),fe.props=k,fe.state=qi,fe.context=Je,k=Ft):(typeof fe.componentDidUpdate!="function"||Ne===f.memoizedProps&&ci===f.memoizedState||(g.flags|=4),typeof fe.getSnapshotBeforeUpdate!="function"||Ne===f.memoizedProps&&ci===f.memoizedState||(g.flags|=1024),k=!1)}return ph(f,g,S,k,K,j)}function ph(f,g,S,k,j,K){ad(f,g);var fe=(g.flags&128)!==0;if(!k&&!fe)return j&&jh(g,S,!1),xc(f,g,K);k=g.stateNode,Wf.current=g;var Ne=fe&&typeof S.getDerivedStateFromError!="function"?null:k.render();return g.flags|=1,f!==null&&fe?(g.child=Uc(g,f.child,null,K),g.child=Uc(g,null,Ne,K)):wo(f,g,Ne,K),g.memoizedState=k.state,j&&jh(g,S,!0),g.child}function mh(f){var g=f.stateNode;g.pendingContext?Uh(f,g.pendingContext,g.pendingContext!==g.context):g.context&&Uh(f,g.context,!1),Jh(f,g.containerInfo)}function nf(f,g,S,k,j){return xu(),$h(j),g.flags|=256,wo(f,g,S,k),g.child}var rf={dehydrated:null,treeContext:null,retryLane:0};function cd(f){return{baseLanes:f,cachePool:null,transitions:null}}function Xf(f,g,S){var k=g.pendingProps,j=ps.current,K=!1,fe=(g.flags&128)!==0,Ne;if((Ne=fe)||(Ne=f!==null&&f.memoizedState===null?!1:(j&2)!==0),Ne?(K=!0,g.flags&=-129):(f===null||f.memoizedState!==null)&&(j|=1),os(ps,j&1),f===null)return Od(g),f=g.memoizedState,f!==null&&(f=f.dehydrated,f!==null)?((g.mode&1)===0?g.lanes=1:f.data==="$!"?g.lanes=8:g.lanes=1073741824,null):(fe=k.children,f=k.fallback,K?(k=g.mode,K=g.child,fe={mode:"hidden",children:fe},(k&1)===0&&K!==null?(K.childLanes=0,K.pendingProps=fe):K=Fs(fe,k,0,null),f=qs(f,k,S,null),K.return=g,f.return=g,K.sibling=f,g.child=K,g.child.memoizedState=cd(S),g.memoizedState=rf,f):_h(g,fe));if(j=f.memoizedState,j!==null&&(Ne=j.dehydrated,Ne!==null))return Rp(f,g,fe,k,Ne,j,S);if(K){K=k.fallback,fe=g.mode,j=f.child,Ne=j.sibling;var Je={mode:"hidden",children:k.children};return(fe&1)===0&&g.child!==j?(k=g.child,k.childLanes=0,k.pendingProps=Je,g.deletions=null):(k=po(j,Je),k.subtreeFlags=j.subtreeFlags&14680064),Ne!==null?K=po(Ne,K):(K=qs(K,fe,S,null),K.flags|=2),K.return=g,k.return=g,k.sibling=K,g.child=k,k=K,K=g.child,fe=f.child.memoizedState,fe=fe===null?cd(S):{baseLanes:fe.baseLanes|S,cachePool:null,transitions:fe.transitions},K.memoizedState=fe,K.childLanes=f.childLanes&~S,g.memoizedState=rf,k}return K=f.child,f=K.sibling,k=po(K,{mode:"visible",children:k.children}),(g.mode&1)===0&&(k.lanes=S),k.return=g,k.sibling=null,f!==null&&(S=g.deletions,S===null?(g.deletions=[f],g.flags|=16):S.push(f)),g.child=k,g.memoizedState=null,k}function _h(f,g){return g=Fs({mode:"visible",children:g},f.mode,0,null),g.return=f,f.child=g}function ud(f,g,S,k){return k!==null&&$h(k),Uc(g,f.child,null,S),f=_h(g,g.pendingProps.children),f.flags|=2,g.memoizedState=null,f}function Rp(f,g,S,k,j,K,fe){if(S)return g.flags&256?(g.flags&=-257,k=Wc(Error(m(422))),ud(f,g,fe,k)):g.memoizedState!==null?(g.child=f.child,g.flags|=128,null):(K=k.fallback,j=g.mode,k=Fs({mode:"visible",children:k.children},j,0,null),K=qs(K,j,fe,null),K.flags|=2,k.return=g,K.return=g,k.sibling=K,g.child=k,(g.mode&1)!==0&&Uc(g,f.child,null,fe),g.child.memoizedState=cd(fe),g.memoizedState=rf,K);if((g.mode&1)===0)return ud(f,g,fe,null);if(j.data==="$!"){if(k=j.nextSibling&&j.nextSibling.dataset,k)var Ne=k.dgst;return k=Ne,K=Error(m(419)),k=Wc(K,k,void 0),ud(f,g,fe,k)}if(Ne=(fe&f.childLanes)!==0,zs||Ne){if(k=b,k!==null){switch(fe&-fe){case 4:j=2;break;case 16:j=8;break;case 64:case 128:case 256:case 512:case 1024:case 2048:case 4096:case 8192:case 16384:case 32768:case 65536:case 131072:case 262144:case 524288:case 1048576:case 2097152:case 4194304:case 8388608:case 16777216:case 33554432:case 67108864:j=32;break;case 536870912:j=268435456;break;default:j=0}j=(j&(k.suspendedLanes|fe))!==0?0:j,j!==0&&j!==K.retryLane&&(K.retryLane=j,Ya(f,j),Te(k,f,j,-1))}return Hi(),k=Wc(Error(m(421))),ud(f,g,fe,k)}return j.data==="$?"?(g.flags|=128,g.child=f.child,g=zr.bind(null,f),j._reactRetry=g,null):(f=K.treeContext,Po=Gl(j.nextSibling),ia=g,Gr=!0,Aa=null,f!==null&&(Xa[Ka++]=ml,Xa[Ka++]=_l,Xa[Ka++]=Wl,ml=f.id,_l=f.overflow,Wl=g),g=_h(g,k.children),g.flags|=4096,g)}function Kf(f,g,S){f.lanes|=g;var k=f.alternate;k!==null&&(k.lanes|=g),Xh(f.return,g,S)}function sf(f,g,S,k,j){var K=f.memoizedState;K===null?f.memoizedState={isBackwards:g,rendering:null,renderingStartTime:0,last:k,tail:S,tailMode:j}:(K.isBackwards=g,K.rendering=null,K.renderingStartTime=0,K.last=k,K.tail=S,K.tailMode=j)}function Yf(f,g,S){var k=g.pendingProps,j=k.revealOrder,K=k.tail;if(wo(f,g,k.children,S),k=ps.current,(k&2)!==0)k=k&1|2,g.flags|=128;else{if(f!==null&&(f.flags&128)!==0)e:for(f=g.child;f!==null;){if(f.tag===13)f.memoizedState!==null&&Kf(f,S,g);else if(f.tag===19)Kf(f,S,g);else if(f.child!==null){f.child.return=f,f=f.child;continue}if(f===g)break e;for(;f.sibling===null;){if(f.return===null||f.return===g)break e;f=f.return}f.sibling.return=f.return,f=f.sibling}k&=1}if(os(ps,k),(g.mode&1)===0)g.memoizedState=null;else switch(j){case"forwards":for(S=g.child,j=null;S!==null;)f=S.alternate,f!==null&&oh(f)===null&&(j=S),S=S.sibling;S=j,S===null?(j=g.child,g.child=null):(j=S.sibling,S.sibling=null),sf(g,!1,j,S,K);break;case"backwards":for(S=null,j=g.child,g.child=null;j!==null;){if(f=j.alternate,f!==null&&oh(f)===null){g.child=j;break}f=j.sibling,j.sibling=S,S=j,j=f}sf(g,!0,S,null,K);break;case"together":sf(g,!1,null,null,void 0);break;default:g.memoizedState=null}return g.child}function of(f,g){(g.mode&1)===0&&f!==null&&(f.alternate=null,g.alternate=null,g.flags|=2)}function xc(f,g,S){if(f!==null&&(g.dependencies=f.dependencies),$|=g.lanes,(S&g.childLanes)===0)return null;if(f!==null&&g.child!==f.child)throw Error(m(153));if(g.child!==null){for(f=g.child,S=po(f,f.pendingProps),g.child=S,S.return=g;f.sibling!==null;)f=f.sibling,S=S.sibling=po(f,f.pendingProps),S.return=g;S.sibling=null}return g.child}function kr(f,g,S){switch(g.tag){case 3:mh(g),xu();break;case 5:yc(g);break;case 1:xo(g.type)&&nh(g);break;case 4:Jh(g,g.stateNode.containerInfo);break;case 10:var k=g.type._context,j=g.memoizedProps.value;os(Zl,k._currentValue),k._currentValue=j;break;case 13:if(k=g.memoizedState,k!==null)return k.dehydrated!==null?(os(ps,ps.current&1),g.flags|=128,null):(S&g.child.childLanes)!==0?Xf(f,g,S):(os(ps,ps.current&1),f=xc(f,g,S),f!==null?f.sibling:null);os(ps,ps.current&1);break;case 19:if(k=(S&g.childLanes)!==0,(f.flags&128)!==0){if(k)return Yf(f,g,S);g.flags|=128}if(j=g.memoizedState,j!==null&&(j.rendering=null,j.tail=null,j.lastEffect=null),os(ps,ps.current),k)break;return null;case 22:case 23:return g.lanes=0,tf(f,g,S)}return xc(f,g,S)}var Qf,Jf,af,Mp;Qf=function(f,g){for(var S=g.child;S!==null;){if(S.tag===5||S.tag===6)f.appendChild(S.stateNode);else if(S.tag!==4&&S.child!==null){S.child.return=S,S=S.child;continue}if(S===g)break;for(;S.sibling===null;){if(S.return===null||S.return===g)return;S=S.return}S.sibling.return=S.return,S=S.sibling}},Jf=function(){},af=function(f,g,S,k){var j=f.memoizedProps;if(j!==k){f=g.stateNode,js(Pa.current);var K=null;switch(S){case"input":j=Bs(f,j),k=Bs(f,k),K=[];break;case"select":j=Ai({},j,{value:void 0}),k=Ai({},k,{value:void 0}),K=[];break;case"textarea":j=ar(f,j),k=ar(f,k),K=[];break;default:typeof j.onClick!="function"&&typeof k.onClick=="function"&&(f.onclick=uc)}Na(S,k);var fe;S=null;for(Ft in j)if(!k.hasOwnProperty(Ft)&&j.hasOwnProperty(Ft)&&j[Ft]!=null)if(Ft==="style"){var Ne=j[Ft];for(fe in Ne)Ne.hasOwnProperty(fe)&&(S||(S={}),S[fe]="")}else Ft!=="dangerouslySetInnerHTML"&&Ft!=="children"&&Ft!=="suppressContentEditableWarning"&&Ft!=="suppressHydrationWarning"&&Ft!=="autoFocus"&&(A.hasOwnProperty(Ft)?K||(K=[]):(K=K||[]).push(Ft,null));for(Ft in k){var Je=k[Ft];if(Ne=j?.[Ft],k.hasOwnProperty(Ft)&&Je!==Ne&&(Je!=null||Ne!=null))if(Ft==="style")if(Ne){for(fe in Ne)!Ne.hasOwnProperty(fe)||Je&&Je.hasOwnProperty(fe)||(S||(S={}),S[fe]="");for(fe in Je)Je.hasOwnProperty(fe)&&Ne[fe]!==Je[fe]&&(S||(S={}),S[fe]=Je[fe])}else S||(K||(K=[]),K.push(Ft,S)),S=Je;else Ft==="dangerouslySetInnerHTML"?(Je=Je?Je.__html:void 0,Ne=Ne?Ne.__html:void 0,Je!=null&&Ne!==Je&&(K=K||[]).push(Ft,Je)):Ft==="children"?typeof Je!="string"&&typeof Je!="number"||(K=K||[]).push(Ft,""+Je):Ft!=="suppressContentEditableWarning"&&Ft!=="suppressHydrationWarning"&&(A.hasOwnProperty(Ft)?(Je!=null&&Ft==="onScroll"&&rn("scroll",f),K||Ne===Je||(K=[])):(K=K||[]).push(Ft,Je))}S&&(K=K||[]).push("style",S);var Ft=K;(g.updateQueue=Ft)&&(g.flags|=4)}},Mp=function(f,g,S,k){S!==k&&(g.flags|=4)};function wc(f,g){if(!Gr)switch(f.tailMode){case"hidden":g=f.tail;for(var S=null;g!==null;)g.alternate!==null&&(S=g),g=g.sibling;S===null?f.tail=null:S.sibling=null;break;case"collapsed":S=f.tail;for(var k=null;S!==null;)S.alternate!==null&&(k=S),S=S.sibling;k===null?g||f.tail===null?f.tail=null:f.tail.sibling=null:k.sibling=null}}function Gs(f){var g=f.alternate!==null&&f.alternate.child===f.child,S=0,k=0;if(g)for(var j=f.child;j!==null;)S|=j.lanes|j.childLanes,k|=j.subtreeFlags&14680064,k|=j.flags&14680064,j.return=f,j=j.sibling;else for(j=f.child;j!==null;)S|=j.lanes|j.childLanes,k|=j.subtreeFlags,k|=j.flags,j.return=f,j=j.sibling;return f.subtreeFlags|=k,f.childLanes=S,g}function ep(f,g,S){var k=g.pendingProps;switch(Fd(g),g.tag){case 2:case 16:case 15:case 0:case 11:case 7:case 8:case 12:case 9:case 14:return Gs(g),null;case 1:return xo(g.type)&&Nc(),Gs(g),null;case 3:return k=g.stateNode,ks(),jr(vo),jr(Us),Ud(),k.pendingContext&&(k.context=k.pendingContext,k.pendingContext=null),(f===null||f.child===null)&&(vu(g)?g.flags|=4:f===null||f.memoizedState.isDehydrated&&(g.flags&256)===0||(g.flags|=1024,Aa!==null&&(ft(Aa),Aa=null))),Jf(f,g),Gs(g),null;case 5:Vd(g);var j=js(Qh.current);if(S=g.type,f!==null&&g.stateNode!=null)af(f,g,S,k,j),f.ref!==g.ref&&(g.flags|=512,g.flags|=2097152);else{if(!k){if(g.stateNode===null)throw Error(m(166));return Gs(g),null}if(f=js(Pa.current),vu(g)){k=g.stateNode,S=g.type;var K=g.memoizedProps;switch(k[fl]=g,k[eh]=K,f=(g.mode&1)!==0,S){case"dialog":rn("cancel",k),rn("close",k);break;case"iframe":case"object":case"embed":rn("load",k);break;case"video":case"audio":for(j=0;j<fu.length;j++)rn(fu[j],k);break;case"source":rn("error",k);break;case"img":case"image":case"link":rn("error",k),rn("load",k);break;case"details":rn("toggle",k);break;case"input":Ut(k,K),rn("invalid",k);break;case"select":k._wrapperState={wasMultiple:!!K.multiple},rn("invalid",k);break;case"textarea":vs(k,K),rn("invalid",k)}Na(S,K),j=null;for(var fe in K)if(K.hasOwnProperty(fe)){var Ne=K[fe];fe==="children"?typeof Ne=="string"?k.textContent!==Ne&&(K.suppressHydrationWarning!==!0&&jl(k.textContent,Ne,f),j=["children",Ne]):typeof Ne=="number"&&k.textContent!==""+Ne&&(K.suppressHydrationWarning!==!0&&jl(k.textContent,Ne,f),j=["children",""+Ne]):A.hasOwnProperty(fe)&&Ne!=null&&fe==="onScroll"&&rn("scroll",k)}switch(S){case"input":ao(k),wr(k,K,!0);break;case"textarea":ao(k),Fa(k);break;case"select":case"option":break;default:typeof K.onClick=="function"&&(k.onclick=uc)}k=j,g.updateQueue=k,k!==null&&(g.flags|=4)}else{fe=j.nodeType===9?j:j.ownerDocument,f==="http://www.w3.org/1999/xhtml"&&(f=Sr(S)),f==="http://www.w3.org/1999/xhtml"?S==="script"?(f=fe.createElement("div"),f.innerHTML="<script><\/script>",f=f.removeChild(f.firstChild)):typeof k.is=="string"?f=fe.createElement(S,{is:k.is}):(f=fe.createElement(S),S==="select"&&(fe=f,k.multiple?fe.multiple=!0:k.size&&(fe.size=k.size))):f=fe.createElementNS(f,S),f[fl]=g,f[eh]=k,Qf(f,g,!1,!1),g.stateNode=f;e:{switch(fe=Rl(S,k),S){case"dialog":rn("cancel",f),rn("close",f),j=k;break;case"iframe":case"object":case"embed":rn("load",f),j=k;break;case"video":case"audio":for(j=0;j<fu.length;j++)rn(fu[j],f);j=k;break;case"source":rn("error",f),j=k;break;case"img":case"image":case"link":rn("error",f),rn("load",f),j=k;break;case"details":rn("toggle",f),j=k;break;case"input":Ut(f,k),j=Bs(f,k),rn("invalid",f);break;case"option":j=k;break;case"select":f._wrapperState={wasMultiple:!!k.multiple},j=Ai({},k,{value:void 0}),rn("invalid",f);break;case"textarea":vs(f,k),j=ar(f,k),rn("invalid",f);break;default:j=k}Na(S,j),Ne=j;for(K in Ne)if(Ne.hasOwnProperty(K)){var Je=Ne[K];K==="style"?ma(f,Je):K==="dangerouslySetInnerHTML"?(Je=Je?Je.__html:void 0,Je!=null&&fa(f,Je)):K==="children"?typeof Je=="string"?(S!=="textarea"||Je!=="")&&pa(f,Je):typeof Je=="number"&&pa(f,""+Je):K!=="suppressContentEditableWarning"&&K!=="suppressHydrationWarning"&&K!=="autoFocus"&&(A.hasOwnProperty(K)?Je!=null&&K==="onScroll"&&rn("scroll",f):Je!=null&&Ei(f,K,Je,fe))}switch(S){case"input":ao(f),wr(f,k,!1);break;case"textarea":ao(f),Fa(f);break;case"option":k.value!=null&&f.setAttribute("value",""+on(k.value));break;case"select":f.multiple=!!k.multiple,K=k.value,K!=null?Rn(f,!!k.multiple,K,!1):k.defaultValue!=null&&Rn(f,!!k.multiple,k.defaultValue,!0);break;default:typeof j.onClick=="function"&&(f.onclick=uc)}switch(S){case"button":case"input":case"select":case"textarea":k=!!k.autoFocus;break e;case"img":k=!0;break e;default:k=!1}}k&&(g.flags|=4)}g.ref!==null&&(g.flags|=512,g.flags|=2097152)}return Gs(g),null;case 6:if(f&&g.stateNode!=null)Mp(f,g,f.memoizedProps,k);else{if(typeof k!="string"&&g.stateNode===null)throw Error(m(166));if(S=js(Qh.current),js(Pa.current),vu(g)){if(k=g.stateNode,S=g.memoizedProps,k[fl]=g,(K=k.nodeValue!==S)&&(f=ia,f!==null))switch(f.tag){case 3:jl(k.nodeValue,S,(f.mode&1)!==0);break;case 5:f.memoizedProps.suppressHydrationWarning!==!0&&jl(k.nodeValue,S,(f.mode&1)!==0)}K&&(g.flags|=4)}else k=(S.nodeType===9?S:S.ownerDocument).createTextNode(k),k[fl]=g,g.stateNode=k}return Gs(g),null;case 13:if(jr(ps),k=g.memoizedState,f===null||f.memoizedState!==null&&f.memoizedState.dehydrated!==null){if(Gr&&Po!==null&&(g.mode&1)!==0&&(g.flags&128)===0)qh(),xu(),g.flags|=98560,K=!1;else if(K=vu(g),k!==null&&k.dehydrated!==null){if(f===null){if(!K)throw Error(m(318));if(K=g.memoizedState,K=K!==null?K.dehydrated:null,!K)throw Error(m(317));K[fl]=g}else xu(),(g.flags&128)===0&&(g.memoizedState=null),g.flags|=4;Gs(g),K=!1}else Aa!==null&&(ft(Aa),Aa=null),K=!0;if(!K)return g.flags&65536?g:null}return(g.flags&128)!==0?(g.lanes=S,g):(k=k!==null,k!==(f!==null&&f.memoizedState!==null)&&k&&(g.child.flags|=8192,(g.mode&1)!==0&&(f===null||(ps.current&1)!==0?F===0&&(F=3):Hi())),g.updateQueue!==null&&(g.flags|=4),Gs(g),null);case 4:return ks(),Jf(f,g),f===null&&Oh(g.stateNode.containerInfo),Gs(g),null;case 10:return Eu(g.type._context),Gs(g),null;case 17:return xo(g.type)&&Nc(),Gs(g),null;case 19:if(jr(ps),K=g.memoizedState,K===null)return Gs(g),null;if(k=(g.flags&128)!==0,fe=K.rendering,fe===null)if(k)wc(K,!1);else{if(F!==0||f!==null&&(f.flags&128)!==0)for(f=g.child;f!==null;){if(fe=oh(f),fe!==null){for(g.flags|=128,wc(K,!1),k=fe.updateQueue,k!==null&&(g.updateQueue=k,g.flags|=4),g.subtreeFlags=0,k=S,S=g.child;S!==null;)K=S,f=k,K.flags&=14680066,fe=K.alternate,fe===null?(K.childLanes=0,K.lanes=f,K.child=null,K.subtreeFlags=0,K.memoizedProps=null,K.memoizedState=null,K.updateQueue=null,K.dependencies=null,K.stateNode=null):(K.childLanes=fe.childLanes,K.lanes=fe.lanes,K.child=fe.child,K.subtreeFlags=0,K.deletions=null,K.memoizedProps=fe.memoizedProps,K.memoizedState=fe.memoizedState,K.updateQueue=fe.updateQueue,K.type=fe.type,f=fe.dependencies,K.dependencies=f===null?null:{lanes:f.lanes,firstContext:f.firstContext}),S=S.sibling;return os(ps,ps.current&1|2),g.child}f=f.sibling}K.tail!==null&&Fn()>le&&(g.flags|=128,k=!0,wc(K,!1),g.lanes=4194304)}else{if(!k)if(f=oh(fe),f!==null){if(g.flags|=128,k=!0,S=f.updateQueue,S!==null&&(g.updateQueue=S,g.flags|=4),wc(K,!0),K.tail===null&&K.tailMode==="hidden"&&!fe.alternate&&!Gr)return Gs(g),null}else 2*Fn()-K.renderingStartTime>le&&S!==1073741824&&(g.flags|=128,k=!0,wc(K,!1),g.lanes=4194304);K.isBackwards?(fe.sibling=g.child,g.child=fe):(S=K.last,S!==null?S.sibling=fe:g.child=fe,K.last=fe)}return K.tail!==null?(g=K.tail,K.rendering=g,K.tail=g.sibling,K.renderingStartTime=Fn(),g.sibling=null,S=ps.current,os(ps,k?S&1|2:S&1),g):(Gs(g),null);case 22:case 23:return si(),k=g.memoizedState!==null,f!==null&&f.memoizedState!==null!==k&&(g.flags|=8192),k&&(g.mode&1)!==0?(L&1073741824)!==0&&(Gs(g),g.subtreeFlags&6&&(g.flags|=8192)):Gs(g),null;case 24:return null;case 25:return null}throw Error(m(156,g.tag))}function lf(f,g){switch(Fd(g),g.tag){case 1:return xo(g.type)&&Nc(),f=g.flags,f&65536?(g.flags=f&-65537|128,g):null;case 3:return ks(),jr(vo),jr(Us),Ud(),f=g.flags,(f&65536)!==0&&(f&128)===0?(g.flags=f&-65537|128,g):null;case 5:return Vd(g),null;case 13:if(jr(ps),f=g.memoizedState,f!==null&&f.dehydrated!==null){if(g.alternate===null)throw Error(m(340));xu()}return f=g.flags,f&65536?(g.flags=f&-65537|128,g):null;case 19:return jr(ps),null;case 4:return ks(),null;case 10:return Eu(g.type._context),null;case 22:case 23:return si(),null;case 24:return null;default:return null}}var $o=!1,io=!1,as=typeof WeakSet=="function"?WeakSet:Set,Li=null;function Sl(f,g){var S=f.ref;if(S!==null)if(typeof S=="function")try{S(null)}catch(k){Si(f,g,k)}else S.current=null}function zu(f,g,S){try{S()}catch(k){Si(f,g,k)}}var cf=!1;function Dp(f,g){if(Ku=ic,f=kf(),qu(f)){if("selectionStart"in f)var S={start:f.selectionStart,end:f.selectionEnd};else e:{S=(S=f.ownerDocument)&&S.defaultView||window;var k=S.getSelection&&S.getSelection();if(k&&k.rangeCount!==0){S=k.anchorNode;var j=k.anchorOffset,K=k.focusNode;k=k.focusOffset;try{S.nodeType,K.nodeType}catch{S=null;break e}var fe=0,Ne=-1,Je=-1,Ft=0,ai=0,hi=f,ci=null;t:for(;;){for(var Oi;hi!==S||j!==0&&hi.nodeType!==3||(Ne=fe+j),hi!==K||k!==0&&hi.nodeType!==3||(Je=fe+k),hi.nodeType===3&&(fe+=hi.nodeValue.length),(Oi=hi.firstChild)!==null;)ci=hi,hi=Oi;for(;;){if(hi===f)break t;if(ci===S&&++Ft===j&&(Ne=fe),ci===K&&++ai===k&&(Je=fe),(Oi=hi.nextSibling)!==null)break;hi=ci,ci=hi.parentNode}hi=Oi}S=Ne===-1||Je===-1?null:{start:Ne,end:Je}}else S=null}S=S||{start:0,end:0}}else S=null;for(Yu={focusedElem:f,selectionRange:S},ic=!1,Li=g;Li!==null;)if(g=Li,f=g.child,(g.subtreeFlags&1028)!==0&&f!==null)f.return=g,Li=f;else for(;Li!==null;){g=Li;try{var qi=g.alternate;if((g.flags&1024)!==0)switch(g.tag){case 0:case 11:case 15:break;case 1:if(qi!==null){var Wi=qi.memoizedProps,$s=qi.memoizedState,yt=g.stateNode,st=yt.getSnapshotBeforeUpdate(g.elementType===g.type?Wi:sa(g.type,Wi),$s);yt.__reactInternalSnapshotBeforeUpdate=st}break;case 3:var Pt=g.stateNode.containerInfo;Pt.nodeType===1?Pt.textContent="":Pt.nodeType===9&&Pt.documentElement&&Pt.removeChild(Pt.documentElement);break;case 5:case 6:case 4:case 17:break;default:throw Error(m(163))}}catch(xi){Si(g,g.return,xi)}if(f=g.sibling,f!==null){f.return=g.return,Li=f;break}Li=g.return}return qi=cf,cf=!1,qi}function bc(f,g,S){var k=g.updateQueue;if(k=k!==null?k.lastEffect:null,k!==null){var j=k=k.next;do{if((j.tag&f)===f){var K=j.destroy;j.destroy=void 0,K!==void 0&&zu(g,S,K)}j=j.next}while(j!==k)}}function uf(f,g){if(g=g.updateQueue,g=g!==null?g.lastEffect:null,g!==null){var S=g=g.next;do{if((S.tag&f)===f){var k=S.create;S.destroy=k()}S=S.next}while(S!==g)}}function hf(f){var g=f.ref;if(g!==null){var S=f.stateNode;switch(f.tag){case 5:f=S;break;default:f=S}typeof g=="function"?g(f):g.current=f}}function df(f){var g=f.alternate;g!==null&&(f.alternate=null,df(g)),f.child=null,f.deletions=null,f.sibling=null,f.tag===5&&(g=f.stateNode,g!==null&&(delete g[fl],delete g[eh],delete g[Fc],delete g[Sp],delete g[Uf])),f.stateNode=null,f.return=null,f.dependencies=null,f.memoizedProps=null,f.memoizedState=null,f.pendingProps=null,f.stateNode=null,f.updateQueue=null}function ff(f){return f.tag===5||f.tag===3||f.tag===4}function gh(f){e:for(;;){for(;f.sibling===null;){if(f.return===null||ff(f.return))return null;f=f.return}for(f.sibling.return=f.return,f=f.sibling;f.tag!==5&&f.tag!==6&&f.tag!==18;){if(f.flags&2||f.child===null||f.tag===4)continue e;f.child.return=f,f=f.child}if(!(f.flags&2))return f.stateNode}}function Xc(f,g,S){var k=f.tag;if(k===5||k===6)f=f.stateNode,g?S.nodeType===8?S.parentNode.insertBefore(f,g):S.insertBefore(f,g):(S.nodeType===8?(g=S.parentNode,g.insertBefore(f,S)):(g=S,g.appendChild(f)),S=S._reactRootContainer,S!=null||g.onclick!==null||(g.onclick=uc));else if(k!==4&&(f=f.child,f!==null))for(Xc(f,g,S),f=f.sibling;f!==null;)Xc(f,g,S),f=f.sibling}function Il(f,g,S){var k=f.tag;if(k===5||k===6)f=f.stateNode,g?S.insertBefore(f,g):S.appendChild(f);else if(k!==4&&(f=f.child,f!==null))for(Il(f,g,S),f=f.sibling;f!==null;)Il(f,g,S),f=f.sibling}var es=null,Es=!1;function Ss(f,g,S){for(S=S.child;S!==null;)oa(f,g,S),S=S.sibling}function oa(f,g,S){if(rs&&typeof rs.onCommitFiberUnmount=="function")try{rs.onCommitFiberUnmount(us,S)}catch{}switch(S.tag){case 5:io||Sl(S,g);case 6:var k=es,j=Es;es=null,Ss(f,g,S),es=k,Es=j,es!==null&&(Es?(f=es,S=S.stateNode,f.nodeType===8?f.parentNode.removeChild(S):f.removeChild(S)):es.removeChild(S.stateNode));break;case 18:es!==null&&(Es?(f=es,S=S.stateNode,f.nodeType===8?Ju(f.parentNode,S):f.nodeType===1&&Ju(f,S),Ua(f)):Ju(es,S.stateNode));break;case 4:k=es,j=Es,es=S.stateNode.containerInfo,Es=!0,Ss(f,g,S),es=k,Es=j;break;case 0:case 11:case 14:case 15:if(!io&&(k=S.updateQueue,k!==null&&(k=k.lastEffect,k!==null))){j=k=k.next;do{var K=j,fe=K.destroy;K=K.tag,fe!==void 0&&((K&2)!==0||(K&4)!==0)&&zu(S,g,fe),j=j.next}while(j!==k)}Ss(f,g,S);break;case 1:if(!io&&(Sl(S,g),k=S.stateNode,typeof k.componentWillUnmount=="function"))try{k.props=S.memoizedProps,k.state=S.memoizedState,k.componentWillUnmount()}catch(Ne){Si(S,g,Ne)}Ss(f,g,S);break;case 21:Ss(f,g,S);break;case 22:S.mode&1?(io=(k=io)||S.memoizedState!==null,Ss(f,g,S),io=k):Ss(f,g,S);break;default:Ss(f,g,S)}}function Lp(f){var g=f.updateQueue;if(g!==null){f.updateQueue=null;var S=f.stateNode;S===null&&(S=f.stateNode=new as),g.forEach(function(k){var j=Tn.bind(null,f,k);S.has(k)||(S.add(k),k.then(j,j))})}}function Al(f,g){var S=g.deletions;if(S!==null)for(var k=0;k<S.length;k++){var j=S[k];try{var K=f,fe=g,Ne=fe;e:for(;Ne!==null;){switch(Ne.tag){case 5:es=Ne.stateNode,Es=!1;break e;case 3:es=Ne.stateNode.containerInfo,Es=!0;break e;case 4:es=Ne.stateNode.containerInfo,Es=!0;break e}Ne=Ne.return}if(es===null)throw Error(m(160));oa(K,fe,j),es=null,Es=!1;var Je=j.alternate;Je!==null&&(Je.return=null),j.return=null}catch(Ft){Si(j,g,Ft)}}if(g.subtreeFlags&12854)for(g=g.child;g!==null;)kp(g,f),g=g.sibling}function kp(f,g){var S=f.alternate,k=f.flags;switch(f.tag){case 0:case 11:case 14:case 15:if(Al(g,f),Kl(f),k&4){try{bc(3,f,f.return),uf(3,f)}catch(Wi){Si(f,f.return,Wi)}try{bc(5,f,f.return)}catch(Wi){Si(f,f.return,Wi)}}break;case 1:Al(g,f),Kl(f),k&512&&S!==null&&Sl(S,S.return);break;case 5:if(Al(g,f),Kl(f),k&512&&S!==null&&Sl(S,S.return),f.flags&32){var j=f.stateNode;try{pa(j,"")}catch(Wi){Si(f,f.return,Wi)}}if(k&4&&(j=f.stateNode,j!=null)){var K=f.memoizedProps,fe=S!==null?S.memoizedProps:K,Ne=f.type,Je=f.updateQueue;if(f.updateQueue=null,Je!==null)try{Ne==="input"&&K.type==="radio"&&K.name!=null&&Di(j,K),Rl(Ne,fe);var Ft=Rl(Ne,K);for(fe=0;fe<Je.length;fe+=2){var ai=Je[fe],hi=Je[fe+1];ai==="style"?ma(j,hi):ai==="dangerouslySetInnerHTML"?fa(j,hi):ai==="children"?pa(j,hi):Ei(j,ai,hi,Ft)}switch(Ne){case"input":cn(j,K);break;case"textarea":Qo(j,K);break;case"select":var ci=j._wrapperState.wasMultiple;j._wrapperState.wasMultiple=!!K.multiple;var Oi=K.value;Oi!=null?Rn(j,!!K.multiple,Oi,!1):ci!==!!K.multiple&&(K.defaultValue!=null?Rn(j,!!K.multiple,K.defaultValue,!0):Rn(j,!!K.multiple,K.multiple?[]:"",!1))}j[eh]=K}catch(Wi){Si(f,f.return,Wi)}}break;case 6:if(Al(g,f),Kl(f),k&4){if(f.stateNode===null)throw Error(m(162));j=f.stateNode,K=f.memoizedProps;try{j.nodeValue=K}catch(Wi){Si(f,f.return,Wi)}}break;case 3:if(Al(g,f),Kl(f),k&4&&S!==null&&S.memoizedState.isDehydrated)try{Ua(g.containerInfo)}catch(Wi){Si(f,f.return,Wi)}break;case 4:Al(g,f),Kl(f);break;case 13:Al(g,f),Kl(f),j=f.child,j.flags&8192&&(K=j.memoizedState!==null,j.stateNode.isHidden=K,!K||j.alternate!==null&&j.alternate.memoizedState!==null||(oe=Fn())),k&4&&Lp(f);break;case 22:if(ai=S!==null&&S.memoizedState!==null,f.mode&1?(io=(Ft=io)||ai,Al(g,f),io=Ft):Al(g,f),Kl(f),k&8192){if(Ft=f.memoizedState!==null,(f.stateNode.isHidden=Ft)&&!ai&&(f.mode&1)!==0)for(Li=f,ai=f.child;ai!==null;){for(hi=Li=ai;Li!==null;){switch(ci=Li,Oi=ci.child,ci.tag){case 0:case 11:case 14:case 15:bc(4,ci,ci.return);break;case 1:Sl(ci,ci.return);var qi=ci.stateNode;if(typeof qi.componentWillUnmount=="function"){k=ci,S=ci.return;try{g=k,qi.props=g.memoizedProps,qi.state=g.memoizedState,qi.componentWillUnmount()}catch(Wi){Si(k,S,Wi)}}break;case 5:Sl(ci,ci.return);break;case 22:if(ci.memoizedState!==null){l(hi);continue}}Oi!==null?(Oi.return=ci,Li=Oi):l(hi)}ai=ai.sibling}e:for(ai=null,hi=f;;){if(hi.tag===5){if(ai===null){ai=hi;try{j=hi.stateNode,Ft?(K=j.style,typeof K.setProperty=="function"?K.setProperty("display","none","important"):K.display="none"):(Ne=hi.stateNode,Je=hi.memoizedProps.style,fe=Je!=null&&Je.hasOwnProperty("display")?Je.display:null,Ne.style.display=Oa("display",fe))}catch(Wi){Si(f,f.return,Wi)}}}else if(hi.tag===6){if(ai===null)try{hi.stateNode.nodeValue=Ft?"":hi.memoizedProps}catch(Wi){Si(f,f.return,Wi)}}else if((hi.tag!==22&&hi.tag!==23||hi.memoizedState===null||hi===f)&&hi.child!==null){hi.child.return=hi,hi=hi.child;continue}if(hi===f)break e;for(;hi.sibling===null;){if(hi.return===null||hi.return===f)break e;ai===hi&&(ai=null),hi=hi.return}ai===hi&&(ai=null),hi.sibling.return=hi.return,hi=hi.sibling}}break;case 19:Al(g,f),Kl(f),k&4&&Lp(f);break;case 21:break;default:Al(g,f),Kl(f)}}function Kl(f){var g=f.flags;if(g&2){try{e:{for(var S=f.return;S!==null;){if(ff(S)){var k=S;break e}S=S.return}throw Error(m(160))}switch(k.tag){case 5:var j=k.stateNode;k.flags&32&&(pa(j,""),k.flags&=-33);var K=gh(f);Il(f,K,j);break;case 3:case 4:var fe=k.stateNode.containerInfo,Ne=gh(f);Xc(f,Ne,fe);break;default:throw Error(m(161))}}catch(Je){Si(f,f.return,Je)}f.flags&=-3}g&4096&&(f.flags&=-4097)}function zp(f,g,S){Li=f,fo(f)}function fo(f,g,S){for(var k=(f.mode&1)!==0;Li!==null;){var j=Li,K=j.child;if(j.tag===22&&k){var fe=j.memoizedState!==null||$o;if(!fe){var Ne=j.alternate,Je=Ne!==null&&Ne.memoizedState!==null||io;Ne=$o;var Ft=io;if($o=fe,(io=Je)&&!Ft)for(Li=j;Li!==null;)fe=Li,Je=fe.child,fe.tag===22&&fe.memoizedState!==null?t(j):Je!==null?(Je.return=fe,Li=Je):t(j);for(;K!==null;)Li=K,fo(K),K=K.sibling;Li=j,$o=Ne,io=Ft}tp(f)}else(j.subtreeFlags&8772)!==0&&K!==null?(K.return=j,Li=K):tp(f)}}function tp(f){for(;Li!==null;){var g=Li;if((g.flags&8772)!==0){var S=g.alternate;try{if((g.flags&8772)!==0)switch(g.tag){case 0:case 11:case 15:io||uf(5,g);break;case 1:var k=g.stateNode;if(g.flags&4&&!io)if(S===null)k.componentDidMount();else{var j=g.elementType===g.type?S.memoizedProps:sa(g.type,S.memoizedProps);k.componentDidUpdate(j,S.memoizedState,k.__reactInternalSnapshotBeforeUpdate)}var K=g.updateQueue;K!==null&&Kh(g,K,k);break;case 3:var fe=g.updateQueue;if(fe!==null){if(S=null,g.child!==null)switch(g.child.tag){case 5:S=g.child.stateNode;break;case 1:S=g.child.stateNode}Kh(g,fe,S)}break;case 5:var Ne=g.stateNode;if(S===null&&g.flags&4){S=Ne;var Je=g.memoizedProps;switch(g.type){case"button":case"input":case"select":case"textarea":Je.autoFocus&&S.focus();break;case"img":Je.src&&(S.src=Je.src)}}break;case 6:break;case 4:break;case 12:break;case 13:if(g.memoizedState===null){var Ft=g.alternate;if(Ft!==null){var ai=Ft.memoizedState;if(ai!==null){var hi=ai.dehydrated;hi!==null&&Ua(hi)}}}break;case 19:case 17:case 21:case 22:case 23:case 25:break;default:throw Error(m(163))}io||g.flags&512&&hf(g)}catch(ci){Si(g,g.return,ci)}}if(g===f){Li=null;break}if(S=g.sibling,S!==null){S.return=g.return,Li=S;break}Li=g.return}}function l(f){for(;Li!==null;){var g=Li;if(g===f){Li=null;break}var S=g.sibling;if(S!==null){S.return=g.return,Li=S;break}Li=g.return}}function t(f){for(;Li!==null;){var g=Li;try{switch(g.tag){case 0:case 11:case 15:var S=g.return;try{uf(4,g)}catch(Je){Si(g,S,Je)}break;case 1:var k=g.stateNode;if(typeof k.componentDidMount=="function"){var j=g.return;try{k.componentDidMount()}catch(Je){Si(g,j,Je)}}var K=g.return;try{hf(g)}catch(Je){Si(g,K,Je)}break;case 5:var fe=g.return;try{hf(g)}catch(Je){Si(g,fe,Je)}}}catch(Je){Si(g,g.return,Je)}if(g===f){Li=null;break}var Ne=g.sibling;if(Ne!==null){Ne.return=g.return,Li=Ne;break}Li=g.return}}var r=Math.ceil,c=en.ReactCurrentDispatcher,p=en.ReactCurrentOwner,_=en.ReactCurrentBatchConfig,v=0,b=null,I=null,M=0,L=0,B=$l(0),F=0,V=null,$=0,H=0,X=0,Z=null,te=null,oe=0,le=1/0,pe=null,ye=!1,we=null,me=null,_e=!1,ge=null,Be=0,Ce=0,nt=null,He=-1,at=0;function mt(){return(v&6)!==0?Fn():He!==-1?He:He=Fn()}function ze(f){return(f.mode&1)===0?1:(v&2)!==0&&M!==0?M&-M:wu.transition!==null?(at===0&&(at=go()),at):(f=Kn,f!==0||(f=window.event,f=f===void 0?16:ba(f.type)),f)}function Te(f,g,S,k){if(50<Ce)throw Ce=0,nt=null,Error(m(185));Ys(f,S,k),((v&2)===0||f!==b)&&(f===b&&((v&2)===0&&(H|=S),F===4&&It(f,M)),Ze(f,k),S===1&&v===0&&(g.mode&1)===0&&(le=Fn()+500,_u&&fc()))}function Ze(f,g){var S=f.callbackNode;ga(f,g);var k=zl(f,f===b?M:0);if(k===0)S!==null&&Xn(S),f.callbackNode=null,f.callbackPriority=0;else if(g=k&-k,f.callbackPriority!==g){if(S!=null&&Xn(S),g===1)f.tag===0?jf(Qt.bind(null,f)):kd(Qt.bind(null,f)),Qu(function(){(v&6)===0&&fc()}),S=null;else{switch(Va(k)){case 1:S=jn;break;case 4:S=dn;break;case 16:S=rr;break;case 536870912:S=Tr;break;default:S=rr}S=tr(S,Ue.bind(null,f))}f.callbackPriority=g,f.callbackNode=S}}function Ue(f,g){if(He=-1,at=0,(v&6)!==0)throw Error(m(327));var S=f.callbackNode;if(pn()&&f.callbackNode!==S)return null;var k=zl(f,f===b?M:0);if(k===0)return null;if((k&30)!==0||(k&f.expiredLanes)!==0||g)g=gn(f,k);else{g=k;var j=v;v|=2;var K=Fi();(b!==f||M!==g)&&(pe=null,le=Fn()+500,Jt(f,g));do try{En();break}catch(Ne){Ci(f,Ne)}while(!0);gc(),c.current=K,v=j,I!==null?g=0:(b=null,M=0,g=F)}if(g!==0){if(g===2&&(j=So(f),j!==0&&(k=j,g=dt(f,j))),g===1)throw S=V,Jt(f,0),It(f,k),Ze(f,Fn()),S;if(g===6)It(f,k);else{if(j=f.current.alternate,(k&30)===0&&!xt(j)&&(g=gn(f,k),g===2&&(K=So(f),K!==0&&(k=K,g=dt(f,K))),g===1))throw S=V,Jt(f,0),It(f,k),Ze(f,Fn()),S;switch(f.finishedWork=j,f.finishedLanes=k,g){case 0:case 1:throw Error(m(345));case 2:Ni(f,te,pe);break;case 3:if(It(f,k),(k&130023424)===k&&(g=oe+500-Fn(),10<g)){if(zl(f,0)!==0)break;if(j=f.suspendedLanes,(j&k)!==k){mt(),f.pingedLanes|=f.suspendedLanes&j;break}f.timeoutHandle=Md(Ni.bind(null,f,te,pe),g);break}Ni(f,te,pe);break;case 4:if(It(f,k),(k&4194240)===k)break;for(g=f.eventTimes,j=-1;0<k;){var fe=31-Ks(k);K=1<<fe,fe=g[fe],fe>j&&(j=fe),k&=~K}if(k=j,k=Fn()-k,k=(120>k?120:480>k?480:1080>k?1080:1920>k?1920:3e3>k?3e3:4320>k?4320:1960*r(k/1960))-k,10<k){f.timeoutHandle=Md(Ni.bind(null,f,te,pe),k);break}Ni(f,te,pe);break;case 5:Ni(f,te,pe);break;default:throw Error(m(329))}}}return Ze(f,Fn()),f.callbackNode===S?Ue.bind(null,f):null}function dt(f,g){var S=Z;return f.current.memoizedState.isDehydrated&&(Jt(f,g).flags|=256),f=gn(f,g),f!==2&&(g=te,te=S,g!==null&&ft(g)),f}function ft(f){te===null?te=f:te.push.apply(te,f)}function xt(f){for(var g=f;;){if(g.flags&16384){var S=g.updateQueue;if(S!==null&&(S=S.stores,S!==null))for(var k=0;k<S.length;k++){var j=S[k],K=j.getSnapshot;j=j.value;try{if(!Wa(K(),j))return!1}catch{return!1}}}if(S=g.child,g.subtreeFlags&16384&&S!==null)S.return=g,g=S;else{if(g===f)break;for(;g.sibling===null;){if(g.return===null||g.return===f)return!0;g=g.return}g.sibling.return=g.return,g=g.sibling}}return!0}function It(f,g){for(g&=~X,g&=~H,f.suspendedLanes|=g,f.pingedLanes&=~g,f=f.expirationTimes;0<g;){var S=31-Ks(g),k=1<<S;f[S]=-1,g&=~k}}function Qt(f){if((v&6)!==0)throw Error(m(327));pn();var g=zl(f,0);if((g&1)===0)return Ze(f,Fn()),null;var S=gn(f,g);if(f.tag!==0&&S===2){var k=So(f);k!==0&&(g=k,S=dt(f,k))}if(S===1)throw S=V,Jt(f,0),It(f,g),Ze(f,Fn()),S;if(S===6)throw Error(m(345));return f.finishedWork=f.current.alternate,f.finishedLanes=g,Ni(f,te,pe),Ze(f,Fn()),null}function oi(f,g){var S=v;v|=1;try{return f(g)}finally{v=S,v===0&&(le=Fn()+500,_u&&fc())}}function qt(f){ge!==null&&ge.tag===0&&(v&6)===0&&pn();var g=v;v|=1;var S=_.transition,k=Kn;try{if(_.transition=null,Kn=1,f)return f()}finally{Kn=k,_.transition=S,v=g,(v&6)===0&&fc()}}function si(){L=B.current,jr(B)}function Jt(f,g){f.finishedWork=null,f.finishedLanes=0;var S=f.timeoutHandle;if(S!==-1&&(f.timeoutHandle=-1,Nf(S)),I!==null)for(S=I.return;S!==null;){var k=S;switch(Fd(k),k.tag){case 1:k=k.type.childContextTypes,k!=null&&Nc();break;case 3:ks(),jr(vo),jr(Us),Ud();break;case 5:Vd(k);break;case 4:ks();break;case 13:jr(ps);break;case 19:jr(ps);break;case 10:Eu(k.type._context);break;case 22:case 23:si()}S=S.return}if(b=f,I=f=po(f.current,null),M=L=g,F=0,V=null,X=H=$=0,te=Z=null,ra!==null){for(g=0;g<ra.length;g++)if(S=ra[g],k=S.interleaved,k!==null){S.interleaved=null;var j=k.next,K=S.pending;if(K!==null){var fe=K.next;K.next=j,k.next=fe}S.pending=k}ra=null}return f}function Ci(f,g){do{var S=I;try{if(gc(),Ra.current=Do,td){for(var k=hs.memoizedState;k!==null;){var j=k.queue;j!==null&&(j.pending=null),k=k.next}td=!1}if(yl=0,to=Ts=hs=null,Ja=!1,vl=0,p.current=null,S===null||S.return===null){F=1,V=g,I=null;break}e:{var K=f,fe=S.return,Ne=S,Je=g;if(g=M,Ne.flags|=32768,Je!==null&&typeof Je=="object"&&typeof Je.then=="function"){var Ft=Je,ai=Ne,hi=ai.tag;if((ai.mode&1)===0&&(hi===0||hi===11||hi===15)){var ci=ai.alternate;ci?(ai.updateQueue=ci.updateQueue,ai.memoizedState=ci.memoizedState,ai.lanes=ci.lanes):(ai.updateQueue=null,ai.memoizedState=null)}var Oi=Jd(fe);if(Oi!==null){Oi.flags&=-257,fh(Oi,fe,Ne,K,g),Oi.mode&1&&Zc(K,Ft,g),g=Oi,Je=Ft;var qi=g.updateQueue;if(qi===null){var Wi=new Set;Wi.add(Je),g.updateQueue=Wi}else qi.add(Je);break e}else{if((g&1)===0){Zc(K,Ft,g),Hi();break e}Je=Error(m(426))}}else if(Gr&&Ne.mode&1){var $s=Jd(fe);if($s!==null){($s.flags&65536)===0&&($s.flags|=256),fh($s,fe,Ne,K,g),$h(El(Je,Ne));break e}}K=Je=El(Je,Ne),F!==4&&(F=2),Z===null?Z=[K]:Z.push(K),K=fe;do{switch(K.tag){case 3:K.flags|=65536,g&=-g,K.lanes|=g;var yt=Yd(K,Je,g);Ip(K,yt);break e;case 1:Ne=Je;var st=K.type,Pt=K.stateNode;if((K.flags&128)===0&&(typeof st.getDerivedStateFromError=="function"||Pt!==null&&typeof Pt.componentDidCatch=="function"&&(me===null||!me.has(Pt)))){K.flags|=65536,g&=-g,K.lanes|=g;var xi=Qd(K,Ne,g);Ip(K,xi);break e}}K=K.return}while(K!==null)}sr(S)}catch(nn){g=nn,I===S&&S!==null&&(I=S=S.return);continue}break}while(!0)}function Fi(){var f=c.current;return c.current=Do,f===null?Do:f}function Hi(){(F===0||F===3||F===2)&&(F=4),b===null||($&268435455)===0&&(H&268435455)===0||It(b,M)}function gn(f,g){var S=v;v|=2;var k=Fi();(b!==f||M!==g)&&(pe=null,Jt(f,g));do try{ki();break}catch(j){Ci(f,j)}while(!0);if(gc(),v=S,c.current=k,I!==null)throw Error(m(261));return b=null,M=0,F}function ki(){for(;I!==null;)Dn(I)}function En(){for(;I!==null&&!tn();)Dn(I)}function Dn(f){var g=Nn(f.alternate,f,L);f.memoizedProps=f.pendingProps,g===null?sr(f):I=g,p.current=null}function sr(f){var g=f;do{var S=g.alternate;if(f=g.return,(g.flags&32768)===0){if(S=ep(S,g,L),S!==null){I=S;return}}else{if(S=lf(S,g),S!==null){S.flags&=32767,I=S;return}if(f!==null)f.flags|=32768,f.subtreeFlags=0,f.deletions=null;else{F=6,I=null;return}}if(g=g.sibling,g!==null){I=g;return}I=g=f}while(g!==null);F===0&&(F=5)}function Ni(f,g,S){var k=Kn,j=_.transition;try{_.transition=null,Kn=1,Sn(f,g,S,k)}finally{_.transition=j,Kn=k}return null}function Sn(f,g,S,k){do pn();while(ge!==null);if((v&6)!==0)throw Error(m(327));S=f.finishedWork;var j=f.finishedLanes;if(S===null)return null;if(f.finishedWork=null,f.finishedLanes=0,S===f.current)throw Error(m(177));f.callbackNode=null,f.callbackPriority=0;var K=S.lanes|S.childLanes;if(Ir(f,K),f===b&&(I=b=null,M=0),(S.subtreeFlags&2064)===0&&(S.flags&2064)===0||_e||(_e=!0,tr(rr,function(){return pn(),null})),K=(S.flags&15990)!==0,(S.subtreeFlags&15990)!==0||K){K=_.transition,_.transition=null;var fe=Kn;Kn=1;var Ne=v;v|=4,p.current=null,Dp(f,S),kp(S,f),Dc(Yu),ic=!!Ku,Yu=Ku=null,f.current=S,zp(S),Nr(),v=Ne,Kn=fe,_.transition=K}else f.current=S;if(_e&&(_e=!1,ge=f,Be=j),K=f.pendingLanes,K===0&&(me=null),Ns(S.stateNode),Ze(f,Fn()),g!==null)for(k=f.onRecoverableError,S=0;S<g.length;S++)j=g[S],k(j.value,{componentStack:j.stack,digest:j.digest});if(ye)throw ye=!1,f=we,we=null,f;return(Be&1)!==0&&f.tag!==0&&pn(),K=f.pendingLanes,(K&1)!==0?f===nt?Ce++:(Ce=0,nt=f):Ce=0,fc(),null}function pn(){if(ge!==null){var f=Va(Be),g=_.transition,S=Kn;try{if(_.transition=null,Kn=16>f?16:f,ge===null)var k=!1;else{if(f=ge,ge=null,Be=0,(v&6)!==0)throw Error(m(331));var j=v;for(v|=4,Li=f.current;Li!==null;){var K=Li,fe=K.child;if((Li.flags&16)!==0){var Ne=K.deletions;if(Ne!==null){for(var Je=0;Je<Ne.length;Je++){var Ft=Ne[Je];for(Li=Ft;Li!==null;){var ai=Li;switch(ai.tag){case 0:case 11:case 15:bc(8,ai,K)}var hi=ai.child;if(hi!==null)hi.return=ai,Li=hi;else for(;Li!==null;){ai=Li;var ci=ai.sibling,Oi=ai.return;if(df(ai),ai===Ft){Li=null;break}if(ci!==null){ci.return=Oi,Li=ci;break}Li=Oi}}}var qi=K.alternate;if(qi!==null){var Wi=qi.child;if(Wi!==null){qi.child=null;do{var $s=Wi.sibling;Wi.sibling=null,Wi=$s}while(Wi!==null)}}Li=K}}if((K.subtreeFlags&2064)!==0&&fe!==null)fe.return=K,Li=fe;else e:for(;Li!==null;){if(K=Li,(K.flags&2048)!==0)switch(K.tag){case 0:case 11:case 15:bc(9,K,K.return)}var yt=K.sibling;if(yt!==null){yt.return=K.return,Li=yt;break e}Li=K.return}}var st=f.current;for(Li=st;Li!==null;){fe=Li;var Pt=fe.child;if((fe.subtreeFlags&2064)!==0&&Pt!==null)Pt.return=fe,Li=Pt;else e:for(fe=st;Li!==null;){if(Ne=Li,(Ne.flags&2048)!==0)try{switch(Ne.tag){case 0:case 11:case 15:uf(9,Ne)}}catch(nn){Si(Ne,Ne.return,nn)}if(Ne===fe){Li=null;break e}var xi=Ne.sibling;if(xi!==null){xi.return=Ne.return,Li=xi;break e}Li=Ne.return}}if(v=j,fc(),rs&&typeof rs.onPostCommitFiberRoot=="function")try{rs.onPostCommitFiberRoot(us,f)}catch{}k=!0}return k}finally{Kn=S,_.transition=g}}return!1}function Bn(f,g,S){g=El(S,g),g=Yd(f,g,1),f=Xl(f,g,1),g=mt(),f!==null&&(Ys(f,1,g),Ze(f,g))}function Si(f,g,S){if(f.tag===3)Bn(f,f,S);else for(;g!==null;){if(g.tag===3){Bn(g,f,S);break}else if(g.tag===1){var k=g.stateNode;if(typeof g.type.getDerivedStateFromError=="function"||typeof k.componentDidCatch=="function"&&(me===null||!me.has(k))){f=El(S,f),f=Qd(g,f,1),g=Xl(g,f,1),f=mt(),g!==null&&(Ys(g,1,f),Ze(g,f));break}}g=g.return}}function Qn(f,g,S){var k=f.pingCache;k!==null&&k.delete(g),g=mt(),f.pingedLanes|=f.suspendedLanes&S,b===f&&(M&S)===S&&(F===4||F===3&&(M&130023424)===M&&500>Fn()-oe?Jt(f,0):X|=S),Ze(f,g)}function Ln(f,g){g===0&&((f.mode&1)===0?g=1:(g=kl,kl<<=1,(kl&130023424)===0&&(kl=4194304)));var S=mt();f=Ya(f,g),f!==null&&(Ys(f,g,S),Ze(f,S))}function zr(f){var g=f.memoizedState,S=0;g!==null&&(S=g.retryLane),Ln(f,S)}function Tn(f,g){var S=0;switch(f.tag){case 13:var k=f.stateNode,j=f.memoizedState;j!==null&&(S=j.retryLane);break;case 19:k=f.stateNode;break;default:throw Error(m(314))}k!==null&&k.delete(g),Ln(f,S)}var Nn;Nn=function(f,g,S){if(f!==null)if(f.memoizedProps!==g.pendingProps||vo.current)zs=!0;else{if((f.lanes&S)===0&&(g.flags&128)===0)return zs=!1,kr(f,g,S);zs=(f.flags&131072)!==0}else zs=!1,Gr&&(g.flags&1048576)!==0&&yu(g,zd,g.index);switch(g.lanes=0,g.tag){case 2:var k=g.type;of(f,g),f=g.pendingProps;var j=Bc(g,Us.current);Su(g,S),j=jc(null,g,k,f,j,S);var K=Fr();return g.flags|=1,typeof j=="object"&&j!==null&&typeof j.render=="function"&&j.$$typeof===void 0?(g.tag=1,g.memoizedState=null,g.updateQueue=null,xo(k)?(K=!0,nh(g)):K=!1,g.memoizedState=j.state!==null&&j.state!==void 0?j.state:null,gl(g),j.updater=bl,g.stateNode=j,j._reactInternals=g,hh(g,k,f,S),g=ph(null,g,k,!0,K,S)):(g.tag=0,Gr&&K&&Hh(g),wo(null,g,j,S),g=g.child),g;case 16:k=g.elementType;e:{switch(of(f,g),f=g.pendingProps,j=k._init,k=j(k._payload),g.type=k,j=g.tag=Hs(k),f=sa(k,f),j){case 0:g=ld(null,g,k,f,S);break e;case 1:g=Zf(null,g,k,f,S);break e;case 11:g=ef(null,g,k,f,S);break e;case 14:g=od(null,g,k,sa(k.type,f),S);break e}throw Error(m(306,k,""))}return g;case 0:return k=g.type,j=g.pendingProps,j=g.elementType===k?j:sa(k,j),ld(f,g,k,j,S);case 1:return k=g.type,j=g.pendingProps,j=g.elementType===k?j:sa(k,j),Zf(f,g,k,j,S);case 3:e:{if(mh(g),f===null)throw Error(m(387));k=g.pendingProps,K=g.memoizedState,j=K.element,Ro(f,g),Au(g,k,null,S);var fe=g.memoizedState;if(k=fe.element,K.isDehydrated)if(K={element:k,isDehydrated:!1,cache:fe.cache,pendingSuspenseBoundaries:fe.pendingSuspenseBoundaries,transitions:fe.transitions},g.updateQueue.baseState=K,g.memoizedState=K,g.flags&256){j=El(Error(m(423)),g),g=nf(f,g,k,S,j);break e}else if(k!==j){j=El(Error(m(424)),g),g=nf(f,g,k,S,j);break e}else for(Po=Gl(g.stateNode.containerInfo.firstChild),ia=g,Gr=!0,Aa=null,S=Bd(g,null,k,S),g.child=S;S;)S.flags=S.flags&-3|4096,S=S.sibling;else{if(xu(),k===j){g=xc(f,g,S);break e}wo(f,g,k,S)}g=g.child}return g;case 5:return yc(g),f===null&&Od(g),k=g.type,j=g.pendingProps,K=f!==null?f.memoizedProps:null,fe=j.children,zc(k,j)?fe=null:K!==null&&zc(k,K)&&(g.flags|=32),ad(f,g),wo(f,g,fe,S),g.child;case 6:return f===null&&Od(g),null;case 13:return Xf(f,g,S);case 4:return Jh(g,g.stateNode.containerInfo),k=g.pendingProps,f===null?g.child=Uc(g,null,k,S):wo(f,g,k,S),g.child;case 11:return k=g.type,j=g.pendingProps,j=g.elementType===k?j:sa(k,j),ef(f,g,k,j,S);case 7:return wo(f,g,g.pendingProps,S),g.child;case 8:return wo(f,g,g.pendingProps.children,S),g.child;case 12:return wo(f,g,g.pendingProps.children,S),g.child;case 10:e:{if(k=g.type._context,j=g.pendingProps,K=g.memoizedProps,fe=j.value,os(Zl,k._currentValue),k._currentValue=fe,K!==null)if(Wa(K.value,fe)){if(K.children===j.children&&!vo.current){g=xc(f,g,S);break e}}else for(K=g.child,K!==null&&(K.return=g);K!==null;){var Ne=K.dependencies;if(Ne!==null){fe=K.child;for(var Je=Ne.firstContext;Je!==null;){if(Je.context===k){if(K.tag===1){Je=fi(-1,S&-S),Je.tag=2;var Ft=K.updateQueue;if(Ft!==null){Ft=Ft.shared;var ai=Ft.pending;ai===null?Je.next=Je:(Je.next=ai.next,ai.next=Je),Ft.pending=Je}}K.lanes|=S,Je=K.alternate,Je!==null&&(Je.lanes|=S),Xh(K.return,S,g),Ne.lanes|=S;break}Je=Je.next}}else if(K.tag===10)fe=K.type===g.type?null:K.child;else if(K.tag===18){if(fe=K.return,fe===null)throw Error(m(341));fe.lanes|=S,Ne=fe.alternate,Ne!==null&&(Ne.lanes|=S),Xh(fe,S,g),fe=K.sibling}else fe=K.child;if(fe!==null)fe.return=K;else for(fe=K;fe!==null;){if(fe===g){fe=null;break}if(K=fe.sibling,K!==null){K.return=fe.return,fe=K;break}fe=fe.return}K=fe}wo(f,g,j.children,S),g=g.child}return g;case 9:return j=g.type,k=g.pendingProps.children,Su(g,S),j=na(j),k=k(j),g.flags|=1,wo(f,g,k,S),g.child;case 14:return k=g.type,j=sa(k,g.pendingProps),j=sa(k.type,j),od(f,g,k,j,S);case 15:return ku(f,g,g.type,g.pendingProps,S);case 17:return k=g.type,j=g.pendingProps,j=g.elementType===k?j:sa(k,j),of(f,g),g.tag=1,xo(k)?(f=!0,nh(g)):f=!1,Su(g,S),Tl(g,k,j),hh(g,k,j,S),ph(null,g,k,!0,f,S);case 19:return Yf(f,g,S);case 22:return tf(f,g,S)}throw Error(m(156,g.tag))};function tr(f,g){return Yi(f,g)}function ls(f,g,S,k){this.tag=f,this.key=S,this.sibling=this.child=this.return=this.stateNode=this.type=this.elementType=null,this.index=0,this.ref=null,this.pendingProps=g,this.dependencies=this.memoizedState=this.updateQueue=this.memoizedProps=null,this.mode=k,this.subtreeFlags=this.flags=0,this.deletions=null,this.childLanes=this.lanes=0,this.alternate=null}function pr(f,g,S,k){return new ls(f,g,S,k)}function ts(f){return f=f.prototype,!(!f||!f.isReactComponent)}function Hs(f){if(typeof f=="function")return ts(f)?1:0;if(f!=null){if(f=f.$$typeof,f===ut)return 11;if(f===$n)return 14}return 2}function po(f,g){var S=f.alternate;return S===null?(S=pr(f.tag,g,f.key,f.mode),S.elementType=f.elementType,S.type=f.type,S.stateNode=f.stateNode,S.alternate=f,f.alternate=S):(S.pendingProps=g,S.type=f.type,S.flags=0,S.subtreeFlags=0,S.deletions=null),S.flags=f.flags&14680064,S.childLanes=f.childLanes,S.lanes=f.lanes,S.child=f.child,S.memoizedProps=f.memoizedProps,S.memoizedState=f.memoizedState,S.updateQueue=f.updateQueue,g=f.dependencies,S.dependencies=g===null?null:{lanes:g.lanes,firstContext:g.firstContext},S.sibling=f.sibling,S.index=f.index,S.ref=f.ref,S}function no(f,g,S,k,j,K){var fe=2;if(k=f,typeof f=="function")ts(f)&&(fe=1);else if(typeof f=="string")fe=5;else e:switch(f){case rt:return qs(S.children,j,K,g);case De:fe=8,j|=8;break;case je:return f=pr(12,S,g,j|2),f.elementType=je,f.lanes=K,f;case Oe:return f=pr(13,S,g,j),f.elementType=Oe,f.lanes=K,f;case kn:return f=pr(19,S,g,j),f.elementType=kn,f.lanes=K,f;case Gn:return Fs(S,j,K,g);default:if(typeof f=="object"&&f!==null)switch(f.$$typeof){case Ke:fe=10;break e;case We:fe=9;break e;case ut:fe=11;break e;case $n:fe=14;break e;case wn:fe=16,k=null;break e}throw Error(m(130,f==null?f:typeof f,""))}return g=pr(fe,S,g,j),g.elementType=f,g.type=k,g.lanes=K,g}function qs(f,g,S,k){return f=pr(7,f,k,g),f.lanes=S,f}function Fs(f,g,S,k){return f=pr(22,f,k,g),f.elementType=Gn,f.lanes=S,f.stateNode={isHidden:!1},f}function Wo(f,g,S){return f=pr(6,f,null,g),f.lanes=S,f}function aa(f,g,S){return g=pr(4,f.children!==null?f.children:[],f.key,g),g.lanes=S,g.stateNode={containerInfo:f.containerInfo,pendingChildren:null,implementation:f.implementation},g}function mo(f,g,S,k,j){this.tag=g,this.containerInfo=f,this.finishedWork=this.pingCache=this.current=this.pendingChildren=null,this.timeoutHandle=-1,this.callbackNode=this.pendingContext=this.context=null,this.callbackPriority=0,this.eventTimes=Vs(0),this.expirationTimes=Vs(-1),this.entangledLanes=this.finishedLanes=this.mutableReadLanes=this.expiredLanes=this.pingedLanes=this.suspendedLanes=this.pendingLanes=0,this.entanglements=Vs(0),this.identifierPrefix=k,this.onRecoverableError=j,this.mutableSourceEagerHydrationData=null}function Hr(f,g,S,k,j,K,fe,Ne,Je){return f=new mo(f,g,S,Ne,Je),g===1?(g=1,K===!0&&(g|=8)):g=0,K=pr(3,null,null,g),f.current=K,K.stateNode=f,K.memoizedState={element:k,isDehydrated:S,cache:null,transitions:null,pendingSuspenseBoundaries:null},gl(K),f}function qr(f,g,S){var k=3<arguments.length&&arguments[3]!==void 0?arguments[3]:null;return{$$typeof:_n,key:k==null?null:""+k,children:f,containerInfo:g,implementation:S}}function lr(f){if(!f)return Ia;f=f._reactInternals;e:{if(lt(f)!==f||f.tag!==1)throw Error(m(170));var g=f;do{switch(g.tag){case 3:g=g.stateNode.context;break e;case 1:if(xo(g.type)){g=g.stateNode.__reactInternalMemoizedMergedChildContext;break e}}g=g.return}while(g!==null);throw Error(m(171))}if(f.tag===1){var S=f.type;if(xo(S))return Ld(f,S,g)}return g}function ms(f,g,S,k,j,K,fe,Ne,Je){return f=Hr(S,k,!0,f,j,K,fe,Ne,Je),f.context=lr(null),S=f.current,k=mt(),j=ze(S),K=fi(k,j),K.callback=g??null,Xl(S,K,j),f.current.lanes=j,Ys(f,j,k),Ze(f,k),f}function Is(f,g,S,k){var j=g.current,K=mt(),fe=ze(j);return S=lr(S),g.context===null?g.context=S:g.pendingContext=S,g=fi(K,fe),g.payload={element:f},k=k===void 0?null:k,k!==null&&(g.callback=k),f=Xl(j,g,fe),f!==null&&(Te(f,j,fe,K),Nd(f,j,fe)),fe}function Or(f){if(f=f.current,!f.child)return null;switch(f.child.tag){case 5:return f.child.stateNode;default:return f.child.stateNode}}function la(f,g){if(f=f.memoizedState,f!==null&&f.dehydrated!==null){var S=f.retryLane;f.retryLane=S!==0&&S<g?S:g}}function Tc(f,g){la(f,g),(f=f.alternate)&&la(f,g)}function Kc(){return null}var Fu=typeof reportError=="function"?reportError:function(f){console.error(f)};function Yc(f){this._internalRoot=f}Lo.prototype.render=Yc.prototype.render=function(f){var g=this._internalRoot;if(g===null)throw Error(m(409));Is(f,g,null,null)},Lo.prototype.unmount=Yc.prototype.unmount=function(){var f=this._internalRoot;if(f!==null){this._internalRoot=null;var g=f.containerInfo;qt(function(){Is(null,f,null,null)}),g[ql]=null}};function Lo(f){this._internalRoot=f}Lo.prototype.unstable_scheduleHydration=function(f){if(f){var g=ec();f={blockedOn:null,target:f,priority:g};for(var S=0;S<ea.length&&g!==0&&g<ea[S].priority;S++);ea.splice(S,0,f),S===0&&vd(f)}};function el(f){return!(!f||f.nodeType!==1&&f.nodeType!==9&&f.nodeType!==11)}function cs(f){return!(!f||f.nodeType!==1&&f.nodeType!==9&&f.nodeType!==11&&(f.nodeType!==8||f.nodeValue!==" react-mount-point-unstable "))}function ca(){}function Ou(f,g,S,k,j){if(j){if(typeof k=="function"){var K=k;k=function(){var Ft=Or(fe);K.call(Ft)}}var fe=ms(g,k,f,0,null,!1,!1,"",ca);return f._reactRootContainer=fe,f[ql]=fe.current,Oh(f.nodeType===8?f.parentNode:f),qt(),fe}for(;j=f.lastChild;)f.removeChild(j);if(typeof k=="function"){var Ne=k;k=function(){var Ft=Or(Je);Ne.call(Ft)}}var Je=Hr(f,0,!1,null,null,!1,!1,"",ca);return f._reactRootContainer=Je,f[ql]=Je.current,Oh(f.nodeType===8?f.parentNode:f),qt(function(){Is(g,Je,S,k)}),Je}function Fp(f,g,S,k,j){var K=S._reactRootContainer;if(K){var fe=K;if(typeof j=="function"){var Ne=j;j=function(){var Je=Or(fe);Ne.call(Je)}}Is(g,fe,f,j)}else fe=Ou(S,g,f,j,k);return Or(fe)}ya=function(f){switch(f.tag){case 3:var g=f.stateNode;if(g.current.memoizedState.isDehydrated){var S=al(g.pendingLanes);S!==0&&(lo(g,S|1),Ze(g,Fn()),(v&6)===0&&(le=Fn()+500,fc()))}break;case 13:qt(function(){var k=Ya(f,1);if(k!==null){var j=mt();Te(k,f,1,j)}}),Tc(f,1)}},Fl=function(f){if(f.tag===13){var g=Ya(f,134217728);if(g!==null){var S=mt();Te(g,f,134217728,S)}Tc(f,134217728)}},Ol=function(f){if(f.tag===13){var g=ze(f),S=Ya(f,g);if(S!==null){var k=mt();Te(S,f,g,k)}Tc(f,g)}},ec=function(){return Kn},ju=function(f,g){var S=Kn;try{return Kn=f,g()}finally{Kn=S}},Dl=function(f,g,S){switch(g){case"input":if(cn(f,S),g=S.name,S.type==="radio"&&g!=null){for(S=f;S.parentNode;)S=S.parentNode;for(S=S.querySelectorAll("input[name="+JSON.stringify(""+g)+'][type="radio"]'),g=0;g<S.length;g++){var k=S[g];if(k!==f&&k.form===f.form){var j=ih(k);if(!j)throw Error(m(90));Bo(k),cn(k,j)}}}break;case"textarea":Qo(f,S);break;case"select":g=S.value,g!=null&&Rn(f,!!S.multiple,g,!1)}},Vo=oi,eu=qt;var Op={usingClientEntryPoint:!1,Events:[th,Oc,ih,No,gt,oi]},ip={findFiberByHostInstance:mu,bundleType:0,version:"18.3.1",rendererPackageName:"react-dom"},U_={bundleType:ip.bundleType,version:ip.version,rendererPackageName:ip.rendererPackageName,rendererConfig:ip.rendererConfig,overrideHookState:null,overrideHookStateDeletePath:null,overrideHookStateRenamePath:null,overrideProps:null,overridePropsDeletePath:null,overridePropsRenamePath:null,setErrorHandler:null,setSuspenseHandler:null,scheduleUpdate:null,currentDispatcherRef:en.ReactCurrentDispatcher,findHostInstanceByFiber:function(f){return f=Ki(f),f===null?null:f.stateNode},findFiberByHostInstance:ip.findFiberByHostInstance||Kc,findHostInstancesForRefresh:null,scheduleRefresh:null,scheduleRoot:null,setRefreshHandler:null,getCurrentFiber:null,reconcilerVersion:"18.3.1-next-f1338f8080-20240426"};if(typeof __REACT_DEVTOOLS_GLOBAL_HOOK__<"u"){var hd=__REACT_DEVTOOLS_GLOBAL_HOOK__;if(!hd.isDisabled&&hd.supportsFiber)try{us=hd.inject(U_),rs=hd}catch{}}return Yl.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED=Op,Yl.createPortal=function(f,g){var S=2<arguments.length&&arguments[2]!==void 0?arguments[2]:null;if(!el(g))throw Error(m(200));return qr(f,g,null,S)},Yl.createRoot=function(f,g){if(!el(f))throw Error(m(299));var S=!1,k="",j=Fu;return g!=null&&(g.unstable_strictMode===!0&&(S=!0),g.identifierPrefix!==void 0&&(k=g.identifierPrefix),g.onRecoverableError!==void 0&&(j=g.onRecoverableError)),g=Hr(f,1,!1,null,null,S,!1,k,j),f[ql]=g.current,Oh(f.nodeType===8?f.parentNode:f),new Yc(g)},Yl.findDOMNode=function(f){if(f==null)return null;if(f.nodeType===1)return f;var g=f._reactInternals;if(g===void 0)throw typeof f.render=="function"?Error(m(188)):(f=Object.keys(f).join(","),Error(m(268,f)));return f=Ki(g),f=f===null?null:f.stateNode,f},Yl.flushSync=function(f){return qt(f)},Yl.hydrate=function(f,g,S){if(!cs(g))throw Error(m(200));return Fp(null,f,g,!0,S)},Yl.hydrateRoot=function(f,g,S){if(!el(f))throw Error(m(405));var k=S!=null&&S.hydratedSources||null,j=!1,K="",fe=Fu;if(S!=null&&(S.unstable_strictMode===!0&&(j=!0),S.identifierPrefix!==void 0&&(K=S.identifierPrefix),S.onRecoverableError!==void 0&&(fe=S.onRecoverableError)),g=ms(g,null,f,1,S??null,j,!1,K,fe),f[ql]=g.current,Oh(f),k)for(f=0;f<k.length;f++)S=k[f],j=S._getVersion,j=j(S._source),g.mutableSourceEagerHydrationData==null?g.mutableSourceEagerHydrationData=[S,j]:g.mutableSourceEagerHydrationData.push(S,j);return new Lo(g)},Yl.render=function(f,g,S){if(!cs(g))throw Error(m(200));return Fp(null,f,g,!1,S)},Yl.unmountComponentAtNode=function(f){if(!cs(f))throw Error(m(40));return f._reactRootContainer?(qt(function(){Fp(null,null,f,!1,function(){f._reactRootContainer=null,f[ql]=null})}),!0):!1},Yl.unstable_batchedUpdates=oi,Yl.unstable_renderSubtreeIntoContainer=function(f,g,S,k){if(!cs(S))throw Error(m(200));if(f==null||f._reactInternals===void 0)throw Error(m(38));return Fp(f,g,S,!1,k)},Yl.version="18.3.1-next-f1338f8080-20240426",Yl}var Wb;function _A(){if(Wb)return O0.exports;Wb=1;function x(){if(!(typeof __REACT_DEVTOOLS_GLOBAL_HOOK__>"u"||typeof __REACT_DEVTOOLS_GLOBAL_HOOK__.checkDCE!="function"))try{__REACT_DEVTOOLS_GLOBAL_HOOK__.checkDCE(x)}catch(u){console.error(u)}}return x(),O0.exports=mA(),O0.exports}var Zb;function gA(){if(Zb)return Dg;Zb=1;var x=_A();return Dg.createRoot=x.createRoot,Dg.hydrateRoot=x.hydrateRoot,Dg}var yA=gA();const vA=J2(yA);/**
 * react-router v7.8.1
 *
 * Copyright (c) Remix Software Inc.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE.md file in the root directory of this source tree.
 *
 * @license MIT
 */var Xb="popstate";function xA(x={}){function u(E,A){let{pathname:z,search:U,hash:s}=E.location;return Q0("",{pathname:z,search:U,hash:s},A.state&&A.state.usr||null,A.state&&A.state.key||"default")}function m(E,A){return typeof A=="string"?A:y_(A)}return bA(u,m,null,x)}function so(x,u){if(x===!1||x===null||typeof x>"u")throw new Error(u)}function Eh(x,u){if(!x){typeof console<"u"&&console.warn(u);try{throw new Error(u)}catch{}}}function wA(){return Math.random().toString(36).substring(2,10)}function Kb(x,u){return{usr:x.state,key:x.key,idx:u}}function Q0(x,u,m=null,E){return{pathname:typeof x=="string"?x:x.pathname,search:"",hash:"",...typeof u=="string"?fm(u):u,state:m,key:u&&u.key||E||wA()}}function y_({pathname:x="/",search:u="",hash:m=""}){return u&&u!=="?"&&(x+=u.charAt(0)==="?"?u:"?"+u),m&&m!=="#"&&(x+=m.charAt(0)==="#"?m:"#"+m),x}function fm(x){let u={};if(x){let m=x.indexOf("#");m>=0&&(u.hash=x.substring(m),x=x.substring(0,m));let E=x.indexOf("?");E>=0&&(u.search=x.substring(E),x=x.substring(0,E)),x&&(u.pathname=x)}return u}function bA(x,u,m,E={}){let{window:A=document.defaultView,v5Compat:z=!1}=E,U=A.history,s="POP",ee=null,ne=Ie();ne==null&&(ne=0,U.replaceState({...U.state,idx:ne},""));function Ie(){return(U.state||{idx:null}).idx}function qe(){s="POP";let wt=Ie(),Nt=wt==null?null:wt-ne;ne=wt,ee&&ee({action:s,location:ct.location,delta:Nt})}function Xe(wt,Nt){s="PUSH";let Ti=Q0(ct.location,wt,Nt);ne=Ie()+1;let Ei=Kb(Ti,ne),en=ct.createHref(Ti);try{U.pushState(Ei,"",en)}catch(Hn){if(Hn instanceof DOMException&&Hn.name==="DataCloneError")throw Hn;A.location.assign(en)}z&&ee&&ee({action:s,location:ct.location,delta:1})}function St(wt,Nt){s="REPLACE";let Ti=Q0(ct.location,wt,Nt);ne=Ie();let Ei=Kb(Ti,ne),en=ct.createHref(Ti);U.replaceState(Ei,"",en),z&&ee&&ee({action:s,location:ct.location,delta:0})}function $t(wt){return TA(wt)}let ct={get action(){return s},get location(){return x(A,U)},listen(wt){if(ee)throw new Error("A history only accepts one active listener");return A.addEventListener(Xb,qe),ee=wt,()=>{A.removeEventListener(Xb,qe),ee=null}},createHref(wt){return u(A,wt)},createURL:$t,encodeLocation(wt){let Nt=$t(wt);return{pathname:Nt.pathname,search:Nt.search,hash:Nt.hash}},push:Xe,replace:St,go(wt){return U.go(wt)}};return ct}function TA(x,u=!1){let m="http://localhost";typeof window<"u"&&(m=window.location.origin!=="null"?window.location.origin:window.location.href),so(m,"No window.location.(origin|href) available to create URL");let E=typeof x=="string"?x:y_(x);return E=E.replace(/ $/,"%20"),!u&&E.startsWith("//")&&(E=m+E),new URL(E,m)}function eT(x,u,m="/"){return EA(x,u,m,!1)}function EA(x,u,m,E){let A=typeof u=="string"?fm(u):u,z=pd(A.pathname||"/",m);if(z==null)return null;let U=tT(x);SA(U);let s=null;for(let ee=0;s==null&&ee<U.length;++ee){let ne=FA(z);s=kA(U[ee],ne,E)}return s}function tT(x,u=[],m=[],E="",A=!1){let z=(U,s,ee=A,ne)=>{let Ie={relativePath:ne===void 0?U.path||"":ne,caseSensitive:U.caseSensitive===!0,childrenIndex:s,route:U};if(Ie.relativePath.startsWith("/")){if(!Ie.relativePath.startsWith(E)&&ee)return;so(Ie.relativePath.startsWith(E),`Absolute route path "${Ie.relativePath}" nested under path "${E}" is not valid. An absolute child route path must start with the combined path of all its parent routes.`),Ie.relativePath=Ie.relativePath.slice(E.length)}let qe=fd([E,Ie.relativePath]),Xe=m.concat(Ie);U.children&&U.children.length>0&&(so(U.index!==!0,`Index routes must not have child routes. Please remove all child routes from route path "${qe}".`),tT(U.children,u,Xe,qe,ee)),!(U.path==null&&!U.index)&&u.push({path:qe,score:DA(qe,U.index),routesMeta:Xe})};return x.forEach((U,s)=>{if(U.path===""||!U.path?.includes("?"))z(U,s);else for(let ee of iT(U.path))z(U,s,!0,ee)}),u}function iT(x){let u=x.split("/");if(u.length===0)return[];let[m,...E]=u,A=m.endsWith("?"),z=m.replace(/\?$/,"");if(E.length===0)return A?[z,""]:[z];let U=iT(E.join("/")),s=[];return s.push(...U.map(ee=>ee===""?z:[z,ee].join("/"))),A&&s.push(...U),s.map(ee=>x.startsWith("/")&&ee===""?"/":ee)}function SA(x){x.sort((u,m)=>u.score!==m.score?m.score-u.score:LA(u.routesMeta.map(E=>E.childrenIndex),m.routesMeta.map(E=>E.childrenIndex)))}var IA=/^:[\w-]+$/,AA=3,CA=2,PA=1,RA=10,MA=-2,Yb=x=>x==="*";function DA(x,u){let m=x.split("/"),E=m.length;return m.some(Yb)&&(E+=MA),u&&(E+=CA),m.filter(A=>!Yb(A)).reduce((A,z)=>A+(IA.test(z)?AA:z===""?PA:RA),E)}function LA(x,u){return x.length===u.length&&x.slice(0,-1).every((E,A)=>E===u[A])?x[x.length-1]-u[u.length-1]:0}function kA(x,u,m=!1){let{routesMeta:E}=x,A={},z="/",U=[];for(let s=0;s<E.length;++s){let ee=E[s],ne=s===E.length-1,Ie=z==="/"?u:u.slice(z.length)||"/",qe=Zg({path:ee.relativePath,caseSensitive:ee.caseSensitive,end:ne},Ie),Xe=ee.route;if(!qe&&ne&&m&&!E[E.length-1].route.index&&(qe=Zg({path:ee.relativePath,caseSensitive:ee.caseSensitive,end:!1},Ie)),!qe)return null;Object.assign(A,qe.params),U.push({params:A,pathname:fd([z,qe.pathname]),pathnameBase:VA(fd([z,qe.pathnameBase])),route:Xe}),qe.pathnameBase!=="/"&&(z=fd([z,qe.pathnameBase]))}return U}function Zg(x,u){typeof x=="string"&&(x={path:x,caseSensitive:!1,end:!0});let[m,E]=zA(x.path,x.caseSensitive,x.end),A=u.match(m);if(!A)return null;let z=A[0],U=z.replace(/(.)\/+$/,"$1"),s=A.slice(1);return{params:E.reduce((ne,{paramName:Ie,isOptional:qe},Xe)=>{if(Ie==="*"){let $t=s[Xe]||"";U=z.slice(0,z.length-$t.length).replace(/(.)\/+$/,"$1")}const St=s[Xe];return qe&&!St?ne[Ie]=void 0:ne[Ie]=(St||"").replace(/%2F/g,"/"),ne},{}),pathname:z,pathnameBase:U,pattern:x}}function zA(x,u=!1,m=!0){Eh(x==="*"||!x.endsWith("*")||x.endsWith("/*"),`Route path "${x}" will be treated as if it were "${x.replace(/\*$/,"/*")}" because the \`*\` character must always follow a \`/\` in the pattern. To get rid of this warning, please change the route path to "${x.replace(/\*$/,"/*")}".`);let E=[],A="^"+x.replace(/\/*\*?$/,"").replace(/^\/*/,"/").replace(/[\\.*+^${}|()[\]]/g,"\\$&").replace(/\/:([\w-]+)(\?)?/g,(U,s,ee)=>(E.push({paramName:s,isOptional:ee!=null}),ee?"/?([^\\/]+)?":"/([^\\/]+)")).replace(/\/([\w-]+)\?(\/|$)/g,"(/$1)?$2");return x.endsWith("*")?(E.push({paramName:"*"}),A+=x==="*"||x==="/*"?"(.*)$":"(?:\\/(.+)|\\/*)$"):m?A+="\\/*$":x!==""&&x!=="/"&&(A+="(?:(?=\\/|$))"),[new RegExp(A,u?void 0:"i"),E]}function FA(x){try{return x.split("/").map(u=>decodeURIComponent(u).replace(/\//g,"%2F")).join("/")}catch(u){return Eh(!1,`The URL path "${x}" could not be decoded because it is a malformed URL segment. This is probably due to a bad percent encoding (${u}).`),x}}function pd(x,u){if(u==="/")return x;if(!x.toLowerCase().startsWith(u.toLowerCase()))return null;let m=u.endsWith("/")?u.length-1:u.length,E=x.charAt(m);return E&&E!=="/"?null:x.slice(m)||"/"}function OA(x,u="/"){let{pathname:m,search:E="",hash:A=""}=typeof x=="string"?fm(x):x;return{pathname:m?m.startsWith("/")?m:BA(m,u):u,search:UA(E),hash:jA(A)}}function BA(x,u){let m=u.replace(/\/+$/,"").split("/");return x.split("/").forEach(A=>{A===".."?m.length>1&&m.pop():A!=="."&&m.push(A)}),m.length>1?m.join("/"):"/"}function V0(x,u,m,E){return`Cannot include a '${x}' character in a manually specified \`to.${u}\` field [${JSON.stringify(E)}].  Please separate it out to the \`to.${m}\` field. Alternatively you may provide the full path as a string in <Link to="..."> and the router will parse it for you.`}function NA(x){return x.filter((u,m)=>m===0||u.route.path&&u.route.path.length>0)}function nT(x){let u=NA(x);return u.map((m,E)=>E===u.length-1?m.pathname:m.pathnameBase)}function rT(x,u,m,E=!1){let A;typeof x=="string"?A=fm(x):(A={...x},so(!A.pathname||!A.pathname.includes("?"),V0("?","pathname","search",A)),so(!A.pathname||!A.pathname.includes("#"),V0("#","pathname","hash",A)),so(!A.search||!A.search.includes("#"),V0("#","search","hash",A)));let z=x===""||A.pathname==="",U=z?"/":A.pathname,s;if(U==null)s=m;else{let qe=u.length-1;if(!E&&U.startsWith("..")){let Xe=U.split("/");for(;Xe[0]==="..";)Xe.shift(),qe-=1;A.pathname=Xe.join("/")}s=qe>=0?u[qe]:"/"}let ee=OA(A,s),ne=U&&U!=="/"&&U.endsWith("/"),Ie=(z||U===".")&&m.endsWith("/");return!ee.pathname.endsWith("/")&&(ne||Ie)&&(ee.pathname+="/"),ee}var fd=x=>x.join("/").replace(/\/\/+/g,"/"),VA=x=>x.replace(/\/+$/,"").replace(/^\/*/,"/"),UA=x=>!x||x==="?"?"":x.startsWith("?")?x:"?"+x,jA=x=>!x||x==="#"?"":x.startsWith("#")?x:"#"+x;function GA(x){return x!=null&&typeof x.status=="number"&&typeof x.statusText=="string"&&typeof x.internal=="boolean"&&"data"in x}var sT=["POST","PUT","PATCH","DELETE"];new Set(sT);var HA=["GET",...sT];new Set(HA);var pm=Ot.createContext(null);pm.displayName="DataRouter";var ay=Ot.createContext(null);ay.displayName="DataRouterState";Ot.createContext(!1);var oT=Ot.createContext({isTransitioning:!1});oT.displayName="ViewTransition";var qA=Ot.createContext(new Map);qA.displayName="Fetchers";var $A=Ot.createContext(null);$A.displayName="Await";var Ah=Ot.createContext(null);Ah.displayName="Navigation";var M_=Ot.createContext(null);M_.displayName="Location";var Ch=Ot.createContext({outlet:null,matches:[],isDataRoute:!1});Ch.displayName="Route";var bv=Ot.createContext(null);bv.displayName="RouteError";function WA(x,{relative:u}={}){so(D_(),"useHref() may be used only in the context of a <Router> component.");let{basename:m,navigator:E}=Ot.useContext(Ah),{hash:A,pathname:z,search:U}=L_(x,{relative:u}),s=z;return m!=="/"&&(s=z==="/"?m:fd([m,z])),E.createHref({pathname:s,search:U,hash:A})}function D_(){return Ot.useContext(M_)!=null}function xp(){return so(D_(),"useLocation() may be used only in the context of a <Router> component."),Ot.useContext(M_).location}var aT="You should call navigate() in a React.useEffect(), not when your component is first rendered.";function lT(x){Ot.useContext(Ah).static||Ot.useLayoutEffect(x)}function ZA(){let{isDataRoute:x}=Ot.useContext(Ch);return x?l4():XA()}function XA(){so(D_(),"useNavigate() may be used only in the context of a <Router> component.");let x=Ot.useContext(pm),{basename:u,navigator:m}=Ot.useContext(Ah),{matches:E}=Ot.useContext(Ch),{pathname:A}=xp(),z=JSON.stringify(nT(E)),U=Ot.useRef(!1);return lT(()=>{U.current=!0}),Ot.useCallback((ee,ne={})=>{if(Eh(U.current,aT),!U.current)return;if(typeof ee=="number"){m.go(ee);return}let Ie=rT(ee,JSON.parse(z),A,ne.relative==="path");x==null&&u!=="/"&&(Ie.pathname=Ie.pathname==="/"?u:fd([u,Ie.pathname])),(ne.replace?m.replace:m.push)(Ie,ne.state,ne)},[u,m,z,A,x])}Ot.createContext(null);function KA(){let{matches:x}=Ot.useContext(Ch),u=x[x.length-1];return u?u.params:{}}function L_(x,{relative:u}={}){let{matches:m}=Ot.useContext(Ch),{pathname:E}=xp(),A=JSON.stringify(nT(m));return Ot.useMemo(()=>rT(x,JSON.parse(A),E,u==="path"),[x,A,E,u])}function YA(x,u){return cT(x,u)}function cT(x,u,m,E){so(D_(),"useRoutes() may be used only in the context of a <Router> component.");let{navigator:A}=Ot.useContext(Ah),{matches:z}=Ot.useContext(Ch),U=z[z.length-1],s=U?U.params:{},ee=U?U.pathname:"/",ne=U?U.pathnameBase:"/",Ie=U&&U.route;{let Nt=Ie&&Ie.path||"";uT(ee,!Ie||Nt.endsWith("*")||Nt.endsWith("*?"),`You rendered descendant <Routes> (or called \`useRoutes()\`) at "${ee}" (under <Route path="${Nt}">) but the parent route path has no trailing "*". This means if you navigate deeper, the parent won't match anymore and therefore the child routes will never render.

Please change the parent <Route path="${Nt}"> to <Route path="${Nt==="/"?"*":`${Nt}/*`}">.`)}let qe=xp(),Xe;if(u){let Nt=typeof u=="string"?fm(u):u;so(ne==="/"||Nt.pathname?.startsWith(ne),`When overriding the location using \`<Routes location>\` or \`useRoutes(routes, location)\`, the location pathname must begin with the portion of the URL pathname that was matched by all parent routes. The current pathname base is "${ne}" but pathname "${Nt.pathname}" was given in the \`location\` prop.`),Xe=Nt}else Xe=qe;let St=Xe.pathname||"/",$t=St;if(ne!=="/"){let Nt=ne.replace(/^\//,"").split("/");$t="/"+St.replace(/^\//,"").split("/").slice(Nt.length).join("/")}let ct=eT(x,{pathname:$t});Eh(Ie||ct!=null,`No routes matched location "${Xe.pathname}${Xe.search}${Xe.hash}" `),Eh(ct==null||ct[ct.length-1].route.element!==void 0||ct[ct.length-1].route.Component!==void 0||ct[ct.length-1].route.lazy!==void 0,`Matched leaf route at location "${Xe.pathname}${Xe.search}${Xe.hash}" does not have an element or Component. This means it will render an <Outlet /> with a null value by default resulting in an "empty" page.`);let wt=i4(ct&&ct.map(Nt=>Object.assign({},Nt,{params:Object.assign({},s,Nt.params),pathname:fd([ne,A.encodeLocation?A.encodeLocation(Nt.pathname).pathname:Nt.pathname]),pathnameBase:Nt.pathnameBase==="/"?ne:fd([ne,A.encodeLocation?A.encodeLocation(Nt.pathnameBase).pathname:Nt.pathnameBase])})),z,m,E);return u&&wt?Ot.createElement(M_.Provider,{value:{location:{pathname:"/",search:"",hash:"",state:null,key:"default",...Xe},navigationType:"POP"}},wt):wt}function QA(){let x=a4(),u=GA(x)?`${x.status} ${x.statusText}`:x instanceof Error?x.message:JSON.stringify(x),m=x instanceof Error?x.stack:null,E="rgba(200,200,200, 0.5)",A={padding:"0.5rem",backgroundColor:E},z={padding:"2px 4px",backgroundColor:E},U=null;return console.error("Error handled by React Router default ErrorBoundary:",x),U=Ot.createElement(Ot.Fragment,null,Ot.createElement("p",null,"💿 Hey developer 👋"),Ot.createElement("p",null,"You can provide a way better UX than this when your app throws errors by providing your own ",Ot.createElement("code",{style:z},"ErrorBoundary")," or"," ",Ot.createElement("code",{style:z},"errorElement")," prop on your route.")),Ot.createElement(Ot.Fragment,null,Ot.createElement("h2",null,"Unexpected Application Error!"),Ot.createElement("h3",{style:{fontStyle:"italic"}},u),m?Ot.createElement("pre",{style:A},m):null,U)}var JA=Ot.createElement(QA,null),e4=class extends Ot.Component{constructor(x){super(x),this.state={location:x.location,revalidation:x.revalidation,error:x.error}}static getDerivedStateFromError(x){return{error:x}}static getDerivedStateFromProps(x,u){return u.location!==x.location||u.revalidation!=="idle"&&x.revalidation==="idle"?{error:x.error,location:x.location,revalidation:x.revalidation}:{error:x.error!==void 0?x.error:u.error,location:u.location,revalidation:x.revalidation||u.revalidation}}componentDidCatch(x,u){console.error("React Router caught the following error during render",x,u)}render(){return this.state.error!==void 0?Ot.createElement(Ch.Provider,{value:this.props.routeContext},Ot.createElement(bv.Provider,{value:this.state.error,children:this.props.component})):this.props.children}};function t4({routeContext:x,match:u,children:m}){let E=Ot.useContext(pm);return E&&E.static&&E.staticContext&&(u.route.errorElement||u.route.ErrorBoundary)&&(E.staticContext._deepestRenderedBoundaryId=u.route.id),Ot.createElement(Ch.Provider,{value:x},m)}function i4(x,u=[],m=null,E=null){if(x==null){if(!m)return null;if(m.errors)x=m.matches;else if(u.length===0&&!m.initialized&&m.matches.length>0)x=m.matches;else return null}let A=x,z=m?.errors;if(z!=null){let ee=A.findIndex(ne=>ne.route.id&&z?.[ne.route.id]!==void 0);so(ee>=0,`Could not find a matching route for errors on route IDs: ${Object.keys(z).join(",")}`),A=A.slice(0,Math.min(A.length,ee+1))}let U=!1,s=-1;if(m)for(let ee=0;ee<A.length;ee++){let ne=A[ee];if((ne.route.HydrateFallback||ne.route.hydrateFallbackElement)&&(s=ee),ne.route.id){let{loaderData:Ie,errors:qe}=m,Xe=ne.route.loader&&!Ie.hasOwnProperty(ne.route.id)&&(!qe||qe[ne.route.id]===void 0);if(ne.route.lazy||Xe){U=!0,s>=0?A=A.slice(0,s+1):A=[A[0]];break}}}return A.reduceRight((ee,ne,Ie)=>{let qe,Xe=!1,St=null,$t=null;m&&(qe=z&&ne.route.id?z[ne.route.id]:void 0,St=ne.route.errorElement||JA,U&&(s<0&&Ie===0?(uT("route-fallback",!1,"No `HydrateFallback` element provided to render during initial hydration"),Xe=!0,$t=null):s===Ie&&(Xe=!0,$t=ne.route.hydrateFallbackElement||null)));let ct=u.concat(A.slice(0,Ie+1)),wt=()=>{let Nt;return qe?Nt=St:Xe?Nt=$t:ne.route.Component?Nt=Ot.createElement(ne.route.Component,null):ne.route.element?Nt=ne.route.element:Nt=ee,Ot.createElement(t4,{match:ne,routeContext:{outlet:ee,matches:ct,isDataRoute:m!=null},children:Nt})};return m&&(ne.route.ErrorBoundary||ne.route.errorElement||Ie===0)?Ot.createElement(e4,{location:m.location,revalidation:m.revalidation,component:St,error:qe,children:wt(),routeContext:{outlet:null,matches:ct,isDataRoute:!0}}):wt()},null)}function Tv(x){return`${x} must be used within a data router.  See https://reactrouter.com/en/main/routers/picking-a-router.`}function n4(x){let u=Ot.useContext(pm);return so(u,Tv(x)),u}function r4(x){let u=Ot.useContext(ay);return so(u,Tv(x)),u}function s4(x){let u=Ot.useContext(Ch);return so(u,Tv(x)),u}function Ev(x){let u=s4(x),m=u.matches[u.matches.length-1];return so(m.route.id,`${x} can only be used on routes that contain a unique "id"`),m.route.id}function o4(){return Ev("useRouteId")}function a4(){let x=Ot.useContext(bv),u=r4("useRouteError"),m=Ev("useRouteError");return x!==void 0?x:u.errors?.[m]}function l4(){let{router:x}=n4("useNavigate"),u=Ev("useNavigate"),m=Ot.useRef(!1);return lT(()=>{m.current=!0}),Ot.useCallback(async(A,z={})=>{Eh(m.current,aT),m.current&&(typeof A=="number"?x.navigate(A):await x.navigate(A,{fromRouteId:u,...z}))},[x,u])}var Qb={};function uT(x,u,m){!u&&!Qb[x]&&(Qb[x]=!0,Eh(!1,m))}Ot.memo(c4);function c4({routes:x,future:u,state:m}){return cT(x,void 0,m,u)}function v_(x){so(!1,"A <Route> is only ever to be used as the child of <Routes> element, never rendered directly. Please wrap your <Route> in a <Routes>.")}function u4({basename:x="/",children:u=null,location:m,navigationType:E="POP",navigator:A,static:z=!1}){so(!D_(),"You cannot render a <Router> inside another <Router>. You should never have more than one in your app.");let U=x.replace(/^\/*/,"/"),s=Ot.useMemo(()=>({basename:U,navigator:A,static:z,future:{}}),[U,A,z]);typeof m=="string"&&(m=fm(m));let{pathname:ee="/",search:ne="",hash:Ie="",state:qe=null,key:Xe="default"}=m,St=Ot.useMemo(()=>{let $t=pd(ee,U);return $t==null?null:{location:{pathname:$t,search:ne,hash:Ie,state:qe,key:Xe},navigationType:E}},[U,ee,ne,Ie,qe,Xe,E]);return Eh(St!=null,`<Router basename="${U}"> is not able to match the URL "${ee}${ne}${Ie}" because it does not start with the basename, so the <Router> won't render anything.`),St==null?null:Ot.createElement(Ah.Provider,{value:s},Ot.createElement(M_.Provider,{children:u,value:St}))}function hT({children:x,location:u}){return YA(J0(x),u)}function J0(x,u=[]){let m=[];return Ot.Children.forEach(x,(E,A)=>{if(!Ot.isValidElement(E))return;let z=[...u,A];if(E.type===Ot.Fragment){m.push.apply(m,J0(E.props.children,z));return}so(E.type===v_,`[${typeof E.type=="string"?E.type:E.type.name}] is not a <Route> component. All component children of <Routes> must be a <Route> or <React.Fragment>`),so(!E.props.index||!E.props.children,"An index route cannot have child routes.");let U={id:E.props.id||z.join("-"),caseSensitive:E.props.caseSensitive,element:E.props.element,Component:E.props.Component,index:E.props.index,path:E.props.path,loader:E.props.loader,action:E.props.action,hydrateFallbackElement:E.props.hydrateFallbackElement,HydrateFallback:E.props.HydrateFallback,errorElement:E.props.errorElement,ErrorBoundary:E.props.ErrorBoundary,hasErrorBoundary:E.props.hasErrorBoundary===!0||E.props.ErrorBoundary!=null||E.props.errorElement!=null,shouldRevalidate:E.props.shouldRevalidate,handle:E.props.handle,lazy:E.props.lazy};E.props.children&&(U.children=J0(E.props.children,z)),m.push(U)}),m}var Vg="get",Ug="application/x-www-form-urlencoded";function ly(x){return x!=null&&typeof x.tagName=="string"}function h4(x){return ly(x)&&x.tagName.toLowerCase()==="button"}function d4(x){return ly(x)&&x.tagName.toLowerCase()==="form"}function f4(x){return ly(x)&&x.tagName.toLowerCase()==="input"}function p4(x){return!!(x.metaKey||x.altKey||x.ctrlKey||x.shiftKey)}function m4(x,u){return x.button===0&&(!u||u==="_self")&&!p4(x)}var Lg=null;function _4(){if(Lg===null)try{new FormData(document.createElement("form"),0),Lg=!1}catch{Lg=!0}return Lg}var g4=new Set(["application/x-www-form-urlencoded","multipart/form-data","text/plain"]);function U0(x){return x!=null&&!g4.has(x)?(Eh(!1,`"${x}" is not a valid \`encType\` for \`<Form>\`/\`<fetcher.Form>\` and will default to "${Ug}"`),null):x}function y4(x,u){let m,E,A,z,U;if(d4(x)){let s=x.getAttribute("action");E=s?pd(s,u):null,m=x.getAttribute("method")||Vg,A=U0(x.getAttribute("enctype"))||Ug,z=new FormData(x)}else if(h4(x)||f4(x)&&(x.type==="submit"||x.type==="image")){let s=x.form;if(s==null)throw new Error('Cannot submit a <button> or <input type="submit"> without a <form>');let ee=x.getAttribute("formaction")||s.getAttribute("action");if(E=ee?pd(ee,u):null,m=x.getAttribute("formmethod")||s.getAttribute("method")||Vg,A=U0(x.getAttribute("formenctype"))||U0(s.getAttribute("enctype"))||Ug,z=new FormData(s,x),!_4()){let{name:ne,type:Ie,value:qe}=x;if(Ie==="image"){let Xe=ne?`${ne}.`:"";z.append(`${Xe}x`,"0"),z.append(`${Xe}y`,"0")}else ne&&z.append(ne,qe)}}else{if(ly(x))throw new Error('Cannot submit element that is not <form>, <button>, or <input type="submit|image">');m=Vg,E=null,A=Ug,U=x}return z&&A==="text/plain"&&(U=z,z=void 0),{action:E,method:m.toLowerCase(),encType:A,formData:z,body:U}}Object.getOwnPropertyNames(Object.prototype).sort().join("\0");function Sv(x,u){if(x===!1||x===null||typeof x>"u")throw new Error(u)}function v4(x,u,m){let E=typeof x=="string"?new URL(x,typeof window>"u"?"server://singlefetch/":window.location.origin):x;return E.pathname==="/"?E.pathname=`_root.${m}`:u&&pd(E.pathname,u)==="/"?E.pathname=`${u.replace(/\/$/,"")}/_root.${m}`:E.pathname=`${E.pathname.replace(/\/$/,"")}.${m}`,E}async function x4(x,u){if(x.id in u)return u[x.id];try{let m=await import(x.module);return u[x.id]=m,m}catch(m){return console.error(`Error loading route module \`${x.module}\`, reloading page...`),console.error(m),window.__reactRouterContext&&window.__reactRouterContext.isSpaMode,window.location.reload(),new Promise(()=>{})}}function w4(x){return x==null?!1:x.href==null?x.rel==="preload"&&typeof x.imageSrcSet=="string"&&typeof x.imageSizes=="string":typeof x.rel=="string"&&typeof x.href=="string"}async function b4(x,u,m){let E=await Promise.all(x.map(async A=>{let z=u.routes[A.route.id];if(z){let U=await x4(z,m);return U.links?U.links():[]}return[]}));return I4(E.flat(1).filter(w4).filter(A=>A.rel==="stylesheet"||A.rel==="preload").map(A=>A.rel==="stylesheet"?{...A,rel:"prefetch",as:"style"}:{...A,rel:"prefetch"}))}function Jb(x,u,m,E,A,z){let U=(ee,ne)=>m[ne]?ee.route.id!==m[ne].route.id:!0,s=(ee,ne)=>m[ne].pathname!==ee.pathname||m[ne].route.path?.endsWith("*")&&m[ne].params["*"]!==ee.params["*"];return z==="assets"?u.filter((ee,ne)=>U(ee,ne)||s(ee,ne)):z==="data"?u.filter((ee,ne)=>{let Ie=E.routes[ee.route.id];if(!Ie||!Ie.hasLoader)return!1;if(U(ee,ne)||s(ee,ne))return!0;if(ee.route.shouldRevalidate){let qe=ee.route.shouldRevalidate({currentUrl:new URL(A.pathname+A.search+A.hash,window.origin),currentParams:m[0]?.params||{},nextUrl:new URL(x,window.origin),nextParams:ee.params,defaultShouldRevalidate:!0});if(typeof qe=="boolean")return qe}return!0}):[]}function T4(x,u,{includeHydrateFallback:m}={}){return E4(x.map(E=>{let A=u.routes[E.route.id];if(!A)return[];let z=[A.module];return A.clientActionModule&&(z=z.concat(A.clientActionModule)),A.clientLoaderModule&&(z=z.concat(A.clientLoaderModule)),m&&A.hydrateFallbackModule&&(z=z.concat(A.hydrateFallbackModule)),A.imports&&(z=z.concat(A.imports)),z}).flat(1))}function E4(x){return[...new Set(x)]}function S4(x){let u={},m=Object.keys(x).sort();for(let E of m)u[E]=x[E];return u}function I4(x,u){let m=new Set;return new Set(u),x.reduce((E,A)=>{let z=JSON.stringify(S4(A));return m.has(z)||(m.add(z),E.push({key:z,link:A})),E},[])}function dT(){let x=Ot.useContext(pm);return Sv(x,"You must render this element inside a <DataRouterContext.Provider> element"),x}function A4(){let x=Ot.useContext(ay);return Sv(x,"You must render this element inside a <DataRouterStateContext.Provider> element"),x}var Iv=Ot.createContext(void 0);Iv.displayName="FrameworkContext";function fT(){let x=Ot.useContext(Iv);return Sv(x,"You must render this element inside a <HydratedRouter> element"),x}function C4(x,u){let m=Ot.useContext(Iv),[E,A]=Ot.useState(!1),[z,U]=Ot.useState(!1),{onFocus:s,onBlur:ee,onMouseEnter:ne,onMouseLeave:Ie,onTouchStart:qe}=u,Xe=Ot.useRef(null);Ot.useEffect(()=>{if(x==="render"&&U(!0),x==="viewport"){let ct=Nt=>{Nt.forEach(Ti=>{U(Ti.isIntersecting)})},wt=new IntersectionObserver(ct,{threshold:.5});return Xe.current&&wt.observe(Xe.current),()=>{wt.disconnect()}}},[x]),Ot.useEffect(()=>{if(E){let ct=setTimeout(()=>{U(!0)},100);return()=>{clearTimeout(ct)}}},[E]);let St=()=>{A(!0)},$t=()=>{A(!1),U(!1)};return m?x!=="intent"?[z,Xe,{}]:[z,Xe,{onFocus:l_(s,St),onBlur:l_(ee,$t),onMouseEnter:l_(ne,St),onMouseLeave:l_(Ie,$t),onTouchStart:l_(qe,St)}]:[!1,Xe,{}]}function l_(x,u){return m=>{x&&x(m),m.defaultPrevented||u(m)}}function P4({page:x,...u}){let{router:m}=dT(),E=Ot.useMemo(()=>eT(m.routes,x,m.basename),[m.routes,x,m.basename]);return E?Ot.createElement(M4,{page:x,matches:E,...u}):null}function R4(x){let{manifest:u,routeModules:m}=fT(),[E,A]=Ot.useState([]);return Ot.useEffect(()=>{let z=!1;return b4(x,u,m).then(U=>{z||A(U)}),()=>{z=!0}},[x,u,m]),E}function M4({page:x,matches:u,...m}){let E=xp(),{manifest:A,routeModules:z}=fT(),{basename:U}=dT(),{loaderData:s,matches:ee}=A4(),ne=Ot.useMemo(()=>Jb(x,u,ee,A,E,"data"),[x,u,ee,A,E]),Ie=Ot.useMemo(()=>Jb(x,u,ee,A,E,"assets"),[x,u,ee,A,E]),qe=Ot.useMemo(()=>{if(x===E.pathname+E.search+E.hash)return[];let $t=new Set,ct=!1;if(u.forEach(Nt=>{let Ti=A.routes[Nt.route.id];!Ti||!Ti.hasLoader||(!ne.some(Ei=>Ei.route.id===Nt.route.id)&&Nt.route.id in s&&z[Nt.route.id]?.shouldRevalidate||Ti.hasClientLoader?ct=!0:$t.add(Nt.route.id))}),$t.size===0)return[];let wt=v4(x,U,"data");return ct&&$t.size>0&&wt.searchParams.set("_routes",u.filter(Nt=>$t.has(Nt.route.id)).map(Nt=>Nt.route.id).join(",")),[wt.pathname+wt.search]},[U,s,E,A,ne,u,x,z]),Xe=Ot.useMemo(()=>T4(Ie,A),[Ie,A]),St=R4(Ie);return Ot.createElement(Ot.Fragment,null,qe.map($t=>Ot.createElement("link",{key:$t,rel:"prefetch",as:"fetch",href:$t,...m})),Xe.map($t=>Ot.createElement("link",{key:$t,rel:"modulepreload",href:$t,...m})),St.map(({key:$t,link:ct})=>Ot.createElement("link",{key:$t,nonce:m.nonce,...ct})))}function D4(...x){return u=>{x.forEach(m=>{typeof m=="function"?m(u):m!=null&&(m.current=u)})}}var pT=typeof window<"u"&&typeof window.document<"u"&&typeof window.document.createElement<"u";try{pT&&(window.__reactRouterVersion="7.8.1")}catch{}function L4({basename:x,children:u,window:m}){let E=Ot.useRef();E.current==null&&(E.current=xA({window:m,v5Compat:!0}));let A=E.current,[z,U]=Ot.useState({action:A.action,location:A.location}),s=Ot.useCallback(ee=>{Ot.startTransition(()=>U(ee))},[U]);return Ot.useLayoutEffect(()=>A.listen(s),[A,s]),Ot.createElement(u4,{basename:x,children:u,location:z.location,navigationType:z.action,navigator:A})}var mT=/^(?:[a-z][a-z0-9+.-]*:|\/\/)/i,_T=Ot.forwardRef(function({onClick:u,discover:m="render",prefetch:E="none",relative:A,reloadDocument:z,replace:U,state:s,target:ee,to:ne,preventScrollReset:Ie,viewTransition:qe,...Xe},St){let{basename:$t}=Ot.useContext(Ah),ct=typeof ne=="string"&&mT.test(ne),wt,Nt=!1;if(typeof ne=="string"&&ct&&(wt=ne,pT))try{let je=new URL(window.location.href),Ke=ne.startsWith("//")?new URL(je.protocol+ne):new URL(ne),We=pd(Ke.pathname,$t);Ke.origin===je.origin&&We!=null?ne=We+Ke.search+Ke.hash:Nt=!0}catch{Eh(!1,`<Link to="${ne}"> contains an invalid URL which will probably break when clicked - please update to a valid URL path.`)}let Ti=WA(ne,{relative:A}),[Ei,en,Hn]=C4(E,Xe),_n=O4(ne,{replace:U,state:s,target:ee,preventScrollReset:Ie,relative:A,viewTransition:qe});function rt(je){u&&u(je),je.defaultPrevented||_n(je)}let De=Ot.createElement("a",{...Xe,...Hn,href:wt||Ti,onClick:Nt||z?u:rt,ref:D4(St,en),target:ee,"data-discover":!ct&&m==="render"?"true":void 0});return Ei&&!ct?Ot.createElement(Ot.Fragment,null,De,Ot.createElement(P4,{page:Ti})):De});_T.displayName="Link";var k4=Ot.forwardRef(function({"aria-current":u="page",caseSensitive:m=!1,className:E="",end:A=!1,style:z,to:U,viewTransition:s,children:ee,...ne},Ie){let qe=L_(U,{relative:ne.relative}),Xe=xp(),St=Ot.useContext(ay),{navigator:$t,basename:ct}=Ot.useContext(Ah),wt=St!=null&&j4(qe)&&s===!0,Nt=$t.encodeLocation?$t.encodeLocation(qe).pathname:qe.pathname,Ti=Xe.pathname,Ei=St&&St.navigation&&St.navigation.location?St.navigation.location.pathname:null;m||(Ti=Ti.toLowerCase(),Ei=Ei?Ei.toLowerCase():null,Nt=Nt.toLowerCase()),Ei&&ct&&(Ei=pd(Ei,ct)||Ei);const en=Nt!=="/"&&Nt.endsWith("/")?Nt.length-1:Nt.length;let Hn=Ti===Nt||!A&&Ti.startsWith(Nt)&&Ti.charAt(en)==="/",_n=Ei!=null&&(Ei===Nt||!A&&Ei.startsWith(Nt)&&Ei.charAt(Nt.length)==="/"),rt={isActive:Hn,isPending:_n,isTransitioning:wt},De=Hn?u:void 0,je;typeof E=="function"?je=E(rt):je=[E,Hn?"active":null,_n?"pending":null,wt?"transitioning":null].filter(Boolean).join(" ");let Ke=typeof z=="function"?z(rt):z;return Ot.createElement(_T,{...ne,"aria-current":De,className:je,ref:Ie,style:Ke,to:U,viewTransition:s},typeof ee=="function"?ee(rt):ee)});k4.displayName="NavLink";var z4=Ot.forwardRef(({discover:x="render",fetcherKey:u,navigate:m,reloadDocument:E,replace:A,state:z,method:U=Vg,action:s,onSubmit:ee,relative:ne,preventScrollReset:Ie,viewTransition:qe,...Xe},St)=>{let $t=V4(),ct=U4(s,{relative:ne}),wt=U.toLowerCase()==="get"?"get":"post",Nt=typeof s=="string"&&mT.test(s),Ti=Ei=>{if(ee&&ee(Ei),Ei.defaultPrevented)return;Ei.preventDefault();let en=Ei.nativeEvent.submitter,Hn=en?.getAttribute("formmethod")||U;$t(en||Ei.currentTarget,{fetcherKey:u,method:Hn,navigate:m,replace:A,state:z,relative:ne,preventScrollReset:Ie,viewTransition:qe})};return Ot.createElement("form",{ref:St,method:wt,action:ct,onSubmit:E?ee:Ti,...Xe,"data-discover":!Nt&&x==="render"?"true":void 0})});z4.displayName="Form";function F4(x){return`${x} must be used within a data router.  See https://reactrouter.com/en/main/routers/picking-a-router.`}function gT(x){let u=Ot.useContext(pm);return so(u,F4(x)),u}function O4(x,{target:u,replace:m,state:E,preventScrollReset:A,relative:z,viewTransition:U}={}){let s=ZA(),ee=xp(),ne=L_(x,{relative:z});return Ot.useCallback(Ie=>{if(m4(Ie,u)){Ie.preventDefault();let qe=m!==void 0?m:y_(ee)===y_(ne);s(x,{replace:qe,state:E,preventScrollReset:A,relative:z,viewTransition:U})}},[ee,s,ne,m,E,u,x,A,z,U])}var B4=0,N4=()=>`__${String(++B4)}__`;function V4(){let{router:x}=gT("useSubmit"),{basename:u}=Ot.useContext(Ah),m=o4();return Ot.useCallback(async(E,A={})=>{let{action:z,method:U,encType:s,formData:ee,body:ne}=y4(E,u);if(A.navigate===!1){let Ie=A.fetcherKey||N4();await x.fetch(Ie,m,A.action||z,{preventScrollReset:A.preventScrollReset,formData:ee,body:ne,formMethod:A.method||U,formEncType:A.encType||s,flushSync:A.flushSync})}else await x.navigate(A.action||z,{preventScrollReset:A.preventScrollReset,formData:ee,body:ne,formMethod:A.method||U,formEncType:A.encType||s,replace:A.replace,state:A.state,fromRouteId:m,flushSync:A.flushSync,viewTransition:A.viewTransition})},[x,u,m])}function U4(x,{relative:u}={}){let{basename:m}=Ot.useContext(Ah),E=Ot.useContext(Ch);so(E,"useFormAction must be used inside a RouteContext");let[A]=E.matches.slice(-1),z={...L_(x||".",{relative:u})},U=xp();if(x==null){z.search=U.search;let s=new URLSearchParams(z.search),ee=s.getAll("index");if(ee.some(Ie=>Ie==="")){s.delete("index"),ee.filter(qe=>qe).forEach(qe=>s.append("index",qe));let Ie=s.toString();z.search=Ie?`?${Ie}`:""}}return(!x||x===".")&&A.route.index&&(z.search=z.search?z.search.replace(/^\?/,"?index&"):"?index"),m!=="/"&&(z.pathname=z.pathname==="/"?m:fd([m,z.pathname])),y_(z)}function j4(x,{relative:u}={}){let m=Ot.useContext(oT);so(m!=null,"`useViewTransitionState` must be used within `react-router-dom`'s `RouterProvider`.  Did you accidentally import `RouterProvider` from `react-router`?");let{basename:E}=gT("useViewTransitionState"),A=L_(x,{relative:u});if(!m.isTransitioning)return!1;let z=pd(m.currentLocation.pathname,E)||m.currentLocation.pathname,U=pd(m.nextLocation.pathname,E)||m.nextLocation.pathname;return Zg(A.pathname,U)!=null||Zg(A.pathname,z)!=null}var jg={exports:{}},G4=jg.exports,e2;function H4(){return e2||(e2=1,(function(x,u){(function(m,E){x.exports=E()})(G4,(function(){var m,E,A;function z(s,ee){if(!m)m=ee;else if(!E)E=ee;else{var ne="self.onerror = function() { console.error('An error occurred while parsing the WebWorker bundle. This is most likely due to improper transpilation by Babel; please see https://docs.mapbox.com/mapbox-gl-js/guides/install/#transpiling'); }; var sharedChunk = {}; ("+m+")(sharedChunk); ("+E+")(sharedChunk); self.onerror = null;",Ie={};m(Ie),A=ee(Ie),typeof window<"u"&&window&&window.URL&&window.URL.createObjectURL&&(A.workerUrl=window.URL.createObjectURL(new Blob([ne],{type:"text/javascript"})))}}z(["exports"],(function(s){var ee=1e-6,ne=typeof Float32Array<"u"?Float32Array:Array;function Ie(n,e){var i=e[0],o=e[1],a=e[2],h=e[3],d=i*h-a*o;return d?(n[0]=h*(d=1/d),n[1]=-o*d,n[2]=-a*d,n[3]=i*d,n):null}function qe(){var n=new ne(9);return ne!=Float32Array&&(n[1]=0,n[2]=0,n[3]=0,n[5]=0,n[6]=0,n[7]=0),n[0]=1,n[4]=1,n[8]=1,n}function Xe(n,e){var i=e[0],o=e[1],a=e[2],h=e[3],d=e[4],y=e[5],w=e[6],T=e[7],C=e[8];return n[0]=d*C-y*T,n[1]=a*T-o*C,n[2]=o*y-a*d,n[3]=y*w-h*C,n[4]=i*C-a*w,n[5]=a*h-i*y,n[6]=h*T-d*w,n[7]=o*w-i*T,n[8]=i*d-o*h,n}function St(n,e,i){var o=e[0],a=e[1],h=e[2],d=e[3],y=e[4],w=e[5],T=e[6],C=e[7],P=e[8],D=i[0],O=i[1],N=i[2],G=i[3],q=i[4],Y=i[5],se=i[6],re=i[7],ae=i[8];return n[0]=D*o+O*d+N*T,n[1]=D*a+O*y+N*C,n[2]=D*h+O*w+N*P,n[3]=G*o+q*d+Y*T,n[4]=G*a+q*y+Y*C,n[5]=G*h+q*w+Y*P,n[6]=se*o+re*d+ae*T,n[7]=se*a+re*y+ae*C,n[8]=se*h+re*w+ae*P,n}function $t(){var n=new ne(16);return ne!=Float32Array&&(n[1]=0,n[2]=0,n[3]=0,n[4]=0,n[6]=0,n[7]=0,n[8]=0,n[9]=0,n[11]=0,n[12]=0,n[13]=0,n[14]=0),n[0]=1,n[5]=1,n[10]=1,n[15]=1,n}function ct(n){return n[0]=1,n[1]=0,n[2]=0,n[3]=0,n[4]=0,n[5]=1,n[6]=0,n[7]=0,n[8]=0,n[9]=0,n[10]=1,n[11]=0,n[12]=0,n[13]=0,n[14]=0,n[15]=1,n}function wt(n,e){var i=e[0],o=e[1],a=e[2],h=e[3],d=e[4],y=e[5],w=e[6],T=e[7],C=e[8],P=e[9],D=e[10],O=e[11],N=e[12],G=e[13],q=e[14],Y=e[15],se=i*y-o*d,re=i*w-a*d,ae=i*T-h*d,Ee=o*w-a*y,ve=o*T-h*y,xe=a*T-h*w,Pe=C*G-P*N,Me=C*q-D*N,it=C*Y-O*N,Fe=P*q-D*G,ot=P*Y-O*G,Dt=D*Y-O*q,ht=se*Dt-re*ot+ae*Fe+Ee*it-ve*Me+xe*Pe;return ht?(n[0]=(y*Dt-w*ot+T*Fe)*(ht=1/ht),n[1]=(a*ot-o*Dt-h*Fe)*ht,n[2]=(G*xe-q*ve+Y*Ee)*ht,n[3]=(D*ve-P*xe-O*Ee)*ht,n[4]=(w*it-d*Dt-T*Me)*ht,n[5]=(i*Dt-a*it+h*Me)*ht,n[6]=(q*ae-N*xe-Y*re)*ht,n[7]=(C*xe-D*ae+O*re)*ht,n[8]=(d*ot-y*it+T*Pe)*ht,n[9]=(o*it-i*ot-h*Pe)*ht,n[10]=(N*ve-G*ae+Y*se)*ht,n[11]=(P*ae-C*ve-O*se)*ht,n[12]=(y*Me-d*Fe-w*Pe)*ht,n[13]=(i*Fe-o*Me+a*Pe)*ht,n[14]=(G*re-N*Ee-q*se)*ht,n[15]=(C*Ee-P*re+D*se)*ht,n):null}function Nt(n,e,i){var o=e[0],a=e[1],h=e[2],d=e[3],y=e[4],w=e[5],T=e[6],C=e[7],P=e[8],D=e[9],O=e[10],N=e[11],G=e[12],q=e[13],Y=e[14],se=e[15],re=i[0],ae=i[1],Ee=i[2],ve=i[3];return n[0]=re*o+ae*y+Ee*P+ve*G,n[1]=re*a+ae*w+Ee*D+ve*q,n[2]=re*h+ae*T+Ee*O+ve*Y,n[3]=re*d+ae*C+Ee*N+ve*se,n[4]=(re=i[4])*o+(ae=i[5])*y+(Ee=i[6])*P+(ve=i[7])*G,n[5]=re*a+ae*w+Ee*D+ve*q,n[6]=re*h+ae*T+Ee*O+ve*Y,n[7]=re*d+ae*C+Ee*N+ve*se,n[8]=(re=i[8])*o+(ae=i[9])*y+(Ee=i[10])*P+(ve=i[11])*G,n[9]=re*a+ae*w+Ee*D+ve*q,n[10]=re*h+ae*T+Ee*O+ve*Y,n[11]=re*d+ae*C+Ee*N+ve*se,n[12]=(re=i[12])*o+(ae=i[13])*y+(Ee=i[14])*P+(ve=i[15])*G,n[13]=re*a+ae*w+Ee*D+ve*q,n[14]=re*h+ae*T+Ee*O+ve*Y,n[15]=re*d+ae*C+Ee*N+ve*se,n}function Ti(n,e,i){var o,a,h,d,y,w,T,C,P,D,O,N,G=i[0],q=i[1],Y=i[2];return e===n?(n[12]=e[0]*G+e[4]*q+e[8]*Y+e[12],n[13]=e[1]*G+e[5]*q+e[9]*Y+e[13],n[14]=e[2]*G+e[6]*q+e[10]*Y+e[14],n[15]=e[3]*G+e[7]*q+e[11]*Y+e[15]):(a=e[1],h=e[2],d=e[3],y=e[4],w=e[5],T=e[6],C=e[7],P=e[8],D=e[9],O=e[10],N=e[11],n[0]=o=e[0],n[1]=a,n[2]=h,n[3]=d,n[4]=y,n[5]=w,n[6]=T,n[7]=C,n[8]=P,n[9]=D,n[10]=O,n[11]=N,n[12]=o*G+y*q+P*Y+e[12],n[13]=a*G+w*q+D*Y+e[13],n[14]=h*G+T*q+O*Y+e[14],n[15]=d*G+C*q+N*Y+e[15]),n}function Ei(n,e,i){var o=i[0],a=i[1],h=i[2];return n[0]=e[0]*o,n[1]=e[1]*o,n[2]=e[2]*o,n[3]=e[3]*o,n[4]=e[4]*a,n[5]=e[5]*a,n[6]=e[6]*a,n[7]=e[7]*a,n[8]=e[8]*h,n[9]=e[9]*h,n[10]=e[10]*h,n[11]=e[11]*h,n[12]=e[12],n[13]=e[13],n[14]=e[14],n[15]=e[15],n}function en(n,e,i){var o=Math.sin(i),a=Math.cos(i),h=e[4],d=e[5],y=e[6],w=e[7],T=e[8],C=e[9],P=e[10],D=e[11];return e!==n&&(n[0]=e[0],n[1]=e[1],n[2]=e[2],n[3]=e[3],n[12]=e[12],n[13]=e[13],n[14]=e[14],n[15]=e[15]),n[4]=h*a+T*o,n[5]=d*a+C*o,n[6]=y*a+P*o,n[7]=w*a+D*o,n[8]=T*a-h*o,n[9]=C*a-d*o,n[10]=P*a-y*o,n[11]=D*a-w*o,n}function Hn(n,e,i){var o=Math.sin(i),a=Math.cos(i),h=e[0],d=e[1],y=e[2],w=e[3],T=e[8],C=e[9],P=e[10],D=e[11];return e!==n&&(n[4]=e[4],n[5]=e[5],n[6]=e[6],n[7]=e[7],n[12]=e[12],n[13]=e[13],n[14]=e[14],n[15]=e[15]),n[0]=h*a-T*o,n[1]=d*a-C*o,n[2]=y*a-P*o,n[3]=w*a-D*o,n[8]=h*o+T*a,n[9]=d*o+C*a,n[10]=y*o+P*a,n[11]=w*o+D*a,n}function _n(n,e,i){var o=Math.sin(i),a=Math.cos(i),h=e[0],d=e[1],y=e[2],w=e[3],T=e[4],C=e[5],P=e[6],D=e[7];return e!==n&&(n[8]=e[8],n[9]=e[9],n[10]=e[10],n[11]=e[11],n[12]=e[12],n[13]=e[13],n[14]=e[14],n[15]=e[15]),n[0]=h*a+T*o,n[1]=d*a+C*o,n[2]=y*a+P*o,n[3]=w*a+D*o,n[4]=T*a-h*o,n[5]=C*a-d*o,n[6]=P*a-y*o,n[7]=D*a-w*o,n}function rt(n,e){return n[0]=e[0],n[1]=0,n[2]=0,n[3]=0,n[4]=0,n[5]=e[1],n[6]=0,n[7]=0,n[8]=0,n[9]=0,n[10]=e[2],n[11]=0,n[12]=0,n[13]=0,n[14]=0,n[15]=1,n}function De(n,e,i){var o,a,h,d=i[0],y=i[1],w=i[2],T=Math.hypot(d,y,w);return T<ee?null:(d*=T=1/T,y*=T,w*=T,o=Math.sin(e),a=Math.cos(e),n[0]=d*d*(h=1-a)+a,n[1]=y*d*h+w*o,n[2]=w*d*h-y*o,n[3]=0,n[4]=d*y*h-w*o,n[5]=y*y*h+a,n[6]=w*y*h+d*o,n[7]=0,n[8]=d*w*h+y*o,n[9]=y*w*h-d*o,n[10]=w*w*h+a,n[11]=0,n[12]=0,n[13]=0,n[14]=0,n[15]=1,n)}function je(n,e){var i=e[0],o=e[1],a=e[2],h=e[3],d=i+i,y=o+o,w=a+a,T=i*d,C=o*d,P=o*y,D=a*d,O=a*y,N=a*w,G=h*d,q=h*y,Y=h*w;return n[0]=1-P-N,n[1]=C+Y,n[2]=D-q,n[3]=0,n[4]=C-Y,n[5]=1-T-N,n[6]=O+G,n[7]=0,n[8]=D+q,n[9]=O-G,n[10]=1-T-P,n[11]=0,n[12]=0,n[13]=0,n[14]=0,n[15]=1,n}Math.hypot||(Math.hypot=function(){for(var n=0,e=arguments.length;e--;)n+=arguments[e]*arguments[e];return Math.sqrt(n)});var Ke=Nt;function We(){var n=new ne(3);return ne!=Float32Array&&(n[0]=0,n[1]=0,n[2]=0),n}function ut(n){var e=new ne(3);return e[0]=n[0],e[1]=n[1],e[2]=n[2],e}function Oe(n){return Math.hypot(n[0],n[1],n[2])}function kn(n,e,i){var o=new ne(3);return o[0]=n,o[1]=e,o[2]=i,o}function $n(n,e,i,o){return n[0]=e,n[1]=i,n[2]=o,n}function wn(n,e,i){return n[0]=e[0]+i[0],n[1]=e[1]+i[1],n[2]=e[2]+i[2],n}function Gn(n,e,i){return n[0]=e[0]-i[0],n[1]=e[1]-i[1],n[2]=e[2]-i[2],n}function wi(n,e,i){return n[0]=e[0]*i[0],n[1]=e[1]*i[1],n[2]=e[2]*i[2],n}function Ui(n,e,i){return n[0]=Math.min(e[0],i[0]),n[1]=Math.min(e[1],i[1]),n[2]=Math.min(e[2],i[2]),n}function Ai(n,e,i){return n[0]=Math.max(e[0],i[0]),n[1]=Math.max(e[1],i[1]),n[2]=Math.max(e[2],i[2]),n}function Qe(n,e,i){return n[0]=e[0]*i,n[1]=e[1]*i,n[2]=e[2]*i,n}function Gt(n,e,i,o){return n[0]=e[0]+i[0]*o,n[1]=e[1]+i[1]*o,n[2]=e[2]+i[2]*o,n}function ji(n,e){var i=e[0]-n[0],o=e[1]-n[1],a=e[2]-n[2];return i*i+o*o+a*a}function Un(n){var e=n[0],i=n[1],o=n[2];return e*e+i*i+o*o}function zn(n,e){return n[0]=-e[0],n[1]=-e[1],n[2]=-e[2],n}function zi(n,e){var i=e[0],o=e[1],a=e[2],h=i*i+o*o+a*a;return h>0&&(h=1/Math.sqrt(h)),n[0]=e[0]*h,n[1]=e[1]*h,n[2]=e[2]*h,n}function Ji(n,e){return n[0]*e[0]+n[1]*e[1]+n[2]*e[2]}function on(n,e,i){var o=e[0],a=e[1],h=e[2],d=i[0],y=i[1],w=i[2];return n[0]=a*w-h*y,n[1]=h*d-o*w,n[2]=o*y-a*d,n}function er(n,e,i,o){var a=e[0],h=e[1],d=e[2];return n[0]=a+o*(i[0]-a),n[1]=h+o*(i[1]-h),n[2]=d+o*(i[2]-d),n}function Pn(n,e,i){var o=e[0],a=e[1],h=e[2],d=i[3]*o+i[7]*a+i[11]*h+i[15];return n[0]=(i[0]*o+i[4]*a+i[8]*h+i[12])/(d=d||1),n[1]=(i[1]*o+i[5]*a+i[9]*h+i[13])/d,n[2]=(i[2]*o+i[6]*a+i[10]*h+i[14])/d,n}function ao(n,e,i){var o=e[0],a=e[1],h=e[2];return n[0]=o*i[0]+a*i[3]+h*i[6],n[1]=o*i[1]+a*i[4]+h*i[7],n[2]=o*i[2]+a*i[5]+h*i[8],n}function Bo(n,e,i){var o=i[0],a=i[1],h=i[2],d=e[0],y=e[1],w=e[2],T=a*w-h*y,C=h*d-o*w,P=o*y-a*d,D=a*P-h*C,O=h*T-o*P,N=o*C-a*T,G=2*i[3];return C*=G,P*=G,O*=2,N*=2,n[0]=d+(T*=G)+(D*=2),n[1]=y+C+O,n[2]=w+P+N,n}function Yo(n){return n[0]=0,n[1]=0,n[2]=0,n}function Bs(n,e){return n[0]===e[0]&&n[1]===e[1]&&n[2]===e[2]}var Ut=Gn,Di=wi,cn=Oe;function wr(){var n=new ne(4);return ne!=Float32Array&&(n[0]=0,n[1]=0,n[2]=0,n[3]=0),n}function Zn(n,e,i){return n[0]=e[0]*i,n[1]=e[1]*i,n[2]=e[2]*i,n[3]=e[3]*i,n}function fr(n,e){var i=e[0],o=e[1],a=e[2],h=e[3],d=i*i+o*o+a*a+h*h;return d>0&&(d=1/Math.sqrt(d)),n[0]=i*d,n[1]=o*d,n[2]=a*d,n[3]=h*d,n}function Rn(n,e,i){var o=e[0],a=e[1],h=e[2],d=e[3];return n[0]=i[0]*o+i[4]*a+i[8]*h+i[12]*d,n[1]=i[1]*o+i[5]*a+i[9]*h+i[13]*d,n[2]=i[2]*o+i[6]*a+i[10]*h+i[14]*d,n[3]=i[3]*o+i[7]*a+i[11]*h+i[15]*d,n}function ar(){var n=new ne(4);return ne!=Float32Array&&(n[0]=0,n[1]=0,n[2]=0),n[3]=1,n}function vs(n){return n[0]=0,n[1]=0,n[2]=0,n[3]=1,n}function Qo(n,e,i){i*=.5;var o=e[0],a=e[1],h=e[2],d=e[3],y=Math.sin(i),w=Math.cos(i);return n[0]=o*w+d*y,n[1]=a*w+h*y,n[2]=h*w-a*y,n[3]=d*w-o*y,n}function Fa(n,e,i){i*=.5;var o=e[0],a=e[1],h=e[2],d=e[3],y=Math.sin(i),w=Math.cos(i);return n[0]=o*w-h*y,n[1]=a*w+d*y,n[2]=h*w+o*y,n[3]=d*w-a*y,n}We(),wr();var Sr,Lr,da,fa=fr,pa=(Sr=We(),Lr=kn(1,0,0),da=kn(0,1,0),function(n,e,i){var o=Ji(e,i);return o<-.999999?(on(Sr,Lr,e),cn(Sr)<1e-6&&on(Sr,da,e),zi(Sr,Sr),(function(a,h,d){d*=.5;var y=Math.sin(d);a[0]=y*h[0],a[1]=y*h[1],a[2]=y*h[2],a[3]=Math.cos(d)})(n,Sr,Math.PI),n):o>.999999?(n[0]=0,n[1]=0,n[2]=0,n[3]=1,n):(on(Sr,e,i),n[0]=Sr[0],n[1]=Sr[1],n[2]=Sr[2],n[3]=1+o,fa(n,n))});function xs(){var n=new ne(2);return ne!=Float32Array&&(n[0]=0,n[1]=0),n}function Xs(n,e){var i=new ne(2);return i[0]=n,i[1]=e,i}function Oa(n,e,i){return n[0]=e[0]+i[0],n[1]=e[1]+i[1],n}function ma(n,e,i){return n[0]=e[0]-i[0],n[1]=e[1]-i[1],n}function Ba(n,e,i){return n[0]=e[0]*i,n[1]=e[1]*i,n}function Na(n){return Math.hypot(n[0],n[1])}function Rl(n,e){var i=e[0],o=e[1],a=i*i+o*o;return a>0&&(a=1/Math.sqrt(a)),n[0]=e[0]*a,n[1]=e[1]*a,n}function nr(n,e){return n[0]*e[0]+n[1]*e[1]}ar(),ar(),qe();var Ml,Dl,gs=ma;function Jo(n){return n&&n.__esModule&&Object.prototype.hasOwnProperty.call(n,"default")?n.default:n}xs();var Ac=(function(){if(Dl)return Ml;function n(e,i,o,a){this.cx=3*e,this.bx=3*(o-e)-this.cx,this.ax=1-this.cx-this.bx,this.cy=3*i,this.by=3*(a-i)-this.cy,this.ay=1-this.cy-this.by,this.p1x=e,this.p1y=i,this.p2x=o,this.p2y=a}return Dl=1,Ml=n,n.prototype={sampleCurveX:function(e){return((this.ax*e+this.bx)*e+this.cx)*e},sampleCurveY:function(e){return((this.ay*e+this.by)*e+this.cy)*e},sampleCurveDerivativeX:function(e){return(3*this.ax*e+2*this.bx)*e+this.cx},solveCurveX:function(e,i){if(i===void 0&&(i=1e-6),e<0)return 0;if(e>1)return 1;for(var o=e,a=0;a<8;a++){var h=this.sampleCurveX(o)-e;if(Math.abs(h)<i)return o;var d=this.sampleCurveDerivativeX(o);if(Math.abs(d)<1e-6)break;o-=h/d}var y=0,w=1;for(o=e,a=0;a<20&&(h=this.sampleCurveX(o),!(Math.abs(h-e)<i));a++)e>h?y=o:w=o,o=.5*(w-y)+y;return o},solve:function(e,i){return this.sampleCurveY(this.solveCurveX(e,i))}},Ml})(),No=Jo(Ac);function gt(n,e){this.x=n,this.y=e}function Vo(n,e){if(Array.isArray(n)){if(!Array.isArray(e)||n.length!==e.length)return!1;for(let i=0;i<n.length;i++)if(!Vo(n[i],e[i]))return!1;return!0}if(typeof n=="object"&&n!==null&&e!==null){if(typeof e!="object"||Object.keys(n).length!==Object.keys(e).length)return!1;for(const i in n)if(!Vo(n[i],e[i]))return!1;return!0}return n===e}gt.prototype={clone(){return new gt(this.x,this.y)},add(n){return this.clone()._add(n)},sub(n){return this.clone()._sub(n)},multByPoint(n){return this.clone()._multByPoint(n)},divByPoint(n){return this.clone()._divByPoint(n)},mult(n){return this.clone()._mult(n)},div(n){return this.clone()._div(n)},rotate(n){return this.clone()._rotate(n)},rotateAround(n,e){return this.clone()._rotateAround(n,e)},matMult(n){return this.clone()._matMult(n)},unit(){return this.clone()._unit()},perp(){return this.clone()._perp()},round(){return this.clone()._round()},mag(){return Math.sqrt(this.x*this.x+this.y*this.y)},equals(n){return this.x===n.x&&this.y===n.y},dist(n){return Math.sqrt(this.distSqr(n))},distSqr(n){const e=n.x-this.x,i=n.y-this.y;return e*e+i*i},angle(){return Math.atan2(this.y,this.x)},angleTo(n){return Math.atan2(this.y-n.y,this.x-n.x)},angleWith(n){return this.angleWithSep(n.x,n.y)},angleWithSep(n,e){return Math.atan2(this.x*e-this.y*n,this.x*n+this.y*e)},_matMult(n){const e=n[2]*this.x+n[3]*this.y;return this.x=n[0]*this.x+n[1]*this.y,this.y=e,this},_add(n){return this.x+=n.x,this.y+=n.y,this},_sub(n){return this.x-=n.x,this.y-=n.y,this},_mult(n){return this.x*=n,this.y*=n,this},_div(n){return this.x/=n,this.y/=n,this},_multByPoint(n){return this.x*=n.x,this.y*=n.y,this},_divByPoint(n){return this.x/=n.x,this.y/=n.y,this},_unit(){return this._div(this.mag()),this},_perp(){const n=this.y;return this.y=this.x,this.x=-n,this},_rotate(n){const e=Math.cos(n),i=Math.sin(n),o=i*this.x+e*this.y;return this.x=e*this.x-i*this.y,this.y=o,this},_rotateAround(n,e){const i=Math.cos(n),o=Math.sin(n),a=e.y+o*(this.x-e.x)+i*(this.y-e.y);return this.x=e.x+i*(this.x-e.x)-o*(this.y-e.y),this.y=a,this},_round(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this},constructor:gt},gt.convert=function(n){if(n instanceof gt)return n;if(Array.isArray(n))return new gt(+n[0],+n[1]);if(n.x!==void 0&&n.y!==void 0)return new gt(+n.x,+n.y);throw new Error("Expected [x, y] or {x, y} point format")};const eu=Math.PI/180,_a=180/Math.PI;function vn(n){return n*eu}function ke(n){return n*_a}const Q=[[0,0],[1,0],[1,1],[0,1]];function J(n){if(n<=0)return 0;if(n>=1)return 1;const e=n*n,i=e*n;return 4*(n<.5?i:3*(n-e)+i-.75)}function ce(n,e,i,o){const a=new No(n,e,i,o);return function(h){return a.solve(h)}}const be=ce(.25,.1,.25,1);function de(n,e,i){return Math.min(i,Math.max(e,n))}function Ae(n,e,i){return(i=de((i-n)/(e-n),0,1))*i*(3-2*i)}function $e(n,e,i){const o=i-e,a=((n-e)%o+o)%o+e;return a===e?i:a}function Re(n,e,i){if(!n.length)return i(null,[]);let o=n.length;const a=new Array(n.length);let h=null;n.forEach(((d,y)=>{e(d,((w,T)=>{w&&(h=w),a[y]=T,--o==0&&i(h,a)}))}))}function Ge(n,...e){for(const i of e)for(const o in i)n[o]=i[o];return n}let Ct=1;function lt(){return Ct++}function ri(n){return n<=1?1:Math.pow(2,Math.ceil(Math.log(n)/Math.LN2))}function yi(n,e){n.forEach((i=>{e[i]&&(e[i]=e[i].bind(e))}))}function Ri(n,e,i){const o={};for(const a in n)o[a]=e.call(this,n[a],a,n);return o}function Ki(n,e,i){const o={};for(const a in n)e.call(this,n[a],a,n)&&(o[a]=n[a]);return o}function Vi(n){return Array.isArray(n)?n.map(Vi):typeof n=="object"&&n?Ri(n,Vi):n}function Yi(n,e){for(let i=0;i<n.length;i++)if(e.indexOf(n[i])>=0)return!0;return!1}const Xn={};function tn(n){Xn[n]||(typeof console<"u"&&console.warn(n),Xn[n]=!0)}function Nr(n,e,i){return(i.y-n.y)*(e.x-n.x)>(e.y-n.y)*(i.x-n.x)}function Fn(n){let e=0;for(let i,o,a=0,h=n.length,d=h-1;a<h;d=a++)i=n[a],o=n[d],e+=(o.x-i.x)*(i.y+o.y);return e}function ns([n,e,i]){const o=vn(e+90),a=vn(i);return{x:n*Math.cos(o)*Math.sin(a),y:n*Math.sin(o)*Math.sin(a),z:n*Math.cos(a),azimuthal:e,polar:i}}function jn(n){return(typeof self<"u"||n!==void 0)&&typeof WorkerGlobalScope<"u"&&(n!==void 0?n:self)instanceof WorkerGlobalScope}function dn(n){const e={};if(n.replace(/(?:^|(?:\s*\,\s*))([^\x00-\x20\(\)<>@\,;\:\\"\/\[\]\?\=\{\}\x7F]+)(?:\=(?:([^\x00-\x20\(\)<>@\,;\:\\"\/\[\]\?\=\{\}\x7F]+)|(?:\"((?:[^"\\]|\\.)*)\")))?/g,((i,o,a,h)=>{const d=a||h;return e[o]=!d||d.toLowerCase(),""})),e["max-age"]){const i=parseInt(e["max-age"],10);isNaN(i)?delete e["max-age"]:e["max-age"]=i}return e}let rr=null;function br(n,e){return[n[4*e],n[4*e+1],n[4*e+2],n[4*e+3]]}function Tr(n,e,i,o){for(;e<i;){const a=e+i>>1;n[a]<o?e=a+1:i=a}return e}function us(n,e,i,o){for(;e<i;){const a=e+i>>1;n[a]<=o?e=a+1:i=a}return e}function rs(n){return n>0?1/(1.001-n):1+n}function Ns(n){return n>0?1-1/(1.001-n):-n}function Ks(n,e,i){return(n-e.min)*(i.max-i.min)/(e.max-e.min)+i.min}const ws={API_URL:"https://api.mapbox.com",get API_URL_REGEX(){return/^((https?:)?\/\/)?([^\/]+\.)?mapbox\.c(n|om)(\/|\?|$)/i},get API_TILEJSON_REGEX(){return/^((https?:)?\/\/)?([^\/]+\.)?mapbox\.c(n|om)(\/v[0-9]*\/.*\.json.*$)/i},get API_SPRITE_REGEX(){return/^((https?:)?\/\/)?([^\/]+\.)?mapbox\.c(n|om)(\/styles\/v[0-9]*\/)(.*\/sprite.*\..*$)/i},get API_FONTS_REGEX(){return/^((https?:)?\/\/)?([^\/]+\.)?mapbox\.c(n|om)(\/fonts\/v[0-9]*\/)(.*\.pbf.*$)/i},get API_STYLE_REGEX(){return/^((https?:)?\/\/)?([^\/]+\.)?mapbox\.c(n|om)(\/styles\/v[0-9]*\/)(.*$)/i},get API_CDN_URL_REGEX(){return/^((https?:)?\/\/)?api\.mapbox\.c(n|om)(\/mapbox-gl-js\/)(.*$)/i},get EVENTS_URL(){if(!ws.API_URL)return null;try{const n=new URL(ws.API_URL);return n.hostname==="api.mapbox.cn"?"https://events.mapbox.cn/events/v2":n.hostname==="api.mapbox.com"?"https://events.mapbox.com/events/v2":null}catch{return null}},SESSION_PATH:"/map-sessions/v1",FEEDBACK_URL:"https://apps.mapbox.com/feedback",TILE_URL_VERSION:"v4",RASTER_URL_PREFIX:"raster/v1",RASTERARRAYS_URL_PREFIX:"rasterarrays/v1",REQUIRE_ACCESS_TOKEN:!0,ACCESS_TOKEN:null,DEFAULT_STYLE:"mapbox://styles/mapbox/standard",MAX_PARALLEL_IMAGE_REQUESTS:16,DRACO_URL:"https://api.mapbox.com/mapbox-gl-js/draco_decoder_gltf_v1.5.6.wasm",MESHOPT_URL:"https://api.mapbox.com/mapbox-gl-js/meshopt_base_v0.20.wasm",MESHOPT_SIMD_URL:"https://api.mapbox.com/mapbox-gl-js/meshopt_simd_v0.20.wasm",BUILDING_GEN_URL:"https://api.mapbox.com/mapbox-gl-js/building-gen/building_gen_v1.2.1.wasm",GLYPHS_URL:"mapbox://fonts/mapbox/{fontstack}/{range}.pbf",TILES3D_URL_PREFIX:"3dtiles/v1"};function ol(n){return ws.API_URL_REGEX.test(n)}function tu(n){return ws.API_SPRITE_REGEX.test(n)}let Ll,kl,al,zl,Jl,ga;function So(){return Ll==null&&(Ll=self.OffscreenCanvas&&new OffscreenCanvas(1,1).getContext("2d")&&typeof self.createImageBitmap=="function"),Ll}const go={now:()=>zl!==void 0?zl:performance.now(),setNow(n){zl=n},restoreNow(){zl=void 0},frame(n){const e=requestAnimationFrame(n);return{cancel:()=>cancelAnimationFrame(e)}},getImageData(n,e=0){const{width:i,height:o}=n;Jl||(Jl=document.createElement("canvas"));const a=Jl.getContext("2d",{willReadFrequently:!0});if(!a)throw new Error("failed to create canvas 2d context");return(i>Jl.width||o>Jl.height)&&(Jl.width=i,Jl.height=o),a.clearRect(-e,-e,i+2*e,o+2*e),a.drawImage(n,0,0,i,o),a.getImageData(-e,-e,i+2*e,o+2*e)},resolveURL:n=>(kl||(kl=document.createElement("a")),kl.href=n,kl.href),get devicePixelRatio(){return window.devicePixelRatio},get prefersReducedMotion(){return!!window.matchMedia&&(al==null&&(al=window.matchMedia("(prefers-reduced-motion: reduce)")),al.matches)},hasCanvasFingerprintNoise(){if(ga!==void 0)return ga;if(!So())return ga=!1,!1;const n=new OffscreenCanvas(85,1),e=n.getContext("2d",{willReadFrequently:!0});let i=0;for(let a=0;a<n.width;++a)e.fillStyle=`rgba(${i++},${i++},${i++}, 255)`,e.fillRect(a,0,1,1);const o=e.getImageData(0,0,n.width,n.height);i=0;for(let a=0;a<o.data.length;++a)if(a%4!=3&&i++!==o.data[a])return ga=!0,!0;return ga=!1,!1}};function Vs(n,e){const i=n.indexOf("?");if(i<0)return`${n}?${new URLSearchParams(e).toString()}`;const o=new URLSearchParams(n.slice(i));for(const a in e)o.set(a,e[a]);return`${n.slice(0,i)}?${o.toString()}`}function Ys(n,e={persistentParams:[]}){const i=n.indexOf("?");if(i<0)return n;const o=new URLSearchParams,a=new URLSearchParams(n.slice(i));for(const d of e.persistentParams){const y=a.get(d);y&&o.set(d,y)}const h=o.toString();return`${n.slice(0,i)}${h.length>0?`?${h}`:""}`}const Ir="mapbox-tiles";let lo=500,Kn=50;const Va=["language","worldview","jobid"];let ya,Fl;function Ol(){try{return caches}catch{}}function ec(){const n=Ol();n&&ya==null&&(ya=n.open(Ir))}let ju=1/0;const iu={supported:!1,testSupport:function(n){!Uo&&bs&&(Io?va(n):ys=n)}};let ys,bs,Uo=!1,Io=!1;const tc=typeof self<"u"?self:{};function va(n){const e=n.createTexture();n.bindTexture(n.TEXTURE_2D,e);try{if(n.texImage2D(n.TEXTURE_2D,0,n.RGBA,n.RGBA,n.UNSIGNED_BYTE,bs),n.isContextLost())return;iu.supported=!0}catch{}n.deleteTexture(e),Uo=!0}tc.document&&(bs=tc.document.createElement("img"),bs.onload=function(){ys&&va(ys),ys=null,Io=!0},bs.onerror=function(){Uo=!0,ys=null},bs.src="data:image/webp;base64,UklGRh4AAABXRUJQVlA4TBEAAAAvAQAAAAfQ//73v/+BiOh/AAA=");const ea={Unknown:"Unknown",Style:"Style",Source:"Source",Tile:"Tile",Glyphs:"Glyphs",SpriteImage:"SpriteImage",SpriteJSON:"SpriteJSON",Iconset:"Iconset",Image:"Image",Model:"Model"};typeof Object.freeze=="function"&&Object.freeze(ea);class xn extends Error{constructor(e,i,o){i===401&&ol(o)&&(e+=": you may have provided an invalid Mapbox access token. See https://docs.mapbox.com/api/overview/#access-tokens-and-token-scopes"),super(e),this.status=i,this.url=o}toString(){return`${this.name}: ${this.message} (${this.status}): ${this.url}`}}const nu=jn()?()=>self.worker.referrer:()=>(location.protocol==="blob:"?parent:self).location.href,Qs=function(n,e){if(!(/^file:/.test(i=n.url)||/^file:/.test(nu())&&!/^\w+:/.test(i))){if(self.fetch&&self.Request&&self.AbortController&&Request.prototype.hasOwnProperty("signal"))return(function(o,a){const h=new AbortController,d=new Request(o.url,{method:o.method||"GET",body:o.body,credentials:o.credentials,headers:o.headers,referrer:nu(),referrerPolicy:o.referrerPolicy,signal:h.signal});let y=!1,w=!1;const T=(C=d.url).indexOf("sku=")>0&&ol(C);var C;o.type==="json"&&d.headers.set("Accept","application/json");const P=(O,N,G)=>{if(w)return;if(O&&O.message!=="SecurityError"&&tn(O.toString()),N&&G)return D(N);const q=Date.now();fetch(d).then((Y=>{if(Y.ok){const se=T?Y.clone():null;return D(Y,se,q)}return a(new xn(Y.statusText,Y.status,o.url))})).catch((Y=>{Y.name!=="AbortError"&&a(new Error(`${Y.message} ${o.url}`))}))},D=(O,N,G)=>{(o.type==="arrayBuffer"?O.arrayBuffer():o.type==="json"?O.json():O.text()).then((q=>{w||(N&&G&&(function(Y,se,re){if(ec(),ya==null)return;const ae=dn(se.headers.get("Cache-Control")||"");if(ae["no-store"])return;const Ee={status:se.status,statusText:se.statusText,headers:new Headers};se.headers.forEach(((Pe,Me)=>Ee.headers.set(Me,Pe))),ae["max-age"]&&Ee.headers.set("Expires",new Date(re+1e3*ae["max-age"]).toUTCString());const ve=Ee.headers.get("Expires");if(!ve||new Date(ve).getTime()-re<42e4)return;let xe=Ys(Y.url,{persistentParams:Va});if(se.status===206){const Pe=Y.headers.get("Range");if(!Pe)return;Ee.status=200,xe=Vs(xe,{range:Pe})}(function(Pe,Me){if(Fl===void 0)try{new Response(new ReadableStream),Fl=!0}catch{Fl=!1}Fl?Me(Pe.body):Pe.blob().then(Me).catch((it=>tn(it.message)))})(se,(Pe=>{const Me=new Response((it=se.status)!==200&&it!==404&&[101,103,204,205,304].includes(it)?null:Pe,Ee);var it;ec(),ya?.then((Fe=>Fe.put(xe,Me))).catch((Fe=>tn(Fe.message)))}))})(d,N,G),y=!0,a(null,q,O.headers.get("Cache-Control"),O.headers.get("Expires")))})).catch((q=>{w||a(new Error(q.message))}))};return T?(function(O,N){if(ec(),ya==null)return N(null);ya.then((G=>{let q=Ys(O.url,{persistentParams:Va});const Y=O.headers.get("Range");Y&&(q=Vs(q,{range:Y})),G.match(q).then((se=>{const re=(function(ae){if(!ae)return!1;const Ee=new Date(ae.headers.get("Expires")||0),ve=dn(ae.headers.get("Cache-Control")||"");return Number(Ee)>Date.now()&&!ve["no-cache"]})(se);G.delete(q).catch(N),re&&G.put(q,se.clone()).catch(N),N(null,se,re)})).catch(N)})).catch(N)})(d,P):P(null,null),{cancel:()=>{w=!0,y||h.abort()}}})(n,e);if(jn(self)&&self.worker.actor)return self.worker.actor.send("getResource",n,e,void 0,!0)}var i;return(function(o,a){const h=new XMLHttpRequest;h.open(o.method||"GET",o.url,!0),o.type==="arrayBuffer"&&(h.responseType="arraybuffer");for(const d in o.headers)h.setRequestHeader(d,o.headers[d]);return o.type==="json"&&(h.responseType="text",h.setRequestHeader("Accept","application/json")),h.withCredentials=o.credentials==="include",h.onerror=()=>{a(new Error(h.statusText))},h.onload=()=>{if((h.status>=200&&h.status<300||h.status===0)&&h.response!==null){let d=h.response;if(o.type==="json")try{d=JSON.parse(h.response)}catch(y){return a(y)}a(null,d,h.getResponseHeader("Cache-Control"),h.getResponseHeader("Expires"))}else a(new xn(h.statusText,h.status,o.url))},h.send(o.body),{cancel:()=>h.abort()}})(n,e)},ru=function(n,e){return Qs(Ge(n,{type:"arrayBuffer"}),e)};function vd(n){const e=document.createElement("a");return e.href=n,e.protocol===location.protocol&&e.host===location.host}const xa="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAC0lEQVQYV2NgAAIAAAUAAarVyFEAAAAASUVORK5CYII=";let wa,ll;wa=[],ll=0;const jo=function(n,e){if(iu.supported&&(n.headers||(n.headers={}),n.headers.accept="image/webp,*/*"),ll>=ws.MAX_PARALLEL_IMAGE_REQUESTS){const h={requestParameters:n,callback:e,cancelled:!1,cancel(){this.cancelled=!0}};return wa.push(h),h}ll++;let i=!1;const o=()=>{if(!i)for(i=!0,ll--;wa.length&&ll<ws.MAX_PARALLEL_IMAGE_REQUESTS;){const h=wa.shift(),{requestParameters:d,callback:y,cancelled:w}=h;w||(h.cancel=jo(d,y).cancel)}},a=ru(n,((h,d,y,w)=>{o(),h?e(h):d&&(self.createImageBitmap?(function(T,C){const P=new Blob([new Uint8Array(T)],{type:"image/png"});createImageBitmap(P).then((D=>{C(null,D)})).catch((D=>{C(new Error(`Could not load image because of ${D.message}. Please make sure to use a supported image type such as PNG or JPEG. Note that SVGs are not supported.`))}))})(d,((T,C)=>e(T,C,y,w))):(function(T,C){const P=new Image;P.onload=()=>{C(null,P),URL.revokeObjectURL(P.src),P.onload=null,requestAnimationFrame((()=>{P.src=xa}))},P.onerror=()=>C(new Error("Could not load image. Please make sure to use a supported image type such as PNG or JPEG. Note that SVGs are not supported."));const D=new Blob([new Uint8Array(T)],{type:"image/png"});P.src=T.byteLength?URL.createObjectURL(D):xa})(d,((T,C)=>e(T,C,y,w))))}));return{cancel:()=>{a.cancel(),o()}}};var Ua,ja,ic,Yr={exports:{}},nc={exports:{}},Gu={exports:{}},cl=(function(){if(ic)return Yr.exports;ic=1;var n=(Ua||(Ua=1,nc.exports=function(i,o){var a,h,d,y,w,T,C,P;for(h=i.length-(a=3&i.length),d=o,w=3432918353,T=461845907,P=0;P<h;)C=255&i.charCodeAt(P)|(255&i.charCodeAt(++P))<<8|(255&i.charCodeAt(++P))<<16|(255&i.charCodeAt(++P))<<24,++P,d=27492+(65535&(y=5*(65535&(d=(d^=C=(65535&(C=(C=(65535&C)*w+(((C>>>16)*w&65535)<<16)&4294967295)<<15|C>>>17))*T+(((C>>>16)*T&65535)<<16)&4294967295)<<13|d>>>19))+((5*(d>>>16)&65535)<<16)&4294967295))+((58964+(y>>>16)&65535)<<16);switch(C=0,a){case 3:C^=(255&i.charCodeAt(P+2))<<16;case 2:C^=(255&i.charCodeAt(P+1))<<8;case 1:d^=C=(65535&(C=(C=(65535&(C^=255&i.charCodeAt(P)))*w+(((C>>>16)*w&65535)<<16)&4294967295)<<15|C>>>17))*T+(((C>>>16)*T&65535)<<16)&4294967295}return d^=i.length,d=2246822507*(65535&(d^=d>>>16))+((2246822507*(d>>>16)&65535)<<16)&4294967295,d=3266489909*(65535&(d^=d>>>13))+((3266489909*(d>>>16)&65535)<<16)&4294967295,(d^=d>>>16)>>>0}),nc.exports),e=(ja||(ja=1,Gu.exports=function(i,o){for(var a,h=i.length,d=o^h,y=0;h>=4;)a=1540483477*(65535&(a=255&i.charCodeAt(y)|(255&i.charCodeAt(++y))<<8|(255&i.charCodeAt(++y))<<16|(255&i.charCodeAt(++y))<<24))+((1540483477*(a>>>16)&65535)<<16),d=1540483477*(65535&d)+((1540483477*(d>>>16)&65535)<<16)^(a=1540483477*(65535&(a^=a>>>24))+((1540483477*(a>>>16)&65535)<<16)),h-=4,++y;switch(h){case 3:d^=(255&i.charCodeAt(y+2))<<16;case 2:d^=(255&i.charCodeAt(y+1))<<8;case 1:d=1540483477*(65535&(d^=255&i.charCodeAt(y)))+((1540483477*(d>>>16)&65535)<<16)}return d=1540483477*(65535&(d^=d>>>13))+((1540483477*(d>>>16)&65535)<<16),(d^=d>>>15)>>>0}),Gu.exports);return Yr.exports=n,Yr.exports.murmur3=n,Yr.exports.murmur2=e,Yr.exports})(),ul=Jo(cl);class ba{constructor(e,...i){Ge(this,i[0]||{}),this.type=e}}class ds extends ba{constructor(e,i={}){super("error",Ge({error:e},i))}}function Cc(n,e,i){i[n]&&i[n].indexOf(e)!==-1||(i[n]=i[n]||[],i[n].push(e))}function Ao(n,e,i){if(i&&i[n]){const o=i[n].indexOf(e);o!==-1&&i[n].splice(o,1)}}class hl{on(e,i){return this._listeners=this._listeners||{},Cc(e,i,this._listeners),this}off(e,i){return Ao(e,i,this._listeners),Ao(e,i,this._oneTimeListeners),this}once(e,i){return i?(this._oneTimeListeners=this._oneTimeListeners||{},Cc(e,i,this._oneTimeListeners),this):new Promise((o=>{this.once(e,o)}))}fire(e,i){const o=typeof e=="string"?new ba(e,i):e,a=o.type;if(this.listens(a)){o.target=this;const h=this._listeners&&this._listeners[a]?this._listeners[a].slice():[];for(const w of h)w.call(this,o);const d=this._oneTimeListeners&&this._oneTimeListeners[a]?this._oneTimeListeners[a].slice():[];for(const w of d)Ao(a,w,this._oneTimeListeners),w.call(this,o);const y=this._eventedParent;y&&(Ge(o,typeof this._eventedParentData=="function"?this._eventedParentData():this._eventedParentData),y.fire(o))}else o instanceof ds&&console.error(o.error);return this}listens(e){return!!(this._listeners&&this._listeners[e]&&this._listeners[e].length>0||this._oneTimeListeners&&this._oneTimeListeners[e]&&this._oneTimeListeners[e].length>0||this._eventedParent&&this._eventedParent.listens(e))}setEventedParent(e,i){return this._eventedParent=e,this._eventedParentData=i,this}}class Js{constructor(e){typeof e=="string"?this.name=e:(this.name=e.name,this.iconsetId=e.iconsetId)}static from(e){return new Js(e)}static toString(e){return e.iconsetId?`${e.name}${e.iconsetId}`:e.name}static parse(e){const[i,o]=e.split("");return new Js({name:i,iconsetId:o})}static isEqual(e,i){return e.name===i.name&&e.iconsetId===i.iconsetId}toString(){return Js.toString(this)}serialize(){return{name:this.name,iconsetId:this.iconsetId}}}var Ga,Pc={},eo=(function(){if(Ga)return Pc;Ga=1;var n={transparent:[0,0,0,0],aliceblue:[240,248,255,1],antiquewhite:[250,235,215,1],aqua:[0,255,255,1],aquamarine:[127,255,212,1],azure:[240,255,255,1],beige:[245,245,220,1],bisque:[255,228,196,1],black:[0,0,0,1],blanchedalmond:[255,235,205,1],blue:[0,0,255,1],blueviolet:[138,43,226,1],brown:[165,42,42,1],burlywood:[222,184,135,1],cadetblue:[95,158,160,1],chartreuse:[127,255,0,1],chocolate:[210,105,30,1],coral:[255,127,80,1],cornflowerblue:[100,149,237,1],cornsilk:[255,248,220,1],crimson:[220,20,60,1],cyan:[0,255,255,1],darkblue:[0,0,139,1],darkcyan:[0,139,139,1],darkgoldenrod:[184,134,11,1],darkgray:[169,169,169,1],darkgreen:[0,100,0,1],darkgrey:[169,169,169,1],darkkhaki:[189,183,107,1],darkmagenta:[139,0,139,1],darkolivegreen:[85,107,47,1],darkorange:[255,140,0,1],darkorchid:[153,50,204,1],darkred:[139,0,0,1],darksalmon:[233,150,122,1],darkseagreen:[143,188,143,1],darkslateblue:[72,61,139,1],darkslategray:[47,79,79,1],darkslategrey:[47,79,79,1],darkturquoise:[0,206,209,1],darkviolet:[148,0,211,1],deeppink:[255,20,147,1],deepskyblue:[0,191,255,1],dimgray:[105,105,105,1],dimgrey:[105,105,105,1],dodgerblue:[30,144,255,1],firebrick:[178,34,34,1],floralwhite:[255,250,240,1],forestgreen:[34,139,34,1],fuchsia:[255,0,255,1],gainsboro:[220,220,220,1],ghostwhite:[248,248,255,1],gold:[255,215,0,1],goldenrod:[218,165,32,1],gray:[128,128,128,1],green:[0,128,0,1],greenyellow:[173,255,47,1],grey:[128,128,128,1],honeydew:[240,255,240,1],hotpink:[255,105,180,1],indianred:[205,92,92,1],indigo:[75,0,130,1],ivory:[255,255,240,1],khaki:[240,230,140,1],lavender:[230,230,250,1],lavenderblush:[255,240,245,1],lawngreen:[124,252,0,1],lemonchiffon:[255,250,205,1],lightblue:[173,216,230,1],lightcoral:[240,128,128,1],lightcyan:[224,255,255,1],lightgoldenrodyellow:[250,250,210,1],lightgray:[211,211,211,1],lightgreen:[144,238,144,1],lightgrey:[211,211,211,1],lightpink:[255,182,193,1],lightsalmon:[255,160,122,1],lightseagreen:[32,178,170,1],lightskyblue:[135,206,250,1],lightslategray:[119,136,153,1],lightslategrey:[119,136,153,1],lightsteelblue:[176,196,222,1],lightyellow:[255,255,224,1],lime:[0,255,0,1],limegreen:[50,205,50,1],linen:[250,240,230,1],magenta:[255,0,255,1],maroon:[128,0,0,1],mediumaquamarine:[102,205,170,1],mediumblue:[0,0,205,1],mediumorchid:[186,85,211,1],mediumpurple:[147,112,219,1],mediumseagreen:[60,179,113,1],mediumslateblue:[123,104,238,1],mediumspringgreen:[0,250,154,1],mediumturquoise:[72,209,204,1],mediumvioletred:[199,21,133,1],midnightblue:[25,25,112,1],mintcream:[245,255,250,1],mistyrose:[255,228,225,1],moccasin:[255,228,181,1],navajowhite:[255,222,173,1],navy:[0,0,128,1],oldlace:[253,245,230,1],olive:[128,128,0,1],olivedrab:[107,142,35,1],orange:[255,165,0,1],orangered:[255,69,0,1],orchid:[218,112,214,1],palegoldenrod:[238,232,170,1],palegreen:[152,251,152,1],paleturquoise:[175,238,238,1],palevioletred:[219,112,147,1],papayawhip:[255,239,213,1],peachpuff:[255,218,185,1],peru:[205,133,63,1],pink:[255,192,203,1],plum:[221,160,221,1],powderblue:[176,224,230,1],purple:[128,0,128,1],rebeccapurple:[102,51,153,1],red:[255,0,0,1],rosybrown:[188,143,143,1],royalblue:[65,105,225,1],saddlebrown:[139,69,19,1],salmon:[250,128,114,1],sandybrown:[244,164,96,1],seagreen:[46,139,87,1],seashell:[255,245,238,1],sienna:[160,82,45,1],silver:[192,192,192,1],skyblue:[135,206,235,1],slateblue:[106,90,205,1],slategray:[112,128,144,1],slategrey:[112,128,144,1],snow:[255,250,250,1],springgreen:[0,255,127,1],steelblue:[70,130,180,1],tan:[210,180,140,1],teal:[0,128,128,1],thistle:[216,191,216,1],tomato:[255,99,71,1],turquoise:[64,224,208,1],violet:[238,130,238,1],wheat:[245,222,179,1],white:[255,255,255,1],whitesmoke:[245,245,245,1],yellow:[255,255,0,1],yellowgreen:[154,205,50,1]};function e(h){return(h=Math.round(h))<0?0:h>255?255:h}function i(h){return e(h[h.length-1]==="%"?parseFloat(h)/100*255:parseInt(h))}function o(h){return(d=h[h.length-1]==="%"?parseFloat(h)/100:parseFloat(h))<0?0:d>1?1:d;var d}function a(h,d,y){return y<0?y+=1:y>1&&(y-=1),6*y<1?h+(d-h)*y*6:2*y<1?d:3*y<2?h+(d-h)*(2/3-y)*6:h}try{Pc.parseCSSColor=function(h){var d,y=h.replace(/ /g,"").toLowerCase();if(y in n)return n[y].slice();if(y[0]==="#")return y.length===4?(d=parseInt(y.substr(1),16))>=0&&d<=4095?[(3840&d)>>4|(3840&d)>>8,240&d|(240&d)>>4,15&d|(15&d)<<4,1]:null:y.length===7&&(d=parseInt(y.substr(1),16))>=0&&d<=16777215?[(16711680&d)>>16,(65280&d)>>8,255&d,1]:null;var w=y.indexOf("("),T=y.indexOf(")");if(w!==-1&&T+1===y.length){var C=y.substr(0,w),P=y.substr(w+1,T-(w+1)).split(","),D=1;switch(C){case"rgba":if(P.length!==4)return null;D=o(P.pop());case"rgb":return P.length!==3?null:[i(P[0]),i(P[1]),i(P[2]),D];case"hsla":if(P.length!==4)return null;D=o(P.pop());case"hsl":if(P.length!==3)return null;var O=(parseFloat(P[0])%360+360)%360/360,N=o(P[1]),G=o(P[2]),q=G<=.5?G*(N+1):G+N-G*N,Y=2*G-q;return[e(255*a(Y,q,O+1/3)),e(255*a(Y,q,O)),e(255*a(Y,q,O-1/3)),D];default:return null}}return null}}catch{}return Pc})();class un{constructor(e,i,o,a=1){this.r=e,this.g=i,this.b=o,this.a=a}static parse(e){if(!e)return;if(e instanceof un)return e;if(typeof e!="string")return;const i=eo.parseCSSColor(e);return i?new un(i[0]/255,i[1]/255,i[2]/255,i[3]):void 0}toString(){const[e,i,o,a]=[this.r,this.g,this.b,this.a];return`rgba(${Math.round(255*e)},${Math.round(255*i)},${Math.round(255*o)},${a})`}toNonPremultipliedRenderColor(e){const{r:i,g:o,b:a,a:h}=this;return new Go(e,i,o,a,h)}toPremultipliedRenderColor(e){const{r:i,g:o,b:a,a:h}=this;return new xd(e,i*h,o*h,a*h,h)}clone(){return new un(this.r,this.g,this.b,this.a)}}class Bl{constructor(e,i,o,a,h,d=!1){if(this.premultiplied=!1,this.premultiplied=d,e){const y=e.image.height,w=y*y;this.premultiplied?(i=h===0?0:i/h*(y-1),o=h===0?0:o/h*(y-1),a=h===0?0:a/h*(y-1)):(i*=y-1,o*=y-1,a*=y-1);const T=Math.floor(i),C=Math.floor(o),P=Math.floor(a),D=Math.ceil(i),O=Math.ceil(o),N=Math.ceil(a),G=i-T,q=o-C,Y=a-P,se=e.image.data,re=4*(T+C*w+P*y),ae=4*(T+C*w+N*y),Ee=4*(T+O*w+P*y),ve=4*(T+O*w+N*y),xe=4*(D+C*w+P*y),Pe=4*(D+C*w+N*y),Me=4*(D+O*w+P*y),it=4*(D+O*w+N*y);if(re<0||it>=se.length)throw new Error("out of range");this.r=di(di(di(se[re],se[ae],Y),di(se[Ee],se[ve],Y),q),di(di(se[xe],se[Pe],Y),di(se[Me],se[it],Y),q),G)/255*(this.premultiplied?h:1),this.g=di(di(di(se[re+1],se[ae+1],Y),di(se[Ee+1],se[ve+1],Y),q),di(di(se[xe+1],se[Pe+1],Y),di(se[Me+1],se[it+1],Y),q),G)/255*(this.premultiplied?h:1),this.b=di(di(di(se[re+2],se[ae+2],Y),di(se[Ee+2],se[ve+2],Y),q),di(di(se[xe+2],se[Pe+2],Y),di(se[Me+2],se[it+2],Y),q),G)/255*(this.premultiplied?h:1),this.a=h}else this.r=i,this.g=o,this.b=a,this.a=h}toArray(){const{r:e,g:i,b:o,a}=this;return[255*e,255*i,255*o,a]}toHslaArray(){let{r:e,g:i,b:o,a}=this;if(this.premultiplied){if(a===0)return[0,0,0,0];e/=a,i/=a,o/=a}const h=Math.min(Math.max(e,0),1),d=Math.min(Math.max(i,0),1),y=Math.min(Math.max(o,0),1),w=Math.min(h,d,y),T=Math.max(h,d,y),C=(w+T)/2;if(w===T)return[0,0,100*C,a];const P=T-w,D=C>.5?P/(2-T-w):P/(T+w);let O=0;return T===h?O=(d-y)/P+(d<y?6:0):T===d?O=(y-h)/P+2:T===y&&(O=(h-d)/P+4),O*=60,[Math.min(Math.max(O,0),360),Math.min(Math.max(100*D,0),100),Math.min(Math.max(100*C,0),100),a]}toArray01(){const{r:e,g:i,b:o,a}=this;return[e,i,o,a]}toArray01Scaled(e){const{r:i,g:o,b:a}=this;return[i*e,o*e,a*e]}toArray01Linear(){const{r:e,g:i,b:o,a}=this;return[Math.pow(e,2.2),Math.pow(i,2.2),Math.pow(o,2.2),a]}}class Go extends Bl{constructor(e,i,o,a,h){super(e,i,o,a,h,!1)}}class xd extends Bl{constructor(e,i,o,a,h){super(e,i,o,a,h,!0)}}function di(n,e,i){return n*(1-i)+e*i}function Nl(n,e,i){return n.map(((o,a)=>di(o,e[a],i)))}un.black=new un(0,0,0,1),un.white=new un(1,1,1,1),un.transparent=new un(0,0,0,0),un.red=new un(1,0,0,1),un.blue=new un(0,0,1,1);var Ha=Object.freeze({__proto__:null,array:Nl,color:function(n,e,i){return new un(di(n.r,e.r,i),di(n.g,e.g,i),di(n.b,e.b,i),di(n.a,e.a,i))},number:di});function Ta(n,...e){for(const i of e)for(const o in i)n[o]=i[o];return n}class co extends Error{constructor(e,i){super(i),this.message=i,this.key=e}}class su{constructor(e,i=[]){this.parent=e,this.bindings={};for(const[o,a]of i)this.bindings[o]=a}concat(e){return new su(this,e)}get(e){if(this.bindings[e])return this.bindings[e];if(this.parent)return this.parent.get(e);throw new Error(`${e} not found in scope.`)}has(e){return!!this.bindings[e]||!!this.parent&&this.parent.has(e)}}const rc={kind:"null"},ni={kind:"number"},bn={kind:"string"},Mn={kind:"boolean"},Cs={kind:"color"},qa={kind:"object"},On={kind:"value"},ou={kind:"collator"},sc={kind:"formatted"},Vl={kind:"resolvedImage"};function Vr(n,e){return{kind:"array",itemType:n,N:e}}function ss(n){if(n.kind==="array"){const e=ss(n.itemType);return typeof n.N=="number"?`array<${e}, ${n.N}>`:n.itemType.kind==="value"?"array":`array<${e}>`}return n.kind}const wd=[rc,ni,bn,Mn,Cs,sc,qa,Vr(On),Vl];function Ho(n,e){if(e.kind==="error")return null;if(n.kind==="array"){if(e.kind==="array"&&(e.N===0&&e.itemType.kind==="value"||!Ho(n.itemType,e.itemType))&&(typeof n.N!="number"||n.N===e.N))return null}else{if(n.kind===e.kind)return null;if(n.kind==="value"){for(const i of wd)if(!Ho(i,e))return null}}return`Expected ${ss(n)} but found ${ss(e)} instead.`}function R(n,e){return e.some((i=>i.kind===n.kind))}function W(n,e){return e.some((i=>i==="null"?n===null:i==="array"?Array.isArray(n):i==="object"?n&&!Array.isArray(n)&&typeof n=="object":i===typeof n))}function ie(n,e){return n.kind==="array"&&e.kind==="array"?n.N===e.N&&ie(n.itemType,e.itemType):n.kind===e.kind}class Se{constructor(e,i,o){this.sensitivity=e?i?"variant":"case":i?"accent":"base",this.locale=o,this.collator=new Intl.Collator(this.locale?this.locale:[],{sensitivity:this.sensitivity,usage:"search"})}compare(e,i){return this.collator.compare(e,i)}resolvedLocale(){return new Intl.Collator(this.locale?this.locale:[]).resolvedOptions().locale}}class pt{constructor(e,i,o,a,h){this.text=e.normalize?e.normalize():e,this.image=i,this.scale=o,this.fontStack=a,this.textColor=h}}class Mt{constructor(e){this.sections=e}static fromString(e){return new Mt([new pt(e,null,null,null,null)])}isEmpty(){return this.sections.length===0||!this.sections.some((e=>e.text.length!==0||!!e.image&&e.image.hasPrimary()))}static factory(e){return e instanceof Mt?e:Mt.fromString(e)}toString(){return this.sections.length===0?"":this.sections.map((e=>e.text)).join("")}serialize(){const e=["format"];for(const i of this.sections){if(i.image){const a=i.image.getPrimary().id.toString();e.push(["image",a]);continue}e.push(i.text);const o={};i.fontStack&&(o["text-font"]=["literal",i.fontStack.split(",")]),i.scale&&(o["font-scale"]=i.scale),i.textColor&&(o["text-color"]=["rgba"].concat(i.textColor.toNonPremultipliedRenderColor(null).toArray())),e.push(o)}return e}}class vi{constructor(e,i={}){if(this.id=Js.from(e),this.options=Object.assign({},i),i.transform){const{a:o,b:a,c:h,d,e:y,f:w}=i.transform;this.options.transform=new DOMMatrix([o,a,h,d,y,w])}else this.options.transform=new DOMMatrix([1,0,0,1,0,0])}toString(){const{a:e,b:i,c:o,d:a,e:h,f:d}=this.options.transform;return JSON.stringify({name:this.id.name,iconsetId:this.id.iconsetId,params:this.options.params,transform:{a:e,b:i,c:o,d:a,e:h,f:d}})}static parse(e){let i,o,a,h;try{({name:i,iconsetId:o,params:a,transform:h}=JSON.parse(e)||{})}catch{return null}if(!i)return null;const{a:d,b:y,c:w,d:T,e:C,f:P}=h||{};return new vi({name:i,iconsetId:o},{params:a,transform:new DOMMatrix([d,y,w,T,C,P])})}scaleSelf(e,i){return this.options.transform.scaleSelf(e,i),this}}class Yn{constructor(e,i,o,a,h=!1){this.primaryId=Js.from(e),this.primaryOptions=i,o&&(this.secondaryId=Js.from(o)),this.secondaryOptions=a,this.available=h}toString(){return this.primaryId&&this.secondaryId?`[${this.primaryId.name},${this.secondaryId.name}]`:this.primaryId.name}hasPrimary(){return!!this.primaryId}getPrimary(){return new vi(this.primaryId,this.primaryOptions)}hasSecondary(){return!!this.secondaryId}getSecondary(){return this.secondaryId?new vi(this.secondaryId,this.secondaryOptions):null}static from(e){return typeof e=="string"?Yn.build({name:e}):e}static build(e,i,o,a){return!e||typeof e=="object"&&!("name"in e)?null:new Yn(e,o,i,a)}}function fs(n,e,i,o){return typeof n=="number"&&n>=0&&n<=255&&typeof e=="number"&&e>=0&&e<=255&&typeof i=="number"&&i>=0&&i<=255?o===void 0||typeof o=="number"&&o>=0&&o<=1?null:`Invalid rgba value [${[n,e,i,o].join(", ")}]: 'a' must be between 0 and 1.`:`Invalid rgba value [${(typeof o=="number"?[n,e,i,o]:[n,e,i]).join(", ")}]: 'r', 'g', and 'b' must be between 0 and 255.`}function ui(n){if(n===null||typeof n=="string"||typeof n=="boolean"||typeof n=="number"||n instanceof un||n instanceof Se||n instanceof Mt||n instanceof Yn)return!0;if(Array.isArray(n)){for(const e of n)if(!ui(e))return!1;return!0}if(typeof n=="object"){for(const e in n)if(!ui(n[e]))return!1;return!0}return!1}function Vt(n){if(n===null)return rc;if(typeof n=="string")return bn;if(typeof n=="boolean")return Mn;if(typeof n=="number")return ni;if(n instanceof un)return Cs;if(n instanceof Se)return ou;if(n instanceof Mt)return sc;if(n instanceof Yn)return Vl;if(Array.isArray(n)){const e=n.length;let i;for(const o of n){const a=Vt(o);if(i){if(i===a)continue;i=On;break}i=a}return Vr(i||On,e)}return qa}function Ur(n){const e=typeof n;return n===null?"":e==="string"||e==="number"||e==="boolean"?String(n):n instanceof Mt||n instanceof Yn||n instanceof un?n.toString():JSON.stringify(n)}class _i{constructor(e,i){this.type=e,this.value=i}static parse(e,i){if(e.length!==2)return i.error(`'literal' expression requires exactly one argument, but found ${e.length-1} instead.`);if(!ui(e[1]))return i.error("invalid value");const o=e[1];let a=Vt(o);const h=i.expectedType;return a.kind!=="array"||a.N!==0||!h||h.kind!=="array"||typeof h.N=="number"&&h.N!==0||(a=h),new _i(a,o)}evaluate(){return this.value}eachChild(){}outputDefined(){return!0}serialize(){return this.type.kind==="array"||this.type.kind==="object"?["literal",this.value]:this.value instanceof un?["rgba"].concat(this.value.toNonPremultipliedRenderColor(null).toArray()):this.value instanceof Mt?this.value.serialize():this.value}}class gr{constructor(e){this.name="ExpressionEvaluationError",this.message=e}toJSON(){return this.message}}const dl={string:bn,number:ni,boolean:Mn,object:qa};class gi{constructor(e,i){this.type=e,this.args=i}static parse(e,i){if(e.length<2)return i.error("Expected at least one argument.");let o,a=1;const h=e[0];if(h==="array"){let y,w;if(e.length>2){const T=e[1];if(typeof T!="string"||!(T in dl)||T==="object")return i.error('The item type argument of "array" must be one of string, number, boolean',1);y=dl[T],a++}else y=On;if(e.length>3){if(e[2]!==null&&(typeof e[2]!="number"||e[2]<0||e[2]!==Math.floor(e[2])))return i.error('The length argument to "array" must be a positive integer literal',2);w=e[2],a++}o=Vr(y,w)}else o=dl[h];const d=[];for(;a<e.length;a++){const y=i.parse(e[a],a,On);if(!y)return null;d.push(y)}return new gi(o,d)}evaluate(e){for(let i=0;i<this.args.length;i++){const o=this.args[i].evaluate(e);if(!Ho(this.type,Vt(o)))return o;if(i===this.args.length-1)throw new gr(`The expression ${JSON.stringify(this.args[i].serialize())} evaluated to ${ss(Vt(o))} but was expected to be of type ${ss(this.type)}.`)}return null}eachChild(e){this.args.forEach(e)}outputDefined(){return this.args.every((e=>e.outputDefined()))}serialize(){const e=this.type,i=[e.kind];if(e.kind==="array"){const o=e.itemType;if(o.kind==="string"||o.kind==="number"||o.kind==="boolean"){i.push(o.kind);const a=e.N;(typeof a=="number"||this.args.length>1)&&i.push(a)}}return i.concat(this.args.map((o=>o.serialize())))}}class au{constructor(e){this.type=sc,this.sections=e}static parse(e,i){if(e.length<2)return i.error("Expected at least one argument.");const o=e[1];if(!Array.isArray(o)&&typeof o=="object")return i.error("First argument must be an image or text section.");const a=[];let h=!1;for(let d=1;d<=e.length-1;++d){const y=e[d];if(h&&typeof y=="object"&&!Array.isArray(y)){h=!1;let w=null;if(y["font-scale"]&&(w=i.parseObjectValue(y["font-scale"],d,"font-scale",ni),!w))return null;let T=null;if(y["text-font"]&&(T=i.parseObjectValue(y["text-font"],d,"text-font",Vr(bn)),!T))return null;let C=null;if(y["text-color"]&&(C=i.parseObjectValue(y["text-color"],d,"text-color",Cs),!C))return null;const P=a[a.length-1];P.scale=w,P.font=T,P.textColor=C}else{const w=i.parse(e[d],d,On);if(!w)return null;const T=w.type.kind;if(T!=="string"&&T!=="value"&&T!=="null"&&T!=="resolvedImage")return i.error("Formatted text type must be 'string', 'value', 'image' or 'null'.");h=!0,a.push({content:w,scale:null,font:null,textColor:null})}}return new au(a)}evaluate(e){return new Mt(this.sections.map((i=>{const o=i.content.evaluate(e);return ie(Vt(o),Vl)?new pt("",o,null,null,null):new pt(Ur(o),null,i.scale?i.scale.evaluate(e):null,i.font?i.font.evaluate(e).join(","):null,i.textColor?i.textColor.evaluate(e):null)})))}eachChild(e){for(const i of this.sections)e(i.content),i.scale&&e(i.scale),i.font&&e(i.font),i.textColor&&e(i.textColor)}outputDefined(){return!1}serialize(){const e=["format"];for(const i of this.sections){e.push(i.content.serialize());const o={};i.scale&&(o["font-scale"]=i.scale.serialize()),i.font&&(o["text-font"]=i.font.serialize()),i.textColor&&(o["text-color"]=i.textColor.serialize()),e.push(o)}return e}}class lu{constructor(e,i,o,a){this._imageWarnHistory={},this.type=Vl,this.namePrimary=e,this.nameSecondary=i,o&&(this.paramsPrimary=o.params,this.iconsetIdPrimary=o.iconset?o.iconset.id:void 0),a&&(this.paramsSecondary=a.params,this.iconsetIdSecondary=a.iconset?a.iconset.id:void 0)}static parse(e,i){if(e.length<2)return i.error("Expected two or more arguments.");let o=1;const a=[];function h(){if(o<e.length){const y=i.parse(e[o],o++,bn);return y?(a.push({image:y,options:{}}),!0):(i.error(a.length?"Secondary image variant is not a string.":"No image name provided."),!1)}return!0}function d(){if(o<e.length){const w=e[o];if((y=w)===null||typeof y!="object"||Array.isArray(y))return!0;const T=w.params,C=w.iconset,P=i.concat(o);if(!T&&!C)return o++,!0;if(T){if(typeof T!="object"||T.constructor!==Object)return P.error('Image options "params" should be an object'),!1;const D={},O=P.concat(void 0,"params");for(const N in T){if(!N)return O.error("Image parameter name should be non-empty"),!1;const G=O.concat(void 0,N).parse(T[N],void 0,Cs,void 0,{typeAnnotation:"coerce"});if(!G)return!1;D[N]=G}a[a.length-1].options.params=D}if(C){if(typeof C!="object"||C.constructor!==Object)return P.error('Image options "iconset" should be an object'),!1;if(!C.id)return P.error('Image options "iconset" should have an "id" property'),!1;a[a.length-1].options.iconset=C}return o++,!0}var y;return!0}for(let y=0;y<2;y++)if(!h()||!d())return;return new lu(a[0].image,a[1]?a[1].image:void 0,a[0].options,a[1]?a[1].options:void 0)}evaluateParams(e,i){const o={};if(i){for(const a in i)if(i[a])try{o[a]=i[a].evaluate(e)}catch{continue}if(Object.keys(o).length!==0)return{params:o}}}evaluate(e){const i={name:this.namePrimary.evaluate(e),iconsetId:this.iconsetIdPrimary},o=this.nameSecondary?{name:this.nameSecondary.evaluate(e),iconsetId:this.iconsetIdSecondary}:void 0,a=Yn.build(i,o,this.paramsPrimary?this.evaluateParams(e,this.paramsPrimary):void 0,this.paramsSecondary?this.evaluateParams(e,this.paramsSecondary):void 0);if(a&&e.availableImages){const h=a.getPrimary().id;if(a.available=e.availableImages.some((d=>Js.isEqual(d,h))),a.available){const d=a.getSecondary()?a.getSecondary().id:null;d&&(a.available=e.availableImages.some((y=>Js.isEqual(y,d))))}}return a}eachChild(e){if(e(this.namePrimary),this.paramsPrimary)for(const i in this.paramsPrimary)this.paramsPrimary[i]&&e(this.paramsPrimary[i]);if(this.nameSecondary&&(e(this.nameSecondary),this.paramsSecondary))for(const i in this.paramsSecondary)this.paramsSecondary[i]&&e(this.paramsSecondary[i])}outputDefined(){return!1}serializeOptions(e,i){const o={};if(i&&(o.iconset={id:i}),e){o.params={};for(const a in e)e[a]&&(o.params[a]=e[a].serialize())}return Object.keys(o).length>0?o:void 0}serialize(){const e=["image",this.namePrimary.serialize()];if(this.paramsPrimary||this.iconsetIdPrimary){const i=this.serializeOptions(this.paramsPrimary,this.iconsetIdPrimary);i&&e.push(i)}if(this.nameSecondary&&(e.push(this.nameSecondary.serialize()),this.paramsSecondary||this.iconsetIdSecondary)){const i=this.serializeOptions(this.paramsSecondary,this.iconsetIdSecondary);i&&e.push(i)}return e}}function oc(n){return n instanceof Number?"number":n instanceof String?"string":n instanceof Boolean?"boolean":Array.isArray(n)?"array":n===null?"null":typeof n}const cu={"to-boolean":Mn,"to-color":Cs,"to-number":ni,"to-string":bn};class $a{constructor(e,i){this.type=e,this.args=i}static parse(e,i){if(e.length<2)return i.error("Expected at least one argument.");const o=e[0],a=[];let h=rc;if(o==="to-array"){if(!Array.isArray(e[1]))return null;const d=e[1].length;if(i.expectedType){if(i.expectedType.kind!=="array")return i.error(`Expected ${i.expectedType.kind} but found array.`);h=Vr(i.expectedType.itemType,d)}else{if(!(d>0&&ui(e[1][0])))return null;h=Vr(Vt(e[1][0]),d)}for(let y=0;y<d;y++){const w=e[1][y];let T;if(oc(w)==="array")T=i.parse(w,void 0,h.itemType);else{const C=oc(w);if(C!==h.itemType.kind)return i.error(`Expected ${h.itemType.kind} but found ${C}.`);T=i.registry.literal.parse(["literal",w===void 0?null:w],i)}if(!T)return null;a.push(T)}}else{if((o==="to-boolean"||o==="to-string")&&e.length!==2)return i.error("Expected one argument.");h=cu[o];for(let d=1;d<e.length;d++){const y=i.parse(e[d],d,On);if(!y)return null;a.push(y)}}return new $a(h,a)}evaluate(e){if(this.type.kind==="boolean")return!!this.args[0].evaluate(e);if(this.type.kind==="color"){let i,o;for(const a of this.args){if(i=a.evaluate(e),o=null,i instanceof un)return i;if(typeof i=="string"){const h=e.parseColor(i);if(h)return h}else if(Array.isArray(i)&&(o=i.length<3||i.length>4?`Invalid rbga value ${JSON.stringify(i)}: expected an array containing either three or four numeric values.`:fs(i[0],i[1],i[2],i[3]),!o))return new un(i[0]/255,i[1]/255,i[2]/255,i[3])}throw new gr(o||`Could not parse color from value '${typeof i=="string"?i:String(JSON.stringify(i))}'`)}if(this.type.kind==="number"){let i=null;for(const o of this.args){if(i=o.evaluate(e),i===null)return 0;const a=Number(i);if(!isNaN(a))return a}throw new gr(`Could not convert ${JSON.stringify(i)} to number.`)}return this.type.kind==="formatted"?Mt.fromString(Ur(this.args[0].evaluate(e))):this.type.kind==="resolvedImage"?Yn.build(Ur(this.args[0].evaluate(e))):this.type.kind==="array"?this.args.map((i=>i.evaluate(e))):Ur(this.args[0].evaluate(e))}eachChild(e){this.args.forEach(e)}outputDefined(){return this.args.every((e=>e.outputDefined()))}serialize(){if(this.type.kind==="formatted")return new au([{content:this.args[0],scale:null,font:null,textColor:null}]).serialize();if(this.type.kind==="resolvedImage")return new lu(this.args[0]).serialize();const e=this.type.kind==="array"?[]:[`to-${this.type.kind}`];return this.eachChild((i=>{e.push(i.serialize())})),e}}const Co=["Unknown","Point","LineString","Polygon"];class Ph{constructor(e,i){this.globals=null,this.feature=null,this.featureState=null,this.formattedSection=null,this._parseColorCache={},this.availableImages=null,this.canonical=null,this.featureTileCoord=null,this.featureDistanceData=null,this.scope=e,this.options=i}id(){return this.feature&&this.feature.id!==void 0?this.feature.id:null}geometryType(){return this.feature?typeof this.feature.type=="number"?Co[this.feature.type]:this.feature.type:null}geometry(){return this.feature&&"geometry"in this.feature?this.feature.geometry:null}canonicalID(){return this.canonical}properties(){return this.feature&&this.feature.properties||{}}measureLight(e){return this.globals.brightness||0}distanceFromCenter(){if(this.featureTileCoord&&this.featureDistanceData){const e=this.featureDistanceData.center,i=this.featureDistanceData.scale,{x:o,y:a}=this.featureTileCoord;return this.featureDistanceData.bearing[0]*(o*i-e[0])+this.featureDistanceData.bearing[1]*(a*i-e[1])}return 0}parseColor(e){let i=this._parseColorCache[e];return i||(i=this._parseColorCache[e]=un.parse(e)),i}getConfig(e){return this.options?this.options.get(e):null}}class Ms{constructor(e,i,o,a,h){this.name=e,this.type=i,this._evaluate=o,this.args=a,this._overloadIndex=h}evaluate(e){if(!this._evaluate){const i=Ms.definitions[this.name];this._evaluate=Array.isArray(i)?i[2]:i.overloads[this._overloadIndex][1]}return this._evaluate(e,this.args)}eachChild(e){this.args.forEach(e)}outputDefined(){return!1}serialize(){return[this.name].concat(this.args.map((e=>e.serialize())))}static parse(e,i){const o=e[0],a=Ms.definitions[o];if(!a)return i.error(`Unknown expression "${o}". If you wanted a literal array, use ["literal", [...]].`,0);const h=Array.isArray(a)?a[0]:a.type,d=Array.isArray(a)?[[a[1],a[2]]]:a.overloads,y=[];let w=null,T=-1;for(const[C,P]of d){if(Array.isArray(C)&&C.length!==e.length-1)continue;y.push(C),T++,w=new Ju(i.registry,i.path,null,i.scope,void 0,i._scope,i.options);const D=[];let O=!1;for(let N=1;N<e.length;N++){const G=e[N],q=Array.isArray(C)?C[N-1]:C.type,Y=w.parse(G,1+D.length,q);if(!Y){O=!0;break}D.push(Y)}if(!O)if(Array.isArray(C)&&C.length!==D.length)w.error(`Expected ${C.length} arguments, but found ${D.length} instead.`);else{for(let N=0;N<D.length;N++){const G=Array.isArray(C)?C[N]:C.type,q=D[N];w.concat(N+1).checkSubtype(G,q.type)}if(w.errors.length===0)return new Ms(o,h,P,D,T)}}if(y.length===1)i.errors.push(...w.errors);else{const C=(y.length?y:d.map((([D])=>D))).map(bd).join(" | "),P=[];for(let D=1;D<e.length;D++){const O=i.parse(e[D],1+P.length);if(!O)return null;P.push(ss(O.type))}i.error(`Expected arguments of type ${C}, but found (${P.join(", ")}) instead.`)}return null}static register(e,i){Ms.definitions=i;for(const o in i)e[o]=Ms}}function bd(n){return Array.isArray(n)?`(${n.map(ss).join(", ")})`:`(${ss(n.type)}...)`}class ta{constructor(e,i,o){this.type=ou,this.locale=o,this.caseSensitive=e,this.diacriticSensitive=i}static parse(e,i){if(e.length!==2)return i.error("Expected one argument.");const o=e[1];if(typeof o!="object"||Array.isArray(o))return i.error("Collator options argument must be an object.");const a=o["case-sensitive"]===void 0?i.parse(!1,1,Mn):i.parseObjectValue(o["case-sensitive"],1,"case-sensitive",Mn);if(!a)return null;const h=o["diacritic-sensitive"]===void 0?i.parse(!1,1,Mn):i.parseObjectValue(o["diacritic-sensitive"],1,"diacritic-sensitive",Mn);if(!h)return null;let d=null;return o.locale&&(d=i.parseObjectValue(o.locale,1,"locale",bn),!d)?null:new ta(a,h,d)}evaluate(e){return new Se(this.caseSensitive.evaluate(e),this.diacriticSensitive.evaluate(e),this.locale?this.locale.evaluate(e):null)}eachChild(e){e(this.caseSensitive),e(this.diacriticSensitive),this.locale&&e(this.locale)}outputDefined(){return!1}serialize(){const e={};return e["case-sensitive"]=this.caseSensitive.serialize(),e["diacritic-sensitive"]=this.diacriticSensitive.serialize(),this.locale&&(e.locale=this.locale.serialize()),["collator",e]}}function Ds(n,e,i=0,o=n.length-1,a=Td){for(;o>i;){if(o-i>600){const w=o-i+1,T=e-i+1,C=Math.log(w),P=.5*Math.exp(2*C/3),D=.5*Math.sqrt(C*P*(w-P)/w)*(T-w/2<0?-1:1);Ds(n,e,Math.max(i,Math.floor(e-T*P/w+D)),Math.min(o,Math.floor(e+(w-T)*P/w+D)),a)}const h=n[e];let d=i,y=o;for(Rh(n,i,e),a(n[o],h)>0&&Rh(n,i,o);d<y;){for(Rh(n,d,y),d++,y--;a(n[d],h)<0;)d++;for(;a(n[y],h)>0;)y--}a(n[i],h)===0?Rh(n,i,y):(y++,Rh(n,y,o)),y<=e&&(i=y+1),e<=y&&(o=y-1)}}function Rh(n,e,i){const o=n[e];n[e]=n[i],n[i]=o}function Td(n,e){return n<e?-1:n>e?1:0}function vm(n){let e=0;for(let i,o,a=0,h=n.length,d=h-1;a<h;d=a++)i=n[a],o=n[d],e+=(o.x-i.x)*(i.y+o.y);return e}function ac(n,e){n[0]=Math.min(n[0],e[0]),n[1]=Math.min(n[1],e[1]),n[2]=Math.max(n[2],e[0]),n[3]=Math.max(n[3],e[1])}function Rc(n,e){return!(n[0]<=e[0]||n[2]>=e[2]||n[1]<=e[1]||n[3]>=e[3])}function lc(n,e,i){const o=n[0]-e[0],a=n[1]-e[1],h=n[0]-i[0],d=n[1]-i[1];return o*d-h*a==0&&o*h<=0&&a*d<=0}function uu(n,e,i=!1){let o=!1;for(let y=0,w=e.length;y<w;y++){const T=e[y];for(let C=0,P=T.length,D=P-1;C<P;D=C++){const O=T[D],N=T[C];if(lc(n,O,N))return i;(h=O)[1]>(a=n)[1]!=(d=N)[1]>a[1]&&a[0]<(d[0]-h[0])*(a[1]-h[1])/(d[1]-h[1])+h[0]&&(o=!o)}}var a,h,d;return o}function Mf(n,e,i,o){const a=o[0]-i[0],h=o[1]-i[1],d=(n[0]-i[0])*h-a*(n[1]-i[1]),y=(e[0]-i[0])*h-a*(e[1]-i[1]);return d>0&&y<0||d<0&&y>0}function Mh(n,e,i,o){return(a=[o[0]-i[0],o[1]-i[1]])[0]*(h=[e[0]-n[0],e[1]-n[1]])[1]-a[1]*h[0]!=0&&!(!Mf(n,e,i,o)||!Mf(i,o,n,e));var a,h}function Df(n){const e=new gt(Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY),i=new gt(Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY);for(const o of n[0])e.x>o.x&&(e.x=o.x),e.y>o.y&&(e.y=o.y),i.x<o.x&&(i.x=o.x),i.y<o.y&&(i.y=o.y);return{min:e,max:i}}const Mc=8192;function xm(n,e){const i=(180+n[0])/360,o=(180-180/Math.PI*Math.log(Math.tan(Math.PI/4+n[1]*Math.PI/360)))/360,a=Math.pow(2,e.z);return[Math.round(i*a*Mc),Math.round(o*a*Mc)]}function Tp(n,e){for(let i=0;i<e.length;i++)if(uu(n,e[i]))return!0;return!1}function wm(n,e,i){for(const o of i)for(let a=0,h=o.length,d=h-1;a<h;d=a++)if(Mh(n,e,o[d],o[a]))return!0;return!1}function Wa(n,e){for(let i=0;i<n.length;++i)if(!uu(n[i],e))return!1;for(let i=0;i<n.length-1;++i)if(wm(n[i],n[i+1],e))return!1;return!0}function Hu(n,e){for(let i=0;i<e.length;i++)if(Wa(n,e[i]))return!0;return!1}function Ed(n,e,i){const o=[];for(let a=0;a<n.length;a++){const h=[];for(let d=0;d<n[a].length;d++){const y=xm(n[a][d],i);ac(e,y),h.push(y)}o.push(h)}return o}function cc(n,e,i){const o=[];for(let a=0;a<n.length;a++){const h=Ed(n[a],e,i);o.push(h)}return o}function Lf(n,e,i,o){if(n[0]<i[0]||n[0]>i[2]){const a=.5*o;let h=n[0]-i[0]>a?-o:i[0]-n[0]>a?o:0;h===0&&(h=n[0]-i[2]>a?-o:i[2]-n[0]>a?o:0),n[0]+=h}ac(e,n)}function kf(n,e,i,o){const a=Math.pow(2,o.z)*Mc,h=[o.x*Mc,o.y*Mc],d=[];if(!n)return d;for(const y of n)for(const w of y){const T=[w.x+h[0],w.y+h[1]];Lf(T,e,i,a),d.push(T)}return d}function qu(n,e,i,o){const a=Math.pow(2,o.z)*Mc,h=[o.x*Mc,o.y*Mc],d=[];if(!n)return d;for(const w of n){const T=[];for(const C of w){const P=[C.x+h[0],C.y+h[1]];ac(e,P),T.push(P)}d.push(T)}if(e[2]-e[0]<=a/2){(y=e)[0]=y[1]=1/0,y[2]=y[3]=-1/0;for(const w of d)for(const T of w)Lf(T,e,i,a)}var y;return d}class Dc{constructor(e,i){this.type=Mn,this.geojson=e,this.geometries=i}static parse(e,i){if(e.length!==2)return i.error(`'within' expression requires exactly one argument, but found ${e.length-1} instead.`);if(ui(e[1])){const o=e[1];if(o.type==="FeatureCollection")for(let a=0;a<o.features.length;++a){const h=o.features[a].geometry.type;if(h==="Polygon"||h==="MultiPolygon")return new Dc(o,o.features[a].geometry)}else if(o.type==="Feature"){const a=o.geometry.type;if(a==="Polygon"||a==="MultiPolygon")return new Dc(o,o.geometry)}else if(o.type==="Polygon"||o.type==="MultiPolygon")return new Dc(o,o)}return i.error("'within' expression requires valid geojson object that contains polygon geometry type.")}evaluate(e){if(e.geometry()!=null&&e.canonicalID()!=null){if(e.geometryType()==="Point")return(function(i,o){const a=[1/0,1/0,-1/0,-1/0],h=[1/0,1/0,-1/0,-1/0],d=i.canonicalID();if(!d)return!1;if(o.type==="Polygon"){const y=Ed(o.coordinates,h,d),w=kf(i.geometry(),a,h,d);if(!Rc(a,h))return!1;for(const T of w)if(!uu(T,y))return!1}if(o.type==="MultiPolygon"){const y=cc(o.coordinates,h,d),w=kf(i.geometry(),a,h,d);if(!Rc(a,h))return!1;for(const T of w)if(!Tp(T,y))return!1}return!0})(e,this.geometries);if(e.geometryType()==="LineString")return(function(i,o){const a=[1/0,1/0,-1/0,-1/0],h=[1/0,1/0,-1/0,-1/0],d=i.canonicalID();if(!d)return!1;if(o.type==="Polygon"){const y=Ed(o.coordinates,h,d),w=qu(i.geometry(),a,h,d);if(!Rc(a,h))return!1;for(const T of w)if(!Wa(T,y))return!1}if(o.type==="MultiPolygon"){const y=cc(o.coordinates,h,d),w=qu(i.geometry(),a,h,d);if(!Rc(a,h))return!1;for(const T of w)if(!Hu(T,y))return!1}return!0})(e,this.geometries)}return!1}eachChild(){}outputDefined(){return!0}serialize(){return["within",this.geojson]}}const Dh={kilometers:1,miles:1e3/1609.344,nauticalmiles:1e3/1852,meters:1e3,metres:1e3,yards:1e3/.9144,feet:1e3/.3048,inches:1e3/.0254},yo=1/298.257223563,Lh=yo*(2-yo),Ul=Math.PI/180;class Lc{static fromTile(e,i,o){const a=Math.PI*(1-2*(e+.5)/Math.pow(2,i)),h=Math.atan(.5*(Math.exp(a)-Math.exp(-a)))/Ul;return new Lc(h,o)}static get units(){return Dh}constructor(e,i){if(e===void 0)throw new Error("No latitude given.");if(i&&!Dh[i])throw new Error(`Unknown unit ${i}. Use one of: ${Object.keys(Dh).join(", ")}`);const o=6378.137*Ul*(i?Dh[i]:1),a=Math.cos(e*Ul),h=1/(1-Lh*(1-a*a)),d=Math.sqrt(h);this.kx=o*d*a,this.ky=o*d*h*(1-Lh)}distance(e,i){const o=uo(e[0]-i[0])*this.kx,a=(e[1]-i[1])*this.ky;return Math.sqrt(o*o+a*a)}bearing(e,i){const o=uo(i[0]-e[0])*this.kx;return Math.atan2(o,(i[1]-e[1])*this.ky)/Ul}destination(e,i,o){const a=o*Ul;return this.offset(e,Math.sin(a)*i,Math.cos(a)*i)}offset(e,i,o){return[e[0]+i/this.kx,e[1]+o/this.ky]}lineDistance(e){let i=0;for(let o=0;o<e.length-1;o++)i+=this.distance(e[o],e[o+1]);return i}area(e){let i=0;for(let o=0;o<e.length;o++){const a=e[o];for(let h=0,d=a.length,y=d-1;h<d;y=h++)i+=uo(a[h][0]-a[y][0])*(a[h][1]+a[y][1])*(o?-1:1)}return Math.abs(i)/2*this.kx*this.ky}along(e,i){let o=0;if(i<=0)return e[0];for(let a=0;a<e.length-1;a++){const h=e[a],d=e[a+1],y=this.distance(h,d);if(o+=y,o>i)return hu(h,d,(i-(o-y))/y)}return e[e.length-1]}pointToSegmentDistance(e,i,o){let[a,h]=i,d=uo(o[0]-a)*this.kx,y=(o[1]-h)*this.ky;if(d!==0||y!==0){const w=(uo(e[0]-a)*this.kx*d+(e[1]-h)*this.ky*y)/(d*d+y*y);w>1?(a=o[0],h=o[1]):w>0&&(a+=d/this.kx*w,h+=y/this.ky*w)}return d=uo(e[0]-a)*this.kx,y=(e[1]-h)*this.ky,Math.sqrt(d*d+y*y)}pointOnLine(e,i){let o=1/0,a=e[0][0],h=e[0][1],d=0,y=0;for(let w=0;w<e.length-1;w++){let T=e[w][0],C=e[w][1],P=uo(e[w+1][0]-T)*this.kx,D=(e[w+1][1]-C)*this.ky,O=0;P===0&&D===0||(O=(uo(i[0]-T)*this.kx*P+(i[1]-C)*this.ky*D)/(P*P+D*D),O>1?(T=e[w+1][0],C=e[w+1][1]):O>0&&(T+=P/this.kx*O,C+=D/this.ky*O)),P=uo(i[0]-T)*this.kx,D=(i[1]-C)*this.ky;const N=P*P+D*D;N<o&&(o=N,a=T,h=C,d=w,y=O)}return{point:[a,h],index:d,t:Math.max(0,Math.min(1,y))}}lineSlice(e,i,o){let a=this.pointOnLine(o,e),h=this.pointOnLine(o,i);if(a.index>h.index||a.index===h.index&&a.t>h.t){const T=a;a=h,h=T}const d=[a.point],y=a.index+1,w=h.index;!Sd(o[y],d[0])&&y<=w&&d.push(o[y]);for(let T=y+1;T<=w;T++)d.push(o[T]);return Sd(o[w],h.point)||d.push(h.point),d}lineSliceAlong(e,i,o){let a=0;const h=[];for(let d=0;d<o.length-1;d++){const y=o[d],w=o[d+1],T=this.distance(y,w);if(a+=T,a>e&&h.length===0&&h.push(hu(y,w,(e-(a-T))/T)),a>=i)return h.push(hu(y,w,(i-(a-T))/T)),h;a>e&&h.push(w)}return h}bufferPoint(e,i){const o=i/this.ky,a=i/this.kx;return[e[0]-a,e[1]-o,e[0]+a,e[1]+o]}bufferBBox(e,i){const o=i/this.ky,a=i/this.kx;return[e[0]-a,e[1]-o,e[2]+a,e[3]+o]}insideBBox(e,i){return uo(e[0]-i[0])>=0&&uo(e[0]-i[2])<=0&&e[1]>=i[1]&&e[1]<=i[3]}}function Sd(n,e){return n[0]===e[0]&&n[1]===e[1]}function hu(n,e,i){const o=uo(e[0]-n[0]);return[n[0]+o*i,n[1]+(e[1]-n[1])*i]}function uo(n){for(;n<-180;)n+=360;for(;n>180;)n-=360;return n}class $u{constructor(e=[],i=((o,a)=>o<a?-1:o>a?1:0)){if(this.data=e,this.length=this.data.length,this.compare=i,this.length>0)for(let o=(this.length>>1)-1;o>=0;o--)this._down(o)}push(e){this.data.push(e),this._up(this.length++)}pop(){if(this.length===0)return;const e=this.data[0],i=this.data.pop();return--this.length>0&&(this.data[0]=i,this._down(0)),e}peek(){return this.data[0]}_up(e){const{data:i,compare:o}=this,a=i[e];for(;e>0;){const h=e-1>>1,d=i[h];if(o(a,d)>=0)break;i[e]=d,e=h}i[e]=a}_down(e){const{data:i,compare:o}=this,a=this.length>>1,h=i[e];for(;e<a;){let d=1+(e<<1);const y=d+1;if(y<this.length&&o(i[y],i[d])<0&&(d=y),o(i[d],h)>=0)break;i[e]=i[d],e=d}i[e]=h}}var zt=8192;function Wu(n,e){return e.dist-n.dist}const kh=100,zh=50;function Zu(n){const e=[1/0,1/0,-1/0,-1/0];if(e.length!==n.length)return!1;for(let i=0;i<e.length;i++)if(e[i]!==n[i])return!1;return!0}function kc(n){return n[1]-n[0]+1}function Ea(n,e){const i=n[1]>=n[0]&&n[1]<e;return i||console.warn("Distance Expression: Index is out of range"),i}function Fh(n,e){if(n[0]>n[1])return[null,null];const i=kc(n);if(e){if(i===2)return[n,null];const o=Math.floor(i/2);return[[n[0],n[0]+o],[n[0]+o,n[1]]]}{if(i===1)return[n,null];const o=Math.floor(i/2)-1;return[[n[0],n[0]+o],[n[0]+o+1,n[1]]]}}function qo(n,e){const i=[1/0,1/0,-1/0,-1/0];if(!Ea(e,n.length))return i;for(let o=e[0];o<=e[1];++o)ac(i,n[o]);return i}function du(n){const e=[1/0,1/0,-1/0,-1/0];for(let i=0;i<n.length;++i)for(let o=0;o<n[i].length;++o)ac(e,n[i][o]);return e}function Sa(n,e,i){if(Zu(n)||Zu(e))return NaN;let o=0,a=0;return n[2]<e[0]&&(o=e[0]-n[2]),n[0]>e[2]&&(o=n[0]-e[2]),n[1]>e[3]&&(a=n[1]-e[3]),n[3]<e[1]&&(a=e[1]-n[3]),i.distance([0,0],[o,a])}function fn(n){return 360*n-180}function bm(n){return 360/Math.PI*Math.atan(Math.exp((180-360*n)*Math.PI/180))-90}function fu(n,e){const i=Math.pow(2,e.z),o=(n.y/zt+e.y)/i;return[fn((n.x/zt+e.x)/i),bm(o)]}function Tm(n,e){const i=[];for(let o=0;o<n.length;++o)i.push(fu(n[o],e));return i}function Id(n,e,i){const o=i.pointOnLine(e,n).point;return i.distance(n,o)}function zf(n,e,i,o,a){const h=i.slice(o[0],o[1]+1);let d=1/0;for(let y=e[0];y<=e[1];++y)if((d=Math.min(d,Id(n[y],h,a)))===0)return 0;return d}function rn(n,e,i,o,a){const h=Math.min(a.pointToSegmentDistance(n,i,o),a.pointToSegmentDistance(e,i,o)),d=Math.min(a.pointToSegmentDistance(i,n,e),a.pointToSegmentDistance(o,n,e));return Math.min(h,d)}function Ff(n,e,i,o,a){if(!Ea(e,n.length)||!Ea(o,i.length))return NaN;let h=1/0;for(let d=e[0];d<e[1];++d)for(let y=o[0];y<o[1];++y){if(Mh(n[d],n[d+1],i[y],i[y+1]))return 0;h=Math.min(h,rn(n[d],n[d+1],i[y],i[y+1],a))}return h}function Ad(n,e,i,o,a){if(!Ea(e,n.length)||!Ea(o,i.length))return NaN;let h=1/0;for(let d=e[0];d<=e[1];++d)for(let y=o[0];y<=o[1];++y)if((h=Math.min(h,a.distance(n[d],i[y])))===0)return h;return h}function Oh(n,e,i){if(uu(n,e,!0))return 0;let o=1/0;for(const a of e){const h=a.length;if(h<2)return console.warn("Distance Expression: Invalid polygon!"),NaN;if(a[0]!==a[h-1]&&(o=Math.min(o,i.pointToSegmentDistance(n,a[h-1],a[0])))===0||(o=Math.min(o,Id(n,a,i)))===0)return o}return o}function Ep(n,e,i,o){if(!Ea(e,n.length))return NaN;for(let h=e[0];h<=e[1];++h)if(uu(n[h],i,!0))return 0;let a=1/0;for(let h=e[0];h<e[1];++h)for(const d of i)for(let y=0,w=d.length,T=w-1;y<w;T=y++){if(Mh(n[h],n[h+1],d[T],d[y]))return 0;a=Math.min(a,rn(n[h],n[h+1],d[T],d[y],o))}return a}function Cd(n,e){for(const i of n)for(let o=0;o<=i.length-1;++o)if(uu(i[o],e,!0))return!0;return!1}function Bh(n,e,i,o=1/0){const a=du(n),h=du(e);if(o!==1/0&&Sa(a,h,i)>=o)return o;if(Rc(a,h)){if(Cd(n,e))return 0}else if(Cd(e,n))return 0;let d=o;for(const y of n)for(let w=0,T=y.length,C=T-1;w<T;C=w++)for(const P of e)for(let D=0,O=P.length,N=O-1;D<O;N=D++){if(Mh(y[C],y[w],P[N],P[D]))return 0;d=Math.min(d,rn(y[C],y[w],P[N],P[D],i))}return d}function pu(n,e,i,o,a,h,d){if(h===null||d===null)return;const y=Sa(qo(o,h),qo(a,d),i);y<e&&n.push({dist:y,range1:h,range2:d})}function Xu(n,e,i,o,a=1/0){let h=Math.min(o.distance(n[0],i[0][0]),a);if(h===0)return h;const d=new $u([{dist:0,range1:[0,n.length-1],range2:[0,0]}],Wu),y=e?zh:kh,w=du(i);for(;d.length;){const T=d.pop();if(T.dist>=h)continue;const C=T.range1;if(kc(C)<=y){if(!Ea(C,n.length))return NaN;if(e){const P=Ep(n,C,i,o);if((h=Math.min(h,P))===0)return h}else for(let P=C[0];P<=C[1];++P){const D=Oh(n[P],i,o);if((h=Math.min(h,D))===0)return h}}else{const P=Fh(C,e);if(P[0]!==null){const D=Sa(qo(n,P[0]),w,o);D<h&&d.push({dist:D,range1:P[0],range2:[0,0]})}if(P[1]!==null){const D=Sa(qo(n,P[1]),w,o);D<h&&d.push({dist:D,range1:P[1],range2:[0,0]})}}}return h}function Of(n,e,i,o,a,h=1/0){let d=Math.min(h,a.distance(n[0],i[0]));if(d===0)return d;const y=new $u([{dist:0,range1:[0,n.length-1],range2:[0,i.length-1]}],Wu),w=e?zh:kh,T=o?zh:kh;for(;y.length;){const C=y.pop();if(C.dist>=d)continue;const P=C.range1,D=C.range2;if(kc(P)<=w&&kc(D)<=T){if(!Ea(P,n.length)||!Ea(D,i.length))return NaN;if(e&&o?d=Math.min(d,Ff(n,P,i,D,a)):e||o?e&&!o?d=Math.min(d,zf(i,D,n,P,a)):!e&&o&&(d=Math.min(d,zf(n,P,i,D,a))):d=Math.min(d,Ad(n,P,i,D,a)),d===0)return d}else{const O=Fh(P,e),N=Fh(D,o);pu(y,d,a,n,i,O[0],N[0]),pu(y,d,a,n,i,O[0],N[1]),pu(y,d,a,n,i,O[1],N[0]),pu(y,d,a,n,i,O[1],N[1])}}return d}function Bf(n,e,i,o,a=1/0){let h=a;const d=qo(n,[0,n.length-1]);for(const y of i)if(!(h!==1/0&&Sa(d,qo(y,[0,y.length-1]),o)>=h)&&(h=Math.min(h,Of(n,e,y,!0,o,h)),h===0))return h;return h}function Pd(n,e,i,o,a=1/0){let h=a;const d=qo(n,[0,n.length-1]);for(const y of i){if(h!==1/0&&Sa(d,du(y),o)>=h)continue;const w=Xu(n,e,y,o,h);if(isNaN(w))return w;if((h=Math.min(h,w))===0)return h}return h}function Rd(n){return n==="Point"||n==="MultiPoint"||n==="LineString"||n==="MultiLineString"||n==="Polygon"||n==="MultiPolygon"}class jl{constructor(e,i){this.type=ni,this.geojson=e,this.geometries=i}static parse(e,i){if(e.length!==2)return i.error(`'distance' expression requires either one argument, but found ' ${e.length-1} instead.`);if(ui(e[1])){const o=e[1];if(o.type==="FeatureCollection"){for(let a=0;a<o.features.length;++a)if(Rd(o.features[a].geometry.type))return new jl(o,o.features[a].geometry)}else if(o.type==="Feature"){if(Rd(o.geometry.type))return new jl(o,o.geometry)}else if(Rd(o.type))return new jl(o,o)}return i.error("'distance' expression needs to be an array with format ['Distance', GeoJSONObj].")}evaluate(e){const i=e.geometry(),o=e.canonicalID();if(i!=null&&o!=null){if(e.geometryType()==="Point")return(function(a,h,d){const y=[];for(const T of a)for(const C of T)y.push(fu(C,h));const w=new Lc(y[0][1],"meters");return d.type==="Point"||d.type==="MultiPoint"||d.type==="LineString"?Of(y,!1,d.type==="Point"?[d.coordinates]:d.coordinates,d.type==="LineString",w):d.type==="MultiLineString"?Bf(y,!1,d.coordinates,w):d.type==="Polygon"||d.type==="MultiPolygon"?Pd(y,!1,d.type==="Polygon"?[d.coordinates]:d.coordinates,w):null})(i,o,this.geometries);if(e.geometryType()==="LineString")return(function(a,h,d){const y=[];for(const T of a){const C=[];for(const P of T)C.push(fu(P,h));y.push(C)}const w=new Lc(y[0][0][1],"meters");if(d.type==="Point"||d.type==="MultiPoint"||d.type==="LineString")return Bf(d.type==="Point"?[d.coordinates]:d.coordinates,d.type==="LineString",y,w);if(d.type==="MultiLineString"){let T=1/0;for(let C=0;C<d.coordinates.length;C++){const P=Bf(d.coordinates[C],!0,y,w,T);if(isNaN(P))return P;if((T=Math.min(T,P))===0)return T}return T}if(d.type==="Polygon"||d.type==="MultiPolygon"){let T=1/0;for(let C=0;C<y.length;C++){const P=Pd(y[C],!0,d.type==="Polygon"?[d.coordinates]:d.coordinates,w,T);if(isNaN(P))return P;if((T=Math.min(T,P))===0)return T}return T}return null})(i,o,this.geometries);if(e.geometryType()==="Polygon")return(function(a,h,d){const y=[];for(const T of(function(C,P){const D=C.length;if(D<=1)return[C];const O=[];let N,G;for(let q=0;q<D;q++){const Y=vm(C[q]);Y!==0&&(C[q].area=Math.abs(Y),G===void 0&&(G=Y<0),G===Y<0?(N&&O.push(N),N=[C[q]]):N.push(C[q]))}return N&&O.push(N),O})(a)){const C=[];for(let P=0;P<T.length;++P)C.push(Tm(T[P],h));y.push(C)}const w=new Lc(y[0][0][0][1],"meters");if(d.type==="Point"||d.type==="MultiPoint"||d.type==="LineString")return Pd(d.type==="Point"?[d.coordinates]:d.coordinates,d.type==="LineString",y,w);if(d.type==="MultiLineString"){let T=1/0;for(let C=0;C<d.coordinates.length;C++){const P=Pd(d.coordinates[C],!0,y,w,T);if(isNaN(P))return P;if((T=Math.min(T,P))===0)return T}return T}return d.type==="Polygon"||d.type==="MultiPolygon"?(function(T,C,P){let D=1/0;for(const O of T)for(const N of C){const G=Bh(O,N,P,D);if(isNaN(G))return G;if((D=Math.min(D,G))===0)return D}return D})(d.type==="Polygon"?[d.coordinates]:d.coordinates,y,w):null})(i,o,this.geometries);console.warn("Distance Expression: currently only evaluates valid Point/LineString/Polygon geometries.")}else console.warn("Distance Expression: requirs valid feature and canonical information.");return null}eachChild(){}outputDefined(){return!0}serialize(){return["distance",this.geojson]}}function uc(n){if(n instanceof Ms&&(n.name==="get"&&n.args.length===1||n.name==="feature-state"||n.name==="has"&&n.args.length===1||n.name==="properties"||n.name==="geometry-type"||n.name==="id"||/^filter-/.test(n.name))||n instanceof Dc||n instanceof jl)return!1;if(n instanceof Qu)return n.featureConstant;let e=!0;return n.eachChild((i=>{e&&!uc(i)&&(e=!1)})),e}function Ku(n){if(n instanceof Ms&&n.name==="feature-state")return!1;let e=!0;return n.eachChild((i=>{e&&!Ku(i)&&(e=!1)})),e}function Yu(n){if(n instanceof Qu)return new Set([n.key]);let e=new Set;return n.eachChild((i=>{e=new Set([...e,...Yu(i)])})),e}function zc(n,e){if(n instanceof Ms&&e.indexOf(n.name)>=0)return!1;let i=!0;return n.eachChild((o=>{i&&!zc(o,e)&&(i=!1)})),i}function Md(n,e,i){return[n,e,i].filter(Boolean).join("")}function Nf(n,e){switch(n){case"string":return Ur(e);case"number":return+e;case"boolean":return!!e;case"color":return un.parse(e);case"formatted":return Mt.fromString(Ur(e));case"resolvedImage":return Yn.build(Ur(e))}return e}function Vf(n,e,i,o){return o!==void 0&&(n=o*Math.round(n/o)),e!==void 0&&n<e&&(n=e),i!==void 0&&n>i&&(n=i),n}class Qu{constructor(e,i,o,a=!1){this.type=e,this.key=i,this.scope=o,this.featureConstant=a}static parse(e,i){let o=i.expectedType;if(o==null&&(o=On),e.length<2||e.length>3)return i.error("Invalid number of arguments for 'config' expression.");const a=i.parse(e[1],1);if(!(a instanceof _i))return i.error("Key name of 'config' expression must be a string literal.");let h,d=!0;const y=Ur(a.value);if(e.length>=3){const w=i.parse(e[2],2);if(!(w instanceof _i))return i.error("Scope of 'config' expression must be a string literal.");h=Ur(w.value)}if(i.options){const w=Md(y,h,i._scope),T=i.options.get(w);T&&(d=uc(T.value||T.default))}return new Qu(o,y,h,d)}evaluate(e){const i=Md(this.key,this.scope,e.scope),o=e.getConfig(i);if(!o)return null;const{type:a,value:h,values:d,minValue:y,maxValue:w,stepValue:T}=o,C=o.default.evaluate(e);let P=C;if(h){const D=e.scope;e.scope=(D||"").split("").slice(1).join(""),P=h.evaluate(e),e.scope=D}return a&&(P=Nf(a,P)),P===void 0||y===void 0&&w===void 0&&T===void 0||(typeof P=="number"?P=Vf(P,y,w,T):Array.isArray(P)&&(P=P.map((D=>typeof D=="number"?Vf(D,y,w,T):D)))),h!==void 0&&P!==void 0&&d&&!d.includes(P)&&(P=C,a&&(P=Nf(a,P))),(a&&a!==this.type||P!==void 0&&!ie(Vt(P),this.type))&&(P=Nf(this.type.kind,P)),P}eachChild(){}outputDefined(){return!1}serialize(){const e=["config",this.key];return this.scope&&e.concat(this.scope),e}}class Dd{constructor(e,i){this.type=i.type,this.name=e,this.boundExpression=i}static parse(e,i){if(e.length!==2||typeof e[1]!="string")return i.error("'var' expression requires exactly one string literal argument.");const o=e[1];return i.scope.has(o)?new Dd(o,i.scope.get(o)):i.error(`Unknown variable "${o}". Make sure "${o}" has been bound in an enclosing "let" expression before using it.`,1)}evaluate(e){return this.boundExpression.evaluate(e)}eachChild(){}outputDefined(){return!1}serialize(){return["var",this.name]}}class Ju{constructor(e,i=[],o,a=new su,h=[],d,y){this.registry=e,this.path=i,this.key=i.map((w=>typeof w=="string"?`['${w}']`:`[${w}]`)).join(""),this.scope=a,this.errors=h,this.expectedType=o,this._scope=d,this.options=y}parse(e,i,o,a,h={}){return i||o?this.concat(i,null,o,a)._parse(e,h):this._parse(e,h)}parseObjectValue(e,i,o,a,h,d={}){return this.concat(i,o,a,h)._parse(e,d)}_parse(e,i){function o(a,h,d){return d==="assert"?new gi(h,[a]):d==="coerce"?new $a(h,[a]):a}if(e!==null&&typeof e!="string"&&typeof e!="boolean"&&typeof e!="number"||(e=["literal",e]),Array.isArray(e)){if(e.length===0)return this.error('Expected an array with at least one element. If you wanted a literal array, use ["literal", []].');const a=typeof e[0]=="string"?this.registry[e[0]]:void 0;if(a){let h=a.parse(e,this);if(!h)return null;if(this.expectedType){const d=this.expectedType,y=h.type;if(d.kind!=="string"&&d.kind!=="number"&&d.kind!=="boolean"&&d.kind!=="object"&&d.kind!=="array"||y.kind!=="value")if(d.kind!=="color"&&d.kind!=="formatted"&&d.kind!=="resolvedImage"||y.kind!=="value"&&y.kind!=="string"){if(this.checkSubtype(d,y))return null}else h=o(h,d,i.typeAnnotation||"coerce");else h=o(h,d,i.typeAnnotation||"assert")}if(!(h instanceof _i)&&h.type.kind!=="resolvedImage"&&Gl(h)){const d=new Ph(this._scope,this.options);try{h=new _i(h.type,h.evaluate(d))}catch(y){return this.error(y.message),null}}return h}return $a.parse(["to-array",e],this)}return this.error(e===void 0?"'undefined' value invalid. Use null instead.":typeof e=="object"?'Bare objects invalid. Use ["literal", {...}] instead.':`Expected an array, but found ${typeof e} instead.`)}concat(e,i,o,a){let h=typeof e=="number"?this.path.concat(e):this.path;h=typeof i=="string"?h.concat(i):h;const d=a?this.scope.concat(a):this.scope;return new Ju(this.registry,h,o||null,d,this.errors,this._scope,this.options)}error(e,...i){const o=`${this.key}${i.map((a=>`[${a}]`)).join("")}`;this.errors.push(new co(o,e))}checkSubtype(e,i){const o=Ho(e,i);return o&&this.error(o),o}}function Gl(n){if(n instanceof Dd)return Gl(n.boundExpression);if(n instanceof Ms&&n.name==="error"||n instanceof ta||n instanceof Dc||n instanceof jl||n instanceof Qu)return!1;const e=n instanceof $a||n instanceof gi;let i=!0;return n.eachChild((o=>{i=e?i&&Gl(o):i&&o instanceof _i})),!!i&&uc(n)&&zc(n,["zoom","heatmap-density","worldview","line-progress","raster-value","sky-radial-progress","accumulated","is-supported-script","pitch","distance-from-center","measure-light","raster-particle-speed"])}function Nh(n,e){const i=n.length-1;let o,a,h=0,d=i,y=0;for(;h<=d;)if(y=Math.floor((h+d)/2),o=n[y],a=n[y+1],o<=e){if(y===i||e<a)return y;h=y+1}else{if(!(o>e))throw new gr("Input is not a number.");d=y-1}return 0}class Hl{constructor(e,i,o){this.type=e,this.input=i,this.labels=[],this.outputs=[];for(const[a,h]of o)this.labels.push(a),this.outputs.push(h)}static parse(e,i){if(e.length-1<4)return i.error(`Expected at least 4 arguments, but found only ${e.length-1}.`);if((e.length-1)%2!=0)return i.error("Expected an even number of arguments.");const o=i.parse(e[1],1,ni);if(!o)return null;const a=[];let h=null;i.expectedType&&i.expectedType.kind!=="value"&&(h=i.expectedType);for(let d=1;d<e.length;d+=2){const y=d===1?-1/0:e[d],w=e[d+1],T=d,C=d+1;if(typeof y!="number")return i.error('Input/output pairs for "step" expressions must be defined using literal numeric values (not computed expressions) for the input values.',T);if(a.length&&a[a.length-1][0]>=y)return i.error('Input/output pairs for "step" expressions must be arranged with input values in strictly ascending order.',T);const P=i.parse(w,C,h);if(!P)return null;h=h||P.type,a.push([y,P])}return new Hl(h,o,a)}evaluate(e){const i=this.labels,o=this.outputs;if(i.length===1)return o[0].evaluate(e);const a=this.input.evaluate(e);if(a<=i[0])return o[0].evaluate(e);const h=i.length;return a>=i[h-1]?o[h-1].evaluate(e):o[Nh(i,a)].evaluate(e)}eachChild(e){e(this.input);for(const i of this.outputs)e(i)}outputDefined(){return this.outputs.every((e=>e.outputDefined()))}serialize(){const e=["step",this.input.serialize()];for(let i=0;i<this.labels.length;i++)i>0&&e.push(this.labels[i]),e.push(this.outputs[i].serialize());return e}}const fl=.95047,eh=1.08883,ql=4/29,Fc=6/29,Sp=3*Fc*Fc,Uf=Fc*Fc*Fc,mu=Math.PI/180,th=180/Math.PI;function Oc(n){return n>Uf?Math.pow(n,1/3):n/Sp+ql}function ih(n){return n>Fc?n*n*n:Sp*(n-ql)}function Vh(n){return 255*(n<=.0031308?12.92*n:1.055*Math.pow(n,1/2.4)-.055)}function hc(n){return(n/=255)<=.04045?n/12.92:Math.pow((n+.055)/1.055,2.4)}function $l(n){const e=hc(n.r),i=hc(n.g),o=hc(n.b),a=Oc((.4124564*e+.3575761*i+.1804375*o)/fl),h=Oc((.2126729*e+.7151522*i+.072175*o)/1);return{l:116*h-16,a:500*(a-h),b:200*(h-Oc((.0193339*e+.119192*i+.9503041*o)/eh)),alpha:n.a}}function jr(n){let e=(n.l+16)/116,i=isNaN(n.a)?e:e+n.a/500,o=isNaN(n.b)?e:e-n.b/200;return e=1*ih(e),i=fl*ih(i),o=eh*ih(o),new un(Vh(3.2404542*i-1.5371385*e-.4985314*o),Vh(-.969266*i+1.8760108*e+.041556*o),Vh(.0556434*i-.2040259*e+1.0572252*o),n.alpha)}function os(n,e,i){const o=e-n;return n+i*(o>180||o<-180?o-360*Math.round(o/360):o)}const Ia={forward:$l,reverse:jr,interpolate:function(n,e,i){return{l:di(n.l,e.l,i),a:di(n.a,e.a,i),b:di(n.b,e.b,i),alpha:di(n.alpha,e.alpha,i)}}},Us={forward:function(n){const{l:e,a:i,b:o}=$l(n),a=Math.atan2(o,i)*th;return{h:a<0?a+360:a,c:Math.sqrt(i*i+o*o),l:e,alpha:n.a}},reverse:function(n){const e=n.h*mu,i=n.c;return jr({l:n.l,a:Math.cos(e)*i,b:Math.sin(e)*i,alpha:n.alpha})},interpolate:function(n,e,i){return{h:os(n.h,e.h,i),c:di(n.c,e.c,i),l:di(n.l,e.l,i),alpha:di(n.alpha,e.alpha,i)}}};var vo=Object.freeze({__proto__:null,hcl:Us,lab:Ia});class Ls{constructor(e,i,o,a,h){this.type=e,this.operator=i,this.interpolation=o,this.input=a,this.labels=[],this.outputs=[];for(const[d,y]of h)this.labels.push(d),this.outputs.push(y)}static interpolationFactor(e,i,o,a){let h=0;if(e.name==="exponential")h=Bc(i,e.base,o,a);else if(e.name==="linear")h=Bc(i,1,o,a);else if(e.name==="cubic-bezier"){const d=e.controlPoints;h=new No(d[0],d[1],d[2],d[3]).solve(Bc(i,1,o,a))}return h}static parse(e,i){let[o,a,h,...d]=e;if(!Array.isArray(a)||a.length===0)return i.error("Expected an interpolation type expression.",1);if(a[0]==="linear")a={name:"linear"};else if(a[0]==="exponential"){const T=a[1];if(typeof T!="number")return i.error("Exponential interpolation requires a numeric base.",1,1);a={name:"exponential",base:T}}else{if(a[0]!=="cubic-bezier")return i.error(`Unknown interpolation type ${String(a[0])}`,1,0);{const T=a.slice(1);if(T.length!==4||T.some((C=>typeof C!="number"||C<0||C>1)))return i.error("Cubic bezier interpolation requires four numeric arguments with values between 0 and 1.",1);a={name:"cubic-bezier",controlPoints:T}}}if(e.length-1<4)return i.error(`Expected at least 4 arguments, but found only ${e.length-1}.`);if(e.length-1>3&&(e.length-1)%2!=0)return i.error("Expected an even number of arguments.");if(h=i.parse(h,2,ni),!h)return null;const y=[];let w=null;o==="interpolate-hcl"||o==="interpolate-lab"?w=Cs:i.expectedType&&i.expectedType.kind!=="value"&&(w=i.expectedType);for(let T=0;T<d.length;T+=2){const C=d[T],P=d[T+1],D=T+3,O=T+4;if(typeof C!="number")return i.error('Input/output pairs for "interpolate" expressions must be defined using literal numeric values (not computed expressions) for the input values.',D);if(y.length&&y[y.length-1][0]>=C)return i.error('Input/output pairs for "interpolate" expressions must be arranged with input values in strictly ascending order.',D);const N=i.parse(P,O,w);if(!N)return null;w=w||N.type,y.push([C,N])}return w.kind==="number"||w.kind==="color"||w.kind==="array"&&w.itemType.kind==="number"&&typeof w.N=="number"?new Ls(w,o,a,h,y):i.error(`Type ${ss(w)} is not interpolatable.`)}evaluate(e){const i=this.labels,o=this.outputs;if(i.length===1)return o[0].evaluate(e);const a=this.input.evaluate(e);if(a<=i[0])return o[0].evaluate(e);const h=i.length;if(a>=i[h-1])return o[h-1].evaluate(e);const d=Nh(i,a),y=Ls.interpolationFactor(this.interpolation,a,i[d],i[d+1]),w=o[d].evaluate(e),T=o[d+1].evaluate(e);return this.operator==="interpolate"?Ha[this.type.kind.toLowerCase()](w,T,y):this.operator==="interpolate-hcl"?Us.reverse(Us.interpolate(Us.forward(w),Us.forward(T),y)):Ia.reverse(Ia.interpolate(Ia.forward(w),Ia.forward(T),y))}eachChild(e){e(this.input);for(const i of this.outputs)e(i)}outputDefined(){return this.outputs.every((e=>e.outputDefined()))}serialize(){let e;e=this.interpolation.name==="linear"?["linear"]:this.interpolation.name==="exponential"?this.interpolation.base===1?["linear"]:["exponential",this.interpolation.base]:["cubic-bezier",...this.interpolation.controlPoints];const i=[this.operator,e,this.input.serialize()];for(let o=0;o<this.labels.length;o++)i.push(this.labels[o],this.outputs[o].serialize());return i}}function Bc(n,e,i,o){const a=o-i,h=n-i;return a===0?0:e===1?h/a:(Math.pow(e,h)-1)/(Math.pow(e,a)-1)}class xo{constructor(e,i){this.type=e,this.args=i}static parse(e,i){if(e.length<2)return i.error("Expectected at least one argument.");let o=null;const a=i.expectedType;a&&a.kind!=="value"&&(o=a);const h=[];for(const y of e.slice(1)){const w=i.parse(y,1+h.length,o,void 0,{typeAnnotation:"omit"});if(!w)return null;o=o||w.type,h.push(w)}const d=a&&h.some((y=>Ho(a,y.type)));return new xo(d?On:o,h)}evaluate(e){let i,o=null,a=0;for(const h of this.args){if(a++,o=h.evaluate(e),o&&o instanceof Yn&&!o.available&&(i||(i=o),o=null,a===this.args.length))return i;if(o!==null)break}return o}eachChild(e){this.args.forEach(e)}outputDefined(){return this.args.every((e=>e.outputDefined()))}serialize(){const e=["coalesce"];return this.eachChild((i=>{e.push(i.serialize())})),e}}class Nc{constructor(e,i){this.type=i.type,this.bindings=[].concat(e),this.result=i}evaluate(e){return this.result.evaluate(e)}eachChild(e){for(const i of this.bindings)e(i[1]);e(this.result)}static parse(e,i){if(e.length<4)return i.error(`Expected at least 3 arguments, but found ${e.length-1} instead.`);const o=[];for(let h=1;h<e.length-1;h+=2){const d=e[h];if(typeof d!="string")return i.error(`Expected string, but found ${typeof d} instead.`,h);if(/[^a-zA-Z0-9_]/.test(d))return i.error("Variable names must contain only alphanumeric characters or '_'.",h);const y=i.parse(e[h+1],h+1);if(!y)return null;o.push([d,y])}const a=i.parse(e[e.length-1],e.length-1,i.expectedType,o);return a?new Nc(o,a):null}outputDefined(){return this.result.outputDefined()}serialize(){const e=["let"];for(const[i,o]of this.bindings)e.push(i,o.serialize());return e.push(this.result.serialize()),e}}class Uh{constructor(e,i,o){this.type=e,this.index=i,this.input=o}static parse(e,i){if(e.length!==3)return i.error(`Expected 2 arguments, but found ${e.length-1} instead.`);const o=i.parse(e[1],1,ni),a=i.parse(e[2],2,Vr(i.expectedType||On));return o&&a?new Uh(a.type.itemType,o,a):null}evaluate(e){const i=this.index.evaluate(e),o=this.input.evaluate(e);if(i<0)throw new gr(`Array index out of bounds: ${i} < 0.`);if(i>=o.length)throw new gr(`Array index out of bounds: ${i} > ${o.length-1}.`);if(i!==Math.floor(i))throw new gr(`Array index must be an integer, but found ${i} instead. Use at-interpolated to retrieve interpolated result with a fractional index.`);return o[i]}eachChild(e){e(this.index),e(this.input)}outputDefined(){return!1}serialize(){return["at",this.index.serialize(),this.input.serialize()]}}class Ld{constructor(e,i,o){this.type=e,this.index=i,this.input=o}static parse(e,i){if(e.length!==3)return i.error(`Expected 2 arguments, but found ${e.length-1} instead.`);const o=i.parse(e[1],1,ni),a=i.parse(e[2],2,Vr(i.expectedType||On));return o&&a?new Ld(a.type.itemType,o,a):null}evaluate(e){const i=this.index.evaluate(e),o=this.input.evaluate(e);if(i<0)throw new gr(`Array index out of bounds: ${i} < 0.`);if(i>o.length-1)throw new gr(`Array index out of bounds: ${i} > ${o.length-1}.`);if(i===Math.floor(i))return o[i];const a=Math.floor(i),h=Math.ceil(i),d=o[a],y=o[h];if(typeof d!="number"||typeof y!="number")throw new gr(`Cannot interpolate between non-number values at index ${i}.`);const w=i-a;return d*(1-w)+y*w}eachChild(e){e(this.index),e(this.input)}outputDefined(){return!1}serialize(){return["at-interpolated",this.index.serialize(),this.input.serialize()]}}class nh{constructor(e,i){this.type=Mn,this.needle=e,this.haystack=i}static parse(e,i){if(e.length!==3)return i.error(`Expected 2 arguments, but found ${e.length-1} instead.`);const o=i.parse(e[1],1,On),a=i.parse(e[2],2,On);return o&&a?R(o.type,[Mn,bn,ni,rc,On])?new nh(o,a):i.error(`Expected first argument to be of type boolean, string, number or null, but found ${ss(o.type)} instead`):null}evaluate(e){const i=this.needle.evaluate(e),o=this.haystack.evaluate(e);if(o==null)return!1;if(!W(i,["boolean","string","number","null"]))throw new gr(`Expected first argument to be of type boolean, string, number or null, but found ${ss(Vt(i))} instead.`);if(!W(o,["string","array"]))throw new gr(`Expected second argument to be of type array or string, but found ${ss(Vt(o))} instead.`);return o.indexOf(i)>=0}eachChild(e){e(this.needle),e(this.haystack)}outputDefined(){return!0}serialize(){return["in",this.needle.serialize(),this.haystack.serialize()]}}class jh{constructor(e,i,o){this.type=ni,this.needle=e,this.haystack=i,this.fromIndex=o}static parse(e,i){if(e.length<=2||e.length>=5)return i.error(`Expected 3 or 4 arguments, but found ${e.length-1} instead.`);const o=i.parse(e[1],1,On),a=i.parse(e[2],2,On);if(!o||!a)return null;if(!R(o.type,[Mn,bn,ni,rc,On]))return i.error(`Expected first argument to be of type boolean, string, number or null, but found ${ss(o.type)} instead`);if(e.length===4){const h=i.parse(e[3],3,ni);return h?new jh(o,a,h):null}return new jh(o,a)}evaluate(e){const i=this.needle.evaluate(e),o=this.haystack.evaluate(e);if(!W(i,["boolean","string","number","null"]))throw new gr(`Expected first argument to be of type boolean, string, number or null, but found ${ss(Vt(i))} instead.`);if(!W(o,["string","array"]))throw new gr(`Expected second argument to be of type array or string, but found ${ss(Vt(o))} instead.`);if(this.fromIndex){const a=this.fromIndex.evaluate(e);return o.indexOf(i,a)}return o.indexOf(i)}eachChild(e){e(this.needle),e(this.haystack),this.fromIndex&&e(this.fromIndex)}outputDefined(){return!1}serialize(){if(this.fromIndex!=null&&this.fromIndex!==void 0){const e=this.fromIndex.serialize();return["index-of",this.needle.serialize(),this.haystack.serialize(),e]}return["index-of",this.needle.serialize(),this.haystack.serialize()]}}class Za{constructor(e,i,o,a,h,d){this.inputType=e,this.type=i,this.input=o,this.cases=a,this.outputs=h,this.otherwise=d}static parse(e,i){if(e.length<5)return i.error(`Expected at least 4 arguments, but found only ${e.length-1}.`);if(e.length%2!=1)return i.error("Expected an even number of arguments.");let o,a;i.expectedType&&i.expectedType.kind!=="value"&&(a=i.expectedType);const h={},d=[];for(let T=2;T<e.length-1;T+=2){let C=e[T];const P=e[T+1];Array.isArray(C)||(C=[C]);const D=i.concat(T);if(C.length===0)return D.error("Expected at least one branch label.");for(const N of C){if(typeof N!="number"&&typeof N!="string")return D.error("Branch labels must be numbers or strings.");if(typeof N=="number"&&Math.abs(N)>Number.MAX_SAFE_INTEGER)return D.error(`Branch labels must be integers no larger than ${Number.MAX_SAFE_INTEGER}.`);if(typeof N=="number"&&Math.floor(N)!==N)return D.error("Numeric branch labels must be integer values.");if(o){if(D.checkSubtype(o,Vt(N)))return null}else o=Vt(N);if(h[String(N)]!==void 0)return D.error("Branch labels must be unique.");h[String(N)]=d.length}const O=i.parse(P,T,a);if(!O)return null;a=a||O.type,d.push(O)}const y=i.parse(e[1],1,On);if(!y)return null;const w=i.parse(e[e.length-1],e.length-1,a);return w?y.type.kind!=="value"&&i.concat(1).checkSubtype(o,y.type)?null:new Za(o,a,y,h,d,w):null}evaluate(e){const i=this.input.evaluate(e);return(ie(Vt(i),this.inputType)&&this.outputs[this.cases[i]]||this.otherwise).evaluate(e)}eachChild(e){e(this.input),this.outputs.forEach(e),e(this.otherwise)}outputDefined(){return this.outputs.every((e=>e.outputDefined()))&&this.otherwise.outputDefined()}serialize(){const e=["match",this.input.serialize()],i=Object.keys(this.cases).sort(),o=[],a={};for(const d of i){const y=a[this.cases[d]];y===void 0?(a[this.cases[d]]=o.length,o.push([this.cases[d],[d]])):o[y][1].push(d)}const h=d=>this.inputType.kind==="number"?Number(d):d;for(const[d,y]of o)e.push(y.length===1?h(y[0]):y.map(h)),e.push(this.outputs[d].serialize());return e.push(this.otherwise.serialize()),e}}class _u{constructor(e,i,o){this.type=e,this.branches=i,this.otherwise=o}static parse(e,i){if(e.length<4)return i.error(`Expected at least 3 arguments, but found only ${e.length-1}.`);if(e.length%2!=0)return i.error("Expected an odd number of arguments.");let o;i.expectedType&&i.expectedType.kind!=="value"&&(o=i.expectedType);const a=[];for(let d=1;d<e.length-1;d+=2){const y=i.parse(e[d],d,Mn);if(!y)return null;const w=i.parse(e[d+1],d+1,o);if(!w)return null;a.push([y,w]),o=o||w.type}const h=i.parse(e[e.length-1],e.length-1,o);return h?new _u(o,a,h):null}evaluate(e){for(const[i,o]of this.branches)if(i.evaluate(e))return o.evaluate(e);return this.otherwise.evaluate(e)}eachChild(e){for(const[i,o]of this.branches)e(i),e(o);e(this.otherwise)}outputDefined(){return this.branches.every((([e,i])=>i.outputDefined()))&&this.otherwise.outputDefined()}serialize(){const e=["case"];return this.eachChild((i=>{e.push(i.serialize())})),e}}class dc{constructor(e,i,o,a){this.type=e,this.input=i,this.beginIndex=o,this.endIndex=a}static parse(e,i){if(e.length<=2||e.length>=5)return i.error(`Expected 3 or 4 arguments, but found ${e.length-1} instead.`);const o=i.parse(e[1],1,On),a=i.parse(e[2],2,ni);if(!o||!a)return null;if(!R(o.type,[Vr(On),bn,On]))return i.error(`Expected first argument to be of type array or string, but found ${ss(o.type)} instead`);if(e.length===4){const h=i.parse(e[3],3,ni);return h?new dc(o.type,o,a,h):null}return new dc(o.type,o,a)}evaluate(e){const i=this.input.evaluate(e),o=this.beginIndex.evaluate(e);if(!W(i,["string","array"]))throw new gr(`Expected first argument to be of type array or string, but found ${ss(Vt(i))} instead.`);if(this.endIndex){const a=this.endIndex.evaluate(e);return i.slice(o,a)}return i.slice(o)}eachChild(e){e(this.input),e(this.beginIndex),this.endIndex&&e(this.endIndex)}outputDefined(){return!1}serialize(){if(this.endIndex!=null&&this.endIndex!==void 0){const e=this.endIndex.serialize();return["slice",this.input.serialize(),this.beginIndex.serialize(),e]}return["slice",this.input.serialize(),this.beginIndex.serialize()]}}class kd{constructor(e,i){this.type=Vr(bn),this.str=e,this.delimiter=i}static parse(e,i){if(e.length!==3)return i.error(`Expected 2 arguments, but found ${e.length-1} instead.`);const o=i.parse(e[1],1,bn),a=i.parse(e[2],2,bn);return o&&a?new kd(o,a):void 0}evaluate(e){const i=this.str.evaluate(e),o=this.delimiter.evaluate(e);return i.split(o)}eachChild(e){e(this.str),e(this.delimiter)}outputDefined(){return!1}serialize(){return["split",this.str.serialize(),this.delimiter.serialize()]}}function jf(n,e){return n==="=="||n==="!="?e.kind==="boolean"||e.kind==="string"||e.kind==="number"||e.kind==="null"||e.kind==="value":e.kind==="string"||e.kind==="number"||e.kind==="value"}function fc(n,e,i,o){return o.compare(e,i)===0}function pl(n,e,i){const o=n!=="=="&&n!=="!=";return class yT{constructor(h,d,y){this.type=Mn,this.lhs=h,this.rhs=d,this.collator=y,this.hasUntypedArgument=h.type.kind==="value"||d.type.kind==="value"}static parse(h,d){if(h.length!==3&&h.length!==4)return d.error("Expected two or three arguments.");const y=h[0];let w=d.parse(h[1],1,On);if(!w)return null;if(!jf(y,w.type))return d.concat(1).error(`"${y}" comparisons are not supported for type '${ss(w.type)}'.`);let T=d.parse(h[2],2,On);if(!T)return null;if(!jf(y,T.type))return d.concat(2).error(`"${y}" comparisons are not supported for type '${ss(T.type)}'.`);if(w.type.kind!==T.type.kind&&w.type.kind!=="value"&&T.type.kind!=="value")return d.error(`Cannot compare types '${ss(w.type)}' and '${ss(T.type)}'.`);o&&(w.type.kind==="value"&&T.type.kind!=="value"?w=new gi(T.type,[w]):w.type.kind!=="value"&&T.type.kind==="value"&&(T=new gi(w.type,[T])));let C=null;if(h.length===4){if(w.type.kind!=="string"&&T.type.kind!=="string"&&w.type.kind!=="value"&&T.type.kind!=="value")return d.error("Cannot use collator to compare non-string types.");if(C=d.parse(h[3],3,ou),!C)return null}return new yT(w,T,C)}evaluate(h){const d=this.lhs.evaluate(h),y=this.rhs.evaluate(h);if(o&&this.hasUntypedArgument){const w=Vt(d),T=Vt(y);if(w.kind!==T.kind||w.kind!=="string"&&w.kind!=="number")throw new gr(`Expected arguments for "${n}" to be (string, string) or (number, number), but found (${w.kind}, ${T.kind}) instead.`)}if(this.collator&&!o&&this.hasUntypedArgument){const w=Vt(d),T=Vt(y);if(w.kind!=="string"||T.kind!=="string")return e(h,d,y)}return this.collator?i(h,d,y,this.collator.evaluate(h)):e(h,d,y)}eachChild(h){h(this.lhs),h(this.rhs),this.collator&&h(this.collator)}outputDefined(){return!0}serialize(){const h=[n];return this.eachChild((d=>{h.push(d.serialize())})),h}}}const gu=pl("==",(function(n,e,i){return e===i}),fc),Gh=pl("!=",(function(n,e,i){return e!==i}),(function(n,e,i,o){return!fc(0,e,i,o)})),zd=pl("<",(function(n,e,i){return e<i}),(function(n,e,i,o){return o.compare(e,i)<0})),Xa=pl(">",(function(n,e,i){return e>i}),(function(n,e,i,o){return o.compare(e,i)>0})),Ka=pl("<=",(function(n,e,i){return e<=i}),(function(n,e,i,o){return o.compare(e,i)<=0})),Wl=pl(">=",(function(n,e,i){return e>=i}),(function(n,e,i,o){return o.compare(e,i)>=0}));class ml{constructor(e,i,o,a,h,d){this.type=bn,this.number=e,this.locale=i,this.currency=o,this.unit=a,this.minFractionDigits=h,this.maxFractionDigits=d}static parse(e,i){if(e.length!==3)return i.error("Expected two arguments.");const o=i.parse(e[1],1,ni);if(!o)return null;const a=e[2];if(typeof a!="object"||Array.isArray(a))return i.error("NumberFormat options argument must be an object.");let h=null;if(a.locale&&(h=i.parseObjectValue(a.locale,2,"locale",bn),!h))return null;let d=null;if(a.currency&&(d=i.parseObjectValue(a.currency,2,"currency",bn),!d))return null;let y=null;if(a.unit&&(y=i.parseObjectValue(a.unit,2,"unit",bn),!y))return null;let w=null;if(a["min-fraction-digits"]&&(w=i.parseObjectValue(a["min-fraction-digits"],2,"min-fraction-digits",ni),!w))return null;let T=null;return a["max-fraction-digits"]&&(T=i.parseObjectValue(a["max-fraction-digits"],2,"max-fraction-digits",ni),!T)?null:new ml(o,h,d,y,w,T)}evaluate(e){return new Intl.NumberFormat(this.locale?this.locale.evaluate(e):[],{style:(this.currency?"currency":this.unit&&"unit")||"decimal",currency:this.currency?this.currency.evaluate(e):void 0,unit:this.unit?this.unit.evaluate(e):void 0,minimumFractionDigits:this.minFractionDigits?this.minFractionDigits.evaluate(e):void 0,maximumFractionDigits:this.maxFractionDigits?this.maxFractionDigits.evaluate(e):void 0}).format(this.number.evaluate(e))}eachChild(e){e(this.number),this.locale&&e(this.locale),this.currency&&e(this.currency),this.unit&&e(this.unit),this.minFractionDigits&&e(this.minFractionDigits),this.maxFractionDigits&&e(this.maxFractionDigits)}outputDefined(){return!1}serialize(){const e={};return this.locale&&(e.locale=this.locale.serialize()),this.currency&&(e.currency=this.currency.serialize()),this.unit&&(e.unit=this.unit.serialize()),this.minFractionDigits&&(e["min-fraction-digits"]=this.minFractionDigits.serialize()),this.maxFractionDigits&&(e["max-fraction-digits"]=this.maxFractionDigits.serialize()),["number-format",this.number.serialize(),e]}}class _l{constructor(e){this.type=ni,this.input=e}static parse(e,i){if(e.length!==2)return i.error(`Expected 1 argument, but found ${e.length-1} instead.`);const o=i.parse(e[1],1);return o?o.type.kind!=="array"&&o.type.kind!=="string"&&o.type.kind!=="value"?i.error(`Expected argument of type string or array, but found ${ss(o.type)} instead.`):new _l(o):null}evaluate(e){const i=this.input.evaluate(e);if(typeof i=="string"||Array.isArray(i))return i.length;throw new gr(`Expected value to be of type string or array, but found ${ss(Vt(i))} instead.`)}eachChild(e){e(this.input)}outputDefined(){return!1}serialize(){const e=["length"];return this.eachChild((i=>{e.push(i.serialize())})),e}}function Vc(n){return function(){n=1831565813+(n|=0)|0;let e=Math.imul(n^n>>>15,1|n);return e=e+Math.imul(e^e>>>7,61|e)^e,((e^e>>>14)>>>0)/4294967296}}const yu={"==":gu,"!=":Gh,">":Xa,"<":zd,">=":Wl,"<=":Ka,array:gi,at:Uh,"at-interpolated":Ld,boolean:gi,case:_u,coalesce:xo,collator:ta,format:au,image:lu,in:nh,"index-of":jh,interpolate:Ls,"interpolate-hcl":Ls,"interpolate-lab":Ls,length:_l,let:Nc,literal:_i,match:Za,number:gi,"number-format":ml,object:gi,slice:dc,step:Hl,string:gi,"to-boolean":$a,"to-color":$a,"to-number":$a,"to-string":$a,var:Dd,within:Dc,distance:jl,config:Qu,split:kd};function Hh(n,[e,i,o,a]){e=e.evaluate(n),i=i.evaluate(n),o=o.evaluate(n);const h=a?a.evaluate(n):1,d=fs(e,i,o,h);if(d)throw new gr(d);return new un(e/255,i/255,o/255,h)}function Fd(n,[e,i,o,a]){e=e.evaluate(n),i=i.evaluate(n),o=o.evaluate(n);const h=a?a.evaluate(n):1,d=(function(T,C,P,D){return typeof T=="number"&&T>=0&&T<=360?typeof C=="number"&&C>=0&&C<=100&&typeof P=="number"&&P>=0&&P<=100?D===void 0||typeof D=="number"&&D>=0&&D<=1?null:`Invalid hsla value [${[T,C,P,D].join(", ")}]: 'a' must be between 0 and 1.`:`Invalid hsla value [${(typeof D=="number"?[T,C,P,D]:[T,C,P]).join(", ")}]: 's', and 'l' must be between 0 and 100.`:`Invalid hsla value [${(typeof D=="number"?[T,C,P,D]:[T,C,P]).join(", ")}]: 'h' must be between 0 and 360.`})(e,i,o,h);if(d)throw new gr(d);const y=`hsla(${e}, ${i}%, ${o}%, ${h})`,w=un.parse(y);if(!w)throw new gr(`Failed to parse HSLA color: ${y}`);return w}function ia(n,e){return n in e}function Po(n,e){const i=e[n];return i===void 0?null:i}function Gr(n){return{type:n}}function Aa(n){return{result:"success",value:n}}function pc(n){return{result:"error",value:n}}function mc(n,e){return!!n&&!!n.parameters&&n.parameters.indexOf(e)>-1}function rh(n){return n["property-type"]==="data-driven"}function Od(n){return mc(n.expression,"measure-light")}function Gf(n){return mc(n.expression,"zoom")}function vu(n){return!!n.expression&&n.expression.interpolated}function qh(n){return typeof n=="object"&&n!==null&&!Array.isArray(n)}function xu(n){return n}function $h(n,e){const i=e.type==="color",o=n.stops&&typeof n.stops[0][0]=="object",a=o||!(o||n.property!==void 0),h=n.type||(vu(e)?"exponential":"interval");if(i&&((n=Ta({},n)).stops&&(n.stops=n.stops.map((T=>[T[0],un.parse(T[1])]))),n.default=un.parse(n.default?n.default:e.default)),n.colorSpace&&n.colorSpace!=="rgb"&&!vo[n.colorSpace])throw new Error(`Unknown color space: ${n.colorSpace}`);let d,y,w;if(h==="exponential")d=Hf;else if(h==="interval")d=Wh;else if(h==="categorical"){d=bu,y=Object.create(null);for(const T of n.stops)y[T[0]]=T[1];w=typeof n.stops[0][0]}else{if(h!=="identity")throw new Error(`Unknown function type "${h}"`);d=_c}if(o){const T={},C=[];for(let O=0;O<n.stops.length;O++){const N=n.stops[O],G=N[0].zoom;T[G]===void 0&&(T[G]={zoom:G,type:n.type,property:n.property,default:n.default,stops:[]},C.push(G)),T[G].stops.push([N[0].value,N[1]])}const P=[];for(const O of C)P.push([T[O].zoom,$h(T[O],e)]);const D={name:"linear"};return{kind:"composite",interpolationType:D,interpolationFactor:Ls.interpolationFactor.bind(void 0,D),zoomStops:P.map((O=>O[0])),evaluate:({zoom:O},N)=>Hf({stops:P,base:n.base},e,O).evaluate(O,N)}}if(a){const T=h==="exponential"?{name:"exponential",base:n.base!==void 0?n.base:1}:null;return{kind:"camera",interpolationType:T,interpolationFactor:Ls.interpolationFactor.bind(void 0,T),zoomStops:n.stops.map((C=>C[0])),evaluate:({zoom:C})=>d(n,e,C,y,w)}}return{kind:"source",evaluate(T,C){const P=C&&C.properties?C.properties[n.property]:void 0;return P===void 0?wu(n.default,e.default):d(n,e,P,y,w)}}}function wu(n,e,i){return n!==void 0?n:e!==void 0?e:i!==void 0?i:void 0}function bu(n,e,i,o,a){return wu(typeof i===a?o[i]:void 0,n.default,e.default)}function Wh(n,e,i){if(oc(i)!=="number")return wu(n.default,e.default);const o=n.stops.length;if(o===1||i<=n.stops[0][0])return n.stops[0][1];if(i>=n.stops[o-1][0])return n.stops[o-1][1];const a=Nh(n.stops.map((h=>h[0])),i);return n.stops[a][1]}function Hf(n,e,i){const o=n.base!==void 0?n.base:1;if(oc(i)!=="number")return wu(n.default,e.default);const a=n.stops.length;if(a===1||i<=n.stops[0][0])return n.stops[0][1];if(i>=n.stops[a-1][0])return n.stops[a-1][1];const h=Nh(n.stops.map((C=>C[0])),i),d=(function(C,P,D,O){const N=O-D,G=C-D;return N===0?0:P===1?G/N:(Math.pow(P,G)-1)/(Math.pow(P,N)-1)})(i,o,n.stops[h][0],n.stops[h+1][0]),y=n.stops[h][1],w=n.stops[h+1][1];let T=Ha[e.type]||xu;if(n.colorSpace&&n.colorSpace!=="rgb"){const C=vo[n.colorSpace];T=(P,D)=>C.reverse(C.interpolate(C.forward(P),C.forward(D),d))}return typeof y.evaluate=="function"?{evaluate(...C){const P=y.evaluate.apply(void 0,C),D=w.evaluate.apply(void 0,C);if(P!==void 0&&D!==void 0)return T(P,D,d)}}:T(y,w,d)}function _c(n,e,i){return e.type==="color"?i=un.parse(i):e.type==="formatted"?i=Mt.fromString(i.toString()):e.type==="resolvedImage"?i=Yn.build(i.toString()):oc(i)===e.type||e.type==="enum"&&e.values[i]||(i=void 0),wu(i,n.default,e.default)}Ms.register(yu,{error:[{kind:"error"},[bn],(n,[e])=>{throw new gr(e.evaluate(n))}],typeof:[bn,[On],(n,[e])=>ss(Vt(e.evaluate(n)))],"to-rgba":[Vr(ni,4),[Cs],(n,[e])=>e.evaluate(n).toNonPremultipliedRenderColor(null).toArray()],"to-hsla":[Vr(ni,4),[Cs],(n,[e])=>e.evaluate(n).toNonPremultipliedRenderColor(null).toHslaArray()],rgb:[Cs,[ni,ni,ni],Hh],rgba:[Cs,[ni,ni,ni,ni],Hh],hsl:[Cs,[ni,ni,ni],Fd],hsla:[Cs,[ni,ni,ni,ni],Fd],has:{type:Mn,overloads:[[[bn],(n,[e])=>ia(e.evaluate(n),n.properties())],[[bn,qa],(n,[e,i])=>ia(e.evaluate(n),i.evaluate(n))]]},get:{type:On,overloads:[[[bn],(n,[e])=>Po(e.evaluate(n),n.properties())],[[bn,qa],(n,[e,i])=>Po(e.evaluate(n),i.evaluate(n))]]},"feature-state":[On,[bn],(n,[e])=>Po(e.evaluate(n),n.featureState||{})],properties:[qa,[],n=>n.properties()],"geometry-type":[bn,[],n=>n.geometryType()],worldview:[bn,[],n=>n.globals.worldview||""],id:[On,[],n=>n.id()],zoom:[ni,[],n=>n.globals.zoom],pitch:[ni,[],n=>n.globals.pitch||0],"distance-from-center":[ni,[],n=>n.distanceFromCenter()],"measure-light":[ni,[bn],(n,[e])=>n.measureLight(e.evaluate(n))],"heatmap-density":[ni,[],n=>n.globals.heatmapDensity||0],"line-progress":[ni,[],n=>n.globals.lineProgress||0],"raster-value":[ni,[],n=>n.globals.rasterValue||0],"raster-particle-speed":[ni,[],n=>n.globals.rasterParticleSpeed||0],"sky-radial-progress":[ni,[],n=>n.globals.skyRadialProgress||0],accumulated:[On,[],n=>n.globals.accumulated===void 0?null:n.globals.accumulated],"+":[ni,Gr(ni),(n,e)=>{let i=0;for(const o of e)i+=o.evaluate(n);return i}],"*":[ni,Gr(ni),(n,e)=>{let i=1;for(const o of e)i*=o.evaluate(n);return i}],"-":{type:ni,overloads:[[[ni,ni],(n,[e,i])=>e.evaluate(n)-i.evaluate(n)],[[ni],(n,[e])=>-e.evaluate(n)]]},"/":[ni,[ni,ni],(n,[e,i])=>e.evaluate(n)/i.evaluate(n)],"%":[ni,[ni,ni],(n,[e,i])=>e.evaluate(n)%i.evaluate(n)],ln2:[ni,[],()=>Math.LN2],pi:[ni,[],()=>Math.PI],e:[ni,[],()=>Math.E],"^":[ni,[ni,ni],(n,[e,i])=>Math.pow(e.evaluate(n),i.evaluate(n))],sqrt:[ni,[ni],(n,[e])=>Math.sqrt(e.evaluate(n))],log10:[ni,[ni],(n,[e])=>Math.log(e.evaluate(n))/Math.LN10],ln:[ni,[ni],(n,[e])=>Math.log(e.evaluate(n))],log2:[ni,[ni],(n,[e])=>Math.log(e.evaluate(n))/Math.LN2],sin:[ni,[ni],(n,[e])=>Math.sin(e.evaluate(n))],cos:[ni,[ni],(n,[e])=>Math.cos(e.evaluate(n))],tan:[ni,[ni],(n,[e])=>Math.tan(e.evaluate(n))],asin:[ni,[ni],(n,[e])=>Math.asin(e.evaluate(n))],acos:[ni,[ni],(n,[e])=>Math.acos(e.evaluate(n))],atan:[ni,[ni],(n,[e])=>Math.atan(e.evaluate(n))],min:[ni,Gr(ni),(n,e)=>Math.min(...e.map((i=>i.evaluate(n))))],max:[ni,Gr(ni),(n,e)=>Math.max(...e.map((i=>i.evaluate(n))))],abs:[ni,[ni],(n,[e])=>Math.abs(e.evaluate(n))],round:[ni,[ni],(n,[e])=>{const i=e.evaluate(n);return i<0?-Math.round(-i):Math.round(i)}],floor:[ni,[ni],(n,[e])=>Math.floor(e.evaluate(n))],ceil:[ni,[ni],(n,[e])=>Math.ceil(e.evaluate(n))],"filter-==":[Mn,[bn,On],(n,[e,i])=>n.properties()[e.value]===i.value],"filter-id-==":[Mn,[On],(n,[e])=>n.id()===e.value],"filter-type-==":[Mn,[bn],(n,[e])=>n.geometryType()===e.value],"filter-<":[Mn,[bn,On],(n,[e,i])=>{const o=n.properties()[e.value],a=i.value;return typeof o==typeof a&&o<a}],"filter-id-<":[Mn,[On],(n,[e])=>{const i=n.id(),o=e.value;return typeof i==typeof o&&i<o}],"filter->":[Mn,[bn,On],(n,[e,i])=>{const o=n.properties()[e.value],a=i.value;return typeof o==typeof a&&o>a}],"filter-id->":[Mn,[On],(n,[e])=>{const i=n.id(),o=e.value;return typeof i==typeof o&&i>o}],"filter-<=":[Mn,[bn,On],(n,[e,i])=>{const o=n.properties()[e.value],a=i.value;return typeof o==typeof a&&o<=a}],"filter-id-<=":[Mn,[On],(n,[e])=>{const i=n.id(),o=e.value;return typeof i==typeof o&&i<=o}],"filter->=":[Mn,[bn,On],(n,[e,i])=>{const o=n.properties()[e.value],a=i.value;return typeof o==typeof a&&o>=a}],"filter-id->=":[Mn,[On],(n,[e])=>{const i=n.id(),o=e.value;return typeof i==typeof o&&i>=o}],"filter-has":[Mn,[On],(n,[e])=>e.value in n.properties()],"filter-has-id":[Mn,[],n=>n.id()!==null&&n.id()!==void 0],"filter-type-in":[Mn,[Vr(bn)],(n,[e])=>e.value.indexOf(n.geometryType())>=0],"filter-id-in":[Mn,[Vr(On)],(n,[e])=>e.value.indexOf(n.id())>=0],"filter-in-small":[Mn,[bn,Vr(On)],(n,[e,i])=>i.value.indexOf(n.properties()[e.value])>=0],"filter-in-large":[Mn,[bn,Vr(On)],(n,[e,i])=>(function(o,a,h,d){for(;h<=d;){const y=h+d>>1;if(a[y]===o)return!0;a[y]>o?d=y-1:h=y+1}return!1})(n.properties()[e.value],i.value,0,i.value.length-1)],all:{type:Mn,overloads:[[[Mn,Mn],(n,[e,i])=>e.evaluate(n)&&i.evaluate(n)],[Gr(Mn),(n,e)=>{for(const i of e)if(!i.evaluate(n))return!1;return!0}]]},any:{type:Mn,overloads:[[[Mn,Mn],(n,[e,i])=>e.evaluate(n)||i.evaluate(n)],[Gr(Mn),(n,e)=>{for(const i of e)if(i.evaluate(n))return!0;return!1}]]},"!":[Mn,[Mn],(n,[e])=>!e.evaluate(n)],"is-supported-script":[Mn,[bn],(n,[e])=>{const i=n.globals&&n.globals.isSupportedScript;return!i||i(e.evaluate(n))}],upcase:[bn,[bn],(n,[e])=>e.evaluate(n).toUpperCase()],downcase:[bn,[bn],(n,[e])=>e.evaluate(n).toLowerCase()],concat:[bn,Gr(On),(n,e)=>e.map((i=>Ur(i.evaluate(n)))).join("")],"resolved-locale":[bn,[ou],(n,[e])=>e.evaluate(n).resolvedLocale()],random:[ni,[ni,ni,On],(n,e)=>{const[i,o,a]=e.map((d=>d.evaluate(n)));if(i>o||i===o)return i;let h;if(typeof a=="string")h=(function(d){let y=0;if(d.length===0)return y;for(let w=0;w<d.length;w++)y=(y<<5)-y+d.charCodeAt(w),y|=0;return y})(a);else{if(typeof a!="number")throw new gr(`Invalid seed input: ${a}`);h=a}return i+Vc(h)()*(o-i)}]});class Uc{constructor(e,i,o,a){this.expression=e,this._warningHistory={},this._evaluator=new Ph(o,a),this._defaultValue=i?(function(h){return h.type==="color"&&(qh(h.default)||Array.isArray(h.default))?new un(0,0,0,0):h.type==="color"?un.parse(h.default)||null:h.default===void 0?null:h.default})(i):null,this._enumValues=i&&i.type==="enum"?i.values:null,this.configDependencies=Yu(e)}evaluateWithoutErrorHandling(e,i,o,a,h,d,y,w){return this._evaluator.globals=e,this._evaluator.feature=i,this._evaluator.featureState=o,this._evaluator.canonical=a||null,this._evaluator.availableImages=h||null,this._evaluator.formattedSection=d,this._evaluator.featureTileCoord=y||null,this._evaluator.featureDistanceData=w||null,this.expression.evaluate(this._evaluator)}evaluate(e,i,o,a,h,d,y,w){this._evaluator.globals=e,this._evaluator.feature=i||null,this._evaluator.featureState=o||null,this._evaluator.canonical=a||null,this._evaluator.availableImages=h||null,this._evaluator.formattedSection=d||null,this._evaluator.featureTileCoord=y||null,this._evaluator.featureDistanceData=w||null;try{const T=this.expression.evaluate(this._evaluator);if(T==null||typeof T=="number"&&T!=T)return this._defaultValue;if(this._enumValues&&!(T in this._enumValues))throw new gr(`Expected value to be one of ${Object.keys(this._enumValues).map((C=>JSON.stringify(C))).join(", ")}, but found ${JSON.stringify(T)} instead.`);return T}catch(T){return this._warningHistory[T.message]||(this._warningHistory[T.message]=!0,typeof console<"u"&&console.warn(`Failed to evaluate expression "${JSON.stringify(this.expression.serialize())}". ${T.message}`)),this._defaultValue}}}function Bd(n){return Array.isArray(n)&&n.length>0&&typeof n[0]=="string"&&n[0]in yu}function Zl(n,e,i,o){const a=new Ju(yu,[],e?(function(d){const y={color:Cs,string:bn,number:ni,enum:bn,boolean:Mn,formatted:sc,resolvedImage:Vl};return d.type==="array"?Vr(y[d.value]||On,d.length):y[d.type]})(e):void 0,void 0,void 0,i,o),h=a.parse(n,void 0,void 0,void 0,e&&e.type==="string"?{typeAnnotation:"coerce"}:void 0);return h?Aa(new Uc(h,e,i,o)):pc(a.errors)}class Tu{constructor(e,i,o,a){this.kind=e,this._styleExpression=i,this.isLightConstant=o,this.isLineProgressConstant=a,this.isStateDependent=e!=="constant"&&!Ku(i.expression),this.configDependencies=Yu(i.expression)}evaluateWithoutErrorHandling(e,i,o,a,h,d){return this._styleExpression.evaluateWithoutErrorHandling(e,i,o,a,h,d)}evaluate(e,i,o,a,h,d){return this._styleExpression.evaluate(e,i,o,a,h,d)}}class Ca{constructor(e,i,o,a,h,d){this.kind=e,this.zoomStops=o,this._styleExpression=i,this.isStateDependent=e!=="camera"&&!Ku(i.expression),this.isLightConstant=h,this.isLineProgressConstant=d,this.configDependencies=Yu(i.expression),this.interpolationType=a}evaluateWithoutErrorHandling(e,i,o,a,h,d){return this._styleExpression.evaluateWithoutErrorHandling(e,i,o,a,h,d)}evaluate(e,i,o,a,h,d){return this._styleExpression.evaluate(e,i,o,a,h,d)}interpolationFactor(e,i,o){return this.interpolationType?Ls.interpolationFactor(this.interpolationType,e,i,o):0}}function Zh(n,e,i,o){if((n=Zl(n,e,i,o)).result==="error")return n;const a=n.value.expression,h=uc(a);if(!h&&!rh(e))return pc([new co("","data expressions not supported")]);const d=zc(a,["zoom","pitch","distance-from-center"]);if(!d&&!Gf(e))return pc([new co("","zoom expressions not supported")]);const y=zc(a,["measure-light"]);if(!y&&!Od(e))return pc([new co("","measure-light expression not supported")]);const w=zc(a,["line-progress"]);if(!w&&!(function(P){return mc(P.expression,"line-progress")})(e))return pc([new co("","line-progress expression not supported")]);const T=e.expression&&e.expression.relaxZoomRestriction,C=Eu(a);return C||d||T?C instanceof co?pc([C]):C instanceof Ls&&!vu(e)?pc([new co("",'"interpolate" expressions cannot be used with this property')]):Aa(C?new Ca(h&&w?"camera":"composite",n.value,C.labels,C instanceof Ls?C.interpolation:void 0,y,w):new Tu(h&&w?"constant":"source",n.value,y,w)):pc([new co("",'"zoom" expression may only be used as input to a top-level "step" or "interpolate" expression, or in the properties of atmosphere.')])}class gc{constructor(e,i){this._parameters=e,this._specification=i,Ta(this,$h(this._parameters,this._specification))}static deserialize(e){return new gc(e._parameters,e._specification)}static serialize(e){return{_parameters:e._parameters,_specification:e._specification}}}function Eu(n){let e=null;if(n instanceof Nc)e=Eu(n.result);else if(n instanceof xo){for(const i of n.args)if(e=Eu(i),e)break}else(n instanceof Hl||n instanceof Ls)&&n.input instanceof Ms&&n.input.name==="zoom"&&(e=n);return e instanceof co||n.eachChild((i=>{const o=Eu(i);o instanceof co?e=o:e&&o&&e!==o&&(e=new co("",'Only one zoom-based "step" or "interpolate" subexpression may be used in an expression.'))})),e}var Xh,Su,na=(function(){if(Su)return Xh;Su=1,Xh=e;var n=3;function e(i,o,a){var h=this.cells=[];if(i instanceof ArrayBuffer){this.arrayBuffer=i;var d=new Int32Array(this.arrayBuffer);i=d[0],this.d=(o=d[1])+2*(a=d[2]);for(var y=0;y<this.d*this.d;y++){var w=d[n+y],T=d[n+y+1];h.push(w===T?null:d.subarray(w,T))}var C=d[n+h.length+1];this.keys=d.subarray(d[n+h.length],C),this.bboxes=d.subarray(C),this.insert=this._insertReadonly}else{this.d=o+2*a;for(var P=0;P<this.d*this.d;P++)h.push([]);this.keys=[],this.bboxes=[]}this.n=o,this.extent=i,this.padding=a,this.scale=o/i,this.uid=0;var D=a/o*i;this.min=-D,this.max=i+D}return e.prototype.insert=function(i,o,a,h,d){this._forEachCell(o,a,h,d,this._insertCell,this.uid++),this.keys.push(i),this.bboxes.push(o),this.bboxes.push(a),this.bboxes.push(h),this.bboxes.push(d)},e.prototype._insertReadonly=function(){throw"Cannot insert into a GridIndex created from an ArrayBuffer."},e.prototype._insertCell=function(i,o,a,h,d,y){this.cells[d].push(y)},e.prototype.query=function(i,o,a,h,d){var y=this.min,w=this.max;if(i<=y&&o<=y&&w<=a&&w<=h&&!d)return Array.prototype.slice.call(this.keys);var T=[];return this._forEachCell(i,o,a,h,this._queryCell,T,{},d),T},e.prototype._queryCell=function(i,o,a,h,d,y,w,T){var C=this.cells[d];if(C!==null)for(var P=this.keys,D=this.bboxes,O=0;O<C.length;O++){var N=C[O];if(w[N]===void 0){var G=4*N;(T?T(D[G+0],D[G+1],D[G+2],D[G+3]):i<=D[G+2]&&o<=D[G+3]&&a>=D[G+0]&&h>=D[G+1])?(w[N]=!0,y.push(P[N])):w[N]=!1}}},e.prototype._forEachCell=function(i,o,a,h,d,y,w,T){for(var C=this._convertToCellCoord(i),P=this._convertToCellCoord(o),D=this._convertToCellCoord(a),O=this._convertToCellCoord(h),N=C;N<=D;N++)for(var G=P;G<=O;G++){var q=this.d*G+N;if((!T||T(this._convertFromCellCoord(N),this._convertFromCellCoord(G),this._convertFromCellCoord(N+1),this._convertFromCellCoord(G+1)))&&d.call(this,i,o,a,h,q,y,w,T))return}},e.prototype._convertFromCellCoord=function(i){return(i-this.padding)/this.scale},e.prototype._convertToCellCoord=function(i){return Math.max(0,Math.min(this.d-1,Math.floor(i*this.scale)+this.padding))},e.prototype.toArrayBuffer=function(){if(this.arrayBuffer)return this.arrayBuffer;for(var i=this.cells,o=n+this.cells.length+1+1,a=0,h=0;h<this.cells.length;h++)a+=this.cells[h].length;var d=new Int32Array(o+a+this.keys.length+this.bboxes.length);d[0]=this.extent,d[1]=this.n,d[2]=this.padding;for(var y=o,w=0;w<i.length;w++){var T=i[w];d[n+w]=y,d.set(T,y),y+=T.length}return d[n+i.length]=y,d.set(this.keys,y),d[n+i.length+1]=y+=this.keys.length,d.set(this.bboxes,y),y+=this.bboxes.length,d.buffer},Xh})(),ra=Jo(na);const Iu={};function Kt(n,e,i={}){Object.defineProperty(n,"_classRegistryKey",{value:e,writable:!1}),Iu[e]={klass:n,omit:i.omit||[]}}Kt(Object,"Object"),ra.serialize=function(n,e){const i=n.toArrayBuffer();return e&&e.add(i),{buffer:i}},ra.deserialize=function(n){return new ra(n.buffer)},Object.defineProperty(ra,"name",{value:"Grid"}),Kt(ra,"Grid"),delete gt.prototype.constructor,typeof DOMMatrix<"u"&&Kt(DOMMatrix,"DOMMatrix"),Kt(un,"Color"),Kt(Error,"Error"),Kt(Mt,"Formatted"),Kt(pt,"FormattedSection"),Kt(xn,"AJAXError"),Kt(Yn,"ResolvedImage"),Kt(gc,"StylePropertyFunction"),Kt(Uc,"StyleExpression",{omit:["_evaluator"]}),Kt(Js,"ImageId"),Kt(vi,"ImageVariant"),Kt(Ca,"ZoomDependentExpression"),Kt(Tu,"ZoomConstantExpression"),Kt(Ms,"CompoundExpression",{omit:["_evaluate"]});for(const n in yu)Iu[yu[n]._classRegistryKey]||Kt(yu[n],`Expression${n}`);function Ya(n){return n&&typeof ArrayBuffer<"u"&&(n instanceof ArrayBuffer||n.constructor&&n.constructor.name==="ArrayBuffer")}function Qa(n){return self.ImageBitmap&&n instanceof ImageBitmap}function gl(n,e){if(n==null||typeof n=="boolean"||typeof n=="number"||typeof n=="string"||n instanceof Boolean||n instanceof Number||n instanceof String||n instanceof Date||n instanceof RegExp)return n;if(Ya(n)||Qa(n))return e&&e.add(n),n;if(ArrayBuffer.isView(n))return e&&e.add(n.buffer),n;if(n instanceof ImageData)return e&&e.add(n.data.buffer),n;if(Array.isArray(n)){const i=[];for(const o of n)i.push(gl(o,e));return i}if(n instanceof Map){const i={$name:"Map",entries:[]};for(const[o,a]of n.entries())i.entries.push(gl(o),gl(a,e));return i}if(n instanceof Set){const i={$name:"Set"};let o=0;for(const a of n.values())i[++o]=gl(a);return i}if(n instanceof DOMMatrix){const i={$name:"DOMMatrix"},o=["is2D","m11","m12","m13","m14","m21","m22","m23","m24","m31","m32","m33","m34","m41","m42","m43","m44","a","b","c","d","e","f"];for(const a of o)i[a]=n[a];return i}if(typeof n=="bigint")return{$name:"BigInt",value:n.toString()};if(typeof n=="object"){const i=n.constructor,o=i._classRegistryKey;if(!o)throw new Error(`Can't serialize object of unregistered class "${i.name}".`);const a=i.serialize?i.serialize(n,e):{};if(!i.serialize){for(const h in n)n.hasOwnProperty(h)&&(Iu[o].omit.indexOf(h)>=0||(a[h]=gl(n[h],e)));n instanceof Error&&(a.message=n.message)}if(a.$name)throw new Error("$name property is reserved for worker serialization logic.");return o!=="Object"&&(a.$name=o),a}throw new Error("can't serialize object of type "+typeof n)}function Ro(n){if(n==null||typeof n=="boolean"||typeof n=="number"||typeof n=="string"||n instanceof Boolean||n instanceof Number||n instanceof String||n instanceof Date||n instanceof RegExp||Ya(n)||Qa(n)||ArrayBuffer.isView(n)||n instanceof ImageData)return n;if(Array.isArray(n))return n.map(Ro);if(typeof n=="object"){const e=n.$name||"Object";if(e==="Map"){const a=n.entries||[],h=new Map;for(let d=0;d<a.length;d+=2)h.set(Ro(a[d]),Ro(a[d+1]));return h}if(e==="Set"){const a=new Set;for(const h of Object.keys(n))h!=="$name"&&a.add(Ro(n[h]));return a}if(e==="DOMMatrix"){let a;return a=n.is2D?[n.a,n.b,n.c,n.d,n.e,n.f]:[n.m11,n.m12,n.m13,n.m14,n.m21,n.m22,n.m23,n.m24,n.m31,n.m32,n.m33,n.m34,n.m41,n.m42,n.m43,n.m44],new DOMMatrix(a)}if(e==="BigInt")return BigInt(n.value);const{klass:i}=Iu[e];if(!i)throw new Error(`Can't deserialize unregistered class "${e}".`);if(i.deserialize)return i.deserialize(n);const o=Object.create(i.prototype);for(const a of Object.keys(n))a!=="$name"&&(o[a]=Ro(n[a]));return o}throw new Error("can't deserialize object of type "+typeof n)}const fi={"Latin-1 Supplement":n=>n>=128&&n<=255,Arabic:n=>n>=1536&&n<=1791,"Arabic Supplement":n=>n>=1872&&n<=1919,"Arabic Extended-A":n=>n>=2208&&n<=2303,"Hangul Jamo":n=>n>=4352&&n<=4607,"Unified Canadian Aboriginal Syllabics":n=>n>=5120&&n<=5759,Khmer:n=>n>=6016&&n<=6143,"Unified Canadian Aboriginal Syllabics Extended":n=>n>=6320&&n<=6399,"General Punctuation":n=>n>=8192&&n<=8303,"Letterlike Symbols":n=>n>=8448&&n<=8527,"Number Forms":n=>n>=8528&&n<=8591,"Miscellaneous Technical":n=>n>=8960&&n<=9215,"Control Pictures":n=>n>=9216&&n<=9279,"Optical Character Recognition":n=>n>=9280&&n<=9311,"Enclosed Alphanumerics":n=>n>=9312&&n<=9471,"Geometric Shapes":n=>n>=9632&&n<=9727,"Miscellaneous Symbols":n=>n>=9728&&n<=9983,"Miscellaneous Symbols and Arrows":n=>n>=11008&&n<=11263,"CJK Radicals Supplement":n=>n>=11904&&n<=12031,"Kangxi Radicals":n=>n>=12032&&n<=12255,"Ideographic Description Characters":n=>n>=12272&&n<=12287,"CJK Symbols and Punctuation":n=>n>=12288&&n<=12351,Hiragana:n=>n>=12352&&n<=12447,Katakana:n=>n>=12448&&n<=12543,Bopomofo:n=>n>=12544&&n<=12591,"Hangul Compatibility Jamo":n=>n>=12592&&n<=12687,Kanbun:n=>n>=12688&&n<=12703,"Bopomofo Extended":n=>n>=12704&&n<=12735,"CJK Strokes":n=>n>=12736&&n<=12783,"Katakana Phonetic Extensions":n=>n>=12784&&n<=12799,"Enclosed CJK Letters and Months":n=>n>=12800&&n<=13055,"CJK Compatibility":n=>n>=13056&&n<=13311,"CJK Unified Ideographs Extension A":n=>n>=13312&&n<=19903,"Yijing Hexagram Symbols":n=>n>=19904&&n<=19967,"CJK Unified Ideographs":n=>n>=19968&&n<=40959,"Yi Syllables":n=>n>=40960&&n<=42127,"Yi Radicals":n=>n>=42128&&n<=42191,"Hangul Jamo Extended-A":n=>n>=43360&&n<=43391,"Hangul Syllables":n=>n>=44032&&n<=55215,"Hangul Jamo Extended-B":n=>n>=55216&&n<=55295,"Private Use Area":n=>n>=57344&&n<=63743,"CJK Compatibility Ideographs":n=>n>=63744&&n<=64255,"Arabic Presentation Forms-A":n=>n>=64336&&n<=65023,"Vertical Forms":n=>n>=65040&&n<=65055,"CJK Compatibility Forms":n=>n>=65072&&n<=65103,"Small Form Variants":n=>n>=65104&&n<=65135,"Arabic Presentation Forms-B":n=>n>=65136&&n<=65279,"Halfwidth and Fullwidth Forms":n=>n>=65280&&n<=65519,Osage:n=>n>=66736&&n<=66815,"CJK Unified Ideographs Extension B":n=>n>=131072&&n<=173791};function Xl(n){for(const e of n)if(Au(e.charCodeAt(0)))return!0;return!1}function Nd(n){for(const e of n)if(!Ip(e.charCodeAt(0)))return!1;return!0}function Ip(n){return!(fi.Arabic(n)||fi["Arabic Supplement"](n)||fi["Arabic Extended-A"](n)||fi["Arabic Presentation Forms-A"](n)||fi["Arabic Presentation Forms-B"](n))}function Au(n){return!(n!==746&&n!==747&&(n<4352||!(fi["Bopomofo Extended"](n)||fi.Bopomofo(n)||fi["CJK Compatibility Forms"](n)&&!(n>=65097&&n<=65103)||fi["CJK Compatibility Ideographs"](n)||fi["CJK Compatibility"](n)||fi["CJK Radicals Supplement"](n)||fi["CJK Strokes"](n)||!(!fi["CJK Symbols and Punctuation"](n)||n>=12296&&n<=12305||n>=12308&&n<=12319||n===12336)||fi["CJK Unified Ideographs Extension A"](n)||fi["CJK Unified Ideographs"](n)||fi["Enclosed CJK Letters and Months"](n)||fi["Hangul Compatibility Jamo"](n)||fi["Hangul Jamo Extended-A"](n)||fi["Hangul Jamo Extended-B"](n)||fi["Hangul Jamo"](n)||fi["Hangul Syllables"](n)||fi.Hiragana(n)||fi["Ideographic Description Characters"](n)||fi.Kanbun(n)||fi["Kangxi Radicals"](n)||fi["Katakana Phonetic Extensions"](n)||fi.Katakana(n)&&n!==12540||!(!fi["Halfwidth and Fullwidth Forms"](n)||n===65288||n===65289||n===65293||n>=65306&&n<=65310||n===65339||n===65341||n===65343||n>=65371&&n<=65503||n===65507||n>=65512&&n<=65519)||!(!fi["Small Form Variants"](n)||n>=65112&&n<=65118||n>=65123&&n<=65126)||fi["Unified Canadian Aboriginal Syllabics"](n)||fi["Unified Canadian Aboriginal Syllabics Extended"](n)||fi["Vertical Forms"](n)||fi["Yijing Hexagram Symbols"](n)||fi["Yi Syllables"](n)||fi["Yi Radicals"](n))))}function Kh(n){return!(Au(n)||(function(e){return!!(fi["Latin-1 Supplement"](e)&&(e===167||e===169||e===174||e===177||e===188||e===189||e===190||e===215||e===247)||fi["General Punctuation"](e)&&(e===8214||e===8224||e===8225||e===8240||e===8241||e===8251||e===8252||e===8258||e===8263||e===8264||e===8265||e===8273)||fi["Letterlike Symbols"](e)||fi["Number Forms"](e)||fi["Miscellaneous Technical"](e)&&(e>=8960&&e<=8967||e>=8972&&e<=8991||e>=8996&&e<=9e3||e===9003||e>=9085&&e<=9114||e>=9150&&e<=9165||e===9167||e>=9169&&e<=9179||e>=9186&&e<=9215)||fi["Control Pictures"](e)&&e!==9251||fi["Optical Character Recognition"](e)||fi["Enclosed Alphanumerics"](e)||fi["Geometric Shapes"](e)||fi["Miscellaneous Symbols"](e)&&!(e>=9754&&e<=9759)||fi["Miscellaneous Symbols and Arrows"](e)&&(e>=11026&&e<=11055||e>=11088&&e<=11097||e>=11192&&e<=11243)||fi["CJK Symbols and Punctuation"](e)||fi.Katakana(e)||fi["Private Use Area"](e)||fi["CJK Compatibility Forms"](e)||fi["Small Form Variants"](e)||fi["Halfwidth and Fullwidth Forms"](e)||e===8734||e===8756||e===8757||e>=9984&&e<=10087||e>=10102&&e<=10131||e===65532||e===65533)})(n))}function sh(n){return fi.Arabic(n)||fi["Arabic Supplement"](n)||fi["Arabic Extended-A"](n)||fi["Arabic Presentation Forms-A"](n)||fi["Arabic Presentation Forms-B"](n)}function Pa(n){return n>=1424&&n<=2303||fi["Arabic Presentation Forms-A"](n)||fi["Arabic Presentation Forms-B"](n)}function Yh(n,e){return!(!e&&Pa(n)||n>=2304&&n<=3583||n>=3840&&n<=4255||fi.Khmer(n))}function Qh(n){for(const e of n)if(Pa(e.charCodeAt(0)))return!0;return!1}const js={unavailable:"unavailable",deferred:"deferred",loading:"loading",parsing:"parsing",parsed:"parsed",loaded:"loaded",error:"error"};let Jh=null,ks=js.unavailable,yc=null;const Vd=function(n){n&&typeof n=="string"&&n.indexOf("NetworkError")>-1&&(ks=js.error),Jh&&Jh(n)};function ps(){oh.fire(new ba("pluginStateChange",{pluginStatus:ks,pluginURL:yc}))}const oh=new hl,ed=function(){return ks},Ud=function(){if(ks!==js.deferred||!yc)throw new Error("rtl-text-plugin cannot be downloaded unless a pluginURL is specified");ks=js.loading,ps(),yc&&ru({url:yc},(n=>{n?Vd(n):(ks=js.loaded,ps())}))},Ra={applyArabicShaping:null,processBidirectionalText:null,processStyledBidirectionalText:null,isLoaded:()=>ks===js.loaded||Ra.applyArabicShaping!=null,isLoading:()=>ks===js.loading,setState(n){ks=n.pluginStatus,yc=n.pluginURL},isParsing:()=>ks===js.parsing,isParsed:()=>ks===js.parsed,getPluginURL:()=>yc};class Wn{constructor(e,i){this.zoom=e,i?(this.now=i.now,this.fadeDuration=i.fadeDuration,this.transition=i.transition,this.pitch=i.pitch,this.brightness=i.brightness,this.worldview=i.worldview):(this.now=0,this.fadeDuration=0,this.transition={},this.pitch=0,this.brightness=0)}isSupportedScript(e){return(function(i,o){for(const a of i)if(!Yh(a.charCodeAt(0),o))return!1;return!0})(e,Ra.isLoaded())}}class yl{constructor(e,i,o,a){this.property=e,this.value=i,this.expression=(function(h,d,y,w){if(qh(h))return new gc(h,d);if(Bd(h)||Array.isArray(h)&&h.length>0){const T=Zh(h,d,y,w);if(T.result==="error")throw new Error(T.value.map((C=>`${C.key}: ${C.message}`)).join(", "));return T.value}{let T=h;return typeof h=="string"&&d.type==="color"&&(T=un.parse(h)),{kind:"constant",configDependencies:new Set,evaluate:()=>T}}})(i===void 0?e.specification.default:i,e.specification,o,a)}isDataDriven(){return this.expression.kind==="source"||this.expression.kind==="composite"}possiblyEvaluate(e,i,o){return this.property.possiblyEvaluate(this,e,i,o)}}class hs{constructor(e,i,o){this.property=e,this.value=new yl(e,void 0,i,o)}transitioned(e,i){return new to(this.property,this.value,i,Ge({},e.transition,this.transition),e.now)}untransitioned(){return new to(this.property,this.value,null,{},0)}}class Ts{constructor(e,i,o){this._properties=e,this._values=Object.create(e.defaultTransitionablePropertyValues),this._scope=i,this._options=o,this.configDependencies=new Set}getValue(e){return Vi(this._values[e].value.value)}setValue(e,i){this._values.hasOwnProperty(e)||(this._values[e]=new hs(this._values[e].property,this._scope,this._options)),this._values[e].value=new yl(this._values[e].property,i===null?void 0:Vi(i),this._scope,this._options),this._values[e].value.expression.configDependencies&&(this.configDependencies=new Set([...this.configDependencies,...this._values[e].value.expression.configDependencies]))}setTransitionOrValue(e,i){i&&(this._options=i);const o=this._properties.properties;if(e)for(const a in e){const h=e[a];if(a.endsWith("-transition")){const d=a.slice(0,-11);o[d]&&this.setTransition(d,h)}else o.hasOwnProperty(a)&&this.setValue(a,h)}}getTransition(e){return Vi(this._values[e].transition)}setTransition(e,i){this._values.hasOwnProperty(e)||(this._values[e]=new hs(this._values[e].property)),this._values[e].transition=Vi(i)||void 0}serialize(){const e={};for(const i of Object.keys(this._values)){const o=this.getValue(i);o!==void 0&&(e[i]=o);const a=this.getTransition(i);a!==void 0&&(e[`${i}-transition`]=a)}return e}transitioned(e,i){const o=new td(this._properties);for(const a of Object.keys(this._values))o._values[a]=this._values[a].transitioned(e,i._values[a]);return o}untransitioned(){const e=new td(this._properties);for(const i of Object.keys(this._values))e._values[i]=this._values[i].untransitioned();return e}}class to{constructor(e,i,o,a,h){const d=a.delay||0,y=a.duration||0;h=h||0,this.property=e,this.value=i,this.begin=h+d,this.end=this.begin+y,e.specification.transition&&(a.delay||a.duration)&&(this.prior=o)}possiblyEvaluate(e,i,o){const a=e.now||0,h=this.value.possiblyEvaluate(e,i,o),d=this.prior;if(d){if(a>this.end)return this.prior=null,h;if(this.value.isDataDriven())return this.prior=null,h;if(a<this.begin)return d.possiblyEvaluate(e,i,o);{const y=(a-this.begin)/(this.end-this.begin);return this.property.interpolate(d.possiblyEvaluate(e,i,o),h,J(y))}}return h}}class td{constructor(e){this._properties=e,this._values=Object.create(e.defaultTransitioningPropertyValues)}possiblyEvaluate(e,i,o){const a=new xl(this._properties);for(const h of Object.keys(this._values))a._values[h]=this._values[h].possiblyEvaluate(e,i,o);return a}hasTransition(){for(const e of Object.keys(this._values))if(this._values[e].prior)return!0;return!1}}class Ja{constructor(e,i,o){this._properties=e,this._values=Object.create(e.defaultPropertyValues),this._scope=i,this._options=o,this.configDependencies=new Set}getValue(e){return Vi(this._values[e].value)}setValue(e,i){this._values[e]=new yl(this._values[e].property,i===null?void 0:Vi(i),this._scope,this._options),this._values[e].expression.configDependencies&&(this.configDependencies=new Set([...this.configDependencies,...this._values[e].expression.configDependencies]))}serialize(){const e={};for(const i of Object.keys(this._values)){const o=this.getValue(i);o!==void 0&&(e[i]=o)}return e}possiblyEvaluate(e,i,o){const a=new xl(this._properties);for(const h of Object.keys(this._values))a._values[h]=this._values[h].possiblyEvaluate(e,i,o);return a}}class vl{constructor(e,i,o){this.property=e,this.value=i,this.parameters=o}isConstant(){return this.value.kind==="constant"}constantOr(e){return this.value.kind==="constant"?this.value.value:e}evaluate(e,i,o,a){return this.property.evaluate(this.value,this.parameters,e,i,o,a)}}class xl{constructor(e){this._properties=e,this._values=Object.create(e.defaultPossiblyEvaluatedValues)}get(e){return this._values[e]}}class _t{constructor(e){this.specification=e}possiblyEvaluate(e,i){return e.expression.evaluate(i)}interpolate(e,i,o){const a=Ha[this.specification.type];return a?a(e,i,o):e}}class Wt{constructor(e,i){this.specification=e,this.overrides=i}possiblyEvaluate(e,i,o,a){return new vl(this,e.expression.kind==="constant"||e.expression.kind==="camera"?{kind:"constant",value:e.expression.evaluate(i,null,{},o,a)}:e.expression,i)}interpolate(e,i,o){if(e.value.kind!=="constant"||i.value.kind!=="constant")return e;if(e.value.value===void 0||i.value.value===void 0)return new vl(this,{kind:"constant",value:void 0},e.parameters);const a=Ha[this.specification.type];return a?new vl(this,{kind:"constant",value:a(e.value.value,i.value.value,o)},e.parameters):e}evaluate(e,i,o,a,h,d){return e.kind==="constant"?e.value:e.evaluate(i,o,a,h,d)}}class jc{constructor(e){this.specification=e}possiblyEvaluate(e,i,o,a){return!!e.expression.evaluate(i,null,{},o,a)}interpolate(){return!1}}class Fr{constructor(e){this.properties=e,this.defaultPropertyValues={},this.defaultTransitionablePropertyValues={},this.defaultTransitioningPropertyValues={},this.defaultPossiblyEvaluatedValues={},this.overridableProperties=[];const i=new Wn(0,{});for(const o in e){const a=e[o];a.specification.overridable&&this.overridableProperties.push(o);const h=this.defaultPropertyValues[o]=new yl(a,void 0),d=this.defaultTransitionablePropertyValues[o]=new hs(a);this.defaultTransitioningPropertyValues[o]=d.untransitioned(),this.defaultPossiblyEvaluatedValues[o]=h.possiblyEvaluate(i)}}}Kt(Wt,"DataDrivenProperty"),Kt(_t,"DataConstantProperty"),Kt(jc,"ColorRampProperty");var Le=JSON.parse('{"$version":8,"$root":{"version":{"type":"enum","values":[8]},"fragment":{"type":"boolean"},"name":{"type":"string"},"metadata":{"type":"*"},"center":{"type":"array","value":"number"},"zoom":{"type":"number"},"bearing":{"type":"number","default":0,"period":360},"pitch":{"type":"number","default":0},"light":{"type":"light"},"lights":{"type":"array","value":"light-3d"},"terrain":{"type":"terrain","optional":true},"fog":{"type":"fog"},"snow":{"type":"snow"},"rain":{"type":"rain"},"camera":{"type":"camera"},"color-theme":{"type":"colorTheme"},"indoor":{"type":"indoor"},"imports":{"type":"array","value":"import"},"iconsets":{"type":"iconsets"},"schema":{"type":"schema"},"sources":{"type":"sources"},"sprite":{"type":"string"},"glyphs":{"type":"string","default":"mapbox://fonts/mapbox/{fontstack}/{range}.pbf"},"transition":{"type":"transition"},"projection":{"type":"projection"},"layers":{"type":"array","value":"layer"},"models":{"type":"models"},"featuresets":{"type":"featuresets"}},"featuresets":{"*":{"type":"featureset"}},"featureset":{"metadata":{"type":"*"},"selectors":{"type":"array","value":"selector"}},"selector":{"layer":{"type":"string"},"properties":{"type":"selectorProperty"},"featureNamespace":{"type":"string"},"_uniqueFeatureID":{"type":"boolean"}},"selectorProperty":{"*":{"type":"*"}},"model":{"type":"string"},"import":{"id":{"type":"string"},"url":{"type":"string"},"config":{"type":"config"},"data":{"type":"$root"},"color-theme":{"type":"colorTheme","optional":true}},"config":{"*":{"type":"*"}},"schema":{"*":{"type":"option"}},"option":{"default":{"type":"*","expression":{}},"type":{"type":"enum","values":{"string":1,"number":1,"boolean":1,"color":1}},"array":{"type":"boolean"},"minValue":{"type":"number"},"maxValue":{"type":"number"},"stepValue":{"type":"number"},"values":{"type":"array","value":"*"},"metadata":{"type":"*"}},"models":{"*":{"type":"model"}},"light-3d":{"id":{"type":"string"},"properties":{"type":"properties"},"type":{"type":"enum","values":{"ambient":{},"directional":{},"flat":{}}}},"properties":["properties_light_directional","properties_light_ambient","properties_light_flat"],"properties_light_directional":{"direction":{"type":"array","default":[210,30],"minimum":[0,0],"maximum":[360,90],"length":2,"value":"number","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"color":{"type":"color","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom"]},"use-theme":true,"transition":true},"intensity":{"type":"number","default":0.5,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"cast-shadows":{"type":"boolean","default":false},"shadow-quality":{"type":"number","default":1,"minimum":0,"maximum":1,"expression":{"parameters":["zoom"]}},"shadow-intensity":{"type":"number","default":1,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"properties_light_ambient":{"color":{"type":"color","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom"]},"use-theme":true,"transition":true},"intensity":{"type":"number","default":0.5,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"properties_light_flat":{"anchor":{"type":"enum","default":"viewport","values":{"map":1,"viewport":1},"expression":{"parameters":["zoom"]}},"position":{"type":"array","default":[1.15,210,30],"length":3,"value":"number","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"color":{"type":"color","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom"]},"use-theme":true,"transition":true},"intensity":{"type":"number","default":0.5,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"iconsets":{"*":{"type":"iconset"}},"iconset":["iconset_sprite","iconset_source"],"iconset_sprite":{"type":{"type":"enum","values":{"sprite":1}},"url":{"type":"string"}},"iconset_source":{"type":{"type":"enum","values":{"source":1}},"source":{"type":"string"}},"sources":{"*":{"type":"source"}},"source":["source_vector","source_raster","source_raster_dem","source_raster_array","source_geojson","source_video","source_image","source_model"],"source_vector":{"type":{"type":"enum","values":{"vector":1}},"url":{"type":"string"},"tiles":{"type":"array","value":"string"},"bounds":{"type":"array","value":"number","length":4,"default":[-180,-85.051129,180,85.051129]},"extra_bounds":{"type":"array","value":{"type":"array","value":"number","length":4}},"scheme":{"type":"enum","values":{"xyz":1,"tms":1},"default":"xyz"},"minzoom":{"type":"number","default":0},"maxzoom":{"type":"number","default":22},"attribution":{"type":"string"},"promoteId":{"type":"promoteId"},"volatile":{"type":"boolean","default":false},"*":{"type":"*"}},"source_raster":{"type":{"type":"enum","values":{"raster":1}},"url":{"type":"string"},"tiles":{"type":"array","value":"string"},"bounds":{"type":"array","value":"number","length":4,"default":[-180,-85.051129,180,85.051129]},"extra_bounds":{"type":"array","value":{"type":"array","value":"number","length":4}},"minzoom":{"type":"number","default":0},"maxzoom":{"type":"number","default":22},"tileSize":{"type":"number","default":512},"scheme":{"type":"enum","values":{"xyz":1,"tms":1},"default":"xyz"},"attribution":{"type":"string"},"volatile":{"type":"boolean","default":false},"*":{"type":"*"}},"source_raster_dem":{"type":{"type":"enum","values":{"raster-dem":1}},"url":{"type":"string"},"tiles":{"type":"array","value":"string"},"bounds":{"type":"array","value":"number","length":4,"default":[-180,-85.051129,180,85.051129]},"extra_bounds":{"type":"array","value":{"type":"array","value":"number","length":4}},"minzoom":{"type":"number","default":0},"maxzoom":{"type":"number","default":22},"tileSize":{"type":"number","default":512},"attribution":{"type":"string"},"encoding":{"type":"enum","values":{"terrarium":1,"mapbox":1},"default":"mapbox"},"volatile":{"type":"boolean","default":false},"*":{"type":"*"}},"source_raster_array":{"type":{"type":"enum","values":{"raster-array":1}},"url":{"type":"string"},"tiles":{"type":"array","value":"string"},"bounds":{"type":"array","value":"number","length":4,"default":[-180,-85.051129,180,85.051129]},"extra_bounds":{"type":"array","value":{"type":"array","value":"number","length":4}},"minzoom":{"type":"number","default":0},"maxzoom":{"type":"number","default":22},"tileSize":{"type":"number","default":512},"attribution":{"type":"string"},"rasterLayers":{"type":"*"},"volatile":{"type":"boolean","default":false},"*":{"type":"*"}},"source_geojson":{"type":{"type":"enum","values":{"geojson":1}},"data":{"type":"*"},"maxzoom":{"type":"number","default":18},"minzoom":{"type":"number","default":0},"attribution":{"type":"string"},"buffer":{"type":"number","default":128,"maximum":512,"minimum":0},"filter":{"type":"*"},"tolerance":{"type":"number","default":0.375},"cluster":{"type":"boolean","default":false},"clusterRadius":{"type":"number","default":50,"minimum":0},"clusterMaxZoom":{"type":"number"},"clusterMinPoints":{"type":"number"},"clusterProperties":{"type":"*"},"lineMetrics":{"type":"boolean","default":false},"generateId":{"type":"boolean","default":false},"promoteId":{"type":"promoteId"},"dynamic":{"type":"boolean","default":false}},"source_video":{"type":{"type":"enum","values":{"video":1}},"urls":{"type":"array","value":"string"},"coordinates":{"type":"array","length":4,"value":{"type":"array","length":2,"value":"number"}}},"source_image":{"type":{"type":"enum","values":{"image":1}},"url":{"type":"string"},"coordinates":{"type":"array","length":4,"value":{"type":"array","length":2,"value":"number"}}},"source_model":{"type":{"type":"enum","values":{"model":1,"batched-model":1}},"maxzoom":{"type":"number","default":18},"minzoom":{"type":"number","default":0},"tiles":{"type":"array","value":"string"}},"layer":{"id":{"type":"string"},"type":{"type":"enum","values":{"fill":{},"line":{},"symbol":{},"circle":{},"heatmap":{},"fill-extrusion":{},"building":{},"raster":{},"raster-particle":{},"hillshade":{},"model":{},"background":{},"sky":{},"slot":{},"clip":{}}},"metadata":{"type":"*"},"source":{"type":"string"},"source-layer":{"type":"string"},"slot":{"type":"string"},"minzoom":{"type":"number","minimum":0,"maximum":24},"maxzoom":{"type":"number","minimum":0,"maximum":24},"filter":{"type":"filter"},"layout":{"type":"layout"},"paint":{"type":"paint"},"appearances":{"type":"array","value":"appearance","supported-layer-types":["symbol"]}},"appearance":{"condition":{"type":"expression"},"name":{"type":"string"},"properties":{"type":"*"}},"layout":["layout_clip","layout_fill","layout_line","layout_circle","layout_heatmap","layout_fill-extrusion","layout_building","layout_symbol","layout_raster","layout_raster-particle","layout_hillshade","layout_background","layout_sky","layout_model"],"layout_background":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}}},"layout_sky":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}}},"layout_model":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}},"model-id":{"type":"string","default":"","property-type":"data-driven","expression":{"parameters":["zoom","feature"]}}},"layout_clip":{"clip-layer-types":{"type":"array","value":"enum","values":{"model":1,"symbol":1},"default":[],"expression":{}},"clip-layer-scope":{"type":"array","value":"string","default":[],"expression":{}}},"layout_fill":{"fill-sort-key":{"type":"number","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}},"fill-elevation-reference":{"type":"enum","values":{"none":1,"hd-road-base":1,"hd-road-markup":1},"default":"none","expression":{}},"fill-construct-bridge-guard-rail":{"type":"boolean","default":"true","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"}},"layout_circle":{"circle-sort-key":{"type":"number","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"circle-elevation-reference":{"type":"enum","values":{"none":1,"hd-road-markup":1},"default":"none","expression":{}},"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}}},"layout_heatmap":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}}},"layout_fill-extrusion":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}},"fill-extrusion-edge-radius":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{}}},"layout_building":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}},"building-facade":{"type":"boolean","default":false,"expression":{"parameters":["feature"]},"property-type":"data-driven"},"building-facade-floors":{"type":"number","minimum":1,"maximum":200,"default":3,"property-type":"data-driven","expression":{"parameters":["feature"]}},"building-facade-window":{"type":"array","length":2,"value":"number","minimum":0.1,"maximum":1,"default":[0.9,0.9],"property-type":"data-driven","expression":{"parameters":["feature"]}},"building-roof-shape":{"type":"enum","values":{"flat":1,"hipped":1,"gabled":1,"parapet":1,"mansard":1,"skillion":1,"pyramidal":1},"default":"flat","expression":{"parameters":["feature"]},"property-type":"data-driven"},"building-height":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{},"property-type":"data-driven"},"building-base":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{},"property-type":"data-driven"}},"layout_line":{"line-cap":{"type":"enum","values":{"butt":1,"round":1,"square":1},"default":"butt","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"line-join":{"type":"enum","values":{"bevel":1,"round":1,"miter":1,"none":1},"default":"miter","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"line-miter-limit":{"type":"number","default":2,"expression":{"interpolated":true,"parameters":["zoom"]}},"line-round-limit":{"type":"number","default":1.05,"expression":{"interpolated":true,"parameters":["zoom"]}},"line-sort-key":{"type":"number","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"line-z-offset":{"type":"number","default":0,"expression":{"parameters":["zoom","feature","line-progress"]},"property-type":"data-driven"},"line-elevation-reference":{"type":"enum","values":{"none":1,"sea":1,"ground":1,"hd-road-markup":1},"default":"none","expression":{}},"line-cross-slope":{"type":"number","expression":{}},"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}},"line-width-unit":{"type":"enum","values":{"pixels":1,"meters":1},"default":"pixels","expression":{"parameters":["zoom"]}}},"layout_symbol":{"symbol-placement":{"type":"enum","values":{"point":1,"line":1,"line-center":1},"default":"point","expression":{"parameters":["zoom"]}},"symbol-spacing":{"type":"number","default":250,"minimum":1,"expression":{"interpolated":true,"parameters":["zoom"]}},"symbol-avoid-edges":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]}},"symbol-sort-key":{"type":"number","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"symbol-z-order":{"type":"enum","values":{"auto":1,"viewport-y":1,"source":1},"default":"auto","expression":{"parameters":["zoom"]}},"symbol-z-elevate":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]}},"symbol-elevation-reference":{"type":"enum","values":{"sea":1,"ground":1,"hd-road-markup":1},"default":"ground","expression":{"parameters":["zoom"]}},"icon-allow-overlap":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]}},"icon-ignore-placement":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]}},"icon-optional":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]}},"icon-rotation-alignment":{"type":"enum","values":{"map":1,"viewport":1,"auto":1},"default":"auto","expression":{"parameters":["zoom"]}},"icon-size":{"type":"number","default":1,"minimum":0,"appearance":true,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-size-scale-range":{"type":"array","value":"number","length":2,"default":[0.8,2],"minimum":0.1,"maximum":10,"expression":{}},"icon-text-fit":{"type":"enum","values":{"none":1,"width":1,"height":1,"both":1},"default":"none","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-text-fit-padding":{"type":"array","value":"number","length":4,"default":[0,0,0,0],"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-image":{"type":"resolvedImage","tokens":true,"appearance":true,"expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-rotate":{"type":"number","default":0,"period":360,"appearance":true,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-padding":{"type":"number","default":2,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]}},"icon-keep-upright":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]}},"icon-offset":{"type":"array","value":"number","length":2,"default":[0,0],"appearance":true,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-anchor":{"type":"enum","values":{"center":1,"left":1,"right":1,"top":1,"bottom":1,"top-left":1,"top-right":1,"bottom-left":1,"bottom-right":1},"default":"center","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"icon-pitch-alignment":{"type":"enum","values":{"map":1,"viewport":1,"auto":1},"default":"auto","expression":{"parameters":["zoom"]}},"text-pitch-alignment":{"type":"enum","values":{"map":1,"viewport":1,"auto":1},"default":"auto","expression":{"parameters":["zoom"]}},"text-rotation-alignment":{"type":"enum","values":{"map":1,"viewport":1,"auto":1},"default":"auto","expression":{"parameters":["zoom"]}},"text-field":{"type":"formatted","default":"","tokens":true,"expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-font":{"type":"array","value":"string","default":["Open Sans Regular","Arial Unicode MS Regular"],"expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-size":{"type":"number","default":16,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-size-scale-range":{"type":"array","value":"number","length":2,"default":[0.8,2],"minimum":0.1,"maximum":10,"expression":{}},"text-max-width":{"type":"number","default":10,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-line-height":{"type":"number","default":1.2,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-letter-spacing":{"type":"number","default":0,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-justify":{"type":"enum","values":{"auto":1,"left":1,"center":1,"right":1},"default":"center","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-radial-offset":{"type":"number","default":0,"property-type":"data-driven","expression":{"interpolated":true,"parameters":["zoom","feature"]}},"text-variable-anchor":{"type":"array","value":"enum","values":{"center":1,"left":1,"right":1,"top":1,"bottom":1,"top-left":1,"top-right":1,"bottom-left":1,"bottom-right":1},"expression":{"parameters":["zoom"]}},"text-anchor":{"type":"enum","values":{"center":1,"left":1,"right":1,"top":1,"bottom":1,"top-left":1,"top-right":1,"bottom-left":1,"bottom-right":1},"default":"center","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-max-angle":{"type":"number","default":45,"expression":{"interpolated":true,"parameters":["zoom"]}},"text-writing-mode":{"type":"array","value":"enum","values":{"horizontal":1,"vertical":1},"expression":{"parameters":["zoom"]}},"text-rotate":{"type":"number","default":0,"period":360,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-padding":{"type":"number","default":2,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]}},"text-keep-upright":{"type":"boolean","default":true,"expression":{"parameters":["zoom"]}},"text-transform":{"type":"enum","values":{"none":1,"uppercase":1,"lowercase":1},"default":"none","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-offset":{"type":"array","value":"number","length":2,"default":[0,0],"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"text-allow-overlap":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]}},"text-ignore-placement":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]}},"text-optional":{"type":"boolean","default":false,"expression":{"parameters":["zoom"]}},"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}}},"layout_raster":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}}},"layout_raster-particle":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}}},"layout_hillshade":{"visibility":{"type":"enum","values":{"visible":1,"none":1},"default":"visible","expression":{}}},"filter":{"type":"array","value":"*"},"filter_symbol":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature","pitch","distance-from-center"]}},"filter_fill":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_hillshade":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_raster":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_raster-particle":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_clip":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_model":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_line":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_circle":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_fill-extrusion":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_building":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_heatmap":{"type":"boolean","default":false,"property-type":"data-driven","expression":{"parameters":["zoom","feature"]}},"filter_operator":{"type":"enum","values":{"==":1,"!=":1,">":1,">=":1,"<":1,"<=":1,"in":1,"!in":1,"all":1,"any":1,"none":1,"has":1,"!has":1}},"geometry_type":{"type":"enum","values":{"Point":1,"LineString":1,"Polygon":1}},"function":{"expression":{"type":"expression"},"stops":{"type":"array","value":"function_stop"},"base":{"type":"number","default":1,"minimum":0},"property":{"type":"string","default":"$zoom"},"type":{"type":"enum","values":{"identity":1,"exponential":1,"interval":1,"categorical":1},"default":"exponential"},"colorSpace":{"type":"enum","values":{"rgb":1,"lab":1,"hcl":1},"default":"rgb"},"default":{"type":"*"}},"function_stop":{"type":"array","minimum":0,"maximum":24,"value":["number","color"],"length":2},"expression":{"type":"array","value":"*","minimum":1},"fog":{"range":{"type":"array","default":[0.5,10],"minimum":-20,"maximum":20,"length":2,"value":"number","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true}},"color":{"type":"color","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"use-theme":true,"transition":true},"high-color":{"type":"color","default":"#245cdf","expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"use-theme":true,"transition":true},"space-color":{"type":"color","default":["interpolate",["linear"],["zoom"],4,"#010b19",7,"#367ab9"],"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"use-theme":true,"transition":true},"horizon-blend":{"type":"number","default":["interpolate",["linear"],["zoom"],4,0.2,7,0.1],"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"star-intensity":{"type":"number","default":["interpolate",["linear"],["zoom"],5,0.35,6,0],"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"vertical-range":{"type":"array","default":[0,0],"minimum":0,"length":2,"value":"number","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true}}},"snow":{"density":{"type":"number","default":["interpolate",["linear"],["zoom"],11,0,13,0.85],"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"intensity":{"type":"number","default":1,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"color":{"type":"color","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"use-theme":true,"transition":true},"opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"vignette":{"type":"number","default":["interpolate",["linear"],["zoom"],11,0,13,0.3],"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"vignette-color":{"type":"color","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"use-theme":true,"transition":true},"center-thinning":{"type":"number","default":0.4,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"direction":{"type":"array","default":[0,50],"minimum":0,"maximum":360,"length":2,"value":"number","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true}},"flake-size":{"type":"number","default":0.71,"minimum":0,"maximum":5,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true}},"rain":{"density":{"type":"number","default":["interpolate",["linear"],["zoom"],11,0,13,0.5],"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"intensity":{"type":"number","default":1,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"color":{"type":"color","default":["interpolate",["linear"],["measure-light","brightness"],0,"#03113d",0.3,"#a8adbc"],"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"use-theme":true,"transition":true},"opacity":{"type":"number","default":["interpolate",["linear"],["measure-light","brightness"],0,0.88,1,0.7],"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"vignette":{"type":"number","default":["interpolate",["linear"],["zoom"],11,0,13,1],"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"vignette-color":{"type":"color","default":["interpolate",["linear"],["measure-light","brightness"],0,"#001736",0.3,"#464646"],"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"use-theme":true,"transition":true},"center-thinning":{"type":"number","default":0.57,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true},"direction":{"type":"array","default":[0,80],"minimum":0,"maximum":360,"length":2,"value":"number","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true}},"droplet-size":{"type":"array","default":[2.6,18.2],"minimum":0,"maximum":50,"length":2,"value":"number","transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true}},"distortion-strength":{"type":"number","default":0.7,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"],"relaxZoomRestriction":true},"transition":true}},"camera":{"camera-projection":{"type":"enum","values":{"perspective":1,"orthographic":1},"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]},"default":"perspective"}},"colorTheme":{"data":{"type":"string","expression":{}}},"indoor":{"floorplanFeaturesetId":{"type":"string","expression":{}},"buildingFeaturesetId":{"type":"string","expression":{}}},"light":{"anchor":{"type":"enum","default":"viewport","values":{"map":1,"viewport":1},"expression":{"parameters":["zoom"]}},"position":{"type":"array","default":[1.15,210,30],"length":3,"value":"number","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"color":{"type":"color","default":"#ffffff","expression":{"interpolated":true,"parameters":["zoom"]},"use-theme":true,"transition":true},"intensity":{"type":"number","default":0.5,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"projection":{"name":{"type":"enum","values":{"albers":1,"equalEarth":1,"equirectangular":1,"lambertConformalConic":1,"mercator":1,"naturalEarth":1,"winkelTripel":1,"globe":1},"default":"mercator"},"center":{"type":"array","length":2,"value":"number","minimum":[-180,-90],"maximum":[180,90]},"parallels":{"type":"array","length":2,"value":"number","minimum":[-90,-90],"maximum":[90,90]}},"terrain":{"source":{"type":"string"},"exaggeration":{"type":"number","default":1,"minimum":0,"maximum":1000,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"paint":["paint_fill","paint_line","paint_circle","paint_heatmap","paint_fill-extrusion","paint_building","paint_symbol","paint_raster","paint_raster-particle","paint_hillshade","paint_background","paint_sky","paint_model"],"paint_fill":{"fill-antialias":{"type":"boolean","default":true,"expression":{"parameters":["zoom"]}},"fill-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"fill-color":{"type":"color","default":"#000000","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"fill-outline-color":{"type":"color","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"fill-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"fill-translate-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]}},"fill-pattern":{"type":"resolvedImage","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"fill-pattern-cross-fade":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"fill-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"fill-z-offset":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"},"fill-bridge-guard-rail-color":{"type":"color","default":"rgba(241, 236, 225, 255)","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light","feature"]},"property-type":"data-driven"},"fill-tunnel-structure-color":{"type":"color","default":"rgba(241, 236, 225, 255)","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light","feature"]},"property-type":"data-driven"}},"paint_fill-extrusion":{"fill-extrusion-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"fill-extrusion-color":{"type":"color","default":"#000000","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"fill-extrusion-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"fill-extrusion-translate-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]}},"fill-extrusion-pattern":{"type":"resolvedImage","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"fill-extrusion-pattern-cross-fade":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"fill-extrusion-height":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-extrusion-base":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"fill-extrusion-height-alignment":{"type":"enum","values":{"terrain":1,"flat":1},"default":"flat"},"fill-extrusion-base-alignment":{"type":"enum","values":{"terrain":1,"flat":1},"default":"terrain"},"fill-extrusion-vertical-gradient":{"type":"boolean","default":true,"expression":{"parameters":["zoom"]}},"fill-extrusion-ambient-occlusion-intensity":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"fill-extrusion-ambient-occlusion-radius":{"type":"number","default":3,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"fill-extrusion-ambient-occlusion-wall-radius":{"type":"number","default":3,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"fill-extrusion-ambient-occlusion-ground-radius":{"type":"number","default":3,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"fill-extrusion-ambient-occlusion-ground-attenuation":{"type":"number","default":0.69,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"fill-extrusion-flood-light-color":{"type":"color","default":"#ffffff","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"fill-extrusion-flood-light-intensity":{"type":"number","default":0,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"fill-extrusion-flood-light-wall-radius":{"property-type":"data-driven","type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["feature","feature-state"]}},"fill-extrusion-flood-light-ground-radius":{"property-type":"data-driven","type":"number","default":0,"transition":true,"expression":{"interpolated":true,"parameters":["feature","feature-state"]}},"fill-extrusion-flood-light-ground-attenuation":{"type":"number","default":0.69,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"fill-extrusion-vertical-scale":{"type":"number","default":1,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"fill-extrusion-rounded-roof":{"type":"boolean","default":true,"expression":{"parameters":["zoom"]}},"fill-extrusion-cutoff-fade-range":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{}},"fill-extrusion-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light","feature-state"]},"property-type":"data-driven"},"fill-extrusion-line-width":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"fill-extrusion-cast-shadows":{"type":"boolean","default":true}},"paint_building":{"building-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"building-ambient-occlusion-intensity":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{"parameters":[]},"transition":true},"building-ambient-occlusion-ground-intensity":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"building-ambient-occlusion-ground-radius":{"type":"number","default":3,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"building-ambient-occlusion-ground-attenuation":{"type":"number","default":0.69,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"building-vertical-scale":{"type":"number","default":1,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"building-cast-shadows":{"type":"boolean","default":true},"building-color":{"type":"color","default":"rgba(193, 154, 127, 1)","use-theme":true,"expression":{"interpolated":true,"parameters":["feature","feature-state","measure-light"]},"property-type":"data-driven"},"building-emissive-strength":{"type":"number","default":0,"minimum":0,"maximum":5,"expression":{"interpolated":true,"parameters":["feature","feature-state","measure-light"]},"property-type":"data-driven"},"building-facade-emissive-chance":{"type":"number","default":0.35,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["measure-light","zoom"]}},"building-cutoff-fade-range":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{}}},"paint_line":{"line-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"line-color":{"type":"color","default":"#000000","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"line-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"line-translate-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]}},"line-width":{"type":"number","default":1,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light","line-progress"]},"property-type":"data-driven"},"line-gap-width":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"line-offset":{"type":"number","default":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"line-blur":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"line-dasharray":{"type":"array","value":"number","minimum":0,"expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"line-pattern":{"type":"resolvedImage","expression":{"parameters":["zoom","feature"]},"property-type":"data-driven"},"line-pattern-cross-fade":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"line-gradient":{"type":"color","use-theme":true,"expression":{"interpolated":true,"parameters":["line-progress"]}},"line-trim-offset":{"type":"array","value":"number","length":2,"default":[0,0],"minimum":[0,0],"maximum":[1,1]},"line-trim-fade-range":{"type":"array","value":"number","length":2,"default":[0,0],"minimum":[0,0],"maximum":[1,1],"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"line-trim-color":{"type":"color","default":"transparent","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"line-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"line-border-width":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-border-color":{"type":"color","default":"rgba(0, 0, 0, 0)","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state"]},"property-type":"data-driven"},"line-occlusion-opacity":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true}},"paint_circle":{"circle-radius":{"type":"number","default":5,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-color":{"type":"color","default":"#000000","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-blur":{"type":"number","default":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"circle-translate-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]}},"circle-pitch-scale":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]}},"circle-pitch-alignment":{"type":"enum","values":{"map":1,"viewport":1},"default":"viewport","expression":{"parameters":["zoom"]}},"circle-stroke-width":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-stroke-color":{"type":"color","default":"#000000","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-stroke-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"circle-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}}},"paint_heatmap":{"heatmap-radius":{"type":"number","default":30,"minimum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"heatmap-weight":{"type":"number","default":1,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"heatmap-intensity":{"type":"number","default":1,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"heatmap-color":{"type":"color","default":["interpolate",["linear"],["heatmap-density"],0,"rgba(0, 0, 255, 0)",0.1,"royalblue",0.3,"cyan",0.5,"lime",0.7,"yellow",1,"red"],"use-theme":true,"expression":{"interpolated":true,"parameters":["heatmap-density"]}},"heatmap-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}}},"paint_symbol":{"icon-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"icon-occlusion-opacity":{"type":"number","minimum":0,"maximum":1,"default":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"icon-emissive-strength":{"type":"number","default":1,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light","feature-state"]},"property-type":"data-driven"},"text-emissive-strength":{"type":"number","default":1,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light","feature-state"]},"property-type":"data-driven"},"icon-color":{"type":"color","default":"#000000","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"icon-halo-color":{"type":"color","default":"rgba(0, 0, 0, 0)","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"icon-halo-width":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"icon-halo-blur":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"icon-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"icon-translate-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]}},"icon-image-cross-fade":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"text-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"text-occlusion-opacity":{"type":"number","minimum":0,"maximum":1,"default":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"text-color":{"type":"color","default":"#000000","use-theme":true,"transition":true,"overridable":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"text-halo-color":{"type":"color","default":"rgba(0, 0, 0, 0)","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"text-halo-width":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"text-halo-blur":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature","feature-state","measure-light"]},"property-type":"data-driven"},"text-translate":{"type":"array","value":"number","length":2,"default":[0,0],"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"text-translate-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":["zoom"]}},"icon-color-saturation":{"type":"number","default":0,"minimum":-1,"maximum":1,"expression":{}},"icon-color-contrast":{"type":"number","default":0,"minimum":-1,"maximum":1,"expression":{}},"icon-color-brightness-min":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{}},"icon-color-brightness-max":{"type":"number","default":1,"minimum":0,"maximum":1,"expression":{}},"symbol-z-offset":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","feature"]},"property-type":"data-driven"}},"paint_raster":{"raster-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-color":{"type":"color","use-theme":true,"expression":{"interpolated":true,"parameters":["raster-value"]}},"raster-color-mix":{"type":"array","default":[0.2126,0.7152,0.0722,0],"length":4,"value":"number","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-color-range":{"type":"array","length":2,"value":"number","transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-hue-rotate":{"type":"number","default":0,"period":360,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-brightness-min":{"type":"number","default":0,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-brightness-max":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-saturation":{"type":"number","default":0,"minimum":-1,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-contrast":{"type":"number","default":0,"minimum":-1,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-resampling":{"type":"enum","values":{"linear":1,"nearest":1},"default":"linear","expression":{"parameters":["zoom"]}},"raster-fade-duration":{"type":"number","default":300,"minimum":0,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"raster-array-band":{"type":"string"},"raster-elevation":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}}},"paint_raster-particle":{"raster-particle-array-band":{"type":"string"},"raster-particle-count":{"type":"number","default":512,"minimum":1},"raster-particle-color":{"type":"color","use-theme":true,"expression":{"interpolated":true,"parameters":["raster-particle-speed"]}},"raster-particle-max-speed":{"type":"number","default":1,"minimum":1},"raster-particle-speed-factor":{"type":"number","default":0.2,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-particle-fade-opacity-factor":{"type":"number","default":0.98,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"raster-particle-reset-rate-factor":{"type":"number","default":0.8,"minimum":0,"maximum":1},"raster-particle-elevation":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}}},"paint_hillshade":{"hillshade-illumination-direction":{"type":"number","default":335,"minimum":0,"maximum":359,"expression":{"interpolated":true,"parameters":["zoom"]}},"hillshade-illumination-anchor":{"type":"enum","values":{"map":1,"viewport":1},"default":"viewport","expression":{"parameters":["zoom"]}},"hillshade-exaggeration":{"type":"number","default":0.5,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"hillshade-shadow-color":{"type":"color","default":"#000000","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"hillshade-highlight-color":{"type":"color","default":"#FFFFFF","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"hillshade-accent-color":{"type":"color","default":"#000000","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}},"hillshade-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}}},"paint_background":{"background-pitch-alignment":{"type":"enum","values":{"map":1,"viewport":1},"default":"map","expression":{"parameters":[]}},"background-color":{"type":"color","default":"#000000","use-theme":true,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"background-pattern":{"type":"resolvedImage","expression":{"parameters":["zoom"]}},"background-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}},"background-emissive-strength":{"type":"number","default":0,"minimum":0,"transition":true,"expression":{"interpolated":true,"parameters":["zoom","measure-light"]}}},"paint_sky":{"sky-type":{"type":"enum","values":{"gradient":1,"atmosphere":1},"default":"atmosphere","expression":{"parameters":["zoom"]}},"sky-atmosphere-sun":{"type":"array","value":"number","length":2,"minimum":[0,0],"maximum":[360,180],"expression":{"parameters":["zoom"]}},"sky-atmosphere-sun-intensity":{"type":"number","default":10,"minimum":0,"maximum":100},"sky-gradient-center":{"type":"array","value":"number","default":[0,0],"length":2,"minimum":[0,0],"maximum":[360,180],"expression":{"parameters":["zoom"]}},"sky-gradient-radius":{"type":"number","default":90,"minimum":0,"maximum":180,"expression":{"parameters":["zoom"]}},"sky-gradient":{"type":"color","default":["interpolate",["linear"],["sky-radial-progress"],0.8,"#87ceeb",1,"white"],"use-theme":true,"expression":{"interpolated":true,"parameters":["sky-radial-progress"]}},"sky-atmosphere-halo-color":{"type":"color","default":"white","use-theme":true},"sky-atmosphere-color":{"type":"color","default":"white","use-theme":true},"sky-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["zoom"]}}},"paint_model":{"model-opacity":{"type":"number","default":1,"minimum":0,"maximum":1,"transition":true,"expression":{"interpolated":true,"parameters":["feature","feature-state","zoom"]},"property-type":"data-driven"},"model-rotation":{"type":"array","value":"number","length":3,"default":[0,0,0],"period":360,"property-type":"data-driven","expression":{"interpolated":true,"parameters":["feature","feature-state","zoom"]},"transition":true},"model-scale":{"type":"array","value":"number","length":3,"default":[1,1,1],"property-type":"data-driven","expression":{"interpolated":true,"parameters":["feature","feature-state","zoom"]},"transition":true},"model-translation":{"type":"array","value":"number","length":3,"default":[0,0,0],"property-type":"data-driven","expression":{"interpolated":true,"parameters":["feature","feature-state","zoom"]},"transition":true},"model-color":{"type":"color","default":"#ffffff","property-type":"data-driven","expression":{"interpolated":true,"parameters":["feature","feature-state","measure-light","zoom"]},"use-theme":true,"transition":true},"model-color-mix-intensity":{"type":"number","property-type":"data-driven","default":0,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["feature","feature-state","measure-light"]},"transition":true},"model-type":{"type":"enum","values":{"common-3d":1,"location-indicator":1},"default":"common-3d"},"model-cast-shadows":{"type":"boolean","default":true},"model-receive-shadows":{"type":"boolean","default":true},"model-ambient-occlusion-intensity":{"type":"number","default":1,"minimum":0,"maximum":1,"expression":{"interpolated":true,"parameters":["zoom"]},"transition":true},"model-emissive-strength":{"type":"number","property-type":"data-driven","default":0,"minimum":0,"maximum":5,"expression":{"interpolated":true,"parameters":["feature","feature-state","measure-light"]},"transition":true},"model-roughness":{"type":"number","default":1,"minimum":0,"maximum":1,"property-type":"data-driven","expression":{"interpolated":true,"parameters":["feature","feature-state"]},"transition":true},"model-height-based-emissive-strength-multiplier":{"type":"array","default":[1,1,1,1,0],"length":5,"value":"number","property-type":"data-driven","expression":{"interpolated":true,"parameters":["feature","feature-state","measure-light"]},"transition":true},"model-cutoff-fade-range":{"type":"number","default":0,"minimum":0,"maximum":1,"expression":{}},"model-front-cutoff":{"type":"array","value":"number","expression":{"interpolated":true,"parameters":["zoom"]},"length":3,"default":[0,0,1],"minimum":[0,0,0],"maximum":[1,1,1]}},"transition":{"duration":{"type":"number","default":300,"minimum":0},"delay":{"type":"number","default":0,"minimum":0}},"promoteId":{"*":{"type":"*"}}}');function Ma(n){return n instanceof Number||n instanceof String||n instanceof Boolean?n.valueOf():n}function vc(n){if(Array.isArray(n))return n.map(vc);if(n instanceof Object&&!(n instanceof Number||n instanceof String||n instanceof Boolean)){const e={};for(const i in n)e[i]=vc(n[i]);return e}return Ma(n)}function Cu(n){if(n===!0||n===!1)return!0;if(!Array.isArray(n)||n.length===0)return!1;switch(n[0]){case"has":return n.length>=2&&n[1]!=="$id"&&n[1]!=="$type";case"in":return n.length>=3&&(typeof n[1]!="string"||Array.isArray(n[2]));case"!in":case"!has":case"none":return!1;case"==":case"!=":case">":case">=":case"<":case"<=":return n.length!==3||Array.isArray(n[1])||Array.isArray(n[2]);case"any":case"all":for(const e of n.slice(1))if(!Cu(e)&&typeof e!="boolean")return!1;return!0;default:return!0}}function Gc(n,e="",i=null,o="fill"){if(n==null)return{filter:()=>!0,needGeometry:!1,needFeature:!1};Cu(n)||(n=nd(n));const a=n;let h=!0;try{h=(function(C){if(!Pu(C))return C;let P=vc(C);return id(P),P=jd(P),P})(a)}catch{console.warn(`Failed to extract static filter. Filter will continue working, but at higher memory usage and slower framerate.
This is most likely a bug, please report this via https://github.com/mapbox/mapbox-gl-js/issues/new?assignees=&labels=&template=Bug_report.md
and paste the contents of this message in the report.
Thank you!
Filter Expression:
${JSON.stringify(a,null,2)}
        `)}let d=null,y=null;if(o!=="background"&&o!=="sky"&&o!=="slot"){y=Le[`filter_${o}`];const C=Zl(h,y,e,i);if(C.result==="error")throw new Error(C.value.map((P=>`${P.key}: ${P.message}`)).join(", "));d=(P,D,O)=>C.value.evaluate(P,D,{},O)}let w=null,T=null;if(h!==a){const C=Zl(a,y,e,i);if(C.result==="error")throw new Error(C.value.map((P=>`${P.key}: ${P.message}`)).join(", "));w=(P,D,O,N,G)=>C.value.evaluate(P,D,{},O,void 0,void 0,N,G),T=!uc(C.value.expression)}return{filter:d,dynamicFilter:w||void 0,needGeometry:Gd(h),needFeature:!!T}}function jd(n){if(!Array.isArray(n))return n;const e=(function(i){if(wl.has(i[0])){for(let o=1;o<i.length;o++)if(Pu(i[o]))return!0}return i})(n);return e===!0?e:e.map((i=>jd(i)))}function id(n){let e=!1;const i=[];if(n[0]==="case"){for(let o=1;o<n.length-1;o+=2)e=e||Pu(n[o]),i.push(n[o+1]);i.push(n[n.length-1])}else if(n[0]==="match"){e=e||Pu(n[1]);for(let o=2;o<n.length-1;o+=2)i.push(n[o+1]);i.push(n[n.length-1])}else if(n[0]==="step"){e=e||Pu(n[1]);for(let o=1;o<n.length-1;o+=2)i.push(n[o+1])}e&&(n.length=0,n.push("any",...i));for(let o=1;o<n.length;o++)id(n[o])}function Pu(n){if(!Array.isArray(n))return!1;if((e=n[0])==="pitch"||e==="distance-from-center")return!0;var e;for(let i=1;i<n.length;i++)if(Pu(n[i]))return!0;return!1}const wl=new Set(["in","==","!=",">",">=","<","<=","to-boolean"]);function Ap(n,e){return n<e?-1:n>e?1:0}function Gd(n){if(!Array.isArray(n))return!1;if(n[0]==="within"||n[0]==="distance")return!0;for(let e=1;e<n.length;e++)if(Gd(n[e]))return!0;return!1}function nd(n){if(!n)return!0;const e=n[0];return n.length<=1?e!=="any":e==="=="?Hd(n[1],n[2],"=="):e==="!="?Ru(Hd(n[1],n[2],"==")):e==="<"||e===">"||e==="<="||e===">="?Hd(n[1],n[2],e):e==="any"?(i=n.slice(1),["any"].concat(i.map(nd))):e==="all"?["all"].concat(n.slice(1).map(nd)):e==="none"?["all"].concat(n.slice(1).map(nd).map(Ru)):e==="in"?ah(n[1],n.slice(2)):e==="!in"?Ru(ah(n[1],n.slice(2))):e==="has"?qf(n[1]):e!=="!has"||Ru(qf(n[1]));var i}function Hd(n,e,i){switch(n){case"$type":return[`filter-type-${i}`,e];case"$id":return[`filter-id-${i}`,e];default:return[`filter-${i}`,n,e]}}function ah(n,e){if(e.length===0)return!1;switch(n){case"$type":return["filter-type-in",["literal",e]];case"$id":return["filter-id-in",["literal",e]];default:return e.length>200&&!e.some((i=>typeof i!=typeof e[0]))?["filter-in-large",n,["literal",e.sort(Ap)]]:["filter-in-small",n,["literal",e]]}}function qf(n){switch(n){case"$type":return!0;case"$id":return["filter-has-id"];default:return["filter-has",n]}}function Ru(n){return["!",n]}const Hc="";function Mu(n,e){return e?`${n}${Hc}${e}`:n}const qd="-transition",Cp=new Set(["fill","line","background","hillshade","raster"]);class ho extends hl{constructor(e,i,o,a,h){if(super(),this.id=e.id,this.fqid=Mu(this.id,o),this.type=e.type,this.scope=o,this.lut=a,this.options=h,this._featureFilter={filter:()=>!0,needGeometry:!1,needFeature:!1},this._filterCompiled=!1,this.configDependencies=new Set,e.type!=="custom"){if(this.metadata=e.metadata,this.minzoom=e.minzoom,this.maxzoom=e.maxzoom,e.type&&e.type!=="background"&&e.type!=="sky"&&e.type!=="slot"){this.source=e.source,this.sourceLayer=e["source-layer"],this.filter=e.filter;const d=Zl(this.filter,Le[`filter_${e.type}`]);d.result!=="error"&&(this.configDependencies=new Set([...this.configDependencies,...d.value.configDependencies]))}if(e.slot&&(this.slot=e.slot),i.layout&&(this._unevaluatedLayout=new Ja(i.layout,this.scope,h),this.configDependencies=new Set([...this.configDependencies,...this._unevaluatedLayout.configDependencies])),i.paint){this._transitionablePaint=new Ts(i.paint,this.scope,h);for(const d in e.paint)this.setPaintProperty(d,e.paint[d]);for(const d in e.layout)this.setLayoutProperty(d,e.layout[d]);this.configDependencies=new Set([...this.configDependencies,...this._transitionablePaint.configDependencies]),this._transitioningPaint=this._transitionablePaint.untransitioned(),this.paint=new xl(i.paint)}}}onAdd(e){}onRemove(e){}isDraped(e){return!this.is3D(!0)&&Cp.has(this.type)}getLayoutProperty(e){return e==="visibility"?this.visibility:this._unevaluatedLayout.getValue(e)}setLayoutProperty(e,i){if(this.type==="custom"&&e==="visibility")return void(this.visibility=i);const o=this._unevaluatedLayout;o._properties.properties[e]&&(o.setValue(e,i),this.configDependencies=new Set([...this.configDependencies,...o.configDependencies]),e==="visibility"&&this.possiblyEvaluateVisibility())}possiblyEvaluateVisibility(){this._unevaluatedLayout._values.visibility&&(this.visibility=this._unevaluatedLayout._values.visibility.possiblyEvaluate({zoom:0}))}getPaintProperty(e){return e.endsWith(qd)?this._transitionablePaint.getTransition(e.slice(0,-11)):this._transitionablePaint.getValue(e)}setPaintProperty(e,i){const o=this._transitionablePaint,a=o._properties.properties;if(e.endsWith(qd)){const P=e.slice(0,-11);return a[P]&&o.setTransition(P,i||void 0),!1}if(!a[e])return!1;const h=o._values[e],d=h.value.isDataDriven(),y=h.value;o.setValue(e,i),this.configDependencies=new Set([...this.configDependencies,...o.configDependencies]),this._handleSpecialPaintPropertyUpdate(e);const w=o._values[e].value,T=w.isDataDriven(),C=e.endsWith("pattern")||e==="line-dasharray";return T||d||C||this._handleOverridablePaintPropertyUpdate(e,y,w)}_handleSpecialPaintPropertyUpdate(e){}getProgramIds(){return null}getDefaultProgramParams(e,i,o){return null}_handleOverridablePaintPropertyUpdate(e,i,o){return!1}isHidden(e){return!!(this.minzoom&&e<this.minzoom)||!!(this.maxzoom&&e>=this.maxzoom)||this.visibility==="none"}updateTransitions(e){this._transitioningPaint=this._transitionablePaint.transitioned(e,this._transitioningPaint)}hasTransition(){return this._transitioningPaint.hasTransition()}recalculate(e,i){this._unevaluatedLayout&&(this.layout=this._unevaluatedLayout.possiblyEvaluate(e,void 0,i)),this.paint=this._transitioningPaint.possiblyEvaluate(e,void 0,i)}serialize(){return Ki({id:this.id,type:this.type,slot:this.slot,source:this.source,"source-layer":this.sourceLayer,metadata:this.metadata,minzoom:this.minzoom,maxzoom:this.maxzoom,filter:this.filter,layout:this._unevaluatedLayout&&this._unevaluatedLayout.serialize(),paint:this._transitionablePaint&&this._transitionablePaint.serialize()},((e,i)=>!(e===void 0||i==="layout"&&!Object.keys(e).length||i==="paint"&&!Object.keys(e).length)))}is3D(e){return!1}hasElevation(){return!1}isSky(){return!1}isTileClipped(){return!1}hasOffscreenPass(){return!1}hasShadowPass(){return!1}canCastShadows(){return!1}hasLightBeamPass(){return!1}cutoffRange(){return 0}tileCoverLift(){return 0}resize(){}_clear(){}isStateDependent(){for(const e in this.paint._values){const i=this.paint.get(e);if(i instanceof vl&&rh(i.property.specification)&&(i.value.kind==="source"||i.value.kind==="composite")&&i.value.isStateDependent)return!0}return!1}compileFilter(e){this._filterCompiled||(this._featureFilter=Gc(this.filter,this.scope,e),this._filterCompiled=!0)}invalidateCompiledFilter(){this._filterCompiled=!1}dynamicFilter(){return this._featureFilter.dynamicFilter}dynamicFilterNeedsFeature(){return this._featureFilter.needFeature}getLayerRenderingStats(){return this._stats}resetLayerRenderingStats(e){this._stats&&(e.renderPass==="shadow"?this._stats.numRenderedVerticesInShadowPass=0:this._stats.numRenderedVerticesInTransparentPass=0)}queryRadius(e){}queryIntersectsFeature(e,i,o,a,h,d,y,w,T){}}const Pp={Int8:Int8Array,Uint8:Uint8Array,Int16:Int16Array,Uint16:Uint16Array,Int32:Int32Array,Uint32:Uint32Array,Float32:Float32Array};class lh{constructor(e,i){this._structArray=e,this._pos1=i*this.size,this._pos2=this._pos1/2,this._pos4=this._pos1/4,this._pos8=this._pos1/8}}class _r{constructor(){this.capacity=-1,this.resize(0)}static serialize(e,i){return e._trim(),i&&i.add(e.arrayBuffer),{length:e.length,arrayBuffer:e.arrayBuffer}}static deserialize(e){const i=Object.create(this.prototype);return i.arrayBuffer=e.arrayBuffer,i.length=e.length,i.capacity=e.arrayBuffer.byteLength/i.bytesPerElement,i._refreshViews(),i}_trim(){this.length!==this.capacity&&(this.capacity=this.length,this.arrayBuffer=this.arrayBuffer.slice(0,this.length*this.bytesPerElement),this._refreshViews())}clear(){this.length=0}resize(e){this.reserve(e),this.length=e}reserve(e){if(e>this.capacity){this.capacity=Math.max(e,Math.floor(5*this.capacity),128),this.arrayBuffer=new ArrayBuffer(this.capacity*this.bytesPerElement);const i=this.uint8;this._refreshViews(),i&&this.uint8.set(i)}}_refreshViews(){throw new Error("StructArray#_refreshViews() must be implemented by each concrete StructArray layout")}emplace(...e){throw new Error("StructArray#emplace() must be implemented by each concrete StructArray layout")}emplaceBack(...e){throw new Error("StructArray#emplaceBack() must be implemented by each concrete StructArray layout")}destroy(){this.int8=this.uint8=this.int16=this.uint16=this.int32=this.uint32=this.float32=null,this.arrayBuffer=null}}function hn(n,e=1){let i=0,o=0;return{members:n.map((a=>{const h=Pp[a.type].BYTES_PER_ELEMENT,d=i=$d(i,Math.max(e,h)),y=a.components||1;return o=Math.max(o,h),i+=h*y,{name:a.name,type:a.type,components:y,offset:d}})),size:$d(i,Math.max(o,e)),alignment:e}}function $d(n,e){return Math.ceil(n/e)*e}class Mo extends _r{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e,i){const o=this.length;return this.resize(o+1),this.emplace(o,e,i)}emplace(e,i,o){const a=2*e;return this.int16[a+0]=i,this.int16[a+1]=o,e}}Mo.prototype.bytesPerElement=4,Kt(Mo,"StructArrayLayout2i4");class ch extends _r{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e,i,o){const a=this.length;return this.resize(a+1),this.emplace(a,e,i,o)}emplace(e,i,o,a){const h=3*e;return this.int16[h+0]=i,this.int16[h+1]=o,this.int16[h+2]=a,e}}ch.prototype.bytesPerElement=6,Kt(ch,"StructArrayLayout3i6");class Du extends _r{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e,i,o,a){const h=this.length;return this.resize(h+1),this.emplace(h,e,i,o,a)}emplace(e,i,o,a,h){const d=4*e;return this.int16[d+0]=i,this.int16[d+1]=o,this.int16[d+2]=a,this.int16[d+3]=h,e}}Du.prototype.bytesPerElement=8,Kt(Du,"StructArrayLayout4i8");class Lu extends _r{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e){const i=this.length;return this.resize(i+1),this.emplace(i,e)}emplace(e,i){return this.float32[1*e+0]=i,e}}Lu.prototype.bytesPerElement=4,Kt(Lu,"StructArrayLayout1f4");class $f extends _r{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,i,o){const a=this.length;return this.resize(a+1),this.emplace(a,e,i,o)}emplace(e,i,o,a){const h=4*e,d=2*e;return this.int16[h+0]=i,this.int16[h+1]=o,this.float32[d+1]=a,e}}$f.prototype.bytesPerElement=8,Kt($f,"StructArrayLayout2i1f8");class Wd extends _r{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e,i,o){const a=this.length;return this.resize(a+1),this.emplace(a,e,i,o)}emplace(e,i,o,a){const h=4*e;return this.int16[h+0]=i,this.int16[h+1]=o,this.int16[h+2]=a,e}}Wd.prototype.bytesPerElement=8,Kt(Wd,"StructArrayLayout3i8");class rd extends _r{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e,i,o,a,h){const d=this.length;return this.resize(d+1),this.emplace(d,e,i,o,a,h)}emplace(e,i,o,a,h,d){const y=5*e;return this.int16[y+0]=i,this.int16[y+1]=o,this.int16[y+2]=a,this.int16[y+3]=h,this.int16[y+4]=d,e}}rd.prototype.bytesPerElement=10,Kt(rd,"StructArrayLayout5i10");class sd extends _r{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,i,o,a,h,d,y){const w=this.length;return this.resize(w+1),this.emplace(w,e,i,o,a,h,d,y)}emplace(e,i,o,a,h,d,y,w){const T=6*e,C=12*e,P=3*e;return this.int16[T+0]=i,this.int16[T+1]=o,this.uint8[C+4]=a,this.uint8[C+5]=h,this.uint8[C+6]=d,this.uint8[C+7]=y,this.float32[P+2]=w,e}}sd.prototype.bytesPerElement=12,Kt(sd,"StructArrayLayout2i4ub1f12");class Do extends _r{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,i,o){const a=this.length;return this.resize(a+1),this.emplace(a,e,i,o)}emplace(e,i,o,a){const h=3*e;return this.float32[h+0]=i,this.float32[h+1]=o,this.float32[h+2]=a,e}}Do.prototype.bytesPerElement=12,Kt(Do,"StructArrayLayout3f12");class qc extends _r{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,i,o,a,h){const d=this.length;return this.resize(d+1),this.emplace(d,e,i,o,a,h)}emplace(e,i,o,a,h,d){const y=6*e,w=3*e;return this.uint16[y+0]=i,this.uint16[y+1]=o,this.uint16[y+2]=a,this.uint16[y+3]=h,this.float32[w+2]=d,e}}qc.prototype.bytesPerElement=12,Kt(qc,"StructArrayLayout4ui1f12");class uh extends _r{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(e,i,o,a){const h=this.length;return this.resize(h+1),this.emplace(h,e,i,o,a)}emplace(e,i,o,a,h){const d=4*e;return this.uint16[d+0]=i,this.uint16[d+1]=o,this.uint16[d+2]=a,this.uint16[d+3]=h,e}}uh.prototype.bytesPerElement=8,Kt(uh,"StructArrayLayout4ui8");class Zd extends _r{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e,i,o,a,h,d){const y=this.length;return this.resize(y+1),this.emplace(y,e,i,o,a,h,d)}emplace(e,i,o,a,h,d,y){const w=6*e;return this.int16[w+0]=i,this.int16[w+1]=o,this.int16[w+2]=a,this.int16[w+3]=h,this.int16[w+4]=d,this.int16[w+5]=y,e}}Zd.prototype.bytesPerElement=12,Kt(Zd,"StructArrayLayout6i12");class sa extends _r{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(e,i,o,a,h,d,y,w,T,C,P,D){const O=this.length;return this.resize(O+1),this.emplace(O,e,i,o,a,h,d,y,w,T,C,P,D)}emplace(e,i,o,a,h,d,y,w,T,C,P,D,O){const N=12*e;return this.int16[N+0]=i,this.int16[N+1]=o,this.int16[N+2]=a,this.int16[N+3]=h,this.uint16[N+4]=d,this.uint16[N+5]=y,this.uint16[N+6]=w,this.uint16[N+7]=T,this.int16[N+8]=C,this.int16[N+9]=P,this.int16[N+10]=D,this.int16[N+11]=O,e}}sa.prototype.bytesPerElement=24,Kt(sa,"StructArrayLayout4i4ui4i24");class $c extends _r{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,i,o,a,h,d){const y=this.length;return this.resize(y+1),this.emplace(y,e,i,o,a,h,d)}emplace(e,i,o,a,h,d,y){const w=10*e,T=5*e;return this.int16[w+0]=i,this.int16[w+1]=o,this.int16[w+2]=a,this.float32[T+2]=h,this.float32[T+3]=d,this.float32[T+4]=y,e}}$c.prototype.bytesPerElement=20,Kt($c,"StructArrayLayout3i3f20");class bl extends _r{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,i,o,a){const h=this.length;return this.resize(h+1),this.emplace(h,e,i,o,a)}emplace(e,i,o,a,h){const d=4*e;return this.float32[d+0]=i,this.float32[d+1]=o,this.float32[d+2]=a,this.float32[d+3]=h,e}}bl.prototype.bytesPerElement=16,Kt(bl,"StructArrayLayout4f16");class Xd extends _r{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer)}emplaceBack(e){const i=this.length;return this.resize(i+1),this.emplace(i,e)}emplace(e,i){return this.uint32[1*e+0]=i,e}}Xd.prototype.bytesPerElement=4,Kt(Xd,"StructArrayLayout1ul4");class Tl extends _r{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(e,i){const o=this.length;return this.resize(o+1),this.emplace(o,e,i)}emplace(e,i,o){const a=2*e;return this.uint16[a+0]=i,this.uint16[a+1]=o,e}}Tl.prototype.bytesPerElement=4,Kt(Tl,"StructArrayLayout2ui4");class Kd extends _r{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(e,i,o,a,h,d,y,w,T,C,P,D,O){const N=this.length;return this.resize(N+1),this.emplace(N,e,i,o,a,h,d,y,w,T,C,P,D,O)}emplace(e,i,o,a,h,d,y,w,T,C,P,D,O,N){const G=20*e,q=10*e;return this.int16[G+0]=i,this.int16[G+1]=o,this.int16[G+2]=a,this.int16[G+3]=h,this.int16[G+4]=d,this.float32[q+3]=y,this.float32[q+4]=w,this.float32[q+5]=T,this.float32[q+6]=C,this.int16[G+14]=P,this.uint32[q+8]=D,this.uint16[G+18]=O,this.uint16[G+19]=N,e}}Kd.prototype.bytesPerElement=40,Kt(Kd,"StructArrayLayout5i4f1i1ul2ui40");class hh extends _r{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e,i,o,a,h,d,y){const w=this.length;return this.resize(w+1),this.emplace(w,e,i,o,a,h,d,y)}emplace(e,i,o,a,h,d,y,w){const T=8*e;return this.int16[T+0]=i,this.int16[T+1]=o,this.int16[T+2]=a,this.int16[T+4]=h,this.int16[T+5]=d,this.int16[T+6]=y,this.int16[T+7]=w,e}}hh.prototype.bytesPerElement=16,Kt(hh,"StructArrayLayout3i2i2i16");class El extends _r{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e,i,o,a,h){const d=this.length;return this.resize(d+1),this.emplace(d,e,i,o,a,h)}emplace(e,i,o,a,h,d){const y=4*e,w=8*e;return this.float32[y+0]=i,this.float32[y+1]=o,this.float32[y+2]=a,this.int16[w+6]=h,this.int16[w+7]=d,e}}El.prototype.bytesPerElement=16,Kt(El,"StructArrayLayout2f1f2i16");class Wc extends _r{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,i,o,a,h,d){const y=this.length;return this.resize(y+1),this.emplace(y,e,i,o,a,h,d)}emplace(e,i,o,a,h,d,y){const w=20*e,T=5*e;return this.uint8[w+0]=i,this.uint8[w+1]=o,this.float32[T+1]=a,this.float32[T+2]=h,this.float32[T+3]=d,this.float32[T+4]=y,e}}Wc.prototype.bytesPerElement=20,Kt(Wc,"StructArrayLayout2ub4f20");class yr extends _r{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(e,i,o){const a=this.length;return this.resize(a+1),this.emplace(a,e,i,o)}emplace(e,i,o,a){const h=3*e;return this.uint16[h+0]=i,this.uint16[h+1]=o,this.uint16[h+2]=a,e}}yr.prototype.bytesPerElement=6,Kt(yr,"StructArrayLayout3ui6");class dh extends _r{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer)}emplaceBack(e,i,o,a,h,d,y,w,T,C,P,D,O,N,G,q,Y,se,re,ae,Ee){const ve=this.length;return this.resize(ve+1),this.emplace(ve,e,i,o,a,h,d,y,w,T,C,P,D,O,N,G,q,Y,se,re,ae,Ee)}emplace(e,i,o,a,h,d,y,w,T,C,P,D,O,N,G,q,Y,se,re,ae,Ee,ve){const xe=30*e,Pe=15*e,Me=60*e;return this.int16[xe+0]=i,this.int16[xe+1]=o,this.int16[xe+2]=a,this.float32[Pe+2]=h,this.float32[Pe+3]=d,this.uint16[xe+8]=y,this.uint16[xe+9]=w,this.uint32[Pe+5]=T,this.uint32[Pe+6]=C,this.uint32[Pe+7]=P,this.uint16[xe+16]=D,this.uint16[xe+17]=O,this.uint16[xe+18]=N,this.float32[Pe+10]=G,this.float32[Pe+11]=q,this.uint8[Me+48]=Y,this.uint8[Me+49]=se,this.uint8[Me+50]=re,this.uint32[Pe+13]=ae,this.int16[xe+28]=Ee,this.uint8[Me+58]=ve,e}}dh.prototype.bytesPerElement=60,Kt(dh,"StructArrayLayout3i2f2ui3ul3ui2f3ub1ul1i1ub60");class Yd extends _r{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer)}emplaceBack(e,i,o,a,h,d,y,w,T,C,P,D,O,N,G,q,Y,se,re,ae,Ee,ve,xe,Pe,Me,it,Fe,ot,Dt,ht,bt,Rt,et){const Tt=this.length;return this.resize(Tt+1),this.emplace(Tt,e,i,o,a,h,d,y,w,T,C,P,D,O,N,G,q,Y,se,re,ae,Ee,ve,xe,Pe,Me,it,Fe,ot,Dt,ht,bt,Rt,et)}emplace(e,i,o,a,h,d,y,w,T,C,P,D,O,N,G,q,Y,se,re,ae,Ee,ve,xe,Pe,Me,it,Fe,ot,Dt,ht,bt,Rt,et,Tt){const Ve=20*e,tt=40*e,Lt=80*e;return this.float32[Ve+0]=i,this.float32[Ve+1]=o,this.int16[tt+4]=a,this.int16[tt+5]=h,this.int16[tt+6]=d,this.int16[tt+7]=y,this.int16[tt+8]=w,this.int16[tt+9]=T,this.int16[tt+10]=C,this.int16[tt+11]=P,this.int16[tt+12]=D,this.uint16[tt+13]=O,this.uint16[tt+14]=N,this.uint16[tt+15]=G,this.uint16[tt+16]=q,this.uint16[tt+17]=Y,this.uint16[tt+18]=se,this.uint16[tt+19]=re,this.uint16[tt+20]=ae,this.uint16[tt+21]=Ee,this.uint16[tt+22]=ve,this.uint16[tt+23]=xe,this.uint16[tt+24]=Pe,this.uint16[tt+25]=Me,this.uint16[tt+26]=it,this.uint16[tt+27]=Fe,this.uint32[Ve+14]=ot,this.float32[Ve+15]=Dt,this.float32[Ve+16]=ht,this.float32[Ve+17]=bt,this.float32[Ve+18]=Rt,this.uint8[Lt+76]=et,this.uint16[tt+39]=Tt,e}}Yd.prototype.bytesPerElement=80,Kt(Yd,"StructArrayLayout2f9i15ui1ul4f1ub1ui80");class Qd extends _r{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,i,o,a,h,d){const y=this.length;return this.resize(y+1),this.emplace(y,e,i,o,a,h,d)}emplace(e,i,o,a,h,d,y){const w=6*e;return this.float32[w+0]=i,this.float32[w+1]=o,this.float32[w+2]=a,this.float32[w+3]=h,this.float32[w+4]=d,this.float32[w+5]=y,e}}Qd.prototype.bytesPerElement=24,Kt(Qd,"StructArrayLayout6f24");class Zc extends _r{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,i,o,a,h){const d=this.length;return this.resize(d+1),this.emplace(d,e,i,o,a,h)}emplace(e,i,o,a,h,d){const y=5*e;return this.float32[y+0]=i,this.float32[y+1]=o,this.float32[y+2]=a,this.float32[y+3]=h,this.float32[y+4]=d,e}}Zc.prototype.bytesPerElement=20,Kt(Zc,"StructArrayLayout5f20");class Jd extends _r{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,i,o,a,h,d,y){const w=this.length;return this.resize(w+1),this.emplace(w,e,i,o,a,h,d,y)}emplace(e,i,o,a,h,d,y,w){const T=7*e;return this.float32[T+0]=i,this.float32[T+1]=o,this.float32[T+2]=a,this.float32[T+3]=h,this.float32[T+4]=d,this.float32[T+5]=y,this.float32[T+6]=w,e}}Jd.prototype.bytesPerElement=28,Kt(Jd,"StructArrayLayout7f28");class fh extends _r{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,i,o,a,h,d,y,w,T,C,P){const D=this.length;return this.resize(D+1),this.emplace(D,e,i,o,a,h,d,y,w,T,C,P)}emplace(e,i,o,a,h,d,y,w,T,C,P,D){const O=11*e;return this.float32[O+0]=i,this.float32[O+1]=o,this.float32[O+2]=a,this.float32[O+3]=h,this.float32[O+4]=d,this.float32[O+5]=y,this.float32[O+6]=w,this.float32[O+7]=T,this.float32[O+8]=C,this.float32[O+9]=P,this.float32[O+10]=D,e}}fh.prototype.bytesPerElement=44,Kt(fh,"StructArrayLayout11f44");class Wf extends _r{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,i,o,a,h,d,y,w,T){const C=this.length;return this.resize(C+1),this.emplace(C,e,i,o,a,h,d,y,w,T)}emplace(e,i,o,a,h,d,y,w,T,C){const P=9*e;return this.float32[P+0]=i,this.float32[P+1]=o,this.float32[P+2]=a,this.float32[P+3]=h,this.float32[P+4]=d,this.float32[P+5]=y,this.float32[P+6]=w,this.float32[P+7]=T,this.float32[P+8]=C,e}}Wf.prototype.bytesPerElement=36,Kt(Wf,"StructArrayLayout9f36");class zs extends _r{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,i){const o=this.length;return this.resize(o+1),this.emplace(o,e,i)}emplace(e,i,o){const a=2*e;return this.float32[a+0]=i,this.float32[a+1]=o,e}}zs.prototype.bytesPerElement=8,Kt(zs,"StructArrayLayout2f8");class wo extends _r{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint32=new Uint32Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(e,i,o,a){const h=this.length;return this.resize(h+1),this.emplace(h,e,i,o,a)}emplace(e,i,o,a,h){const d=6*e;return this.uint32[3*e+0]=i,this.uint16[d+2]=o,this.uint16[d+3]=a,this.uint16[d+4]=h,e}}wo.prototype.bytesPerElement=12,Kt(wo,"StructArrayLayout1ul3ui12");class ef extends _r{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer)}emplaceBack(e){const i=this.length;return this.resize(i+1),this.emplace(i,e)}emplace(e,i){return this.uint16[1*e+0]=i,e}}ef.prototype.bytesPerElement=2,Kt(ef,"StructArrayLayout1ui2");class od extends _r{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,i,o,a,h,d,y,w,T,C,P,D,O,N,G,q){const Y=this.length;return this.resize(Y+1),this.emplace(Y,e,i,o,a,h,d,y,w,T,C,P,D,O,N,G,q)}emplace(e,i,o,a,h,d,y,w,T,C,P,D,O,N,G,q,Y){const se=16*e;return this.float32[se+0]=i,this.float32[se+1]=o,this.float32[se+2]=a,this.float32[se+3]=h,this.float32[se+4]=d,this.float32[se+5]=y,this.float32[se+6]=w,this.float32[se+7]=T,this.float32[se+8]=C,this.float32[se+9]=P,this.float32[se+10]=D,this.float32[se+11]=O,this.float32[se+12]=N,this.float32[se+13]=G,this.float32[se+14]=q,this.float32[se+15]=Y,e}}od.prototype.bytesPerElement=64,Kt(od,"StructArrayLayout16f64");class ku extends _r{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.uint16=new Uint16Array(this.arrayBuffer),this.float32=new Float32Array(this.arrayBuffer)}emplaceBack(e,i,o,a,h,d,y){const w=this.length;return this.resize(w+1),this.emplace(w,e,i,o,a,h,d,y)}emplace(e,i,o,a,h,d,y,w){const T=10*e,C=5*e;return this.uint16[T+0]=i,this.uint16[T+1]=o,this.uint16[T+2]=a,this.uint16[T+3]=h,this.float32[C+2]=d,this.float32[C+3]=y,this.float32[C+4]=w,e}}ku.prototype.bytesPerElement=20,Kt(ku,"StructArrayLayout4ui3f20");class tf extends _r{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer),this.int16=new Int16Array(this.arrayBuffer)}emplaceBack(e){const i=this.length;return this.resize(i+1),this.emplace(i,e)}emplace(e,i){return this.int16[1*e+0]=i,e}}tf.prototype.bytesPerElement=2,Kt(tf,"StructArrayLayout1i2");class ad extends _r{_refreshViews(){this.uint8=new Uint8Array(this.arrayBuffer)}emplaceBack(e){const i=this.length;return this.resize(i+1),this.emplace(i,e)}emplace(e,i){return this.uint8[1*e+0]=i,e}}ad.prototype.bytesPerElement=1,Kt(ad,"StructArrayLayout1ub1");class ld extends lh{get projectedAnchorX(){return this._structArray.int16[this._pos2+0]}get projectedAnchorY(){return this._structArray.int16[this._pos2+1]}get projectedAnchorZ(){return this._structArray.int16[this._pos2+2]}get tileAnchorX(){return this._structArray.int16[this._pos2+3]}get tileAnchorY(){return this._structArray.int16[this._pos2+4]}get x1(){return this._structArray.float32[this._pos4+3]}get y1(){return this._structArray.float32[this._pos4+4]}get x2(){return this._structArray.float32[this._pos4+5]}get y2(){return this._structArray.float32[this._pos4+6]}get padding(){return this._structArray.int16[this._pos2+14]}get featureIndex(){return this._structArray.uint32[this._pos4+8]}get sourceLayerIndex(){return this._structArray.uint16[this._pos2+18]}get bucketIndex(){return this._structArray.uint16[this._pos2+19]}}ld.prototype.size=40;class Zf extends Kd{get(e){return new ld(this,e)}}Kt(Zf,"CollisionBoxArray");class ph extends lh{get projectedAnchorX(){return this._structArray.int16[this._pos2+0]}get projectedAnchorY(){return this._structArray.int16[this._pos2+1]}get projectedAnchorZ(){return this._structArray.int16[this._pos2+2]}get tileAnchorX(){return this._structArray.float32[this._pos4+2]}get tileAnchorY(){return this._structArray.float32[this._pos4+3]}get glyphStartIndex(){return this._structArray.uint16[this._pos2+8]}get numGlyphs(){return this._structArray.uint16[this._pos2+9]}get vertexStartIndex(){return this._structArray.uint32[this._pos4+5]}get lineStartIndex(){return this._structArray.uint32[this._pos4+6]}get lineLength(){return this._structArray.uint32[this._pos4+7]}get segment(){return this._structArray.uint16[this._pos2+16]}get lowerSize(){return this._structArray.uint16[this._pos2+17]}get upperSize(){return this._structArray.uint16[this._pos2+18]}get lineOffsetX(){return this._structArray.float32[this._pos4+10]}get lineOffsetY(){return this._structArray.float32[this._pos4+11]}get writingMode(){return this._structArray.uint8[this._pos1+48]}get placedOrientation(){return this._structArray.uint8[this._pos1+49]}set placedOrientation(e){this._structArray.uint8[this._pos1+49]=e}get hidden(){return this._structArray.uint8[this._pos1+50]}set hidden(e){this._structArray.uint8[this._pos1+50]=e}get crossTileID(){return this._structArray.uint32[this._pos4+13]}set crossTileID(e){this._structArray.uint32[this._pos4+13]=e}get associatedIconIndex(){return this._structArray.int16[this._pos2+28]}get flipState(){return this._structArray.uint8[this._pos1+58]}set flipState(e){this._structArray.uint8[this._pos1+58]=e}}ph.prototype.size=60;class mh extends dh{get(e){return new ph(this,e)}}Kt(mh,"PlacedSymbolArray");class nf extends lh{get tileAnchorX(){return this._structArray.float32[this._pos4+0]}get tileAnchorY(){return this._structArray.float32[this._pos4+1]}get projectedAnchorX(){return this._structArray.int16[this._pos2+4]}get projectedAnchorY(){return this._structArray.int16[this._pos2+5]}get projectedAnchorZ(){return this._structArray.int16[this._pos2+6]}get rightJustifiedTextSymbolIndex(){return this._structArray.int16[this._pos2+7]}get centerJustifiedTextSymbolIndex(){return this._structArray.int16[this._pos2+8]}get leftJustifiedTextSymbolIndex(){return this._structArray.int16[this._pos2+9]}get verticalPlacedTextSymbolIndex(){return this._structArray.int16[this._pos2+10]}get placedIconSymbolIndex(){return this._structArray.int16[this._pos2+11]}get verticalPlacedIconSymbolIndex(){return this._structArray.int16[this._pos2+12]}get key(){return this._structArray.uint16[this._pos2+13]}get textBoxStartIndex(){return this._structArray.uint16[this._pos2+14]}get textBoxEndIndex(){return this._structArray.uint16[this._pos2+15]}get verticalTextBoxStartIndex(){return this._structArray.uint16[this._pos2+16]}get verticalTextBoxEndIndex(){return this._structArray.uint16[this._pos2+17]}get iconBoxStartIndex(){return this._structArray.uint16[this._pos2+18]}get iconBoxEndIndex(){return this._structArray.uint16[this._pos2+19]}get verticalIconBoxStartIndex(){return this._structArray.uint16[this._pos2+20]}get verticalIconBoxEndIndex(){return this._structArray.uint16[this._pos2+21]}get featureIndex(){return this._structArray.uint16[this._pos2+22]}get numHorizontalGlyphVertices(){return this._structArray.uint16[this._pos2+23]}get numVerticalGlyphVertices(){return this._structArray.uint16[this._pos2+24]}get numIconVertices(){return this._structArray.uint16[this._pos2+25]}get numVerticalIconVertices(){return this._structArray.uint16[this._pos2+26]}get useRuntimeCollisionCircles(){return this._structArray.uint16[this._pos2+27]}get crossTileID(){return this._structArray.uint32[this._pos4+14]}set crossTileID(e){this._structArray.uint32[this._pos4+14]=e}get textOffset0(){return this._structArray.float32[this._pos4+15]}get textOffset1(){return this._structArray.float32[this._pos4+16]}get collisionCircleDiameter(){return this._structArray.float32[this._pos4+17]}get zOffset(){return this._structArray.float32[this._pos4+18]}set zOffset(e){this._structArray.float32[this._pos4+18]=e}get hasIconTextFit(){return this._structArray.uint8[this._pos1+76]}get elevationFeatureIndex(){return this._structArray.uint16[this._pos2+39]}}nf.prototype.size=80;class rf extends Yd{get(e){return new nf(this,e)}}Kt(rf,"SymbolInstanceArray");class cd extends Lu{getoffsetX(e){return this.float32[1*e+0]}}Kt(cd,"GlyphOffsetArray");class Xf extends Mo{getx(e){return this.int16[2*e+0]}gety(e){return this.int16[2*e+1]}}Kt(Xf,"SymbolLineVertexArray");class _h extends lh{get featureIndex(){return this._structArray.uint32[this._pos4+0]}get sourceLayerIndex(){return this._structArray.uint16[this._pos2+2]}get bucketIndex(){return this._structArray.uint16[this._pos2+3]}get layoutVertexArrayOffset(){return this._structArray.uint16[this._pos2+4]}}_h.prototype.size=12;class ud extends wo{get(e){return new _h(this,e)}}Kt(ud,"FeatureIndexArray");class Rp extends Tl{geta_centroid_pos0(e){return this.uint16[2*e+0]}geta_centroid_pos1(e){return this.uint16[2*e+1]}}Kt(Rp,"FillExtrusionCentroidArray");class Kf extends lh{get a_join_normal_inside0(){return this._structArray.int16[this._pos2+0]}get a_join_normal_inside1(){return this._structArray.int16[this._pos2+1]}get a_join_normal_inside2(){return this._structArray.int16[this._pos2+2]}}Kf.prototype.size=6;class sf extends ch{get(e){return new Kf(this,e)}}Kt(sf,"FillExtrusionWallArray");const Yf=hn([{name:"a_pos",components:2,type:"Int16"}],4),of=hn([{name:"a_circle_z_offset",components:1,type:"Float32"}],4),xc=hn([{name:"a_pos_3",components:3,type:"Int16"},{name:"a_pos_normal_3",components:3,type:"Int16"}]);class kr{constructor(e=[]){this.segments=e}_prepareSegment(e,i,o,a){let h=this.segments[this.segments.length-1];return e>kr.MAX_VERTEX_ARRAY_LENGTH&&tn(`Max vertices per segment is ${kr.MAX_VERTEX_ARRAY_LENGTH}: bucket requested ${e}`),(!h||h.vertexLength+e>kr.MAX_VERTEX_ARRAY_LENGTH||h.sortKey!==a)&&(h={vertexOffset:i,primitiveOffset:o,vertexLength:0,primitiveLength:0},a!==void 0&&(h.sortKey=a),this.segments.push(h)),h}prepareSegment(e,i,o,a){return this._prepareSegment(e,i.length,o.length,a)}get(){return this.segments}destroy(){for(const e of this.segments)for(const i in e.vaos)e.vaos[i].destroy()}static simpleSegment(e,i,o,a){return new kr([{vertexOffset:e,primitiveOffset:i,vertexLength:o,primitiveLength:a,vaos:{},sortKey:0}])}}function Qf(n,e){return 256*(n=de(Math.floor(n),0,255))+de(Math.floor(e),0,255)}kr.MAX_VERTEX_ARRAY_LENGTH=Math.pow(2,16)-1,Kt(kr,"SegmentVector");const Jf=hn([{name:"a_pattern",components:4,type:"Uint16"},{name:"a_pixel_ratio",components:1,type:"Float32"}]),af=hn([{name:"a_pattern_b",components:4,type:"Uint16"}]),Mp=hn([{name:"a_dash",components:4,type:"Uint16"}]);class wc{constructor(){this.ids=[],this.uniqueIds=[],this.positions=[],this.indexed=!1}add(e,i,o,a){this.ids.push(Gs(e)),this.positions.push(i,o,a)}eachPosition(e,i){const o=Gs(e);let a=0,h=this.ids.length-1;for(;a<h;){const d=a+h>>1;this.ids[d]>=o?h=d:a=d+1}for(;this.ids[a]===o;)i(this.positions[3*a],this.positions[3*a+1],this.positions[3*a+2]),a++}static serialize(e,i){const o=new Float64Array(e.ids),a=new Uint32Array(e.positions);return ep(o,a,0,o.length-1),i&&(i.add(o.buffer),i.add(a.buffer)),{ids:o,positions:a}}static deserialize(e){const i=new wc;let o;i.ids=e.ids,i.positions=e.positions;for(const a of i.ids)a!==o&&i.uniqueIds.push(a),o=a;return i.indexed=!0,i}}function Gs(n){const e=+n;return!isNaN(e)&&Number.MIN_SAFE_INTEGER<=e&&e<=Number.MAX_SAFE_INTEGER?e:ul(String(n))}function ep(n,e,i,o){for(;i<o;){const a=n[i+o>>1];let h=i-1,d=o+1;for(;;){do h++;while(n[h]<a);do d--;while(n[d]>a);if(h>=d)break;lf(n,h,d),lf(e,3*h,3*d),lf(e,3*h+1,3*d+1),lf(e,3*h+2,3*d+2)}d-i<o-d?(ep(n,e,i,d),i=d+1):(ep(n,e,d+1,o),o=d)}}function lf(n,e,i){const o=n[e];n[e]=n[i],n[i]=o}Kt(wc,"FeaturePositionMap");class $o{constructor(e){this.gl=e.gl,this.initialized=!1}fetchUniformLocation(e,i){return this.location||this.initialized||(this.location=this.gl.getUniformLocation(e,i),this.initialized=!0),!!this.location}set(e,i,o){throw new Error("Uniform#set() must be implemented by each concrete Uniform")}}class io extends $o{constructor(e){super(e),this.current=0}set(e,i,o){this.fetchUniformLocation(e,i)&&this.current!==o&&(this.current=o,this.gl.uniform1i(this.location,o))}}class as extends $o{constructor(e){super(e),this.current=0}set(e,i,o){this.fetchUniformLocation(e,i)&&this.current!==o&&(this.current=o,this.gl.uniform1f(this.location,o))}}class Li extends $o{constructor(e){super(e),this.current=[0,0]}set(e,i,o){this.fetchUniformLocation(e,i)&&(o[0]===this.current[0]&&o[1]===this.current[1]||(this.current=o,this.gl.uniform2f(this.location,o[0],o[1])))}}class Sl extends $o{constructor(e){super(e),this.current=[0,0,0]}set(e,i,o){this.fetchUniformLocation(e,i)&&(o[0]===this.current[0]&&o[1]===this.current[1]&&o[2]===this.current[2]||(this.current=o,this.gl.uniform3f(this.location,o[0],o[1],o[2])))}}class zu extends $o{constructor(e){super(e),this.current=[0,0,0,0]}set(e,i,o){this.fetchUniformLocation(e,i)&&(o[0]===this.current[0]&&o[1]===this.current[1]&&o[2]===this.current[2]&&o[3]===this.current[3]||(this.current=o,this.gl.uniform4f(this.location,o[0],o[1],o[2],o[3])))}}class cf extends $o{constructor(e){super(e),this.current=un.transparent.toPremultipliedRenderColor(null)}set(e,i,o){this.fetchUniformLocation(e,i)&&(o.r===this.current.r&&o.g===this.current.g&&o.b===this.current.b&&o.a===this.current.a||(this.current=o,this.gl.uniform4f(this.location,o.r,o.g,o.b,o.a)))}}const Dp=new Float32Array(16);class bc extends $o{constructor(e){super(e),this.current=Dp}set(e,i,o){if(this.fetchUniformLocation(e,i)){if(o[12]!==this.current[12]||o[0]!==this.current[0])return this.current=o,void this.gl.uniformMatrix4fv(this.location,!1,o);for(let a=1;a<16;a++)if(o[a]!==this.current[a]){this.current=o,this.gl.uniformMatrix4fv(this.location,!1,o);break}}}}const uf=new Float32Array(9),hf=new Float32Array(4);class df extends $o{constructor(e){super(e),this.current=hf}set(e,i,o){if(this.fetchUniformLocation(e,i)){for(let a=0;a<4;a++)if(o[a]!==this.current[a]){this.current=o,this.gl.uniformMatrix2fv(this.location,!1,o);break}}}}function ff(n){return[Qf(255*n.r,255*n.g),Qf(255*n.b,255*n.a)]}class gh{constructor(e,i,o,a){this.value=e,this.uniformNames=i.map((h=>`u_${h}`)),this.type=o,this.context=a}setUniform(e,i,o,a,h){const d=a.constantOr(this.value);i.set(e,h,d instanceof un?d.toPremultipliedRenderColor(this.lutExpression&&this.lutExpression.value==="none"?null:this.context.lut):d)}getBinding(e,i){return this.type==="color"?new cf(e):new as(e)}}class Xc{constructor(e,i){this.uniformNames=i.map((o=>`u_${o}`)),this.pattern=null,this.patternTransition=null,this.pixelRatio=1}setConstantPatternPositions(e,i){this.pixelRatio=e.pixelRatio||1,this.pattern=e.tl.concat(e.br),this.patternTransition=i?i.tl.concat(i.br):this.pattern}setUniform(e,i,o,a,h){let d=null;h!=="u_pattern"&&h!=="u_dash"||(d=this.pattern),h==="u_pattern_b"&&(d=this.patternTransition),h==="u_pixel_ratio"&&(d=this.pixelRatio),d&&i.set(e,h,d)}getBinding(e,i){return i==="u_pattern"||i==="u_pattern_b"||i==="u_dash"?new zu(e):new as(e)}}class Il{constructor(e,i,o,a){this.expression=e,this.type=o,this.maxValue=0,this.paintVertexAttributes=i.map((h=>({name:`a_${h}`,type:"Float32",components:o==="color"?2:1,offset:0}))),this.paintVertexArray=new a}populatePaintArray(e,i,o,a,h,d,y,w){const T=this.paintVertexArray.length,C=this.expression.kind==="composite"||this.expression.kind==="source"?this.expression.evaluate(new Wn(0,{brightness:d,worldview:w}),i,{},h,a,y):this.expression.kind==="constant"&&this.expression.value,P=!!this.lutExpression&&(this.lutExpression.kind==="composite"||this.lutExpression.kind==="source"?this.lutExpression.evaluate(new Wn(0,{brightness:d,worldview:w}),i,{},h,a,y):this.lutExpression.value)==="none";this.paintVertexArray.resize(e),this._setPaintValue(T,e,C,P?null:this.context.lut)}updatePaintArray(e,i,o,a,h,d,y,w){const T=this.expression.kind==="composite"||this.expression.kind==="source"?this.expression.evaluate({zoom:0,brightness:y,worldview:w},o,a,void 0,h):this.expression.kind==="constant"&&this.expression.value,C=!!this.lutExpression&&(this.lutExpression.kind==="composite"||this.lutExpression.kind==="source"?this.lutExpression.evaluate(new Wn(0,{brightness:y,worldview:w}),o,a,void 0,h):this.lutExpression.value)==="none";this._setPaintValue(e,i,T,C?null:this.context.lut)}_setPaintValue(e,i,o,a){if(this.type==="color"){const h=ff(o.toPremultipliedRenderColor(a));for(let d=e;d<i;d++)this.paintVertexArray.emplace(d,h[0],h[1])}else{for(let h=e;h<i;h++)this.paintVertexArray.emplace(h,o);this.maxValue=Math.max(this.maxValue,Math.abs(o))}}upload(e){this.paintVertexArray&&this.paintVertexArray.arrayBuffer&&(this.paintVertexBuffer&&this.paintVertexBuffer.buffer?this.paintVertexBuffer.updateData(this.paintVertexArray):this.paintVertexBuffer=e.createVertexBuffer(this.paintVertexArray,this.paintVertexAttributes,this.lutExpression&&this.lutExpression.kind!=="constant"&&(this.lutExpression.isStateDependent||!this.lutExpression.isLightConstant)||this.expression.kind!=="constant"&&(this.expression.isStateDependent||!this.expression.isLightConstant)))}destroy(){this.paintVertexBuffer&&this.paintVertexBuffer.destroy()}}class es{constructor(e,i,o,a,h,d){this.expression=e,this.uniformNames=i.map((y=>`u_${y}_t`)),this.type=o,this.useIntegerZoom=a,this.context=h,this.maxValue=0,this.paintVertexAttributes=i.map((y=>({name:`a_${y}`,type:"Float32",components:o==="color"?4:2,offset:0}))),this.paintVertexArray=new d}populatePaintArray(e,i,o,a,h,d,y,w){const T=this.expression.evaluate(new Wn(this.context.zoom,{brightness:d,worldview:w}),i,{},h,a,y),C=this.expression.evaluate(new Wn(this.context.zoom+1,{brightness:d,worldview:w}),i,{},h,a,y),P=!!this.lutExpression&&(this.lutExpression.kind==="composite"||this.lutExpression.kind==="source"?this.lutExpression.evaluate(new Wn(0,{brightness:d,worldview:w}),i,{},h,a,y):this.lutExpression.value)==="none",D=this.paintVertexArray.length;this.paintVertexArray.resize(e),this._setPaintValue(D,e,T,C,P?null:this.context.lut)}updatePaintArray(e,i,o,a,h,d,y,w){const T=this.expression.evaluate({zoom:this.context.zoom,brightness:y,worldview:w},o,a,void 0,h),C=this.expression.evaluate({zoom:this.context.zoom+1,brightness:y,worldview:w},o,a,void 0,h),P=!!this.lutExpression&&(this.lutExpression.kind==="composite"||this.lutExpression.kind==="source"?this.lutExpression.evaluate(new Wn(0,{brightness:y,worldview:w}),o,a,void 0,h):this.lutExpression.value)==="none";this._setPaintValue(e,i,T,C,P?null:this.context.lut)}_setPaintValue(e,i,o,a,h){if(this.type==="color"){const d=ff(o.toPremultipliedRenderColor(h)),y=ff(o.toPremultipliedRenderColor(h));for(let w=e;w<i;w++)this.paintVertexArray.emplace(w,d[0],d[1],y[0],y[1])}else{for(let d=e;d<i;d++)this.paintVertexArray.emplace(d,o,a);this.maxValue=Math.max(this.maxValue,Math.abs(o),Math.abs(a))}}upload(e){this.paintVertexArray&&this.paintVertexArray.arrayBuffer&&(this.paintVertexBuffer&&this.paintVertexBuffer.buffer?this.paintVertexBuffer.updateData(this.paintVertexArray):this.paintVertexBuffer=e.createVertexBuffer(this.paintVertexArray,this.paintVertexAttributes,this.expression.isStateDependent||!this.expression.isLightConstant))}destroy(){this.paintVertexBuffer&&this.paintVertexBuffer.destroy()}setUniform(e,i,o,a,h){const d=this.useIntegerZoom?Math.floor(o.zoom):o.zoom,y=de(this.expression.interpolationFactor(d,this.context.zoom,this.context.zoom+1),0,1);i.set(e,h,y)}getBinding(e,i){return new as(e)}}class Es{constructor(e,i,o,a,h){this.expression=e,this.layerId=h,this.paintVertexAttributes=(o==="array"?Mp:Jf).members;for(let d=0;d<i.length;++d);this.paintVertexArray=new a,this.paintTransitionVertexArray=new uh}populatePaintArray(e,i,o,a){const h=this.paintVertexArray.length;this.paintVertexArray.resize(e),this._setPaintValues(h,e,i.patterns&&i.patterns[this.layerId],o)}updatePaintArray(e,i,o,a,h,d,y){this._setPaintValues(e,i,o.patterns&&o.patterns[this.layerId],d)}_setPaintValues(e,i,o,a){if(!a||!o)return;const h=a[o[0]],d=a[o[1]];if(h){if(h){const{tl:y,br:w,pixelRatio:T}=h;for(let C=e;C<i;C++)this.paintVertexArray.emplace(C,y[0],y[1],w[0],w[1],T)}if(d){this.paintTransitionVertexArray.resize(this.paintVertexArray.length);const{tl:y,br:w}=d;for(let T=e;T<i;T++)this.paintTransitionVertexArray.emplace(T,y[0],y[1],w[0],w[1])}}}upload(e){const i=this.expression.isStateDependent||!this.expression.isLightConstant;this.paintVertexArray&&this.paintVertexArray.arrayBuffer&&(this.paintVertexBuffer=e.createVertexBuffer(this.paintVertexArray,this.paintVertexAttributes,i)),this.paintTransitionVertexArray&&this.paintTransitionVertexArray.length&&(this.paintTransitionVertexBuffer=e.createVertexBuffer(this.paintTransitionVertexArray,af.members,i))}destroy(){this.paintVertexBuffer&&this.paintVertexBuffer.destroy(),this.paintTransitionVertexBuffer&&this.paintTransitionVertexBuffer.destroy()}}class Ss{constructor(e,i,o=(()=>!0)){this.binders={},this._buffers=[],this.context=i;const a=[];for(const h in e.paint._values){const d=e.paint.get(h);if(h.endsWith("-use-theme")||!o(h)||!(d instanceof vl&&rh(d.property.specification)))continue;const y=Al(h,e.type),w=d.value,T=d.property.specification.type,C=!!d.property.useIntegerZoom,P=h==="line-dasharray"||h.endsWith("pattern"),D=e.paint.get(`${h}-use-theme`),O=h==="line-dasharray"&&e.layout.get("line-cap").value.kind!=="constant"||D&&D.value.kind!=="constant";if(w.kind!=="constant"||O)if(w.kind==="source"||O||P){const N=zp(h,T,"source");this.binders[h]=P?new Es(w,y,T,N,e.id):new Il(w,y,T,N),a.push(`/a_${h}`)}else{const N=zp(h,T,"composite");this.binders[h]=new es(w,y,T,C,i,N),a.push(`/z_${h}`)}else this.binders[h]=P?new Xc(w.value,y):new gh(w.value,y,T,i),a.push(`/u_${h}`);D&&(this.binders[h].lutExpression=D.value)}this.cacheKey=a.sort().join("")}getMaxValue(e){const i=this.binders[e];return i instanceof Il||i instanceof es?i.maxValue:0}populatePaintArrays(e,i,o,a,h,d,y,w){for(const T in this.binders){const C=this.binders[T];C.context=this.context,(C instanceof Il||C instanceof es||C instanceof Es)&&C.populatePaintArray(e,i,o,a,h,d,y,w)}}setConstantPatternPositions(e,i){for(const o in this.binders){const a=this.binders[o];a instanceof Xc&&a.setConstantPatternPositions(e,i)}}getPatternTransitionVertexBuffer(e){const i=this.binders[e];return i instanceof Es?i.paintTransitionVertexBuffer:null}updatePaintArrays(e,i,o,a,h,d,y,w,T,C){let P=!1;const D=Object.keys(e),O=D.length!==0&&!w,N=O?D:i.uniqueIds;this.context.lut=h.lut;for(const G in this.binders){const q=this.binders[G];if(q.context=this.context,(q instanceof Il||q instanceof es||q instanceof Es)&&q.expression&&q.expression.kind&&q.expression.kind!=="constant"&&(q.expression.isStateDependent===!0||q.expression.isLightConstant===!1)){const Y=h.paint.get(G);q.expression=Y.value;for(const se of N){const re=e[se.toString()];i.eachPosition(se,((ae,Ee,ve)=>{const xe=a.feature(ae);q.updatePaintArray(Ee,ve,xe,re,d,y,T,C)}))}if(!O)for(const se of o.uniqueIds){const re=e[se.toString()];o.eachPosition(se,((ae,Ee,ve)=>{const xe=a.feature(ae);q.updatePaintArray(Ee,ve,xe,re,d,y,T,C)}))}P=!0}}return P}defines(){const e=[];for(const i in this.binders){const o=this.binders[i];(o instanceof gh||o instanceof Xc)&&e.push(...o.uniformNames.map((a=>`#define HAS_UNIFORM_${a}`)))}return e}getBinderAttributes(){const e=[];for(const i in this.binders){const o=this.binders[i];if(o instanceof Il||o instanceof es||o instanceof Es)for(let a=0;a<o.paintVertexAttributes.length;a++)e.push(o.paintVertexAttributes[a].name);if(o instanceof Es)for(let a=0;a<af.members.length;a++)e.push(af.members[a].name)}return e}getBinderUniforms(){const e=[];for(const i in this.binders){const o=this.binders[i];if(o instanceof gh||o instanceof Xc||o instanceof es)for(const a of o.uniformNames)e.push(a)}return e}getPaintVertexBuffers(){return this._buffers}getUniforms(e){const i=[];for(const o in this.binders){const a=this.binders[o];if(a instanceof gh||a instanceof Xc||a instanceof es)for(const h of a.uniformNames)i.push({name:h,property:o,binding:a.getBinding(e,h)})}return i}setUniforms(e,i,o,a,h){for(const{name:d,property:y,binding:w}of o)this.binders[y].setUniform(e,w,h,a.get(y),d)}updatePaintBuffers(){this._buffers=[];for(const e in this.binders){const i=this.binders[e];(i instanceof Il||i instanceof es||i instanceof Es)&&i.paintVertexBuffer&&this._buffers.push(i.paintVertexBuffer),i instanceof Es&&i.paintTransitionVertexBuffer&&this._buffers.push(i.paintTransitionVertexBuffer)}}upload(e){for(const i in this.binders){const o=this.binders[i];(o instanceof Il||o instanceof es||o instanceof Es)&&o.upload(e)}this.updatePaintBuffers()}destroy(){for(const e in this.binders){const i=this.binders[e];(i instanceof Il||i instanceof es||i instanceof Es)&&i.destroy()}}}class oa{constructor(e,i,o=(()=>!0)){this.programConfigurations={};for(const a of e)this.programConfigurations[a.id]=new Ss(a,i,o);this.needsUpload=!1,this._featureMap=new wc,this._featureMapWithoutIds=new wc,this._bufferOffset=0,this._idlessCounter=0}populatePaintArrays(e,i,o,a,h,d,y,w,T){for(const C in this.programConfigurations)this.programConfigurations[C].populatePaintArrays(e,i,a,h,d,y,w,T);i.id!==void 0?this._featureMap.add(i.id,o,this._bufferOffset,e):(this._featureMapWithoutIds.add(this._idlessCounter,o,this._bufferOffset,e),this._idlessCounter+=1),this._bufferOffset=e,this.needsUpload=!0}updatePaintArrays(e,i,o,a,h,d,y,w){for(const T of o)this.needsUpload=this.programConfigurations[T.id].updatePaintArrays(e,this._featureMap,this._featureMapWithoutIds,i,T,a,h,d,y||0,w)||this.needsUpload}get(e){return this.programConfigurations[e]}upload(e){if(this.needsUpload){for(const i in this.programConfigurations)this.programConfigurations[i].upload(e);this.needsUpload=!1}}destroy(){for(const e in this.programConfigurations)this.programConfigurations[e].destroy()}}const Lp={"text-opacity":["opacity"],"icon-opacity":["opacity"],"text-occlusion-opacity":["occlusion_opacity"],"icon-occlusion-opacity":["occlusion_opacity"],"text-color":["fill_color"],"icon-color":["fill_color"],"text-emissive-strength":["emissive_strength"],"icon-emissive-strength":["emissive_strength"],"text-halo-color":["halo_color"],"icon-halo-color":["halo_color"],"text-halo-blur":["halo_blur"],"icon-halo-blur":["halo_blur"],"text-halo-width":["halo_width"],"icon-halo-width":["halo_width"],"symbol-z-offset":["z_offset"],"line-gap-width":["gapwidth"],"line-pattern":["pattern","pixel_ratio","pattern_b"],"fill-pattern":["pattern","pixel_ratio","pattern_b"],"fill-extrusion-pattern":["pattern","pixel_ratio","pattern_b"],"line-dasharray":["dash"],"fill-bridge-guard-rail-color":["structure_color"],"fill-tunnel-structure-color":["structure_color"]};function Al(n,e){return Lp[n]||[n.replace(`${e}-`,"").replace(/-/g,"_")]}const kp={"line-pattern":{source:qc,composite:qc},"fill-pattern":{source:qc,composite:qc},"fill-extrusion-pattern":{source:qc,composite:qc},"line-dasharray":{source:uh,composite:uh}},Kl={color:{source:zs,composite:bl},number:{source:Lu,composite:zs}};function zp(n,e,i){const o=kp[n];return o&&o[i]||Kl[e][i]}Kt(gh,"ConstantBinder"),Kt(Xc,"PatternConstantBinder"),Kt(Il,"SourceExpressionBinder"),Kt(Es,"PatternCompositeBinder"),Kt(es,"CompositeExpressionBinder"),Kt(Ss,"ProgramConfiguration",{omit:["_buffers"]}),Kt(oa,"ProgramConfigurationSet");const fo=zt/Math.PI/2,tp=5,l=6,t=16383,r=64,c=[r,32,16],p=-fo,_=fo;function v(n,e,i,o=fo){return i=vn(i),[n*Math.sin(i)*o,-e*o,n*Math.cos(i)*o]}function b(n,e,i){return v(Math.cos(vn(n)),Math.sin(vn(n)),e,i)}const I=63710088e-1,M=2*Math.PI*I;class L{constructor(e,i){if(isNaN(e)||isNaN(i))throw new Error(`Invalid LngLat object: (${e}, ${i})`);if(this.lng=+e,this.lat=+i,this.lat>90||this.lat<-90)throw new Error("Invalid LngLat latitude value: must be between -90 and 90")}wrap(){return new L($e(this.lng,-180,180),this.lat)}toArray(){return[this.lng,this.lat]}toString(){return`LngLat(${this.lng}, ${this.lat})`}distanceTo(e){const i=Math.PI/180,o=this.lat*i,a=e.lat*i,h=Math.sin(o)*Math.sin(a)+Math.cos(o)*Math.cos(a)*Math.cos((e.lng-this.lng)*i);return I*Math.acos(Math.min(h,1))}toBounds(e=0){const i=360*e/40075017,o=i/Math.cos(Math.PI/180*this.lat);return new B({lng:this.lng-o,lat:this.lat-i},{lng:this.lng+o,lat:this.lat+i})}toEcef(e){return b(this.lat,this.lng,fo+e*fo/I)}static convert(e){if(e instanceof L)return e;if(Array.isArray(e)&&(e.length===2||e.length===3))return new L(Number(e[0]),Number(e[1]));if(!Array.isArray(e)&&typeof e=="object"&&e!==null)return new L(Number("lng"in e?e.lng:e.lon),Number(e.lat));throw new Error("`LngLatLike` argument must be specified as a LngLat instance, an object {lng: <lng>, lat: <lat>}, an object {lon: <lng>, lat: <lat>}, or an array of [<lng>, <lat>]")}}class B{constructor(e,i){if(e)if(i)this.setSouthWest(e).setNorthEast(i);else if(e.length===4){const o=e;this.setSouthWest([o[0],o[1]]).setNorthEast([o[2],o[3]])}else{const o=e;this.setSouthWest(o[0]).setNorthEast(o[1])}}setNorthEast(e){return this._ne=e instanceof L?new L(e.lng,e.lat):L.convert(e),this}setSouthWest(e){return this._sw=e instanceof L?new L(e.lng,e.lat):L.convert(e),this}extend(e){const i=this._sw,o=this._ne;let a,h;if(e instanceof L)a=e,h=e;else{if(!(e instanceof B))return Array.isArray(e)?e.length===4||e.every(Array.isArray)?this.extend(B.convert(e)):this.extend(L.convert(e)):typeof e=="object"&&e!==null&&e.hasOwnProperty("lat")&&(e.hasOwnProperty("lon")||e.hasOwnProperty("lng"))?this.extend(L.convert(e)):this;if(a=e._sw,h=e._ne,!a||!h)return this}return i||o?(i.lng=Math.min(a.lng,i.lng),i.lat=Math.min(a.lat,i.lat),o.lng=Math.max(h.lng,o.lng),o.lat=Math.max(h.lat,o.lat)):(this._sw=new L(a.lng,a.lat),this._ne=new L(h.lng,h.lat)),this}getCenter(){return new L((this._sw.lng+this._ne.lng)/2,(this._sw.lat+this._ne.lat)/2)}getSouthWest(){return this._sw}getNorthEast(){return this._ne}getNorthWest(){return new L(this.getWest(),this.getNorth())}getSouthEast(){return new L(this.getEast(),this.getSouth())}getWest(){return this._sw.lng}getSouth(){return this._sw.lat}getEast(){return this._ne.lng}getNorth(){return this._ne.lat}toArray(){return[this._sw.toArray(),this._ne.toArray()]}toString(){return`LngLatBounds(${this._sw.toString()}, ${this._ne.toString()})`}isEmpty(){return!(this._sw&&this._ne)}contains(e){const{lng:i,lat:o}=L.convert(e);let a=this._sw.lng<=i&&i<=this._ne.lng;return this._sw.lng>this._ne.lng&&(a=this._sw.lng>=i&&i>=this._ne.lng),this._sw.lat<=o&&o<=this._ne.lat&&a}static convert(e){if(e)return e instanceof B?e:new B(e)}}const F=0,V=25.5;function $(n){return M*Math.cos(n*Math.PI/180)}function H(n){return(180+n)/360}function X(n){return(180-180/Math.PI*Math.log(Math.tan(Math.PI/4+n*Math.PI/360)))/360}function Z(n,e){return n/$(e)}function te(n){return 360*n-180}function oe(n){return 360/Math.PI*Math.atan(Math.exp((180-360*n)*Math.PI/180))-90}function le(n,e){return n*$(oe(e))}const pe=85.051129;function ye(n){return Math.cos(vn(de(n,-pe,pe)))}function we(n,e){const i=de(e,F,V),o=Math.pow(2,i);return ye(n)*M/(512*o)}function me(n){return 1/Math.cos(n*Math.PI/180)}function _e(n,e=0){const i=Math.exp(Math.PI*(1-(n.y+e/zt)/(1<<n.z)*2));return 80150034*i/(i*i+1)/zt/(1<<n.z)}class ge{constructor(e,i,o=0){this.x=+e,this.y=+i,this.z=+o}static fromLngLat(e,i=0){const o=L.convert(e);return new ge(H(o.lng),X(o.lat),Z(i,o.lat))}toLngLat(){return new L(te(this.x),oe(this.y))}toAltitude(){return le(this.z,this.y)}meterInMercatorCoordinateUnits(){return 1/M*me(oe(this.y))}}function Be(n,e,i,o,a,h,d,y,w){const T=(e+o)/2,C=(i+a)/2,P=new gt(T,C);y(P),(function(D,O,N,G,q,Y){const se=N-q,re=G-Y;return Math.abs((G-O)*se-(N-D)*re)/Math.hypot(se,re)})(P.x,P.y,h.x,h.y,d.x,d.y)>=w?(Be(n,e,i,T,C,h,P,y,w),Be(n,T,C,o,a,P,d,y,w)):n.push(d)}function Ce(n,e,i){let o=n[0],a=o.x,h=o.y;e(o);const d=[o];for(let y=1;y<n.length;y++){const w=n[y],{x:T,y:C}=w;e(w),Be(d,a,h,T,C,o,w,e,i),a=T,h=C,o=w}return d}function nt(n,e,i,o){if(o(e,i)){const a=e.add(i)._mult(.5);nt(n,e,a,o),nt(n,a,i,o)}else n.push(i)}function He(n,e){let i=n[0];const o=[i];for(let a=1;a<n.length;a++){const h=n[a];nt(o,i,h,e),i=h}return o}const at=Math.pow(2,14)-1,mt=-at-1;function ze(n,e){const i=Math.round(n.x*e),o=Math.round(n.y*e);return n.x=de(i,mt,at),n.y=de(o,mt,at),(i<n.x||i>n.x+1||o<n.y||o>n.y+1)&&tn("Geometry exceeds allowed extent, reduce your vector tile buffer size"),n}function Te(n,e,i){const o=n.loadGeometry(),a=n.extent,h=zt/a;if(e&&i&&i.projection.isReprojectedInTileSpace){const d=1<<e.z,{scale:y,x:w,y:T,projection:C}=i,P=D=>{const O=te((e.x+D.x/a)/d),N=oe((e.y+D.y/a)/d),G=C.project(O,N);D.x=(G.x*y-w)*a,D.y=(G.y*y-T)*a};for(let D=0;D<o.length;D++)if(n.type!==1)o[D]=Ce(o[D],P,1);else{const O=[];for(const N of o[D])N.x<0||N.x>=a||N.y<0||N.y>=a||(P(N),O.push(N));o[D]=O}}for(const d of o)for(const y of d)ze(y,h);return o}function Ze(n,e){return{type:n.type,id:n.id,properties:n.properties,geometry:e?Te(n):[]}}class Ue{constructor(e,i,o,a,h){this.properties={},this.extent=o,this.type=0,this.id=void 0,this._pbf=e,this._geometry=-1,this._keys=a,this._values=h,e.readFields(dt,this,i)}loadGeometry(){const e=this._pbf;e.pos=this._geometry;const i=e.readVarint()+e.pos,o=[];let a,h=1,d=0,y=0,w=0;for(;e.pos<i;){if(d<=0){const T=e.readVarint();h=7&T,d=T>>3}if(d--,h===1||h===2)y+=e.readSVarint(),w+=e.readSVarint(),h===1&&(a&&o.push(a),a=[]),a&&a.push(new gt(y,w));else{if(h!==7)throw new Error(`unknown command ${h}`);a&&a.push(a[0].clone())}}return a&&o.push(a),o}bbox(){const e=this._pbf;e.pos=this._geometry;const i=e.readVarint()+e.pos;let o=1,a=0,h=0,d=0,y=1/0,w=-1/0,T=1/0,C=-1/0;for(;e.pos<i;){if(a<=0){const P=e.readVarint();o=7&P,a=P>>3}if(a--,o===1||o===2)h+=e.readSVarint(),d+=e.readSVarint(),h<y&&(y=h),h>w&&(w=h),d<T&&(T=d),d>C&&(C=d);else if(o!==7)throw new Error(`unknown command ${o}`)}return[y,T,w,C]}toGeoJSON(e,i,o){const a=this.extent*Math.pow(2,o),h=this.extent*e,d=this.extent*i,y=this.loadGeometry();function w(D){return[360*(D.x+h)/a-180,360/Math.PI*Math.atan(Math.exp((1-2*(D.y+d)/a)*Math.PI))-90]}function T(D){return D.map(w)}let C;if(this.type===1){const D=[];for(const N of y)D.push(N[0]);const O=T(D);C=D.length===1?{type:"Point",coordinates:O[0]}:{type:"MultiPoint",coordinates:O}}else if(this.type===2){const D=y.map(T);C=D.length===1?{type:"LineString",coordinates:D[0]}:{type:"MultiLineString",coordinates:D}}else{if(this.type!==3)throw new Error("unknown feature type");{const D=(function(N){const G=N.length;if(G<=1)return[N];const q=[];let Y,se;for(let re=0;re<G;re++){const ae=ft(N[re]);ae!==0&&(se===void 0&&(se=ae<0),se===ae<0?(Y&&q.push(Y),Y=[N[re]]):Y&&Y.push(N[re]))}return Y&&q.push(Y),q})(y),O=[];for(const N of D)O.push(N.map(T));C=O.length===1?{type:"Polygon",coordinates:O[0]}:{type:"MultiPolygon",coordinates:O}}}const P={type:"Feature",geometry:C,properties:this.properties};return this.id!=null&&(P.id=this.id),P}}function dt(n,e,i){n===1?e.id=i.readVarint():n===2?(function(o,a){const h=o.readVarint()+o.pos;for(;o.pos<h;){const d=a._keys[o.readVarint()],y=a._values[o.readVarint()];a.properties[d]=y}})(i,e):n===3?e.type=i.readVarint():n===4&&(e._geometry=i.pos)}function ft(n){let e=0;for(let i,o,a=0,h=n.length,d=h-1;a<h;d=a++)i=n[a],o=n[d],e+=(o.x-i.x)*(i.y+o.y);return e}Ue.types=["Unknown","Point","LineString","Polygon"];class xt{constructor(e,i){this.version=1,this.name="",this.extent=4096,this.length=0,this._pbf=e,this._keys=[],this._values=[],this._features=[],e.readFields(It,this,i),this.length=this._features.length}feature(e){if(e<0||e>=this._features.length)throw new Error("feature index out of bounds");this._pbf.pos=this._features[e];const i=this._pbf.readVarint()+this._pbf.pos;return new Ue(this._pbf,i,this.extent,this._keys,this._values)}}function It(n,e,i){n===15?e.version=i.readVarint():n===1?e.name=i.readString():n===5?e.extent=i.readVarint():n===2?e._features.push(i.pos):n===3?e._keys.push(i.readString()):n===4&&e._values.push((function(o){let a=null;const h=o.readVarint()+o.pos;for(;o.pos<h;){const d=o.readVarint()>>3;a=d===1?o.readString():d===2?o.readFloat():d===3?o.readDouble():d===4?o.readVarint64():d===5?o.readVarint():d===6?o.readSVarint():d===7?o.readBoolean():null}if(a==null)throw new Error("unknown feature value");return a})(i))}class Qt{constructor(e,i){this.layers=e.readFields(oi,{},i)}}function oi(n,e,i){if(n===3){const o=new xt(i,i.readVarint()+i.pos);o.length&&(e[o.name]=o)}}const qt="3d_elevation_id",si="level";class Jt{constructor(){this._valid=!1}reset(e){return this.feature=e,this._valid=!0,this._geometry=e.loadGeometry(),this._geometry.length!==0&&this._geometry[0].length!==0||(this._valid=!1),this}geometry(e,i){return this._valid&&e(i(this._geometry)),this}require(e,i,o){return this.get(e,!0,i,o)}optional(e,i,o){return this.get(e,!1,i,o)}success(){return this._valid}get(e,i,o,a){const h=this.feature.properties.hasOwnProperty(e)?+this.feature.properties[e]:void 0;return this._valid&&h!==void 0&&!Number.isNaN(h)?o(a?a(h):h):i&&(this._valid=!1),this}}class Ci{constructor(e,i){this.featureFunc=e,this.vertexFunc=i}parseFeature(e,i,o){return this.featureFunc(e,i,o)}parseVertex(e,i,o){return this.vertexFunc(e,i,o)}}const Fi=new Ci(((n,e,i)=>n.reset(e).require(qt,(o=>{i.id=o})).optional("fixed_height_relative",(o=>{i.constantHeight=o}),gn.decodeRelativeHeight).geometry((o=>{i.bounds=o}),Df).success()),((n,e,i)=>n.reset(e).require(qt,(o=>{i.id=o})).require("elevation_idx",(o=>{i.idx=o})).require("extent",(o=>{i.extent=o})).require("height_relative",(o=>{i.height=o}),gn.decodeRelativeHeight).geometry((o=>{i.position=o}),gn.getPoint).success())),Hi=new Ci(((n,e,i)=>n.reset(e).require(qt,(o=>{i.id=o})).optional("fixed_height",(o=>{i.constantHeight=o}),gn.decodeMetricHeight).geometry((o=>{i.bounds=o}),Df).success()),((n,e,i)=>n.reset(e).require(qt,(o=>{i.id=o})).require("elevation_idx",(o=>{i.idx=o})).require("extent",(o=>{i.extent=o})).require("height",(o=>{i.height=o}),gn.decodeMetricHeight).geometry((o=>{i.position=o}),gn.getPoint).success()));class gn{static getPoint(e){return Xs(e[0][0].x,e[0][0].y)}static decodeRelativeHeight(e){return 1e-4*e*5}static decodeMetricHeight(e){return 1e-4*e}static parse(e){const i=[],o=[],a=e.length,h=new Jt;for(let y=0;y<a;y++){const w=e.feature(y),T=w.properties.version,C=(d=T)?d==="1.0.1"?Hi:void 0:Fi;if(C===void 0){tn(`Unknown elevation feature version number ${T||"(unknown)"}`);continue}const P=w.properties.hasOwnProperty("type")?w.properties.type:void 0;if(P){if(Ue.types[w.type]==="Point"&&P==="curve_point"){const D={};C.parseVertex(h,w,D)&&i.push(D)}else if(Ue.types[w.type]==="Polygon"&&P==="curve_meta"){const D={};C.parseFeature(h,w,D)&&o.push(D)}}}var d;return{vertices:i,features:o}}}class ki{constructor(e,i){this.pos=e,this.dir=i}intersectsPlane(e,i,o){const a=nr(i,this.dir);if(Math.abs(a)<1e-6)return!1;const h=((e[0]-this.pos[0])*i[0]+(e[1]-this.pos[1])*i[1])/a;return o[0]=this.pos[0]+this.dir[0]*h,o[1]=this.pos[1]+this.dir[1]*h,!0}}class En{constructor(e,i){this.pos=e,this.dir=i}intersectsPlane(e,i,o){const a=Ji(i,this.dir);if(Math.abs(a)<1e-6)return!1;const h=((e[0]-this.pos[0])*i[0]+(e[1]-this.pos[1])*i[1]+(e[2]-this.pos[2])*i[2])/a;return o[0]=this.pos[0]+this.dir[0]*h,o[1]=this.pos[1]+this.dir[1]*h,o[2]=this.pos[2]+this.dir[2]*h,!0}closestPointOnSphere(e,i,o){if((function(O,N){var G=O[0],q=O[1],Y=O[2],se=N[0],re=N[1],ae=N[2];return Math.abs(G-se)<=ee*Math.max(1,Math.abs(G),Math.abs(se))&&Math.abs(q-re)<=ee*Math.max(1,Math.abs(q),Math.abs(re))&&Math.abs(Y-ae)<=ee*Math.max(1,Math.abs(Y),Math.abs(ae))})(this.pos,e)||i===0)return o[0]=o[1]=o[2]=0,!1;const[a,h,d]=this.dir,y=this.pos[0]-e[0],w=this.pos[1]-e[1],T=this.pos[2]-e[2],C=a*a+h*h+d*d,P=2*(y*a+w*h+T*d),D=P*P-4*C*(y*y+w*w+T*T-i*i);if(D<0){const O=Math.max(-P/2,0),N=y+a*O,G=w+h*O,q=T+d*O,Y=Math.hypot(N,G,q);return o[0]=N*i/Y,o[1]=G*i/Y,o[2]=q*i/Y,!1}{const O=(-P-Math.sqrt(D))/(2*C);if(O<0){const N=Math.hypot(y,w,T);return o[0]=y*i/N,o[1]=w*i/N,o[2]=T*i/N,!1}return o[0]=y+a*O,o[1]=w+h*O,o[2]=T+d*O,!0}}}class Dn{constructor(e,i,o,a,h){this.TL=e,this.TR=i,this.BR=o,this.BL=a,this.horizon=h}static fromInvProjectionMatrix(e,i,o){const a=[-1,1,1],h=[1,1,1],d=[1,-1,1],y=[-1,-1,1],w=Pn(a,a,e),T=Pn(h,h,e),C=Pn(d,d,e),P=Pn(y,y,e);return new Dn(w,T,C,P,i/o)}}function sr(n,e,i){let o=1/0,a=-1/0;const h=[];for(const d of n){Ut(h,d,e);const y=Ji(h,i);o=Math.min(o,y),a=Math.max(a,y)}return[o,a]}function Ni(n,e){let i=!0;for(let o=0;o<n.planes.length;o++){const a=n.planes[o];let h=0;for(let d=0;d<e.length;d++)h+=Ji(a,e[d])+a[3]>=0;if(h===0)return 0;h!==e.length&&(i=!1)}return i?2:1}function Sn(n,e){for(const i of n.projections){const o=sr(e,n.points[0],i.axis);if(i.projection[1]<o[0]||i.projection[0]>o[1])return 0}return 1}function pn(n,e){let i=0;const o=[0,0,0,0];for(let d=0;d<n.length;d++)o[0]=n[d][0],o[1]=n[d][1],o[2]=n[d][2],o[3]=1,(a=o)[0]*(h=e)[0]+a[1]*h[1]+a[2]*h[2]+a[3]*h[3]>=0&&i++;var a,h;return i}class Bn{constructor(e,i){this.points=e||new Array(8).fill([0,0,0]),this.planes=i||new Array(6).fill([0,0,0,0]),this.bounds=Si.fromPoints(this.points),this.projections=[],this.frustumEdges=[Ut([],this.points[2],this.points[3]),Ut([],this.points[0],this.points[3]),Ut([],this.points[4],this.points[0]),Ut([],this.points[5],this.points[1]),Ut([],this.points[6],this.points[2]),Ut([],this.points[7],this.points[3])];for(const o of this.frustumEdges){const a=[0,-o[2],o[1]],h=[o[2],0,-o[0]];this.projections.push({axis:a,projection:sr(this.points,this.points[0],a)}),this.projections.push({axis:h,projection:sr(this.points,this.points[0],h)})}}static fromInvProjectionMatrix(e,i,o,a){const h=Math.pow(2,o),d=[[-1,1,-1,1],[1,1,-1,1],[1,-1,-1,1],[-1,-1,-1,1],[-1,1,1,1],[1,1,1,1],[1,-1,1,1],[-1,-1,1,1]].map((T=>{const C=Rn([],T,e),P=1/C[3]/i*h;return(D=C)[0]=(O=C)[0]*(N=[P,P,a?1/C[3]:P,P])[0],D[1]=O[1]*N[1],D[2]=O[2]*N[2],D[3]=O[3]*N[3],D;var D,O,N})),y=[[0,1,2],[6,5,4],[0,3,7],[2,1,5],[3,2,6],[0,4,5]].map((T=>{const C=zi([],on([],Ut([],d[T[0]],d[T[1]]),Ut([],d[T[2]],d[T[1]]))),P=-Ji(C,d[T[1]]);return C.concat(P)})),w=[];for(let T=0;T<d.length;T++)w.push([d[T][0],d[T][1],d[T][2]]);return new Bn(w,y)}intersectsPrecise(e,i,o){for(let a=0;a<i.length;a++)if(!pn(e,i[a]))return 0;for(let a=0;a<this.planes.length;a++)if(!pn(e,this.planes[a]))return 0;for(const a of o)for(const h of this.frustumEdges){const d=on([],a,h),y=Oe(d);if(y===0)continue;Qe(d,d,1/y);const w=sr(this.points,this.points[0],d),T=sr(e,this.points[0],d);if(w[0]>T[1]||T[0]>w[1])return 0}return 1}containsPoint(e){for(const i of this.planes){const o=i[3];if(Ji([i[0],i[1],i[2]],e)+o<0)return!1}return!0}}class Si{static fromPoints(e){const i=[1/0,1/0,1/0],o=[-1/0,-1/0,-1/0];for(const a of e)Ui(i,i,a),Ai(o,o,a);return new Si(i,o)}static fromTileIdAndHeight(e,i,o){const a=1<<e.canonical.z,h=e.canonical.x,d=e.canonical.y;return new Si([h/a,d/a,i],[(h+1)/a,(d+1)/a,o])}static applyTransform(e,i){const o=e.getCorners();for(let a=0;a<o.length;++a)Pn(o[a],o[a],i);return Si.fromPoints(o)}static applyTransformFast(e,i){const o=[i[12],i[13],i[14]],a=[...o];for(let h=0;h<3;h++)for(let d=0;d<3;d++){const y=i[4*d+h],w=y*e.min[d],T=y*e.max[d];o[h]+=Math.min(w,T),a[h]+=Math.max(w,T)}return new Si(o,a)}static projectAabbCorners(e,i){const o=e.getCorners();for(let a=0;a<o.length;++a)Pn(o[a],o[a],i);return o}constructor(e,i){this.min=e,this.max=i,this.center=Qe([],wn([],this.min,this.max),.5)}quadrant(e){const i=[e%2==0,e<2],o=ut(this.min),a=ut(this.max);for(let h=0;h<i.length;h++)o[h]=i[h]?this.min[h]:this.center[h],a[h]=i[h]?this.center[h]:this.max[h];return a[2]=this.max[2],new Si(o,a)}distanceX(e){return Math.max(Math.min(this.max[0],e[0]),this.min[0])-e[0]}distanceY(e){return Math.max(Math.min(this.max[1],e[1]),this.min[1])-e[1]}distanceZ(e){return Math.max(Math.min(this.max[2],e[2]),this.min[2])-e[2]}getCorners(){const e=this.min,i=this.max;return[[e[0],e[1],e[2]],[i[0],e[1],e[2]],[i[0],i[1],e[2]],[e[0],i[1],e[2]],[e[0],e[1],i[2]],[i[0],e[1],i[2]],[i[0],i[1],i[2]],[e[0],i[1],i[2]]]}intersects(e){return this.intersectsAabb(e.bounds)?Ni(e,this.getCorners()):0}intersectsFlat(e){return this.intersectsAabb(e.bounds)?Ni(e,[[this.min[0],this.min[1],0],[this.max[0],this.min[1],0],[this.max[0],this.max[1],0],[this.min[0],this.max[1],0]]):0}intersectsPrecise(e,i){return i||this.intersects(e)?Sn(e,this.getCorners()):0}intersectsPreciseFlat(e,i){return i||this.intersectsFlat(e)?Sn(e,[[this.min[0],this.min[1],0],[this.max[0],this.min[1],0],[this.max[0],this.max[1],0],[this.min[0],this.max[1],0]]):0}intersectsAabb(e){for(let i=0;i<3;++i)if(this.min[i]>e.max[i]||e.min[i]>this.max[i])return!1;return!0}intersectsAabbXY(e){return!(this.min[0]>e.max[0]||e.min[0]>this.max[0]||this.min[1]>e.max[1]||e.min[1]>this.max[1])}encapsulate(e){for(let i=0;i<3;i++)this.min[i]=Math.min(this.min[i],e.min[i]),this.max[i]=Math.max(this.max[i],e.max[i])}encapsulatePoint(e){for(let i=0;i<3;i++)this.min[i]=Math.min(this.min[i],e[i]),this.max[i]=Math.max(this.max[i],e[i])}closestPoint(e){return[Math.max(Math.min(this.max[0],e[0]),this.min[0]),Math.max(Math.min(this.max[1],e[1]),this.min[1]),Math.max(Math.min(this.max[2],e[2]),this.min[2])]}}Kt(Si,"Aabb");class Qn{constructor(e,i){this.feature=e,this.metersToTile=i,this.index=0}get(){const e=this.feature.vertices[this.index],i=this.feature.vertexProps[this.index].dir,o=i[1],a=-i[0],h=(e.extent+1)*this.metersToTile;return[new gt(Math.trunc(e.position[0]+o*h),Math.trunc(e.position[1]+a*h)),new gt(Math.trunc(e.position[0]-o*h),Math.trunc(e.position[1]-a*h))]}next(){this.index++}valid(){return this.index<this.feature.vertices.length}}class Ln{constructor(e,i,o,a,h,d){if(this.vertices=new Array,this.vertexProps=new Array,this.edges=new Array,this.edgeProps=new Array,this.id=e,this.heightRange={min:o,max:o},this.safeArea=i,this.constantHeight=o,this.constantHeight==null&&(this.constantHeight!=null||a.length!==0)){this.vertices=a,this.edges=h,this.edges=this.edges.filter((y=>{return y.a<this.vertices.length&&y.b<this.vertices.length&&!((w=this.vertices[y.a].position)[0]===(T=this.vertices[y.b].position)[0]&&w[1]===T[1]);var w,T})),this.heightRange={min:Number.POSITIVE_INFINITY,max:Number.NEGATIVE_INFINITY};for(const y of this.vertices)this.vertexProps.push({dir:Xs(0,0)}),this.heightRange.min=Math.min(this.heightRange.min,y.height),this.heightRange.max=Math.max(this.heightRange.max,y.height);for(const y of this.edges){const w=this.vertices[y.a].position,T=this.vertices[y.b].position,C=ma(xs(),T,w),P=Na(C),D=Ba(xs(),C,1/P);this.edgeProps.push({vec:C,dir:D,len:P});const O=this.vertexProps[y.a].dir,N=this.vertexProps[y.b].dir;Oa(O,O,D),Oa(N,N,D)}for(const y of this.vertexProps)y.dir[0]===0&&y.dir[1]===0||Rl(y.dir,y.dir);this.tessellate(d)}}pointElevation(e){if(this.constantHeight!=null)return this.constantHeight;const i=this.getClosestEdge(e);if(i==null)return 0;const[o,a]=i;return di(this.vertices[this.edges[o].a].height,this.vertices[this.edges[o].b].height,a)}computeSlopeNormal(e,i){const o=this.getClosestEdge(e);if(!o)return kn(0,0,1);const a=o[0],h=this.edges[a],d=this.edgeProps[a].vec,y=kn(d[0],d[1],(this.vertices[h.b].height-this.vertices[h.a].height)*i),w=kn(y[1],-y[0],0);on(w,w,y);const T=Oe(w);return T>0?Qe(w,w,1/T):kn(0,0,1)}getSafeArea(){return this.safeArea}isTunnel(){return this.heightRange.max<=-5}getClosestEdge(e){if(this.edges.length===0)return;let i=0,o=Number.POSITIVE_INFINITY,a=0;const h=Xs(e.x,e.y);for(let d=0;d<this.edges.length;d++){const y=this.edges[d],w=this.edgeProps[d].dir,T=new ki(h,this.edgeProps[d].dir),C=this.vertices[y.a].position,P=this.vertices[y.b].position,D=xs(),O=xs(),N=T.intersectsPlane(C,this.vertexProps[y.a].dir,D),G=T.intersectsPlane(P,this.vertexProps[y.b].dir,O);if(!N||!G)continue;const q=ma(xs(),O,D),Y=ma(xs(),h,D),se=nr(q,q),re=se>0?nr(Y,q)/se:0,ae=de(re,0,1),Ee=Math.abs((re-ae)*this.edgeProps[d].len),ve=ma(xs(),h,C),xe=Ee+Math.abs(nr(ve,Xs(w[1],-w[0])));xe<o&&(i=d,o=xe,a=ae)}return[i,a]}tessellate(e){for(let i=this.edges.length-1;i>=0;--i){const o=this.edges[i].a,a=this.edges[i].b,{position:h,height:d,extent:y}=this.vertices[o],{position:w,height:T,extent:C}=this.vertices[a],P=this.vertexProps[o].dir,D=this.vertexProps[a].dir,O=kn(h[0]/e,h[1]/e,d),N=kn(w[0]/e,w[1]/e,T),G=kn(P[1],-P[0],0);Qe(G,G,y);const q=kn(D[1],-D[0],0);if(Qe(q,q,C),this.distSqLines(kn(O[0]+.5*G[0],O[1]+.5*G[1],O[2]+.5*G[2]),kn(N[0]-.5*q[0],N[1]-.5*q[1],N[2]-.5*q[2]),kn(O[0]-.5*G[0],O[1]-.5*G[1],O[2]-.5*G[2]),kn(N[0]+.5*q[0],N[1]+.5*q[1],N[2]+.5*q[2]))<=.0025000000000000005)continue;const Y=this.vertices.length,se=Oa(xs(),h,w);this.vertices.push({position:Ba(se,se,.5),height:.5*(d+T),extent:.5*(y+C)});const re=Oa(xs(),P,D);this.vertexProps.push({dir:Rl(re,re)}),this.edges.splice(i,1),this.edgeProps.splice(i,1),this.edges.push({a:o,b:Y}),this.edges.push({a:Y,b:a});const ae=ma(xs(),this.vertices[Y].position,h),Ee=Na(ae),ve={vec:ae,dir:Ba(xs(),ae,1/Ee),len:Ee};this.edgeProps.push(ve),this.edgeProps.push(ve)}}distSqLines(e,i,o,a){const h=Gn(We(),i,e),d=Gn(We(),a,o),y=Gn(We(),e,o),w=Ji(h,h),T=Ji(h,d),C=Ji(h,y),P=Ji(d,d),D=Ji(d,y),O=w*P-T*T;if(O===0){const q=Ji(y,d)/Ji(d,d);return ji(er(We(),o,a,q),e)}const N=(T*D-C*P)/O,G=(w*D-T*C)/O;return ji(er(We(),e,i,N),er(We(),o,a,G))}}class zr{static parseFrom(e,i){const o=gn.parse(e);if(!o)return[];let{vertices:a,features:h}=o;const d=1/_e(i);h.sort(((C,P)=>C.id-P.id)),a.sort(((C,P)=>C.id-P.id||C.idx-P.idx)),a=a.filter(((C,P,D)=>P===D.findIndex((O=>O.id===C.id&&O.idx===C.idx))));const y=new Array;let w=0;const T=a.length;for(const C of h){if(C.constantHeight){y.push(new Ln(C.id,C.bounds,C.constantHeight));continue}for(;w!==T&&a[w].id<C.id;)w++;if(w===T||a[w].id!==C.id)continue;const P=new Array,D=new Array,O=w;for(;w!==T&&a[w].id===C.id;){const N=a[w];if(P.push({position:N.position,height:N.height,extent:N.extent}),w!==O&&a[w-1].idx===N.idx-1){const G=w-O;D.push({a:G-1,b:G})}w++}y.push(new Ln(C.id,C.bounds,void 0,P,D,d))}return y}static getElevationFeature(e,i){if(!i)return;const o=+e.properties[qt];return Number.isNaN(o)?void 0:i.find((a=>a.id===o))}}class Tn{constructor(e,i){this.zScale=1,this.xOffset=0,this.yOffset=0,e.equals(i)||(this.zScale=Math.pow(2,i.z-e.z),this.xOffset=(e.x*this.zScale-i.x)*zt,this.yOffset=(e.y*this.zScale-i.y)*zt)}constantElevation(e,i){if(e.constantHeight!=null)return this.computeBiasedHeight(e.constantHeight,i)}pointElevation(e,i,o){const a=this.constantElevation(i,o);return a??(e.x=e.x*this.zScale+this.xOffset,e.y=e.y*this.zScale+this.yOffset,this.computeBiasedHeight(i.pointElevation(e),o))}computeBiasedHeight(e,i){return i<=0?e:e+i*Ae(0,i,e>=0?e:Math.abs(.5*e))}}Kt(Ln,"ElevationFeature");class Nn{constructor(e){this.zoom=e.zoom,this.overscaling=e.overscaling,this.layers=e.layers,this.layerIds=this.layers.map((i=>i.fqid)),this.index=e.index,this.hasPattern=!1,this.projection=e.projection,this.layoutVertexArray=new Mo,this.indexArray=new yr,this.segments=new kr,this.programConfigurations=new oa(e.layers,{zoom:e.zoom,lut:e.lut}),this.stateDependentLayerIds=this.layers.filter((i=>i.isStateDependent())).map((i=>i.id)),this.elevationMode=this.layers[0].layout.get("circle-elevation-reference"),this.hasElevation=!1,this.elevationMode!=="none"&&(this.elevatedLayoutVertexArray=new Lu),this.worldview=e.worldview}updateFootprints(e,i){}populate(e,i,o,a){const h=this.layers[0],d=[];let y=null;h.type==="circle"&&(y=h.layout.get("circle-sort-key"));for(const{feature:T,id:C,index:P,sourceLayerIndex:D}of e){const O=this.layers[0]._featureFilter.needGeometry,N=Ze(T,O);if(!this.layers[0]._featureFilter.filter(new Wn(this.zoom,{worldview:this.worldview}),N,o))continue;const G=y?y.evaluate(N,{},o):void 0,q={id:C,properties:T.properties,type:T.type,sourceLayerIndex:D,index:P,geometry:O?N.geometry:Te(T,o,a),patterns:{},sortKey:G};d.push(q)}y&&d.sort(((T,C)=>T.sortKey-C.sortKey));let w=null;a.projection.name==="globe"&&(this.globeExtVertexArray=new Zd,w=a.projection);for(const T of d){const{geometry:C,index:P,sourceLayerIndex:D}=T,O=e[P].feature;this.addFeature(T,C,P,i.availableImages,o,w,i.brightness,i.elevationFeatures),i.featureIndex.insert(O,C,P,D,this.index)}this.hasElevation||(this.elevatedLayoutVertexArray=void 0)}update(e,i,o,a,h,d,y){this.programConfigurations.updatePaintArrays(e,i,h,o,a,d,y,this.worldview)}isEmpty(){return this.layoutVertexArray.length===0}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload}upload(e){this.uploaded||(this.layoutVertexBuffer=e.createVertexBuffer(this.layoutVertexArray,Yf.members),this.indexBuffer=e.createIndexBuffer(this.indexArray),this.globeExtVertexArray&&(this.globeExtVertexBuffer=e.createVertexBuffer(this.globeExtVertexArray,xc.members)),this.elevatedLayoutVertexArray&&(this.elevatedLayoutVertexBuffer=e.createVertexBuffer(this.elevatedLayoutVertexArray,of.members))),this.programConfigurations.upload(e),this.uploaded=!0}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy(),this.globeExtVertexBuffer&&this.globeExtVertexBuffer.destroy(),this.elevatedLayoutVertexBuffer&&this.elevatedLayoutVertexBuffer.destroy())}addFeature(e,i,o,a,h,d,y,w){let T;this.elevationMode!=="none"&&(T=zr.getElevationFeature(e,w));for(const C of i)for(const P of C){const D=P.x,O=P.y;if(D<0||D>=zt||O<0||O>=zt)continue;if(d){const q=d.projectTilePoint(D,O,h),Y=d.upVector(h,D,O);this.addGlobeExtVertex(q,Y),this.addGlobeExtVertex(q,Y),this.addGlobeExtVertex(q,Y),this.addGlobeExtVertex(q,Y)}const N=this.segments.prepareSegment(4,this.layoutVertexArray,this.indexArray,e.sortKey),G=N.vertexLength;if(this.addCircleVertex(D,O,-1,-1),this.addCircleVertex(D,O,1,-1),this.addCircleVertex(D,O,1,1),this.addCircleVertex(D,O,-1,1),this.elevationMode!=="none"){const q=T?T.pointElevation(new gt(D,O)):0;this.hasElevation=this.hasElevation||q!==0;for(let Y=0;Y<4;Y++)this.elevatedLayoutVertexArray.emplaceBack(q)}this.indexArray.emplaceBack(G,G+1,G+2),this.indexArray.emplaceBack(G,G+2,G+3),N.vertexLength+=4,N.primitiveLength+=2}this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,e,o,{},a,h,y,void 0,this.worldview)}addCircleVertex(e,i,o,a){this.layoutVertexArray.emplaceBack(2*e+(o+1)/2,2*i+(a+1)/2)}addGlobeExtVertex(e,i){this.globeExtVertexArray.emplaceBack(e.x,e.y,e.z,i[0]*16384,i[1]*16384,i[2]*16384)}}function tr(n,e){for(let i=0;i<n.length;i++)if(mo(e,n[i]))return!0;for(let i=0;i<e.length;i++)if(mo(n,e[i]))return!0;return!!Hs(n,e)}function ls(n,e,i){return!!mo(n,e)||!!Fs(e,n,i)}function pr(n,e){if(n.length===1)return aa(e,n[0]);for(let i=0;i<e.length;i++){const o=e[i];for(let a=0;a<o.length;a++)if(mo(n,o[a]))return!0}for(let i=0;i<n.length;i++)if(aa(e,n[i]))return!0;for(let i=0;i<e.length;i++)if(Hs(n,e[i]))return!0;return!1}function ts(n,e,i){if(n.length>1){if(Hs(n,e))return!0;for(let o=0;o<e.length;o++)if(Fs(e[o],n,i))return!0}for(let o=0;o<n.length;o++)if(Fs(n[o],e,i))return!0;return!1}function Hs(n,e){if(n.length===0||e.length===0)return!1;for(let i=0;i<n.length-1;i++){const o=n[i],a=n[i+1];for(let h=0;h<e.length-1;h++)if(po(o,a,e[h],e[h+1]))return!0}return!1}function po(n,e,i,o){return Nr(n,i,o)!==Nr(e,i,o)&&Nr(n,e,i)!==Nr(n,e,o)}function no(n,e,i){return(n.x-i.x)*(e.y-i.y)-(n.y-i.y)*(e.x-i.x)}function qs(n,e,i,o){const a=no(n,e,o),h=no(n,e,i);if(Math.sign(a)===Math.sign(h))return;const d=no(i,o,n),y=d+h-a;return Math.sign(d)!==Math.sign(y)?[d/(d-y),h/(h-a)]:void 0}function Fs(n,e,i){const o=i*i;if(e.length===1)return n.distSqr(e[0])<o;for(let a=1;a<e.length;a++)if(Wo(n,e[a-1],e[a])<o)return!0;return!1}function Wo(n,e,i){const o=e.distSqr(i);if(o===0)return n.distSqr(e);const a=((n.x-e.x)*(i.x-e.x)+(n.y-e.y)*(i.y-e.y))/o;return n.distSqr(a<0?e:a>1?i:i.sub(e)._mult(a)._add(e))}function aa(n,e){let i,o,a,h=!1;for(let d=0;d<n.length;d++){i=n[d];for(let y=0,w=i.length-1;y<i.length;w=y++)o=i[y],a=i[w],o.y>e.y!=a.y>e.y&&e.x<(a.x-o.x)*(e.y-o.y)/(a.y-o.y)+o.x&&(h=!h)}return h}function mo(n,e){let i=!1;for(let o=0,a=n.length-1;o<n.length;a=o++){const h=n[o],d=n[a];h.y>e.y!=d.y>e.y&&e.x<(d.x-h.x)*(e.y-h.y)/(d.y-h.y)+h.x&&(i=!i)}return i}function Hr(n,e,i,o,a){for(const d of n)if(e<=d.x&&i<=d.y&&o>=d.x&&a>=d.y)return!0;const h=[new gt(e,i),new gt(e,a),new gt(o,a),new gt(o,i)];if(n.length>2){for(const d of h)if(mo(n,d))return!0}for(let d=0;d<n.length-1;d++)if(qr(n[d],n[d+1],h))return!0;return!1}function qr(n,e,i){const o=i[0],a=i[2];if(n.x<o.x&&e.x<o.x||n.x>a.x&&e.x>a.x||n.y<o.y&&e.y<o.y||n.y>a.y&&e.y>a.y)return!1;const h=Nr(n,e,i[0]);return h!==Nr(n,e,i[1])||h!==Nr(n,e,i[2])||h!==Nr(n,e,i[3])}function lr(n,e,i,o,a,h){let d=e.y-n.y,y=n.x-e.x;if(h=h||0){const w=d*d+y*y;if(w===0)return!0;const T=Math.sqrt(w);d/=T,y/=T}return!((i.x-n.x)*d+(i.y-n.y)*y-h<0||(o.x-n.x)*d+(o.y-n.y)*y-h<0||(a.x-n.x)*d+(a.y-n.y)*y-h<0)}function ms(n,e,i,o,a,h,d){return!(lr(n,e,o,a,h,d)||lr(e,i,o,a,h,d)||lr(i,n,o,a,h,d)||lr(o,a,n,e,i,d)||lr(a,h,n,e,i,d)||lr(h,o,n,e,i,d))}function Is(n,e,i){const o=e.paint.get(n).value;return o.kind==="constant"?o.value:i.programConfigurations.get(e.id).getMaxValue(n)}function Or(n){return Math.sqrt(n[0]*n[0]+n[1]*n[1])}function la(n,e,i,o,a){if(!e[0]&&!e[1])return n;const h=gt.convert(e)._mult(a);i==="viewport"&&h._rotate(-o);const d=[];for(let y=0;y<n.length;y++)d.push(n[y].sub(h));return d}function Tc(n,e,i,o){const a=gt.convert(n)._mult(o);return e==="viewport"&&a._rotate(-i),a}let Kc,Fu;function Yc(n,e,i){var o=2*Math.PI*6378137/256/Math.pow(2,i);return[n*o-2*Math.PI*6378137/2,e*o-2*Math.PI*6378137/2]}Kt(Nn,"CircleBucket",{omit:["layers"]});class Lo{constructor(e,i,o){this.z=e,this.x=i,this.y=o,this.key=ca(0,e,e,i,o)}equals(e){return this.z===e.z&&this.x===e.x&&this.y===e.y}isChildOf(e){const i=this.z-e.z;return e.z===0||e.z<this.z&&e.x===this.x>>i&&e.y===this.y>>i}url(e,i){const o=(function(h,d,y){var w=Yc(256*h,256*(d=Math.pow(2,y)-d-1),y),T=Yc(256*(h+1),256*(d+1),y);return w[0]+","+w[1]+","+T[0]+","+T[1]})(this.x,this.y,this.z),a=(function(h,d,y){let w,T="";for(let C=h;C>0;C--)w=1<<C-1,T+=(d&w?1:0)+(y&w?2:0);return T})(this.z,this.x,this.y);return e[(this.x+this.y)%e.length].replace("{prefix}",(this.x%16).toString(16)+(this.y%16).toString(16)).replace(/{z}/g,String(this.z)).replace(/{x}/g,String(this.x)).replace(/{y}/g,String(i==="tms"?Math.pow(2,this.z)-this.y-1:this.y)).replace("{quadkey}",a).replace("{bbox-epsg-3857}",o)}toString(){return`${this.z}/${this.x}/${this.y}`}}class el{constructor(e,i){this.wrap=e,this.canonical=i,this.key=ca(e,i.z,i.z,i.x,i.y)}}class cs{constructor(e,i,o,a,h){this.overscaledZ=e,this.wrap=i,this.canonical=new Lo(o,+a,+h),this.key=i===0&&e===o?this.canonical.key:ca(i,e,o,a,h)}equals(e){return this.overscaledZ===e.overscaledZ&&this.wrap===e.wrap&&this.canonical.equals(e.canonical)}scaledTo(e){const i=this.canonical.z-e;return e>this.canonical.z?new cs(e,this.wrap,this.canonical.z,this.canonical.x,this.canonical.y):new cs(e,this.wrap,e,this.canonical.x>>i,this.canonical.y>>i)}calculateScaledKey(e,i=!0){if(this.overscaledZ===e&&i)return this.key;if(e>this.canonical.z)return ca(this.wrap*+i,e,this.canonical.z,this.canonical.x,this.canonical.y);{const o=this.canonical.z-e;return ca(this.wrap*+i,e,e,this.canonical.x>>o,this.canonical.y>>o)}}isChildOf(e){if(e.wrap!==this.wrap)return!1;const i=this.canonical.z-e.canonical.z;return e.overscaledZ===0||e.overscaledZ<this.overscaledZ&&e.canonical.z<this.canonical.z&&e.canonical.x===this.canonical.x>>i&&e.canonical.y===this.canonical.y>>i}children(e){if(this.overscaledZ>=e)return[new cs(this.overscaledZ+1,this.wrap,this.canonical.z,this.canonical.x,this.canonical.y)];const i=this.canonical.z+1,o=2*this.canonical.x,a=2*this.canonical.y;return[new cs(i,this.wrap,i,o,a),new cs(i,this.wrap,i,o+1,a),new cs(i,this.wrap,i,o,a+1),new cs(i,this.wrap,i,o+1,a+1)]}isLessThan(e){return this.wrap<e.wrap||!(this.wrap>e.wrap)&&(this.overscaledZ<e.overscaledZ||!(this.overscaledZ>e.overscaledZ)&&(this.canonical.x<e.canonical.x||!(this.canonical.x>e.canonical.x)&&this.canonical.y<e.canonical.y))}wrapped(){return new cs(this.overscaledZ,0,this.canonical.z,this.canonical.x,this.canonical.y)}unwrapTo(e){return new cs(this.overscaledZ,e,this.canonical.z,this.canonical.x,this.canonical.y)}overscaleFactor(){return Math.pow(2,this.overscaledZ-this.canonical.z)}toUnwrapped(){return new el(this.wrap,this.canonical)}toString(){return`${this.overscaledZ}/${this.canonical.x}/${this.canonical.y}`}}function ca(n,e,i,o,a){const h=1<<Math.min(i,22);let d=h*(a%h)+o%h;return n&&i<22&&(d+=h*h*((n<0?-2*n-1:2*n)%(1<<2*(22-i)))),16*(32*d+i)+(e-i)}const Ou=[n=>{let e=n.canonical.x-1,i=n.wrap;return e<0&&(e=(1<<n.canonical.z)-1,i--),new cs(n.overscaledZ,i,n.canonical.z,e,n.canonical.y)},n=>{let e=n.canonical.x+1,i=n.wrap;return e===1<<n.canonical.z&&(e=0,i++),new cs(n.overscaledZ,i,n.canonical.z,e,n.canonical.y)},n=>new cs(n.overscaledZ,n.wrap,n.canonical.z,n.canonical.x,(n.canonical.y===0?1<<n.canonical.z:n.canonical.y)-1),n=>new cs(n.overscaledZ,n.wrap,n.canonical.z,n.canonical.x,n.canonical.y===(1<<n.canonical.z)-1?0:n.canonical.y+1)];Kt(Lo,"CanonicalTileID"),Kt(cs,"OverscaledTileID",{omit:["projMatrix","expandedProjMatrix"]});const Fp=hn([{type:"Float32",name:"a_globe_pos",components:3},{type:"Float32",name:"a_uv",components:2}]),{members:Op}=Fp,ip=hn([{name:"a_pos_3",components:3,type:"Int16"}]);var U_=hn([{name:"a_pos",type:"Int16",components:2}]);function hd(n){return n*fo/I}const f=[new Si([p,p,p],[_,_,_]),new Si([p,p,p],[0,0,_]),new Si([0,p,p],[_,0,_]),new Si([p,0,p],[0,_,_]),new Si([0,0,p],[_,_,_])];function g(n,e,i,o=!0){const a=Qe([],n._camera.position,n.worldSize),h=[e,i,1,1];Rn(h,h,n.pixelMatrixInverse),Zn(h,h,1/h[3]);const d=zi([],Ut([],h,a)),y=n.globeMatrix,w=[y[12],y[13],y[14]],T=Ut([],w,a),C=Oe(T),P=zi([],T),D=n.worldSize/(2*Math.PI),O=Ji(P,d),N=Math.asin(D/C);if(N<Math.acos(O)){if(!o)return null;const it=[],Fe=[];Qe(it,d,C/O),zi(Fe,Ut(Fe,it,T)),zi(d,wn(d,T,Qe(d,Fe,Math.tan(N)*C)))}const G=[];new En(a,d).closestPointOnSphere(w,D,G);const q=zi([],br(y,0)),Y=zi([],br(y,1)),se=zi([],br(y,2)),re=Ji(q,G),ae=Ji(Y,G),Ee=Ji(se,G),ve=ke(Math.asin(-ae/D));let xe=ke(Math.atan2(re,Ee));xe=n.center.lng+(function(it,Fe){const ot=(Fe-it+180)%360-180;return ot<-180?ot+360:ot})(n.center.lng,xe);const Pe=H(xe),Me=de(X(ve),0,1);return new ge(Pe,Me)}class S{constructor(e,i,o){this.a=Ut([],e,o),this.b=Ut([],i,o),this.center=o;const a=zi([],this.a),h=zi([],this.b);this.angle=Math.acos(Ji(a,h))}}function k(n,e){if(n.angle===0)return null;let i;return i=n.a[e]===0?1/n.angle*.5*Math.PI:1/n.angle*Math.atan(n.b[e]/n.a[e]/Math.sin(n.angle)-1/Math.tan(n.angle)),i<0||i>1?null:(function(o,a,h,d){const y=Math.sin(h);return o*(Math.sin((1-d)*h)/y)+a*(Math.sin(d*h)/y)})(n.a[e],n.b[e],n.angle,de(i,0,1))+n.center[e]}function j(n){if(n.z<=1)return f[n.z+2*n.y+n.x];const e=Ft(Je(n));return Si.fromPoints(e)}function K(n,e,i){return Qe(n,n,1-i),Gt(n,n,e,i)}function fe(n,e,i){for(const o of n)Pn(o,o,e),Qe(o,o,i)}function Ne(n,e,i,o){const a=e/n.worldSize,h=n.globeMatrix;if(i.z<=1){const Me=j(i).getCorners();return fe(Me,h,a),Si.fromPoints(Me)}const d=Je(i,o),y=Ft(d,fo+hd(n._tileCoverLift));fe(y,h,a);const w=Number.MAX_VALUE,T=[-w,-w,-w],C=[w,w,w];if(d.contains(n.center)){for(const Fe of y)Ui(C,C,Fe),Ai(T,T,Fe);T[2]=0;const Me=n.point,it=[Me.x*a,Me.y*a,0];return Ui(C,C,it),Ai(T,T,it),new Si(C,T)}if(n._tileCoverLift>0){for(const Me of y)Ui(C,C,Me),Ai(T,T,Me);return new Si(C,T)}const P=[h[12]*a,h[13]*a,h[14]*a],D=d.getCenter(),O=de(n.center.lat,-pe,pe),N=de(D.lat,-pe,pe),G=H(n.center.lng),q=X(O);let Y=G-H(D.lng);const se=q-X(N);Y>.5?Y-=1:Y<-.5&&(Y+=1);let re=0;Math.abs(Y)>Math.abs(se)?re=Y>=0?1:3:(re=se>=0?0:2,Gt(P,P,[h[4]*a,h[5]*a,h[6]*a],-Math.sin(vn(se>=0?d.getSouth():d.getNorth()))*fo));const ae=y[re],Ee=y[(re+1)%4],ve=new S(ae,Ee,P),xe=[k(ve,0)||ae[0],k(ve,1)||ae[1],k(ve,2)||ae[2]],Pe=st(n.zoom);if(Pe>0){const Me=(function({x:Fe,y:ot,z:Dt},ht,bt,Rt,et){const Tt=1/(1<<Dt);let Ve=Fe*Tt,tt=Ve+Tt,Lt=ot*Tt,Et=Lt+Tt,li=0;const Yt=(Ve+tt)/2-Rt;return Yt>.5?li=-1:Yt<-.5&&(li=1),Ve=((Ve+li)*ht-(Rt*=ht))*bt+Rt,tt=((tt+li)*ht-Rt)*bt+Rt,Lt=(Lt*ht-(et*=ht))*bt+et,Et=(Et*ht-et)*bt+et,[[Ve,Et,0],[tt,Et,0],[tt,Lt,0],[Ve,Lt,0]]})(i,e,n._pixelsPerMercatorPixel,G,q);for(let Fe=0;Fe<y.length;Fe++)K(y[Fe],Me[Fe],Pe);const it=wn([],Me[re],Me[(re+1)%4]);Qe(it,it,.5),K(xe,it,Pe)}for(const Me of y)Ui(C,C,Me),Ai(T,T,Me);return C[2]=Math.min(ae[2],Ee[2]),Ui(C,C,xe),Ai(T,T,xe),new Si(C,T)}function Je({x:n,y:e,z:i},o=!1){const a=1/(1<<i),h=new L(te(n*a),e===(1<<i)-1&&o?-90:oe((e+1)*a)),d=new L(te((n+1)*a),e===0&&o?90:oe(e*a));return new B(h,d)}function Ft(n,e=fo){const i=vn(n.getNorth()),o=vn(n.getSouth()),a=Math.cos(i),h=Math.cos(o),d=Math.sin(i),y=Math.sin(o),w=n.getWest(),T=n.getEast();return[v(h,y,w,e),v(h,y,T,e),v(a,d,T,e),v(a,d,w,e)]}function ai(n,e,i,o){const a=1<<i.z,h=(n/zt+i.x)/a;return b(oe((e/zt+i.y)/a),te(h),o)}function hi({min:n,max:e}){return t/Math.max(e[0]-n[0],e[1]-n[1],e[2]-n[2])}const ci=new Float64Array(16);function Oi(n){const e=hi(n),i=rt(ci,[e,e,e]);return Ti(i,i,zn([],n.min))}function qi(n){const e=(o=n.min,(i=ci)[0]=1,i[1]=0,i[2]=0,i[3]=0,i[4]=0,i[5]=1,i[6]=0,i[7]=0,i[8]=0,i[9]=0,i[10]=1,i[11]=0,i[12]=o[0],i[13]=o[1],i[14]=o[2],i[15]=1,i);var i,o;const a=1/hi(n);return Ei(e,e,[a,a,a])}function Wi(n){const e=zt/(2*Math.PI);return n/(2*Math.PI)/e}function $s(n,e){return zt/(512*Math.pow(2,n))*hi(j(e))}function yt(n,e,i,o,a){const h=Wi(i),d=[n,e,-i/(2*Math.PI)],y=ct(new Float64Array(16));return Ti(y,y,d),Ei(y,y,[h,h,h]),en(y,y,vn(-a)),Hn(y,y,vn(-o)),y}function st(n){return Ae(tp,l,n)}function Pt(n,e){const i=b(e.lat,e.lng),o=(function(N){const G=b(N._center.lat,N._center.lng);let q=on([],kn(0,1,0),G);const Y=De([],-N.angle,G);q=Pn(q,q,Y),De(Y,-N._pitch,q);const se=zi([],G);return Qe(se,se,hd(N.cameraToCenterDistance/N.pixelsPerMeter)),Pn(se,se,Y),wn([],G,se)})(n);return d=(a=Gn([],o,i))[0],y=a[1],w=a[2],T=(h=i)[0],C=h[1],P=h[2],O=(D=Math.sqrt(d*d+y*y+w*w)*Math.sqrt(T*T+C*C+P*P))&&Ji(a,h)/D,Math.acos(Math.min(Math.max(O,-1),1));var a,h,d,y,w,T,C,P,D,O}function xi(n,e){return Pt(n,e)>Math.PI/2*1.01}const nn=vn(85),In=Math.cos(nn),An=Math.sin(nn),qn=$t(),bo=n=>{const e=[];return n.paint.get("circle-pitch-alignment")==="map"&&e.push("PITCH_WITH_MAP"),n.paint.get("circle-pitch-scale")==="map"&&e.push("SCALE_WITH_MAP"),e};function $r(n,e,i,o,a,h,d,y,w){if(h&&n.queryGeometry.isAboveHorizon)return!1;h&&(w*=n.pixelToTileUnitsFactor);const T=n.tileID.canonical,C=i.projection.upVectorScale(T,i.center.lat,i.worldSize).metersToTile;for(const P of e)for(const D of P){const O=D.add(y),N=a&&i.elevation?i.elevation.exaggeration()*a.getElevationAt(O.x,O.y,!0):0,G=i.projection.projectTilePoint(O.x,O.y,T);if(N>0){const re=i.projection.upVector(T,O.x,O.y);G.x+=re[0]*C*N,G.y+=re[1]*C*N,G.z+=re[2]*C*N}const q=h?O:yh(G.x,G.y,G.z,o),Y=h?n.tilespaceRays.map((re=>$3(re,N))):n.queryGeometry.screenGeometry,se=Rn([],[G.x,G.y,G.z,1],o);if(!d&&h?w*=se[3]/i.cameraToCenterDistance:d&&!h&&(w*=i.cameraToCenterDistance/se[3]),h){const re=oe((D.y/zt+T.y)/(1<<T.z));w/=i.projection.pixelsPerMeter(re,1)/Z(1,re)}if(ls(Y,q,w))return!0}return!1}function yh(n,e,i,o){const a=Rn([],[n,e,i,1],o);return new gt(a[0]/a[3],a[1]/a[3])}const j_=kn(0,0,0),q3=kn(0,0,1);function $3(n,e){const i=We();return j_[2]=e,n.intersectsPlane(j_,q3,i),new gt(i[0],i[1])}class cx extends Nn{}let ux,hx,dx,fx;function px(n,{width:e,height:i},o,a){if(a){if(a instanceof Uint8ClampedArray)a=new Uint8Array(a.buffer);else if(a.length!==e*i*o)throw new RangeError("mismatched image size")}else a=new Uint8Array(e*i*o);return n.width=e,n.height=i,n.data=a,n}function mx(n,e,i){const{width:o,height:a}=e;o===n.width&&a===n.height||(Sy(n,e,{x:0,y:0},{x:0,y:0},{width:Math.min(n.width,o),height:Math.min(n.height,a)},i,null),n.width=o,n.height=a,n.data=e.data)}function Sy(n,e,i,o,a,h,d,y){if(a.width===0||a.height===0)return e;if(a.width>n.width||a.height>n.height||i.x>n.width-a.width||i.y>n.height-a.height)throw new RangeError("out of range source coordinates for image copy");if(a.width>e.width||a.height>e.height||o.x>e.width-a.width||o.y>e.height-a.height)throw new RangeError("out of range destination coordinates for image copy");const w=n.data,T=e.data,C=h===4&&y;for(let P=0;P<a.height;P++){const D=((i.y+P)*n.width+i.x)*h,O=((o.y+P)*e.width+o.x)*h;if(C)for(let N=0;N<a.width;N++){const G=D+N*h+3,q=O+N*h;T[q+0]=255,T[q+1]=255,T[q+2]=255,T[q+3]=w[G]}else if(d)for(let N=0;N<a.width;N++){const G=D+N*h,q=O+N*h,Y=new un(w[G+0]/255,w[G+1]/255,w[G+2]/255,w[G+3]).toNonPremultipliedRenderColor(d).toArray();T[q+0]=Y[0],T[q+1]=Y[1],T[q+2]=Y[2],T[q+3]=Y[3]}else for(let N=0;N<a.width*h;N++)T[O+N]=w[D+N]}return e}Kt(cx,"HeatmapBucket",{omit:["layers"]});class pf{constructor(e,i){px(this,e,1,i)}resize(e){mx(this,new pf(e),1)}clone(){return new pf({width:this.width,height:this.height},new Uint8Array(this.data))}static copy(e,i,o,a,h){Sy(e,i,o,a,h,1,null)}}class ko{constructor(e,i){px(this,e,4,i)}resize(e){mx(this,new ko(e),4)}replace(e,i){i?this.data.set(e):this.data=e instanceof Uint8ClampedArray?new Uint8Array(e.buffer):e}clone(){return new ko({width:this.width,height:this.height},new Uint8Array(this.data))}static copy(e,i,o,a,h,d,y){Sy(e,i,o,a,h,4,d,y)}}class _x{constructor(e,i){this.width=e.width,this.height=e.height,this.data=i instanceof Uint8Array?new Float32Array(i.buffer):i}}function Em(n){const e={},i=n.resolution||256,o=n.clips?n.clips.length:1,a=n.image||new ko({width:i,height:o}),h=(d,y,w)=>{e[n.evaluationKey]=w;const T=n.expression.evaluate(e),C=T?T.toNonPremultipliedRenderColor(null):null;C&&(a.data[d+y+0]=Math.floor(255*C.r),a.data[d+y+1]=Math.floor(255*C.g),a.data[d+y+2]=Math.floor(255*C.b),a.data[d+y+3]=Math.floor(255*C.a))};if(n.clips)for(let d=0,y=0;d<o;++d,y+=4*i)for(let w=0,T=0;w<i;w++,T+=4){const C=w/(i-1),{start:P,end:D}=n.clips[d];h(y,T,P*(1-C)+D*C)}else for(let d=0,y=0;d<i;d++,y+=4)h(0,y,d/(i-1));return a}Kt(pf,"AlphaImage"),Kt(ko,"RGBAImage");const W3=hn([{name:"a_pos",components:2,type:"Int16"}],4),Z3=hn([{name:"a_road_z_offset",components:1,type:"Float32"}],4),X3=hn([{name:"a_pos",components:2,type:"Int16"},{name:"a_height",components:1,type:"Float32"}],4),K3=hn([{name:"a_pos_normal_3",components:3,type:"Int16"}],4);function Bp(n,e,i=2){const o=e&&e.length,a=o?e[0]*i:n.length;let h=gx(n,0,a,i,!0);const d=[];if(!h||h.next===h.prev)return d;let y,w,T;if(o&&(h=(function(C,P,D,O){const N=[];for(let G=0,q=P.length;G<q;G++){const Y=gx(C,P[G]*O,G<q-1?P[G+1]*O:C.length,O,!1);Y===Y.next&&(Y.steiner=!0),N.push(rE(Y))}N.sort(tE);for(let G=0;G<N.length;G++)D=iE(N[G],D);return D})(n,e,h,i)),n.length>80*i){y=n[0],w=n[1];let C=y,P=w;for(let D=i;D<a;D+=i){const O=n[D],N=n[D+1];O<y&&(y=O),N<w&&(w=N),O>C&&(C=O),N>P&&(P=N)}T=Math.max(C-y,P-w),T=T!==0?32767/T:0}return Sm(h,d,i,y,w,T,0),d}function gx(n,e,i,o,a){let h;if(a===(function(d,y,w,T){let C=0;for(let P=y,D=w-T;P<w;P+=T)C+=(d[D]-d[P])*(d[P+1]+d[D+1]),D=P;return C})(n,e,i,o)>0)for(let d=e;d<i;d+=o)h=wx(d/o|0,n[d],n[d+1],h);else for(let d=i-o;d>=e;d-=o)h=wx(d/o|0,n[d],n[d+1],h);return h&&Np(h,h.next)&&(Cm(h),h=h.next),h}function np(n,e){if(!n)return n;e||(e=n);let i,o=n;do if(i=!1,o.steiner||!Np(o,o.next)&&ro(o.prev,o,o.next)!==0)o=o.next;else{if(Cm(o),o=e=o.prev,o===o.next)break;i=!0}while(i||o!==e);return e}function Sm(n,e,i,o,a,h,d){if(!n)return;!d&&h&&(function(w,T,C,P){let D=w;do D.z===0&&(D.z=Iy(D.x,D.y,T,C,P)),D.prevZ=D.prev,D.nextZ=D.next,D=D.next;while(D!==w);D.prevZ.nextZ=null,D.prevZ=null,(function(O){let N,G=1;do{let q,Y=O;O=null;let se=null;for(N=0;Y;){N++;let re=Y,ae=0;for(let ve=0;ve<G&&(ae++,re=re.nextZ,re);ve++);let Ee=G;for(;ae>0||Ee>0&&re;)ae!==0&&(Ee===0||!re||Y.z<=re.z)?(q=Y,Y=Y.nextZ,ae--):(q=re,re=re.nextZ,Ee--),se?se.nextZ=q:O=q,q.prevZ=se,se=q;Y=re}se.nextZ=null,G*=2}while(N>1)})(D)})(n,o,a,h);let y=n;for(;n.prev!==n.next;){const w=n.prev,T=n.next;if(h?Q3(n,o,a,h):Y3(n))e.push(w.i,n.i,T.i),Cm(n),n=T.next,y=T.next;else if((n=T)===y){d?d===1?Sm(n=J3(np(n),e),e,i,o,a,h,2):d===2&&eE(n,e,i,o,a,h):Sm(np(n),e,i,o,a,h,1);break}}}function Y3(n){const e=n.prev,i=n,o=n.next;if(ro(e,i,o)>=0)return!1;const a=e.x,h=i.x,d=o.x,y=e.y,w=i.y,T=o.y,C=Math.min(a,h,d),P=Math.min(y,w,T),D=Math.max(a,h,d),O=Math.max(y,w,T);let N=o.next;for(;N!==e;){if(N.x>=C&&N.x<=D&&N.y>=P&&N.y<=O&&Im(a,y,h,w,d,T,N.x,N.y)&&ro(N.prev,N,N.next)>=0)return!1;N=N.next}return!0}function Q3(n,e,i,o){const a=n.prev,h=n,d=n.next;if(ro(a,h,d)>=0)return!1;const y=a.x,w=h.x,T=d.x,C=a.y,P=h.y,D=d.y,O=Math.min(y,w,T),N=Math.min(C,P,D),G=Math.max(y,w,T),q=Math.max(C,P,D),Y=Iy(O,N,e,i,o),se=Iy(G,q,e,i,o);let re=n.prevZ,ae=n.nextZ;for(;re&&re.z>=Y&&ae&&ae.z<=se;){if(re.x>=O&&re.x<=G&&re.y>=N&&re.y<=q&&re!==a&&re!==d&&Im(y,C,w,P,T,D,re.x,re.y)&&ro(re.prev,re,re.next)>=0||(re=re.prevZ,ae.x>=O&&ae.x<=G&&ae.y>=N&&ae.y<=q&&ae!==a&&ae!==d&&Im(y,C,w,P,T,D,ae.x,ae.y)&&ro(ae.prev,ae,ae.next)>=0))return!1;ae=ae.nextZ}for(;re&&re.z>=Y;){if(re.x>=O&&re.x<=G&&re.y>=N&&re.y<=q&&re!==a&&re!==d&&Im(y,C,w,P,T,D,re.x,re.y)&&ro(re.prev,re,re.next)>=0)return!1;re=re.prevZ}for(;ae&&ae.z<=se;){if(ae.x>=O&&ae.x<=G&&ae.y>=N&&ae.y<=q&&ae!==a&&ae!==d&&Im(y,C,w,P,T,D,ae.x,ae.y)&&ro(ae.prev,ae,ae.next)>=0)return!1;ae=ae.nextZ}return!0}function J3(n,e){let i=n;do{const o=i.prev,a=i.next.next;!Np(o,a)&&vx(o,i,i.next,a)&&Am(o,a)&&Am(a,o)&&(e.push(o.i,i.i,a.i),Cm(i),Cm(i.next),i=n=a),i=i.next}while(i!==n);return np(i)}function eE(n,e,i,o,a,h){let d=n;do{let y=d.next.next;for(;y!==d.prev;){if(d.i!==y.i&&sE(d,y)){let w=xx(d,y);return d=np(d,d.next),w=np(w,w.next),Sm(d,e,i,o,a,h,0),void Sm(w,e,i,o,a,h,0)}y=y.next}d=d.next}while(d!==n)}function tE(n,e){let i=n.x-e.x;return i===0&&(i=n.y-e.y,i===0)&&(i=(n.next.y-n.y)/(n.next.x-n.x)-(e.next.y-e.y)/(e.next.x-e.x)),i}function iE(n,e){const i=(function(a,h){let d=h;const y=a.x,w=a.y;let T,C=-1/0;if(Np(a,d))return d;do{if(Np(a,d.next))return d.next;if(w<=d.y&&w>=d.next.y&&d.next.y!==d.y){const G=d.x+(w-d.y)*(d.next.x-d.x)/(d.next.y-d.y);if(G<=y&&G>C&&(C=G,T=d.x<d.next.x?d:d.next,G===y))return T}d=d.next}while(d!==h);if(!T)return null;const P=T,D=T.x,O=T.y;let N=1/0;d=T;do{if(y>=d.x&&d.x>=D&&y!==d.x&&yx(w<O?y:C,w,D,O,w<O?C:y,w,d.x,d.y)){const G=Math.abs(w-d.y)/(y-d.x);Am(d,a)&&(G<N||G===N&&(d.x>T.x||d.x===T.x&&nE(T,d)))&&(T=d,N=G)}d=d.next}while(d!==P);return T})(n,e);if(!i)return e;const o=xx(i,n);return np(o,o.next),np(i,i.next)}function nE(n,e){return ro(n.prev,n,e.prev)<0&&ro(e.next,n,n.next)<0}function Iy(n,e,i,o,a){return(n=1431655765&((n=858993459&((n=252645135&((n=16711935&((n=(n-i)*a|0)|n<<8))|n<<4))|n<<2))|n<<1))|(e=1431655765&((e=858993459&((e=252645135&((e=16711935&((e=(e-o)*a|0)|e<<8))|e<<4))|e<<2))|e<<1))<<1}function rE(n){let e=n,i=n;do(e.x<i.x||e.x===i.x&&e.y<i.y)&&(i=e),e=e.next;while(e!==n);return i}function yx(n,e,i,o,a,h,d,y){return(a-d)*(e-y)>=(n-d)*(h-y)&&(n-d)*(o-y)>=(i-d)*(e-y)&&(i-d)*(h-y)>=(a-d)*(o-y)}function Im(n,e,i,o,a,h,d,y){return!(n===d&&e===y)&&yx(n,e,i,o,a,h,d,y)}function sE(n,e){return n.next.i!==e.i&&n.prev.i!==e.i&&!(function(i,o){let a=i;do{if(a.i!==i.i&&a.next.i!==i.i&&a.i!==o.i&&a.next.i!==o.i&&vx(a,a.next,i,o))return!0;a=a.next}while(a!==i);return!1})(n,e)&&(Am(n,e)&&Am(e,n)&&(function(i,o){let a=i,h=!1;const d=(i.x+o.x)/2,y=(i.y+o.y)/2;do a.y>y!=a.next.y>y&&a.next.y!==a.y&&d<(a.next.x-a.x)*(y-a.y)/(a.next.y-a.y)+a.x&&(h=!h),a=a.next;while(a!==i);return h})(n,e)&&(ro(n.prev,n,e.prev)||ro(n,e.prev,e))||Np(n,e)&&ro(n.prev,n,n.next)>0&&ro(e.prev,e,e.next)>0)}function ro(n,e,i){return(e.y-n.y)*(i.x-e.x)-(e.x-n.x)*(i.y-e.y)}function Np(n,e){return n.x===e.x&&n.y===e.y}function vx(n,e,i,o){const a=H_(ro(n,e,i)),h=H_(ro(n,e,o)),d=H_(ro(i,o,n)),y=H_(ro(i,o,e));return a!==h&&d!==y||!(a!==0||!G_(n,i,e))||!(h!==0||!G_(n,o,e))||!(d!==0||!G_(i,n,o))||!(y!==0||!G_(i,e,o))}function G_(n,e,i){return e.x<=Math.max(n.x,i.x)&&e.x>=Math.min(n.x,i.x)&&e.y<=Math.max(n.y,i.y)&&e.y>=Math.min(n.y,i.y)}function H_(n){return n>0?1:n<0?-1:0}function Am(n,e){return ro(n.prev,n,n.next)<0?ro(n,e,n.next)>=0&&ro(n,n.prev,e)>=0:ro(n,e,n.prev)<0||ro(n,n.next,e)<0}function xx(n,e){const i=Ay(n.i,n.x,n.y),o=Ay(e.i,e.x,e.y),a=n.next,h=e.prev;return n.next=e,e.prev=n,i.next=a,a.prev=i,o.next=i,i.prev=o,h.next=o,o.prev=h,o}function wx(n,e,i,o){const a=Ay(n,e,i);return o?(a.next=o.next,a.prev=o,o.next.prev=a,o.next=a):(a.prev=a,a.next=a),a}function Cm(n){n.next.prev=n.prev,n.prev.next=n.next,n.prevZ&&(n.prevZ.nextZ=n.nextZ),n.nextZ&&(n.nextZ.prevZ=n.prevZ)}function Ay(n,e,i){return{i:n,x:e,y:i,prev:null,next:null,z:0,prevZ:null,nextZ:null,steiner:!1}}function Pm(n,e){const i=n.length;if(i<=1)return[n];const o=[];let a,h;for(let d=0;d<i;d++){const y=Fn(n[d]);y!==0&&(n[d].area=Math.abs(y),h===void 0&&(h=y<0),h===y<0?(a&&o.push(a),a=[n[d]]):a.push(n[d]))}if(a&&o.push(a),e>1)for(let d=0;d<o.length;d++)o[d].length<=e||(Ds(o[d],e,1,o[d].length-1,oE),o[d]=o[d].slice(0,e));return o}function oE(n,e){return e.area-n.area}function bx(n,e,i=1){if(!n)return null;const o=typeof n=="string"?Yn.from(n).getPrimary():n.getPrimary(),a=typeof n=="string"?null:n.getSecondary();for(const h of[o,a]){if(!h)continue;const d=h.id.toString();e.has(d)||e.set(d,[]),h.scaleSelf(i),e.get(d).push(h)}return{primary:o.toString(),secondary:a?a.toString():null}}function Cy(n,e,i,o){const a=o.patternDependencies;let h=!1;for(const d of e){const y=d.paint.get(`${n}-pattern`);y.isConstant()||(h=!0),bx(y.constantOr(null),a,i)&&(h=!0)}return h}function Py(n,e,i,o,a,h){const d=h.patternDependencies;for(const y of e){const w=y.paint.get(`${n}-pattern`).value;if(w.kind!=="constant"){let T=w.evaluate({zoom:o},i,{},h.availableImages);T=T&&T.name?T.name:T;const C=bx(T,d,a);if(!C)continue;const{primary:P,secondary:D}=C;P&&(i.patterns[y.id]=[P,D].filter(Boolean))}}return i}class Tx{constructor(){this.polygons=new Map}add(e,...i){this.polygons.has(e)?this.polygons.get(e).push(...i):this.polygons.set(e,i)}merge(e){for(const[i,o]of e.polygons)this.add(i,...o)}}class rp{constructor(){this.portals=[]}static evaluate(e){if(e.length===0)return new rp;let i=[];for(const T of e)i.push(...T.portals);if(i.length===0)return new rp;const o=(T,C)=>T<=0&&C<=0||T>=zt&&C>=zt;for(const T of i){const C=T.va,P=T.vb;(o(C.x,P.x)||o(C.y,P.y))&&(T.type="border")}const a=i.filter((T=>T.type!=="unevaluated")),h=i.filter((T=>T.type==="unevaluated"));if(h.length===0)return new rp;h.sort(((T,C)=>T.hash===C.hash?T.isTunnel===C.isTunnel?0:T.isTunnel?-1:1:T.hash<C.hash?1:-1)),i=a.concat(h);let d=a.length,y=d,w=d;do if(y++,y===i.length||i[d].hash!==i[y].hash){if(y-d==2){w<d&&(i[w]=i[d],i[d]=null);const T=i[w],C=i[y-1];T.type=T.isTunnel!==C.isTunnel?"tunnel":"polygon",T.connection={a:T.connection.a,b:C.connection.a},w++}d=y}while(d!==i.length);return i.splice(w),i.sort(((T,C)=>T.hash<C.hash?1:-1)),{portals:i}}}Kt(rp,"ElevationPortalGraph"),Kt(Tx,"ElevationPolygons");class aE{constructor(e,i,o){this.outPositions=e,this.outNormals=i,this.outIndices=o,this.vertexLookup=new Map,this.buffer=new ArrayBuffer(4),this.view=new DataView(this.buffer)}addVertex(e,i,o){let a=e[2];o!=null&&(a*=o);const h=this.getVec3Bits(e)<<96n|this.getVec3Bits(i),d=this.vertexLookup.get(h);if(d!=null)return d;const y=this.outPositions.length;this.vertexLookup.set(h,y);const w=Math.trunc(16384*i[0]),T=Math.trunc(16384*i[1]),C=Math.trunc(16384*i[2]);return this.outPositions.emplaceBack(e[0],e[1],a),this.outNormals.emplaceBack(w,T,C),y}addTriangle(e,i,o){this.outIndices.emplaceBack(e,i,o)}addTriangles(e,i,o){if(e.length===0)return;const a=o.length===1,h=We(),d=We();for(let y=0;y<e.length;y+=3){const w=i[e[y+0]],T=i[e[y+1]],C=i[e[y+2]],P=a?o[0]:o[e[y+1]],D=a?o[0]:o[e[y+2]];$n(h,w.x,w.y,a?o[0]:o[e[y+0]]);const O=this.addVertex(h,d);$n(h,T.x,T.y,P);const N=this.addVertex(h,d);$n(h,C.x,C.y,D);const G=this.addVertex(h,d);this.outIndices.emplaceBack(O,N,G)}}addQuad(e,i,o,a,h,d){const y=this.addVertex(e,h,d),w=this.addVertex(i,h,d),T=this.addVertex(o,h,d),C=this.addVertex(a,h,d);this.addTriangle(y,w,T),this.addTriangle(T,C,y)}getVertexCount(){return this.outPositions.length}clearVertexLookup(){this.vertexLookup.clear()}getBits(e){return this.view.setFloat32(0,e),BigInt(this.view.getUint32(0))}getVec3Bits(e){return this.getBits(e[0])<<64n|this.getBits(e[1])<<32n|this.getBits(e[2])}}class Cl{constructor(e,i,o,a){this.unevaluatedPortals=new rp,this.portalPolygons=new Tx,this.bridgeFeatureSections=[],this.tunnelFeatureSections=[],this.vertexHashLookup=new Map,this.unevalVertices=[],this.unevalHeights=[],this.unevalTriangles=[],this.unevalTunnelTriangles=[],this.unevalEdges=[],this.vertexPositions=new $f,this.vertexNormals=new Wd,this.indexArray=new yr,this.tileToMeters=_e(e),this.bridgeProgramConfigurations=new oa(i,{zoom:o,lut:a},(h=>h!=="fill-tunnel-structure-color")),this.tunnelProgramConfigurations=new oa(i,{zoom:o,lut:a},(h=>h!=="fill-bridge-guard-rail-color"))}addVertices(e,i){const o=this.unevalVertices.length;for(let a=0;a<e.length;a++)this.unevalVertices.push(e[a]),this.unevalHeights.push(i[a]);return o}addTriangles(e,i,o){const a=o?this.unevalTunnelTriangles:this.unevalTriangles;for(const h of e)a.push(h+i)}addRenderableRing(e,i,o,a,h,d){const y=[new gt(h.min.x,h.min.y),new gt(h.max.x,h.min.y),new gt(h.max.x,h.max.y),new gt(h.min.x,h.max.y)];for(let w=0;w<o-1;w++){const T=i+w,C=T+1,P=this.unevalVertices[T],D=this.unevalVertices[C];if(!(P.x>=h.min.x&&P.x<=h.max.x&&P.y>=h.min.y&&P.y<=h.max.y||D.x>=h.min.x&&D.x<=h.max.x&&D.y>=h.min.y&&D.y<=h.max.y||qr(P,D,y))||this.isOnBorder(P.x,D.x)||this.isOnBorder(P.y,D.y))continue;const O=Cl.computeEdgeHash(this.unevalVertices[T],this.unevalVertices[C]);let N,G=this.vertexHashLookup.get(Cl.computePosHash(P));G!=null?N=G.next:(G=this.vertexHashLookup.get(Cl.computePosHash(D)),N=G!=null?G.prev:O),this.unevalEdges.push({polygonIdx:e,a:T,b:C,hash:O,portalHash:N,isTunnel:a,type:"unevaluated",featureInfo:d})}}addPortalCandidates(e,i,o,a,h){if(i.length===0)return;this.portalPolygons.add(e,{geometry:i,zLevel:h});const d=i[0];this.vertexHashLookup.clear();let y=Cl.computeEdgeHash(d[d.length-2],d[d.length-1]);for(let w=0;w<d.length-1;w++){const T=d[w+0],C=d[w+1],P=Xs(C.x-T.x,C.y-T.y),D=Na(P);if(D===0)continue;let O="unevaluated";const N=a.pointElevation(T),G=a.pointElevation(C);Math.abs(N)<.01&&Math.abs(G)<.01?O="entrance":(this.isOnBorder(T.x,C.x)||this.isOnBorder(T.y,C.y))&&(O="border");const q=Cl.computeEdgeHash(T,C);this.unevaluatedPortals.portals.push({connection:{a:e,b:void 0},va:T,vb:C,vab:P,length:D,hash:q,isTunnel:o,type:O});const Y=Cl.computePosHash(T);this.vertexHashLookup.set(Y,{prev:y,next:q}),y=q}}construct(e){if(this.unevalVertices.length===0)return;const i=()=>({vertexOffset:0,primitiveOffset:this.indexArray.length}),o=D=>{D.primitiveLength=this.indexArray.length-D.primitiveOffset},a=new aE(this.vertexPositions,this.vertexNormals,this.indexArray);this.prepareEdges(e.portals,this.unevalEdges);const h=i(),d=i(),y=i(),w=(D,O)=>{D.sort(((G,q)=>G.type===O&&q.type!==O?-1:G.type!==O&&q.type===O?1:0));const N=D.findIndex((G=>G.type!==O));return N>=0?N:D.length};let T=0;this.unevalEdges.length>0&&(T=w(this.unevalEdges,"none"),this.constructBridgeStructures(a,this.unevalVertices,this.unevalHeights,this.unevalEdges,{min:0,max:T},this.tileToMeters)),o(y);const C=i(),P=i();if(this.unevalEdges.length>0){const D=this.unevalEdges.splice(T),O=w(D,"tunnel")+T;this.unevalEdges.push(...D),this.constructTunnelStructures(a,this.unevalVertices,this.unevalHeights,this.unevalEdges,{min:0,max:T},{min:T,max:O})}o(C),a.addTriangles(this.unevalTriangles,this.unevalVertices,this.unevalHeights),o(P),a.addTriangles(this.unevalTunnelTriangles,this.unevalVertices,this.unevalHeights),o(d),a.addTriangles(this.unevalTunnelTriangles,this.unevalVertices,[-.1]),o(h),this.maskSegments=kr.simpleSegment(0,P.primitiveOffset,0,P.primitiveLength),this.depthSegments=kr.simpleSegment(0,d.primitiveOffset,0,d.primitiveLength),this.renderableBridgeSegments=kr.simpleSegment(0,y.primitiveOffset,0,y.primitiveLength),this.renderableTunnelSegments=kr.simpleSegment(0,C.primitiveOffset,0,C.primitiveLength),this.shadowCasterSegments=kr.simpleSegment(0,h.primitiveOffset,0,h.primitiveLength)}update(e,i,o,a,h,d,y,w){this.bridgeProgramConfigurations.updatePaintArrays(e,i,h,o,a,d,y,w),this.tunnelProgramConfigurations.updatePaintArrays(e,i,h,o,a,d,y,w)}upload(e){this.vertexBuffer||this.vertexPositions.length===0||this.vertexNormals.length===0||this.indexArray.length===0||(this.vertexBuffer=e.createVertexBuffer(this.vertexPositions,X3.members),this.vertexBufferNormal=e.createVertexBuffer(this.vertexNormals,K3.members),this.indexBuffer=e.createIndexBuffer(this.indexArray),this.bridgeProgramConfigurations.upload(e),this.tunnelProgramConfigurations.upload(e))}destroy(){this.vertexBuffer&&(this.vertexBuffer.destroy(),this.vertexBufferNormal.destroy(),this.indexBuffer.destroy()),this.maskSegments&&(this.maskSegments.destroy(),this.depthSegments.destroy(),this.renderableBridgeSegments.destroy(),this.renderableTunnelSegments.destroy(),this.shadowCasterSegments.destroy()),this.bridgeProgramConfigurations.destroy(),this.tunnelProgramConfigurations.destroy()}populatePaintArrays(e,i,o,a,h){const d=(y,w)=>{for(let T=0;T<w.length-1;T++){const C=w[T].featureIndex,P=w[T+1].vertexStart,D=e.feature(C);y.populatePaintArrays(P,D,C,{},o,i,a,void 0,h)}};d(this.bridgeProgramConfigurations,this.bridgeFeatureSections),d(this.tunnelProgramConfigurations,this.tunnelFeatureSections)}computeVertexConnections(e,i,o,a,h){const d=new Map;for(let y=a;y<h;y++){const w=o[y],T=w.a,C=w.b,P=Cl.computePosHash(e[T]),D=Cl.computePosHash(e[C]);let O=d.get(P);O||(O={},d.set(P,O));let N=d.get(D);N||(N={},d.set(D,N)),i[T]<=0&&i[C]<=0||(O.to=C,N.from=T)}return d}isTerminalVertex(e,i){const o=Cl.computePosHash(this.unevalVertices[e]),a=i.get(o);return!a||!a.from||!a.to}constructBridgeStructures(e,i,o,a,h,d){e.clearVertexLookup();const y=this.computeVertexConnections(i,o,a,h.min,h.max),w=1/d,T=.5*w,C=(bt,Rt)=>$n(bt,i[Rt].x,i[Rt].y,o[Rt]*w),P=We(),D=We(),O=We(),N=We(),G=We(),q=(bt,Rt)=>{const et=y.get(Cl.computePosHash(i[Rt])),Tt=et.from,Ve=et.to;if(!Tt||!Ve)return;C(P,Tt),C(D,Rt),C(O,Ve),Yo(N),Bs(P,D)||(Ut(G,D,P),zi(N,G)),Bs(O,D)||(Ut(G,O,D),wn(N,N,zi(G,G)));const tt=cn(N);return tt>0?Qe(bt,N,1/tt):void 0};let Y=Number.POSITIVE_INFINITY;this.sortSubarray(a,h.min,h.max,((bt,Rt)=>bt.featureInfo.featureIndex-Rt.featureInfo.featureIndex));const se=We(),re=We(),ae=We(),Ee=We(),ve=We(),xe=We(),Pe=We(),Me=We(),it=We(),Fe=[We(),We(),We(),We()],ot=[We(),We(),We(),We()],Dt=[{coord:new gt(0,0),height:0},{coord:new gt(0,0),height:0}],ht=(bt,Rt)=>bt>Rt;for(let bt=h.min;bt<h.max;bt++){const Rt=a[bt];if(!Rt.featureInfo.guardRailEnabled||!this.prepareEdgePoints(Dt,i,o,Rt,ht))continue;const[et,Tt]=Dt;if($n(se,et.coord.x,et.coord.y,w*et.height),$n(re,Tt.coord.x,Tt.coord.y,w*Tt.height),Bs(se,re))continue;Ut(ae,re,se),zi(ae,ae);const Ve=q(Me,Rt.a)||ae,tt=q(it,Rt.b)||ae;$n(Ee,Ve[1],-Ve[0],0),zi(Ee,Ee),$n(ve,tt[1],-tt[0],0),zi(ve,ve),on(Me,Ee,Ve),zi(xe,Me),on(Me,ve,tt),zi(Pe,Me),wn(Fe[0],se,Qe(Me,Ut(Me,Ee,xe),T)),wn(Fe[1],se,Qe(Me,wn(Me,Ee,xe),T)),wn(Fe[2],se,Qe(Me,xe,T)),Fe[3]=se,wn(ot[0],re,Qe(Me,Ut(Me,ve,Pe),T)),wn(ot[1],re,Qe(Me,wn(Me,ve,Pe),T)),wn(ot[2],re,Qe(Me,Pe,T)),ot[3]=re,Y=this.addFeatureSection(Rt.featureInfo.featureIndex,Y,this.bridgeFeatureSections,e);const Lt=e.addVertex(Fe[0],Ee,d),Et=e.addVertex(Fe[1],Ee,d),li=e.addVertex(ot[0],ve,d),Yt=e.addVertex(ot[1],ve,d);e.addTriangle(Lt,Et,li),e.addTriangle(Et,Yt,li);const vt=e.addVertex(Fe[1],xe,d),At=e.addVertex(Fe[2],xe,d),ti=e.addVertex(ot[1],Pe,d),Zt=e.addVertex(ot[2],Pe,d);e.addTriangle(vt,At,ti),e.addTriangle(At,Zt,ti),zn(Ee,Ee),zn(ve,ve);const Bt=e.addVertex(Fe[2],Ee,d),Xt=e.addVertex(Fe[3],Ee,d),bi=e.addVertex(ot[2],ve,d),Mi=e.addVertex(ot[3],ve,d);e.addTriangle(Bt,Xt,bi),e.addTriangle(Xt,Mi,bi);const Gi=this.isTerminalVertex(Rt.a,y),Bi=this.isTerminalVertex(Rt.b,y);et.height<.01&&Gi&&e.addQuad(Fe[3],Fe[2],Fe[1],Fe[0],zn(Ve,Ve),d),Tt.height<.01&&Bi&&e.addQuad(ot[0],ot[1],ot[2],ot[3],tt,d)}this.bridgeFeatureSections.push({featureIndex:Number.POSITIVE_INFINITY,vertexStart:e.getVertexCount()})}constructTunnelStructures(e,i,o,a,h,d){e.clearVertexLookup();let y=Number.POSITIVE_INFINITY;const w=(Y,se)=>Y.featureInfo.featureIndex-se.featureInfo.featureIndex;this.sortSubarray(a,h.min,h.max,w),this.sortSubarray(a,d.min,d.max,w);const T=Y=>zi(Y,Y),C=[{coord:new gt(0,0),height:0},{coord:new gt(0,0),height:0}],P=(Y,se)=>Y<se,D=We(),O=We(),N=We(),G=We(),q=We();for(let Y=h.min;Y<h.max;Y++){if(!this.prepareEdgePoints(C,i,o,a[Y],P))continue;const[se,re]=C,ae=T($n(q,-(re.coord.y-se.coord.y),re.coord.x-se.coord.x,0));y=this.addFeatureSection(a[Y].featureInfo.featureIndex,y,this.tunnelFeatureSections,e),e.addQuad($n(D,se.coord.x,se.coord.y,se.height),$n(O,re.coord.x,re.coord.y,re.height),$n(N,re.coord.x,re.coord.y,a[Y].isTunnel?-.1:0),$n(G,se.coord.x,se.coord.y,a[Y].isTunnel?-.1:0),ae)}for(let Y=d.min;Y<d.max;Y++){const se=a[Y];se.isTunnel&&([se.a,se.b]=[se.b,se.a]);const re=i[se.a],ae=i[se.b],Ee=T($n(q,-(ae.y-re.y),ae.x-re.x,0));y=this.addFeatureSection(se.featureInfo.featureIndex,y,this.tunnelFeatureSections,e),e.addQuad($n(D,ae.x,ae.y,0),$n(O,re.x,re.y,0),$n(N,re.x,re.y,o[se.a]+4),$n(G,ae.x,ae.y,o[se.b]+4),Ee),e.addQuad($n(D,re.x,re.y,0),$n(O,ae.x,ae.y,0),$n(N,ae.x,ae.y,o[se.b]+4),$n(G,re.x,re.y,o[se.a]+4),Ee)}this.tunnelFeatureSections.push({featureIndex:Number.POSITIVE_INFINITY,vertexStart:e.getVertexCount()})}setElevatedPoint(e,i,o,a){e.coord.x=i,e.coord.y=o,e.height=a}prepareEdgePoints(e,i,o,a,h){let d=i[a.a].x,y=i[a.a].y,w=i[a.b].x,T=i[a.b].y,C=o[a.a],P=o[a.b];const D=h(C,0),O=h(P,0);if(D&&O)return this.setElevatedPoint(e[0],d,y,C),this.setElevatedPoint(e[1],w,T,P),!0;if(!D&&!O)return!1;if(D){if(!O){const N=P/(P-C);w=di(w,d,N),T=di(T,y,N),P=di(P,C,N)}}else{const N=C/(C-P);d=di(d,w,N),y=di(y,T,N),C=di(C,P,N)}return this.setElevatedPoint(e[0],d,y,C),this.setElevatedPoint(e[1],w,T,P),!0}prepareEdges(e,i){if(i.length===0)return;i.sort(((y,w)=>y.hash===w.hash?w.polygonIdx-y.polygonIdx:w.hash>y.hash?1:-1));let o=0,a=0,h=0,d=i[o].polygonIdx;do a++,(a===i.length||i[o].hash!==i[a].hash)&&((a-o==1||i[a-1].polygonIdx!==d)&&(h<o&&(i[h]=i[o],i[o]=null),i[h].type="none",h++),o=a,o!==i.length&&(d=i[o].polygonIdx));while(o!==i.length);if(i.splice(h),i.length!==0&&e.length!==0){i.sort(((T,C)=>T.portalHash<C.portalHash?1:-1));let y=0,w=0;for(;y!==i.length&&w!==e.length;){const T=i[y],C=e[w];T.portalHash>C.hash?y++:C.hash>T.portalHash?w++:(T.type=C.type,y++)}}}isOnBorder(e,i){return e<=0&&i<=0||e>=zt&&i>=zt}addFeatureSection(e,i,o,a){return e!==i&&(i=e,o.push({featureIndex:e,vertexStart:a.getVertexCount()}),a.clearVertexLookup()),i}sortSubarray(e,i,o,a){const h=e.slice(i,o);h.sort(a),e.splice(i,h.length,...h)}static computeEdgeHash(e,i){return(e.y===i.y&&e.x>i.x||e.y>i.y)&&([e,i]=[i,e]),BigInt(Cl.computePosHash(e))<<32n|BigInt(Cl.computePosHash(i))}static computePosHash(e){return((65535&e.x)<<16|65535&e.y)>>>0}}var Ex,Sx={exports:{}},Ix=(Ex||(Ex=1,(function(n,e){(function(i){function o(ue,he){return ue>he?1:ue<he?-1:0}var a=function(ue,he){ue===void 0&&(ue=o),he===void 0&&(he=!1),this._compare=ue,this._root=null,this._size=0,this._noDuplicates=!!he},h={size:{configurable:!0}};function d(ue,he,Ye,kt,Ht){var jt=Ht-kt;if(jt>0){var ei=kt+Math.floor(jt/2),Pi={key:he[ei],data:Ye[ei],parent:ue};return Pi.left=d(Pi,he,Ye,kt,ei),Pi.right=d(Pi,he,Ye,ei+1,Ht),Pi}return null}function y(ue,he,Ye,kt,Ht){if(!(Ye>=kt)){for(var jt=ue[Ye+kt>>1],ei=Ye-1,Pi=kt+1;;){do ei++;while(Ht(ue[ei],jt)<0);do Pi--;while(Ht(ue[Pi],jt)>0);if(ei>=Pi)break;var an=ue[ei];ue[ei]=ue[Pi],ue[Pi]=an,an=he[ei],he[ei]=he[Pi],he[Pi]=an}y(ue,he,Ye,Pi,Ht),y(ue,he,Pi+1,kt,Ht)}}a.prototype.rotateLeft=function(ue){var he=ue.right;he&&(ue.right=he.left,he.left&&(he.left.parent=ue),he.parent=ue.parent),ue.parent?ue===ue.parent.left?ue.parent.left=he:ue.parent.right=he:this._root=he,he&&(he.left=ue),ue.parent=he},a.prototype.rotateRight=function(ue){var he=ue.left;he&&(ue.left=he.right,he.right&&(he.right.parent=ue),he.parent=ue.parent),ue.parent?ue===ue.parent.left?ue.parent.left=he:ue.parent.right=he:this._root=he,he&&(he.right=ue),ue.parent=he},a.prototype._splay=function(ue){for(;ue.parent;){var he=ue.parent;he.parent?he.left===ue&&he.parent.left===he?(this.rotateRight(he.parent),this.rotateRight(he)):he.right===ue&&he.parent.right===he?(this.rotateLeft(he.parent),this.rotateLeft(he)):he.left===ue&&he.parent.right===he?(this.rotateRight(he),this.rotateLeft(he)):(this.rotateLeft(he),this.rotateRight(he)):he.left===ue?this.rotateRight(he):this.rotateLeft(he)}},a.prototype.splay=function(ue){for(var he,Ye,kt,Ht,jt;ue.parent;)(Ye=(he=ue.parent).parent)&&Ye.parent?((kt=Ye.parent).left===Ye?kt.left=ue:kt.right=ue,ue.parent=kt):(ue.parent=null,this._root=ue),Ht=ue.left,jt=ue.right,ue===he.left?(Ye&&(Ye.left===he?(he.right?(Ye.left=he.right,Ye.left.parent=Ye):Ye.left=null,he.right=Ye,Ye.parent=he):(Ht?(Ye.right=Ht,Ht.parent=Ye):Ye.right=null,ue.left=Ye,Ye.parent=ue)),jt?(he.left=jt,jt.parent=he):he.left=null,ue.right=he,he.parent=ue):(Ye&&(Ye.right===he?(he.left?(Ye.right=he.left,Ye.right.parent=Ye):Ye.right=null,he.left=Ye,Ye.parent=he):(jt?(Ye.left=jt,jt.parent=Ye):Ye.left=null,ue.right=Ye,Ye.parent=ue)),Ht?(he.right=Ht,Ht.parent=he):he.right=null,ue.left=he,he.parent=ue)},a.prototype.replace=function(ue,he){ue.parent?ue===ue.parent.left?ue.parent.left=he:ue.parent.right=he:this._root=he,he&&(he.parent=ue.parent)},a.prototype.minNode=function(ue){if(ue===void 0&&(ue=this._root),ue)for(;ue.left;)ue=ue.left;return ue},a.prototype.maxNode=function(ue){if(ue===void 0&&(ue=this._root),ue)for(;ue.right;)ue=ue.right;return ue},a.prototype.insert=function(ue,he){var Ye=this._root,kt=null,Ht=this._compare;if(this._noDuplicates)for(;Ye;){if(kt=Ye,Ht(Ye.key,ue)===0)return;Ye=Ht(Ye.key,ue)<0?Ye.right:Ye.left}else for(;Ye;)kt=Ye,Ye=Ht(Ye.key,ue)<0?Ye.right:Ye.left;return Ye={key:ue,data:he,left:null,right:null,parent:kt},kt?Ht(kt.key,Ye.key)<0?kt.right=Ye:kt.left=Ye:this._root=Ye,this.splay(Ye),this._size++,Ye},a.prototype.find=function(ue){for(var he=this._root,Ye=this._compare;he;){var kt=Ye(he.key,ue);if(kt<0)he=he.right;else{if(!(kt>0))return he;he=he.left}}return null},a.prototype.contains=function(ue){for(var he=this._root,Ye=this._compare;he;){var kt=Ye(ue,he.key);if(kt===0)return!0;he=kt<0?he.left:he.right}return!1},a.prototype.remove=function(ue){var he=this.find(ue);if(!he)return!1;if(this.splay(he),he.left)if(he.right){var Ye=this.minNode(he.right);Ye.parent!==he&&(this.replace(Ye,Ye.right),Ye.right=he.right,Ye.right.parent=Ye),this.replace(he,Ye),Ye.left=he.left,Ye.left.parent=Ye}else this.replace(he,he.left);else this.replace(he,he.right);return this._size--,!0},a.prototype.removeNode=function(ue){if(!ue)return!1;if(this.splay(ue),ue.left)if(ue.right){var he=this.minNode(ue.right);he.parent!==ue&&(this.replace(he,he.right),he.right=ue.right,he.right.parent=he),this.replace(ue,he),he.left=ue.left,he.left.parent=he}else this.replace(ue,ue.left);else this.replace(ue,ue.right);return this._size--,!0},a.prototype.erase=function(ue){var he=this.find(ue);if(he){this.splay(he);var Ye=he.left,kt=he.right,Ht=null;Ye&&(Ye.parent=null,Ht=this.maxNode(Ye),this.splay(Ht),this._root=Ht),kt&&(Ye?Ht.right=kt:this._root=kt,kt.parent=Ht),this._size--}},a.prototype.pop=function(){var ue=this._root,he=null;if(ue){for(;ue.left;)ue=ue.left;he={key:ue.key,data:ue.data},this.remove(ue.key)}return he},a.prototype.next=function(ue){var he=ue;if(he)if(he.right)for(he=he.right;he&&he.left;)he=he.left;else for(he=ue.parent;he&&he.right===ue;)ue=he,he=he.parent;return he},a.prototype.prev=function(ue){var he=ue;if(he)if(he.left)for(he=he.left;he&&he.right;)he=he.right;else for(he=ue.parent;he&&he.left===ue;)ue=he,he=he.parent;return he},a.prototype.forEach=function(ue){for(var he=this._root,Ye=[],kt=!1,Ht=0;!kt;)he?(Ye.push(he),he=he.left):Ye.length>0?(ue(he=Ye.pop(),Ht++),he=he.right):kt=!0;return this},a.prototype.range=function(ue,he,Ye,kt){for(var Ht=[],jt=this._compare,ei=this._root;Ht.length!==0||ei;)if(ei)Ht.push(ei),ei=ei.left;else{if(jt((ei=Ht.pop()).key,he)>0)break;if(jt(ei.key,ue)>=0&&Ye.call(kt,ei))return this;ei=ei.right}return this},a.prototype.keys=function(){for(var ue=this._root,he=[],Ye=[],kt=!1;!kt;)ue?(he.push(ue),ue=ue.left):he.length>0?(ue=he.pop(),Ye.push(ue.key),ue=ue.right):kt=!0;return Ye},a.prototype.values=function(){for(var ue=this._root,he=[],Ye=[],kt=!1;!kt;)ue?(he.push(ue),ue=ue.left):he.length>0?(ue=he.pop(),Ye.push(ue.data),ue=ue.right):kt=!0;return Ye},a.prototype.at=function(ue){for(var he=this._root,Ye=[],kt=!1,Ht=0;!kt;)if(he)Ye.push(he),he=he.left;else if(Ye.length>0){if(he=Ye.pop(),Ht===ue)return he;Ht++,he=he.right}else kt=!0;return null},a.prototype.load=function(ue,he,Ye){if(ue===void 0&&(ue=[]),he===void 0&&(he=[]),Ye===void 0&&(Ye=!1),this._size!==0)throw new Error("bulk-load: tree is not empty");var kt=ue.length;return Ye&&y(ue,he,0,kt-1,this._compare),this._root=d(null,ue,he,0,kt),this._size=kt,this},a.prototype.min=function(){var ue=this.minNode(this._root);return ue?ue.key:null},a.prototype.max=function(){var ue=this.maxNode(this._root);return ue?ue.key:null},a.prototype.isEmpty=function(){return this._root===null},h.size.get=function(){return this._size},a.createTree=function(ue,he,Ye,kt,Ht){return new a(Ye,Ht).load(ue,he,kt)},Object.defineProperties(a.prototype,h);var w=0,T=1,C=2,P=3,D=0,O=1,N=2,G=3;function q(ue,he,Ye){he===null?(ue.inOut=!1,ue.otherInOut=!0):(ue.isSubject===he.isSubject?(ue.inOut=!he.inOut,ue.otherInOut=he.otherInOut):(ue.inOut=!he.otherInOut,ue.otherInOut=he.isVertical()?!he.inOut:he.inOut),he&&(ue.prevInResult=!Y(he,Ye)||he.isVertical()?he.prevInResult:he));var kt=Y(ue,Ye);ue.resultTransition=kt?(function(Ht,jt){var ei,Pi=!Ht.inOut,an=!Ht.otherInOut;switch(jt){case D:ei=Pi&&an;break;case O:ei=Pi||an;break;case G:ei=Pi^an;break;case N:ei=Ht.isSubject?Pi&&!an:an&&!Pi}return ei?1:-1})(ue,Ye):0}function Y(ue,he){switch(ue.type){case w:switch(he){case D:return!ue.otherInOut;case O:return ue.otherInOut;case N:return ue.isSubject&&ue.otherInOut||!ue.isSubject&&!ue.otherInOut;case G:return!0}break;case C:return he===D||he===O;case P:return he===N;case T:return!1}return!1}var se=function(ue,he,Ye,kt,Ht){this.left=he,this.point=ue,this.otherEvent=Ye,this.isSubject=kt,this.type=Ht||w,this.inOut=!1,this.otherInOut=!1,this.prevInResult=null,this.resultTransition=0,this.otherPos=-1,this.outputContourId=-1,this.isExteriorRing=!0},re={inResult:{configurable:!0}};function ae(ue,he){return ue[0]===he[0]&&ue[1]===he[1]}se.prototype.isBelow=function(ue){var he=this.point,Ye=this.otherEvent.point;return this.left?(he[0]-ue[0])*(Ye[1]-ue[1])-(Ye[0]-ue[0])*(he[1]-ue[1])>0:(Ye[0]-ue[0])*(he[1]-ue[1])-(he[0]-ue[0])*(Ye[1]-ue[1])>0},se.prototype.isAbove=function(ue){return!this.isBelow(ue)},se.prototype.isVertical=function(){return this.point[0]===this.otherEvent.point[0]},re.inResult.get=function(){return this.resultTransition!==0},se.prototype.clone=function(){var ue=new se(this.point,this.left,this.otherEvent,this.isSubject,this.type);return ue.contourId=this.contourId,ue.resultTransition=this.resultTransition,ue.prevInResult=this.prevInResult,ue.isExteriorRing=this.isExteriorRing,ue.inOut=this.inOut,ue.otherInOut=this.otherInOut,ue},Object.defineProperties(se.prototype,re);var Ee=11102230246251565e-32,ve=134217729,xe=(3+8*Ee)*Ee;function Pe(ue,he,Ye,kt,Ht){var jt,ei,Pi,an,ln=he[0],Zi=kt[0],cr=0,Xr=0;Zi>ln==Zi>-ln?(jt=ln,ln=he[++cr]):(jt=Zi,Zi=kt[++Xr]);var $i=0;if(cr<ue&&Xr<Ye)for(Zi>ln==Zi>-ln?(Pi=jt-((ei=ln+jt)-ln),ln=he[++cr]):(Pi=jt-((ei=Zi+jt)-Zi),Zi=kt[++Xr]),jt=ei,Pi!==0&&(Ht[$i++]=Pi);cr<ue&&Xr<Ye;)Zi>ln==Zi>-ln?(Pi=jt-((ei=jt+ln)-(an=ei-jt))+(ln-an),ln=he[++cr]):(Pi=jt-((ei=jt+Zi)-(an=ei-jt))+(Zi-an),Zi=kt[++Xr]),jt=ei,Pi!==0&&(Ht[$i++]=Pi);for(;cr<ue;)Pi=jt-((ei=jt+ln)-(an=ei-jt))+(ln-an),ln=he[++cr],jt=ei,Pi!==0&&(Ht[$i++]=Pi);for(;Xr<Ye;)Pi=jt-((ei=jt+Zi)-(an=ei-jt))+(Zi-an),Zi=kt[++Xr],jt=ei,Pi!==0&&(Ht[$i++]=Pi);return jt===0&&$i!==0||(Ht[$i++]=jt),$i}function Me(ue){return new Float64Array(ue)}var it=33306690738754716e-32,Fe=22204460492503146e-32,ot=11093356479670487e-47,Dt=Me(4),ht=Me(8),bt=Me(12),Rt=Me(16),et=Me(4);function Tt(ue,he,Ye){var kt=(function(Ht,jt,ei,Pi,an,ln){var Zi=(jt-ln)*(ei-an),cr=(Ht-an)*(Pi-ln),Xr=Zi-cr;if(Zi===0||cr===0||Zi>0!=cr>0)return Xr;var $i=Math.abs(Zi+cr);return Math.abs(Xr)>=it*$i?Xr:-(function(Rr,vr,Jn,Wr,Cr,xr,Er){var or,Xi,ur,Zr,Ii,Cn,Pr,Qr,Mr,Ps,mr,As,tl,zo,To,il,wh,Rs,Ws=Rr-Cr,Fo=Jn-Cr,ua=vr-xr,Zo=Wr-xr;Dt[0]=(To=(Qr=Ws-(Pr=(Cn=ve*Ws)-(Cn-Ws)))*(Ps=Zo-(Mr=(Cn=ve*Zo)-(Cn-Zo)))-((zo=Ws*Zo)-Pr*Mr-Qr*Mr-Pr*Ps))-((mr=To-(wh=(Qr=ua-(Pr=(Cn=ve*ua)-(Cn-ua)))*(Ps=Fo-(Mr=(Cn=ve*Fo)-(Cn-Fo)))-((il=ua*Fo)-Pr*Mr-Qr*Mr-Pr*Ps)))+(Ii=To-mr))+(Ii-wh),Dt[1]=(tl=zo-((As=zo+mr)-(Ii=As-zo))+(mr-Ii))-((mr=tl-il)+(Ii=tl-mr))+(Ii-il),Dt[2]=As-((Rs=As+mr)-(Ii=Rs-As))+(mr-Ii),Dt[3]=Rs;var wf=(function(SM,Bb){for(var Nb=Bb[0],k0=1;k0<4;k0++)Nb+=Bb[k0];return Nb})(0,Dt),o_=Fe*Er;if(wf>=o_||-wf>=o_||(or=Rr-(Ws+(Ii=Rr-Ws))+(Ii-Cr),ur=Jn-(Fo+(Ii=Jn-Fo))+(Ii-Cr),Xi=vr-(ua+(Ii=vr-ua))+(Ii-xr),Zr=Wr-(Zo+(Ii=Wr-Zo))+(Ii-xr),or===0&&Xi===0&&ur===0&&Zr===0)||(o_=ot*Er+xe*Math.abs(wf),(wf+=Ws*Zr+Zo*or-(ua*ur+Fo*Xi))>=o_||-wf>=o_))return wf;et[0]=(To=(Qr=or-(Pr=(Cn=ve*or)-(Cn-or)))*(Ps=Zo-(Mr=(Cn=ve*Zo)-(Cn-Zo)))-((zo=or*Zo)-Pr*Mr-Qr*Mr-Pr*Ps))-((mr=To-(wh=(Qr=Xi-(Pr=(Cn=ve*Xi)-(Cn-Xi)))*(Ps=Fo-(Mr=(Cn=ve*Fo)-(Cn-Fo)))-((il=Xi*Fo)-Pr*Mr-Qr*Mr-Pr*Ps)))+(Ii=To-mr))+(Ii-wh),et[1]=(tl=zo-((As=zo+mr)-(Ii=As-zo))+(mr-Ii))-((mr=tl-il)+(Ii=tl-mr))+(Ii-il),et[2]=As-((Rs=As+mr)-(Ii=Rs-As))+(mr-Ii),et[3]=Rs;var aA=Pe(4,Dt,4,et,ht);et[0]=(To=(Qr=Ws-(Pr=(Cn=ve*Ws)-(Cn-Ws)))*(Ps=Zr-(Mr=(Cn=ve*Zr)-(Cn-Zr)))-((zo=Ws*Zr)-Pr*Mr-Qr*Mr-Pr*Ps))-((mr=To-(wh=(Qr=ua-(Pr=(Cn=ve*ua)-(Cn-ua)))*(Ps=ur-(Mr=(Cn=ve*ur)-(Cn-ur)))-((il=ua*ur)-Pr*Mr-Qr*Mr-Pr*Ps)))+(Ii=To-mr))+(Ii-wh),et[1]=(tl=zo-((As=zo+mr)-(Ii=As-zo))+(mr-Ii))-((mr=tl-il)+(Ii=tl-mr))+(Ii-il),et[2]=As-((Rs=As+mr)-(Ii=Rs-As))+(mr-Ii),et[3]=Rs;var lA=Pe(aA,ht,4,et,bt);et[0]=(To=(Qr=or-(Pr=(Cn=ve*or)-(Cn-or)))*(Ps=Zr-(Mr=(Cn=ve*Zr)-(Cn-Zr)))-((zo=or*Zr)-Pr*Mr-Qr*Mr-Pr*Ps))-((mr=To-(wh=(Qr=Xi-(Pr=(Cn=ve*Xi)-(Cn-Xi)))*(Ps=ur-(Mr=(Cn=ve*ur)-(Cn-ur)))-((il=Xi*ur)-Pr*Mr-Qr*Mr-Pr*Ps)))+(Ii=To-mr))+(Ii-wh),et[1]=(tl=zo-((As=zo+mr)-(Ii=As-zo))+(mr-Ii))-((mr=tl-il)+(Ii=tl-mr))+(Ii-il),et[2]=As-((Rs=As+mr)-(Ii=Rs-As))+(mr-Ii),et[3]=Rs;var cA=Pe(lA,bt,4,et,Rt);return Rt[cA-1]})(Ht,jt,ei,Pi,an,ln,$i)})(ue[0],ue[1],he[0],he[1],Ye[0],Ye[1]);return kt>0?-1:kt<0?1:0}function Ve(ue,he){var Ye=ue.point,kt=he.point;return Ye[0]>kt[0]?1:Ye[0]<kt[0]?-1:Ye[1]!==kt[1]?Ye[1]>kt[1]?1:-1:(function(Ht,jt,ei,Pi){return Ht.left!==jt.left?Ht.left?1:-1:Tt(ei,Ht.otherEvent.point,jt.otherEvent.point)!==0?Ht.isBelow(jt.otherEvent.point)?-1:1:!Ht.isSubject&&jt.isSubject?1:-1})(ue,he,Ye)}function tt(ue,he,Ye){var kt=new se(he,!1,ue,ue.isSubject),Ht=new se(he,!0,ue.otherEvent,ue.isSubject);return ae(ue.point,ue.otherEvent.point)&&console.warn("what is that, a collapsed segment?",ue),kt.contourId=Ht.contourId=ue.contourId,Ve(Ht,ue.otherEvent)>0&&(ue.otherEvent.left=!0,Ht.left=!1),ue.otherEvent.otherEvent=Ht,ue.otherEvent=kt,Ye.push(Ht),Ye.push(kt),Ye}function Lt(ue,he){return ue[0]*he[1]-ue[1]*he[0]}function Et(ue,he){return ue[0]*he[0]+ue[1]*he[1]}function li(ue,he,Ye){var kt=(function(an,ln,Zi,cr,Xr){var $i=[ln[0]-an[0],ln[1]-an[1]],Rr=[cr[0]-Zi[0],cr[1]-Zi[1]];function vr(Cn,Pr,Qr){return[Cn[0]+Pr*Qr[0],Cn[1]+Pr*Qr[1]]}var Jn=[Zi[0]-an[0],Zi[1]-an[1]],Wr=Lt($i,Rr),Cr=Wr*Wr,xr=Et($i,$i);if(Cr>0){var Er=Lt(Jn,Rr)/Wr;if(Er<0||Er>1)return null;var or=Lt(Jn,$i)/Wr;return or<0||or>1?null:Er===0||Er===1?[vr(an,Er,$i)]:or===0||or===1?[vr(Zi,or,Rr)]:[vr(an,Er,$i)]}if((Cr=(Wr=Lt(Jn,$i))*Wr)>0)return null;var Xi=Et($i,Jn)/xr,ur=Xi+Et($i,Rr)/xr,Zr=Math.min(Xi,ur),Ii=Math.max(Xi,ur);return Zr<=1&&Ii>=0?Zr===1?[vr(an,Zr>0?Zr:0,$i)]:Ii===0?[vr(an,Ii<1?Ii:1,$i)]:[vr(an,Zr>0?Zr:0,$i),vr(an,Ii<1?Ii:1,$i)]:null})(ue.point,ue.otherEvent.point,he.point,he.otherEvent.point),Ht=kt?kt.length:0;if(Ht===0||Ht===1&&(ae(ue.point,he.point)||ae(ue.otherEvent.point,he.otherEvent.point))||Ht===2&&ue.isSubject===he.isSubject)return 0;if(Ht===1)return ae(ue.point,kt[0])||ae(ue.otherEvent.point,kt[0])||tt(ue,kt[0],Ye),ae(he.point,kt[0])||ae(he.otherEvent.point,kt[0])||tt(he,kt[0],Ye),1;var jt=[],ei=!1,Pi=!1;return ae(ue.point,he.point)?ei=!0:Ve(ue,he)===1?jt.push(he,ue):jt.push(ue,he),ae(ue.otherEvent.point,he.otherEvent.point)?Pi=!0:Ve(ue.otherEvent,he.otherEvent)===1?jt.push(he.otherEvent,ue.otherEvent):jt.push(ue.otherEvent,he.otherEvent),ei&&Pi||ei?(he.type=T,ue.type=he.inOut===ue.inOut?C:P,ei&&!Pi&&tt(jt[1].otherEvent,jt[0].point,Ye),2):Pi?(tt(jt[0],jt[1].point,Ye),3):jt[0]!==jt[3].otherEvent?(tt(jt[0],jt[1].point,Ye),tt(jt[1],jt[2].point,Ye),3):(tt(jt[0],jt[1].point,Ye),tt(jt[3].otherEvent,jt[2].point,Ye),3)}function Yt(ue,he){if(ue===he)return 0;if(Tt(ue.point,ue.otherEvent.point,he.point)!==0||Tt(ue.point,ue.otherEvent.point,he.otherEvent.point)!==0)return ae(ue.point,he.point)?ue.isBelow(he.otherEvent.point)?-1:1:ue.point[0]===he.point[0]?ue.point[1]<he.point[1]?-1:1:Ve(ue,he)===1?he.isAbove(ue.point)?-1:1:ue.isBelow(he.point)?-1:1;if(ue.isSubject!==he.isSubject)return ue.isSubject?-1:1;var Ye=ue.point,kt=he.point;return Ye[0]===kt[0]&&Ye[1]===kt[1]?(Ye=ue.otherEvent.point)[0]===(kt=he.otherEvent.point)[0]&&Ye[1]===kt[1]?0:ue.contourId>he.contourId?1:-1:Ve(ue,he)===1?1:-1}var vt=function(){this.points=[],this.holeIds=[],this.holeOf=null,this.depth=null};function At(ue,he,Ye,kt){var Ht,jt=ue+1,ei=he[ue].point,Pi=he.length;for(jt<Pi&&(Ht=he[jt].point);jt<Pi&&Ht[0]===ei[0]&&Ht[1]===ei[1];){if(!Ye[jt])return jt;++jt<Pi&&(Ht=he[jt].point)}for(jt=ue-1;Ye[jt]&&jt>kt;)jt--;return jt}vt.prototype.isExterior=function(){return this.holeOf==null};var ti=Bt,Zt=Bt;function Bt(ue,he){if(!(this instanceof Bt))return new Bt(ue,he);if(this.data=ue||[],this.length=this.data.length,this.compare=he||Xt,this.length>0)for(var Ye=(this.length>>1)-1;Ye>=0;Ye--)this._down(Ye)}function Xt(ue,he){return ue<he?-1:ue>he?1:0}Bt.prototype={push:function(ue){this.data.push(ue),this.length++,this._up(this.length-1)},pop:function(){if(this.length!==0){var ue=this.data[0];return this.length--,this.length>0&&(this.data[0]=this.data[this.length],this._down(0)),this.data.pop(),ue}},peek:function(){return this.data[0]},_up:function(ue){for(var he=this.data,Ye=this.compare,kt=he[ue];ue>0;){var Ht=ue-1>>1,jt=he[Ht];if(Ye(kt,jt)>=0)break;he[ue]=jt,ue=Ht}he[ue]=kt},_down:function(ue){for(var he=this.data,Ye=this.compare,kt=this.length>>1,Ht=he[ue];ue<kt;){var jt=1+(ue<<1),ei=jt+1,Pi=he[jt];if(ei<this.length&&Ye(he[ei],Pi)<0&&(jt=ei,Pi=he[ei]),Ye(Pi,Ht)>=0)break;he[ue]=Pi,ue=jt}he[ue]=Ht}},ti.default=Zt;var bi=Math.max,Mi=Math.min,Gi=0;function Bi(ue,he,Ye,kt,Ht,jt){var ei,Pi,an,ln,Zi,cr;for(ei=0,Pi=ue.length-1;ei<Pi;ei++)if(ln=ue[ei+1],Zi=new se(an=ue[ei],!1,void 0,he),cr=new se(ln,!1,Zi,he),Zi.otherEvent=cr,an[0]!==ln[0]||an[1]!==ln[1]){Zi.contourId=cr.contourId=Ye,jt||(Zi.isExteriorRing=!1,cr.isExteriorRing=!1),Ve(Zi,cr)>0?cr.left=!0:Zi.left=!0;var Xr=an[0],$i=an[1];Ht[0]=Mi(Ht[0],Xr),Ht[1]=Mi(Ht[1],$i),Ht[2]=bi(Ht[2],Xr),Ht[3]=bi(Ht[3],$i),kt.push(Zi),kt.push(cr)}}var mn=[];function Qi(ue,he,Ye){typeof ue[0][0][0]=="number"&&(ue=[ue]),typeof he[0][0][0]=="number"&&(he=[he]);var kt=(function($i,Rr,vr){var Jn=null;return $i.length*Rr.length==0&&(vr===D?Jn=mn:vr===N?Jn=$i:vr!==O&&vr!==G||(Jn=$i.length===0?Rr:$i)),Jn})(ue,he,Ye);if(kt)return kt===mn?null:kt;var Ht=[1/0,1/0,-1/0,-1/0],jt=[1/0,1/0,-1/0,-1/0],ei=(function($i,Rr,vr,Jn,Wr){var Cr,xr,Er,or,Xi,ur,Zr=new ti(null,Ve);for(Er=0,or=$i.length;Er<or;Er++)for(Xi=0,ur=(Cr=$i[Er]).length;Xi<ur;Xi++)(xr=Xi===0)&&Gi++,Bi(Cr[Xi],!0,Gi,Zr,vr,xr);for(Er=0,or=Rr.length;Er<or;Er++)for(Xi=0,ur=(Cr=Rr[Er]).length;Xi<ur;Xi++)xr=Xi===0,Wr===N&&(xr=!1),xr&&Gi++,Bi(Cr[Xi],!1,Gi,Zr,Jn,xr);return Zr})(ue,he,Ht,jt,Ye);if(kt=(function($i,Rr,vr,Jn,Wr){var Cr=null;return(vr[0]>Jn[2]||Jn[0]>vr[2]||vr[1]>Jn[3]||Jn[1]>vr[3])&&(Wr===D?Cr=mn:Wr===N?Cr=$i:Wr!==O&&Wr!==G||(Cr=$i.concat(Rr))),Cr})(ue,he,Ht,jt,Ye))return kt===mn?null:kt;for(var Pi=(function($i){var Rr,vr,Jn=(function(Er){var or,Xi,ur,Zr,Ii=[];for(Xi=0,ur=Er.length;Xi<ur;Xi++)((or=Er[Xi]).left&&or.inResult||!or.left&&or.otherEvent.inResult)&&Ii.push(or);for(var Cn=!1;!Cn;)for(Cn=!0,Xi=0,ur=Ii.length;Xi<ur;Xi++)Xi+1<ur&&Ve(Ii[Xi],Ii[Xi+1])===1&&(Zr=Ii[Xi],Ii[Xi]=Ii[Xi+1],Ii[Xi+1]=Zr,Cn=!1);for(Xi=0,ur=Ii.length;Xi<ur;Xi++)(or=Ii[Xi]).otherPos=Xi;for(Xi=0,ur=Ii.length;Xi<ur;Xi++)(or=Ii[Xi]).left||(Zr=or.otherPos,or.otherPos=or.otherEvent.otherPos,or.otherEvent.otherPos=Zr);return Ii})($i),Wr={},Cr=[],xr=function(){if(!Wr[Rr]){var Er=Cr.length,or=(function(Ii,Cn,Pr){var Qr=new vt;if(Ii.prevInResult!=null){var Mr=Ii.prevInResult,Ps=Mr.outputContourId;if(Mr.resultTransition>0){var mr=Cn[Ps];if(mr.holeOf!=null){var As=mr.holeOf;Cn[As].holeIds.push(Pr),Qr.holeOf=As,Qr.depth=Cn[Ps].depth}else Cn[Ps].holeIds.push(Pr),Qr.holeOf=Ps,Qr.depth=Cn[Ps].depth+1}else Qr.holeOf=null,Qr.depth=Cn[Ps].depth}else Qr.holeOf=null,Qr.depth=0;return Qr})(Jn[Rr],Cr,Er),Xi=function(Ii){Wr[Ii]=!0,Ii<Jn.length&&Jn[Ii]&&(Jn[Ii].outputContourId=Er)},ur=Rr,Zr=Rr;for(or.points.push(Jn[Rr].point);Xi(ur),Xi(ur=Jn[ur].otherPos),or.points.push(Jn[ur].point),!((ur=At(ur,Jn,Wr,Zr))==Zr||ur>=Jn.length)&&Jn[ur];);Cr.push(or)}};for(Rr=0,vr=Jn.length;Rr<vr;Rr++)xr();return Cr})((function($i,Rr,vr,Jn,Wr,Cr){for(var xr,Er,or,Xi=new a(Yt),ur=[],Zr=Math.min(Jn[2],Wr[2]);$i.length!==0;){var Ii=$i.pop();if(ur.push(Ii),Cr===D&&Ii.point[0]>Zr||Cr===N&&Ii.point[0]>Jn[2])break;if(Ii.left){Er=xr=Xi.insert(Ii),xr=xr!==(or=Xi.minNode())?Xi.prev(xr):null,Er=Xi.next(Er);var Cn=xr?xr.key:null;if(q(Ii,Cn,Cr),Er&&li(Ii,Er.key,$i)===2&&(q(Ii,Cn,Cr),q(Er.key,Ii,Cr)),xr&&li(xr.key,Ii,$i)===2){var Pr=xr;q(Cn,(Pr=Pr!==or?Xi.prev(Pr):null)?Pr.key:null,Cr),q(Ii,Cn,Cr)}}else Er=xr=Xi.find(Ii=Ii.otherEvent),xr&&Er&&(xr=xr!==or?Xi.prev(xr):null,Er=Xi.next(Er),Xi.remove(Ii),Er&&xr&&li(xr.key,Er.key,$i))}return ur})(ei,0,0,Ht,jt,Ye)),an=[],ln=0;ln<Pi.length;ln++){var Zi=Pi[ln];if(Zi.isExterior()){for(var cr=[Zi.points],Xr=0;Xr<Zi.holeIds.length;Xr++)cr.push(Pi[Zi.holeIds[Xr]].points);an.push(cr)}}return an}var Ar={UNION:O,DIFFERENCE:N,INTERSECTION:D,XOR:G};i.diff=function(ue,he){return Qi(ue,he,N)},i.intersection=function(ue,he){return Qi(ue,he,D)},i.operations=Ar,i.union=function(ue,he){return Qi(ue,he,O)},i.xor=function(ue,he){return Qi(ue,he,G)},Object.defineProperty(i,"__esModule",{value:!0})})(e)})(0,Sx.exports)),Sx.exports);/**
 * martinez v0.7.4
 * Martinez polygon clipping algorithm, does boolean operation on polygons (multipolygons, polygons with holes etc): intersection, union, difference, xor
 *
 * @author Alex Milevski <info@w8r.name>
 * @license MIT
 * @preserve
 */function q_(n,e,i,o){const a=[],h=o===0?(d,y,w,T,C,P)=>{d.push(new gt(P,w+(P-y)/(T-y)*(C-w)))}:(d,y,w,T,C,P)=>{d.push(new gt(y+(P-w)/(C-w)*(T-y),P))};for(const d of n){const y=[];for(const w of d){if(w.length<=2)continue;const T=[];for(let D=0;D<w.length-1;D++){const O=w[D].x,N=w[D].y,G=w[D+1].x,q=w[D+1].y,Y=o===0?O:N,se=o===0?G:q;Y<e?se>e&&h(T,O,N,G,q,e):Y>i?se<i&&h(T,O,N,G,q,i):T.push(w[D]),se<e&&Y>=e&&h(T,O,N,G,q,e),se>i&&Y<=i&&h(T,O,N,G,q,i)}let C=w[w.length-1];const P=o===0?C.x:C.y;P>=e&&P<=i&&T.push(C),T.length&&(C=T[T.length-1],T[0].x===C.x&&T[0].y===C.y||T.push(T[0]),y.push(T))}y.length&&a.push(y)}return a}function lE(n,e){const i=Ry(n),o=Ry([e]),a=Ix.intersection(i,o);return a==null?[]:Ax(a)}function cE(n,e){let o=Ry(n,65536);for(;e.valid();e.next()){const[a,h]=e.get(),d=a.x*65536,y=a.y*65536,w=h.x*65536,T=h.y*65536,C=w-d,P=T-y,D=Math.hypot(C,P),O=Math.trunc(P/D*3),N=-Math.trunc(C/D*3);o=Ix.diff(o,[[[d,y],[w,T],[w+O,T+N],[d+O,y+N],[d,y]]])}return Ax(o,1/65536)}function Ry(n,e=1){return[n.map((i=>i.map((o=>[o.x*e,o.y*e]))))]}function Ax(n,e=1){return n.map((i=>i.map(((o,a)=>{const h=o.map((d=>new gt(d[0]*e,d[1]*e).round()));return a>0&&h.reverse(),h}))))}class My{constructor(e,i){this.layoutVertexArray=new Mo,this.indexArray=new yr,this.lineIndexArray=new Tl,this.triangleSegments=new kr,this.lineSegments=new kr,this.programConfigurations=new oa(e.layers,{zoom:e.zoom,lut:e.lut}),this.uploaded=!1,i&&(this.elevatedLayoutVertexArray=new Lu)}update(e,i,o,a,h,d,y,w){this.programConfigurations.updatePaintArrays(e,i,h,o,a,d,y,w)}isEmpty(){return this.layoutVertexArray.length===0}needsUpload(){return this.programConfigurations.needsUpload}upload(e){this.uploaded||(this.layoutVertexBuffer=e.createVertexBuffer(this.layoutVertexArray,W3.members),this.indexBuffer=e.createIndexBuffer(this.indexArray),this.lineIndexBuffer=e.createIndexBuffer(this.lineIndexArray),this.elevatedLayoutVertexArray&&this.elevatedLayoutVertexArray.length>0&&(this.elevatedLayoutVertexBuffer=e.createVertexBuffer(this.elevatedLayoutVertexArray,Z3.members))),this.programConfigurations.upload(e),this.uploaded=!0}destroy(){this.layoutVertexBuffer&&(this.elevatedLayoutVertexBuffer&&this.elevatedLayoutVertexBuffer.destroy(),this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.lineIndexBuffer.destroy(),this.programConfigurations.destroy(),this.triangleSegments.destroy(),this.lineSegments.destroy())}populatePaintArrays(e,i,o,a,h,d,y){this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,e,i,o,a,h,d,void 0,y)}}class Dy{constructor(e){this.zoom=e.zoom,this.pixelRatio=e.pixelRatio,this.overscaling=e.overscaling,this.layers=e.layers,this.layerIds=this.layers.map((i=>i.fqid)),this.index=e.index,this.hasPattern=!1,this.patternFeatures=[],this.lut=e.lut,this.bufferData=new My(e,!1),this.elevationBufferData=new My(e,!0),this.stateDependentLayerIds=this.layers.filter((i=>i.isStateDependent())).map((i=>i.id)),this.projection=e.projection,this.elevationMode=this.layers[0].layout.get("fill-elevation-reference"),this.sourceLayerIndex=e.sourceLayerIndex,this.worldview=e.worldview}updateFootprints(e,i){}populate(e,i,o,a){this.hasPattern=Cy("fill",this.layers,this.pixelRatio,i);const h=this.layers[0].layout.get("fill-sort-key"),d=[];for(const{feature:y,id:w,index:T,sourceLayerIndex:C}of e){const P=this.layers[0]._featureFilter.needGeometry,D=Ze(y,P);if(!this.layers[0]._featureFilter.filter(new Wn(this.zoom,{worldview:this.worldview}),D,o))continue;const O=h?h.evaluate(D,{},o,i.availableImages):void 0,N={id:w,properties:y.properties,type:y.type,sourceLayerIndex:C,index:T,geometry:P?D.geometry:Te(y,o,a),patterns:{},sortKey:O};d.push(N)}h&&d.sort(((y,w)=>y.sortKey-w.sortKey));for(const y of d){const{geometry:w,index:T,sourceLayerIndex:C}=y;if(this.hasPattern){const P=Py("fill",this.layers,y,this.zoom,this.pixelRatio,i);this.patternFeatures.push(P)}else this.addFeature(y,w,T,o,{},i.availableImages,i.brightness,i.elevationFeatures);i.featureIndex.insert(e[T].feature,w,T,C,this.index)}}update(e,i,o,a,h,d,y){this.bufferData.update(e,i,o,a,h,d,y,this.worldview),this.elevationBufferData.update(e,i,o,a,h,d,y,this.worldview),this.elevatedStructures&&this.elevatedStructures.update(e,i,o,a,h,d,y,this.worldview)}addFeatures(e,i,o,a,h,d){for(const y of this.patternFeatures)this.addFeature(y,y.geometry,y.index,i,o,a,d,e.elevationFeatures)}isEmpty(){return this.bufferData.isEmpty()&&this.elevationBufferData.isEmpty()}uploadPending(){return!this.uploaded||this.bufferData.needsUpload()||this.elevationBufferData.needsUpload()}upload(e){this.bufferData.upload(e),this.elevationBufferData.upload(e),this.elevatedStructures&&this.elevatedStructures.upload(e)}destroy(){this.bufferData.destroy(),this.elevationBufferData.destroy(),this.elevatedStructures&&this.elevatedStructures.destroy()}addFeature(e,i,o,a,h,d=[],y,w){const T=Pm(i,500);this.elevationMode!=="none"?this.addElevatedRoadFeature(e,T,a,o,w):this.addGeometry(T,this.bufferData),this.bufferData.populatePaintArrays(e,o,h,d,a,y,this.worldview),this.elevationBufferData.populatePaintArrays(e,o,h,d,a,y,this.worldview)}getUnevaluatedPortalGraph(){return this.elevatedStructures?this.elevatedStructures.unevaluatedPortals:void 0}getElevationPolygons(){return this.elevatedStructures?this.elevatedStructures.portalPolygons:void 0}setEvaluatedPortalGraph(e,i,o,a,h){this.elevatedStructures&&(this.elevatedStructures.construct(e),this.elevatedStructures.populatePaintArrays(i,o,a,h,this.worldview))}addElevatedRoadFeature(e,i,o,a,h){const d=new Array,y=zr.getElevationFeature(e,h);if(!y)return void this.addGeometry(i,this.bufferData);{const T=this.clipPolygonsToTile(i,1);T.length>0&&d.push({polygons:T,elevationFeature:y,elevationTileID:o})}const w={guardRailEnabled:this.layers[0].layout.get("fill-construct-bridge-guard-rail").evaluate(e,{},o),featureIndex:a};for(const T of d)if(T.elevationFeature){if(this.elevationMode==="hd-road-base"){this.elevatedStructures||(this.elevatedStructures=new Cl(T.elevationTileID,this.layers,this.zoom,this.lut));const P=T.elevationFeature.isTunnel();let D=0;e.properties.hasOwnProperty(si)&&(D=+e.properties[si]);for(const O of T.polygons)this.elevatedStructures.addPortalCandidates(T.elevationFeature.id,O,P,T.elevationFeature,D)}T.elevationFeature.constantHeight==null&&(T.polygons=this.prepareElevatedPolygons(T.polygons,T.elevationFeature,T.elevationTileID));const C=new Tn(o,T.elevationTileID);this.addElevatedGeometry(T.polygons,C,T.elevationFeature,this.elevationMode==="hd-road-base"?0:.05,a,w)}}addElevatedGeometry(e,i,o,a,h,d){const y={elevation:o,elevationSampler:i,bias:a,index:h,featureInfo:d},[w,T]=this.addGeometry(e,this.elevationBufferData,y);this.elevationBufferData.heightRange==null?this.elevationBufferData.heightRange={min:w,max:T}:(this.elevationBufferData.heightRange.min=Math.min(this.elevationBufferData.heightRange.min,w),this.elevationBufferData.heightRange.max=Math.max(this.elevationBufferData.heightRange.max,T))}addGeometry(e,i,o){let a=Number.POSITIVE_INFINITY,h=Number.NEGATIVE_INFINITY,d=null;o&&(d=o.elevationSampler.constantElevation(o.elevation,o.bias),d!=null&&(a=d,h=d));const y=(w,T,C)=>{if(o!=null)if(T.push(w),d!=null)i.elevatedLayoutVertexArray.emplaceBack(d),C.push(d);else{const P=o.elevationSampler.pointElevation(w,o.elevation,o.bias);i.elevatedLayoutVertexArray.emplaceBack(P),C.push(P),a=Math.min(a,P),h=Math.max(h,P)}};for(const w of e){let T=0;for(const re of w)T+=re.length;const C=i.triangleSegments.prepareSegment(T,i.layoutVertexArray,i.indexArray),P=C.vertexLength,D=[],O=[],N=[],G=[],q=[],Y=i.layoutVertexArray.length;for(const re of w){if(re.length===0)continue;re!==w[0]&&O.push(D.length/2);const ae=i.lineSegments.prepareSegment(re.length,i.layoutVertexArray,i.lineIndexArray),Ee=ae.vertexLength;o&&q.push(i.layoutVertexArray.length-Y),y(re[0],N,G),i.layoutVertexArray.emplaceBack(re[0].x,re[0].y),i.lineIndexArray.emplaceBack(Ee+re.length-1,Ee),D.push(re[0].x),D.push(re[0].y);for(let ve=1;ve<re.length;ve++)y(re[ve],N,G),i.layoutVertexArray.emplaceBack(re[ve].x,re[ve].y),i.lineIndexArray.emplaceBack(Ee+ve-1,Ee+ve),D.push(re[ve].x),D.push(re[ve].y);ae.vertexLength+=re.length,ae.primitiveLength+=re.length}const se=Bp(D,O);for(let re=0;re<se.length;re+=3)i.indexArray.emplaceBack(P+se[re],P+se[re+1],P+se[re+2]);if(se.length>0&&o&&this.elevationMode==="hd-road-base"){const re=o.elevation.isTunnel(),ae=o.elevation.safeArea,Ee=this.elevatedStructures.addVertices(N,G);this.elevatedStructures.addTriangles(se,Ee,re);const ve=q.length;if(ve>0){for(let xe=0;xe<ve-1;xe++)this.elevatedStructures.addRenderableRing(o.index,q[xe]+Ee,q[xe+1]-q[xe],re,ae,o.featureInfo);this.elevatedStructures.addRenderableRing(o.index,q[ve-1]+Ee,N.length-q[ve-1],re,ae,o.featureInfo)}}C.vertexLength+=T,C.primitiveLength+=se.length/3}return[a,h]}prepareElevatedPolygons(e,i,o){const a=1/_e(o),h=[];for(const d of e){const y=cE(d,new Qn(i,a));h.push(...y)}return h}clipPolygonsToTile(e,i){const o=-i,a=-i,h=zt+i,d=zt+i;let y=0;const w=[],T=[];for(;y<e.length;y++){const D=e[y],O=Df(D);(O.min.x>=o&&O.max.x<=h&&O.min.y>=a&&O.max.y<=d?w:T).push(D)}if(w.length===e.length)return e;const C=[new gt(o,a),new gt(h,a),new gt(h,d),new gt(o,d),new gt(o,a)],P=w;for(const D of T)P.push(...lE(D,C));return P}}let Cx,Px,Rx,Mx;Kt(Dy,"FillBucket",{omit:["layers","patternFeatures"]}),Kt(My,"FillBufferData"),Kt(Cl,"ElevatedStructures");class $_{constructor(e,i,o,a){if(this.triangleCount=i.length/3,this.min=new gt(0,0),this.max=new gt(0,0),this.xScale=0,this.yScale=0,this.cellsX=0,this.cellsY=0,this.cells=[],this.payload=[],this.triangleCount===0||e.length===0)return;const[h,d]=[e[0].clone(),e[0].clone()];for(let P=1;P<e.length;++P){const D=e[P];h.x=Math.min(h.x,D.x),h.y=Math.min(h.y,D.y),d.x=Math.max(d.x,D.x),d.y=Math.max(d.y,D.y)}if(a){const P=Math.ceil(Math.max(d.x-h.x,d.y-h.y)/a);o=Math.max(o,P)}if(o===0)return;this.min=h,this.max=d;const y=this.max.sub(this.min);y.x=Math.max(y.x,1),y.y=Math.max(y.y,1);const w=Math.max(y.x,y.y)/o;this.cellsX=Math.max(1,Math.ceil(y.x/w)),this.cellsY=Math.max(1,Math.ceil(y.y/w)),this.xScale=1/w,this.yScale=1/w;const T=[];for(let P=0;P<this.triangleCount;P++){const D=e[i[3*P+0]].sub(this.min),O=e[i[3*P+1]].sub(this.min),N=e[i[3*P+2]].sub(this.min),G=vh(Math.floor(Math.min(D.x,O.x,N.x)),this.xScale,this.cellsX),q=vh(Math.floor(Math.max(D.x,O.x,N.x)),this.xScale,this.cellsX),Y=vh(Math.floor(Math.min(D.y,O.y,N.y)),this.yScale,this.cellsY),se=vh(Math.floor(Math.max(D.y,O.y,N.y)),this.yScale,this.cellsY),re=new gt(0,0),ae=new gt(0,0),Ee=new gt(0,0),ve=new gt(0,0);for(let xe=Y;xe<=se;++xe){re.y=ae.y=xe*w,Ee.y=ve.y=(xe+1)*w;for(let Pe=G;Pe<=q;++Pe)re.x=Ee.x=Pe*w,ae.x=ve.x=(Pe+1)*w,(ms(D,O,N,re,ae,ve)||ms(D,O,N,re,ve,Ee))&&T.push({cellIdx:xe*this.cellsX+Pe,triIdx:P})}}if(T.length===0)return;T.sort(((P,D)=>P.cellIdx-D.cellIdx||P.triIdx-D.triIdx));let C=0;for(;C<T.length;){const P=T[C].cellIdx,D={start:this.payload.length,len:0};for(;C<T.length&&T[C].cellIdx===P;)++D.len,this.payload.push(T[C++].triIdx);this.cells[P]=D}}_lazyInitLookup(){this.lookup||(this.lookup=new Uint8Array(Math.ceil(this.triangleCount/8))),this.lookup.fill(0)}queryPoint(e,i){if(this.triangleCount===0||this.cells.length===0||e.x>this.max.x||this.min.x>e.x||e.y>this.max.y||this.min.y>e.y)return;const o=vh(e.x-this.min.x,this.xScale,this.cellsX),a=vh(e.y-this.min.y,this.yScale,this.cellsY),h=this.cells[a*this.cellsX+o];if(h){this._lazyInitLookup();for(let d=0;d<h.len;d++){const y=this.payload[h.start+d],w=Math.floor(y/8),T=1<<y%8;if(!(this.lookup[w]&T)&&(this.lookup[w]|=T,i.push(y),i.length===this.triangleCount))return}}}query(e,i,o){if(this.triangleCount===0||this.cells.length===0||e.x>this.max.x||this.min.x>i.x||e.y>this.max.y||this.min.y>i.y)return;this._lazyInitLookup();const a=vh(e.x-this.min.x,this.xScale,this.cellsX),h=vh(i.x-this.min.x,this.xScale,this.cellsX),d=vh(e.y-this.min.y,this.yScale,this.cellsY),y=vh(i.y-this.min.y,this.yScale,this.cellsY);for(let w=d;w<=y;w++)for(let T=a;T<=h;T++){const C=this.cells[w*this.cellsX+T];if(C)for(let P=0;P<C.len;P++){const D=this.payload[C.start+P],O=Math.floor(D/8),N=1<<D%8;if(!(this.lookup[O]&N)&&(this.lookup[O]|=N,o.push(D),o.length===this.triangleCount))return}}}}function vh(n,e,i){return Math.max(0,Math.min(i-1,Math.floor(n*e)))}Kt($_,"TriangleGridIndex");class Dx{constructor(e){this.zoom=e.zoom,this.layers=e.layers,this.layerIds=this.layers.map((i=>i.fqid)),this.index=e.index,this.hasPattern=!1,this.stateDependentLayerIds=this.layers.filter((i=>i.isStateDependent())).map((i=>i.id)),this.footprints=[],this.worldview=e.worldview}updateFootprints(e,i){for(const o of this.footprints)i.push({footprint:o,id:e})}populate(e,i,o,a){const h=[];for(const{feature:d,id:y,index:w,sourceLayerIndex:T}of e){const C=this.layers[0]._featureFilter.needGeometry,P=Ze(d,C);if(!this.layers[0]._featureFilter.filter(new Wn(this.zoom,{worldview:this.worldview}),P,o))continue;const D={id:y,properties:d.properties,type:d.type,sourceLayerIndex:T,index:w,geometry:C?P.geometry:Te(d,o,a),patterns:{}};h.push(D)}for(const d of h){const{geometry:y,index:w,sourceLayerIndex:T}=d;this.addFeature(d,y,w,o,{},i.availableImages,i.brightness),i.featureIndex.insert(e[w].feature,y,w,T,this.index)}}isEmpty(){return this.footprints.length===0}uploadPending(){return!1}upload(e){}update(e,i,o,a,h,d,y){}destroy(){}addFeature(e,i,o,a,h,d=[],y){for(const w of Pm(i,2)){const T=[],C=[],P=[],D=new gt(1/0,1/0),O=new gt(-1/0,-1/0);for(const q of w)if(q.length!==0){q!==w[0]&&P.push(C.length/2);for(let Y=0;Y<q.length;Y++)C.push(q[Y].x),C.push(q[Y].y),T.push(q[Y]),D.x=Math.min(D.x,q[Y].x),D.y=Math.min(D.y,q[Y].y),O.x=Math.max(O.x,q[Y].x),O.y=Math.max(O.y,q[Y].y)}const N=Bp(C,P),G=new $_(T,N,8,256);this.footprints.push({vertices:T,indices:N,grid:G,min:D,max:O})}}}Kt(Dx,"ClipBucket",{omit:["layers"]});const uE=hn([{name:"a_pos_normal_ed",components:4,type:"Int16"}]),hE=hn([{name:"a_pos_end",components:4,type:"Int16"},{name:"a_angular_offset_factor",components:1,type:"Int16"}]),dE=hn([{name:"a_centroid_pos",components:2,type:"Uint16"}]),fE=hn([{name:"a_join_normal_inside",components:3,type:"Int16"}]),pE=hn([{name:"a_hidden_by_landmark",components:1,type:"Uint8"}]),mE=hn([{name:"a_pos_3",components:3,type:"Int16"},{name:"a_pos_normal_3",components:3,type:"Int16"}]),{members:_E}=uE,Rm=Number.MAX_SAFE_INTEGER,Lx=Rm-1;function kx(n,e,i,o){return n.order<e||n.order===Rm||!(n.clipMask&i)||(function(a,h){return h.length!==0&&h.find((d=>d===a))===void 0})(o,n.clipScope)}function W_(n,e){return n.x-e.x||n.y-e.y}function zx(n,e){return W_(n.min,e.min)===0&&W_(n.max,e.max)===0}function Ly(n,e){return!(n.min.x>e.max.x||n.max.x<e.min.x||n.min.y>e.max.y||n.max.y<e.min.y)}function Z_(n,e){if(n.length!==e.length)return!1;for(let i=0;i<n.length;i++)if(n[i].sourceId!==e[i].sourceId||!zx(n[i],e[i])||n[i].order!==e[i].order||n[i].clipMask!==e[i].clipMask||!Vo(n[i].clipScope,e[i].clipScope))return!1;return!0}function Fx(n,e,i){const o=1/zt,a=1/(1<<i.canonical.z),h=(e.x*o+i.canonical.x)*a+i.wrap,d=(e.y*o+i.canonical.y)*a;return{min:new gt((n.x*o+i.canonical.x)*a+i.wrap,(n.y*o+i.canonical.y)*a),max:new gt(h,d)}}function gE(n,e,i){const o=1<<i.canonical.z,a=((e.x-i.wrap)*o-i.canonical.x)*zt,h=(e.y*o-i.canonical.y)*zt;return{min:new gt(((n.x-i.wrap)*o-i.canonical.x)*zt,(n.y*o-i.canonical.y)*zt),max:new gt(a,h)}}function ky(n,e,i,o,a,h,d){const y=n.indices,w=n.vertices,T=[];for(let C=o;C<o+a;C+=3){const P=e[i[C+0]+h],D=e[i[C+1]+h],O=e[i[C+2]+h],N=Math.min(P.x,D.x,O.x),G=Math.max(P.x,D.x,O.x),q=Math.min(P.y,D.y,O.y),Y=Math.max(P.y,D.y,O.y);T.length=0,n.grid.query(new gt(N,q),new gt(G,Y),T);for(let se=0;se<T.length;se++){const re=T[se];if(ms(w[y[3*re+0]],w[y[3*re+1]],w[y[3*re+2]],P,D,O,d))return!0}}return!1}function Ox(n,e,i,o){if(!n||!i)return!1;let a=n.vertices;if(!e.canonical.equals(o.canonical)||e.wrap!==o.wrap){if(i.vertices.length<n.vertices.length)return Ox(i,o,n,e);const h=e.canonical,d=o.canonical,y=Math.pow(2,d.z-h.z);a=n.vertices.map((w=>new gt((w.x+h.x*zt)*y-d.x*zt,(w.y+h.y*zt)*y-d.y*zt)))}return ky(i,a,n.indices,0,n.indices.length,0,0)}function Bx(n,e,i,o){const a=Math.pow(2,o.z-i.z);return new gt((n+i.x*zt)*a-o.x*zt,(e+i.y*zt)*a-o.y*zt)}function zy(n,e){const i=[];e.grid.queryPoint(n,i);const o=e.indices,a=e.vertices;for(let h=0;h<i.length;h++){const d=i[h];if(mo([a[o[3*d+0]],a[o[3*d+1]],a[o[3*d+2]]],n))return!0}return!1}const Fy=[new gt(0,0),new gt(zt,0),new gt(zt,zt),new gt(0,zt)];function Nx(n,e){const i=[];let o=[];if(!e||n.length<2)return[n];if(n.length===2)return qr(n[0],n[1],Fy)?[n]:[];for(let a=0;a<n.length+2;a++){const h=n[a%n.length],d=n[(a+1)%n.length],y=qr(a===0?n[n.length-1]:n[(a-1)%n.length],h,Fy),w=qr(h,d,Fy),T=y||w;T&&o.push(h),T&&w||o.length>0&&(o.length>1&&i.push(o),o=[])}return o.length>1&&i.push(o),i}const Oy=Ue.types,yE=["fill-extrusion-base","fill-extrusion-height","fill-extrusion-color","fill-extrusion-pattern","fill-extrusion-flood-light-wall-radius","fill-extrusion-line-width","fill-extrusion-emissive-strength"],vE=["fill-extrusion-flood-light-ground-radius"],xE=Math.pow(2,13),wE=Math.pow(2,15)-1,Vx=new gt(0,1),mf=2147483648;function Mm(n,e,i,o,a,h,d,y){n.emplaceBack((e<<1)+d,(i<<1)+h,(Math.floor(o*xE)<<1)+a,Math.round(y))}function Dm(n,e,i){n.emplaceBack(e.x*zt,e.y*zt,i?1:0)}function X_(n,e,i,o,a,h){n.emplaceBack(e.x,e.y,(i.x<<1)+o,(i.y<<1)+a,h)}function Lm(n,e,i){n.emplaceBack(e.x,e.y,e.z,i[0]*16384,i[1]*16384,i[2]*16384)}class Ux{constructor(){this.vertexOffset=0,this.vertexCount=0,this.indexOffset=0,this.indexCount=0}}class jx{constructor(){this.centroidXY=new gt(0,0),this.vertexArrayOffset=0,this.vertexCount=0,this.groundVertexArrayOffset=0,this.groundVertexCount=0,this.flags=0,this.footprintSegIdx=-1,this.footprintSegLen=0,this.polygonSegIdx=-1,this.polygonSegLen=0,this.min=new gt(Number.MAX_VALUE,Number.MAX_VALUE),this.max=new gt(-Number.MAX_VALUE,-Number.MAX_VALUE),this.height=0,this.buildingId=0}span(){return new gt(this.max.x-this.min.x,this.max.y-this.min.y)}}class Gx{constructor(){this.acc=new gt(0,0),this.accCount=0,this.centroidDataIndex=0}startRing(e,i){e.min.x===Number.MAX_VALUE&&(e.min.x=e.max.x=i.x,e.min.y=e.max.y=i.y)}appendEdge(e,i,o){this.accCount++,this.acc._add(i);let a=!!this.borders;i.x<e.min.x?(e.min.x=i.x,a=!0):i.x>e.max.x&&(e.max.x=i.x,a=!0),i.y<e.min.y?(e.min.y=i.y,a=!0):i.y>e.max.y&&(e.max.y=i.y,a=!0),((i.x===0||i.x===zt)&&i.x===o.x)!=((i.y===0||i.y===zt)&&i.y===o.y)&&this.processBorderOverlap(i,o),a&&this.checkBorderIntersection(i,o)}checkBorderIntersection(e,i){i.x<0!=e.x<0&&this.addBorderIntersection(0,di(i.y,e.y,(0-i.x)/(e.x-i.x))),i.x>zt!=e.x>zt&&this.addBorderIntersection(1,di(i.y,e.y,(zt-i.x)/(e.x-i.x))),i.y<0!=e.y<0&&this.addBorderIntersection(2,di(i.x,e.x,(0-i.y)/(e.y-i.y))),i.y>zt!=e.y>zt&&this.addBorderIntersection(3,di(i.x,e.x,(zt-i.y)/(e.y-i.y)))}addBorderIntersection(e,i){this.borders||(this.borders=[[Number.MAX_VALUE,-Number.MAX_VALUE],[Number.MAX_VALUE,-Number.MAX_VALUE],[Number.MAX_VALUE,-Number.MAX_VALUE],[Number.MAX_VALUE,-Number.MAX_VALUE]]);const o=this.borders[e];i<o[0]&&(o[0]=i),i>o[1]&&(o[1]=i)}processBorderOverlap(e,i){if(e.x===i.x){if(e.y===i.y)return;const o=e.x===0?0:1;this.addBorderIntersection(o,i.y),this.addBorderIntersection(o,e.y)}else{const o=e.y===0?2:3;this.addBorderIntersection(o,i.x),this.addBorderIntersection(o,e.x)}}centroid(){return this.accCount===0?new gt(0,0):new gt(Math.floor(Math.max(0,this.acc.x)/this.accCount),Math.floor(Math.max(0,this.acc.y)/this.accCount))}intersectsCount(){return this.borders?this.borders.reduce(((e,i)=>e+ +(i[0]!==Number.MAX_VALUE)),0):0}}function Hx(n,e){const i=n.add(e)._unit(),o=de(n.x*i.x+n.y*i.y,-1,1);var a,h,d;return a=Math.acos(o),Math.min(4,Math.max(-4,Math.tan(a)))/4*wE*((h=n).x*(d=e).y-h.y*d.x<0?-1:1)}const bE=[n=>n.x<0,n=>n.x>zt,n=>n.y<0,n=>n.y>zt];function TE(n,e,i,o){const a=[4];if(o===0)return a;i._mult(o);const h=n.sub(i),d=e.sub(i),y=[n,e,h,d];for(let w=0;w<4;w++)for(const T of y)if(bE[w](T)){a.push(w);break}return a}class By{constructor(e){this.vertexArray=new rd,this.indexArray=new yr,this.programConfigurations=new oa(e.layers,{zoom:e.zoom,lut:e.lut},(i=>vE.includes(i))),this._segments=new kr,this.hiddenByLandmarkVertexArray=new ad,this._segmentToGroundQuads={},this._segmentToGroundQuads[0]=[],this._segmentToRegionTriCounts={},this._segmentToRegionTriCounts[0]=[0,0,0,0,0],this.regionSegments={},this.regionSegments[4]=new kr}getDefaultSegment(){return this.regionSegments[4]}hasData(){return this.vertexArray.length!==0}addData(e,i,o,a=!1){const h=e.length;if(h>2){let d=Math.max(0,this._segments.get().length-1);const y=this._segments._prepareSegment(4*h,this.vertexArray.length,2*this._segmentToGroundQuads[d].length);let w;d!==this._segments.get().length-1&&(d++,this._segmentToGroundQuads[d]=[],this._segmentToRegionTriCounts[d]=[0,0,0,0,0]);{const T=e[0],C=e[1];w=Hx(T.sub(e[h-1])._perp()._unit(),C.sub(T)._perp()._unit())}for(let T=0;T<h;T++){const C=T===h-1?0:T+1,P=e[T],D=e[C],O=e[C===h-1?0:C+1],N=D.sub(P)._perp()._unit(),G=Hx(N,O.sub(D)._perp()._unit()),q=w,Y=G;if(Ny(P,D,i)||a&&Wx(P,i)&&Wx(D,i)){w=G;continue}const se=y.vertexLength;X_(this.vertexArray,P,D,1,1,q),X_(this.vertexArray,P,D,1,0,q),X_(this.vertexArray,P,D,0,1,Y),X_(this.vertexArray,P,D,0,0,Y),y.vertexLength+=4;const re=TE(P,D,N,o);for(const ae of re)this._segmentToGroundQuads[d].push({id:se,region:ae}),this._segmentToRegionTriCounts[d][ae]+=2,y.primitiveLength+=2;w=G}}}prepareBorderSegments(){if(!this.hasData())return;const e=this._segments.get(),i=e.length;for(let o=0;o<i;o++)this._segmentToGroundQuads[o].sort(((a,h)=>a.region-h.region));for(let o=0;o<i;o++){const a=this._segmentToGroundQuads[o],h=e[o],d=this._segmentToRegionTriCounts[o];d.reduce(((w,T)=>w+T),0);let y=0;for(let w=0;w<=4;w++){const T=d[w];if(T!==0){let C=this.regionSegments[w];C||(C=this.regionSegments[w]=new kr);const P={vertexOffset:h.vertexOffset,primitiveOffset:h.primitiveOffset+y,vertexLength:h.vertexLength,primitiveLength:T};C.get().push(P)}y+=T}for(let w=0;w<a.length;w++){const T=a[w].id;this.indexArray.emplaceBack(T,T+1,T+3),this.indexArray.emplaceBack(T,T+3,T+2)}}this._segmentToGroundQuads=null,this._segmentToRegionTriCounts=null,this._segments.destroy(),this._segments=null}addPaintPropertiesData(e,i,o,a,h,d,y){this.hasData()&&this.programConfigurations.populatePaintArrays(this.vertexArray.length,e,i,o,a,h,d,void 0,y)}upload(e){this.hasData()&&(this.vertexBuffer=e.createVertexBuffer(this.vertexArray,hE.members),this.indexBuffer=e.createIndexBuffer(this.indexArray))}uploadPaintProperties(e){this.hasData()&&this.programConfigurations.upload(e)}update(e,i,o,a,h,d,y,w){this.hasData()&&this.programConfigurations.updatePaintArrays(e,i,o,a,h,d,y,w)}updateHiddenByLandmark(e){this.updateHiddenByLandmarkRange(e.groundVertexArrayOffset,e.groundVertexCount,!!(e.flags&mf))}updateHiddenByLandmarkRange(e,i,o){if(!this.hasData())return;const a=i+e;if(i!==0){for(let h=e;h<a;++h)this.hiddenByLandmarkVertexArray.emplace(h,o?1:0);this._needsHiddenByLandmarkUpdate=!0}}uploadHiddenByLandmark(e){this.hasData()&&this._needsHiddenByLandmarkUpdate&&(!this.hiddenByLandmarkVertexBuffer&&this.hiddenByLandmarkVertexArray.length>0?this.hiddenByLandmarkVertexBuffer=e.createVertexBuffer(this.hiddenByLandmarkVertexArray,pE.members,!0):this.hiddenByLandmarkVertexBuffer&&this.hiddenByLandmarkVertexBuffer.updateData(this.hiddenByLandmarkVertexArray),this._needsHiddenByLandmarkUpdate=!1)}destroy(){if(this.vertexBuffer){this.vertexBuffer.destroy(),this.indexBuffer.destroy(),this.hiddenByLandmarkVertexBuffer&&this.hiddenByLandmarkVertexBuffer.destroy(),this._segments&&this._segments.destroy(),this.programConfigurations.destroy();for(let e=0;e<=4;e++){const i=this.regionSegments[e];i&&i.destroy()}}}}class K_{constructor(e){this.zoom=e.zoom,this.canonical=e.canonical,this.overscaling=e.overscaling,this.layers=e.layers,this.pixelRatio=e.pixelRatio,this.layerIds=this.layers.map((i=>i.fqid)),this.index=e.index,this.hasPattern=!1,this.edgeRadius=0,this.projection=e.projection,this.activeReplacements=[],this.replacementUpdateTime=0,this.centroidData=[],this.footprintIndices=new yr,this.footprintVertices=new Mo,this.footprintSegments=[],this.layoutVertexArray=new Du,this.centroidVertexArray=new Rp,this.wallVertexArray=new sf,this.indexArray=new yr,this.programConfigurations=new oa(e.layers,{zoom:e.zoom,lut:e.lut},(i=>yE.includes(i))),this.segments=new kr,this.stateDependentLayerIds=this.layers.filter((i=>i.isStateDependent())).map((i=>i.id)),this.groundEffect=new By(e),this.maxHeight=0,this.partLookup={},this.triangleSubSegments=[],this.polygonSegments=[],this.worldview=e.worldview}updateFootprints(e,i){}populate(e,i,o,a){this.features=[],this.hasPattern=Cy("fill-extrusion",this.layers,this.pixelRatio,i),this.featuresOnBorder=[],this.borderFeatureIndices=[[],[],[],[]],this.borderDoneWithNeighborZ=[-1,-1,-1,-1],this.selfDEMTileTimestamp=Number.MAX_VALUE,this.borderDEMTileTimestamp=[Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE],this.tileToMeter=_e(o),this.edgeRadius=this.layers[0].layout.get("fill-extrusion-edge-radius")/this.tileToMeter,this.wallMode=this.layers[0].paint.get("fill-extrusion-line-width").constantOr(1)!==0;for(const{feature:h,id:d,index:y,sourceLayerIndex:w}of e){const T=this.layers[0]._featureFilter.needGeometry,C=Ze(h,T);if(!this.layers[0]._featureFilter.filter(new Wn(this.zoom,{worldview:this.worldview}),C,o))continue;const P={id:d,sourceLayerIndex:w,index:y,geometry:T?C.geometry:Te(h,o,a),properties:h.properties,type:h.type,patterns:{}},D=this.layoutVertexArray.length,O=Oy[P.type]==="Polygon";if(this.hasPattern)this.features.push({featureId:h.id,feature:Py("fill-extrusion",this.layers,P,this.zoom,this.pixelRatio,i)});else if(this.wallMode)for(const N of P.geometry)for(const G of Nx(N,O))this.addFeature(h.id,P,[G],y,o,{},i.availableImages,a,i.brightness);else this.addFeature(h.id,P,P.geometry,y,o,{},i.availableImages,a,i.brightness);i.featureIndex.insert(h,P.geometry,y,w,this.index,D)}this.sortBorders(),this.projection.name==="mercator"&&this.splitToSubtiles(),this.groundEffect.prepareBorderSegments(),this.polygonSegments.length=0}addFeatures(e,i,o,a,h,d){for(const{featureId:y,feature:w}of this.features){const T=Oy[w.type]==="Polygon",{geometry:C}=w;if(this.wallMode)for(const P of C)for(const D of Nx(P,T))this.addFeature(y,w,[D],w.index,i,o,a,h,d);else this.addFeature(y,w,C,w.index,i,o,a,h,d)}this.sortBorders(),this.projection.name==="mercator"&&this.splitToSubtiles()}update(e,i,o,a,h,d,y){this.programConfigurations.updatePaintArrays(e,i,h,o,a,d,y,this.worldview),this.groundEffect.update(e,i,h,o,a,d,y,this.worldview)}isEmpty(){return this.layoutVertexArray.length===0}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload||this.groundEffect.programConfigurations.needsUpload}upload(e){this.uploaded||(this.layoutVertexBuffer=e.createVertexBuffer(this.layoutVertexArray,_E),this.indexBuffer=e.createIndexBuffer(this.indexArray),this.wallVertexBuffer=e.createVertexBuffer(this.wallVertexArray,fE.members),this.layoutVertexExtArray&&(this.layoutVertexExtBuffer=e.createVertexBuffer(this.layoutVertexExtArray,mE.members,!0)),this.groundEffect.upload(e)),this.groundEffect.uploadPaintProperties(e),this.programConfigurations.upload(e),this.uploaded=!0}uploadCentroid(e){this.groundEffect.uploadHiddenByLandmark(e),this.needsCentroidUpdate&&(!this.centroidVertexBuffer&&this.centroidVertexArray.length>0?this.centroidVertexBuffer=e.createVertexBuffer(this.centroidVertexArray,dE.members,!0):this.centroidVertexBuffer&&this.centroidVertexBuffer.updateData(this.centroidVertexArray),this.needsCentroidUpdate=!1)}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.centroidVertexBuffer&&this.centroidVertexBuffer.destroy(),this.layoutVertexExtBuffer&&this.layoutVertexExtBuffer.destroy(),this.groundEffect.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy())}addFeature(e,i,o,a,h,d,y,w,T){const C=this.layers[0].paint.get("fill-extrusion-flood-light-ground-radius").evaluate(i,{})/this.tileToMeter,P=[new gt(0,0),new gt(zt,zt)],D=w.projection,O=D.name==="globe",N=this.wallMode||Oy[i.type]==="Polygon",G=new Gx;G.centroidDataIndex=this.centroidData.length;const q=new jx;q.buildingId=e,i.properties&&i.properties.hasOwnProperty("building_id")&&(q.buildingId=i.properties.building_id);const Y=this.layers[0].paint.get("fill-extrusion-base").evaluate(i,{},h)<=0,se=this.layers[0].paint.get("fill-extrusion-height").evaluate(i,{},h);let re;if(q.height=se,q.vertexArrayOffset=this.layoutVertexArray.length,q.groundVertexArrayOffset=this.groundEffect.vertexArray.length,O&&!this.layoutVertexExtArray&&(this.layoutVertexExtArray=new Zd),this.wallMode){if(O)return void tn("Non zero fill-extrusion-line-width is not yet supported on globe.");if(o.length!==1)return;re=(function(Fe){const ot=Fe[0].x===Fe[Fe.length-1].x&&Fe[0].y===Fe[Fe.length-1].y;(function(At){let ti=0;const Zt=At.length;for(let Bt=0;Bt<Zt;Bt++)ti+=(At[(Bt+1)%Zt].x-At[Bt].x)*(At[(Bt+1)%Zt].y+At[Bt].y);return ti>=0})(Fe)||(Fe=Fe.reverse());const ht={geometry:[],joinNormals:[],indices:[]},bt=[],Rt=[],et=[];let Tt=Fe.length;for(;Tt>=2&&Fe[Tt-1].equals(Fe[Tt-2]);)Tt--;if(Tt<(ot?3:2))return ht;let Ve,tt,Lt,Et,li,Yt=0;for(;Yt<Tt-1&&Fe[Yt].equals(Fe[Yt+1]);)Yt++;ot&&(Ve=Fe[Tt-2],li=Fe[Yt].sub(Ve)._unit()._perp());for(let At=Yt;At<Tt;At++){if(Lt=At===Tt-1?ot?Fe[Yt+1]:void 0:Fe[At+1],Lt&&Fe[At].equals(Lt))continue;li&&(Et=li),Ve&&(tt=Ve),Ve=Fe[At],li=Lt?Lt.sub(Ve)._unit()._perp():Et,Et=Et||li;let ti=Et.add(li);ti.x===0&&ti.y===0||ti._unit();const Zt=ti.x*li.x+ti.y*li.y,Bt=Zt!==0?1/Zt:1/0,Xt=Et.x*li.y-Et.y*li.x>0;let bi="miter";const Mi=2;bi==="miter"&&Bt>Mi&&(bi="bevel"),bi==="bevel"&&(Bt>100&&(bi="flipbevel"),Bt<Mi&&(bi="miter"));const Gi=(Bi,mn,Qi,Ar)=>{const ue=new gt(Bi.x,Bi.y),he=new gt(Bi.x,Bi.y);ue.x+=mn.x*Ar,ue.y+=mn.y*Ar,he.x-=mn.x*Math.max(Qi,1),he.y-=mn.y*Math.max(Qi,1),et.push(mn),bt.push(ue),Rt.push(he)};if(bi==="miter")ti._mult(Bt),Gi(Ve,ti,0,0);else if(bi==="flipbevel")ti=li.mult(-1),Gi(Ve,ti,0,0),Gi(Ve,ti.mult(-1),0,0);else{const Bi=-Math.sqrt(Bt*Bt-1),mn=Xt?Bi:0,Qi=Xt?0:Bi;tt&&Gi(Ve,Et,mn,Qi),Lt&&Gi(Ve,li,mn,Qi)}}ht.geometry=[...bt,...Rt.reverse(),bt[0]],ht.joinNormals=[...et,...et.reverse(),et[et.length-1]];const vt=ht.geometry.length-1;for(let At=0;At<vt/2;At++)if(At+1<vt/2){let ti=At,Zt=At+1,Bt=vt-1-At,Xt=vt-2-At;ti=ti===0?vt-1:ti-1,Zt=Zt===0?vt-1:Zt-1,Bt=Bt===0?vt-1:Bt-1,Xt=Xt===0?vt-1:Xt-1,ht.indices.push(Bt),ht.indices.push(Zt),ht.indices.push(ti),ht.indices.push(Bt),ht.indices.push(Xt),ht.indices.push(Zt)}return ht})(o[0]),o=[re.geometry]}const ae=(Fe,ot)=>Fe<(ot.length-1)/2||Fe===ot.length-1,Ee=this.wallMode?[o]:Pm(o,500);for(let Fe=Ee.length-1;Fe>=0;Fe--){const ot=Ee[Fe];(ot.length===0||(ve=ot[0]).every((Dt=>Dt.x<=0))||ve.every((Dt=>Dt.x>=zt))||ve.every((Dt=>Dt.y<=0))||ve.every((Dt=>Dt.y>=zt)))&&Ee.splice(Fe,1)}var ve;let xe;if(O)xe=Yx(Ee,P,h);else{xe=[];for(const Fe of Ee)xe.push({polygon:Fe,bounds:P})}const Pe=N?this.edgeRadius:0,Me=Pe>0&&this.zoom<17,it=(Fe,ot)=>{if(Fe.length===0)return!1;const Dt=Fe[Fe.length-1];return ot.x===Dt.x&&ot.y===Dt.y};for(const{polygon:Fe,bounds:ot}of xe){let Dt=0,ht=0;for(const Tt of Fe)N&&!Tt[0].equals(Tt[Tt.length-1])&&Tt.push(Tt[0]),ht+=N?Tt.length-1:Tt.length;const bt=this.segments.prepareSegment((N?5:4)*ht,this.layoutVertexArray,this.indexArray);q.footprintSegIdx<0&&(q.footprintSegIdx=this.footprintSegments.length),q.polygonSegIdx<0&&(q.polygonSegIdx=this.polygonSegments.length);const Rt={triangleArrayOffset:this.indexArray.length,triangleCount:0,triangleSegIdx:this.segments.segments.length-1},et=new Ux;if(et.vertexOffset=this.footprintVertices.length,et.indexOffset=3*this.footprintIndices.length,et.ringIndices=[],N){const Tt=[],Ve=[];Dt=bt.vertexLength;for(let Lt=0;Lt<Fe.length;Lt++){const Et=Fe[Lt];Et.length&&Lt!==0&&Ve.push(Tt.length/2);const li=[];let Yt,vt;Yt=Et[1].sub(Et[0])._perp()._unit(),et.ringIndices.push(Et.length-1);for(let At=1;At<Et.length;At++){const ti=Et[At],Zt=Et[At===Et.length-1?1:At+1],Bt=ti.clone();if(Pe){vt=Zt.sub(ti)._perp()._unit();const Xt=Yt.add(vt)._unit(),bi=Pe*Math.min(4,1/(Yt.x*Xt.x+Yt.y*Xt.y));Bt.x+=bi*Xt.x,Bt.y+=bi*Xt.y,Bt.x=Math.round(Bt.x),Bt.y=Math.round(Bt.y),Yt=vt}if(!Y||Pe!==0&&!Me||it(li,Bt)||li.push(Bt),Mm(this.layoutVertexArray,Bt.x,Bt.y,0,0,1,1,0),this.wallMode){const Xt=ae(At,Et);Dm(this.wallVertexArray,re.joinNormals[At],!Xt)}bt.vertexLength++,this.footprintVertices.emplaceBack(ti.x,ti.y),Tt.push(ti.x,ti.y),O&&Lm(this.layoutVertexExtArray,D.projectTilePoint(Bt.x,Bt.y,h),D.upVector(h,Bt.x,Bt.y))}Y&&(Pe===0||Me)&&(li.length!==0&&it(li,li[0])&&li.pop(),this.groundEffect.addData(li,ot,C))}const tt=this.wallMode?re.indices:Bp(Tt,Ve);for(let Lt=0;Lt<tt.length;Lt+=3)this.footprintIndices.emplaceBack(et.vertexOffset+tt[Lt+0],et.vertexOffset+tt[Lt+1],et.vertexOffset+tt[Lt+2]),this.indexArray.emplaceBack(Dt+tt[Lt],Dt+tt[Lt+2],Dt+tt[Lt+1]),bt.primitiveLength++;et.indexCount+=tt.length,et.vertexCount+=this.footprintVertices.length-et.vertexOffset}for(let Tt=0;Tt<Fe.length;Tt++){const Ve=Fe[Tt];G.startRing(q,Ve[0]);let tt=Ve.length>4&&Zx(Ve[Ve.length-2],Ve[0],Ve[1]),Lt=Pe?EE(Ve[Ve.length-2],Ve[0],Ve[1],Pe):0;const Et=[];let li,Yt,vt;Yt=Ve[1].sub(Ve[0])._perp()._unit();let At=!0;for(let ti=1,Zt=0;ti<Ve.length;ti++){let Bt=Ve[ti-1],Xt=Ve[ti];const bi=Ve[ti===Ve.length-1?1:ti+1];if(G.appendEdge(q,Xt,Bt),Ny(Xt,Bt,ot)){Pe&&(Yt=bi.sub(Xt)._perp()._unit(),At=!At);continue}const Mi=Xt.sub(Bt)._perp(),Gi=Mi.x/(Math.abs(Mi.x)+Math.abs(Mi.y)),Bi=Mi.y>0?1:0,mn=Bt.dist(Xt);if(Zt+mn>32768&&(Zt=0),Pe){vt=bi.sub(Xt)._perp()._unit();let he=$x(Bt,Xt,bi,qx(Yt,vt),Pe);isNaN(he)&&(he=0);const Ye=Xt.sub(Bt)._unit();Bt=Bt.add(Ye.mult(Lt))._round(),Xt=Xt.add(Ye.mult(-he))._round(),Lt=he,Yt=vt,Y&&this.zoom>=17&&(it(Et,Bt)||Et.push(Bt),it(Et,Xt)||Et.push(Xt))}const Qi=bt.vertexLength,Ar=Ve.length>4&&Zx(Bt,Xt,bi);let ue=Xx(Zt,tt,At);if(Mm(this.layoutVertexArray,Bt.x,Bt.y,Gi,Bi,0,0,ue),Mm(this.layoutVertexArray,Bt.x,Bt.y,Gi,Bi,0,1,ue),this.wallMode){const he=ae(ti-1,Ve),Ye=re.joinNormals[ti-1];Dm(this.wallVertexArray,Ye,he),Dm(this.wallVertexArray,Ye,he)}if(Zt+=mn,ue=Xx(Zt,Ar,!At),tt=Ar,Mm(this.layoutVertexArray,Xt.x,Xt.y,Gi,Bi,0,0,ue),Mm(this.layoutVertexArray,Xt.x,Xt.y,Gi,Bi,0,1,ue),this.wallMode){const he=ae(ti,Ve),Ye=re.joinNormals[ti];Dm(this.wallVertexArray,Ye,he),Dm(this.wallVertexArray,Ye,he)}if(bt.vertexLength+=4,this.indexArray.emplaceBack(Qi+0,Qi+1,Qi+2),this.indexArray.emplaceBack(Qi+1,Qi+3,Qi+2),bt.primitiveLength+=2,Pe){const he=Dt+(ti===1?Ve.length-2:ti-2),Ye=ti===1?Dt:he+1;if(this.indexArray.emplaceBack(Qi+1,he,Qi+3),this.indexArray.emplaceBack(he,Ye,Qi+3),bt.primitiveLength+=2,li===void 0&&(li=Qi),!Ny(bi,Ve[ti],ot)){const kt=ti===Ve.length-1?li:bt.vertexLength;this.indexArray.emplaceBack(Qi+2,Qi+3,kt),this.indexArray.emplaceBack(Qi+3,kt+1,kt),this.indexArray.emplaceBack(Qi+3,Ye,kt+1),bt.primitiveLength+=3}At=!At}if(O){const he=this.layoutVertexExtArray,Ye=D.projectTilePoint(Bt.x,Bt.y,h),kt=D.projectTilePoint(Xt.x,Xt.y,h),Ht=D.upVector(h,Bt.x,Bt.y),jt=D.upVector(h,Xt.x,Xt.y);Lm(he,Ye,Ht),Lm(he,Ye,Ht),Lm(he,kt,jt),Lm(he,kt,jt)}}N&&(Dt+=Ve.length-1),Y&&Pe&&this.zoom>=17&&(Et.length!==0&&it(Et,Et[0])&&Et.pop(),this.groundEffect.addData(Et,ot,C,Pe>0))}this.footprintSegments.push(et),Rt.triangleCount=this.indexArray.length-Rt.triangleArrayOffset,this.polygonSegments.push(Rt),++q.footprintSegLen,++q.polygonSegLen}if(q.vertexCount=this.layoutVertexArray.length-q.vertexArrayOffset,q.groundVertexCount=this.groundEffect.vertexArray.length-q.groundVertexArrayOffset,q.vertexCount!==0){if(q.centroidXY=G.borders?Vx:this.encodeCentroid(G,q),this.centroidData.push(q),G.borders){this.featuresOnBorder.push(G);const Fe=this.featuresOnBorder.length-1;for(let ot=0;ot<G.borders.length;ot++)G.borders[ot][0]!==Number.MAX_VALUE&&this.borderFeatureIndices[ot].push(Fe)}this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,i,a,d,y,h,T,void 0,this.worldview),this.groundEffect.addPaintPropertiesData(i,a,d,y,h,T,this.worldview),this.maxHeight=Math.max(this.maxHeight,se)}}sortBorders(){for(let e=0;e<this.borderFeatureIndices.length;e++)this.borderFeatureIndices[e].sort(((i,o)=>this.featuresOnBorder[i].borders[e][0]-this.featuresOnBorder[o].borders[e][0]))}splitToSubtiles(){const e=[];for(let y=0;y<this.centroidData.length;y++){const w=this.centroidData[y],T=+(w.min.y+w.max.y>zt),C=2*T+(+(w.min.x+w.max.x>zt)^T);for(let P=0;P<w.polygonSegLen;P++){const D=w.polygonSegIdx+P;e.push({centroidIdx:y,subtile:C,polygonSegmentIdx:D,triangleSegmentIdx:this.polygonSegments[D].triangleSegIdx})}}const i=new yr;e.sort(((y,w)=>y.triangleSegmentIdx===w.triangleSegmentIdx?y.subtile-w.subtile:y.triangleSegmentIdx-w.triangleSegmentIdx));let o=0,a=0,h=0;for(const y of e){if(y.triangleSegmentIdx!==o)break;h++}const d=e.length;for(;a!==e.length;){o=e[a].triangleSegmentIdx;let y=0,w=a,T=a;for(let C=w;C<h&&e[C].subtile===y;C++)T++;for(;w!==h;){const C=e[w];y=C.subtile;const P=this.centroidData[C.centroidIdx].min.clone(),D=this.centroidData[C.centroidIdx].max.clone(),O={vertexOffset:this.segments.segments[o].vertexOffset,primitiveOffset:i.length,vertexLength:this.segments.segments[o].vertexLength,primitiveLength:0,sortKey:void 0,vaos:{}};for(let N=w;N<T;N++){const G=e[N],q=this.polygonSegments[G.polygonSegmentIdx],Y=this.centroidData[G.centroidIdx].min,se=this.centroidData[G.centroidIdx].max,re=this.indexArray.uint16;for(let ae=q.triangleArrayOffset;ae<q.triangleArrayOffset+q.triangleCount;ae++)i.emplaceBack(re[3*ae],re[3*ae+1],re[3*ae+2]);O.primitiveLength+=q.triangleCount,P.x=Math.min(P.x,Y.x),P.y=Math.min(P.y,Y.y),D.x=Math.max(D.x,se.x),D.y=Math.max(D.y,se.y)}O.primitiveLength>0&&this.triangleSubSegments.push({segment:O,min:P,max:D}),w=T;for(let N=w;N<h&&e[N].subtile===e[w].subtile;N++)T++}a=h;for(let C=a;C<d&&e[C].triangleSegmentIdx===e[a].triangleSegmentIdx;C++)h++}i._trim(),this.indexArray=i}getVisibleSegments(e,i,o){const a=new kr;if(this.wallMode){for(const G of this.triangleSubSegments)a.segments.push(G.segment);return a}let h=0,d=0;const y=1<<e.canonical.z;if(i){const G=i.getMinMaxForTile(e);G&&(h=G.min,d=G.max)}d+=this.maxHeight;const w=e.toUnwrapped();let T;const C=[w.canonical.x/y+w.wrap,w.canonical.y/y],P=[(w.canonical.x+1)/y+w.wrap,(w.canonical.y+1)/y],D=(G,q,Y)=>[G[0]*(1-Y[0])+q[0]*Y[0],G[1]*(1-Y[1])+q[1]*Y[1]],O=[],N=[];for(const G of this.triangleSubSegments){O[0]=G.min.x/zt,O[1]=G.min.y/zt,N[0]=G.max.x/zt,N[1]=G.max.y/zt;const q=D(C,P,O),Y=D(C,P,N);if(new Si([q[0],q[1],h],[Y[0],Y[1],d]).intersectsPrecise(o)===0){T&&(a.segments.push(T),T=void 0);continue}const se=G.segment;T&&T.vertexOffset!==se.vertexOffset&&(a.segments.push(T),T=void 0),T?(T.vertexLength+=se.vertexLength,T.primitiveLength+=se.primitiveLength):T={vertexOffset:se.vertexOffset,primitiveLength:se.primitiveLength,vertexLength:se.vertexLength,primitiveOffset:se.primitiveOffset,sortKey:void 0,vaos:{}}}return T&&a.segments.push(T),a}encodeCentroid(e,i){const o=e.centroid(),a=i.span(),h=Math.min(7,Math.round(a.x*this.tileToMeter/10)),d=Math.min(7,Math.round(a.y*this.tileToMeter/10));return new gt(de(o.x,1,zt-1)<<3|h,de(o.y,1,zt-1)<<3|d)}encodeBorderCentroid(e){if(!e.borders)return new gt(0,0);const i=e.borders,o=Number.MAX_VALUE;if(i[0][0]!==o||i[1][0]!==o){const a=i[0][0]!==o?0:1;return new gt(6|(i[0][0]!==o?0:65528),(i[a][0]+i[a][1])/2<<3|6)}{const a=i[2][0]!==o?2:3;return new gt((i[a][0]+i[a][1])/2<<3|6,6|(i[2][0]!==o?0:65528))}}showCentroid(e){const i=this.centroidData[e.centroidDataIndex];i.flags&=2147483647,i.centroidXY.x=0,i.centroidXY.y=0,this.writeCentroidToBuffer(i)}writeCentroidToBuffer(e){this.groundEffect.updateHiddenByLandmark(e);const i=e.vertexArrayOffset,o=e.vertexCount+e.vertexArrayOffset,a=e.flags&mf?Vx:e.centroidXY,h=this.centroidVertexArray.geta_centroid_pos0(i);if(this.centroidVertexArray.geta_centroid_pos1(i)!==a.y||h!==a.x){for(let d=i;d<o;++d)this.centroidVertexArray.emplace(d,a.x,a.y);this.needsCentroidUpdate=!0}}createCentroidsBuffer(){this.centroidVertexArray.resize(this.layoutVertexArray.length),this.groundEffect.hiddenByLandmarkVertexArray.resize(this.groundEffect.vertexArray.length);for(const e of this.centroidData)this.writeCentroidToBuffer(e)}updateReplacement(e,i,o){if(i.updateTime===this.replacementUpdateTime)return;this.replacementUpdateTime=i.updateTime;const a=i.getReplacementRegionsForTile(e.toUnwrapped());if(Z_(this.activeReplacements,a))return;if(this.activeReplacements=a,this.centroidVertexArray.length===0)this.createCentroidsBuffer();else for(const d of this.centroidData)d.flags&=2147483647;const h=[];for(const d of this.activeReplacements){if(d.order<o)continue;const y=Math.max(1,Math.pow(2,d.footprintTileId.canonical.z-e.canonical.z));if(d.footprint.buildingId){const w=d.footprint.buildingId;for(const T of this.centroidData)T.buildingId===w&&(T.flags|=mf)}else for(const w of this.centroidData)if(!(w.flags&mf||d.min.x>w.max.x||w.min.x>d.max.x||d.min.y>w.max.y||w.min.y>d.max.y))for(let T=0;T<w.footprintSegLen;T++){const C=this.footprintSegments[w.footprintSegIdx+T];if(h.length=0,SE(this.footprintVertices,C.vertexOffset,C.vertexCount,d.footprintTileId.canonical,e.canonical,h),ky(d.footprint,h,this.footprintIndices.uint16,C.indexOffset,C.indexCount,-C.vertexOffset,-y)){w.flags|=mf;break}}}for(const d of this.centroidData)this.writeCentroidToBuffer(d);this.borderDoneWithNeighborZ=[-1,-1,-1,-1]}footprintContainsPoint(e,i,o){let a=!1;for(let h=0;h<o.footprintSegLen;h++){const d=this.footprintSegments[o.footprintSegIdx+h];let y=0;for(const w of d.ringIndices){for(let T=y,C=w+y-1;T<w+y;C=T++){const P=this.footprintVertices.int16[2*(T+d.vertexOffset)+0],D=this.footprintVertices.int16[2*(T+d.vertexOffset)+1],O=this.footprintVertices.int16[2*(C+d.vertexOffset)+1];D>i!=O>i&&e<(this.footprintVertices.int16[2*(C+d.vertexOffset)+0]-P)*(i-D)/(O-D)+P&&(a=!a)}y=w}}return a}getHeightAtTileCoord(e,i){let o=Number.NEGATIVE_INFINITY,a=!0;const h=4*(e+zt)*zt+(i+zt);if(this.partLookup.hasOwnProperty(h)){const d=this.partLookup[h];return d?{height:d.height,hidden:!!(d.flags&mf)}:void 0}for(const d of this.centroidData)e>d.max.x||d.min.x>e||i>d.max.y||d.min.y>i||d.height<=o||this.footprintContainsPoint(e,i,d)&&(o=d.height,this.partLookup[h]=d,a=!!(d.flags&mf));if(o!==Number.NEGATIVE_INFINITY)return{height:o,hidden:a};this.partLookup[h]=void 0}}function qx(n,e){const i=n.add(e)._unit();return n.x*i.x+n.y*i.y}function EE(n,e,i,o){const a=e.sub(n)._perp()._unit(),h=i.sub(e)._perp()._unit();return $x(n,e,i,qx(a,h),o)}function $x(n,e,i,o,a){const h=Math.sqrt(1-o*o);return Math.min(n.dist(e)/3,e.dist(i)/3,a*h/o)}function Ny(n,e,i){return n.x<i[0].x&&e.x<i[0].x||n.x>i[1].x&&e.x>i[1].x||n.y<i[0].y&&e.y<i[0].y||n.y>i[1].y&&e.y>i[1].y}function Wx(n,e){return n.x<e[0].x||n.x>e[1].x||n.y<e[0].y||n.y>e[1].y}function Zx(n,e,i){if(n.x<0||n.x>=zt||e.x<0||e.x>=zt||i.x<0||i.x>=zt)return!1;const o=i.sub(e),a=o.perp(),h=n.sub(e);return(o.x*h.x+o.y*h.y)/Math.sqrt((o.x*o.x+o.y*o.y)*(h.x*h.x+h.y*h.y))>-.866&&a.x*h.x+a.y*h.y<0}function Xx(n,e,i){const o=e?2|n:-3&n;return i?1|o:-2&o}function Kx(){const n=Math.PI/32,e=Math.tan(n),i=I;return i*Math.sqrt(1+2*e*e)-i}function Yx(n,e,i){const o=1<<i.z,a=te(i.x/o),h=te((i.x+1)/o),d=oe(i.y/o),y=oe((i.y+1)/o);return(function(w,T,C,P,D=0,O){const N=[];if(!w.length||!C||!P)return N;const G=(ve,xe)=>{for(const Pe of ve)N.push({polygon:Pe,bounds:xe})},q=Math.ceil(Math.log2(C)),Y=Math.ceil(Math.log2(P)),se=q-Y,re=[];for(let ve=0;ve<Math.abs(se);ve++)re.push(se>0?0:1);for(let ve=0;ve<Math.min(q,Y);ve++)re.push(0),re.push(1);let ae=w;if(ae=q_(ae,T[0].y-D,T[1].y+D,1),ae=q_(ae,T[0].x-D,T[1].x+D,0),!ae.length)return N;const Ee=[];for(re.length?Ee.push({polygons:ae,bounds:T,depth:0}):G(ae,T);Ee.length;){const ve=Ee.pop(),xe=ve.depth,Pe=re[xe],Me=ve.bounds[0],it=ve.bounds[1],Fe=Pe===0?Me.x:Me.y,ot=Pe===0?it.x:it.y,Dt=O?O(Pe,Fe,ot):.5*(Fe+ot),ht=q_(ve.polygons,Fe-D,Dt+D,Pe),bt=q_(ve.polygons,Dt-D,ot+D,Pe);if(ht.length){const Rt=[Me,new gt(Pe===0?Dt:it.x,Pe===1?Dt:it.y)];re.length>xe+1?Ee.push({polygons:ht,bounds:Rt,depth:xe+1}):G(ht,Rt)}if(bt.length){const Rt=[new gt(Pe===0?Dt:Me.x,Pe===1?Dt:Me.y),it];re.length>xe+1?Ee.push({polygons:bt,bounds:Rt,depth:xe+1}):G(bt,Rt)}}return N})(n,e,Math.ceil((h-a)/11.25),Math.ceil((d-y)/11.25),1,((w,T,C)=>{if(w===0)return .5*(T+C);{const P=oe((i.y+T/zt)/o);return(X(.5*(oe((i.y+C/zt)/o)+P))*o-i.y)*zt}}))}function SE(n,e,i,o,a,h){const d=Math.pow(2,o.z-a.z);for(let y=0;y<i;y++){let w=n.int16[2*(y+e)+0],T=n.int16[2*(y+e)+1];w=(w+a.x*zt)*d-o.x*zt,T=(T+a.y*zt)*d-o.y*zt,h.push(new gt(w,T))}}let Qx,Jx;Kt(K_,"FillExtrusionBucket",{omit:["layers","features"]}),Kt(jx,"PartData"),Kt(Ux,"FootprintSegment"),Kt(Gx,"BorderCentroidData"),Kt(By,"GroundEffect");class sp extends gt{constructor(e,i,o){super(e,i),this.z=o}}class e1 extends sp{constructor(e,i,o,a){super(e,i,o),this.w=a}}function t1(n,e,i,o){const a=i==="x"?"y":"x",h=(o-n[i])/(e[i]-n[i]);n[a]=Math.round(n[a]+(e[a]-n[a])*h),n[i]=o,n.hasOwnProperty("z")&&(n.z=di(n.z,e.z,h)),n.hasOwnProperty("w")&&(n.w=di(n.w,e.w,h))}function i1(n,e,i,o){const a=i,h=o;for(const d of["x","y"]){let y=n,w=e;y[d]>=w[d]&&(y=e,w=n),y[d]<a&&w[d]>a&&t1(y,w,d,a),y[d]<h&&w[d]>h&&t1(w,y,d,h)}}function Y_(n,e,i,o,a,h){const d=[];for(let y=0;y<n.length;y++){const w=n[y];let T;const C=d.length;let P=0;for(let D=0;D<w.length-1;D++){let O=w[D],N=w[D+1],G=0;const q=P;let Y,se;h&&(G=Math.hypot(N.x-O.x,N.y-O.y),P+=G,Y=O,se=N),O.x<e&&N.x<e||(O.x<e?O=new gt(e,O.y+(e-O.x)/(N.x-O.x)*(N.y-O.y))._round():N.x<e&&(N=new gt(e,O.y+(e-O.x)/(N.x-O.x)*(N.y-O.y))._round()),O.y<i&&N.y<i||(O.y<i?O=new gt(O.x+(i-O.y)/(N.y-O.y)*(N.x-O.x),i)._round():N.y<i&&(N=new gt(O.x+(i-O.y)/(N.y-O.y)*(N.x-O.x),i)._round()),O.x>=o&&N.x>=o||(O.x>=o?O=new gt(o,O.y+(o-O.x)/(N.x-O.x)*(N.y-O.y))._round():N.x>=o&&(N=new gt(o,O.y+(o-O.x)/(N.x-O.x)*(N.y-O.y))._round()),O.y>=a&&N.y>=a||(O.y>=a?O=new gt(O.x+(a-O.y)/(N.y-O.y)*(N.x-O.x),a)._round():N.y>=a&&(N=new gt(O.x+(a-O.y)/(N.y-O.y)*(N.x-O.x),a)._round()),T&&O.equals(T[T.length-1])||(T=[O],d.push(T),h&&h.push({progress:{min:q+n1(Y,se,O)*G,max:1},parentIndex:y,prevPoint:Y,nextPoint:se})),T.push(N),h&&(h[h.length-1].progress.max=q+n1(Y,se,N)*G,h[h.length-1].nextPoint=se)))))}if(h&&P>0)for(let D=C;D<d.length;D++)h[D].progress.min/=P,h[D].progress.max/=P}return d}function IE(n,e,i,o,a){if(n.length<2)return void o.push(n);const h=[];for(;e.valid();){const[T,C]=e.get();for(let P=0;P<n.length-1;P++){const D=n[P],O=n[P+1],N=qs(D,O,T,C);if(N){const[G]=N,q=new gt(di(D.x,O.x,G),di(D.y,O.y,G));h.push({t:P+G,distance:0,point:q})}}e.next()}if(h.length===0)return void o.push(n);h.sort(((T,C)=>T.t-C.t));let d=0,y=0,w=[];for(o.push(w);d!==n.length;){if(y===h.length){for(;d!==n.length;)w.length!==0&&w[w.length-1].equals(n[d])||w.push(n[d]),d++;break}h[y].t<=d?(w.length!==0&&w[w.length-1].equals(h[y].point)||w.push(h[y].point),Math.trunc(h[y].t),y++):(w.length!==0&&w[w.length-1].equals(n[d])||w.push(n[d]),d++)}}function n1(n,e,i){return n.x!==e.x?(i.x-n.x)/(e.x-n.x):n.y!==e.y?(i.y-n.y)/(e.y-n.y):0}function km(n,e){return n.x*e.x+n.y*e.y}function r1(n,e){if(n.length===1){let i=0;const o=e[i++];let a;for(;!a||o.equals(a);)if(a=e[i++],!a)return 1/0;for(;i<e.length;i++){const h=e[i],d=n[0],y=a.sub(o),w=h.sub(o),T=d.sub(o),C=km(y,y),P=km(y,w),D=km(w,w),O=km(T,y),N=km(T,w),G=C*D-P*P,q=(D*O-P*N)/G,Y=(C*N-P*O)/G,se=o.z*(1-q-Y)+a.z*q+h.z*Y;if(isFinite(se))return se}return 1/0}{let i=1/0;for(const o of e)i=Math.min(i,o.z);return i}}function s1(n,e,i,o,a,h,d,y){const w=d*a.getElevationAt(n,e,!0,!0),T=h[0]!==0,C=T?h[1]===0?d*(h[0]/7-450):d*(function(P,D,O){const N=Math.floor(D[0]/8),G=Math.floor(D[1]/8),q=10*(D[0]-8*N),Y=10*(D[1]-8*G),se=P.getElevationAt(N,G,!0,!0),re=P.getMeterToDEM(O),ae=Math.floor(.5*(q*re-1)),Ee=Math.floor(.5*(Y*re-1)),ve=P.tileCoordToPixel(N,G),xe=2*ae+1,Pe=2*Ee+1,Me=(function(bt,Rt,et,Tt,Ve){return[bt.getElevationAtPixel(Rt,et,!0),bt.getElevationAtPixel(Rt+Ve,et,!0),bt.getElevationAtPixel(Rt,et+Ve,!0),bt.getElevationAtPixel(Rt+Tt,et+Ve,!0)]})(P,ve.x-ae,ve.y-Ee,xe,Pe),it=Math.abs(Me[0]-Me[1]),Fe=Math.abs(Me[2]-Me[3]),ot=Math.abs(Me[0]-Me[2])+Math.abs(Me[1]-Me[3]),Dt=Math.min(.25,.5*re*(it+Fe)/xe),ht=Math.min(.25,.5*re*ot/Pe);return se+Math.max(Dt*q,ht*Y)})(a,h,y):w;return{base:w+(i===0?-1:i),top:T?Math.max(C+o,w+i+2):w+o}}class AE{constructor(e){this._callback=e,this._triggered=!1,typeof MessageChannel<"u"&&(this._channel=new MessageChannel,this._channel.port2.onmessage=()=>{this._triggered=!1,this._callback()})}trigger(){this._triggered||(this._triggered=!0,this._channel?this._channel.port1.postMessage(!0):setTimeout((()=>{this._triggered=!1,this._callback()}),0))}remove(){this._channel=void 0,this._callback=()=>{}}}class CE{constructor(){this.tasks={},this.taskQueue=[],yi(["process"],this),this.invoker=new AE(this.process),this.nextId=0}add(e,i){const o=this.nextId++,a=(function({type:h,isSymbolTile:d,zoom:y}){return y=y||0,h==="message"?0:h!=="maybePrepare"||d?h!=="parseTile"||d?h==="parseTile"&&d?300-y:h==="maybePrepare"&&d?400-y:500:200-y:100-y})(i);if(a===0){try{e()}finally{}return null}return this.tasks[o]={fn:e,metadata:i,priority:a,id:o},this.taskQueue.push(o),this.invoker.trigger(),{cancel:()=>{delete this.tasks[o]}}}process(){try{if(this.taskQueue=this.taskQueue.filter((o=>!!this.tasks[o])),!this.taskQueue.length)return;const e=this.pick();if(e===null)return;const i=this.tasks[e];if(delete this.tasks[e],this.taskQueue.length&&this.invoker.trigger(),!i)return;i.fn()}finally{}}pick(){let e=null,i=1/0;for(let a=0;a<this.taskQueue.length;a++){const h=this.tasks[this.taskQueue[a]];h.priority<i&&(i=h.priority,e=a)}if(e===null)return null;const o=this.taskQueue[e];return this.taskQueue.splice(e,1),o}remove(){this.invoker.remove()}}class o1{constructor(e,i,o){this.target=e,this.parent=i,this.mapId=o,this.callbacks={},this.cancelCallbacks={},yi(["receive"],this),this.target.addEventListener("message",this.receive,!1),this.scheduler=new CE}send(e,i,o,a,h=!1,d){const y=Math.round(1e18*Math.random()).toString(36).substring(0,10);o&&(o.metadata=d,this.callbacks[y]=o);const w=new Set;return this.target.postMessage({id:y,type:e,hasCallback:!!o,targetMapId:a,mustQueue:h,sourceMapId:this.mapId,data:gl(i,w)},w),{cancel:()=>{o&&delete this.callbacks[y],this.target.postMessage({id:y,type:"<cancel>",targetMapId:a,sourceMapId:this.mapId})}}}receive(e){const i=e.data;if(!i)return;const o=i.id;if(o&&(!i.targetMapId||this.mapId===i.targetMapId))if(i.type==="<cancel>"){const a=this.cancelCallbacks[o];delete this.cancelCallbacks[o],a&&a.cancel()}else if(i.mustQueue||jn(self)){const a=this.callbacks[o],h=this.scheduler.add((()=>this.processTask(o,i)),a&&a.metadata||{type:"message"});h&&(this.cancelCallbacks[o]=h)}else this.processTask(o,i)}processTask(e,i){if(delete this.cancelCallbacks[e],i.type==="<response>"){const o=this.callbacks[e];delete this.callbacks[e],o&&(i.error?o(Ro(i.error)):o(null,Ro(i.data)))}else{const o=new Set,a=i.hasCallback?(d,y)=>{this.target.postMessage({id:e,type:"<response>",sourceMapId:this.mapId,error:d?gl(d):null,data:gl(y,o)},o)}:()=>{},h=Ro(i.data);if(this.parent[i.type])this.parent[i.type](i.sourceMapId,h,a);else if(this.parent.getWorkerSource){const d=i.type.split("."),{source:y,scope:w}=h;this.parent.getWorkerSource(i.sourceMapId,d[0],y,w)[d[1]](h,a)}else a(new Error(`Could not find function ${i.type}`))}}remove(){this.scheduler.remove(),this.target.removeEventListener("message",this.receive,!1)}}var zm={workerUrl:"",workerClass:null,workerParams:void 0};const Vy="mapboxgl_preloaded_worker_pool";class op{constructor(){this.active={}}acquire(e,i=op.workerCount){if(!this.workers)for(this.workers=[];this.workers.length<i;)this.workers.push(zm.workerClass!=null?new zm.workerClass:new self.Worker(zm.workerUrl,zm.workerParams));return this.active[e]=!0,this.workers.slice()}release(e){delete this.active[e],this.workers&&this.numActive()===0&&(this.workers.forEach((i=>{i.terminate()})),this.workers=null)}isPreloaded(){return!!this.active[Vy]}numActive(){return Object.keys(this.active).length}}op.workerCount=2;class Vp{constructor(e,i,o="Worker",a=op.workerCount){this.workerPool=e,this.actors=[],this.currentActor=0,this.id=lt();const h=this.workerPool.acquire(this.id,a);for(let d=0;d<h.length;d++){const y=new Vp.Actor(h[d],i,this.id);y.name=`${o} ${d}`,this.actors.push(y)}this.ready=!1,this.broadcast("checkIfReady",null,(()=>{this.ready=!0}))}broadcast(e,i,o){Re(this.actors,((a,h)=>{a.send(e,i,h)}),o=o||function(){})}getActor(){return this.currentActor=(this.currentActor+1)%this.actors.length,this.actors[this.currentActor]}remove(){this.actors.forEach((e=>{e.remove()})),this.actors=[],this.workerPool.release(this.id)}}let Fm,Uy;function Q_(){return Fm||(Fm=new op),Fm}Vp.Actor=o1;class PE{constructor(e){this.module=e}createIntArray(e){const i=new Int32Array(e),o=this.module.malloc(i.length*i.BYTES_PER_ELEMENT);return this.module.heap32.set(i,o/i.BYTES_PER_ELEMENT),o}createFloatArray(e){const i=new Float32Array(e),o=this.module.malloc(i.length*i.BYTES_PER_ELEMENT);return this.module.heapF32.set(i,o/i.BYTES_PER_ELEMENT),o}createStringBuffer(e){const i=this.module.malloc(e.length+1);for(let o=0;o<e.length;++o)this.module.heapU8[i+o]=e.charCodeAt(o);return this.module.heapU8[i+e.length]=0,i}readStringBuffer(e){let i="";for(;this.module.heapU8[e]!==0;)i+=String.fromCharCode(this.module.heapU8[e]),++e;return i}setStyle(e){const i=e.entranceColorRgb,o=e.facadeGlazingColorRgb,a=e.roofColorRgb,h=e.wallColorRgb,d=e.normalScale;this.module.setStyle(i[0],i[1],i[2],o[0],o[1],o[2],a[0],a[1],a[2],h[0],h[1],h[2],d[0],d[1],d[2],e.tileToMeters)}setAOOptions(e,i){this.module.setAOOptions(e?1:0,i)}setMetricOptions(e,i){this.module.setMetricOptions(e?1:0,i)}setStructuralOptions(e){this.module.setStructuralOptions(e?1:0)}setFacadeOptions(e,i){this.module.setFacadeOptions(e,i?1:0)}setFauxFacadeOptions(e,i,o){this.module.setFauxFacadeOptions(e?1:0,i?1:0,o)}setFacadeClassifierOptions(e){this.module.setFacadeClassifierOptions(e)}generateMesh(e,i){for(const y of e){const w=this.createStringBuffer(y.roofType),T=[0],C=[];for(const O of y.coordinates)if(Array.isArray(O)){for(const N of O)C.push(N.x),C.push(N.y);T.push(C.length)}const P=this.createIntArray(T),D=this.createFloatArray(C);this.module.addFeature(y.id,y.sourceId,y.minHeight,y.height,w,y.roofType.length,D,P,T.length-1),this.module.free(w),this.module.free(P),this.module.free(D)}for(const y of i){let w;w=y.entrances?JSON.parse(y.entrances):[];const T=this.createFloatArray(w),C=[];for(const D of y.coordinates)C.push(D.x),C.push(D.y);const P=this.createFloatArray(C);this.module.addFacade(y.sourceId,y.crossPerc,y.distanceToRoad,T,w.length,P,C.length),this.module.free(T),this.module.free(P)}if(!this.module.generateMesh()){const y=this.module.getLastError();return this.readStringBuffer(y)}const o=this.module.getMeshCount(),a=new Array(o);for(let y=0;y<o;y++){const w=this.module.getPositionsPtr(y),T=this.module.getPositionsLength(y),C=new Float32Array(this.module.heapF32.buffer,w,T),P=this.module.getNormalsPtr(y),D=this.module.getNormalsLength(y),O=new Float32Array(this.module.heapF32.buffer,P,D),N=this.module.getColorsPtr(y),G=this.module.getColorsLength(y),q=new Uint8Array(this.module.heapU8.buffer,N,G),Y=this.module.getAOPtr(y),se=this.module.getAOLength(y),re=new Float32Array(this.module.heapF32.buffer,Y,se),ae=this.module.getUVPtr(y),Ee=this.module.getUVLength(y),ve=new Float32Array(this.module.heapF32.buffer,ae,Ee),xe=this.module.getFauxFacadePtr(y),Pe=this.module.getFauxFacadeLength(y),Me=new Uint8Array(this.module.heapU8.buffer,xe,Pe),it=this.module.getIndicesPtr(y),Fe=this.module.getIndicesLength(y),ot=new Int32Array(this.module.heap32.buffer,it,Fe),Dt=this.module.getBuildingPart(y),ht=this.readStringBuffer(Dt);a[y]={positions:C,normals:O,colors:q,ao:re,uv:ve,isFauxFacade:Me,indices:ot,buildingPart:ht}}const h=this.module.getRingCount(),d=[];for(let y=0;y<h;y++){const w=this.module.getRingPtr(y),T=this.module.getRingLength(y),C=new Float32Array(this.module.heapF32.buffer,w,T);d.push(C)}return{meshes:a,modifiedPolygonRings:d}}}let Om,jy,Bu,Up,Gy,jp=null,Gp=null,a1=null,J_=null;function l1(){return jn(self)&&self.worker.dracoUrl?self.worker.dracoUrl:jy||ws.DRACO_URL}function c1(){if(jn(self)&&self.worker.meshoptUrl)return self.worker.meshoptUrl;if(Up)return Up;const n=new Uint8Array([0,97,115,109,1,0,0,0,1,4,1,96,0,0,3,3,2,0,0,5,3,1,0,1,12,1,0,10,22,2,12,0,65,0,65,0,65,0,252,10,0,0,11,7,0,65,0,253,15,26,11]);if(typeof WebAssembly!="object")throw new Error("WebAssembly not supported, cannot instantiate meshoptimizer");return Up=WebAssembly.validate(n)?ws.MESHOPT_SIMD_URL:ws.MESHOPT_URL,Up}function RE(){return J_}const eg={5120:Int8Array,5121:Uint8Array,5122:Int16Array,5123:Uint16Array,5125:Uint32Array,5126:Float32Array},ME={5120:"DT_INT8",5121:"DT_UINT8",5122:"DT_INT16",5123:"DT_UINT16",5125:"DT_UINT32",5126:"DT_FLOAT32"},Bm={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16};function u1(n,e,i){const o=i.json.bufferViews.length,a=i.buffers.length;e.bufferView=o,i.json.bufferViews[o]={buffer:a,byteLength:n.byteLength},i.buffers[a]=n}const Hy="KHR_draco_mesh_compression";function DE(n,e){const i=n.extensions&&n.extensions[Hy];if(!i)return;const o=new Bu.Decoder,a=p1(e,i.bufferView),h=new Bu.Mesh;if(!o.DecodeArrayToMesh(a,a.byteLength,h))throw new Error("Failed to decode Draco mesh");const d=e.json.accessors[n.indices],y=eg[d.componentType],w=d.count*y.BYTES_PER_ELEMENT,T=Bu._malloc(w);y===Uint16Array?o.GetTrianglesUInt16Array(h,w,T):o.GetTrianglesUInt32Array(h,w,T),u1(Bu.memory.buffer.slice(T,T+w),d,e),Bu._free(T);for(const C of Object.keys(i.attributes)){const P=o.GetAttributeByUniqueId(h,i.attributes[C]),D=e.json.accessors[n.attributes[C]],O=ME[D.componentType],N=D.count*Bm[D.type]*eg[D.componentType].BYTES_PER_ELEMENT,G=Bu._malloc(N);o.GetAttributeDataArrayForAllPoints(h,P,Bu[O],N,G),u1(Bu.memory.buffer.slice(G,G+N),D,e),Bu._free(G)}o.destroy(),h.destroy(),delete n.extensions[Hy]}const tg="EXT_meshopt_compression";function LE(n,e){if(!n.extensions||!n.extensions[tg])return;const i=n.extensions[tg],o=new Uint8Array(e.buffers[i.buffer],i.byteOffset||0,i.byteLength||0),a=new Uint8Array(i.count*i.byteStride);Gy.decodeGltfBuffer(a,i.count,i.byteStride,o,i.mode,i.filter),n.buffer=e.buffers.length,n.byteOffset=0,e.buffers[n.buffer]=a.buffer,delete n.extensions[tg]}const h1=1179937895,d1=new TextDecoder("utf8");function f1(n,e){return new URL(n,e).href}function kE(n,e,i,o){return fetch(f1(n.uri,o)).then((a=>a.arrayBuffer())).then((a=>{e.buffers[i]=a}))}function p1(n,e){const i=n.json.bufferViews[e];return new Uint8Array(n.buffers[i.buffer],i.byteOffset||0,i.byteLength)}function zE(n,e,i,o){if(n.uri){const a=f1(n.uri,o);return fetch(a).then((h=>h.blob())).then((h=>createImageBitmap(h))).then((h=>{e.images[i]=h}))}if(n.bufferView!==void 0){const a=p1(e,n.bufferView),h=new Blob([a],{type:n.mimeType});return createImageBitmap(h).then((d=>{e.images[i]=d}))}}function m1(n,e=0,i){const o={json:null,images:[],buffers:[]};if(new Uint32Array(n,e,1)[0]===h1){const C=new Uint32Array(n,e);let P=2;const D=(C[P++]>>2)-3,O=C[P++]>>2;if(P++,o.json=JSON.parse(d1.decode(C.subarray(P,P+O))),P+=O,P<D){const N=C[P++];P++;const G=e+(P<<2);o.buffers[0]=n.slice(G,G+N)}}else o.json=JSON.parse(d1.decode(new Uint8Array(n,e)));const{buffers:a,images:h,meshes:d,extensionsUsed:y,bufferViews:w}=o.json;let T=Promise.resolve();if(a){const C=[];for(let P=0;P<a.length;P++){const D=a[P];D.uri?C.push(kE(D,o,P,i)):o.buffers[P]||(o.buffers[P]=null)}T=Promise.all(C)}return T.then((()=>{const C=[],P=y&&y.includes(Hy),D=y&&y.includes(tg);if(P&&C.push((function(){if(!Bu)return Om??(Om=(function(O){let N,G=null;function q(){N=new Uint8Array(G.buffer)}function Y(){throw new Error("Unexpected Draco error.")}const se={a:{a:Y,d:function(re,ae,Ee){return N.copyWithin(re,ae,ae+Ee)},c:function(re){const ae=N.length,Ee=Math.max(re>>>0,Math.ceil(1.2*ae)),ve=Math.ceil((Ee-ae)/65536);try{return G.grow(ve),q(),!0}catch{return!1}},b:Y}};return(WebAssembly.instantiateStreaming?WebAssembly.instantiateStreaming(O,se):O.then((re=>re.arrayBuffer())).then((re=>WebAssembly.instantiate(re,se)))).then((re=>{const{Rb:ae,Qb:Ee,P:ve,T:xe,X:Pe,Ja:Me,La:it,Qa:Fe,Va:ot,Wa:Dt,eb:ht,jb:bt,f:Rt,e:et,yb:Tt,zb:Ve,Ab:tt,Bb:Lt,Db:Et,Gb:li}=re.instance.exports;G=et;const Yt=(()=>{let vt=0,At=0,ti=0,Zt=0;return Bt=>{ti&&(ae(Zt),ae(vt),At+=ti,ti=vt=0),vt||(At+=128,vt=Ee(At));const Xt=Bt.length+7&-8;let bi=vt;Xt>=At&&(ti=Xt,bi=Zt=Ee(Xt));for(let Mi=0;Mi<Bt.length;Mi++)N[bi+Mi]=Bt[Mi];return bi}})();return q(),Rt(),{memory:et,_free:ae,_malloc:Ee,Mesh:class{constructor(){this.ptr=ve()}destroy(){xe(this.ptr)}},Decoder:class{constructor(){this.ptr=Me()}destroy(){bt(this.ptr)}DecodeArrayToMesh(vt,At,ti){const Zt=Yt(vt),Bt=it(this.ptr,Zt,At,ti.ptr);return!!Pe(Bt)}GetAttributeByUniqueId(vt,At){return{ptr:Fe(this.ptr,vt.ptr,At)}}GetTrianglesUInt16Array(vt,At,ti){ot(this.ptr,vt.ptr,At,ti)}GetTrianglesUInt32Array(vt,At,ti){Dt(this.ptr,vt.ptr,At,ti)}GetAttributeDataArrayForAllPoints(vt,At,ti,Zt,Bt){ht(this.ptr,vt.ptr,At.ptr,ti,Zt,Bt)}},DT_INT8:Tt(),DT_UINT8:Ve(),DT_INT16:tt(),DT_UINT16:Lt(),DT_UINT32:Et(),DT_FLOAT32:li()}}))})(fetch(l1())),Om.then((O=>{Bu=O,Om=void 0})))})()),D&&C.push((function(){if(Gy)return;const O=(function(N){let G;const q=WebAssembly.instantiateStreaming(N,{}).then((re=>{G=re.instance,G.exports.__wasm_call_ctors()})),Y={NONE:"",OCTAHEDRAL:"meshopt_decodeFilterOct",QUATERNION:"meshopt_decodeFilterQuat",EXPONENTIAL:"meshopt_decodeFilterExp"},se={ATTRIBUTES:"meshopt_decodeVertexBuffer",TRIANGLES:"meshopt_decodeIndexBuffer",INDICES:"meshopt_decodeIndexSequence"};return{ready:q,supported:!0,decodeGltfBuffer(re,ae,Ee,ve,xe,Pe){(function(Me,it,Fe,ot,Dt,ht,bt){const Rt=Me.exports.sbrk,et=ot+3&-4,Tt=Rt(et*Dt),Ve=Rt(ht.length),tt=new Uint8Array(Me.exports.memory.buffer);tt.set(ht,Ve);const Lt=it(Tt,ot,Dt,Ve,ht.length);if(Lt===0&&bt&&bt(Tt,et,Dt),Fe.set(tt.subarray(Tt,Tt+ot*Dt)),Rt(Tt-Rt(0)),Lt!==0)throw new Error(`Malformed buffer data: ${Lt}`)})(G,G.exports[se[xe]],re,ae,Ee,ve,G.exports[Y[Pe]])}}})(fetch(c1()));return O.ready.then((()=>{Gy=O}))})()),h)for(let O=0;O<h.length;O++)C.push(zE(h[O],o,O,i));return(C.length?Promise.all(C):Promise.resolve()).then((()=>{if(P&&d)for(const{primitives:O}of d)for(const N of O)DE(N,o);if(D&&d&&w)for(const O of w)LE(O,o);return o}))}))}function qy(n){switch(n){case WebGL2RenderingContext.RGBA8:return WebGL2RenderingContext.RGBA;case WebGL2RenderingContext.DEPTH_COMPONENT16:return WebGL2RenderingContext.DEPTH_COMPONENT;case WebGL2RenderingContext.DEPTH24_STENCIL8:return WebGL2RenderingContext.DEPTH_STENCIL;case WebGL2RenderingContext.R8:case WebGL2RenderingContext.R32F:return WebGL2RenderingContext.RED}}function $y(n){switch(n){case WebGL2RenderingContext.RGBA8:return WebGL2RenderingContext.UNSIGNED_BYTE;case WebGL2RenderingContext.DEPTH_COMPONENT16:return WebGL2RenderingContext.UNSIGNED_SHORT;case WebGL2RenderingContext.DEPTH24_STENCIL8:return WebGL2RenderingContext.UNSIGNED_INT_24_8;case WebGL2RenderingContext.R8:return WebGL2RenderingContext.UNSIGNED_BYTE;case WebGL2RenderingContext.R32F:return WebGL2RenderingContext.FLOAT}}class Wy{constructor(e,i,o,a){this.context=e,this.format=o,this.useMipmap=a&&a.useMipmap,this.texture=e.gl.createTexture(),this.update(i,{premultiply:a&&a.premultiply})}update(e,i){const o=e&&e instanceof HTMLVideoElement&&e.width===0?e.videoWidth:e.width,a=e&&e instanceof HTMLVideoElement&&e.height===0?e.videoHeight:e.height,{context:h}=this,{gl:d}=h,{x:y,y:w}=i&&i.position?i.position:{x:0,y:0},T=y+o,C=w+a;!this.size||this.size[0]===T&&this.size[1]===C||(d.bindTexture(d.TEXTURE_2D,null),d.deleteTexture(this.texture),this.texture=d.createTexture(),this.size=null),d.bindTexture(d.TEXTURE_2D,this.texture),h.pixelStoreUnpackFlipY.set(!1),h.pixelStoreUnpack.set(1),h.pixelStoreUnpackPremultiplyAlpha.set(this.format===d.RGBA8&&(!i||i.premultiply!==!1));const P=e instanceof HTMLImageElement||e instanceof HTMLCanvasElement||e instanceof HTMLVideoElement||e instanceof ImageData||ImageBitmap&&e instanceof ImageBitmap;if(!this.size&&T>0&&C>0){const D=this.useMipmap?Math.floor(Math.log2(Math.max(T,C)))+1:1;d.texStorage2D(d.TEXTURE_2D,D,this.format,T,C),this.size=[T,C]}if(this.size)if(P)d.texSubImage2D(d.TEXTURE_2D,0,y,w,qy(this.format),$y(this.format),e);else{const D=e.data;D&&d.texSubImage2D(d.TEXTURE_2D,0,y,w,o,a,qy(this.format),$y(this.format),D)}this.useMipmap&&d.generateMipmap(d.TEXTURE_2D)}bind(e,i,o=!1){const{context:a}=this,{gl:h}=a;h.bindTexture(h.TEXTURE_2D,this.texture),e!==this.minFilter&&(h.texParameteri(h.TEXTURE_2D,h.TEXTURE_MAG_FILTER,e),h.texParameteri(h.TEXTURE_2D,h.TEXTURE_MIN_FILTER,this.useMipmap&&!o?e===h.NEAREST?h.NEAREST_MIPMAP_NEAREST:h.LINEAR_MIPMAP_LINEAR:e),this.minFilter=e),i!==this.wrapS&&(h.texParameteri(h.TEXTURE_2D,h.TEXTURE_WRAP_S,i),h.texParameteri(h.TEXTURE_2D,h.TEXTURE_WRAP_T,i),this.wrapS=i)}bindExtraParam(e,i,o,a,h){const{context:d}=this,{gl:y}=d;y.bindTexture(y.TEXTURE_2D,this.texture),i!==this.magFilter&&(y.texParameteri(y.TEXTURE_2D,y.TEXTURE_MAG_FILTER,i),this.magFilter=i),e!==this.minFilter&&(y.texParameteri(y.TEXTURE_2D,y.TEXTURE_MIN_FILTER,this.useMipmap?e===y.NEAREST?y.NEAREST_MIPMAP_NEAREST:y.LINEAR_MIPMAP_LINEAR:e),this.minFilter=e),o!==this.wrapS&&(y.texParameteri(y.TEXTURE_2D,y.TEXTURE_WRAP_S,o),this.wrapS=o),a!==this.wrapT&&(y.texParameteri(y.TEXTURE_2D,y.TEXTURE_WRAP_T,a),this.wrapT=a),h!==this.compareMode&&(h?(y.texParameteri(y.TEXTURE_2D,y.TEXTURE_COMPARE_MODE,y.COMPARE_REF_TO_TEXTURE),y.texParameteri(y.TEXTURE_2D,y.TEXTURE_COMPARE_FUNC,h)):y.texParameteri(y.TEXTURE_2D,y.TEXTURE_COMPARE_MODE,y.NONE),this.compareMode=h)}destroy(){const{gl:e}=this.context;e.deleteTexture(this.texture),this.texture=null}}class Nm{constructor(e,i){this.context=e,this.texture=i}bind(e,i){const{context:o}=this,{gl:a}=o;a.bindTexture(a.TEXTURE_2D,this.texture),e!==this.minFilter&&(a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MAG_FILTER,e),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_MIN_FILTER,e),this.minFilter=e),i!==this.wrapS&&(a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_S,i),a.texParameteri(a.TEXTURE_2D,a.TEXTURE_WRAP_T,i),this.wrapS=i)}}const FE=hn([{name:"a_pos_3f",components:3,type:"Float32"}]),OE=hn([{name:"a_color_3f",components:3,type:"Float32"}]),BE=hn([{name:"a_color_4f",components:4,type:"Float32"}]),NE=hn([{name:"a_uv_2f",components:2,type:"Float32"}]),VE=hn([{name:"a_normal_3f",components:3,type:"Float32"}]),UE=hn([{name:"a_normal_matrix0",components:4,type:"Float32"},{name:"a_normal_matrix1",components:4,type:"Float32"},{name:"a_normal_matrix2",components:4,type:"Float32"},{name:"a_normal_matrix3",components:4,type:"Float32"}]),jE=hn([{name:"a_pbr",components:4,type:"Uint16"},{name:"a_heightBasedEmissiveStrength",components:3,type:"Float32"}]);function _1(n,e){const i=ig(n.projection,n.zoom,n.width,n.height),o=(function(h,d,y,w,T){const C=new L(y.lng-180*_f,y.lat),P=new L(y.lng+180*_f,y.lat),D=h.project(C.lng,C.lat),O=h.project(P.lng,P.lat),N=-Math.atan2(O.y-D.y,O.x-D.x),G=ge.fromLngLat(y);G.y=de(G.y,-1+_f,1-_f);const q=G.toLngLat(),Y=h.project(q.lng,q.lat),se=ge.fromLngLat(q);se.x+=_f;const re=se.toLngLat(),ae=h.project(re.lng,re.lat),Ee=y1(ae.x-Y.x,ae.y-Y.y,N),ve=ge.fromLngLat(q);ve.y+=_f;const xe=ve.toLngLat(),Pe=h.project(xe.lng,xe.lat),Me=y1(Pe.x-Y.x,Pe.y-Y.y,N),it=Math.abs(Ee.x)/Math.abs(Me.y),Fe=ct([]);_n(Fe,Fe,-N*(1-(T?0:w)));const ot=ct([]);return Ei(ot,ot,[1,1-(1-it)*w,1]),ot[4]=-Me.x/Me.y*w,_n(ot,ot,N),Nt(ot,Fe,ot),ot})(n.projection,0,n.center,i,e),a=g1(n);return Ei(o,o,[a,a,1]),o}function g1(n){const e=n.projection,i=ig(n.projection,n.zoom,n.width,n.height),o=Zy(e,n.center),a=Zy(e,L.convert(e.center));return Math.pow(2,o*i+(1-i)*a)}function ig(n,e,i,o,a=1/0){const h=n.range;if(!h)return 0;const d=Math.min(a,Math.max(i,o)),y=Math.log(d/1024)/Math.LN2;return Ae(h[0]+y,h[1]+y,e)}const _f=1/4e4;function Zy(n,e){const i=de(e.lat,-pe,pe),o=new L(e.lng-180*_f,i),a=new L(e.lng+180*_f,i),h=n.project(o.lng,i),d=n.project(a.lng,i),y=ge.fromLngLat(o),w=ge.fromLngLat(a),T=d.x-h.x,C=d.y-h.y,P=w.x-y.x,D=w.y-y.y,O=Math.sqrt((P*P+D*D)/(T*T+C*C));return Math.log(O)/Math.LN2}function y1(n,e,i){const o=Math.cos(i),a=Math.sin(i);return{x:n*o-e*a,y:n*a+e*o}}function v1(n,e,i){ct(n),_n(n,n,vn(e[2])),en(n,n,vn(e[0])),Hn(n,n,vn(e[1])),Ei(n,n,i),Nt(n,n,[1,0,0,0,0,0,1,0,0,1,0,0,0,0,0,1])}function ng(n,e,i,o,a,h,d,y){const w=[i[0]-e[0],i[1]-e[1],0],T=[o[0]-e[0],o[1]-e[1],0];if(Oe(w)<1e-12||Oe(T)<1e-12)return vs(n);const C=on([],w,T);zi(C,C),Gn(T,o,e),w[2]=(h-a)*y,T[2]=(d-a)*y;const P=w;return on(P,w,T),zi(P,P),pa(n,C,P)}function Xy(n,e,i=!1){const o=st(e.zoom),a=(function(h,d,y){const w=d.worldSize,T=[h[12],h[13],h[14]],C=oe(T[1]/w),P=te(T[0]/w),D=ct([]),O=Z(1,C)*w,N=Z(1,0)*w*we(C,d.zoom),G=1/Wi(w);let q=N*G;if(y){const ae=ig(d.projection,d.zoom,d.width,d.height,1024);q=G*d.projection.pixelSpaceConversion(d.center.lat,w,ae)}const Y=b(C,P);wn(Y,Y,Qe([],zi([],Y),O*q*T[2]));const se=(function(ae){const Ee=[ae[0],ae[1],ae[2]];let ve=[0,1,0];const xe=on([],ve,Ee);return on(ve,Ee,xe),Un(ve)===0&&(ve=[0,1,0],on(xe,Ee,ve)),zi(xe,xe),zi(ve,ve),zi(Ee,Ee),[xe[0],xe[1],xe[2],0,ve[0],ve[1],ve[2],0,Ee[0],Ee[1],Ee[2],0,ae[0],ae[1],ae[2],1]})(Y);Ei(D,D,[q,q,q*O]),Ti(D,D,[-T[0],-T[1],-T[2]]);const re=Nt([],d.globeMatrix,se);return Nt(re,re,D),Nt(re,re,h),re})(n,e,i);if(o>0){const h=(function(d,y){const w=y.worldSize,T=Z(1,0)*w*we(y.center.lat,y.zoom)/Wi(w),C=Z(1,y.center.lat)*w,P=ct([]);return Hn(P,P,vn(y.center.lng)),en(P,P,vn(y.center.lat)),Ti(P,P,[0,0,fo]),Ei(P,P,[T,T,T*C]),Ti(P,P,[y.point.x-.5*w,y.point.y-.5*w,0]),Nt(P,P,d),Nt(P,y.globeMatrix,P)})(n,e);return(function(d,y,w){const T=(N,G,q)=>{const Y=Oe(N),se=Oe(G),re=K(N,G,q);return Qe(re,re,1/Oe(re)*di(Y,se,q))},C=T([d[0],d[1],d[2]],[y[0],y[1],y[2]],w),P=T([d[4],d[5],d[6]],[y[4],y[5],y[6]],w),D=T([d[8],d[9],d[10]],[y[8],y[9],y[10]],w),O=K([d[12],d[13],d[14]],[y[12],y[13],y[14]],w);return[C[0],C[1],C[2],0,P[0],P[1],P[2],0,D[0],D[1],D[2],0,O[0],O[1],O[2],1]})(a,h,o)}return a}function x1(n,e,i,o){const a=Si.projectAabbCorners(o,i);let h=Number.MAX_VALUE,d=-1;for(let T=0;T<a.length;++T){const C=a[T];C[0]=(.5*C[0]+.5)*e.width,C[1]=(.5-.5*C[1])*e.height,C[2]<h&&(d=T,h=C[2])}const y=T=>new gt(a[T][0],a[T][1]);let w;switch(d){case 0:case 6:w=[y(1),y(5),y(4),y(7),y(3),y(2),y(1)];break;case 1:case 7:w=[y(0),y(4),y(5),y(6),y(2),y(3),y(0)];break;case 3:case 5:w=[y(1),y(0),y(4),y(7),y(6),y(2),y(1)];break;default:w=[y(1),y(5),y(6),y(7),y(3),y(0),y(1)]}if(tr(n,w))return h}const ap=64,Hp={CoordinateSpaceTile:1,HasMapboxMeshFeatures:4,HasMeshoptCompression:8};function w1(n,e,i,o,a,h,d,y,w,T=!1){const C=i.zoom,P=i.project(o),D=we(o.lat,C),O=1/D;ct(n),Ti(n,n,[P.x+d[0]*O,P.y+d[1]*O,d[2]]);let N=1,G=1;const q=i.worldSize;if(T){if(i.projection.name==="mercator"){let ae=0;i.elevation&&(ae=i.elevation.getAtPointOrZero(new ge(P.x/q,P.y/q),0));const Ee=Rn([],[P.x,P.y,ae,1],i.projMatrix)[3]/i.cameraToCenterDistance;N=Ee,G=Ee*we(i.center.lat,C)}else if(i.projection.name==="globe"){const ae=Xy(n,i),Ee=[0,0,0,1];Rn(Ee,Ee,Nt([],i.projMatrix,ae));const ve=Ee[3]/i.cameraToCenterDistance,xe=st(C),Pe=i.projection.pixelsPerMeter(o.lat,q)*we(o.lat,C),Me=i.projection.pixelsPerMeter(i.center.lat,q)*we(i.center.lat,C);N=ve/di(Pe,ye(i.center.lat),xe),G=ve*D/Pe,N*=Me,G*=Me}}else N=O;Ei(n,n,[N,N,G]);const Y=[...n],se=e.orientation,re=[];if(v1(re,[se[0]+a[0],se[1]+a[1],se[2]+a[2]],h),Nt(n,Y,re),y&&i.elevation){let ae=0;const Ee=[];if(w&&i.elevation){ae=(function(xe,Pe,Me,it,Fe){const ot=Pe.elevation;if(!ot)return 0;const Dt=Si.projectAabbCorners(Me,it),ht=Z(1,Fe.lat)*Pe.worldSize,bt=(function(At,ti){const Zt=[0,0,1],Bt=[{corners:[0,1,3,2],dotProductWithUp:0},{corners:[1,5,2,6],dotProductWithUp:0},{corners:[0,4,1,5],dotProductWithUp:0},{corners:[2,6,3,7],dotProductWithUp:0},{corners:[4,7,5,6],dotProductWithUp:0},{corners:[0,3,4,7],dotProductWithUp:0}];for(const Xt of Bt){const bi=At[Xt.corners[0]],Mi=At[Xt.corners[1]],Gi=At[Xt.corners[2]],Bi=[Mi[0]-bi[0],Mi[1]-bi[1],ti*(Mi[2]-bi[2])],mn=on(Bi,Bi,[Gi[0]-bi[0],Gi[1]-bi[1],ti*(Gi[2]-bi[2])]);zi(mn,mn),Xt.dotProductWithUp=Ji(mn,Zt)}return Bt.sort(((Xt,bi)=>Xt.dotProductWithUp-bi.dotProductWithUp)),Bt[0].corners})(Dt,ht),Rt=Dt[bt[0]],et=Dt[bt[1]],Tt=Dt[bt[2]],Ve=Dt[bt[3]],tt=ot.getAtPointOrZero(new ge(Rt[0]/Pe.worldSize,Rt[1]/Pe.worldSize),0),Lt=ot.getAtPointOrZero(new ge(et[0]/Pe.worldSize,et[1]/Pe.worldSize),0),Et=ot.getAtPointOrZero(new ge(Tt[0]/Pe.worldSize,Tt[1]/Pe.worldSize),0),li=ot.getAtPointOrZero(new ge(Ve[0]/Pe.worldSize,Ve[1]/Pe.worldSize),0),Yt=(tt+li)/2,vt=(Lt+Et)/2;return Yt>vt?Lt<Et?ng(xe,et,Ve,Rt,Lt,li,tt,ht):ng(xe,Tt,Rt,Ve,Et,tt,li,ht):tt<li?ng(xe,Rt,et,Tt,tt,Lt,Et,ht):ng(xe,Ve,Tt,et,li,Et,Lt,ht),Math.max(Yt,vt)})(Ee,i,e.aabb,n,o);const ve=Nt([],je([],Ee),re);Nt(n,Y,ve)}else ae=i.elevation.getAtPointOrZero(new ge(P.x/q,P.y/q),0);ae!==0&&(n[14]+=ae)}}function Vm(n,e,i=!1){n.uploaded||(n.gfxTexture=new Wy(e,n.image,i?e.gl.R8:e.gl.RGBA8,{useMipmap:n.sampler.minFilter>=e.gl.NEAREST_MIPMAP_NEAREST}),n.uploaded=!0,n.image=null)}function GE(n,e,i){n.indexBuffer=e.createIndexBuffer(n.indexArray,!1,!0),n.vertexBuffer=e.createVertexBuffer(n.vertexArray,FE.members,!1,!0),n.normalArray&&(n.normalBuffer=e.createVertexBuffer(n.normalArray,VE.members,!1,!0)),n.texcoordArray&&(n.texcoordBuffer=e.createVertexBuffer(n.texcoordArray,NE.members,!1,!0)),n.colorArray&&(n.colorBuffer=e.createVertexBuffer(n.colorArray,(n.colorArray.bytesPerElement===12?OE:BE).members,!1,!0)),n.featureArray&&(n.pbrBuffer=e.createVertexBuffer(n.featureArray,jE.members,!0)),n.segments=kr.simpleSegment(0,0,n.vertexArray.length,n.indexArray.length);const o=n.material;o.pbrMetallicRoughness.baseColorTexture&&Vm(o.pbrMetallicRoughness.baseColorTexture,e),o.pbrMetallicRoughness.metallicRoughnessTexture&&Vm(o.pbrMetallicRoughness.metallicRoughnessTexture,e),o.normalTexture&&Vm(o.normalTexture,e),o.occlusionTexture&&Vm(o.occlusionTexture,e,i),o.emissionTexture&&Vm(o.emissionTexture,e)}function Ky(n,e,i){if(n.meshes)for(const o of n.meshes)GE(o,e,i);if(n.children)for(const o of n.children)Ky(o,e,i)}function rg(n){if(n.meshes)for(const e of n.meshes)e.indexArray.destroy(),e.vertexArray.destroy(),e.colorArray&&e.colorArray.destroy(),e.normalArray&&e.normalArray.destroy(),e.texcoordArray&&e.texcoordArray.destroy(),e.featureArray&&e.featureArray.destroy();if(n.children)for(const e of n.children)rg(e)}function Yy(n){if(n.meshes)for(const i of n.meshes)i.vertexBuffer&&(i.vertexBuffer.destroy(),i.indexBuffer.destroy(),i.normalBuffer&&i.normalBuffer.destroy(),i.texcoordBuffer&&i.texcoordBuffer.destroy(),i.colorBuffer&&i.colorBuffer.destroy(),i.pbrBuffer&&i.pbrBuffer.destroy(),i.segments.destroy(),i.material&&((e=i.material).pbrMetallicRoughness.baseColorTexture&&e.pbrMetallicRoughness.baseColorTexture.gfxTexture&&e.pbrMetallicRoughness.baseColorTexture.gfxTexture.destroy(),e.pbrMetallicRoughness.metallicRoughnessTexture&&e.pbrMetallicRoughness.metallicRoughnessTexture.gfxTexture&&e.pbrMetallicRoughness.metallicRoughnessTexture.gfxTexture.destroy(),e.normalTexture&&e.normalTexture.gfxTexture&&e.normalTexture.gfxTexture.destroy(),e.emissionTexture&&e.emissionTexture.gfxTexture&&e.emissionTexture.gfxTexture.destroy(),e.occlusionTexture&&e.occlusionTexture.gfxTexture&&e.occlusionTexture.gfxTexture.destroy()));var e;if(n.children)for(const i of n.children)Yy(i)}function lp(n,e){const i=n.json.bufferViews[e.bufferView],o=eg[e.componentType];return new o(n.buffers[i.buffer],(e.byteOffset||0)+(i.byteOffset||0),e.count*(i.byteStride&&i.byteStride!==Bm[e.type]*o.BYTES_PER_ELEMENT?i.byteStride/o.BYTES_PER_ELEMENT:Bm[e.type]))}function Qy(n,e,i,o){const a=eg[e.componentType],h=(function(C){switch(C){case Int8Array:return 1/127;case Uint8Array:return 1/255;case Int16Array:return 1/32767;case Uint16Array:return 1/65535;default:return 1}})(a),d=n.json.bufferViews[e.bufferView],y=d.byteStride?d.byteStride/a.BYTES_PER_ELEMENT:Bm[e.type],w=i.float32,T=w.length/i.capacity;for(let C=0,P=0;C<e.count*y;C+=y,P+=T)for(let D=0;D<T;D++)w[P+D]=o[C+D]*h;i._trim()}function HE(n,e,i){const o=n.indices,a=n.attributes,h={};h.indexArray=new yr;const d=e.json.accessors[o],y=d.count/3;h.indexArray.reserve(y);const w=lp(e,d);for(let D=0;D<y;D++)h.indexArray.emplaceBack(w[3*D],w[3*D+1],w[3*D+2]);h.indexArray._trim(),h.vertexArray=new Do;const T=e.json.accessors[a.POSITION];h.vertexArray.reserve(T.count);const C=lp(e,T);for(let D=0;D<T.count;D++)h.vertexArray.emplaceBack(C[3*D],C[3*D+1],C[3*D+2]);if(h.vertexArray._trim(),h.aabb=new Si(T.min,T.max),h.centroid=(function(D,O){const N=[0,0,0],G=D.length;if(G>0){for(let q=0;q<G;q++){const Y=3*D[q];N[0]+=O[Y],N[1]+=O[Y+1],N[2]+=O[Y+2]}N[0]/=G,N[1]/=G,N[2]/=G}return N})(w,C),a.COLOR_0!==void 0){const D=e.json.accessors[a.COLOR_0],O=Bm[D.type],N=lp(e,D);h.colorArray=O===3?new Do:new bl,h.colorArray.resize(D.count),Qy(e,D,h.colorArray,N)}if(a.NORMAL!==void 0){h.normalArray=new Do;const D=e.json.accessors[a.NORMAL];h.normalArray.resize(D.count);const O=lp(e,D);Qy(e,D,h.normalArray,O)}if(a.TEXCOORD_0!==void 0&&i.length>0){h.texcoordArray=new zs;const D=e.json.accessors[a.TEXCOORD_0];h.texcoordArray.resize(D.count);const O=lp(e,D);Qy(e,D,h.texcoordArray,O)}if(a._FEATURE_ID_RGBA4444!==void 0){const D=e.json.accessors[a._FEATURE_ID_RGBA4444];e.json.extensionsUsed&&e.json.extensionsUsed.includes("EXT_meshopt_compression")&&(h.featureData=lp(e,D))}a._FEATURE_RGBA4444!==void 0&&(h.featureData=new Uint32Array(lp(e,e.json.accessors[a._FEATURE_RGBA4444]).buffer));const P=n.material;return h.material=(function(D,O){const{emissiveFactor:N=[0,0,0],alphaMode:G="OPAQUE",alphaCutoff:q=.5,normalTexture:Y,occlusionTexture:se,emissiveTexture:re,doubleSided:ae}=D,{baseColorFactor:Ee=[1,1,1,1],metallicFactor:ve=1,roughnessFactor:xe=1,baseColorTexture:Pe,metallicRoughnessTexture:Me}=D.pbrMetallicRoughness||{},it=se?O[se.index]:void 0;if(se&&se.extensions&&se.extensions.KHR_texture_transform&&it){const Fe=se.extensions.KHR_texture_transform;it.offsetScale=[Fe.offset[0],Fe.offset[1],Fe.scale[0],Fe.scale[1]]}return{pbrMetallicRoughness:{baseColorFactor:new un(...Ee),metallicFactor:ve,roughnessFactor:xe,baseColorTexture:Pe?O[Pe.index]:void 0,metallicRoughnessTexture:Me?O[Me.index]:void 0},doubleSided:ae,emissiveFactor:new un(...N),alphaMode:G,alphaCutoff:q,normalTexture:Y?O[Y.index]:void 0,occlusionTexture:it,emissionTexture:re?O[re.index]:void 0,defined:D.defined===void 0}})(P!==void 0?e.json.materials[P]:{defined:!1},i),h}function b1(n,e,i){const{matrix:o,rotation:a,translation:h,scale:d,mesh:y,extras:w,children:T}=n,C={};if(C.matrix=o||(function(P,D,O,N){var G=D[0],q=D[1],Y=D[2],se=D[3],re=G+G,ae=q+q,Ee=Y+Y,ve=G*re,xe=G*ae,Pe=G*Ee,Me=q*ae,it=q*Ee,Fe=Y*Ee,ot=se*re,Dt=se*ae,ht=se*Ee,bt=N[0],Rt=N[1],et=N[2];return P[0]=(1-(Me+Fe))*bt,P[1]=(xe+ht)*bt,P[2]=(Pe-Dt)*bt,P[3]=0,P[4]=(xe-ht)*Rt,P[5]=(1-(ve+Fe))*Rt,P[6]=(it+ot)*Rt,P[7]=0,P[8]=(Pe+Dt)*et,P[9]=(it-ot)*et,P[10]=(1-(ve+Me))*et,P[11]=0,P[12]=O[0],P[13]=O[1],P[14]=O[2],P[15]=1,P})([],a||[0,0,0,1],h||[0,0,0],d||[1,1,1]),y!==void 0){C.meshes=i[y];const P=C.anchor=[0,0];for(const D of C.meshes){const{min:O,max:N}=D.aabb;P[0]+=O[0]+N[0],P[1]+=O[1]+N[1]}P[0]=Math.floor(P[0]/C.meshes.length/2),P[1]=Math.floor(P[1]/C.meshes.length/2)}if(w&&(w.id&&(C.id=w.id),w.lights&&(C.lights=(function(P){if(!P.length)return[];const D=(function(Y){const se=atob(Y),re=new Uint8Array(se.length);for(let ae=0;ae<se.length;ae++)re[ae]=se.codePointAt(ae);return re})(P),O=[],N=D.length/24,G=new Uint16Array(D.buffer),q=new Float32Array(D.buffer);for(let Y=0;Y<N;Y++){const se=G[2*Y*6]/30,re=G[2*Y*6+1]/30,ae=G[2*Y*6+10]/100,Ee=q[6*Y+1],ve=q[6*Y+2],xe=q[6*Y+3],Pe=q[6*Y+4],Me=xe-Ee,it=Pe-ve,Fe=Math.hypot(Me,it);O.push({pos:[Ee+.5*Me,ve+.5*it,re],normal:[it/Fe,-Me/Fe,0],width:Fe,height:se,depth:ae,points:[Ee,ve,xe,Pe]})}return O})(w.lights))),T){const P=[];for(const D of T)P.push(b1(e.json.nodes[D],e,i));C.children=P}return C}function qE(n){if(n.vertices.length===0||n.indices.length===0)return null;const e=new $_(n.vertices,n.indices,8,256),[i,o]=[e.min.clone(),e.max.clone()];return{vertices:n.vertices,indices:n.indices,grid:e,min:i,max:o}}function $E(n){if(!n.extras||!n.extras.ground)return null;const e=n.extras.ground;if(!e||!Array.isArray(e)||e.length===0)return null;const i=e[0];if(!i||!Array.isArray(i)||i.length===0)return null;const o=[];for(const d of i){if(!Array.isArray(d)||d.length!==2)continue;const y=d[0],w=d[1];typeof y=="number"&&typeof w=="number"&&o.push(new gt(y,w))}if(o.length<3)return null;o.length>1&&o[o.length-1].equals(o[0])&&o.pop();let a=0;for(let d=0;d<o.length;d++){const y=o[d],w=o[(d+1)%o.length],T=o[(d+2)%o.length];a+=(y.x-w.x)*(T.y-w.y)-(T.x-w.x)*(y.y-w.y)}a>0&&o.reverse();const h=Bp(o.flatMap((d=>[d.x,d.y])),[]);return h.length===0?null:{vertices:o,indices:h}}function WE(n,e){const i=[],o=[];let a=0;const h=[];for(const d of n){a=i.length;const y=d.vertexArray.float32,w=d.indexArray.uint16;for(let T=0;T<d.vertexArray.length;T++)h[0]=y[3*T+0],h[1]=y[3*T+1],h[2]=y[3*T+2],Pn(h,h,e),i.push(new gt(h[0],h[1]));for(let T=0;T<3*d.indexArray.length;T++)o.push(w[T]+a)}if(o.length%3!=0)return null;for(let d=0;d<o.length;d+=3){const y=i[o[d+0]],w=i[o[d+1]],T=i[o[d+2]];(y.x-w.x)*(T.y-w.y)-(T.x-w.x)*(y.y-w.y)>0&&([o[d+1],o[d+2]]=[o[d+2],o[d+1]])}return{vertices:i,indices:o}}function T1(n){const e=(function(w,T){const C=[],P=WebGL2RenderingContext;if(w.json.textures)for(const D of w.json.textures){const O={magFilter:P.LINEAR,minFilter:P.NEAREST,wrapS:P.REPEAT,wrapT:P.REPEAT};D.sampler!==void 0&&Object.assign(O,w.json.samplers[D.sampler]),C.push({image:T[D.source],sampler:O,uploaded:!1})}return C})(n,n.images),i=(function(w,T){const C=[];for(const P of w.json.meshes){const D=[];for(const O of P.primitives)D.push(HE(O,w,T));C.push(D)}return C})(n,e),{scenes:o,scene:a,nodes:h}=n.json,d=o?o[a||0].nodes:h,y=[];for(const w of d)y.push(b1(h[w],n,i));return(function(w,T,C){const P={},D=new Set;for(let O=0;O<w.length;O++){const N=C[T[O]];if(!N.extras)continue;const G=N.extras["mapbox:footprint:version"],q=N.extras["mapbox:footprint:id"];(G||q)&&D.add(O),G==="1.0.0"&&q&&(P[q]=O)}for(let O=0;O<w.length;O++){if(D.has(O))continue;const N=w[O],G=C[T[O]];if(!G.extras)continue;let q=null;N.id in P&&(q=WE(w[P[N.id]].meshes,N.matrix)),q||(q=$E(G)),q&&(N.footprint=qE(q))}if(D.size>0){const O=Array.from(D.values()).sort(((N,G)=>N-G));for(let N=O.length-1;N>=0;N--)w.splice(O[N],1)}})(y,d,n.json.nodes),y}function ZE(n){n.heightmap=new Float32Array(4096),n.heightmap.fill(-1);const e=n.vertexArray.float32,i=n.aabb.min[0]-1,o=n.aabb.min[1]-1,a=ap/(n.aabb.max[0]-i+2),h=ap/(n.aabb.max[1]-o+2);for(let d=0;d<e.length;d+=3){const y=e[d+2],w=(e[d+0]-i)*a|0,T=(e[d+1]-o)*h|0;y>n.heightmap[T*ap+w]&&(n.heightmap[T*ap+w]=y)}}function E1(n,e,i,o,a){i.reserve(i.length+4*n.length),o.reserve(o.length+10*n.length),a.reserve(a.length+10*n.length);let h=o.length;for(const d of n){const y=Math.min(10,Math.max(4,1.3*d.height))*e,w=[-d.normal[1],d.normal[0],0],T=Math.min(.29,.1*d.width/d.depth),C=d.width-2*d.depth*e*(T+.01),P=Gt([],d.pos,w,C/2),D=Gt([],d.pos,w,-C/2),O=[P[0],P[1],P[2]+d.height],N=[D[0],D[1],D[2]+d.height],G=Gt([],d.normal,w,T);Qe(G,G,y);const q=Gt([],d.normal,w,-T);Qe(q,q,y),wn(G,P,G),wn(q,D,q),P[2]+=.1,D[2]+=.1,o.emplaceBack(G[0],G[1],G[2]),o.emplaceBack(q[0],q[1],q[2]),o.emplaceBack(P[0],P[1],P[2]),o.emplaceBack(D[0],D[1],D[2]),o.emplaceBack(O[0],O[1],O[2]),o.emplaceBack(N[0],N[1],N[2]),o.emplaceBack(P[0],P[1],P[2]),o.emplaceBack(D[0],D[1],D[2]),o.emplaceBack(G[0],G[1],G[2]),o.emplaceBack(q[0],q[1],q[2]);const Y=C/y/2;a.emplaceBack(-Y-T,-1,Y,.8),a.emplaceBack(Y+T,-1,Y,.8),a.emplaceBack(-Y,0,Y,1.3),a.emplaceBack(Y,0,Y,1.3),a.emplaceBack(Y+T,-.8,Y,.7),a.emplaceBack(Y+T,-.8,Y,.7),a.emplaceBack(0,0,Y,1.3),a.emplaceBack(0,0,Y,1.3),a.emplaceBack(Y+T,-1.2,Y,.8),a.emplaceBack(Y+T,-1.2,Y,.8),i.emplaceBack(6+h,4+h,8+h),i.emplaceBack(7+h,9+h,5+h),i.emplaceBack(0+h,1+h,2+h),i.emplaceBack(1+h,3+h,2+h),h+=10}}function XE(n,e){const i={};i.indexArray=new yr,i.vertexArray=new Do,i.colorArray=new bl,E1(n,e,i.indexArray,i.vertexArray,i.colorArray);const o={defined:!0};o.emissiveFactor=un.black;const a={};return a.baseColorFactor=un.white,o.pbrMetallicRoughness=a,i.material=o,i.aabb=new Si([1/0,1/0,1/0],[-1/0,-1/0,-1/0]),i}const S1=hn([{name:"a_pos_3f",components:3,type:"Float32"}]),KE=hn([{name:"a_normal_3",components:3,type:"Int16"}]),I1=hn([{name:"a_part_color_emissive",components:2,type:"Uint16"}]),YE=hn([{name:"a_bloom_attenuation",components:4,type:"Float32"}]),A1=Ue.types,Jy=32767;function QE(n,e){const i=zt+e;for(const o of n)for(const a of o)if(a.x<-e||a.x>i||a.y<-e||a.y>i)return!1;return!0}class C1{constructor(e){this.layoutAOArray=[],this.indexArrayForConflationUploaded=!1,this.maxHeight=0,this.replacementUpdateTime=0,this.activeReplacements=[],this.footprints=[],this.featuresOnBorder=[],this.buildingFeatures=[],this.footprintLookup={},this.zoom=e.zoom,this.canonical=e.canonical,this.layers=e.layers,this.layerIds=this.layers.map((i=>i.fqid)),this.index=e.index,this.hasPattern=!1,this.worldview=e.worldview,this.layoutVertexArray=new Do,this.layoutNormalArray=new ch,this.layoutColorArray=new Tl,this.indexArray=new yr,this.indexArrayForConflation=new yr,this.entranceBloom={layoutVertexArray:new Do,layoutVertexBuffer:null,layoutAttenuationArray:new bl,layoutAttenuationBuffer:null,layoutColorArray:new Tl,layoutColorBuffer:null,indexArray:new yr,indexArrayForConflation:new yr,indexBuffer:null,segmentsBucket:new kr},this.programConfigurations=new oa(e.layers,{zoom:e.zoom,lut:e.lut}),this.segmentsBucket=new kr,this.stateDependentLayerIds=this.layers.filter((i=>i.isStateDependent())).map((i=>i.id)),this.projection=e.projection,this.groundEffect=new By(e)}get segments(){return this.segmentsBucket}get bloomGeometry(){return this.entranceBloom}updateFootprints(e,i){for(const o of this.footprints)i.push({footprint:o,id:e})}prepare(){return(function(){if(J_!=null||a1!=null)return null;if(Gp!=null)return Gp;const e=fetch(ws.BUILDING_GEN_URL);return Gp=(function(i){let o,a,h,d;function y(){o=new Uint8Array(d.buffer),a=new Int32Array(d.buffer),h=new Float32Array(d.buffer)}function w(){throw new Error("Unexpected BuildingGen error.")}const T=()=>{},C={a:{a:w,f:function(P){const D=o.length,O=Math.max(P>>>0,Math.ceil(1.2*D)),N=Math.ceil((O-D)/65536);try{return d.grow(N),y(),!0}catch{return!1}},g:w,b:T,c:T,d:T,e:T}};return(WebAssembly.instantiateStreaming?WebAssembly.instantiateStreaming(i,C):i.then((P=>P.arrayBuffer())).then((P=>WebAssembly.instantiate(P,C)))).then((P=>{const D=P.instance.exports;return(0,D.g)(),d=D.f,y(),new PE({setStyle:D.h,setAOOptions:D.i,setMetricOptions:D.j,setStructuralOptions:D.k,setFacadeOptions:D.l,setFauxFacadeOptions:D.m,setFacadeClassifierOptions:D.n,addFeature:D.o,addFacade:D.p,generateMesh:D.q,getLastError:D.r,getMeshCount:D.s,getPositionsPtr:D.t,getPositionsLength:D.u,getNormalsPtr:D.v,getNormalsLength:D.w,getColorsPtr:D.x,getColorsLength:D.y,getAOPtr:D.z,getAOLength:D.A,getUVPtr:D.B,getUVLength:D.C,getFauxFacadePtr:D.D,getFauxFacadeLength:D.E,getIndicesPtr:D.F,getIndicesLength:D.G,getBuildingPart:D.H,getRingCount:D.I,getRingPtr:D.J,getRingLength:D.K,free:D.L,malloc:D.M,heapU8:o,heap32:a,heapF32:h})}))})(e).then((i=>(Gp=null,J_=i,J_))).catch((i=>{tn("Could not load building-gen"),Gp=null,a1=i})),Gp})()}populate(e,i,o,a){const h=RE();if(!h)return;const d=_e(o);this.tileToMeter=d,this.brightness=i.brightness,h.setStyle({convertToMeters:!1,entranceColorRgb:[1,1,1],facadeGlazingColorRgb:[.5607843137254902,.6745098039215687,.7215686274509804],normalScale:[1,-1,d],ridgeHeight:3,roofColorRgb:[.886274516,.784313738,.713725507],tileToMeters:d,tileZoom:16,wallColorRgb:[.988235294,.933333337,.811764717]}),h.setAOOptions(!1,.3),h.setMetricOptions(!1,16),h.setStructuralOptions(!0),h.setFacadeOptions(4,!0),h.setFauxFacadeOptions(!1,!1,1),h.setFacadeClassifierOptions(3);const y=new Map;for(const{feature:w}of e){if(A1[w.type]!=="LineString")continue;const T=this.layers[0]._featureFilter.needGeometry,C=Ze(w,T);if(!this.layers[0]._featureFilter.filter(new Wn(this.zoom),C,o))continue;const P=T?C.geometry:Te(w,o,a),D=[];for(const q of P)for(const Y of q)D.push({x:Y.x,y:Y.y});const O={coordinates:D,crossPerc:w.properties.cross_perc,distanceToRoad:w.properties.distance_to_road,entrances:w.properties.entrances,sourceId:0},N=w.properties.source_id;let G=y.get(N);G||(G=[],y.set(N,G)),G.push(O)}this.maxHeight=0;for(const{feature:w,index:T}of e){if(A1[w.type]==="LineString")continue;const C=this.layers[0]._featureFilter.needGeometry,P=Ze(w,C);if(!this.layers[0]._featureFilter.filter(new Wn(this.zoom),P,o))continue;const D=C?P.geometry:Te(w,o,a),O=Pm(D,500);if(!QE(D,163))continue;const N=this.layers[0],G=N.layout.get("building-base").evaluate(w,{},o),q=N.layout.get("building-height").evaluate(w,{},o),Y=N.layout.get("building-roof-shape").evaluate(w,{},o),se=N.paint.get("building-ambient-occlusion-intensity"),re=N.paint.get("building-ambient-occlusion-ground-radius")/this.tileToMeter;if(Y==="flat")continue;const ae=w.properties.source_id;let Ee;Ee=y.has(ae)?y.get(ae):[];const ve=[],xe=new gt(1/0,1/0),Pe=new gt(-1/0,-1/0);for(const vt of O)if(vt.length>0){const At=[];for(const ti of vt){const Zt=[];for(let Bt=ti.length-1;Bt>=0;Bt--){const Xt=ti[Bt];Zt.push({x:Xt.x,y:Xt.y}),xe.x=Math.min(xe.x,Xt.x),xe.y=Math.min(xe.y,Xt.y),Pe.x=Math.max(Pe.x,Xt.x),Pe.y=Math.max(Pe.y,Xt.y)}At.push(Zt)}ve.push({id:w.id,height:q,minHeight:G,sourceId:0,roofType:Y,coordinates:At})}const Me=h.generateMesh(ve,Ee);if(typeof Me=="string"||Me.meshes.length===0||Me.modifiedPolygonRings.length===0)continue;let it=0;for(const vt of Me.meshes)it+=vt.positions.length/3;const Fe=this.segmentsBucket.prepareSegment(it,this.layoutVertexArray,this.indexArray),ot=[];let Dt=null,ht=0,bt=-1;const Rt=this.indexArray.length;let et=0;for(const vt of Me.meshes){const At=this.layoutVertexArray.length;if(vt.buildingPart==="entrance"){const Zt=new Array;for(let Mi=0;Mi<vt.indices.length;Mi+=12){const Gi=vt.positions[Mi+0],Bi=vt.positions[Mi+1],mn=vt.positions[Mi+3],Qi=vt.positions[Mi+4],Ar=vt.positions[Mi+2],ue=vt.positions[Mi+8]-Ar,he=1,Ye=mn-Gi,kt=Qi-Bi,Ht=Math.hypot(Ye,kt);Zt.push({pos:[Gi+.5*Ye,Bi+.5*kt,Ar],normal:[kt/Ht,-Ye/Ht,0],width:Ht,height:ue,depth:he,points:[Gi,Bi,mn,Qi]})}const Bt=this.entranceBloom.segmentsBucket.prepareSegment(10*Zt.length,this.entranceBloom.layoutVertexArray,this.entranceBloom.indexArray),Xt=this.entranceBloom.layoutVertexArray.length;ht=this.entranceBloom.indexArray.length,E1(Zt,.5/this.tileToMeter,this.entranceBloom.indexArray,this.entranceBloom.layoutVertexArray,this.entranceBloom.layoutAttenuationArray);const bi=this.entranceBloom.layoutVertexArray.length-Xt;bt=this.entranceBloom.indexArray.length-ht;for(let Mi=0;Mi<bi;Mi++)this.entranceBloom.layoutColorArray.emplaceBack(65535,65535);Bt.vertexLength+=bi,Bt.primitiveLength+=bt,Dt={part:vt.buildingPart,vertexOffset:Xt,vertexLength:bi}}for(let Zt=0;Zt<vt.positions.length;Zt+=3)et=Math.max(et,vt.positions[Zt+2]),this.layoutVertexArray.emplaceBack(vt.positions[Zt],vt.positions[Zt+1],vt.positions[Zt+2]);for(let Zt=0;Zt<vt.normals.length;Zt+=3)this.layoutNormalArray.emplaceBack(vt.normals[Zt+0]*Jy,vt.normals[Zt+1]*Jy,vt.normals[Zt+2]*Jy);for(let Zt=0;Zt<vt.ao.length;Zt++)this.layoutAOArray.push(vt.ao[Zt]);for(let Zt=0;Zt<vt.colors.length;Zt+=3){const Bt=1+(vt.ao[Zt/3]-1)*se;this.layoutColorArray.emplaceBack(vt.colors[Zt]*Bt<<8|vt.colors[Zt+1]*Bt,vt.colors[Zt+2]*Bt<<8)}const ti=Fe.vertexLength;for(let Zt=0;Zt<vt.indices.length;Zt+=3)this.indexArray.emplaceBack(ti+vt.indices[Zt],ti+vt.indices[Zt+1],ti+vt.indices[Zt+2]);Fe.vertexLength+=vt.positions.length/3,Fe.primitiveLength+=vt.indices.length/3,(vt.buildingPart==="roof"||vt.buildingPart==="wall"||vt.buildingPart==="facade_glazing"||vt.buildingPart==="entrance")&&ot.push({part:vt.buildingPart,vertexOffset:At,vertexLength:vt.positions.length/3})}this.maxHeight=Math.max(this.maxHeight,et),this.buildingFeatures.push({feature:P,segment:Fe,parts:ot,buildingBloom:Dt});const Tt=this.indexArray.length-Rt,Ve=[],tt=[],Lt=new gt(1/0,1/0),Et=new gt(-1/0,-1/0),li=this.groundEffect.vertexArray.length;for(const vt of Me.modifiedPolygonRings){const At=[],ti=new gt(1/0,1/0),Zt=new gt(-1/0,-1/0);for(let Bt=0;Bt<vt.length;Bt+=2){const Xt=vt.length-Bt-2;ti.x=Math.min(ti.x,vt[Xt]),ti.y=Math.min(ti.y,vt[Xt+1]),Zt.x=Math.max(Zt.x,vt[Xt]),Zt.y=Math.max(Zt.y,vt[Xt+1]);const bi=new gt(vt[Xt],vt[Xt+1]);At.push(bi),Ve.push(bi.x,bi.y),tt.push(bi.clone())}Lt.x=Math.min(Lt.x,ti.x),Lt.y=Math.min(Lt.y,ti.y),Et.x=Math.max(Et.x,Zt.x),Et.y=Math.max(Et.y,Zt.y),this.groundEffect.addData(At,[ti,Zt],re)}const Yt=this.groundEffect.vertexArray.length-li;(xe.x<0||Pe.x>zt||xe.y<0||Pe.y>zt)&&this.featuresOnBorder.push({featureId:w.id,footprintIndex:this.footprints.length});{const vt=Bp(Ve,null,2),At=new $_(tt,vt,8,256);let ti=w.id;w.properties&&w.properties.hasOwnProperty("building_id")&&(ti=w.properties.building_id),this.footprints.push({vertices:tt,indices:vt,grid:At,min:Lt,max:Et,buildingId:ti,hiddenFlags:0,indicesOffset:Rt,indicesLength:Tt,bloomIndicesOffset:ht,bloomIndicesLength:bt,groundEffectVertexOffset:li,groundEffectVertexLength:Yt,segment:Fe,height:et})}this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,w,T,{},i.availableImages,o,i.brightness),this.groundEffect.addPaintPropertiesData(w,T,{},i.availableImages,o,i.brightness)}this.groundEffect.prepareBorderSegments(),this.evaluate(this.layers[0])}update(e,i,o,a,h,d,y){this.programConfigurations.updatePaintArrays(e,i,h,o,a,d,y),this.groundEffect.update(e,i,h,o,a,d,y)}isEmpty(){return this.layoutVertexArray.length===0}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload||this.groundEffect.programConfigurations.needsUpload}upload(e){this.uploaded||(this.layoutVertexBuffer=e.createVertexBuffer(this.layoutVertexArray,S1.members),this.layoutNormalBuffer=e.createVertexBuffer(this.layoutNormalArray,KE.members),this.entranceBloom.layoutVertexBuffer=e.createVertexBuffer(this.entranceBloom.layoutVertexArray,S1.members),this.entranceBloom.layoutAttenuationBuffer=e.createVertexBuffer(this.entranceBloom.layoutAttenuationArray,YE.members),this.uploadUpdatedColorBuffer(e),this.uploadUpdatedIndexBuffer(e),this.groundEffect.upload(e)),this.groundEffect.uploadPaintProperties(e),this.programConfigurations.upload(e),this.uploaded=!0}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.layoutNormalBuffer.destroy(),this.layoutColorBuffer.destroy(),this.groundEffect.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segmentsBucket.destroy(),this.entranceBloom.layoutVertexBuffer.destroy(),this.entranceBloom.layoutColorBuffer.destroy(),this.entranceBloom.layoutAttenuationBuffer.destroy(),this.entranceBloom.indexBuffer.destroy(),this.entranceBloom.segmentsBucket.destroy())}updateFootprintHiddenFlags(e,i,o=!0){let a=!1;const h=o?i:0,d=0|(o?-1:~i);this.groundEffect.hiddenByLandmarkVertexArray.length===0&&this.groundEffect.hiddenByLandmarkVertexArray.resize(this.groundEffect.vertexArray.length);for(const y of e){const w=this.footprints[y],T=w.hiddenFlags&d|h;w.hiddenFlags!==T&&(w.hiddenFlags=T,a=!0,this.groundEffect.updateHiddenByLandmarkRange(w.groundEffectVertexOffset,w.groundEffectVertexLength,w.hiddenFlags!==0))}return a&&(this.indexArrayForConflationUploaded=!1),a}uploadUpdatedIndexBuffer(e){if(this.groundEffect.uploadHiddenByLandmark(e),!this.indexArrayForConflationUploaded&&this.indexArray.length!==0){this.indexArrayForConflation.resize(this.indexArray.length),this.indexArrayForConflation.uint16.set(this.indexArray.uint16),this.entranceBloom.indexArrayForConflation.resize(this.entranceBloom.indexArray.length),this.entranceBloom.indexArrayForConflation.uint16.set(this.entranceBloom.indexArray.uint16);for(const i of this.footprints){const o=i.indicesOffset+i.indicesLength;if(i.hiddenFlags!==0){for(let h=i.indicesOffset;h<o;h++)this.indexArrayForConflation.uint16[3*h+0]=0,this.indexArrayForConflation.uint16[3*h+1]=0,this.indexArrayForConflation.uint16[3*h+2]=0;const a=i.bloomIndicesOffset+i.bloomIndicesLength;for(let h=i.bloomIndicesOffset;h<a;h++)this.entranceBloom.indexArrayForConflation.uint16[3*h+0]=0,this.entranceBloom.indexArrayForConflation.uint16[3*h+1]=0,this.entranceBloom.indexArrayForConflation.uint16[3*h+2]=0}}this.indexBuffer?this.indexBuffer.updateData(this.indexArrayForConflation):this.indexBuffer=e.createIndexBuffer(this.indexArrayForConflation,!0),this.entranceBloom.indexBuffer?this.entranceBloom.indexBuffer.updateData(this.entranceBloom.indexArrayForConflation):this.entranceBloom.indexBuffer=e.createIndexBuffer(this.entranceBloom.indexArrayForConflation,!0),this.indexArrayForConflationUploaded=!0}}uploadUpdatedColorBuffer(e){this.layoutColorBuffer?this.layoutColorBuffer.updateData(this.layoutColorArray):this.layoutColorBuffer=e.createVertexBuffer(this.layoutColorArray,I1.members,!0),this.entranceBloom.layoutColorBuffer?this.entranceBloom.layoutColorBuffer.updateData(this.entranceBloom.layoutColorArray):this.entranceBloom.layoutColorBuffer=e.createVertexBuffer(this.entranceBloom.layoutColorArray,I1.members,!0)}evaluate(e){const i=e.paint.get("building-ambient-occlusion-intensity");for(const o of this.buildingFeatures){const a=o.feature;a.properties["building-part"]="roof";const h=e.paint.get("building-color").evaluate(a,{},this.canonical),d=e.paint.get("building-emissive-strength").evaluate(a,{},this.canonical);a.properties["building-part"]="wall";const y=e.paint.get("building-color").evaluate(a,{},this.canonical),w=e.paint.get("building-emissive-strength").evaluate(a,{},this.canonical);a.properties["building-part"]="window";const T=e.paint.get("building-color").evaluate(a,{},this.canonical),C=e.paint.get("building-emissive-strength").evaluate(a,{},this.canonical);a.properties["building-part"]="door";const P=e.paint.get("building-color").evaluate(a,{},this.canonical),D=e.paint.get("building-emissive-strength").evaluate(a,{},this.canonical);for(const N of o.parts){let G,q=h;N.part==="roof"?(q=h,G=d):N.part==="wall"?(q=y,G=w):N.part==="facade_glazing"?(q=T,G=C):N.part==="entrance"&&(q=P,G=D),G=de(G,0,1);for(let Y=0;Y<N.vertexLength;Y++){const se=N.vertexOffset+Y,re=1+(this.layoutAOArray[se]-1)*i;this.layoutColorArray.emplace(se,q.r*re*255<<8|q.g*re*255,q.b*re*255<<8|255*G)}}const O=o.buildingBloom;if(O)for(let N=0;N<O.vertexLength;N++)this.bloomGeometry.layoutColorArray.emplace(O.vertexOffset+N,255*P.r<<8|255*P.g,255*P.b<<8|51*D)}}needsEvaluation(e,i){const o=e.transform.projectionOptions,a=e.style.getBrightness();return!(this.uploaded&&o.name===this.projection.name&&this.brightness===a||(this.projection=o,this.brightness=a,0))}updateReplacement(e,i,o){if(i.updateTime===this.replacementUpdateTime)return;this.replacementUpdateTime=i.updateTime;const a=i.getReplacementRegionsForTile(e.toUnwrapped());if(Z_(this.activeReplacements,a))return;this.activeReplacements=a;for(const d of this.footprints)d.hiddenFlags&=-2;const h=[];for(const d of this.activeReplacements){if(d.order<=Lx)continue;const y=Math.max(1,Math.pow(2,d.footprintTileId.canonical.z-e.canonical.z));for(const w of this.footprints)w.min.x>d.max.x||w.max.x<d.min.x||w.min.y>d.max.y||w.max.y<d.min.y||(h.length=0,JE(w.vertices,0,w.vertices.length,d.footprintTileId.canonical,e.canonical,h),ky(d.footprint,h,w.indices,0,w.indices.length,0,-y)&&(w.hiddenFlags|=1))}this.groundEffect.hiddenByLandmarkVertexArray.length===0&&this.groundEffect.hiddenByLandmarkVertexArray.resize(this.groundEffect.vertexArray.length);for(const d of this.footprints)this.groundEffect.updateHiddenByLandmarkRange(d.groundEffectVertexOffset,d.groundEffectVertexLength,d.hiddenFlags!==0);this.indexArrayForConflationUploaded=!1}getHeightAtTileCoord(e,i){let o=Number.NEGATIVE_INFINITY,a=!0;const h=4*(e+zt)*zt+(i+zt);if(this.footprintLookup.hasOwnProperty(h)){const y=this.footprintLookup[h];return y?{height:y.height,hidden:y.hiddenFlags!==0}:void 0}const d=new gt(e,i);for(const y of this.footprints)e>y.max.x||y.min.x>e||i>y.max.y||y.min.y>i||y.height<=o||zy(d,y)&&(o=y.height,this.footprintLookup[h]=y,a=y.hiddenFlags!==0);if(o!==Number.NEGATIVE_INFINITY)return{height:o,hidden:a};this.footprintLookup[h]=void 0}}function JE(n,e,i,o,a,h){const d=Math.pow(2,o.z-a.z);for(let y=0;y<i;y++){let w=n[y+e].x,T=n[y+e].y;w=(w+a.x*zt)*d-o.x*zt,T=(T+a.y*zt)*d-o.y*zt,h.push(new gt(w,T))}}let P1,R1;Kt(C1,"BuildingBucket",{omit:["layers"]});const eS=hn([{name:"a_pos_normal",components:2,type:"Int16"},{name:"a_data",components:4,type:"Uint8"},{name:"a_linesofar",components:1,type:"Float32"}],4),tS=hn([{name:"a_z_offset_width",components:3,type:"Float32"}],4),{members:iS}=eS,nS=hn([{name:"a_packed",components:3,type:"Float32"}]),{members:rS}=nS,sS=hn([{name:"a_pattern_data",components:3,type:"Float32"}]),{members:oS}=sS;class M1{constructor(e,i){this.width=e,this.height=i,this.nextRow=0,this.image=new pf({width:e,height:i}),this.positions={},this.uploaded=!1}getDash(e,i){const o=this.getKey(e,i);return this.positions[o]}trim(){const e=this.width,i=this.height=ri(this.nextRow);this.image.resize({width:e,height:i})}getKey(e,i){return e.join(",")+i}getDashRanges(e,i,o){const a=[];let h=e.length%2==1?-e[e.length-1]*o:0,d=e[0]*o,y=!0;a.push({left:h,right:d,isDash:y,zeroLength:e[0]===0});let w=e[0];for(let T=1;T<e.length;T++){y=!y;const C=e[T];h=w*o,w+=C,d=w*o,a.push({left:h,right:d,isDash:y,zeroLength:C===0})}return a}addRoundDash(e,i,o){const a=i/2;for(let h=-o;h<=o;h++){const d=this.width*(this.nextRow+o+h);let y=0,w=e[y];for(let T=0;T<this.width;T++){T/w.right>1&&(w=e[++y]);const C=Math.abs(T-w.left),P=Math.abs(T-w.right),D=Math.min(C,P);let O;const N=h/o*(a+1);if(w.isDash){const G=a-Math.abs(N);O=Math.sqrt(D*D+G*G)}else O=a-Math.sqrt(D*D+N*N);this.image.data[d+T]=Math.max(0,Math.min(255,O+128))}}}addRegularDash(e,i){for(let w=e.length-1;w>=0;--w){const T=e[w],C=e[w+1];T.zeroLength?e.splice(w,1):C&&C.isDash===T.isDash&&(C.left=T.left,e.splice(w,1))}const o=e[0],a=e[e.length-1];o.isDash===a.isDash&&(o.left=a.left-this.width,a.right=o.right+this.width);const h=this.width*this.nextRow;let d=0,y=e[d];for(let w=0;w<this.width;w++){w/y.right>1&&(y=e[++d]);const T=Math.abs(w-y.left),C=Math.abs(w-y.right),P=Math.min(T,C);this.image.data[h+w]=Math.max(0,Math.min(255,(y.isDash?P:-P)+i+128))}}addDash(e,i){const o=this.getKey(e,i);if(this.positions[o])return this.positions[o];const a=i==="round",h=a?7:0,d=2*h+1;if(this.nextRow+d>this.height)return tn("LineAtlas out of space"),null;e.length===0&&e.push(1);let y=0;for(let C=0;C<e.length;C++)e[C]<0&&(tn("Negative value is found in line dasharray, replacing values with 0"),e[C]=0),y+=e[C];if(y!==0){const C=this.width/y,P=this.getDashRanges(e,this.width,C);a?this.addRoundDash(P,C,h):this.addRegularDash(P,i==="square"?.5*C:0)}const w=this.nextRow+h;this.nextRow+=d;const T={tl:[w,h],br:[y,0]};return this.positions[o]=T,T}}Kt(M1,"LineAtlas");const aS=Ue.types,lS=Math.cos(Math.PI/180*37.5),cS=Math.cos(Math.PI/180*5);class e0{constructor(e){this.evaluationGlobals={zoom:0,lineProgress:void 0},this.elevationType="none",this.zoom=e.zoom,this.evaluationGlobals.zoom=this.zoom,this.overscaling=e.overscaling,this.pixelRatio=e.pixelRatio,this.layers=e.layers,this.layerIds=this.layers.map((i=>i.fqid)),this.index=e.index,this.projection=e.projection,this.hasPattern=!1,this.hasCrossSlope=!1,this.patternFeatures=[],this.lineClipsArray=[],this.gradients={},this.layers.forEach((i=>{this.gradients[i.id]={}})),this.layoutVertexArray=new sd,this.layoutVertexArray2=new Do,this.patternVertexArray=new Do,this.indexArray=new yr,this.programConfigurations=new oa(e.layers,{zoom:e.zoom,lut:e.lut}),this.segments=new kr,this.maxLineLength=0,this.zOffsetVertexArray=new Do,this.stateDependentLayerIds=this.layers.filter((i=>i.isStateDependent())).map((i=>i.id)),this.tessellationStep=e.tessellationStep?e.tessellationStep:zt/64,this.worldview=e.worldview}updateFootprints(e,i){}populate(e,i,o,a){this.hasPattern=Cy("line",this.layers,this.pixelRatio,i);const h=this.layers[0].layout.get("line-sort-key");this.tileToMeter=_e(o);const d=this.layers[0].layout.get("line-elevation-reference");if(d==="hd-road-markup")this.elevationType="road";else{const D=this.layers[0].layout.get("line-z-offset"),O=D.isConstant()&&!D.constantOr(0);this.elevationType=d!=="sea"&&d!=="ground"&&O?"none":"offset",this.elevationType==="offset"&&d==="none"&&tn(`line-elevation-reference: ground is used for the layer ${this.layerIds[0]} because non-zero line-z-offset value was found.`)}const y=this.layers[0].layout.get("line-cross-slope");this.hasCrossSlope=this.elevationType==="offset"&&y!==void 0;const w=[];for(const{feature:D,id:O,index:N,sourceLayerIndex:G}of e){const q=this.layers[0]._featureFilter.needGeometry,Y=Ze(D,q);if(!this.layers[0]._featureFilter.filter(new Wn(this.zoom,{worldview:this.worldview}),Y,o))continue;const se=h?h.evaluate(Y,{},o):void 0,re={id:O,properties:D.properties,type:D.type,sourceLayerIndex:G,index:N,geometry:q?Y.geometry:Te(D,o,a),patterns:{},sortKey:se};w.push(re)}h&&w.sort(((D,O)=>D.sortKey-O.sortKey));const{lineAtlas:T,featureIndex:C}=i,P=this.addConstantDashes(T);for(const D of w){const{geometry:O,index:N,sourceLayerIndex:G}=D;if(P&&this.addFeatureDashes(D,T),this.hasPattern){const q=Py("line",this.layers,D,this.zoom,this.pixelRatio,i);this.patternFeatures.push(q)}else this.addFeature(D,O,N,o,T.positions,i.availableImages,i.brightness,i.elevationFeatures);C.insert(e[N].feature,O,N,G,this.index)}}addConstantDashes(e){let i=!1;for(const o of this.layers){const a=o.paint.get("line-dasharray").value,h=o.layout.get("line-cap").value;if(a.kind!=="constant"||h.kind!=="constant")i=!0;else{const d=h.value,y=a.value;if(!y)continue;e.addDash(y,d)}}return i}addFeatureDashes(e,i){const o=this.zoom;for(const a of this.layers){const h=a.paint.get("line-dasharray").value,d=a.layout.get("line-cap").value;if(h.kind==="constant"&&d.kind==="constant")continue;let y,w;if(h.kind==="constant"){if(y=h.value,!y)continue}else y=h.evaluate({zoom:o},e);w=d.kind==="constant"?d.value:d.evaluate({zoom:o},e),i.addDash(y,w),e.patterns[a.id]=[i.getKey(y,w)]}}update(e,i,o,a,h,d,y,w){this.programConfigurations.updatePaintArrays(e,i,h,o,a,d,y,w)}addFeatures(e,i,o,a,h,d){for(const y of this.patternFeatures)this.addFeature(y,y.geometry,y.index,i,o,a,d)}isEmpty(){return this.layoutVertexArray.length===0}uploadPending(){return!this.uploaded||this.programConfigurations.needsUpload}upload(e){this.uploaded||(this.layoutVertexArray2.length!==0&&(this.layoutVertexBuffer2=e.createVertexBuffer(this.layoutVertexArray2,rS)),this.patternVertexArray.length!==0&&(this.patternVertexBuffer=e.createVertexBuffer(this.patternVertexArray,oS)),!this.zOffsetVertexBuffer&&this.zOffsetVertexArray.length>0&&(this.zOffsetVertexBuffer=e.createVertexBuffer(this.zOffsetVertexArray,tS.members,!0)),this.layoutVertexBuffer=e.createVertexBuffer(this.layoutVertexArray,iS),this.indexBuffer=e.createIndexBuffer(this.indexArray)),this.programConfigurations.upload(e),this.uploaded=!0}destroy(){this.layoutVertexBuffer&&(this.zOffsetVertexBuffer&&this.zOffsetVertexBuffer.destroy(),this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy())}lineFeatureClips(e){if(e.properties&&e.properties.hasOwnProperty("mapbox_clip_start")&&e.properties.hasOwnProperty("mapbox_clip_end"))return{start:+e.properties.mapbox_clip_start,end:+e.properties.mapbox_clip_end}}addFeature(e,i,o,a,h,d,y,w){const T=this.layers[0].layout,C=T.get("line-join").evaluate(e,{}),P=T.get("line-cap").evaluate(e,{}),D=T.get("line-miter-limit"),O=T.get("line-round-limit");this.lineClips=this.lineFeatureClips(e),this.lineFeature=e,this.zOffsetValue=T.get("line-z-offset").value;const N=this.layers[0].paint.get("line-width").value;if(N.kind!=="constant"&&N.isLineProgressConstant===!1&&(this.variableWidthValue=N),this.elevationType==="road"){const G=this.layoutVertexArray.length;if(!this.addElevatedRoadFeature(e,i,a,w,C,P,D,O)){const[q,Y]=this.clipRuntimeLinesToTile(i,1);for(let se=0;se<q.length;se++){const re=q[se],ae=Y[se],Ee={progress:{min:ae.progress.min,max:ae.progress.max},nextDir:this.computeSegNextDir(ae,re),prevDir:this.computeSegPrevDir(ae,re)};this.addLine(re,e,a,C,P,D,O,Ee)}this.fillNonElevatedRoadSegment(G)}}else for(const G of i)this.addLine(G,e,a,C,P,D,O);this.programConfigurations.populatePaintArrays(this.layoutVertexArray.length,e,o,h,d,a,y,void 0,this.worldview)}computeSegNextDir(e,i){return e.nextPoint.sub(i.at(-2)).unit()}computeSegPrevDir(e,i){return i[1].sub(e.prevPoint).unit()}clipLinesToTile(e,i){return Y_(e,-i,-i,zt+i,zt+i)}clipRuntimeLinesToTile(e,i){const o=[];return[Y_(e,-i,-i,zt+i,zt+i,o),o]}addElevatedRoadFeature(e,i,o,a,h,d,y,w){const T=[],C=zr.getElevationFeature(e,a);if(C){const P=this.clipLinesToTile(i,1),D=this.prepareElevatedLines(P,C,o);for(const O of D)T.push({geometry:O,elevation:C,elevationTileID:o,segment:{progress:{min:0,max:1},nextDir:void 0,prevDir:void 0}})}if(T.length===0)return!1;for(const P of T){const D=this.layoutVertexArray.length;this.addLine(P.geometry,e,o,h,d,y,w);const O=new Tn(o,P.elevationTileID);if(P.elevation)for(let N=D;N<this.layoutVertexArray.length;N++){const G=new gt(this.layoutVertexArray.int16[6*N]>>1,this.layoutVertexArray.int16[6*N+1]>>1),q=O.pointElevation(G,P.elevation,.05);this.updateHeightRange(q),this.zOffsetVertexArray.emplaceBack(q,0,0)}else this.fillNonElevatedRoadSegment(D)}return!0}prepareElevatedLines(e,i,o){if(i.constantHeight!=null)return e;const a=[],h=1/_e(o);for(const d of e)IE(d,new Qn(i,h),0,a);return a}fillNonElevatedRoadSegment(e){for(let i=e;i<this.layoutVertexArray.length;i++)this.zOffsetVertexArray.emplaceBack(0,0,0)}updateHeightRange(e){this.heightRange?(this.heightRange.min=Math.min(this.heightRange.min,e),this.heightRange.max=Math.max(this.heightRange.max,e)):this.heightRange={min:e,max:e}}addLine(e,i,o,a,h,d,y,w){this.distance=0,this.prevDistance=0,this.scaledDistance=0,this.totalDistance=0,this.totalFeatureLength=0,this.lineSoFar=0,this.currentVertex=void 0;const T=a==="none";this.patternJoinNone=this.hasPattern&&T,this.segmentStart=0,this.segmentStartf32=0,this.segmentPoints=[];const C=w&&w.progress.min>0,P=w&&w.progress.max<1;if(this.lineClips){let Pe={min:this.lineClips.start,max:this.lineClips.end},Me=1;if(w){const ot=this.lineClips.end-this.lineClips.start;Pe=(function(Dt,ht,bt){return{min:Ks(Dt.min,ht,bt),max:Ks(Dt.max,ht,bt)}})(w.progress,{min:0,max:1},Pe),ot>0&&(Me=(Pe.max-Pe.min)/ot)}const it=+i.properties.mapbox_clip_feature_len,Fe=+i.properties.mapbox_clip_seg_len;if(Number.isNaN(it)||Number.isNaN(Fe)){for(let Dt=0;Dt<e.length-1;Dt++)this.totalDistance+=e[Dt].dist(e[Dt+1]);const ot=this.totalDistance/(Pe.max-Pe.min);this.totalFeatureLength=Number.isFinite(ot)?ot:0,this.lineClips.start=Pe.min,this.lineClips.end=Pe.max,this.maxLineLength=Math.max(this.maxLineLength,this.totalDistance)}else this.totalFeatureLength=it,this.distance=Fe*Me,this.lineClips.start=Pe.min,this.lineClips.end=Pe.max,this.maxLineLength=Math.max(this.maxLineLength,this.distance);this.lineClipsArray.push(this.lineClips),this.updateScaledDistance()}const D=aS[i.type]==="Polygon";let O=e.length;for(;O>=2&&e[O-1].equals(e[O-2]);)O--;let N=0;for(;N<O-1&&e[N].equals(e[N+1]);)N++;if(O<(D?3:2))return;a==="bevel"&&(d=1.05);const G=this.segments.prepareSegment(10*O,this.layoutVertexArray,this.indexArray);let q,Y,se,re,ae,Ee,ve,xe;w&&w.prevDir&&(Ee=w.prevDir.perp()),w&&w.nextDir&&(ve=w.nextDir.perp()),this.e1=this.e2=-1,D&&(q=e[O-2],ae=e[N].sub(q)._unit()._perp());for(let Pe=N;Pe<O;Pe++){if(se=Pe===O-1?D?e[N+1]:void 0:e[Pe+1],se&&e[Pe].equals(se))continue;ae&&(re=ae),q&&(Y=q),q=e[Pe],xe=this.evaluateLineProgressFeatures(Y?Y.dist(q):0),ae=se?se.sub(q)._unit()._perp():re,re=re||ae;const Me=Y&&se;let it=Me?a:D||T?"butt":h;const Fe=re.x*ae.x+re.y*ae.y;if(T){const Ve=function(tt){if(tt.patternJoinNone){const Lt=tt.segmentPoints.length/2,Et=tt.lineSoFar-tt.segmentStart;for(let li=0;li<Lt;++li){const Yt=tt.segmentPoints[2*li+1],vt=Math.round(tt.segmentPoints[2*li])+.5+.25*Yt;tt.patternVertexArray.emplaceBack(vt,Et,tt.segmentStart),tt.patternVertexArray.emplaceBack(vt,Et,tt.segmentStart)}tt.segmentPoints.length=0}tt.e1=tt.e2=-1};if(Me&&Fe<cS){this.updateDistance(Y,q),this.addCurrentVertex(q,re,1,1,G,xe),Ve(this),this.addCurrentVertex(q,ae,-1,-1,G,xe);continue}if(Y){if(!se){this.updateDistance(Y,q),this.addCurrentVertex(q,re,1,1,G,xe),Ve(this);continue}it="miter"}}let ot=re.add(ae);ot.x===0&&ot.y===0||ot._unit();const Dt=ot.x*ae.x+ot.y*ae.y,ht=Dt!==0?1/Dt:1/0,bt=2*Math.sqrt(2-2*Dt),Rt=Dt<lS&&Y&&se,et=re.x*ae.y-re.y*ae.x>0,Tt=this.overscaling<=16?15*zt/(512*this.overscaling):0;if(Me&&it==="round"){if(ht<y)it="miter";else if(ht<=2){const Ve=t0(q,-10,zt+10);it=this.elevationType==="offset"&&(Ve||this.hasCrossSlope)?"miter":"fakeround"}}if(it==="miter"&&ht>d&&(it="bevel"),it==="bevel"&&(ht>2&&(it="flipbevel"),ht<d&&(it="miter")),Y&&!(it==="miter"&&Rt)&&this.updateDistance(Y,q),it==="miter")if(Rt){const Ve=q.dist(Y);if(Ve>2*Tt){const Lt=q.sub(q.sub(Y)._mult(Tt/Ve)._round());this.updateDistance(Y,Lt),this.addCurrentVertex(Lt,re,0,0,G,xe),Y=Lt}this.updateDistance(Y,q),ot._mult(ht),this.addCurrentVertex(q,ot,0,0,G,xe);const tt=q.dist(se);if(tt>2*Tt){const Lt=q.add(se.sub(q)._mult(Tt/tt)._round());this.updateDistance(q,Lt),this.addCurrentVertex(Lt,ae,0,0,G,xe),q=Lt}}else ot._mult(ht),this.addCurrentVertex(q,ot,0,0,G,xe);else if(it==="flipbevel"){if(ht>100)ot=ae.mult(-1);else{const Ve=ht*re.add(ae).mag()/re.sub(ae).mag();ot._perp()._mult(Ve*(et?-1:1))}this.addCurrentVertex(q,ot,0,0,G,xe),this.addCurrentVertex(q,ot.mult(-1),0,0,G,xe)}else if(it==="bevel"||it==="fakeround"){xe!=null&&Y&&this.addCurrentVertex(q,ve||re,-1,-1,G,xe);const Ve=q.dist(Y)<=2*Tt&&it!=="bevel",tt=ot.mult(et?1:-1);tt._mult(ht);const Lt=ae.mult(et?-1:1),Et=re.mult(et?-1:1),li=this.evaluateLineProgressFeatures(this.distance);if(xe==null&&(this.addHalfVertex(q,tt.x,tt.y,!1,!et,0,G,li),Ve||this.addHalfVertex(q,tt.x+2*Et.x,tt.y+2*Et.y,!1,et,0,G,li)),it==="fakeround"){const Yt=Math.round(180*bt/Math.PI/20);this.addHalfVertex(q,Et.x,Et.y,!1,et,0,G,li);for(let vt=0;vt<Yt;vt++){let At=vt/Yt;if(At!==.5){const Zt=At-.5;At+=At*Zt*(At-1)*((1.0904+Fe*(Fe*(3.55645-1.43519*Fe)-3.2452))*Zt*Zt+(.848013+Fe*(.215638*Fe-1.06021)))}const ti=Lt.sub(Et)._mult(At)._add(Et)._unit();this.addHalfVertex(q,ti.x,ti.y,!1,et,0,G,li)}this.addHalfVertex(q,Lt.x,Lt.y,!1,et,0,G,li)}Ve||xe!=null||this.addHalfVertex(q,tt.x+2*Lt.x,tt.y+2*Lt.y,!1,et,0,G,li),xe!=null&&se&&this.addCurrentVertex(q,Ee||ae,1,1,G,xe)}else if(it==="butt")this.addCurrentVertex(q,ot,0,0,G,xe);else if(it==="square"){if(!Y){const Ve=C?0:-1;this.addCurrentVertex(q,ot,Ve,Ve,G,xe)}if(this.addCurrentVertex(q,ot,0,0,G,xe),Y){const Ve=P?0:1;this.addCurrentVertex(q,ot,Ve,Ve,G,xe)}}else if(it==="round"){if(Y){const Ve=!Me&&ve?ve:re;this.addCurrentVertex(q,Ve,0,0,G,xe),!Me&&P||this.addCurrentVertex(q,Ve,1,1,G,xe,!0)}if(se){const Ve=!Me&&Ee?Ee:ae;!Me&&C||this.addCurrentVertex(q,Ve,-1,-1,G,xe,!0),this.addCurrentVertex(q,Ve,0,0,G,xe)}}}}addVerticesTo(e,i,o,a,h,d,y,w,T,C){const P=(i.w-e.w)/this.tessellationStep|0;let D=0;const O=this.scaledDistance;if(P>1){this.lineSoFar=e.w;const G=(i.x-e.x)/P,q=(i.y-e.y)/P,Y=(i.z-e.z)/P,se=(i.w-e.w)/P;for(let re=1;re<P;++re){e.x+=G,e.y+=q,e.z+=Y,this.lineSoFar+=se,D+=se;const ae=this.evaluateLineProgressFeatures(this.prevDistance+D);this.scaledDistance=(this.prevDistance+D)/this.totalDistance,this.addHalfVertex(e,o,a,C,!1,y,T,ae),this.addHalfVertex(e,h,d,C,!0,-w,T,ae)}}this.lineSoFar=i.w,this.scaledDistance=O;const N=this.evaluateLineProgressFeatures(this.distance);this.addHalfVertex(i,o,a,C,!1,y,T,N),this.addHalfVertex(i,h,d,C,!0,-w,T,N)}evaluateLineProgressFeatures(e){if(!this.variableWidthValue&&this.elevationType!=="offset")return null;this.evaluationGlobals.lineProgress=0,this.lineClips?this.evaluationGlobals.lineProgress=Math.min(1,(this.totalFeatureLength*this.lineClips.start+e)/this.totalFeatureLength):tn(`line-progress evaluation for ${this.layerIds[0]} requires enabling 'lineMetrics' for the source.`);let i=0;return this.variableWidthValue&&this.variableWidthValue.kind!=="constant"&&(i=this.variableWidthValue.evaluate(this.evaluationGlobals,this.lineFeature)||0),this.elevationType!=="offset"?{zOffset:0,variableWidth:i}:this.zOffsetValue.kind==="constant"?{zOffset:this.zOffsetValue.value,variableWidth:i}:{zOffset:this.zOffsetValue.evaluate(this.evaluationGlobals,this.lineFeature)||0,variableWidth:i}}addCurrentVertex(e,i,o,a,h,d,y=!1){const w=i.x+i.y*o,T=i.y-i.x*o,C=i.y*a-i.x,P=-i.y-i.x*a;if(d!=null){const D=this.elevationType==="offset",O=-10,N=zt+10,G=d.zOffset,q=new e1(e.x,e.y,G,this.lineSoFar),Y=!!D&&t0(e,O,N),se=this.lineSoFar,re=this.distance;if(this.currentVertex)if(Y){const ae=this.currentVertexIsOutside,Ee=this.currentVertex,ve=new e1(e.x,e.y,G,this.lineSoFar);if(i1(Ee,ve,O,N),!t0(ve,O,N)){if(ae){this.e1=this.e2=-1,this.distance-=Ee.dist(q),this.lineSoFar=Ee.w;const xe=this.evaluateLineProgressFeatures(Ee.w-this.totalFeatureLength*(this.lineClips?this.lineClips.start:0));this.addHalfVertex(Ee,w,T,y,!1,o,h,xe),this.addHalfVertex(Ee,C,P,y,!0,-a,h,xe),this.prevDistance=this.distance}this.distance=this.prevDistance+Ee.dist(ve),this.scaledDistance=this.distance/this.totalDistance,this.addVerticesTo(Ee,ve,w,T,C,P,o,a,h,y),this.distance=re,this.scaledDistance=this.distance/this.totalDistance}}else{const ae=this.currentVertex;if(this.currentVertexIsOutside){i1(ae,q,O,N),this.e1=this.e2=-1,this.distance-=ae.dist(q),this.scaledDistance=this.distance/this.totalDistance,this.lineSoFar=ae.w;const Ee=this.evaluateLineProgressFeatures(ae.w-this.totalFeatureLength*(this.lineClips?this.lineClips.start:0));this.addHalfVertex(ae,w,T,y,!1,o,h,Ee),this.addHalfVertex(ae,C,P,y,!0,-a,h,Ee),this.prevDistance=this.distance,this.distance=re,this.scaledDistance=this.distance/this.totalDistance}this.addVerticesTo(ae,q,w,T,C,P,o,a,h,y)}else Y||(this.addHalfVertex(e,w,T,y,!1,o,h,d),this.addHalfVertex(e,C,P,y,!0,-a,h,d));this.currentVertex=q,this.currentVertexIsOutside=Y,this.lineSoFar=se}else this.addHalfVertex(e,w,T,y,!1,o,h,d),this.addHalfVertex(e,C,P,y,!0,-a,h,d)}addHalfVertex({x:e,y:i},o,a,h,d,y,w,T){if(this.patternJoinNone&&(this.segmentPoints.length===0&&(this.segmentStart=this.lineSoFar,this.segmentStartf32=Math.fround(this.lineSoFar)),d||this.segmentPoints.push(this.lineSoFar-this.segmentStart,y)),this.layoutVertexArray.emplaceBack((e<<1)+(h?1:0),(i<<1)+(d?1:0),Math.round(63*o)+128,Math.round(63*a)+128,1+(y===0?0:y<0?-1:1),0,this.lineSoFar-this.segmentStartf32),this.lineClips){const P=di(this.lineClips.start,this.lineClips.end,this.scaledDistance);this.layoutVertexArray2.emplaceBack(this.scaledDistance,this.lineClipsArray.length,P)}const C=w.vertexLength++;this.e1>=0&&this.e2>=0&&(this.indexArray.emplaceBack(this.e1,this.e2,C),w.primitiveLength++),d?this.e2=C:this.e1=C,T!=null&&this.zOffsetVertexArray.emplaceBack(T.zOffset,T.variableWidth,T.variableWidth)}updateScaledDistance(){this.lineClips?(this.scaledDistance=this.distance/this.totalDistance,this.lineSoFar=this.totalFeatureLength*this.lineClips.start+this.distance):this.lineSoFar=this.distance}updateDistance(e,i){this.prevDistance=this.distance,this.distance+=e.dist(i),this.updateScaledDistance()}}function t0(n,e,i){return n.x<e||n.x>i||n.y<e||n.y>i}let D1,L1;function k1(n,e,i){return e*(zt/(n.tileSize*Math.pow(2,i-n.tileID.overscaledZ)))}Kt(e0,"LineBucket",{omit:["layers","patternFeatures","currentVertex","currentVertexIsOutside"]});const z1=(n,e,i)=>(1-i)*n+i*e;function F1(n,e){return 1/k1(n,1,e.tileZoom)}function O1(n,e,i,o){return n.translatePosMatrix(o||e.tileID.projMatrix,e,i.paint.get("line-translate"),i.paint.get("line-translate-anchor"))}const B1=n=>{const e=[];N1(n)&&e.push("RENDER_LINE_DASH"),n.paint.get("line-gradient")&&e.push("RENDER_LINE_GRADIENT");const i=n.paint.get("line-trim-offset");i[0]===0&&i[1]===0||e.push("RENDER_LINE_TRIM_OFFSET"),n.paint.get("line-border-width").constantOr(1)!==0&&e.push("RENDER_LINE_BORDER");const o=n.layout.get("line-join").constantOr("miter")==="none",a=!!n.paint.get("line-pattern").constantOr(1);return o&&a&&e.push("LINE_JOIN_NONE"),e};function N1(n){const e=n.paint.get("line-dasharray").value;return e.value||e.kind!=="constant"}let i0;const V1=()=>i0||(i0={layout:D1||(D1=new Fr({"line-cap":new Wt(Le.layout_line["line-cap"]),"line-join":new Wt(Le.layout_line["line-join"]),"line-miter-limit":new _t(Le.layout_line["line-miter-limit"]),"line-round-limit":new _t(Le.layout_line["line-round-limit"]),"line-sort-key":new Wt(Le.layout_line["line-sort-key"]),"line-z-offset":new Wt(Le.layout_line["line-z-offset"]),"line-elevation-reference":new _t(Le.layout_line["line-elevation-reference"]),"line-cross-slope":new _t(Le.layout_line["line-cross-slope"]),visibility:new _t(Le.layout_line.visibility),"line-width-unit":new _t(Le.layout_line["line-width-unit"])})),paint:L1||(L1=new Fr({"line-opacity":new Wt(Le.paint_line["line-opacity"]),"line-color":new Wt(Le.paint_line["line-color"]),"line-translate":new _t(Le.paint_line["line-translate"]),"line-translate-anchor":new _t(Le.paint_line["line-translate-anchor"]),"line-width":new Wt(Le.paint_line["line-width"]),"line-gap-width":new Wt(Le.paint_line["line-gap-width"]),"line-offset":new Wt(Le.paint_line["line-offset"]),"line-blur":new Wt(Le.paint_line["line-blur"]),"line-dasharray":new Wt(Le.paint_line["line-dasharray"]),"line-pattern":new Wt(Le.paint_line["line-pattern"]),"line-pattern-cross-fade":new _t(Le.paint_line["line-pattern-cross-fade"]),"line-gradient":new jc(Le.paint_line["line-gradient"]),"line-trim-offset":new _t(Le.paint_line["line-trim-offset"]),"line-trim-fade-range":new _t(Le.paint_line["line-trim-fade-range"]),"line-trim-color":new _t(Le.paint_line["line-trim-color"]),"line-emissive-strength":new _t(Le.paint_line["line-emissive-strength"]),"line-border-width":new Wt(Le.paint_line["line-border-width"]),"line-border-color":new Wt(Le.paint_line["line-border-color"]),"line-occlusion-opacity":new _t(Le.paint_line["line-occlusion-opacity"]),"line-color-use-theme":new Wt({type:"string",default:"default","property-type":"data-driven"}),"line-gradient-use-theme":new Wt({type:"string",default:"default","property-type":"data-driven"}),"line-trim-color-use-theme":new Wt({type:"string",default:"default","property-type":"data-driven"}),"line-border-color-use-theme":new Wt({type:"string",default:"default","property-type":"data-driven"})}))},i0);class uS extends Wt{possiblyEvaluate(e,i){return i=new Wn(Math.floor(i.zoom),{now:i.now,fadeDuration:i.fadeDuration,transition:i.transition,worldview:i.worldview}),super.possiblyEvaluate(e,i)}evaluate(e,i,o,a){return i=Ge({},i,{zoom:Math.floor(i.zoom)}),super.evaluate(e,i,o,a)}}let Um;function U1(n,e){return e>0?e+2*n:n}const hS=hn([{name:"a_pos_offset",components:4,type:"Int16"},{name:"a_tex_size",components:4,type:"Uint16"},{name:"a_pixeloffset",components:4,type:"Int16"}],4),dS=hn([{name:"a_globe_anchor",components:3,type:"Int16"},{name:"a_globe_normal",components:3,type:"Float32"}],4),fS=hn([{name:"a_projected_pos",components:4,type:"Float32"}],4);hn([{name:"a_fade_opacity",components:1,type:"Uint32"}],4);const pS=hn([{name:"a_auto_z_offset",components:1,type:"Float32"}],4),mS=hn([{name:"a_x_axis",components:3,type:"Float32"},{name:"a_y_axis",components:3,type:"Float32"}]),_S=hn([{name:"a_texb",components:2,type:"Uint16"}]),gS=hn([{name:"a_placed",components:2,type:"Uint8"},{name:"a_shift",components:2,type:"Float32"},{name:"a_elevation_from_sea",components:2,type:"Float32"}]),yS=hn([{name:"a_size_scale",components:1,type:"Float32"},{name:"a_padding",components:2,type:"Float32"},{name:"a_auto_z_offset",components:1,type:"Float32"}]);hn([{type:"Int16",name:"projectedAnchorX"},{type:"Int16",name:"projectedAnchorY"},{type:"Int16",name:"projectedAnchorZ"},{type:"Int16",name:"tileAnchorX"},{type:"Int16",name:"tileAnchorY"},{type:"Float32",name:"x1"},{type:"Float32",name:"y1"},{type:"Float32",name:"x2"},{type:"Float32",name:"y2"},{type:"Int16",name:"padding"},{type:"Uint32",name:"featureIndex"},{type:"Uint16",name:"sourceLayerIndex"},{type:"Uint16",name:"bucketIndex"}]);const j1=hn([{name:"a_pos",components:3,type:"Int16"},{name:"a_anchor_pos",components:2,type:"Int16"},{name:"a_extrude",components:2,type:"Int16"}],4),vS=hn([{name:"a_pos_2f",components:2,type:"Float32"},{name:"a_radius",components:1,type:"Float32"},{name:"a_flags",components:2,type:"Int16"}],4);hn([{name:"triangle",components:3,type:"Uint16"}]),hn([{type:"Int16",name:"projectedAnchorX"},{type:"Int16",name:"projectedAnchorY"},{type:"Int16",name:"projectedAnchorZ"},{type:"Float32",name:"tileAnchorX"},{type:"Float32",name:"tileAnchorY"},{type:"Uint16",name:"glyphStartIndex"},{type:"Uint16",name:"numGlyphs"},{type:"Uint32",name:"vertexStartIndex"},{type:"Uint32",name:"lineStartIndex"},{type:"Uint32",name:"lineLength"},{type:"Uint16",name:"segment"},{type:"Uint16",name:"lowerSize"},{type:"Uint16",name:"upperSize"},{type:"Float32",name:"lineOffsetX"},{type:"Float32",name:"lineOffsetY"},{type:"Uint8",name:"writingMode"},{type:"Uint8",name:"placedOrientation"},{type:"Uint8",name:"hidden"},{type:"Uint32",name:"crossTileID"},{type:"Int16",name:"associatedIconIndex"},{type:"Uint8",name:"flipState"}]),hn([{type:"Float32",name:"tileAnchorX"},{type:"Float32",name:"tileAnchorY"},{type:"Int16",name:"projectedAnchorX"},{type:"Int16",name:"projectedAnchorY"},{type:"Int16",name:"projectedAnchorZ"},{type:"Int16",name:"rightJustifiedTextSymbolIndex"},{type:"Int16",name:"centerJustifiedTextSymbolIndex"},{type:"Int16",name:"leftJustifiedTextSymbolIndex"},{type:"Int16",name:"verticalPlacedTextSymbolIndex"},{type:"Int16",name:"placedIconSymbolIndex"},{type:"Int16",name:"verticalPlacedIconSymbolIndex"},{type:"Uint16",name:"key"},{type:"Uint16",name:"textBoxStartIndex"},{type:"Uint16",name:"textBoxEndIndex"},{type:"Uint16",name:"verticalTextBoxStartIndex"},{type:"Uint16",name:"verticalTextBoxEndIndex"},{type:"Uint16",name:"iconBoxStartIndex"},{type:"Uint16",name:"iconBoxEndIndex"},{type:"Uint16",name:"verticalIconBoxStartIndex"},{type:"Uint16",name:"verticalIconBoxEndIndex"},{type:"Uint16",name:"featureIndex"},{type:"Uint16",name:"numHorizontalGlyphVertices"},{type:"Uint16",name:"numVerticalGlyphVertices"},{type:"Uint16",name:"numIconVertices"},{type:"Uint16",name:"numVerticalIconVertices"},{type:"Uint16",name:"useRuntimeCollisionCircles"},{type:"Uint32",name:"crossTileID"},{type:"Float32",components:2,name:"textOffset"},{type:"Float32",name:"collisionCircleDiameter"},{type:"Float32",name:"zOffset"},{type:"Uint8",name:"hasIconTextFit"},{type:"Uint16",name:"elevationFeatureIndex"}]),hn([{type:"Float32",name:"offsetX"}]),hn([{type:"Int16",name:"x"},{type:"Int16",name:"y"}]);var _o=24;function xS(n,e,i){return n.sections.forEach((o=>{o.text=(function(a,h,d){const y=h.layout.get("text-transform").evaluate(d,{});return y==="uppercase"?a=a.toLocaleUpperCase():y==="lowercase"&&(a=a.toLocaleLowerCase()),Ra.applyArabicShaping&&(a=Ra.applyArabicShaping(a)),a})(o.text,e,i)})),n}const jm={"!":"︕","#":"＃",$:"＄","%":"％","&":"＆","(":"︵",")":"︶","*":"＊","+":"＋",",":"︐","-":"︲",".":"・","/":"／",":":"︓",";":"︔","<":"︿","=":"＝",">":"﹀","?":"︖","@":"＠","[":"﹇","\\":"＼","]":"﹈","^":"＾",_:"︳","`":"｀","{":"︷","|":"―","}":"︸","~":"～","¢":"￠","£":"￡","¥":"￥","¦":"￤","¬":"￢","¯":"￣","–":"︲","—":"︱","‘":"﹃","’":"﹄","“":"﹁","”":"﹂","…":"︙","‧":"・","₩":"￦","、":"︑","。":"︒","〈":"︿","〉":"﹀","《":"︽","》":"︾","「":"﹁","」":"﹂","『":"﹃","』":"﹄","【":"︻","】":"︼","〔":"︹","〕":"︺","〖":"︗","〗":"︘","！":"︕","（":"︵","）":"︶","，":"︐","－":"︲","．":"・","：":"︓","；":"︔","＜":"︿","＞":"﹀","？":"︖","［":"﹇","］":"﹈","＿":"︳","｛":"︷","｜":"―","｝":"︸","｟":"︵","｠":"︶","｡":"︒","｢":"﹁","｣":"﹂","←":"↑","→":"↓"};function wS(n){return n==="︶"||n==="﹈"||n==="︸"||n==="﹄"||n==="﹂"||n==="︾"||n==="︼"||n==="︺"||n==="︘"||n==="﹀"||n==="︐"||n==="︓"||n==="︔"||n==="｀"||n==="￣"||n==="︑"||n==="︒"}function bS(n){return n==="︵"||n==="﹇"||n==="︷"||n==="﹃"||n==="﹁"||n==="︽"||n==="︻"||n==="︹"||n==="︗"||n==="︿"}const n0=4294967296,G1=1/n0,H1=typeof TextDecoder>"u"?null:new TextDecoder("utf-8");let sg=class{constructor(n=new Uint8Array(16)){this.buf=ArrayBuffer.isView(n)?n:new Uint8Array(n),this.dataView=new DataView(this.buf.buffer),this.pos=0,this.type=0,this.length=this.buf.length}readFields(n,e,i=this.length){for(;this.pos<i;){const o=this.readVarint(),a=o>>3,h=this.pos;this.type=7&o,n(a,e,this),this.pos===h&&this.skip(o)}return e}readMessage(n,e){return this.readFields(n,e,this.readVarint()+this.pos)}readFixed32(){const n=this.dataView.getUint32(this.pos,!0);return this.pos+=4,n}readSFixed32(){const n=this.dataView.getInt32(this.pos,!0);return this.pos+=4,n}readFixed64(){const n=this.dataView.getUint32(this.pos,!0)+this.dataView.getUint32(this.pos+4,!0)*n0;return this.pos+=8,n}readSFixed64(){const n=this.dataView.getUint32(this.pos,!0)+this.dataView.getInt32(this.pos+4,!0)*n0;return this.pos+=8,n}readFloat(){const n=this.dataView.getFloat32(this.pos,!0);return this.pos+=4,n}readDouble(){const n=this.dataView.getFloat64(this.pos,!0);return this.pos+=8,n}readVarint(n){const e=this.buf;let i,o;return o=e[this.pos++],i=127&o,o<128?i:(o=e[this.pos++],i|=(127&o)<<7,o<128?i:(o=e[this.pos++],i|=(127&o)<<14,o<128?i:(o=e[this.pos++],i|=(127&o)<<21,o<128?i:(o=e[this.pos],i|=(15&o)<<28,(function(a,h,d){const y=d.buf;let w,T;if(T=y[d.pos++],w=(112&T)>>4,T<128||(T=y[d.pos++],w|=(127&T)<<3,T<128)||(T=y[d.pos++],w|=(127&T)<<10,T<128)||(T=y[d.pos++],w|=(127&T)<<17,T<128)||(T=y[d.pos++],w|=(127&T)<<24,T<128)||(T=y[d.pos++],w|=(1&T)<<31,T<128))return qp(a,w,h);throw new Error("Expected varint not more than 10 bytes")})(i,n,this)))))}readVarint64(){return this.readVarint(!0)}readSVarint(){const n=this.readVarint();return n%2==1?(n+1)/-2:n/2}readBoolean(){return!!this.readVarint()}readString(){const n=this.readVarint()+this.pos,e=this.pos;return this.pos=n,n-e>=12&&H1?H1.decode(this.buf.subarray(e,n)):(function(i,o,a){let h="",d=o;for(;d<a;){const y=i[d];let w,T,C,P=null,D=y>239?4:y>223?3:y>191?2:1;if(d+D>a)break;D===1?y<128&&(P=y):D===2?(w=i[d+1],(192&w)==128&&(P=(31&y)<<6|63&w,P<=127&&(P=null))):D===3?(w=i[d+1],T=i[d+2],(192&w)==128&&(192&T)==128&&(P=(15&y)<<12|(63&w)<<6|63&T,(P<=2047||P>=55296&&P<=57343)&&(P=null))):D===4&&(w=i[d+1],T=i[d+2],C=i[d+3],(192&w)==128&&(192&T)==128&&(192&C)==128&&(P=(15&y)<<18|(63&w)<<12|(63&T)<<6|63&C,(P<=65535||P>=1114112)&&(P=null))),P===null?(P=65533,D=1):P>65535&&(P-=65536,h+=String.fromCharCode(P>>>10&1023|55296),P=56320|1023&P),h+=String.fromCharCode(P),d+=D}return h})(this.buf,e,n)}readBytes(){const n=this.readVarint()+this.pos,e=this.buf.subarray(this.pos,n);return this.pos=n,e}readPackedVarint(n=[],e){const i=this.readPackedEnd();for(;this.pos<i;)n.push(this.readVarint(e));return n}readPackedSVarint(n=[]){const e=this.readPackedEnd();for(;this.pos<e;)n.push(this.readSVarint());return n}readPackedBoolean(n=[]){const e=this.readPackedEnd();for(;this.pos<e;)n.push(this.readBoolean());return n}readPackedFloat(n=[]){const e=this.readPackedEnd();for(;this.pos<e;)n.push(this.readFloat());return n}readPackedDouble(n=[]){const e=this.readPackedEnd();for(;this.pos<e;)n.push(this.readDouble());return n}readPackedFixed32(n=[]){const e=this.readPackedEnd();for(;this.pos<e;)n.push(this.readFixed32());return n}readPackedSFixed32(n=[]){const e=this.readPackedEnd();for(;this.pos<e;)n.push(this.readSFixed32());return n}readPackedFixed64(n=[]){const e=this.readPackedEnd();for(;this.pos<e;)n.push(this.readFixed64());return n}readPackedSFixed64(n=[]){const e=this.readPackedEnd();for(;this.pos<e;)n.push(this.readSFixed64());return n}readPackedEnd(){return this.type===2?this.readVarint()+this.pos:this.pos+1}skip(n){const e=7&n;if(e===0)for(;this.buf[this.pos++]>127;);else if(e===2)this.pos=this.readVarint()+this.pos;else if(e===5)this.pos+=4;else{if(e!==1)throw new Error(`Unimplemented type: ${e}`);this.pos+=8}}writeTag(n,e){this.writeVarint(n<<3|e)}realloc(n){let e=this.length||16;for(;e<this.pos+n;)e*=2;if(e!==this.length){const i=new Uint8Array(e);i.set(this.buf),this.buf=i,this.dataView=new DataView(i.buffer),this.length=e}}finish(){return this.length=this.pos,this.pos=0,this.buf.subarray(0,this.length)}writeFixed32(n){this.realloc(4),this.dataView.setInt32(this.pos,n,!0),this.pos+=4}writeSFixed32(n){this.realloc(4),this.dataView.setInt32(this.pos,n,!0),this.pos+=4}writeFixed64(n){this.realloc(8),this.dataView.setInt32(this.pos,-1&n,!0),this.dataView.setInt32(this.pos+4,Math.floor(n*G1),!0),this.pos+=8}writeSFixed64(n){this.realloc(8),this.dataView.setInt32(this.pos,-1&n,!0),this.dataView.setInt32(this.pos+4,Math.floor(n*G1),!0),this.pos+=8}writeVarint(n){(n=+n||0)>268435455||n<0?(function(e,i){let o,a;if(e>=0?(o=e%4294967296|0,a=e/4294967296|0):(o=~(-e%4294967296),a=~(-e/4294967296),4294967295^o?o=o+1|0:(o=0,a=a+1|0)),e>=18446744073709552e3||e<-18446744073709552e3)throw new Error("Given varint doesn't fit into 10 bytes");i.realloc(10),(function(h,d,y){y.buf[y.pos++]=127&h|128,h>>>=7,y.buf[y.pos++]=127&h|128,h>>>=7,y.buf[y.pos++]=127&h|128,h>>>=7,y.buf[y.pos++]=127&h|128,y.buf[y.pos]=127&(h>>>=7)})(o,0,i),(function(h,d){const y=(7&h)<<4;d.buf[d.pos++]|=y|((h>>>=3)?128:0),h&&(d.buf[d.pos++]=127&h|((h>>>=7)?128:0),h&&(d.buf[d.pos++]=127&h|((h>>>=7)?128:0),h&&(d.buf[d.pos++]=127&h|((h>>>=7)?128:0),h&&(d.buf[d.pos++]=127&h|((h>>>=7)?128:0),h&&(d.buf[d.pos++]=127&h)))))})(a,i)})(n,this):(this.realloc(4),this.buf[this.pos++]=127&n|(n>127?128:0),n<=127||(this.buf[this.pos++]=127&(n>>>=7)|(n>127?128:0),n<=127||(this.buf[this.pos++]=127&(n>>>=7)|(n>127?128:0),n<=127||(this.buf[this.pos++]=n>>>7&127))))}writeSVarint(n){this.writeVarint(n<0?2*-n-1:2*n)}writeBoolean(n){this.writeVarint(+n)}writeString(n){n=String(n),this.realloc(4*n.length),this.pos++;const e=this.pos;this.pos=(function(o,a,h){for(let d,y,w=0;w<a.length;w++){if(d=a.charCodeAt(w),d>55295&&d<57344){if(!y){d>56319||w+1===a.length?(o[h++]=239,o[h++]=191,o[h++]=189):y=d;continue}if(d<56320){o[h++]=239,o[h++]=191,o[h++]=189,y=d;continue}d=y-55296<<10|d-56320|65536,y=null}else y&&(o[h++]=239,o[h++]=191,o[h++]=189,y=null);d<128?o[h++]=d:(d<2048?o[h++]=d>>6|192:(d<65536?o[h++]=d>>12|224:(o[h++]=d>>18|240,o[h++]=d>>12&63|128),o[h++]=d>>6&63|128),o[h++]=63&d|128)}return h})(this.buf,n,this.pos);const i=this.pos-e;i>=128&&q1(e,i,this),this.pos=e-1,this.writeVarint(i),this.pos+=i}writeFloat(n){this.realloc(4),this.dataView.setFloat32(this.pos,n,!0),this.pos+=4}writeDouble(n){this.realloc(8),this.dataView.setFloat64(this.pos,n,!0),this.pos+=8}writeBytes(n){const e=n.length;this.writeVarint(e),this.realloc(e);for(let i=0;i<e;i++)this.buf[this.pos++]=n[i]}writeRawMessage(n,e){this.pos++;const i=this.pos;n(e,this);const o=this.pos-i;o>=128&&q1(i,o,this),this.pos=i-1,this.writeVarint(o),this.pos+=o}writeMessage(n,e,i){this.writeTag(n,2),this.writeRawMessage(e,i)}writePackedVarint(n,e){e.length&&this.writeMessage(n,TS,e)}writePackedSVarint(n,e){e.length&&this.writeMessage(n,ES,e)}writePackedBoolean(n,e){e.length&&this.writeMessage(n,AS,e)}writePackedFloat(n,e){e.length&&this.writeMessage(n,SS,e)}writePackedDouble(n,e){e.length&&this.writeMessage(n,IS,e)}writePackedFixed32(n,e){e.length&&this.writeMessage(n,CS,e)}writePackedSFixed32(n,e){e.length&&this.writeMessage(n,PS,e)}writePackedFixed64(n,e){e.length&&this.writeMessage(n,RS,e)}writePackedSFixed64(n,e){e.length&&this.writeMessage(n,MS,e)}writeBytesField(n,e){this.writeTag(n,2),this.writeBytes(e)}writeFixed32Field(n,e){this.writeTag(n,5),this.writeFixed32(e)}writeSFixed32Field(n,e){this.writeTag(n,5),this.writeSFixed32(e)}writeFixed64Field(n,e){this.writeTag(n,1),this.writeFixed64(e)}writeSFixed64Field(n,e){this.writeTag(n,1),this.writeSFixed64(e)}writeVarintField(n,e){this.writeTag(n,0),this.writeVarint(e)}writeSVarintField(n,e){this.writeTag(n,0),this.writeSVarint(e)}writeStringField(n,e){this.writeTag(n,2),this.writeString(e)}writeFloatField(n,e){this.writeTag(n,5),this.writeFloat(e)}writeDoubleField(n,e){this.writeTag(n,1),this.writeDouble(e)}writeBooleanField(n,e){this.writeVarintField(n,+e)}};function qp(n,e,i){return i?4294967296*e+(n>>>0):4294967296*(e>>>0)+(n>>>0)}function q1(n,e,i){const o=e<=16383?1:e<=2097151?2:e<=268435455?3:Math.floor(Math.log(e)/(7*Math.LN2));i.realloc(o);for(let a=i.pos-1;a>=n;a--)i.buf[a+o]=i.buf[a]}function TS(n,e){for(let i=0;i<n.length;i++)e.writeVarint(n[i])}function ES(n,e){for(let i=0;i<n.length;i++)e.writeSVarint(n[i])}function SS(n,e){for(let i=0;i<n.length;i++)e.writeFloat(n[i])}function IS(n,e){for(let i=0;i<n.length;i++)e.writeDouble(n[i])}function AS(n,e){for(let i=0;i<n.length;i++)e.writeBoolean(n[i])}function CS(n,e){for(let i=0;i<n.length;i++)e.writeFixed32(n[i])}function PS(n,e){for(let i=0;i<n.length;i++)e.writeSFixed32(n[i])}function RS(n,e){for(let i=0;i<n.length;i++)e.writeFixed64(n[i])}function MS(n,e){for(let i=0;i<n.length;i++)e.writeSFixed64(n[i])}const r0=3;function DS(n,e,i){e.glyphs=[],n===1&&i.readMessage(LS,e)}function LS(n,e,i){if(n===3){const{id:o,bitmap:a,width:h,height:d,left:y,top:w,advance:T}=i.readMessage(kS,{});e.glyphs.push({id:o,bitmap:new pf({width:h+2*r0,height:d+2*r0},a),metrics:{width:h,height:d,left:y,top:w,advance:T}})}else n===4?e.ascender=i.readSVarint():n===5&&(e.descender=i.readSVarint())}function kS(n,e,i){n===1?e.id=i.readVarint():n===2?e.bitmap=i.readBytes():n===3?e.width=i.readVarint():n===4?e.height=i.readVarint():n===5?e.left=i.readSVarint():n===6?e.top=i.readSVarint():n===7&&(e.advance=i.readVarint())}const $1=r0,Pl={horizontal:1,vertical:2,horizontalOnly:3};class Gm{constructor(){this.scale=1,this.fontStack="",this.image=null}static forText(e,i){const o=new Gm;return o.scale=e||1,o.fontStack=i,o}static forImage(e){const i=new Gm;return i.image=e,i}}class $p{constructor(){this.text="",this.sectionIndex=[],this.sections=[],this.imageSectionID=null}static fromFeature(e,i,o){const a=new $p;for(let h=0;h<e.sections.length;h++){const d=e.sections[h];d.image?a.addImageSection(d,o):a.addTextSection(d,i)}return a}length(){return this.text.length}getSection(e){return this.sections[this.sectionIndex[e]]}getSections(){return this.sections}getSectionIndex(e){return this.sectionIndex[e]}getCodePoint(e){return this.text.codePointAt(e)}verticalizePunctuation(e){this.text=(function(i,o){let a="";for(let h=0;h<i.length;h++){const d=i.charCodeAt(h+1)||null,y=i.charCodeAt(h-1)||null;a+=!o&&(d&&Kh(d)&&!jm[i[h+1]]||y&&Kh(y)&&!jm[i[h-1]])||!jm[i[h]]?i[h]:jm[i[h]]}return a})(this.text,e)}trim(){let e=0;for(let o=0;o<this.text.length&&og[this.text.charCodeAt(o)];o++)e++;let i=this.text.length;for(let o=this.text.length-1;o>=0&&o>=e&&og[this.text.charCodeAt(o)];o--)i--;this.text=this.text.substring(e,i),this.sectionIndex=this.sectionIndex.slice(e,i)}substring(e,i){const o=new $p;return o.text=this.text.substring(e,i),o.sectionIndex=this.sectionIndex.slice(e,i),o.sections=this.sections,o}toString(){return this.text}getMaxScale(){return this.sectionIndex.reduce(((e,i)=>Math.max(e,this.sections[i].scale)),0)}addTextSection(e,i){this.text+=e.text,this.sections.push(Gm.forText(e.scale,e.fontStack||i));const o=this.sections.length-1;for(let a=0;a<e.text.length;++a)this.sectionIndex.push(o)}addImageSection(e,i){const o=e.image?e.image.getPrimary():null;if(!o)return void tn("Can't add FormattedSection with an empty image.");o.scaleSelf(i);const a=this.getNextImageSectionCharCode();a?(this.text+=String.fromCodePoint(a),this.sections.push(Gm.forImage(o)),this.sectionIndex.push(this.sections.length-1)):tn("Reached maximum number of images 6401")}getNextImageSectionCharCode(){return this.imageSectionID?this.imageSectionID>=63743?null:++this.imageSectionID:(this.imageSectionID=57344,this.imageSectionID)}}function s0(n,e,i,o,a,h,d,y,w,T,C,P,D,O,N,G=1){const q=$p.fromFeature(n,a,G);P===Pl.vertical&&q.verticalizePunctuation(D);let Y=[];const se=(function(xe,Pe,Me,it,Fe,ot){if(!xe)return[];const Dt=[],ht=(function(Tt,Ve,tt,Lt,Et,li){let Yt=0;for(let vt=0;vt<Tt.length();vt++){const At=Tt.getSection(vt);Yt+=W1(Tt.getCodePoint(vt),At,Lt,Et,Ve,li)}return Yt/Math.max(1,Math.ceil(Yt/tt))})(xe,Pe,Me,it,Fe,ot),bt=xe.text.indexOf("​")>=0;let Rt=0;for(let Tt=0;Tt<xe.length();Tt++){const Ve=xe.getSection(Tt),tt=xe.getCodePoint(Tt);if(og[tt]||(Rt+=W1(tt,Ve,it,Fe,Pe,ot)),Tt<xe.length()-1){const Lt=!((et=tt)<11904||!(fi["Bopomofo Extended"](et)||fi.Bopomofo(et)||fi["CJK Compatibility Forms"](et)||fi["CJK Compatibility Ideographs"](et)||fi["CJK Compatibility"](et)||fi["CJK Radicals Supplement"](et)||fi["CJK Strokes"](et)||fi["CJK Symbols and Punctuation"](et)||fi["CJK Unified Ideographs Extension A"](et)||fi["CJK Unified Ideographs"](et)||fi["Enclosed CJK Letters and Months"](et)||fi["Halfwidth and Fullwidth Forms"](et)||fi.Hiragana(et)||fi["Ideographic Description Characters"](et)||fi["Kangxi Radicals"](et)||fi["Katakana Phonetic Extensions"](et)||fi.Katakana(et)||fi["Vertical Forms"](et)||fi["Yi Radicals"](et)||fi["Yi Syllables"](et)));(zS[tt]||Lt||Ve.image)&&Dt.push(X1(Tt+1,Rt,ht,Dt,FS(tt,xe.getCodePoint(Tt+1),Lt&&bt),!1))}}var et;return K1(X1(xe.length(),Rt,ht,Dt,0,!0))})(q,T,h,e,o,O),{processBidirectionalText:re,processStyledBidirectionalText:ae}=Ra;if(re&&q.sections.length===1){const xe=re(q.toString(),se);for(const Pe of xe){const Me=new $p;Me.text=Pe,Me.sections=q.sections;for(let it=0;it<Pe.length;it++)Me.sectionIndex.push(0);Y.push(Me)}}else if(ae){const xe=ae(q.text,q.sectionIndex,se);for(const Pe of xe){const Me=new $p;Me.text=Pe[0],Me.sectionIndex=Pe[1],Me.sections=q.sections,Y.push(Me)}}else Y=(function(xe,Pe){const Me=[],it=xe.text;let Fe=0;for(const ot of Pe)Me.push(xe.substring(Fe,ot)),Fe=ot;return Fe<it.length&&Me.push(xe.substring(Fe,it.length)),Me})(q,se);const Ee=[],ve={positionedLines:Ee,text:q.toString(),top:C[1],bottom:C[1],left:C[0],right:C[0],writingMode:P,iconsInText:!1,verticalizable:!1,hasBaseline:!1};if((function(xe,Pe,Me,it,Fe,ot,Dt,ht,bt,Rt,et,Tt){let Ve=0,tt=0,Lt=0;const Et=ht==="right"?1:ht==="left"?0:.5;let li=!1;for(const Bt of Fe){const Xt=Bt.getSections();for(const bi of Xt){if(bi.image)continue;const Mi=Pe[bi.fontStack];if(Mi&&(li=Mi.ascender!==void 0&&Mi.descender!==void 0,!li))break}if(!li)break}let Yt=0;for(const Bt of Fe){Bt.trim();const Xt=Bt.getMaxScale(),bi=(Xt-1)*_o,Mi={positionedGlyphs:[],lineOffset:0};xe.positionedLines[Yt]=Mi;const Gi=Mi.positionedGlyphs;let Bi=0;if(!Bt.length()){tt+=ot,++Yt;continue}let mn=0,Qi=0;for(let ue=0;ue<Bt.length();ue++){const he=Bt.getSection(ue),Ye=Bt.getSectionIndex(ue),kt=Bt.getCodePoint(ue);let Ht=he.scale,jt=null,ei=null,Pi=null,an=_o,ln=0,Zi=bt;Zi===Pl.vertical&&((vt=kt)===12312||vt===12313||vt===12316||vt===12540||vt===12448)&&(Zi=Pl.horizontal);const cr=!(Zi===Pl.horizontal||!et&&!Au(kt)||et&&(og[kt]||sh(kt)));if(he.image){const Xr=it.get(he.image.toString());if(!Xr)continue;Pi=he.image,xe.iconsInText=xe.iconsInText||!0,ei=Xr.paddedRect;const $i=Xr.displaySize;Ht=Ht*_o/Tt,jt={width:$i[0],height:$i[1],left:0,top:-$1,advance:cr?$i[1]:$i[0],localGlyph:!1},ln=li?-jt.height*Ht:Xt*_o-17-$i[1]*Ht,an=jt.advance;const Rr=(cr?$i[0]:$i[1])*Ht-_o*Xt;Rr>0&&Rr>Bi&&(Bi=Rr)}else{const Xr=Me[he.fontStack];if(!Xr)continue;Xr[kt]&&(ei=Xr[kt]);const $i=Pe[he.fontStack];if(!$i)continue;const Rr=$i.glyphs[kt];if(!Rr)continue;if(jt=Rr.metrics,an=kt!==8203?_o:0,li){const vr=$i.ascender!==void 0?Math.abs($i.ascender):0,Jn=$i.descender!==void 0?Math.abs($i.descender):0,Wr=(vr+Jn)*Ht;mn<Wr&&(mn=Wr,Qi=(vr-Jn)/2*Ht),ln=-vr*Ht}else ln=(Xt-Ht)*_o-17}cr?(xe.verticalizable=!0,Gi.push({glyph:kt,image:Pi,x:Ve,y:tt+ln,vertical:cr,scale:Ht,localGlyph:jt.localGlyph,fontStack:he.fontStack,sectionIndex:Ye,metrics:jt,rect:ei}),Ve+=an*Ht+Rt):(Gi.push({glyph:kt,image:Pi,x:Ve,y:tt+ln,vertical:cr,scale:Ht,localGlyph:jt.localGlyph,fontStack:he.fontStack,sectionIndex:Ye,metrics:jt,rect:ei}),Ve+=jt.advance*Ht+Rt)}Gi.length!==0&&(Lt=Math.max(Ve-Rt,Lt),li?Y1(Gi,Et,Bi,Qi,ot*Xt/2):Y1(Gi,Et,Bi,0,ot/2)),Ve=0;const Ar=ot*Xt+Bi;Mi.lineOffset=Math.max(Bi,bi),tt+=Ar,++Yt}var vt;const At=tt,{horizontalAlign:ti,verticalAlign:Zt}=o0(Dt);(function(Bt,Xt,bi,Mi,Gi,Bi){const mn=(Xt-bi)*Gi,Qi=-Bi*Mi;for(const Ar of Bt)for(const ue of Ar.positionedGlyphs)ue.x+=mn,ue.y+=Qi})(xe.positionedLines,Et,ti,Zt,Lt,At),xe.top+=-Zt*At,xe.bottom=xe.top+At,xe.left+=-ti*Lt,xe.right=xe.left+Lt,xe.hasBaseline=li})(ve,e,i,o,Y,d,y,w,P,T,D,N),!(function(xe){for(const Pe of xe)if(Pe.positionedGlyphs.length!==0)return!1;return!0})(Ee))return ve}const og={9:!0,10:!0,11:!0,12:!0,13:!0,32:!0},zS={10:!0,32:!0,38:!0,40:!0,41:!0,43:!0,45:!0,47:!0,173:!0,183:!0,8203:!0,8208:!0,8211:!0,8231:!0};function W1(n,e,i,o,a,h){if(e.image){const d=o.get(e.image.toString());return d?d.displaySize[0]*e.scale*_o/h+a:0}{const d=i[e.fontStack],y=d&&d.glyphs[n];return y?y.metrics.advance*e.scale+a:0}}function Z1(n,e,i,o){const a=Math.pow(n-e,2);return o?n<e?a/2:2*a:a+Math.abs(i)*i}function FS(n,e,i){let o=0;return n===10&&(o-=1e4),i&&(o+=150),n!==40&&n!==65288||(o+=50),e!==41&&e!==65289||(o+=50),o}function X1(n,e,i,o,a,h){let d=null,y=Z1(e,i,a,h);for(const w of o){const T=Z1(e-w.x,i,a,h)+w.badness;T<=y&&(d=w,y=T)}return{index:n,x:e,priorBreak:d,badness:y}}function K1(n){return n?K1(n.priorBreak).concat(n.index):[]}function o0(n){let e=.5,i=.5;switch(n){case"right":case"top-right":case"bottom-right":e=1;break;case"left":case"top-left":case"bottom-left":e=0}switch(n){case"bottom":case"bottom-right":case"bottom-left":i=1;break;case"top":case"top-right":case"top-left":i=0}return{horizontalAlign:e,verticalAlign:i}}function Y1(n,e,i,o,a){if(!(e||i||o||a))return;const h=n.length-1,d=n[h],y=(d.x+d.metrics.advance*d.scale)*e;for(let w=0;w<=h;w++)n[w].x-=y,n[w].y+=i+o+a}function Q1(n){return n.imagePrimary!==void 0&&n.top!==void 0&&n.bottom!==void 0&&n.left!==void 0&&n.right!==void 0}function OS(n,e,i,o){const{horizontalAlign:a,verticalAlign:h}=o0(o),d=i[0]-n.displaySize[0]*a,y=i[1]-n.displaySize[1]*h;return{imagePrimary:n,imageSecondary:e,top:y,bottom:y+n.displaySize[1],left:d,right:d+n.displaySize[0]}}function J1(n,e,i,o,a,h){const d=n.imagePrimary;let y;if(d.content){const q=d.content,Y=d.pixelRatio||1;y=[q[0]/Y,q[1]/Y,d.displaySize[0]-q[2]/Y,d.displaySize[1]-q[3]/Y]}const w=e.left*h,T=e.right*h;let C,P,D,O;i==="width"||i==="both"?(O=a[0]+w-o[3],P=a[0]+T+o[1]):(O=a[0]+(w+T-d.displaySize[0])/2,P=O+d.displaySize[0]);const N=e.top*h,G=e.bottom*h;return i==="height"||i==="both"?(C=a[1]+N-o[0],D=a[1]+G+o[2]):(C=a[1]+(N+G-d.displaySize[1])/2,D=C+d.displaySize[1]),{imagePrimary:d,imageSecondary:void 0,top:C,right:P,bottom:D,left:O,collisionPadding:y}}function ew(n){return!n.imagePrimary.stretchX}function tw(n){return!n.imagePrimary.stretchY}function iw(n){return{width:n.right-n.left,height:n.bottom-n.top}}const xh=128;function nw(n,e,i){const{expression:o}=e;if(o.kind==="constant")return{kind:"constant",layoutSize:o.evaluate(new Wn(n+1,{worldview:i}))};if(o.kind==="source")return{kind:"source"};{const{zoomStops:a,interpolationType:h}=o;let d=0;for(;d<a.length&&a[d]<=n;)d++;d=Math.max(0,d-1);let y=d;for(;y<a.length&&a[y]<n+1;)y++;y=Math.min(a.length-1,y);const w=a[d],T=a[y];return o.kind==="composite"?{kind:"composite",minZoom:w,maxZoom:T,interpolationType:h}:{kind:"camera",minZoom:w,maxZoom:T,minSize:o.evaluate(new Wn(w,{worldview:i})),maxSize:o.evaluate(new Wn(T,{worldview:i})),interpolationType:h}}}function a0(n,{uSize:e,uSizeT:i},{lowerSize:o,upperSize:a}){return n.kind==="source"?o/xh:n.kind==="composite"?di(o/xh,a/xh,i):e}function Hm(n,e,i=1){let o=0,a=0;if(n.kind==="constant")a=n.layoutSize*i;else if(n.kind!=="source"){const{interpolationType:h,minZoom:d,maxZoom:y}=n,w=h?de(Ls.interpolationFactor(h,e,d,y),0,1):0;n.kind==="camera"?a=di(n.minSize,n.maxSize,w)*i:o=w*i}return{uSizeT:o,uSize:a}}class dd extends gt{constructor(e,i,o,a,h){super(e,i),this.angle=a,this.z=o,h!==void 0&&(this.segment=h)}clone(){return new dd(this.x,this.y,this.z,this.angle,this.segment)}}function rw(n,e,i,o,a){if(e.segment===void 0)return!0;let h=e,d=e.segment+1,y=0;for(;y>-i/2;){if(d--,d<0)return!1;y-=n[d].dist(h),h=n[d]}y+=n[d].dist(n[d+1]),d++;const w=[];let T=0;for(;y<i/2;){const C=n[d],P=n[d+1];if(!P)return!1;let D=n[d-1].angleTo(C)-C.angleTo(P);for(D=Math.abs((D+3*Math.PI)%(2*Math.PI)-Math.PI),w.push({distance:y,angleDelta:D}),T+=D;y-w[0].distance>o;)T-=w.shift().angleDelta;if(T>a)return!1;d++,y+=C.dist(P)}return!0}function sw(n){let e=0;for(let i=0;i<n.length-1;i++)e+=n[i].dist(n[i+1]);return e}function ow(n,e,i){return n?.6*e*i:0}function aw(n,e){return Math.max(n?n.right-n.left:0,e?e.right-e.left:0)}function BS(n,e,i,o,a,h){const d=ow(i,a,h),y=aw(i,o)*h;let w=0;const T=sw(n)/2;for(let C=0;C<n.length-1;C++){const P=n[C],D=n[C+1],O=P.dist(D);if(w+O>T){const N=(T-w)/O,G=di(P.x,D.x,N),q=di(P.y,D.y,N),Y=new dd(G,q,0,D.angleTo(P),C);return!d||rw(n,Y,y,d,e)?Y:void 0}w+=O}}function NS(n,e,i,o,a,h,d,y,w){const T=ow(o,h,d),C=aw(o,a),P=C*d,D=n[0].x===0||n[0].x===w||n[0].y===0||n[0].y===w;return e-P<e/4&&(e=P+e/4),lw(n,D?e/2*y%e:(C/2+2*h)*d*y%e,e,T,i,P,D,!1,w)}function lw(n,e,i,o,a,h,d,y,w){const T=h/2,C=sw(n);let P=0,D=e-i,O=[];for(let N=0;N<n.length-1;N++){const G=n[N],q=n[N+1],Y=G.dist(q),se=q.angleTo(G);for(;D+i<P+Y;){D+=i;const re=(D-P)/Y,ae=di(G.x,q.x,re),Ee=di(G.y,q.y,re);if(ae>=0&&ae<w&&Ee>=0&&Ee<w&&D-T>=0&&D+T<=C){const ve=new dd(ae,Ee,0,se,N);o&&!rw(n,ve,h,o,a)||O.push(ve)}}P+=Y}return y||O.length||d||(O=lw(n,P/2,i,o,a,h,d,!0,w)),O}function cw(n){let e=0,i=0;for(const d of n)e+=d.w*d.h,i=Math.max(i,d.w);n.sort(((d,y)=>y.h-d.h));const o=[{x:0,y:0,w:Math.max(Math.ceil(Math.sqrt(e/.95)),i),h:1/0}];let a=0,h=0;for(const d of n)for(let y=o.length-1;y>=0;y--){const w=o[y];if(!(d.w>w.w||d.h>w.h)){if(d.x=w.x,d.y=w.y,h=Math.max(h,d.y+d.h),a=Math.max(a,d.x+d.w),d.w===w.w&&d.h===w.h){const T=o.pop();T&&y<o.length&&(o[y]=T)}else d.h===w.h?(w.x+=d.w,w.w-=d.w):d.w===w.w?(w.y+=d.h,w.h-=d.h):(o.push({x:w.x+d.w,y:w.y,w:w.w-d.w,h:d.h}),w.y+=d.h,w.h-=d.h);break}}return{w:a,h,fill:e/(a*h)||0}}Kt(dd,"Anchor");const cp=1;class qm{static getImagePositionScale(e,i,o){if(i&&e&&e.options&&e.options.transform){const a=e.options.transform;return{x:a.a,y:a.d}}return{x:o,y:o}}constructor(e,i,o,a){this.paddedRect=e;const{pixelRatio:h,version:d,stretchX:y,stretchY:w,content:T,sdf:C,usvg:P}=i;this.pixelRatio=h,this.stretchX=y,this.stretchY=w,this.content=T,this.version=d,this.padding=o,this.sdf=C,this.usvg=P,this.scale=qm.getImagePositionScale(a,P,h)}get tl(){return[this.paddedRect.x+this.padding,this.paddedRect.y+this.padding]}get br(){return[this.paddedRect.x+this.paddedRect.w-this.padding,this.paddedRect.y+this.paddedRect.h-this.padding]}get displaySize(){return[(this.paddedRect.w-2*this.padding)/this.scale.x,(this.paddedRect.h-2*this.padding)/this.scale.y]}}function l0(n,e,i){const o=vi.parse(n),a=(function(h,d,y=[1,1]){return{x:0,y:0,w:(h.data?h.data.width:h.width*y[0])+2*d,h:(h.data?h.data.height:h.height*y[1])+2*d}})(e,i,[o.options.transform.a,o.options.transform.d]);return{bin:a,imagePosition:new qm(a,e,i,o),imageVariant:o}}class uw{constructor(e,i,o){const a=new Map,h=new Map;this.haveRenderCallbacks=[];const d=[];this.addImages(e,a,cp,d),this.addImages(i,h,2,d);const{w:y,h:w}=cw(d),T=new ko({width:y||1,height:w||1});for(const[C,P]of e.entries()){const D=a.get(C).paddedRect;ko.copy(P.data,T,{x:0,y:0},{x:D.x+cp,y:D.y+cp},P.data,o,P.sdf)}for(const[C,P]of i.entries()){const D=h.get(C),O=D.paddedRect;let N=D.padding;const G=O.x+N,q=O.y+N,Y=P.data.width,se=P.data.height;N=N>1?N-1:N,ko.copy(P.data,T,{x:0,y:0},{x:G,y:q},P.data,o),ko.copy(P.data,T,{x:0,y:se-N},{x:G,y:q-N},{width:Y,height:N},o),ko.copy(P.data,T,{x:0,y:0},{x:G,y:q+se},{width:Y,height:N},o),ko.copy(P.data,T,{x:Y-N,y:0},{x:G-N,y:q},{width:N,height:se},o),ko.copy(P.data,T,{x:0,y:0},{x:G+Y,y:q},{width:N,height:se},o),ko.copy(P.data,T,{x:Y-N,y:se-N},{x:G-N,y:q-N},{width:N,height:N},o),ko.copy(P.data,T,{x:0,y:se-N},{x:G+Y,y:q-N},{width:N,height:N},o),ko.copy(P.data,T,{x:0,y:0},{x:G+Y,y:q+se},{width:N,height:N},o),ko.copy(P.data,T,{x:Y-N,y:0},{x:G-N,y:q+se},{width:N,height:N},o)}this.lut=o,this.image=T,this.iconPositions=a,this.patternPositions=h}addImages(e,i,o,a){for(const[h,d]of e.entries()){const{bin:y,imagePosition:w,imageVariant:T}=l0(h,d,o);i.set(h,w),a.push(y),d.hasRenderCallback&&this.haveRenderCallbacks.push(T.id)}}patchUpdatedImages(e,i,o){this.haveRenderCallbacks=this.haveRenderCallbacks.filter((a=>e.hasImage(a,o))),e.dispatchRenderCallbacks(this.haveRenderCallbacks,o);for(const a of e.getUpdatedImages(o)){for(const h of this.iconPositions.keys()){const d=vi.parse(h);if(Js.isEqual(d.id,a)){const y=e.getImage(a,o);this.patchUpdatedImage(this.iconPositions.get(h),y,i)}}for(const h of this.patternPositions.keys()){const d=vi.parse(h);if(Js.isEqual(d.id,a)){const y=e.getImage(a,o);this.patchUpdatedImage(this.patternPositions.get(h),y,i)}}}}patchUpdatedImage(e,i,o){if(!e||!i||e.version===i.version)return;e.version=i.version;const[a,h]=e.tl,d=e.sdf;if(this.lut||d){const y={width:i.data.width,height:i.data.height},w=new ko(y);ko.copy(i.data,w,{x:0,y:0},{x:0,y:0},y,this.lut,d),o.update(w,{position:{x:a,y:h}})}else o.update(i.data,{position:{x:a,y:h}})}}Kt(qm,"ImagePosition"),Kt(uw,"ImageAtlas");const $m=1e20;function hw(n,e,i,o,a,h,d,y,w){for(let T=e;T<e+o;T++)dw(n,i*h+T,h,a,d,y,w);for(let T=i;T<i+a;T++)dw(n,T*h+e,1,o,d,y,w)}function dw(n,e,i,o,a,h,d){h[0]=0,d[0]=-$m,d[1]=$m,a[0]=n[e];for(let y=1,w=0,T=0;y<o;y++){a[y]=n[e+y*i];const C=y*y;do{const P=h[w];T=(a[y]-a[P]+C-P*P)/(y-P)/2}while(T<=d[w]&&--w>-1);w++,h[w]=y,d[w]=T,d[w+1]=$m}for(let y=0,w=0;y<o;y++){for(;d[w+1]<y;)w++;const T=h[w],C=y-T;n[e+y*i]=a[T]+C*C}}const Nu=2,c0={none:0,ideographs:1,all:2};class Wp{constructor(e,i,o){this.requestManager=e,this.localGlyphMode=i,this.localFontFamily=o,this.url="",this.entries={},this.localGlyphs={200:{},400:{},500:{},900:{}}}setURL(e){this.url=e}getGlyphs(e,i){const o=[],a=this.url||ws.GLYPHS_URL;for(const h in e)for(const d of e[h])o.push({stack:h,id:d});Re(o,(({stack:h,id:d},y)=>{let w=this.entries[h];w||(w=this.entries[h]={glyphs:{},requests:{},ranges:{},ascender:void 0,descender:void 0});let T=w.glyphs[d];if(T!==void 0)return void y(null,{stack:h,id:d,glyph:T});if(T=this._tinySDF(w,h,d),T)return w.glyphs[d]=T,void y(null,{stack:h,id:d,glyph:T});const C=Math.floor(d/256);if(256*C>65535)return tn("glyphs > 65535 not supported"),void y(null,{stack:h,id:d,glyph:T});if(w.ranges[C])return void y(null,{stack:h,id:d,glyph:T});let P=w.requests[C];P||(P=w.requests[C]=[],Wp.loadGlyphRange(h,C,a,this.requestManager,((D,O)=>{if(O){w.ascender=O.ascender,w.descender=O.descender;for(const N in O.glyphs)this._doesCharSupportLocalGlyph(+N)||(w.glyphs[+N]=O.glyphs[+N]);w.ranges[C]=!0}for(const N of P)N(D,O);delete w.requests[C]}))),P.push(((D,O)=>{D?y(D):O&&y(null,{stack:h,id:d,glyph:O.glyphs[d]||null})}))}),((h,d)=>{if(h)i(h);else if(d){const y={};for(const{stack:w,id:T,glyph:C}of d)y[w]===void 0&&(y[w]={}),y[w].glyphs===void 0&&(y[w].glyphs={}),y[w].glyphs[T]=C&&{id:C.id,bitmap:C.bitmap.clone(),metrics:C.metrics},y[w].ascender=this.entries[w].ascender,y[w].descender=this.entries[w].descender;i(null,y)}}))}_doesCharSupportLocalGlyph(e){return this.localGlyphMode!==c0.none&&(this.localGlyphMode===c0.all?!!this.localFontFamily:!!this.localFontFamily&&(fi["CJK Unified Ideographs"](e)||fi["Hangul Syllables"](e)||fi.Hiragana(e)||fi.Katakana(e)||fi["CJK Symbols and Punctuation"](e)||fi["CJK Unified Ideographs Extension A"](e)||fi["CJK Unified Ideographs Extension B"](e)||fi.Osage(e)))}_tinySDF(e,i,o){const a=this.localFontFamily;if(!a||!this._doesCharSupportLocalGlyph(o))return;let h=e.tinySDF;if(!h){let G="400";/bold/i.test(i)?G="900":/medium/i.test(i)?G="500":/light/i.test(i)&&(G="200"),h=e.tinySDF=new Wp.TinySDF({fontFamily:a,fontWeight:G,fontSize:24*Nu,buffer:3*Nu,radius:8*Nu}),h.fontWeight=G}if(this.localGlyphs[h.fontWeight][o])return this.localGlyphs[h.fontWeight][o];const d=String.fromCodePoint(o),{data:y,width:w,height:T,glyphWidth:C,glyphHeight:P,glyphLeft:D,glyphTop:O,glyphAdvance:N}=h.draw(d);return this.localGlyphs[h.fontWeight][o]={id:o,bitmap:new pf({width:w,height:T},y),metrics:{width:C/Nu,height:P/Nu,left:D/Nu,top:O/Nu-27,advance:N/Nu,localGlyph:!0}}}}Wp.loadGlyphRange=function(n,e,i,o,a){const h=256*e,d=h+255,y=o.transformRequest(o.normalizeGlyphsURL(i).replace("{fontstack}",n).replace("{range}",`${h}-${d}`),ea.Glyphs);ru(y,((w,T)=>{if(w)a(w);else if(T){const C={},P=(function(D){return new sg(D).readFields(DS,{})})(T);for(const D of P.glyphs)C[D.id]=D;a(null,{glyphs:C,ascender:P.ascender,descender:P.descender})}}))},Wp.TinySDF=class{constructor({fontSize:n=24,buffer:e=3,radius:i=8,cutoff:o=.25,fontFamily:a="sans-serif",fontWeight:h="normal",fontStyle:d="normal"}={}){this.buffer=e,this.cutoff=o,this.radius=i;const y=this.size=n+4*e,w=this._createCanvas(y),T=this.ctx=w.getContext("2d",{willReadFrequently:!0});T.font=`${d} ${h} ${n}px ${a}`,T.textBaseline="alphabetic",T.textAlign="left",T.fillStyle="black",this.gridOuter=new Float64Array(y*y),this.gridInner=new Float64Array(y*y),this.f=new Float64Array(y),this.z=new Float64Array(y+1),this.v=new Uint16Array(y)}_createCanvas(n){const e=document.createElement("canvas");return e.width=e.height=n,e}draw(n){const{width:e,actualBoundingBoxAscent:i,actualBoundingBoxDescent:o,actualBoundingBoxLeft:a,actualBoundingBoxRight:h}=this.ctx.measureText(n),d=Math.ceil(i),y=Math.max(0,Math.min(this.size-this.buffer,Math.ceil(h-a))),w=Math.min(this.size-this.buffer,d+Math.ceil(o)),T=y+2*this.buffer,C=w+2*this.buffer,P=Math.max(T*C,0),D=new Uint8ClampedArray(P),O={data:D,width:T,height:C,glyphWidth:y,glyphHeight:w,glyphTop:d,glyphLeft:0,glyphAdvance:e};if(y===0||w===0)return O;const{ctx:N,buffer:G,gridInner:q,gridOuter:Y}=this;N.clearRect(G,G,y,w),N.fillText(n,G,G+d);const se=N.getImageData(G,G,y,w);Y.fill($m,0,P),q.fill(0,0,P);for(let re=0;re<w;re++)for(let ae=0;ae<y;ae++){const Ee=se.data[4*(re*y+ae)+3]/255;if(Ee===0)continue;const ve=(re+G)*T+ae+G;if(Ee===1)Y[ve]=0,q[ve]=$m;else{const xe=.5-Ee;Y[ve]=xe>0?xe*xe:0,q[ve]=xe<0?xe*xe:0}}hw(Y,0,0,T,C,T,this.f,this.v,this.z),hw(q,G,G,y,w,T,this.f,this.v,this.z);for(let re=0;re<P;re++){const ae=Math.sqrt(Y[re])-Math.sqrt(q[re]);D[re]=Math.round(255-255*(ae/this.radius+this.cutoff))}return O}};const gf=cp;function fw(n,e){return n+e[1]-e[0]}function pw(n,e,i,o,a=1){const h=[],d=n.imagePrimary,y=d.pixelRatio,w=d.paddedRect.w-2*gf,T=d.paddedRect.h-2*gf,C=(n.right-n.left)*a,P=(n.bottom-n.top)*a,D=d.stretchX||[[0,w]],O=d.stretchY||[[0,T]],N=D.reduce(fw,0),G=O.reduce(fw,0),q=w-N,Y=T-G;let se=0,re=N,ae=0,Ee=G,ve=0,xe=q,Pe=0,Me=Y;if(d.content&&o){const Fe=d.content;se=ag(D,0,Fe[0]),ae=ag(O,0,Fe[1]),re=ag(D,Fe[0],Fe[2]),Ee=ag(O,Fe[1],Fe[3]),ve=Fe[0]-se,Pe=Fe[1]-ae,xe=Fe[2]-Fe[0]-re,Me=Fe[3]-Fe[1]-Ee}const it=(Fe,ot,Dt,ht)=>{const bt=lg(Fe.stretch-se,re,C,n.left*a),Rt=cg(Fe.fixed-ve,xe,Fe.stretch,N),et=lg(ot.stretch-ae,Ee,P,n.top*a),Tt=cg(ot.fixed-Pe,Me,ot.stretch,G),Ve=lg(Dt.stretch-se,re,C,n.left*a),tt=cg(Dt.fixed-ve,xe,Dt.stretch,N),Lt=lg(ht.stretch-ae,Ee,P,n.top*a),Et=cg(ht.fixed-Pe,Me,ht.stretch,G),li=new gt(bt,et),Yt=new gt(Ve,et),vt=new gt(Ve,Lt),At=new gt(bt,Lt),ti=new gt(Rt/y,Tt/y),Zt=new gt(tt/y,Et/y),Bt=e*Math.PI/180;if(Bt){const mn=Math.sin(Bt),Qi=Math.cos(Bt),Ar=[Qi,-mn,mn,Qi];li._matMult(Ar),Yt._matMult(Ar),At._matMult(Ar),vt._matMult(Ar)}const Xt=Fe.stretch+Fe.fixed,bi=Dt.stretch+Dt.fixed,Mi=ot.stretch+ot.fixed,Gi=ht.stretch+ht.fixed,Bi=n.imageSecondary;return{tl:li,tr:Yt,bl:At,br:vt,texPrimary:{x:d.paddedRect.x+gf+Xt,y:d.paddedRect.y+gf+Mi,w:bi-Xt,h:Gi-Mi},texSecondary:Bi?{x:Bi.paddedRect.x+gf+Xt,y:Bi.paddedRect.y+gf+Mi,w:bi-Xt,h:Gi-Mi}:void 0,writingMode:void 0,glyphOffset:[0,0],sectionIndex:0,pixelOffsetTL:ti,pixelOffsetBR:Zt,minFontScaleX:xe/y/C,minFontScaleY:Me/y/P,isSDF:i}};if(o&&(d.stretchX||d.stretchY)){const Fe=mw(D,q,N),ot=mw(O,Y,G);for(let Dt=0;Dt<Fe.length-1;Dt++){const ht=Fe[Dt],bt=Fe[Dt+1];for(let Rt=0;Rt<ot.length-1;Rt++)h.push(it(ht,ot[Rt],bt,ot[Rt+1]))}}else h.push(it({fixed:0,stretch:-1},{fixed:0,stretch:-1},{fixed:0,stretch:w+1},{fixed:0,stretch:T+1}));return h}function ag(n,e,i){let o=0;for(const a of n)o+=Math.max(e,Math.min(i,a[1]))-Math.max(e,Math.min(i,a[0]));return o}function mw(n,e,i){const o=[{fixed:-gf,stretch:0}];for(const[a,h]of n){const d=o[o.length-1];o.push({fixed:a-d.stretch,stretch:d.stretch}),o.push({fixed:a-d.stretch,stretch:d.stretch+(h-a)})}return o.push({fixed:e+gf,stretch:i}),o}function lg(n,e,i,o){return n/e*i+o}function cg(n,e,i,o){return n-e*i/o}function VS(n,e,i,o){const a=e+n.positionedLines[o].lineOffset;return o===0?i+a/2:i+(a+(e+n.positionedLines[o-1].lineOffset))/2}function US(n,e=1,i=!1){let o=1/0,a=1/0,h=-1/0,d=-1/0;const y=n[0];for(let O=0;O<y.length;O++){const N=y[O];(!O||N.x<o)&&(o=N.x),(!O||N.y<a)&&(a=N.y),(!O||N.x>h)&&(h=N.x),(!O||N.y>d)&&(d=N.y)}const w=Math.min(h-o,d-a);let T=w/2;const C=new $u([],jS);if(w===0)return new gt(o,a);for(let O=o;O<h;O+=w)for(let N=a;N<d;N+=w)C.push(new Zp(O+T,N+T,T,n));let P=(function(O){let N=0,G=0,q=0;const Y=O[0];for(let se=0,re=Y.length,ae=re-1;se<re;ae=se++){const Ee=Y[se],ve=Y[ae],xe=Ee.x*ve.y-ve.x*Ee.y;G+=(Ee.x+ve.x)*xe,q+=(Ee.y+ve.y)*xe,N+=3*xe}return new Zp(G/N,q/N,0,O)})(n),D=C.length;for(;C.length;){const O=C.pop();(O.d>P.d||!P.d)&&(P=O,i&&console.log("found best %d after %d probes",Math.round(1e4*O.d)/1e4,D)),O.max-P.d<=e||(T=O.h/2,C.push(new Zp(O.p.x-T,O.p.y-T,T,n)),C.push(new Zp(O.p.x+T,O.p.y-T,T,n)),C.push(new Zp(O.p.x-T,O.p.y+T,T,n)),C.push(new Zp(O.p.x+T,O.p.y+T,T,n)),D+=4)}return i&&(console.log(`num probes: ${D}`),console.log(`best distance: ${P.d}`)),P.p}function jS(n,e){return e.max-n.max}class Zp{constructor(e,i,o,a){this.p=new gt(e,i),this.h=o,this.d=(function(h,d){let y=!1,w=1/0;for(let T=0;T<d.length;T++){const C=d[T];for(let P=0,D=C.length,O=D-1;P<D;O=P++){const N=C[P],G=C[O];N.y>h.y!=G.y>h.y&&h.x<(G.x-N.x)*(h.y-N.y)/(G.y-N.y)+N.x&&(y=!y),w=Math.min(w,Wo(h,N,G))}}return(y?1:-1)*Math.sqrt(w)})(this.p,a),this.max=this.d+this.h*Math.SQRT2}}const GS=Object.keys,u0=Number.POSITIVE_INFINITY,HS=Math.sqrt(2);function _w(n,[e,i]){let o=0,a=0;if(i===u0){e<0&&(e=0);const h=e/HS;switch(n){case"top-right":case"top-left":a=h-7;break;case"bottom-right":case"bottom-left":a=7-h;break;case"bottom":a=7-e;break;case"top":a=e-7}switch(n){case"top-right":case"bottom-right":o=-h;break;case"top-left":case"bottom-left":o=h;break;case"left":o=e;break;case"right":o=-e}}else{switch(e=Math.abs(e),i=Math.abs(i),n){case"top-right":case"top-left":case"top":a=i-7;break;case"bottom-right":case"bottom-left":case"bottom":a=7-i}switch(n){case"top-right":case"bottom-right":case"right":o=-e;break;case"top-left":case"bottom-left":case"left":o=e}}return[o,a]}function ug(n,e,i,o,a,h,d,y,w){if(!e||!e.usvg)return;const T=iw(o),C=iw(a),P=h!=="both"&&h!=="width"||!ew(o)?1:C.width/T.width,D=h!=="both"&&h!=="height"||!tw(o)?1:C.height/T.height;i.scaleSelf(P,D);const O=i.toString();d.set(O,i),y.set(O,e);const{imagePosition:N}=l0(O,e,cp);w.set(O,N)}function gw(n,e,i,o,a,h,d,y,w){if(!n)return;const T=(function(C,P,D,O,N,G){if(C.kind==="camera")return C.maxSize;if(C.kind==="composite"){const q=P.possiblyEvaluate(new Wn(C.maxZoom,{worldview:G}),D).evaluate(N,{},D),Y=P.possiblyEvaluate(new Wn(C.minZoom,{worldview:G}),D).evaluate(N,{},D);return Math.max(q,Y)}return P.possiblyEvaluate(new Wn(O,{worldview:G})).evaluate(N,{},D)})(e,i,o,a,h,w);return n.scaleSelf(T*y*d)}function yw(n,e,i,o,a,h,d,y,w){return{iconPrimary:gw(n.getPrimary(),e,i,o,a,h,d,y,w),iconSecondary:gw(n.getSecondary(),e,i,o,a,h,d,y,w)}}function qS(n,e,i){if(!e)return;const o=i.get(n.toString()),a=i.get(e.toString());a&&(o.paddedRect.w===a.paddedRect.w&&o.paddedRect.h===a.paddedRect.h||tn(`Mismatch in icon variant sizes: ${n.toString()} and ${e.toString()}`),o.usvg!==a.usvg&&tn(`Mismatch in icon variant image types: ${n.id} and ${e.id}`))}function vw(n,e,i,o){if(!n)return;const a=e.get(i.toString());if(n.imagePrimary=a,o){const h=e.get(o.toString());n.imageSecondary=h}}function $S(n,e){for(const i in n.horizontal)xw(n.horizontal[i],e);xw(n.vertical,e)}function xw(n,e){if(n){for(const i of n.positionedLines)for(const o of i.positionedGlyphs)if(o.image!==null){const a=o.image.toString();o.rect=e.get(a).paddedRect}}}function h0(n){switch(n){case"right":case"top-right":case"bottom-right":return"right";case"left":case"top-left":case"bottom-left":return"left"}return"center"}function WS(n,e,i,o,a,h,d,y,w){const T=d0(h.horizontal)||h.vertical,C=i.get("icon-text-fit-padding").evaluate(o,{},a);let P,D=e;return e&&w!=="none"&&(n.allowVerticalPlacement&&h.vertical&&(P=J1(e,h.vertical,w,C,y,d)),T&&(D=J1(e,T,w,C,y,d))),{defaultShapedIcon:D,verticallyShapedIcon:P}}function ZS(n,e,i,o,a,h,d,y,w,T,C,P,D,O,N,G,q,Y,se,re){let ae=d.textMaxSize.evaluate(e,{},D);ae===void 0?ae=y*d.textScaleFactor:ae*=d.textScaleFactor;const Ee=n.layers[0].layout,ve=d0(i.horizontal)||i.vertical,xe=O.name==="globe",Pe=_o,Me=n.tilePixelRatio*ae/Pe,it=(Rt=n.overscaling,n.zoom>18&&Rt>2&&(Rt>>=1),Math.max(zt/(512*Rt),1)*Ee.get("symbol-spacing")),Fe=Ee.get("text-padding")*n.tilePixelRatio,ot=Ee.get("icon-padding")*n.tilePixelRatio,Dt=vn(Ee.get("text-max-angle")),ht=Ee.get("icon-rotation-alignment")==="map"&&re!=="point",bt=it/2;var Rt;n.hasAnyIconTextFit===!1&&q!=="none"&&(n.hasAnyIconTextFit=!0);const et=e.properties?+e.properties[qt]:null,Tt=et&&n.elevationFeatureIdToIndex?n.elevationFeatureIdToIndex.get(et):65535,Ve=(tt,Lt,Et)=>{if(Lt.x<0||Lt.x>=zt||Lt.y<0||Lt.y>=zt)return;let li=null;if(xe){const{x:Yt,y:vt,z:At}=O.projectTilePoint(Lt.x,Lt.y,Et);li={anchor:new dd(Yt,vt,At,0,void 0),up:O.upVector(Et,Lt.x,Lt.y)}}(function(Yt,vt,At,ti,Zt,Bt,Xt,bi,Mi,Gi,Bi,mn,Qi,Ar,ue,he,Ye,kt,Ht,jt,ei,Pi,an,ln,Zi,cr,Xr,$i,Rr){const vr=Yt.addToLineVertexArray(vt,ti);let Jn,Wr,Cr,xr,Er,or,Xi,ur=0,Zr=0,Ii=0,Cn=0,Pr=-1,Qr=-1;const Mr={};let Ps=ul("");const mr=At?At.anchor:vt,As=$i!=="none";let tl=0,zo=0;if(Mi._unevaluatedLayout.getValue("text-radial-offset")===void 0){const Rs=Mi.layout.get("text-offset").evaluate(ei,{},Zi);tl=Rs[0]*_o,zo=Rs[1]*_o}else tl=Mi.layout.get("text-radial-offset").evaluate(ei,{},Zi)*_o,zo=u0;if(Yt.allowVerticalPlacement&&Zt.vertical){const Rs=Zt.vertical;if(ue)or=f0(Rs),bi&&(Xi=f0(bi));else{const Ws=Mi.layout.get("text-rotate").evaluate(ei,{},Zi)+90;Cr=hg(Gi,mr,vt,Bi,mn,Qi,Rs,Ar,Ws,he),bi&&(xr=hg(Gi,mr,vt,Bi,mn,Qi,bi,kt,Ws))}}if(Bt){const Rs=Yt.iconSizeData,Ws=Mi.layout.get("icon-rotate").evaluate(ei,{},Zi),Fo=pw(Bt,Ws,an,As,Pi.iconScaleFactor),ua=bi?pw(bi,Ws,an,As,Pi.iconScaleFactor):void 0;Wr=hg(Gi,mr,vt,Bi,mn,Qi,Bt,kt,Ws,null),ur=4*Fo.length;let Zo=null;Rs.kind==="source"?(Zo=[xh*Mi.layout.get("icon-size").evaluate(ei,{},Zi)*Pi.iconScaleFactor],Zo[0]>yf&&tn(`${Yt.layerIds[0]}: Value for "icon-size" is >= ${Wm}. Reduce your "icon-size".`)):Rs.kind==="composite"&&(Zo=[xh*Pi.compositeIconSizes[0].evaluate(ei,{},Zi)*Pi.iconScaleFactor,xh*Pi.compositeIconSizes[1].evaluate(ei,{},Zi)*Pi.iconScaleFactor],(Zo[0]>yf||Zo[1]>yf)&&tn(`${Yt.layerIds[0]}: Value for "icon-size" is >= ${Wm}. Reduce your "icon-size".`)),Yt.addSymbols(Yt.icon,Fo,Zo,jt,Ht,ei,void 0,At,vt,vr.lineStartIndex,vr.lineLength,-1,ln,Zi,cr,Xr),Pr=Yt.icon.placedSymbolArray.length-1,ua&&(Zr=4*ua.length,Yt.addSymbols(Yt.icon,ua,Zo,jt,Ht,ei,Pl.vertical,At,vt,vr.lineStartIndex,vr.lineLength,-1,ln,Zi,cr,Xr),Qr=Yt.icon.placedSymbolArray.length-1)}for(const Rs in Zt.horizontal){const Ws=Rs,Fo=Zt.horizontal[Ws];Jn||(Ps=ul(Fo.text),ue?Er=f0(Fo):Jn=hg(Gi,mr,vt,Bi,mn,Qi,Fo,Ar,Mi.layout.get("text-rotate").evaluate(ei,{},Zi),he));const ua=Fo.positionedLines.length===1;if(Ii+=ww(Yt,At,vt,Fo,Xt,Mi,ue,ei,he,vr,Zt.vertical?Pl.horizontal:Pl.horizontalOnly,ua?GS(Zt.horizontal):[Ws],Mr,Pr,Pi,ln,Zi,cr),ua)break}Zt.vertical&&(Cn+=ww(Yt,At,vt,Zt.vertical,Xt,Mi,ue,ei,he,vr,Pl.vertical,["vertical"],Mr,Qr,Pi,ln,Zi,cr));let To=-1;const il=(Rs,Ws)=>Rs?Math.max(Rs,Ws):Ws;To=il(Er,To),To=il(or,To),To=il(Xi,To);const wh=To>-1?1:0;Yt.glyphOffsetArray.length>=65535&&tn("Too many glyphs being rendered in a tile. See https://github.com/mapbox/mapbox-gl-js/issues/2907"),ei.sortKey!==void 0&&Yt.addToSortKeyRanges(Yt.symbolInstances.length,ei.sortKey),Yt.symbolInstances.emplaceBack(vt.x,vt.y,mr.x,mr.y,mr.z,Mr.right>=0?Mr.right:-1,Mr.center>=0?Mr.center:-1,Mr.left>=0?Mr.left:-1,Mr.vertical>=0?Mr.vertical:-1,Pr,Qr,Ps,Jn!==void 0?Jn:Yt.collisionBoxArray.length,Jn!==void 0?Jn+1:Yt.collisionBoxArray.length,Cr!==void 0?Cr:Yt.collisionBoxArray.length,Cr!==void 0?Cr+1:Yt.collisionBoxArray.length,Wr!==void 0?Wr:Yt.collisionBoxArray.length,Wr!==void 0?Wr+1:Yt.collisionBoxArray.length,xr||Yt.collisionBoxArray.length,xr?xr+1:Yt.collisionBoxArray.length,Bi,Ii,Cn,ur,Zr,wh,0,tl,zo,To,0,As?1:0,Rr)})(n,Lt,li,tt,i,o,h,a,n.layers[0],n.collisionBoxArray,e.index,e.sourceLayerIndex,n.index,Fe,se,T,0,ot,ht,Y,e,d,C,P,D,N,G,q,Tt)};if(re==="line")for(const tt of Y_(e.geometry,0,0,zt,zt)){const Lt=NS(tt,it,Dt,i.vertical||ve,o,Pe,Me,n.overscaling,zt);for(const Et of Lt)ve&&XS(n,ve.text,bt,Et)||Ve(tt,Et,D)}else if(re==="line-center"){for(const tt of e.geometry)if(tt.length>1){const Lt=BS(tt,Dt,i.vertical||ve,o,Pe,Me);Lt&&Ve(tt,Lt,D)}}else if(e.type==="Polygon")for(const tt of Pm(e.geometry,0)){const Lt=US(tt,16);Ve(tt[0],new dd(Lt.x,Lt.y,0,0,void 0),D)}else if(e.type==="LineString")for(const tt of e.geometry)Ve(tt,new dd(tt[0].x,tt[0].y,0,0,void 0),D);else if(e.type==="Point")for(const tt of e.geometry)for(const Lt of tt)Ve([Lt],new dd(Lt.x,Lt.y,0,0,void 0),D)}const Wm=255,yf=Wm*xh;function ww(n,e,i,o,a,h,d,y,w,T,C,P,D,O,N,G,q,Y){const se=(function(Ee,ve,xe,Pe,Me,it,Fe,ot){const Dt=[];if(ve.positionedLines.length===0)return Dt;const ht=Pe.layout.get("text-rotate").evaluate(it,{})*Math.PI/180,bt=(function(tt){const Lt=tt[0],Et=tt[1],li=Lt*Et;return li>0?[Lt,-Et]:li<0?[-Lt,Et]:Lt===0?[Et,Lt]:[Et,-Lt]})(xe);let Rt=Math.abs(ve.top-ve.bottom);for(const tt of ve.positionedLines)Rt-=tt.lineOffset;const et=ve.positionedLines.length,Tt=Rt/et;let Ve=ve.top-xe[1];for(let tt=0;tt<et;++tt){const Lt=ve.positionedLines[tt];Ve=VS(ve,Tt,Ve,tt);for(const Et of Lt.positionedGlyphs){if(!Et.rect)continue;const li=Et.rect||{};let Yt=$1+1,vt=!0,At=1,ti=0;if(Et.image){const ei=Fe.get(Et.image.toString());if(!ei)continue;if(ei.sdf){tn("SDF images are not supported in formatted text and will be ignored.");continue}vt=!1,At=ei.pixelRatio,Yt=cp/At}const Zt=(Me||ot)&&Et.vertical,Bt=Et.metrics.advance*Et.scale/2,Xt=Et.metrics,bi=Et.rect;if(bi===null)continue;ot&&ve.verticalizable&&(ti=Et.image?Bt-Et.metrics.width*Et.scale/2:0);const Mi=Me?[Et.x+Bt,Et.y]:[0,0];let Gi=[0,0],Bi=[0,0],mn=!1;Me||(Zt?(Bi=[Et.x+Bt+bt[0],Et.y+bt[1]-ti],mn=!0):Gi=[Et.x+Bt+xe[0],Et.y+xe[1]-ti]);const Qi=bi.w*Et.scale/(At*(Et.localGlyph?Nu:1)),Ar=bi.h*Et.scale/(At*(Et.localGlyph?Nu:1));let ue,he,Ye,kt;if(Zt){const ei=Et.y-Ve,Pi=new gt(-Bt,Bt-ei),an=-Math.PI/2,ln=new gt(...Bi);ue=new gt(-Bt+Gi[0],Gi[1]),ue._rotateAround(an,Pi)._add(ln),ue.x+=-ei+Bt,ue.y-=(Xt.left-Yt)*Et.scale;const Zi=Et.image?Xt.advance*Et.scale:_o*Et.scale,cr=String.fromCodePoint(Et.glyph);wS(cr)?ue.x+=(1-Yt)*Et.scale:bS(cr)?ue.x+=Zi-Xt.height*Et.scale+(-Yt-1)*Et.scale:ue.x+=Et.image||Xt.width+2*Yt===bi.w&&Xt.height+2*Yt===bi.h?(Zi-Ar)/2:(Zi-(Xt.height+2*Yt)*Et.scale)/2,he=new gt(ue.x,ue.y-Qi),Ye=new gt(ue.x+Ar,ue.y),kt=new gt(ue.x+Ar,ue.y-Qi)}else{const ei=(Xt.left-Yt)*Et.scale-Bt+Gi[0],Pi=(-Xt.top-Yt)*Et.scale+Gi[1],an=ei+Qi,ln=Pi+Ar;ue=new gt(ei,Pi),he=new gt(an,Pi),Ye=new gt(ei,ln),kt=new gt(an,ln)}if(ht){let ei;ei=Me?new gt(0,0):mn?new gt(bt[0],bt[1]):new gt(xe[0],xe[1]),ue._rotateAround(ht,ei),he._rotateAround(ht,ei),Ye._rotateAround(ht,ei),kt._rotateAround(ht,ei)}const Ht=new gt(0,0),jt=new gt(0,0);Dt.push({tl:ue,tr:he,bl:Ye,br:kt,texPrimary:li,texSecondary:void 0,writingMode:ve.writingMode,glyphOffset:Mi,sectionIndex:Et.sectionIndex,isSDF:vt,pixelOffsetTL:Ht,pixelOffsetBR:jt,minFontScaleX:0,minFontScaleY:0})}}return Dt})(0,o,w,h,d,y,a,n.allowVerticalPlacement),re=n.textSizeData;let ae=null;re.kind==="source"?(ae=[xh*h.layout.get("text-size").evaluate(y,{},q)*N.textScaleFactor],ae[0]>yf&&tn(`${n.layerIds[0]}: Value for "text-size" is >= ${Wm}. Reduce your "text-size".`)):re.kind==="composite"&&(ae=[xh*N.compositeTextSizes[0].evaluate(y,{},q)*N.textScaleFactor,xh*N.compositeTextSizes[1].evaluate(y,{},q)*N.textScaleFactor],(ae[0]>yf||ae[1]>yf)&&tn(`${n.layerIds[0]}: Value for "text-size" is >= ${Wm}. Reduce your "text-size".`)),n.addSymbols(n.text,se,ae,w,d,y,C,e,i,T.lineStartIndex,T.lineLength,O,G,q,Y,!1);for(const Ee of P)D[Ee]=n.text.placedSymbolArray.length-1;return 4*se.length}function d0(n){for(const e in n)return n[e];return null}function hg(n,e,i,o,a,h,d,y,w,T){let C=d.top,P=d.bottom,D=d.left,O=d.right;if(Q1(d)&&d.collisionPadding){const N=d.collisionPadding;D-=N[0],C-=N[1],O+=N[2],P+=N[3]}if(w){const N=new gt(D,C),G=new gt(O,C),q=new gt(D,P),Y=new gt(O,P),se=vn(w);let re=new gt(0,0);T&&(re=new gt(T[0],T[1])),N._rotateAround(se,re),G._rotateAround(se,re),q._rotateAround(se,re),Y._rotateAround(se,re),D=Math.min(N.x,G.x,q.x,Y.x),O=Math.max(N.x,G.x,q.x,Y.x),C=Math.min(N.y,G.y,q.y,Y.y),P=Math.max(N.y,G.y,q.y,Y.y)}return n.emplaceBack(e.x,e.y,e.z,i.x,i.y,D,C,O,P,y,o,a,h),n.length-1}function f0(n){Q1(n)&&n.collisionPadding&&(n.top-=n.collisionPadding[1],n.bottom+=n.collisionPadding[3]);const e=n.bottom-n.top;return e>0?Math.max(10,e):null}function XS(n,e,i,o){const a=n.compareText;if(e in a){const h=a[e];for(let d=h.length-1;d>=0;d--)if(o.dist(h[d])<i)return!0}else a[e]=[];return a[e].push(o),!1}function bw(n,e){const i=n.fovAboveCenter,o=n.elevation?n.elevation.getMinElevationBelowMSL()*e:0,a=(n._camera.position[2]*n.worldSize-o)/Math.cos(n._pitch),h=Math.sin(i)*a/Math.sin(Math.max(Math.PI/2-n._pitch-i,.01));let d=Math.sin(n._pitch)*h+a;const y=a*(1/n._horizonShift);if(!n.elevation||n.elevation.exaggeration()===0){let w=Math.max(n.zoom-17,0);n.isOrthographic&&(w/=10),d*=1+w}return Math.min(1.01*d,y)}function Zm(n,e){if(!e.isReprojectedInTileSpace)return{scale:1<<n.z,x:n.x,y:n.y,x2:n.x+1,y2:n.y+1,projection:e};const i=Math.pow(2,-n.z),o=n.x*i,a=(n.x+1)*i,h=n.y*i,d=(n.y+1)*i,y=te(o),w=te(a),T=oe(h),C=oe(d),P=e.project(y,T),D=e.project(w,T),O=e.project(w,C),N=e.project(y,C);let G=Math.min(P.x,D.x,O.x,N.x),q=Math.min(P.y,D.y,O.y,N.y),Y=Math.max(P.x,D.x,O.x,N.x),se=Math.max(P.y,D.y,O.y,N.y);const re=i/16;function ae(ve,xe,Pe,Me,it,Fe){const ot=(Pe+it)/2,Dt=(Me+Fe)/2,ht=e.project(te(ot),oe(Dt)),bt=Math.max(0,G-ht.x,q-ht.y,ht.x-Y,ht.y-se);G=Math.min(G,ht.x),Y=Math.max(Y,ht.x),q=Math.min(q,ht.y),se=Math.max(se,ht.y),bt>re&&(ae(ve,ht,Pe,Me,ot,Dt),ae(ht,xe,ot,Dt,it,Fe))}ae(P,D,o,h,a,h),ae(D,O,a,h,a,d),ae(O,N,a,d,o,d),ae(N,P,o,d,o,h),G-=re,q-=re,Y+=re,se+=re;const Ee=1/Math.max(Y-G,se-q);return{scale:Ee,x:G*Ee,y:q*Ee,x2:Y*Ee,y2:se*Ee,projection:e}}function Tw(n,{x:e,y:i},o=0){return new gt(((e-o)*n.scale-n.x)*zt,(i*n.scale-n.y)*zt)}const KS=ct(new Float32Array(16));class vf{constructor(e){this.spec=e,this.name=e.name,this.wrap=!1,this.requiresDraping=!1,this.supportsWorldCopies=!1,this.supportsTerrain=!1,this.supportsFog=!1,this.supportsFreeCamera=!1,this.zAxisUnit="meters",this.isReprojectedInTileSpace=!0,this.unsupportedLayers=["custom"],this.center=[0,0],this.range=[3.5,7]}project(e,i){return{x:0,y:0,z:0}}unproject(e,i){return new L(0,0)}projectTilePoint(e,i,o){return{x:e,y:i,z:0}}locationPoint(e,i,o,a=!0){return e._coordinatePoint(e.locationCoordinate(i,o),a)}pixelsPerMeter(e,i){return Z(1,e)*i}pixelSpaceConversion(e,i,o){return 1}farthestPixelDistance(e){return bw(e,e.pixelsPerMeter)}pointCoordinate(e,i,o,a){const h=e.horizonLineFromTop(!1),d=new gt(i,Math.max(h,o));return e.rayIntersectionCoordinate(e.pointRayIntersection(d,a))}pointCoordinate3D(e,i,o){const a=new gt(i,o);if(e.elevation)return e.elevation.pointCoordinate(a);{const h=this.pointCoordinate(e,a.x,a.y,0);return[h.x,h.y,h.z]}}isPointAboveHorizon(e,i){if(e.elevation&&e.elevation.visibleDemTiles.length)return!this.pointCoordinate3D(e,i.x,i.y);const o=e.horizonLineFromTop();return i.y<o}createInversionMatrix(e,i){return KS}createTileMatrix(e,i,o){let a,h,d;const y=o.canonical,w=ct(new Float64Array(16));if(this.isReprojectedInTileSpace){const T=Zm(y,this);a=1,h=T.x+o.wrap*T.scale,d=T.y,Ei(w,w,[a/T.scale,a/T.scale,e.pixelsPerMeter/i])}else a=i/e.zoomScale(y.z),h=(y.x+Math.pow(2,y.z)*o.wrap)*a,d=y.y*a;return Ti(w,w,[h,d,0]),Ei(w,w,[a/zt,a/zt,1]),w}upVector(e,i,o){return[0,0,1]}upVectorScale(e,i,o){return{metersToTile:1}}}class YS extends vf{constructor(e){super(e),this.range=[4,7],this.center=e.center||[-96,37.5];const[i,o]=this.parallels=e.parallels||[29.5,45.5],a=Math.sin(vn(i));this.n=(a+Math.sin(vn(o)))/2,this.c=1+a*(2*this.n-a),this.r0=Math.sqrt(this.c)/this.n}project(e,i){const{n:o,c:a,r0:h}=this,d=vn(e-this.center[0]),y=vn(i),w=Math.sqrt(a-2*o*Math.sin(y))/o;return{x:w*Math.sin(d*o),y:w*Math.cos(d*o)-h,z:0}}unproject(e,i){const{n:o,c:a,r0:h}=this,d=h+i;let y=Math.atan2(e,Math.abs(d))*Math.sign(d);d*o<0&&(y-=Math.PI*Math.sign(e)*Math.sign(d));const w=vn(this.center[0])*o;y=$e(y,-Math.PI-w,Math.PI-w);const T=de(ke(y/o)+this.center[0],-180,180),C=Math.asin(de((a-(e*e+d*d)*o*o)/(2*o),-1,1)),P=de(ke(C),-pe,pe);return new L(T,P)}}const Xm=1.340264,Km=-.081106,Ym=893e-6,Qm=.003796,dg=Math.sqrt(3)/2;class QS extends vf{project(e,i){i=i/180*Math.PI,e=e/180*Math.PI;const o=Math.asin(dg*Math.sin(i)),a=o*o,h=a*a*a;return{x:.5*(e*Math.cos(o)/(dg*(Xm+3*Km*a+h*(7*Ym+9*Qm*a)))/Math.PI+.5),y:1-.5*(o*(Xm+Km*a+h*(Ym+Qm*a))/Math.PI+1),z:0}}unproject(e,i){e=(2*e-.5)*Math.PI;let o=i=(2*(1-i)-1)*Math.PI,a=o*o,h=a*a*a;for(let C,P,D,O=0;O<12&&(P=o*(Xm+Km*a+h*(Ym+Qm*a))-i,D=Xm+3*Km*a+h*(7*Ym+9*Qm*a),C=P/D,o=de(o-C,-Math.PI/3,Math.PI/3),a=o*o,h=a*a*a,!(Math.abs(C)<1e-12));++O);const d=dg*e*(Xm+3*Km*a+h*(7*Ym+9*Qm*a))/Math.cos(o),y=Math.asin(Math.sin(o)/dg),w=de(180*d/Math.PI,-180,180),T=de(180*y/Math.PI,-pe,pe);return new L(w,T)}}class JS extends vf{constructor(e){super(e),this.wrap=!0,this.supportsWorldCopies=!0}project(e,i){return{x:.5+e/360,y:.5-i/360,z:0}}unproject(e,i){const o=360*(e-.5),a=de(360*(.5-i),-pe,pe);return new L(o,a)}}const Xp=Math.PI/2;function fg(n){return Math.tan((Xp+n)/2)}class eI extends vf{constructor(e){super(e),this.center=e.center||[0,30];const[i,o]=this.parallels=e.parallels||[30,30];let a=vn(i),h=vn(o);this.southernCenter=a+h<0,this.southernCenter&&(a=-a,h=-h);const d=Math.cos(a),y=fg(a);this.n=a===h?Math.sin(a):Math.log(d/Math.cos(h))/Math.log(fg(h)/y),this.f=d*Math.pow(fg(a),this.n)/this.n}project(e,i){i=vn(i),this.southernCenter&&(i=-i),e=vn(e-this.center[0]);const o=1e-6,{n:a,f:h}=this;h>0?i<-Xp+o&&(i=-Xp+o):i>Xp-o&&(i=Xp-o);const d=h/Math.pow(fg(i),a);let y=d*Math.sin(a*e),w=h-d*Math.cos(a*e);return y=.5*(y/Math.PI+.5),w=.5*(w/Math.PI+.5),{x:y,y:this.southernCenter?w:1-w,z:0}}unproject(e,i){e=(2*e-.5)*Math.PI,this.southernCenter&&(i=1-i),i=(2*(1-i)-.5)*Math.PI;const{n:o,f:a}=this,h=a-i,d=Math.sign(h),y=Math.sign(o)*Math.sqrt(e*e+h*h);let w=Math.atan2(e,Math.abs(h))*d;h*o<0&&(w-=Math.PI*Math.sign(e)*d);const T=de(ke(w/o)+this.center[0],-180,180),C=de(ke(2*Math.atan(Math.pow(a/y,1/o))-Xp),-pe,pe);return new L(T,this.southernCenter?-C:C)}}class Ew extends vf{constructor(e){super(e),this.wrap=!0,this.supportsWorldCopies=!0,this.supportsTerrain=!0,this.supportsFog=!0,this.supportsFreeCamera=!0,this.isReprojectedInTileSpace=!1,this.unsupportedLayers=[],this.range=null}project(e,i){return{x:H(e),y:X(i),z:0}}unproject(e,i){const o=te(e),a=oe(i);return new L(o,a)}}const Sw=vn(pe);class tI extends vf{project(e,i){const o=(i=vn(i))*i,a=o*o;return{x:.5*((e=vn(e))*(.8707-.131979*o+a*(a*(.003971*o-.001529*a)-.013791))/Math.PI+.5),y:1-.5*(i*(1.007226+o*(.015085+a*(.028874*o-.044475-.005916*a)))/Math.PI+1),z:0}}unproject(e,i){e=(2*e-.5)*Math.PI;let o=i=(2*(1-i)-1)*Math.PI,a=25,h=0,d=o*o;do{d=o*o;const T=d*d;h=(o*(1.007226+d*(.015085+T*(.028874*d-.044475-.005916*T)))-i)/(1.007226+d*(.045255+T*(.259866*d-.311325-.005916*11*T))),o=de(o-h,-Sw,Sw)}while(Math.abs(h)>1e-6&&--a>0);d=o*o;const y=de(ke(e/(.8707+d*(d*(d*d*d*(.003971-.001529*d)-.013791)-.131979))),-180,180),w=ke(o);return new L(y,w)}}const Iw=vn(pe);class iI extends vf{project(e,i){i=vn(i),e=vn(e);const o=Math.cos(i),a=2/Math.PI,h=Math.acos(o*Math.cos(e/2)),d=Math.sin(h)/h,y=.5*(e*a+2*o*Math.sin(e/2)/d)||0,w=.5*(i+Math.sin(i)/d)||0;return{x:.5*(y/Math.PI+.5),y:1-.5*(w/Math.PI+1),z:0}}unproject(e,i){let o=e=(2*e-.5)*Math.PI,a=i=(2*(1-i)-1)*Math.PI,h=25;const d=1e-6;let y=0,w=0;do{const T=Math.cos(a),C=Math.sin(a),P=2*C*T,D=C*C,O=T*T,N=Math.cos(o/2),G=Math.sin(o/2),q=2*N*G,Y=G*G,se=1-O*N*N,re=se?1/se:0,ae=se?Math.acos(T*N)*Math.sqrt(1/se):0,Ee=.5*(2*ae*T*G+2*o/Math.PI)-e,ve=.5*(ae*C+a)-i,xe=.5*re*(O*Y+ae*T*N*D)+1/Math.PI,Pe=re*(q*P/4-ae*C*G),Me=.125*re*(P*G-ae*C*O*q),it=.5*re*(D*N+ae*Y*T)+.5,Fe=Pe*Me-it*xe;y=(ve*Pe-Ee*it)/Fe,w=(Ee*Me-ve*xe)/Fe,o=de(o-y,-Math.PI,Math.PI),a=de(a-w,-Iw,Iw)}while((Math.abs(y)>d||Math.abs(w)>d)&&--h>0);return new L(ke(o),ke(a))}}class Aw extends vf{constructor(e){super(e),this.center=e.center||[0,0],this.parallels=e.parallels||[0,0],this.cosPhi=Math.max(.01,Math.cos(vn(this.parallels[0]))),this.scale=1/(2*Math.max(Math.PI*this.cosPhi,1/this.cosPhi)),this.wrap=!0,this.supportsWorldCopies=!0}project(e,i){const{scale:o,cosPhi:a}=this;return{x:vn(e)*a*o+.5,y:-Math.sin(vn(i))/a*o+.5,z:0}}unproject(e,i){const{scale:o,cosPhi:a}=this,h=-(i-.5)/o,d=de(ke((e-.5)/o)/a,-180,180),y=Math.asin(de(h*a,-1,1)),w=de(ke(y),-pe,pe);return new L(d,w)}}class nI extends Ew{constructor(e){super(e),this.requiresDraping=!0,this.supportsWorldCopies=!1,this.supportsFog=!0,this.zAxisUnit="pixels",this.unsupportedLayers=["debug"],this.range=[3,5]}projectTilePoint(e,i,o){const a=ai(e,i,o);return Pn(a,a,Oi(j(o))),{x:a[0],y:a[1],z:a[2]}}locationPoint(e,i,o){const a=b(i.lat,i.lng),h=zi([],a),d=o?e._centerAltitude+o:e.elevation?e.elevation.getAtPointOrZero(e.locationCoordinate(i),e._centerAltitude):e._centerAltitude;Gt(a,a,h,Z(1,0)*zt*d);const y=ct(new Float64Array(16));return Nt(y,e.pixelMatrix,e.globeMatrix),Pn(a,a,y),new gt(a[0],a[1])}pixelsPerMeter(e,i){return Z(1,0)*i}pixelSpaceConversion(e,i,o){const a=Z(1,e)*i,h=di(Z(1,45)*i,a,o);return this.pixelsPerMeter(e,i)/h}createTileMatrix(e,i,o){const a=qi(j(o.canonical));return Nt(new Float64Array(16),e.globeMatrix,a)}createInversionMatrix(e,i){const{center:o}=e,a=Oi(j(i));return Hn(a,a,vn(o.lng)),en(a,a,vn(o.lat)),Ei(a,a,[e._pixelsPerMercatorPixel,e._pixelsPerMercatorPixel,1]),Float32Array.from(a)}pointCoordinate(e,i,o,a){return g(e,i,o,!0)||new ge(0,0)}pointCoordinate3D(e,i,o){const a=this.pointCoordinate(e,i,o,0);return[a.x,a.y,a.z]}isPointAboveHorizon(e,i){return!g(e,i.x,i.y,!1)}farthestPixelDistance(e){const i=(function(a,h){const d=a.cameraToCenterDistance,y=a._centerAltitude*h,w=a._camera,T=a._camera.forward(),C=wn([],Qe([],T,-d),[0,0,y]),P=a.worldSize/(2*Math.PI),D=[0,0,-P],O=a.width/a.height,N=Math.tan(a.fovAboveCenter),G=Qe([],w.up(),N),q=Qe([],w.right(),N*O),Y=zi([],wn([],wn([],T,G),q)),se=[];let re;if(new En(C,Y).closestPointOnSphere(D,P,se)){const ae=wn([],se,D),Ee=Ut([],ae,C);re=Math.cos(a.fovAboveCenter)*Oe(Ee)}else{const ae=Ut([],C,D),Ee=Ut([],D,C);zi(Ee,Ee);const ve=Oe(ae)-P;re=Math.sqrt(ve*(ve+2*P));const xe=Math.acos(re/(P+ve))-Math.acos(Ji(T,Ee));re*=Math.cos(xe)}return 1.01*re})(e,this.pixelsPerMeter(e.center.lat,e.worldSize)),o=st(e.zoom);if(o>0){const a=bw(e,Z(1,e.center.lat)*e.worldSize),h=e.worldSize/(2*Math.PI),d=Math.max(e.width,e.height)/e.worldSize*Math.PI;return di(i,a+h*(1-Math.cos(d)),Math.pow(o,10))}return i}upVector(e,i,o){return ai(i,o,e,1)}upVectorScale(e){return{metersToTile:hd(hi(j(e)))}}}function Cw(n){const e=n.parallels,i=!!e&&Math.abs(e[0]+e[1])<.01;switch(n.name){case"mercator":return new Ew(n);case"equirectangular":return new JS(n);case"naturalEarth":return new tI(n);case"equalEarth":return new QS(n);case"winkelTripel":return new iI(n);case"albers":return i?new Aw(n):new YS(n);case"lambertConformalConic":return i?new Aw(n):new eI(n);case"globe":return new nI(n)}throw new Error(`Invalid projection name: ${n.name}`)}const rI=Ue.types,sI=[{name:"a_fade_opacity",components:1,type:"Uint8",offset:0}];function pg(n,e,i,o,a,h,d,y,w,T,C,P,D){const O=y?Math.min(yf,Math.round(y[0])):0,N=y?Math.min(yf,Math.round(y[1])):0;n.emplaceBack(e,i,Math.round(32*o),Math.round(32*a),h,d,(O<<1)+(w?1:0),N,16*T,16*C,256*P,256*D)}function mg(n,e,i){n.emplaceBack(e,i)}function _g(n,e,i,o,a,h,d){n.emplaceBack(e,i,o,a,h,d)}const gg=(n,e,i,o)=>{for(let a=0;a<e;a++)n.emplaceBack(i[0],i[1],i[2],o[0],o[1],o[2])};function yg(n,e,i,o,a){n.emplaceBack(e,i,o,a),n.emplaceBack(e,i,o,a),n.emplaceBack(e,i,o,a),n.emplaceBack(e,i,o,a)}function oI(n){for(const e of n.sections)if(Qh(e.text))return!0;return!1}class p0{constructor(e){this.layoutVertexArray=new sa,this.indexArray=new yr,this.programConfigurations=e,this.segments=new kr,this.dynamicLayoutVertexArray=new bl,this.opacityVertexArray=new Xd,this.placedSymbolArray=new mh,this.iconTransitioningVertexArray=new Tl,this.globeExtVertexArray=new $c,this.zOffsetVertexArray=new Lu,this.orientationVertexArray=new Qd}isEmpty(){return this.layoutVertexArray.length===0&&this.indexArray.length===0&&this.dynamicLayoutVertexArray.length===0&&this.opacityVertexArray.length===0&&this.iconTransitioningVertexArray.length===0}upload(e,i,o,a,h){this.isEmpty()||(o&&(this.layoutVertexBuffer=e.createVertexBuffer(this.layoutVertexArray,hS.members),this.indexBuffer=e.createIndexBuffer(this.indexArray,i),this.dynamicLayoutVertexBuffer=e.createVertexBuffer(this.dynamicLayoutVertexArray,fS.members,!0),this.opacityVertexBuffer=e.createVertexBuffer(this.opacityVertexArray,sI,!0),this.iconTransitioningVertexArray.length>0&&(this.iconTransitioningVertexBuffer=e.createVertexBuffer(this.iconTransitioningVertexArray,_S.members,!0)),this.globeExtVertexArray.length>0&&(this.globeExtVertexBuffer=e.createVertexBuffer(this.globeExtVertexArray,dS.members,!0)),!this.zOffsetVertexBuffer&&(this.zOffsetVertexArray.length>0||h)&&(this.zOffsetVertexBuffer=e.createVertexBuffer(this.zOffsetVertexArray,pS.members,!0)),!this.orientationVertexBuffer&&this.orientationVertexArray&&this.orientationVertexArray.length>0&&(this.orientationVertexBuffer=e.createVertexBuffer(this.orientationVertexArray,mS.members,!0)),this.opacityVertexBuffer.itemSize=1),(o||a)&&this.programConfigurations.upload(e))}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.programConfigurations.destroy(),this.segments.destroy(),this.dynamicLayoutVertexBuffer.destroy(),this.opacityVertexBuffer.destroy(),this.iconTransitioningVertexBuffer&&this.iconTransitioningVertexBuffer.destroy(),this.globeExtVertexBuffer&&this.globeExtVertexBuffer.destroy(),this.zOffsetVertexBuffer&&this.zOffsetVertexBuffer.destroy(),this.orientationVertexBuffer&&this.orientationVertexBuffer.destroy())}}Kt(p0,"SymbolBuffers");class m0{constructor(e,i,o){this.layoutVertexArray=new e,this.layoutAttributes=i,this.indexArray=new o,this.segments=new kr,this.collisionVertexArray=new Wc,this.collisionVertexArrayExt=new bl}upload(e){this.layoutVertexBuffer=e.createVertexBuffer(this.layoutVertexArray,this.layoutAttributes),this.indexBuffer=e.createIndexBuffer(this.indexArray),this.collisionVertexBuffer=e.createVertexBuffer(this.collisionVertexArray,gS.members,!0),this.collisionVertexBufferExt=e.createVertexBuffer(this.collisionVertexArrayExt,yS.members,!0)}destroy(){this.layoutVertexBuffer&&(this.layoutVertexBuffer.destroy(),this.indexBuffer.destroy(),this.segments.destroy(),this.collisionVertexBuffer.destroy(),this.collisionVertexBufferExt.destroy())}}Kt(m0,"CollisionBuffers");class vg{constructor(e){this.collisionBoxArray=e.collisionBoxArray,this.zoom=e.zoom,this.lut=e.lut,this.overscaling=e.overscaling,this.layers=e.layers,this.layerIds=this.layers.map((d=>d.fqid)),this.index=e.index,this.pixelRatio=e.pixelRatio,this.sourceLayerIndex=e.sourceLayerIndex,this.hasPattern=!1,this.hasRTLText=!1,this.fullyClipped=!1,this.hasAnyIconTextFit=!1,this.sortKeyRanges=[],this.collisionCircleArray=[],this.placementInvProjMatrix=ct([]),this.placementViewportMatrix=ct([]);const i=this.layers[0]._unevaluatedLayout._values;this.worldview=e.worldview,this.textSizeData=nw(this.zoom,i["text-size"],this.worldview),this.iconSizeData=nw(this.zoom,i["icon-size"],this.worldview);const o=this.layers[0].layout,a=o.get("symbol-sort-key"),h=o.get("symbol-z-order");this.canOverlap=o.get("text-allow-overlap")||o.get("icon-allow-overlap")||o.get("text-ignore-placement")||o.get("icon-ignore-placement"),this.sortFeaturesByKey=h!=="viewport-y"&&a.constantOr(1)!==void 0,this.sortFeaturesByY=(h==="viewport-y"||h==="auto"&&!this.sortFeaturesByKey)&&this.canOverlap,this.writingModes=o.get("text-writing-mode").map((d=>Pl[d])),this.stateDependentLayerIds=this.layers.filter((d=>d.isStateDependent())).map((d=>d.id)),this.sourceID=e.sourceID,this.projection=e.projection,this.hasAnyZOffset=!1,this.zOffsetSortDirty=!1,this.zOffsetBuffersNeedUpload=!1,this.elevationType="none",this.elevationStateComplete=!1,this.activeReplacements=[],this.replacementUpdateTime=0,this.hasAnySecondaryIcon=!1}createArrays(){this.text=new p0(new oa(this.layers,{zoom:this.zoom,lut:this.lut},(e=>e.startsWith("text")||e.startsWith("symbol")))),this.icon=new p0(new oa(this.layers,{zoom:this.zoom,lut:this.lut},(e=>e.startsWith("icon")||e.startsWith("symbol")))),this.glyphOffsetArray=new cd,this.lineVertexArray=new Xf,this.symbolInstances=new rf}calculateGlyphDependencies(e,i,o,a,h){for(const d of e){const y=d.codePointAt(0);if(y===void 0)break;if(i[y]=!0,a&&h&&y<=65535){const w=jm[d];w&&(i[w.charCodeAt(0)]=!0)}}}updateFootprints(e,i){}updateReplacement(e,i){if(i.updateTime===this.replacementUpdateTime)return!1;this.replacementUpdateTime=i.updateTime;const o=i.getReplacementRegionsForTile(e.toUnwrapped(),!0);return!Z_(this.activeReplacements,o)&&(this.activeReplacements=o,!0)}populate(e,i,o,a){const h=this.layers[0],d=h.layout,y=this.projection.name==="globe",w=d.get("text-font"),T=d.get("text-field"),C=d.get("icon-image"),[P,D]=d.get("icon-size-scale-range"),O=de(i.scaleFactor||1,P,D),N=(T.value.kind!=="constant"||T.value.value instanceof Mt&&!T.value.value.isEmpty()||T.value.value.toString().length>0)&&(w.value.kind!=="constant"||w.value.value.length>0),G=C.value.kind!=="constant"||!!C.value.value||Object.keys(C.parameters).length>0,q=d.get("symbol-sort-key");if(this.features=[],!N&&!G)return;const Y=i.iconDependencies,se=i.glyphDependencies,re=i.availableImages,ae=new Wn(this.zoom,{worldview:this.worldview});for(const{feature:Ee,id:ve,index:xe,sourceLayerIndex:Pe}of e){const Me=h._featureFilter.needGeometry,it=Ze(Ee,Me);if(!h._featureFilter.filter(ae,it,o))continue;if(Me||(it.geometry=Te(Ee,o,a)),y&&Ee.type!==1&&o.z<=5){const bt=it.geometry,Rt=.98078528056,et=(Tt,Ve)=>Ji(ai(Tt.x,Tt.y,o,1),ai(Ve.x,Ve.y,o,1))<Rt;for(let Tt=0;Tt<bt.length;Tt++)bt[Tt]=He(bt[Tt],et)}let Fe,ot;if(N){const bt=h.getValueAndResolveTokens("text-field",it,o,re),Rt=Mt.factory(bt);oI(Rt)&&(this.hasRTLText=!0),(!this.hasRTLText||ed()==="unavailable"||this.hasRTLText&&Ra.isParsed())&&(Fe=xS(Rt,h,it))}if(G){const bt=h.getValueAndResolveTokens("icon-image",it,o,re);ot=typeof bt=="string"?Yn.build(bt):bt}if(!Fe&&!ot)continue;const Dt=this.sortFeaturesByKey?q.evaluate(it,{},o):void 0,ht={id:ve,text:Fe,icon:ot,index:xe,sourceLayerIndex:Pe,geometry:it.geometry,properties:Ee.properties,type:rI[Ee.type],sortKey:Dt};if(this.features.push(ht),ot){const bt=this.layers[0]._unevaluatedLayout._values,{iconPrimary:Rt,iconSecondary:et}=yw(ot,this.iconSizeData,bt["icon-size"],o,this.zoom,ht,this.pixelRatio,O,this.worldview),Tt=Rt.id.toString();if(Y.has(Tt)?Y.get(Tt).push(Rt):Y.set(Tt,[Rt]),et){this.hasAnySecondaryIcon=!0;const Ve=et.id.toString();Y.has(Ve)?Y.get(Ve).push(et):Y.set(Ve,[et])}}if(Fe){const bt=w.evaluate(it,{},o).join(","),Rt=d.get("text-rotation-alignment")==="map"&&d.get("symbol-placement")!=="point";this.allowVerticalPlacement=this.writingModes&&this.writingModes.indexOf(Pl.vertical)>=0;for(const et of Fe.sections)if(et.image){const Tt=et.image.getPrimary().scaleSelf(this.pixelRatio),Ve=Tt.id.toString(),tt=Y.get(Ve)||[];tt.push(Tt),Y.set(Ve,tt)}else{const Tt=Xl(Fe.toString()),Ve=et.fontStack||bt,tt=se[Ve]=se[Ve]||{};this.calculateGlyphDependencies(et.text,tt,Rt,this.allowVerticalPlacement,Tt)}}}if(d.get("symbol-placement")==="line"&&(this.features=(function(Ee){const ve={},xe={},Pe=[];let Me=0;function it(ht){Pe.push(Ee[ht]),Me++}function Fe(ht,bt,Rt){const et=xe[ht];return delete xe[ht],xe[bt]=et,Pe[et].geometry[0].pop(),Pe[et].geometry[0]=Pe[et].geometry[0].concat(Rt[0]),et}function ot(ht,bt,Rt){const et=ve[bt];return delete ve[bt],ve[ht]=et,Pe[et].geometry[0].shift(),Pe[et].geometry[0]=Rt[0].concat(Pe[et].geometry[0]),et}function Dt(ht,bt,Rt){const et=Rt?bt[0][bt[0].length-1]:bt[0][0];return`${ht}:${et.x}:${et.y}`}for(let ht=0;ht<Ee.length;ht++){const bt=Ee[ht],Rt=bt.geometry,et=bt.text?bt.text.toString():null;if(!et){it(ht);continue}const Tt=Dt(et,Rt),Ve=Dt(et,Rt,!0);if(Tt in xe&&Ve in ve&&xe[Tt]!==ve[Ve]){const tt=ot(Tt,Ve,Rt),Lt=Fe(Tt,Ve,Pe[tt].geometry);delete ve[Tt],delete xe[Ve],xe[Dt(et,Pe[Lt].geometry,!0)]=Lt,Pe[tt].geometry=null}else Tt in xe?Fe(Tt,Ve,Rt):Ve in ve?ot(Tt,Ve,Rt):(it(ht),ve[Tt]=Me-1,xe[Ve]=Me-1)}return Pe.filter((ht=>ht.geometry))})(this.features)),d.get("symbol-elevation-reference")==="hd-road-markup"){if(this.elevationType="road",i.elevationFeatures){!this.elevationFeatures&&i.elevationFeatures.length>0&&(this.elevationFeatures=[],this.elevationFeatureIdToIndex=new Map);for(const Ee of i.elevationFeatures)this.elevationFeatureIdToIndex.set(Ee.id,this.elevationFeatures.length),this.elevationFeatures.push(Ee)}}else d.get("symbol-z-elevate")&&(this.elevationType="offset");this.elevationType!=="none"&&(this.zOffsetBuffersNeedUpload=!0),this.sortFeaturesByKey&&this.features.sort(((Ee,ve)=>Ee.sortKey-ve.sortKey))}update(e,i,o,a,h,d,y){this.text.programConfigurations.updatePaintArrays(e,i,h,o,a,d,y,this.worldview),this.icon.programConfigurations.updatePaintArrays(e,i,h,o,a,d,y,this.worldview)}updateRoadElevation(e){if(this.elevationType!=="road"||!this.elevationFeatures||this.elevationStateComplete)return;this.elevationStateComplete=!0,this.hasAnyZOffset=!1;let i=!1;const o=_e(e),a=1/o;let h=!1,d=!1;for(let y=0;y<this.symbolInstances.length;y++){const w=this.symbolInstances.get(y),T=kn(1,0,0),C=kn(0,1,0),{numHorizontalGlyphVertices:P,numVerticalGlyphVertices:D,numIconVertices:O,numVerticalIconVertices:N}=w,G=P>0||D>0,q=O>0,Y=this.elevationFeatures[w.elevationFeatureIndex];if(Y){const se=new gt(w.tileAnchorX,w.tileAnchorY),re=.075+Y.pointElevation(se);w.zOffset!==re&&(i=!0,w.zOffset=re);const ae=Y.computeSlopeNormal(se,a),Ee=pa(ar(),kn(0,0,1),ae);Bo(T,T,Ee),Bo(C,C,Ee),T[2]*=o,C[2]*=o,T[0]===1&&T[1]===0&&T[2]===0&&C[0]===0&&C[1]===1&&C[2]===0||(h=h||G,d=d||q)}if(G&&(gg(this.text.orientationVertexArray,P,T,C),gg(this.text.orientationVertexArray,D,T,C)),q){const{placedIconSymbolIndex:se,verticalPlacedIconSymbolIndex:re}=w;se>=0&&gg(this.icon.orientationVertexArray,O,T,C),re>=0&&gg(this.icon.orientationVertexArray,N,T,C)}}h||(this.text.orientationVertexArray=void 0),d||(this.icon.orientationVertexArray=void 0),i&&(this.zOffsetBuffersNeedUpload=!0,this.zOffsetSortDirty=!0)}updateZOffset(){const e=(h,d,y)=>{o+=d,o>h.length&&h.resize(o);for(let w=-d;w<0;w++)h.emplace(w+o,y)},i=(h,d,y)=>{a+=d,a>h.length&&h.resize(a);for(let w=-d;w<0;w++)h.emplace(w+a,y)};if(!this.zOffsetBuffersNeedUpload)return;this.zOffsetBuffersNeedUpload=!1;let o=0,a=0;for(let h=0;h<this.symbolInstances.length;h++){const d=this.symbolInstances.get(h),{numHorizontalGlyphVertices:y,numVerticalGlyphVertices:w,numIconVertices:T}=d,C=d.zOffset,P=T>0;if((y>0||w>0)&&(e(this.text.zOffsetVertexArray,y,C),e(this.text.zOffsetVertexArray,w,C)),P){const{placedIconSymbolIndex:D,verticalPlacedIconSymbolIndex:O}=d;D>=0&&i(this.icon.zOffsetVertexArray,T,C),O>=0&&i(this.icon.zOffsetVertexArray,d.numVerticalIconVertices,C)}}this.text.zOffsetVertexBuffer&&this.text.zOffsetVertexBuffer.updateData(this.text.zOffsetVertexArray),this.icon.zOffsetVertexBuffer&&this.icon.zOffsetVertexBuffer.updateData(this.icon.zOffsetVertexArray)}isEmpty(){return this.symbolInstances.length===0&&!this.hasRTLText}uploadPending(){return!this.uploaded||this.text.programConfigurations.needsUpload||this.icon.programConfigurations.needsUpload}upload(e){!this.uploaded&&this.hasDebugData()&&(this.textCollisionBox.upload(e),this.iconCollisionBox.upload(e)),this.text.upload(e,this.sortFeaturesByY,!this.uploaded,this.text.programConfigurations.needsUpload,this.zOffsetBuffersNeedUpload),this.icon.upload(e,this.sortFeaturesByY,!this.uploaded,this.icon.programConfigurations.needsUpload,this.zOffsetBuffersNeedUpload),this.uploaded=!0}destroyDebugData(){this.textCollisionBox.destroy(),this.iconCollisionBox.destroy()}getProjection(){return this.projectionInstance||(this.projectionInstance=Cw(this.projection)),this.projectionInstance}destroy(){this.text.destroy(),this.icon.destroy(),this.hasDebugData()&&this.destroyDebugData()}addToLineVertexArray(e,i){const o=this.lineVertexArray.length;if(e.segment!==void 0)for(const{x:a,y:h}of i)this.lineVertexArray.emplaceBack(a,h);return{lineStartIndex:o,lineLength:this.lineVertexArray.length-o}}addSymbols(e,i,o,a,h,d,y,w,T,C,P,D,O,N,G,q){const Y=e.indexArray,se=e.layoutVertexArray,re=e.globeExtVertexArray,ae=e.segments.prepareSegment(4*i.length,se,Y,this.canOverlap?d.sortKey:void 0),Ee=this.glyphOffsetArray.length,ve=ae.vertexLength,xe=this.allowVerticalPlacement&&y===Pl.vertical?Math.PI/2:0,Pe=d.text&&d.text.sections;for(let it=0;it<i.length;it++){const{tl:Fe,tr:ot,bl:Dt,br:ht,texPrimary:bt,texSecondary:Rt,pixelOffsetTL:et,pixelOffsetBR:Tt,minFontScaleX:Ve,minFontScaleY:tt,glyphOffset:Lt,isSDF:Et,sectionIndex:li}=i[it],Yt=ae.vertexLength,vt=Lt[1];if(pg(se,T.x,T.y,Fe.x,vt+Fe.y,bt.x,bt.y,o,Et,et.x,et.y,Ve,tt),pg(se,T.x,T.y,ot.x,vt+ot.y,bt.x+bt.w,bt.y,o,Et,Tt.x,et.y,Ve,tt),pg(se,T.x,T.y,Dt.x,vt+Dt.y,bt.x,bt.y+bt.h,o,Et,et.x,Tt.y,Ve,tt),pg(se,T.x,T.y,ht.x,vt+ht.y,bt.x+bt.w,bt.y+bt.h,o,Et,Tt.x,Tt.y,Ve,tt),w){const{x:At,y:ti,z:Zt}=w.anchor,[Bt,Xt,bi]=w.up;_g(re,At,ti,Zt,Bt,Xt,bi),_g(re,At,ti,Zt,Bt,Xt,bi),_g(re,At,ti,Zt,Bt,Xt,bi),_g(re,At,ti,Zt,Bt,Xt,bi),yg(e.dynamicLayoutVertexArray,At,ti,Zt,xe)}else yg(e.dynamicLayoutVertexArray,T.x,T.y,T.z,xe);if(q){const At=Rt||bt;mg(e.iconTransitioningVertexArray,At.x,At.y),mg(e.iconTransitioningVertexArray,At.x+At.w,At.y),mg(e.iconTransitioningVertexArray,At.x,At.y+At.h),mg(e.iconTransitioningVertexArray,At.x+At.w,At.y+At.h)}Y.emplaceBack(Yt,Yt+1,Yt+2),Y.emplaceBack(Yt+1,Yt+2,Yt+3),ae.vertexLength+=4,ae.primitiveLength+=2,this.glyphOffsetArray.emplaceBack(Lt[0]),it!==i.length-1&&li===i[it+1].sectionIndex||e.programConfigurations.populatePaintArrays(se.length,d,d.index,{},O,N,G,Pe&&Pe[li],this.worldview)}const Me=w?w.anchor:T;e.placedSymbolArray.emplaceBack(Me.x,Me.y,Me.z,T.x,T.y,Ee,this.glyphOffsetArray.length-Ee,ve,C,P,T.segment,o?o[0]:0,o?o[1]:0,a[0],a[1],y,0,0,0,D,0)}_commitLayoutVertex(e,i,o,a,h,d,y){e.emplaceBack(i,o,a,h,d,Math.round(y.x),Math.round(y.y))}_addCollisionDebugVertices(e,i,o,a,h,d,y){const w=o.segments.prepareSegment(4,o.layoutVertexArray,o.indexArray),T=w.vertexLength,C=y.tileAnchorX,P=y.tileAnchorY;for(let O=0;O<4;O++)o.collisionVertexArray.emplaceBack(0,0,0,0,0,0);this._commitDebugCollisionVertexUpdate(o.collisionVertexArrayExt,i,e.padding,y.zOffset),this._commitLayoutVertex(o.layoutVertexArray,a,h,d,C,P,new gt(e.x1,e.y1)),this._commitLayoutVertex(o.layoutVertexArray,a,h,d,C,P,new gt(e.x2,e.y1)),this._commitLayoutVertex(o.layoutVertexArray,a,h,d,C,P,new gt(e.x2,e.y2)),this._commitLayoutVertex(o.layoutVertexArray,a,h,d,C,P,new gt(e.x1,e.y2)),w.vertexLength+=4;const D=o.indexArray;D.emplaceBack(T,T+1),D.emplaceBack(T+1,T+2),D.emplaceBack(T+2,T+3),D.emplaceBack(T+3,T),w.primitiveLength+=4}_addTextDebugCollisionBoxes(e,i,o,a,h,d){for(let y=a;y<h;y++){const w=o.get(y),T=this.getSymbolInstanceTextSize(e,d,i,y);this._addCollisionDebugVertices(w,T,this.textCollisionBox,w.projectedAnchorX,w.projectedAnchorY,w.projectedAnchorZ,d)}}_addIconDebugCollisionBoxes(e,i,o,a,h,d){for(let y=a;y<h;y++){const w=o.get(y),T=this.getSymbolInstanceIconSize(e,i,d.placedIconSymbolIndex);this._addCollisionDebugVertices(w,T,this.iconCollisionBox,w.projectedAnchorX,w.projectedAnchorY,w.projectedAnchorZ,d)}}generateCollisionDebugBuffers(e,i,o){this.hasDebugData()&&this.destroyDebugData(),this.textCollisionBox=new m0(hh,j1.members,Tl),this.iconCollisionBox=new m0(hh,j1.members,Tl);const a=Hm(this.iconSizeData,e),h=Hm(this.textSizeData,e,o);for(let d=0;d<this.symbolInstances.length;d++){const y=this.symbolInstances.get(d);this._addTextDebugCollisionBoxes(h,e,i,y.textBoxStartIndex,y.textBoxEndIndex,y),this._addTextDebugCollisionBoxes(h,e,i,y.verticalTextBoxStartIndex,y.verticalTextBoxEndIndex,y),this._addIconDebugCollisionBoxes(a,e,i,y.iconBoxStartIndex,y.iconBoxEndIndex,y),this._addIconDebugCollisionBoxes(a,e,i,y.verticalIconBoxStartIndex,y.verticalIconBoxEndIndex,y)}}getSymbolInstanceTextSize(e,i,o,a){const h=this.text.placedSymbolArray.get(i.rightJustifiedTextSymbolIndex>=0?i.rightJustifiedTextSymbolIndex:i.centerJustifiedTextSymbolIndex>=0?i.centerJustifiedTextSymbolIndex:i.leftJustifiedTextSymbolIndex>=0?i.leftJustifiedTextSymbolIndex:i.verticalPlacedTextSymbolIndex>=0?i.verticalPlacedTextSymbolIndex:a),d=a0(this.textSizeData,e,h)/_o;return this.tilePixelRatio*d}getSymbolInstanceIconSize(e,i,o){const a=this.icon.placedSymbolArray.get(o),h=a0(this.iconSizeData,e,a);return this.tilePixelRatio*h}_commitDebugCollisionVertexUpdate(e,i,o,a){e.emplaceBack(i,-o,-o,a),e.emplaceBack(i,o,-o,a),e.emplaceBack(i,o,o,a),e.emplaceBack(i,-o,o,a)}_updateTextDebugCollisionBoxes(e,i,o,a,h,d,y){for(let w=a;w<h;w++){const T=o.get(w),C=this.getSymbolInstanceTextSize(e,d,i,w);this._commitDebugCollisionVertexUpdate(this.textCollisionBox.collisionVertexArrayExt,C,T.padding,d.zOffset)}}_updateIconDebugCollisionBoxes(e,i,o,a,h,d,y){for(let w=a;w<h;w++){const T=o.get(w),C=this.getSymbolInstanceIconSize(e,i,d.placedIconSymbolIndex);this._commitDebugCollisionVertexUpdate(this.iconCollisionBox.collisionVertexArrayExt,C,T.padding,d.zOffset)}}updateCollisionDebugBuffers(e,i,o,a){if(!this.hasDebugData())return;this.hasTextCollisionBoxData()&&this.textCollisionBox.collisionVertexArrayExt.clear(),this.hasIconCollisionBoxData()&&this.iconCollisionBox.collisionVertexArrayExt.clear();const h=Hm(this.iconSizeData,e,a),d=Hm(this.textSizeData,e,o);for(let y=0;y<this.symbolInstances.length;y++){const w=this.symbolInstances.get(y);this._updateTextDebugCollisionBoxes(d,e,i,w.textBoxStartIndex,w.textBoxEndIndex,w,o),this._updateTextDebugCollisionBoxes(d,e,i,w.verticalTextBoxStartIndex,w.verticalTextBoxEndIndex,w,o),this._updateIconDebugCollisionBoxes(h,e,i,w.iconBoxStartIndex,w.iconBoxEndIndex,w,a),this._updateIconDebugCollisionBoxes(h,e,i,w.verticalIconBoxStartIndex,w.verticalIconBoxEndIndex,w,a)}this.hasTextCollisionBoxData()&&this.textCollisionBox.collisionVertexBufferExt&&this.textCollisionBox.collisionVertexBufferExt.updateData(this.textCollisionBox.collisionVertexArrayExt),this.hasIconCollisionBoxData()&&this.iconCollisionBox.collisionVertexBufferExt&&this.iconCollisionBox.collisionVertexBufferExt.updateData(this.iconCollisionBox.collisionVertexArrayExt)}_deserializeCollisionBoxesForSymbol(e,i,o,a,h,d,y,w,T){const C={};if(i<o){const{x1:P,y1:D,x2:O,y2:N,padding:G,projectedAnchorX:q,projectedAnchorY:Y,projectedAnchorZ:se,tileAnchorX:re,tileAnchorY:ae,featureIndex:Ee}=e.get(i);C.textBox={x1:P,y1:D,x2:O,y2:N,padding:G,projectedAnchorX:q,projectedAnchorY:Y,projectedAnchorZ:se,tileAnchorX:re,tileAnchorY:ae},C.textFeatureIndex=Ee}if(a<h){const{x1:P,y1:D,x2:O,y2:N,padding:G,projectedAnchorX:q,projectedAnchorY:Y,projectedAnchorZ:se,tileAnchorX:re,tileAnchorY:ae,featureIndex:Ee}=e.get(a);C.verticalTextBox={x1:P,y1:D,x2:O,y2:N,padding:G,projectedAnchorX:q,projectedAnchorY:Y,projectedAnchorZ:se,tileAnchorX:re,tileAnchorY:ae},C.verticalTextFeatureIndex=Ee}if(d<y){const{x1:P,y1:D,x2:O,y2:N,padding:G,projectedAnchorX:q,projectedAnchorY:Y,projectedAnchorZ:se,tileAnchorX:re,tileAnchorY:ae,featureIndex:Ee}=e.get(d);C.iconBox={x1:P,y1:D,x2:O,y2:N,padding:G,projectedAnchorX:q,projectedAnchorY:Y,projectedAnchorZ:se,tileAnchorX:re,tileAnchorY:ae},C.iconFeatureIndex=Ee}if(w<T){const{x1:P,y1:D,x2:O,y2:N,padding:G,projectedAnchorX:q,projectedAnchorY:Y,projectedAnchorZ:se,tileAnchorX:re,tileAnchorY:ae,featureIndex:Ee}=e.get(w);C.verticalIconBox={x1:P,y1:D,x2:O,y2:N,padding:G,projectedAnchorX:q,projectedAnchorY:Y,projectedAnchorZ:se,tileAnchorX:re,tileAnchorY:ae},C.verticalIconFeatureIndex=Ee}return C}deserializeCollisionBoxes(e){this.collisionArrays=[];for(let i=0;i<this.symbolInstances.length;i++){const o=this.symbolInstances.get(i);this.collisionArrays.push(this._deserializeCollisionBoxesForSymbol(e,o.textBoxStartIndex,o.textBoxEndIndex,o.verticalTextBoxStartIndex,o.verticalTextBoxEndIndex,o.iconBoxStartIndex,o.iconBoxEndIndex,o.verticalIconBoxStartIndex,o.verticalIconBoxEndIndex))}}hasTextData(){return this.text.segments.get().length>0}hasIconData(){return this.icon.segments.get().length>0}hasDebugData(){return this.textCollisionBox&&this.iconCollisionBox}hasTextCollisionBoxData(){return this.hasDebugData()&&this.textCollisionBox.segments.get().length>0}hasIconCollisionBoxData(){return this.hasDebugData()&&this.iconCollisionBox.segments.get().length>0}hasIconTextFit(){return this.hasAnyIconTextFit}addIndicesForPlacedSymbol(e,i){const o=e.placedSymbolArray.get(i),a=o.vertexStartIndex+4*o.numGlyphs;for(let h=o.vertexStartIndex;h<a;h+=4)e.indexArray.emplaceBack(h,h+1,h+2),e.indexArray.emplaceBack(h+1,h+2,h+3)}getSortedSymbolIndexes(e){if(this.sortedAngle===e&&this.symbolInstanceIndexes!==void 0)return this.symbolInstanceIndexes;const i=Math.sin(e),o=Math.cos(e),a=[],h=[],d=[];for(let y=0;y<this.symbolInstances.length;++y){d.push(y);const w=this.symbolInstances.get(y);a.push(0|Math.round(i*w.tileAnchorX+o*w.tileAnchorY)),h.push(w.featureIndex)}return d.sort(((y,w)=>a[y]-a[w]||h[w]-h[y])),d}getSortedIndexesByZOffset(){if(!this.zOffsetSortDirty)return this.symbolInstanceIndexesSortedZOffset;if(!this.symbolInstanceIndexesSortedZOffset){this.symbolInstanceIndexesSortedZOffset=[];for(let e=0;e<this.symbolInstances.length;++e)this.symbolInstanceIndexesSortedZOffset.push(e)}return this.zOffsetSortDirty=!1,this.symbolInstanceIndexesSortedZOffset.sort(((e,i)=>this.symbolInstances.get(i).zOffset-this.symbolInstances.get(e).zOffset))}addToSortKeyRanges(e,i){const o=this.sortKeyRanges[this.sortKeyRanges.length-1];o&&o.sortKey===i?o.symbolInstanceEnd=e+1:this.sortKeyRanges.push({sortKey:i,symbolInstanceStart:e,symbolInstanceEnd:e+1})}sortFeatures(e){if(this.sortFeaturesByY&&this.sortedAngle!==e&&!(this.text.segments.get().length>1||this.icon.segments.get().length>1)){this.symbolInstanceIndexes=this.getSortedSymbolIndexes(e),this.sortedAngle=e,this.text.indexArray.clear(),this.icon.indexArray.clear(),this.featureSortOrder=[];for(const i of this.symbolInstanceIndexes){const o=this.symbolInstances.get(i);this.featureSortOrder.push(o.featureIndex);const{rightJustifiedTextSymbolIndex:a,centerJustifiedTextSymbolIndex:h,leftJustifiedTextSymbolIndex:d,verticalPlacedTextSymbolIndex:y,placedIconSymbolIndex:w,verticalPlacedIconSymbolIndex:T}=o;a>=0&&this.addIndicesForPlacedSymbol(this.text,a),h>=0&&h!==a&&this.addIndicesForPlacedSymbol(this.text,h),d>=0&&d!==h&&d!==a&&this.addIndicesForPlacedSymbol(this.text,d),y>=0&&this.addIndicesForPlacedSymbol(this.text,y),w>=0&&this.addIndicesForPlacedSymbol(this.icon,w),T>=0&&this.addIndicesForPlacedSymbol(this.icon,T)}this.text.indexBuffer&&this.text.indexBuffer.updateData(this.text.indexArray),this.icon.indexBuffer&&this.icon.indexBuffer.updateData(this.icon.indexArray)}}}let Pw,Rw,_0;Kt(vg,"SymbolBucket",{omit:["layers","collisionBoxArray","features","compareText"]}),vg.addDynamicAttributes=yg;class Mw{constructor(e){this.type=e.property.overrides?e.property.overrides.runtimeType:rc,this.defaultValue=e}evaluate(e){if(e.formattedSection){const i=this.defaultValue.property.overrides;if(i&&i.hasOverride(e.formattedSection))return i.getOverride(e.formattedSection)}return e.feature&&e.featureState?this.defaultValue.evaluate(e.feature,e.featureState):this.defaultValue.property.specification.default}eachChild(e){this.defaultValue.isConstant()||e(this.defaultValue.value._styleExpression.expression)}outputDefined(){return!1}serialize(){return null}}Kt(Mw,"FormatSectionOverride",{omit:["defaultValue"]});const g0=()=>_0||(_0={layout:Pw||(Pw=new Fr({"symbol-placement":new _t(Le.layout_symbol["symbol-placement"]),"symbol-spacing":new _t(Le.layout_symbol["symbol-spacing"]),"symbol-avoid-edges":new _t(Le.layout_symbol["symbol-avoid-edges"]),"symbol-sort-key":new Wt(Le.layout_symbol["symbol-sort-key"]),"symbol-z-order":new _t(Le.layout_symbol["symbol-z-order"]),"symbol-z-elevate":new _t(Le.layout_symbol["symbol-z-elevate"]),"symbol-elevation-reference":new _t(Le.layout_symbol["symbol-elevation-reference"]),"icon-allow-overlap":new _t(Le.layout_symbol["icon-allow-overlap"]),"icon-ignore-placement":new _t(Le.layout_symbol["icon-ignore-placement"]),"icon-optional":new _t(Le.layout_symbol["icon-optional"]),"icon-rotation-alignment":new _t(Le.layout_symbol["icon-rotation-alignment"]),"icon-size":new Wt(Le.layout_symbol["icon-size"]),"icon-size-scale-range":new _t(Le.layout_symbol["icon-size-scale-range"]),"icon-text-fit":new Wt(Le.layout_symbol["icon-text-fit"]),"icon-text-fit-padding":new Wt(Le.layout_symbol["icon-text-fit-padding"]),"icon-image":new Wt(Le.layout_symbol["icon-image"]),"icon-rotate":new Wt(Le.layout_symbol["icon-rotate"]),"icon-padding":new _t(Le.layout_symbol["icon-padding"]),"icon-keep-upright":new _t(Le.layout_symbol["icon-keep-upright"]),"icon-offset":new Wt(Le.layout_symbol["icon-offset"]),"icon-anchor":new Wt(Le.layout_symbol["icon-anchor"]),"icon-pitch-alignment":new _t(Le.layout_symbol["icon-pitch-alignment"]),"text-pitch-alignment":new _t(Le.layout_symbol["text-pitch-alignment"]),"text-rotation-alignment":new _t(Le.layout_symbol["text-rotation-alignment"]),"text-field":new Wt(Le.layout_symbol["text-field"]),"text-font":new Wt(Le.layout_symbol["text-font"]),"text-size":new Wt(Le.layout_symbol["text-size"]),"text-size-scale-range":new _t(Le.layout_symbol["text-size-scale-range"]),"text-max-width":new Wt(Le.layout_symbol["text-max-width"]),"text-line-height":new Wt(Le.layout_symbol["text-line-height"]),"text-letter-spacing":new Wt(Le.layout_symbol["text-letter-spacing"]),"text-justify":new Wt(Le.layout_symbol["text-justify"]),"text-radial-offset":new Wt(Le.layout_symbol["text-radial-offset"]),"text-variable-anchor":new _t(Le.layout_symbol["text-variable-anchor"]),"text-anchor":new Wt(Le.layout_symbol["text-anchor"]),"text-max-angle":new _t(Le.layout_symbol["text-max-angle"]),"text-writing-mode":new _t(Le.layout_symbol["text-writing-mode"]),"text-rotate":new Wt(Le.layout_symbol["text-rotate"]),"text-padding":new _t(Le.layout_symbol["text-padding"]),"text-keep-upright":new _t(Le.layout_symbol["text-keep-upright"]),"text-transform":new Wt(Le.layout_symbol["text-transform"]),"text-offset":new Wt(Le.layout_symbol["text-offset"]),"text-allow-overlap":new _t(Le.layout_symbol["text-allow-overlap"]),"text-ignore-placement":new _t(Le.layout_symbol["text-ignore-placement"]),"text-optional":new _t(Le.layout_symbol["text-optional"]),visibility:new _t(Le.layout_symbol.visibility)})),paint:Rw||(Rw=new Fr({"icon-opacity":new Wt(Le.paint_symbol["icon-opacity"]),"icon-occlusion-opacity":new Wt(Le.paint_symbol["icon-occlusion-opacity"]),"icon-emissive-strength":new Wt(Le.paint_symbol["icon-emissive-strength"]),"text-emissive-strength":new Wt(Le.paint_symbol["text-emissive-strength"]),"icon-color":new Wt(Le.paint_symbol["icon-color"]),"icon-halo-color":new Wt(Le.paint_symbol["icon-halo-color"]),"icon-halo-width":new Wt(Le.paint_symbol["icon-halo-width"]),"icon-halo-blur":new Wt(Le.paint_symbol["icon-halo-blur"]),"icon-translate":new _t(Le.paint_symbol["icon-translate"]),"icon-translate-anchor":new _t(Le.paint_symbol["icon-translate-anchor"]),"icon-image-cross-fade":new _t(Le.paint_symbol["icon-image-cross-fade"]),"text-opacity":new Wt(Le.paint_symbol["text-opacity"]),"text-occlusion-opacity":new Wt(Le.paint_symbol["text-occlusion-opacity"]),"text-color":new Wt(Le.paint_symbol["text-color"],{runtimeType:Cs,getOverride:n=>n.textColor,hasOverride:n=>!!n.textColor}),"text-halo-color":new Wt(Le.paint_symbol["text-halo-color"]),"text-halo-width":new Wt(Le.paint_symbol["text-halo-width"]),"text-halo-blur":new Wt(Le.paint_symbol["text-halo-blur"]),"text-translate":new _t(Le.paint_symbol["text-translate"]),"text-translate-anchor":new _t(Le.paint_symbol["text-translate-anchor"]),"icon-color-saturation":new _t(Le.paint_symbol["icon-color-saturation"]),"icon-color-contrast":new _t(Le.paint_symbol["icon-color-contrast"]),"icon-color-brightness-min":new _t(Le.paint_symbol["icon-color-brightness-min"]),"icon-color-brightness-max":new _t(Le.paint_symbol["icon-color-brightness-max"]),"symbol-z-offset":new Wt(Le.paint_symbol["symbol-z-offset"]),"icon-color-use-theme":new Wt({type:"string",default:"default","property-type":"data-driven"}),"icon-halo-color-use-theme":new Wt({type:"string",default:"default","property-type":"data-driven"}),"text-color-use-theme":new Wt({type:"string",default:"default","property-type":"data-driven"}),"text-halo-color-use-theme":new Wt({type:"string",default:"default","property-type":"data-driven"})}))},_0);class xg extends ho{constructor(e,i,o,a){super(e,g0(),i,o,a),this._colorAdjustmentMatrix=ct([]),this.hasInitialOcclusionOpacityProperties=e.paint!==void 0&&("icon-occlusion-opacity"in e.paint||"text-occlusion-opacity"in e.paint)}recalculate(e,i){super.recalculate(e,i),this.layout.get("icon-rotation-alignment")==="auto"&&(this.layout._values["icon-rotation-alignment"]=this.layout.get("symbol-placement")!=="point"?"map":"viewport"),this.layout.get("text-rotation-alignment")==="auto"&&(this.layout._values["text-rotation-alignment"]=this.layout.get("symbol-placement")!=="point"?"map":"viewport"),this.layout.get("text-pitch-alignment")==="auto"&&(this.layout._values["text-pitch-alignment"]=this.layout.get("text-rotation-alignment")),this.layout.get("icon-pitch-alignment")==="auto"&&(this.layout._values["icon-pitch-alignment"]=this.layout.get("icon-rotation-alignment"));const o=this.layout.get("text-writing-mode");if(o){const a=[];for(const h of o)a.indexOf(h)<0&&a.push(h);this.layout._values["text-writing-mode"]=a}else this.layout._values["text-writing-mode"]=this.layout.get("symbol-placement")==="point"?["horizontal"]:["horizontal","vertical"];this._setPaintOverrides()}getColorAdjustmentMatrix(e,i,o,a){return this._saturation===e&&this._contrast===i&&this._brightnessMin===o&&this._brightnessMax===a||(this._colorAdjustmentMatrix=(function(h,d,y,w){h=Ns(h),d=rs(d);const T=$t(),C=h/3,P=1-2*C,D=[P,C,C,0,C,P,C,0,C,C,P,0,0,0,0,1],O=.5-.5*d,N=w-y;return Nt(T,[N,0,0,0,0,N,0,0,0,0,N,0,y,y,y,1],[d,0,0,0,0,d,0,0,0,0,d,0,O,O,O,1]),Nt(T,T,D),T})(e,i,o,a),this._saturation=e,this._contrast=i,this._brightnessMin=o,this._brightnessMax=a),this._colorAdjustmentMatrix}getValueAndResolveTokens(e,i,o,a){const h=this.layout.get(e).evaluate(i,{},o,a),d=this._unevaluatedLayout._values[e];return d.isDataDriven()||Bd(d.value)||!h?h:(function(y,w){return w.replace(/{([^{}]+)}/g,((T,C)=>C in y?String(y[C]):""))})(i.properties,h)}createBucket(e){return new vg(e)}queryRadius(){return 0}queryIntersectsFeature(){return!1}_setPaintOverrides(){for(const e of g0().paint.overridableProperties){if(!xg.hasPaintOverride(this.layout,e))continue;const i=this.paint.get(e),o=new Mw(i),a=new Uc(o,i.property.specification,this.scope,this.options);let h=null;h=i.value.kind==="constant"||i.value.kind==="source"?new Tu("source",a):new Ca("composite",a,i.value.zoomStops,i.value.interpolationType),this.paint._values[e]=new vl(i.property,h,i.parameters)}}_handleOverridablePaintPropertyUpdate(e,i,o){return!(!this.layout||i.isDataDriven()||o.isDataDriven())&&xg.hasPaintOverride(this.layout,e)}static hasPaintOverride(e,i){const o=e.get("text-field"),a=g0().paint.properties[i];let h=!1;const d=y=>{for(const w of y)if(a.overrides&&a.overrides.hasOverride(w))return void(h=!0)};if(o.value.kind==="constant"&&o.value.value instanceof Mt)d(o.value.value.sections);else if(o.value.kind==="source"){const y=T=>{h||(T instanceof _i&&Vt(T.value)===sc?d(T.value.sections):T instanceof au?d(T.sections):T.eachChild(y))},w=o.value;w._styleExpression&&y(w._styleExpression.expression)}return h}getProgramIds(){return["symbol"]}getDefaultProgramParams(e,i,o){return{config:new Ss(this,{zoom:i,lut:o}),overrideFog:!1}}hasElevation(){return this.layout&&this.layout.get("symbol-elevation-reference")==="hd-road-markup"}}let Dw,Lw,kw,zw;var y0=hn([{name:"a_pos",type:"Int16",components:2},{name:"a_texture_pos",type:"Int16",components:2}]);function wg(n,e,i,o,a,h,d,y){const w=[n,e,1,i,o,1,a,h,1],T=[d,y,1],C=Xe([],w),[P,D,O]=ao(T,T,C);return St(w,w,[P,0,0,0,D,0,0,0,O])}function Fw(n,e,i,o,a,h,d,y){const w=(function(T,C,P,D,O,N,G,q){const Y=wg(0,0,1,0,1,1,0,1),se=wg(T,C,P,D,O,N,G,q);return St(se,se,Xe([],Y))})(n,e,i,o,a,h,d,y);return[w[2]/w[8]/zt,w[5]/w[8]/zt]}function bg(n){return[n[0],Math.min(Math.max(n[1],-pe),pe)]}class Ow extends hl{constructor(e,i,o,a){super(),this.id=e,this.dispatcher=o,this.coordinates=i.coordinates,this.type="image",this.minzoom=0,this.maxzoom=22,this.tileSize=512,this.tiles={},this._loaded=!1,this.onNorthPole=!1,this.onSouthPole=!1,this.setEventedParent(a),this.options=i,this._dirty=!1}load(e,i){if(this._loaded=i||!1,this.fire(new ba("dataloading",{dataType:"source"})),this.url=this.options.url,!this.url)return e&&(this.coordinates=e),this._loaded=!0,void this._finishLoading();this._imageRequest=jo(this.map._requestManager.transformRequest(this.url,ea.Image),((o,a)=>{this._imageRequest=null,this._loaded=!0,o?this.fire(new ds(o)):a&&(this.image=a instanceof HTMLImageElement?go.getImageData(a):a,this._dirty=!0,this.width=this.image.width,this.height=this.image.height,e&&(this.coordinates=e),this._finishLoading())}))}loaded(){return this._loaded}updateImage(e){return e.url?(this._imageRequest&&e.url!==this.options.url&&(this._imageRequest.cancel(),this._imageRequest=null),this.options.url=e.url,this.load(e.coordinates,this._loaded),this):this}setTexture(e){if(!(e.handle instanceof WebGLTexture))throw new Error("The provided handle is not a WebGLTexture instance");return this.texture=new Nm(this.map.painter.context,e.handle),this.width=e.dimensions[0],this.height=e.dimensions[1],this._dirty=!1,this._loaded=!0,this._finishLoading(),this}_finishLoading(){this.map&&(this.setCoordinates(this.coordinates),this.fire(new ba("data",{dataType:"source",sourceDataType:"metadata"})))}onAdd(e){this.map=e,this.load()}onRemove(e){this._imageRequest&&(this._imageRequest.cancel(),this._imageRequest=null),!this.texture||this.texture instanceof Nm||this.texture.destroy(),this.boundsBuffer&&(this.boundsBuffer.destroy(),this.elevatedGlobeVertexBuffer&&this.elevatedGlobeVertexBuffer.destroy(),this.elevatedGlobeIndexBuffer&&this.elevatedGlobeIndexBuffer.destroy())}setCoordinates(e){if(this.coordinates=e,this._boundsArray=void 0,this._unsupportedCoords=!1,!e.length)return this;this.onNorthPole=!1,this.onSouthPole=!1;let i=e[0][1],o=e[0][1];for(const h of e)h[1]>o&&(o=h[1]),h[1]<i&&(i=h[1]);const a=(o+i)/2;if(a>pe?this.onNorthPole=!0:a<-pe&&(this.onSouthPole=!0),!this.onNorthPole&&!this.onSouthPole){const h=e.map(ge.fromLngLat);this.tileID=(function(d){let y=1/0,w=1/0,T=-1/0,C=-1/0;for(const G of d)y=Math.min(y,G.x),w=Math.min(w,G.y),T=Math.max(T,G.x),C=Math.max(C,G.y);const P=Math.max(T-y,C-w),D=Math.max(0,Math.floor(-Math.log(P)/Math.LN2)),O=Math.pow(2,D);let N=Math.floor((y+T)/2*O);return N>1&&(N-=1),new Lo(D,N,Math.floor((w+C)/2*O))})(h),this.minzoom=this.maxzoom=this.tileID.z}return this.fire(new ba("data",{dataType:"source",sourceDataType:"content"})),this}_clear(){!this.texture||this.texture instanceof Nm||(this.texture.destroy(),this._dirty=!0),this.texture=null,this._boundsArray=void 0,this._unsupportedCoords=!1}_prepareData(e){for(const Y in this.tiles){const se=this.tiles[Y];se.state!=="loaded"&&(se.state="loaded",se.texture=this.texture)}if(this._boundsArray||this.onNorthPole||this.onSouthPole||this._unsupportedCoords)return;const i=Zm(new Lo(0,0,0),this.map.transform.projection),o=[i.projection.project(this.coordinates[0][0],this.coordinates[0][1]),i.projection.project(this.coordinates[1][0],this.coordinates[1][1]),i.projection.project(this.coordinates[2][0],this.coordinates[2][1]),i.projection.project(this.coordinates[3][0],this.coordinates[3][1])];if(!(function(Y){const se=Y[1].x-Y[0].x,re=Y[1].y-Y[0].y,ae=Y[2].x-Y[1].x,Ee=Y[2].y-Y[1].y,ve=Y[3].x-Y[2].x,xe=Y[3].y-Y[2].y,Pe=Y[0].x-Y[3].x,Me=Y[0].y-Y[3].y,it=se*Ee-ae*re,Fe=ae*xe-ve*Ee,ot=ve*Me-Pe*xe,Dt=Pe*re-se*Me;return it>0&&Fe>0&&ot>0&&Dt>0||it<0&&Fe<0&&ot<0&&Dt<0})(o))return console.warn("Image source coordinates are defining non-convex area in the Mercator projection"),void(this._unsupportedCoords=!0);const a=Zm(this.tileID,this.map.transform.projection),[h,d,y,w]=this.coordinates.map((Y=>{const se=a.projection.project(Y[0],Y[1]);return Tw(a,se)._round()}));this.perspectiveTransform=Fw(h.x,h.y,d.x,d.y,y.x,y.y,w.x,w.y);const T=this._boundsArray=new Du;T.emplaceBack(h.x,h.y,0,0),T.emplaceBack(d.x,d.y,zt,0),T.emplaceBack(w.x,w.y,0,zt),T.emplaceBack(y.x,y.y,zt,zt),this.boundsBuffer&&(this.boundsBuffer.destroy(),this.elevatedGlobeVertexBuffer&&this.elevatedGlobeVertexBuffer.destroy(),this.elevatedGlobeIndexBuffer&&this.elevatedGlobeIndexBuffer.destroy()),this.boundsBuffer=e.createVertexBuffer(T,y0.members),this.boundsSegments=kr.simpleSegment(0,0,4,2);const C=[],P=[bg((D=this.coordinates)[0]),bg(D[1]),bg(D[2]),bg(D[3])];var D;const[O,N,G,q]=(function(Y){let se=Y[0][0],re=se,ae=Y[0][1],Ee=ae;for(let ve=1;ve<Y.length;ve++)Y[ve][0]<se?se=Y[ve][0]:Y[ve][0]>re&&(re=Y[ve][0]),Y[ve][1]<ae?ae=Y[ve][1]:Y[ve][1]>Ee&&(Ee=Y[ve][1]);return[se,ae,re-se,Ee-ae]})(P);{const Y=new Du,[se,re,ae,Ee]=(function(et){let Tt=et[0].x,Ve=Tt,tt=et[0].y,Lt=tt;for(let Et=1;Et<et.length;Et++)et[Et].x<Tt?Tt=et[Et].x:et[Et].x>Ve&&(Ve=et[Et].x),et[Et].y<tt?tt=et[Et].y:et[Et].y>Lt&&(Lt=et[Et].y);return[Tt,tt,Ve-Tt,Lt-tt]})(o),ve=et=>[(et.x-se)/ae,(et.y-re)/Ee],[xe,Pe,Me,it]=o.map(ve),Fe=(function(et,Tt,Ve,tt,Lt,Et,li,Yt){const vt=wg(0,0,1,0,1,1,0,1);return St(vt,vt,Xe([],wg(et,Tt,Ve,tt,Lt,Et,li,Yt)))})(xe[0],xe[1],Pe[0],Pe[1],Me[0],Me[1],it[0],it[1]);this.elevatedGlobePerspectiveTransform=Fw(xe[0],xe[1],Pe[0],Pe[1],Me[0],Me[1],it[0],it[1]);const ot=(et,Tt)=>{C.push(et.lng);const Ve=Math.round((et.lng-O)/G*zt),tt=Math.round((et.lat-N)/q*zt),Lt=ve(Tt),Et=ao([],[Lt[0],Lt[1],1],Fe),li=Math.round(Et[0]/Et[2]*zt),Yt=Math.round(Et[1]/Et[2]*zt);Y.emplaceBack(Ve,tt,li,Yt)},Dt=o[3].x-o[0].x,ht=o[3].y-o[0].y,bt=o[2].x-o[1].x,Rt=o[2].y-o[1].y;for(let et=0;et<65;et++){const Tt=et/64,Ve=[o[0].x+Tt*Dt,o[0].y+Tt*ht],tt=[o[1].x+Tt*bt,o[1].y+Tt*Rt],Lt=tt[0]-Ve[0],Et=tt[1]-Ve[1];for(let li=0;li<65;li++){const Yt=li/64,vt={x:Ve[0]+Lt*Yt,y:Ve[1]+Et*Yt};ot(i.projection.unproject(vt.x,vt.y),vt)}}this.elevatedGlobeVertexBuffer=e.createVertexBuffer(Y,y0.members)}{this.maxLongitudeTriangleSize=0;let Y=[],se=new yr;const re=(ae,Ee,ve)=>{se.emplaceBack(ae,Ee,ve);const xe=C[ae],Pe=C[Ee],Me=C[ve],it=Math.min(Math.min(xe,Pe),Me),Fe=Math.max(Math.max(xe,Pe),Me)-it;Fe>this.maxLongitudeTriangleSize&&(this.maxLongitudeTriangleSize=Fe),Y.push(it+Fe/2)};for(let ae=0;ae<64;ae++)for(let Ee=0;Ee<64;Ee++){const ve=65*ae+Ee,xe=ve+1,Pe=ve+65,Me=Pe+1;re(ve,Pe,xe),re(xe,Pe,Me)}[Y,se]=(function(ae,Ee){const ve=Array.from({length:ae.length},((Me,it)=>it));ve.sort(((Me,it)=>ae[Me]-ae[it]));const xe=[],Pe=new yr;for(let Me=0;Me<ve.length;Me++){const it=ve[Me];xe.push(ae[it]);const Fe=3*it,ot=Fe+1;Pe.emplaceBack(Ee.uint16[Fe],Ee.uint16[ot],Ee.uint16[ot+1])}return[xe,Pe]})(Y,se),this.elevatedGlobeTrianglesCenterLongitudes=Y,this.elevatedGlobeIndexBuffer=e.createIndexBuffer(se)}this.elevatedGlobeSegments=kr.simpleSegment(0,0,4225,8192),this.elevatedGlobeGridMatrix=new Float32Array([0,G/zt,0,q/zt,0,0,N,O,0])}prepare(){const e=Object.keys(this.tiles).length!==0;if(this.tileID&&!e)return;const i=this.map.painter.context,o=i.gl;!this._dirty||this.texture instanceof Nm||(this.texture?this.texture.update(this.image):(this.texture=new Wy(i,this.image,o.RGBA8),this.texture.bind(o.LINEAR,o.CLAMP_TO_EDGE)),this._dirty=!1),e&&this._prepareData(i)}loadTile(e,i){this.tileID&&this.tileID.equals(e.tileID.canonical)?(this.tiles[String(e.tileID.wrap)]=e,e.buckets={},i(null)):(e.state="errored",i(null))}serialize(){return{type:"image",url:this.options.url,coordinates:this.coordinates}}hasTransition(){return!1}getSegmentsForLongitude(e){const i=this.elevatedGlobeSegments;if(!this.elevatedGlobeTrianglesCenterLongitudes||!i)return null;const o=this.elevatedGlobeTrianglesCenterLongitudes;let a=(h=e+180)+360*Math.round((o[0]-h)/360);var h;const d=new kr,y=(P,D)=>{d.segments.push({vertexOffset:0,primitiveOffset:P,vertexLength:i.segments[0].vertexLength,primitiveLength:D,sortKey:void 0,vaos:{}})},w=.51*this.maxLongitudeTriangleSize;if(Math.abs(o[0]-a)<=w){const P=us(o,0,o.length,a+w);return P===o.length||y(P,Tr(o,P+1,o.length,a+360-w)-P),d}a<o[0]&&(a+=360);const T=Tr(o,0,o.length,a-w);if(T===o.length)return y(0,o.length),d;y(0,T-0);const C=us(o,T+1,o.length,a+w);return C!==o.length&&y(C,o.length-C),d}}const aI=(Math.pow(256,2)-1)/16907520;class Bw extends ho{constructor(e,i,o,a){super(e,{layout:kw||(kw=new Fr({visibility:new _t(Le.layout_raster.visibility)})),paint:zw||(zw=new Fr({"raster-opacity":new _t(Le.paint_raster["raster-opacity"]),"raster-color":new jc(Le.paint_raster["raster-color"]),"raster-color-mix":new _t(Le.paint_raster["raster-color-mix"]),"raster-color-range":new _t(Le.paint_raster["raster-color-range"]),"raster-hue-rotate":new _t(Le.paint_raster["raster-hue-rotate"]),"raster-brightness-min":new _t(Le.paint_raster["raster-brightness-min"]),"raster-brightness-max":new _t(Le.paint_raster["raster-brightness-max"]),"raster-saturation":new _t(Le.paint_raster["raster-saturation"]),"raster-contrast":new _t(Le.paint_raster["raster-contrast"]),"raster-resampling":new _t(Le.paint_raster["raster-resampling"]),"raster-fade-duration":new _t(Le.paint_raster["raster-fade-duration"]),"raster-emissive-strength":new _t(Le.paint_raster["raster-emissive-strength"]),"raster-array-band":new _t(Le.paint_raster["raster-array-band"]),"raster-elevation":new _t(Le.paint_raster["raster-elevation"]),"raster-color-use-theme":new Wt({type:"string",default:"default","property-type":"data-driven"})}))},i,o,a),this.updateColorRamp(),this._curRampRange=[NaN,NaN]}getProgramIds(){return["raster"]}hasColorMap(){return!!this._transitionablePaint._values["raster-color"].value.value}tileCoverLift(){return this.paint.get("raster-elevation")}isDraped(e){return!(e&&e._source instanceof Ow&&(e._source.onNorthPole||e._source.onSouthPole))&&this.paint.get("raster-elevation")===0}_handleSpecialPaintPropertyUpdate(e){e!=="raster-color"&&e!=="raster-color-range"||(this._curRampRange=[NaN,NaN],this.updateColorRamp())}_clear(){this.colorRampTexture&&(this.colorRampTexture.destroy(),this.colorRampTexture=null)}updateColorRamp(e){if(!this.hasColorMap()||!this._curRampRange)return;const i=this._transitionablePaint._values["raster-color"].value.expression,[o,a]=e||this._transitionablePaint._values["raster-color-range"].value.expression.evaluate({zoom:0})||[NaN,NaN];isNaN(o)&&isNaN(a)||o===this._curRampRange[0]&&a===this._curRampRange[1]||(this.colorRamp=Em({expression:i,evaluationKey:"rasterValue",image:this.colorRamp,clips:[{start:o,end:a}],resolution:256}),this.colorRampTexture=null,this._curRampRange=[o,a])}}let Nw,Vw,Uw,jw,Gw;class Hw extends ho{constructor(e,i,o,a){super(e,{layout:Nw||(Nw=new Fr({visibility:new _t(Le["layout_raster-particle"].visibility)})),paint:Vw||(Vw=new Fr({"raster-particle-array-band":new _t(Le["paint_raster-particle"]["raster-particle-array-band"]),"raster-particle-count":new _t(Le["paint_raster-particle"]["raster-particle-count"]),"raster-particle-color":new jc(Le["paint_raster-particle"]["raster-particle-color"]),"raster-particle-max-speed":new _t(Le["paint_raster-particle"]["raster-particle-max-speed"]),"raster-particle-speed-factor":new _t(Le["paint_raster-particle"]["raster-particle-speed-factor"]),"raster-particle-fade-opacity-factor":new _t(Le["paint_raster-particle"]["raster-particle-fade-opacity-factor"]),"raster-particle-reset-rate-factor":new _t(Le["paint_raster-particle"]["raster-particle-reset-rate-factor"]),"raster-particle-elevation":new _t(Le["paint_raster-particle"]["raster-particle-elevation"]),"raster-particle-color-use-theme":new Wt({type:"string",default:"default","property-type":"data-driven"})}))},i,o,a),this._updateColorRamp(),this.lastInvalidatedAt=go.now()}_clear(){this.colorRampTexture&&(this.colorRampTexture.destroy(),this.colorRampTexture=null),this.tileFramebuffer&&(this.tileFramebuffer.destroy(),this.tileFramebuffer=null),this.particleFramebuffer&&(this.particleFramebuffer.destroy(),this.particleFramebuffer=null)}onRemove(e){this.colorRampTexture&&this.colorRampTexture.destroy(),this.tileFramebuffer&&this.tileFramebuffer.destroy(),this.particleFramebuffer&&this.particleFramebuffer.destroy()}hasColorMap(){return!!this._transitionablePaint._values["raster-particle-color"].value.value}getProgramIds(){return["rasterParticle"]}hasOffscreenPass(){return this.visibility!=="none"}isDraped(e){return!1}_handleSpecialPaintPropertyUpdate(e){e!=="raster-particle-color"&&e!=="raster-particle-max-speed"||(this._updateColorRamp(),this._invalidateAnimationState()),e==="raster-particle-count"&&this._invalidateAnimationState()}_updateColorRamp(){if(!this.hasColorMap())return;const e=this._transitionablePaint._values["raster-particle-color"].value.expression,i=this._transitionablePaint._values["raster-particle-max-speed"].value.expression.evaluate({zoom:0});this.colorRamp=Em({expression:e,evaluationKey:"rasterParticleSpeed",image:this.colorRamp,clips:[{start:0,end:i}],resolution:256}),this.colorRampTexture=null}_invalidateAnimationState(){this.lastInvalidatedAt=go.now()}tileCoverLift(){return this.paint.get("raster-particle-elevation")}}class lI extends ho{constructor(e,i){super(e,{},i,null),this.implementation=e,e.slot&&(this.slot=e.slot)}is3D(e){return this.implementation.renderingMode==="3d"}hasOffscreenPass(){return this.implementation.prerender!==void 0}isDraped(e){return this.implementation.renderToTile!==void 0}shouldRedrape(){return!!this.implementation.shouldRerenderTiles&&this.implementation.shouldRerenderTiles()}recalculate(){}updateTransitions(){}hasTransition(){return!1}serialize(){}onAdd(e){this.implementation.onAdd&&this.implementation.onAdd(e,e.painter.context.gl)}onRemove(e){this.implementation.onRemove&&this.implementation.onRemove(e,e.painter.context.gl)}}function v0(n,e,i){const o=[0,0,1],a=vs([]);return Fa(a,a,i?-vn(n)+Math.PI:vn(n)),Qo(a,a,-vn(e)),Bo(o,o,a),zi(o,o)}const qw={None:0,Model:1,Symbol:2,FillExtrusion:4};class Tg{constructor(e,i,o,a){this.message=(e?`${e}: `:"")+o,a&&(this.identifier=a),i!=null&&i.__line__&&(this.line=i.__line__)}}function x0(n,e){const i=n.indexOf("://")===-1;try{return new URL(n,i&&e?"http://example.com":void 0),!0}catch{return!1}}class $w{constructor(e,i){this.feature=e,this.instancedDataOffset=i,this.instancedDataCount=0,this.rotation=[0,0,0],this.scale=[1,1,1],this.translation=[0,0,0]}}class Ww{constructor(){this.instancedDataArray=new od,this.instancesEvaluatedElevation=[],this.features=[],this.idToFeaturesIndex={}}}class w0{constructor(e){this.zoom=e.zoom,this.canonical=e.canonical,this.layers=e.layers,this.layerIds=this.layers.map((i=>i.fqid)),this.projection=e.projection,this.index=e.index,this.worldview=e.worldview,this.hasZoomDependentProperties=this.layers[0].isZoomDependent(),this.stateDependentLayerIds=this.layers.filter((i=>i.isStateDependent())).map((i=>i.id)),this.hasPattern=!1,this.instancesPerModel={},this.validForExaggeration=0,this.maxVerticalOffset=0,this.maxScale=0,this.maxHeight=0,this.lookupDim=this.zoom>this.canonical.z?256:this.zoom>15?75:100,this.instanceCount=0,this.terrainElevationMin=0,this.terrainElevationMax=0,this.validForDEMTile={id:null,timestamp:0},this.modelUris=[],this.modelsRequested=!1,this.activeReplacements=[],this.replacementUpdateTime=0,this.styleDefinedModelURLs=e.styleDefinedModelURLs}updateFootprints(e,i){}populate(e,i,o,a){this.tileToMeter=_e(o);const h=this.layers[0]._featureFilter.needGeometry;this.lookup=new Uint8Array(this.lookupDim*this.lookupDim);for(const{feature:d,id:y,index:w,sourceLayerIndex:T}of e){const C=y??(d.properties&&d.properties.hasOwnProperty("id")?d.properties.id:void 0),P=Ze(d,h);if(!this.layers[0]._featureFilter.filter(new Wn(this.zoom,{worldview:this.worldview}),P,o))continue;const D={id:C,sourceLayerIndex:T,index:w,geometry:h?P.geometry:Te(d,o,a),properties:d.properties,type:d.type,patterns:{}},O=this.addFeature(D,D.geometry,P);O&&i.featureIndex.insert(d,D.geometry,w,T,this.index,this.instancesPerModel[O].instancedDataArray.length,zt/32)}this.lookup=null}update(e,i,o,a){for(const h in this.instancesPerModel){const d=this.instancesPerModel[h];for(const y in e)d.idToFeaturesIndex.hasOwnProperty(y)&&(this.evaluate(d.features[d.idToFeaturesIndex[y]],e[y],d,!0),this.uploaded=!1)}this.maxHeight=0}updateZoomBasedPaintProperties(){if(!this.hasZoomDependentProperties)return!1;let e=!1;for(const i in this.instancesPerModel){const o=this.instancesPerModel[i];for(const a of o.features){const h=this.layers[0],d=a.feature,y=this.canonical,w=h.paint.get("model-rotation").evaluate(d,{},y),T=h.paint.get("model-scale").evaluate(d,{},y),C=h.paint.get("model-translation").evaluate(d,{},y);Bs(a.rotation,w)&&Bs(a.scale,T)&&Bs(a.translation,C)||(this.evaluate(a,a.featureStates,o,!0),e=!0)}}return e}updateReplacement(e,i,o,a){if(i.updateTime===this.replacementUpdateTime)return!1;this.replacementUpdateTime=i.updateTime;const h=i.getReplacementRegionsForTile(e.toUnwrapped(),!0);if(Z_(this.activeReplacements,h))return!1;this.activeReplacements=h;let d=!1;for(const y in this.instancesPerModel){const w=this.instancesPerModel[y],T=w.instancedDataArray;for(const C of w.features){const P=C.instancedDataOffset,D=C.instancedDataCount;for(let O=0;O<D;O++){const N=16*(O+P);let G=T.float32[N+0];const q=G>zt;G=q?G-zt:G;const Y=Math.floor(G),se=T.float32[N+1];let re=!1;for(const ae of this.activeReplacements)if(!kx(ae,o,qw.Model,a)&&!(ae.min.x>Y||Y>ae.max.x||ae.min.y>se||se>ae.max.y)&&(re=zy(Bx(Y,se,e.canonical,ae.footprintTileId.canonical),ae.footprint),re))break;T.float32[N]=re?G+zt:G,d=d||re!==q}}}return d}isEmpty(){for(const e in this.instancesPerModel)if(this.instancesPerModel[e].instancedDataArray.length!==0)return!1;return!0}uploadPending(){return!this.uploaded}upload(e){if(!this.uploaded)for(const i in this.instancesPerModel){const o=this.instancesPerModel[i];o.instancedDataArray.length<0||o.instancedDataArray.length===0||(o.instancedDataBuffer?o.instancedDataBuffer.updateData(o.instancedDataArray):o.instancedDataBuffer=e.createVertexBuffer(o.instancedDataArray,UE.members,!0,void 0,this.instanceCount))}this.uploaded=!0}destroy(){for(const i in this.instancesPerModel){const o=this.instancesPerModel[i];o.instancedDataArray.length!==0&&o.instancedDataBuffer&&o.instancedDataBuffer.destroy()}const e=this.layers[0].modelManager;if(e&&this.modelUris&&this.modelsRequested)for(const i of this.modelUris)e.removeModel(i,"",!0)}addFeature(e,i,o){const a=this.layers[0],h=a.layout.get("model-id").evaluate(o,{},this.canonical);if(!h)return tn(`modelId is not evaluated for layer ${a.id} and it is not going to get rendered.`),h;(x0(h,!1)||this.styleDefinedModelURLs[h]!==void 0)&&(this.modelUris.includes(h)||this.modelUris.push(h)),this.instancesPerModel[h]||(this.instancesPerModel[h]=new Ww);const d=this.instancesPerModel[h],y=d.instancedDataArray,w=new $w(o,y.length);for(const T of i)for(const C of T){if(C.x<0||C.x>=zt||C.y<0||C.y>=zt)continue;const P=(this.lookupDim-1)/zt,D=this.lookupDim*(C.y*P|0)+C.x*P|0;if(this.lookup){if(this.lookup[D]!==0)continue;this.lookup[D]=1}this.instanceCount++;const O=y.length;y.resize(O+1),d.instancesEvaluatedElevation.push(0),y.float32[16*O]=C.x,y.float32[16*O+1]=C.y}return w.instancedDataCount=d.instancedDataArray.length-w.instancedDataOffset,w.instancedDataCount>0&&(e.id&&(d.idToFeaturesIndex[e.id]=d.features.length),d.features.push(w),this.evaluate(w,{},d,!1)),h}getModelUris(){return this.modelUris}evaluate(e,i,o,a){const h=this.layers[0],d=e.feature,y=this.canonical,w=e.rotation=h.paint.get("model-rotation").evaluate(d,i,y),T=e.scale=h.paint.get("model-scale").evaluate(d,i,y),C=e.translation=h.paint.get("model-translation").evaluate(d,i,y),P=h.paint.get("model-color").evaluate(d,i,y);P.a=h.paint.get("model-color-mix-intensity").evaluate(d,i,y);const D=[];this.maxVerticalOffset<C[2]&&(this.maxVerticalOffset=C[2]),this.maxScale=Math.max(Math.max(this.maxScale,T[0]),Math.max(T[1],T[2])),v1(D,w,T);const O=Math.round(100*P.a)+P.b/1.05;for(let N=0;N<e.instancedDataCount;++N){const G=e.instancedDataOffset+N,q=16*G,Y=o.instancedDataArray.float32;let se=0;a&&(se=Y[q+6]-o.instancesEvaluatedElevation[G]);const re=0|Y[q+1];Y[q]=(0|Y[q])+P.r/1.05,Y[q+1]=re+P.g/1.05,Y[q+2]=O,Y[q+3]=1/(y.z>10?this.tileToMeter:_e(y,re)),Y[q+4]=C[0],Y[q+5]=C[1],Y[q+6]=C[2]+se,Y[q+7]=D[0],Y[q+8]=D[1],Y[q+9]=D[2],Y[q+10]=D[4],Y[q+11]=D[5],Y[q+12]=D[6],Y[q+13]=D[8],Y[q+14]=D[9],Y[q+15]=D[10],o.instancesEvaluatedElevation[G]=C[2]}}}let Zw,Xw;Kt(w0,"ModelBucket",{omit:["layers"]}),Kt(Ww,"PerModelAttributes"),Kt($w,"ModelFeature");class Kp{constructor(e,i,o){this._demTile=e,this._dem=this._demTile.dem,this._scale=i,this._offset=o}static create(e,i,o){const a=o||e.findDEMTileFor(i);if(!a||!a.dem)return;const h=a.dem,d=a.tileID,y=1<<i.canonical.z-d.canonical.z;return new Kp(a,h.dim/zt/y,[(i.canonical.x/y-d.canonical.x)*h.dim,(i.canonical.y/y-d.canonical.y)*h.dim])}tileCoordToPixel(e,i){const o=i*this._scale+this._offset[1];return new gt(Math.floor(e*this._scale+this._offset[0]),Math.floor(o))}getElevationAt(e,i,o,a){const h=e*this._scale+this._offset[0],d=i*this._scale+this._offset[1],y=Math.floor(h),w=Math.floor(d),T=this._dem;return a=!!a,o?di(di(T.get(y,w,a),T.get(y,w+1,a),d-w),di(T.get(y+1,w,a),T.get(y+1,w+1,a),d-w),h-y):T.get(y,w,a)}getElevationAtPixel(e,i,o){return this._dem.get(e,i,!!o)}getMeterToDEM(e){return(1<<this._demTile.tileID.canonical.z)*Z(1,e)*this._dem.stride}}const b0=new Float32Array(262144),up=new Uint8Array(262144);function Kw(n){let e=0;if(n.meshes)for(const i of n.meshes)e=Math.max(e,i.aabb.max[2]);if(n.children)for(const i of n.children)e=Math.max(e,Kw(i));return e}function Yw(n,e,i){if(n.meshes)for(const o of n.meshes){if(o.aabb.min[0]===1/0)continue;const a=Si.applyTransform(o.aabb,n.matrix);i.insert(e,a.min[0],a.min[1],a.max[0],a.max[1])}if(n.children)for(const o of n.children)Yw(o,e,i)}const Qw=["","wall","door","roof","window","lamp","logo"];class Jw{constructor(e){this.node=e,this.evaluatedRMEA=[[1,0,0,1],[1,0,0,1],[1,0,0,1],[1,0,0,1],[.4,1,0,1],[1,0,0,1],[1,0,0,1]],this.hiddenByReplacement=!1,this.evaluatedTranslation=[0,0,0],this.evaluatedScale=[1,1,1],this.evaluatedColor=[],this.emissionHeightBasedParams=[],this.cameraCollisionOpacity=1,this.feature={type:"Point",id:e.id,geometry:[],properties:{height:Kw(e)}},this.aabb=this._getLocalBounds(),this.state=null}_getLocalBounds(){if(!this.node.meshes)return new Si([1/0,1/0,1/0],[-1/0,-1/0,-1/0]);if(!this.aabb){let e=0;const i=new Si([1/0,1/0,1/0],[-1/0,-1/0,-1/0]);for(const o of this.node.meshes)this.node.lightMeshIndex!==e&&(o.transformedAabb=Si.applyTransformFast(o.aabb,this.node.matrix),i.encapsulate(o.transformedAabb)),e++;this.aabb=i}return this.aabb}}class Eg{constructor(e,i,o,a,h,d,y,w){this.id=o,this.layers=e,this.layerIds=this.layers.map((T=>T.fqid)),this.stateDependentLayerIds=this.layers.filter((T=>T.isStateDependent())).map((T=>T.id)),this.modelTraits|=Hp.CoordinateSpaceTile,this.uploaded=!1,this.hasPattern=!1,a&&(this.modelTraits|=Hp.HasMapboxMeshFeatures),h&&(this.modelTraits|=Hp.HasMeshoptCompression),this.zoom=-1,this.terrainExaggeration=1,this.projection={name:"mercator"},this.replacementUpdateTime=0,this.elevationReadFromZ=255,this.brightness=d,this.worldview=w,this.dirty=!0,this.needsUpload=!1,this.filter=null,this.nodesInfo=[];for(const T of i)this.nodesInfo.push(new Jw(T)),Yw(T,y.featureIndexArray.length,y.grid),y.featureIndexArray.emplaceBack(this.nodesInfo.length-1,0,y.bucketLayerIDs.length-1,0);this.states={}}updateFootprints(e,i){for(const o of this.getNodesInfo()){const a=o.node;a.footprint&&i.push({footprint:a.footprint,id:e})}}update(e){const i=Object.keys(e).length!==0;if(i&&!this.stateDependentLayers.length)return;const o=i?this.stateDependentLayers:this.layers;if(!Vo(e,this.states))for(const a of o)this.evaluate(a,e);this.states=structuredClone(e)}populate(){console.log("populate 3D model bucket")}uploadPending(){return!this.uploaded||this.needsUpload}upload(e){if(!this.needsUpload)return;const i=this.getNodesInfo();for(const o of i){const a=o.node;this.uploaded?this.updatePbrBuffer(a):Ky(a,e,!0)}for(const o of i)rg(o.node);this.uploaded=!0,this.needsUpload=!1}updatePbrBuffer(e){let i=!1;if(!e.meshes)return i;for(const o of e.meshes)o.pbrBuffer&&(o.pbrBuffer.updateData(o.featureArray),i=!0);return i}needsReEvaluation(e,i,o){const a=e.transform.projectionOptions,h=e.style.getBrightness(),d=this.brightness!==h;if(!this.uploaded||this.dirty||a.name!==this.projection.name||Jm(o.paint.get("model-color").value,d)||Jm(o.paint.get("model-color-mix-intensity").value,d)||Jm(o.paint.get("model-roughness").value,d)||Jm(o.paint.get("model-emissive-strength").value,d)||Jm(o.paint.get("model-height-based-emissive-strength-multiplier").value,d)){this.projection=a,this.brightness=h;const y=this.getNodesInfo();for(const w of y)w.state=null;return!0}return!1}evaluateTransform(e,i){if(e.transform.zoom===this.zoom)return;this.zoom=e.transform.zoom;const o=this.getNodesInfo(),a=this.id.canonical;for(const h of o){const d=h.feature;h.evaluatedTranslation=i.paint.get("model-translation").evaluate(d,{},a),h.evaluatedScale=i.paint.get("model-scale").evaluate(d,{},a)}}evaluate(e,i){const o=this.getNodesInfo();for(const a of o){if(!a.node.meshes)continue;const h=a.feature,d=i&&i[h.id];if(Vo(d,a.state))continue;a.state=structuredClone(d);const y=a.node.meshes&&a.node.meshes[0].featureData,w=a.evaluatedColor[2],T=a.evaluatedRMEA[2],C=this.id.canonical;if(a.hasTranslucentParts=!1,y){for(let P=0;P<Qw.length;P++){const D=Qw[P];D.length&&(h.properties.part=D);const O=e.paint.get("model-color").evaluate(h,d,C).toPremultipliedRenderColor(null),N=e.paint.get("model-color-mix-intensity").evaluate(h,d,C);a.evaluatedColor[P]=[O.r,O.g,O.b,N],a.evaluatedRMEA[P][0]=e.paint.get("model-roughness").evaluate(h,d,C),a.evaluatedRMEA[P][2]=e.paint.get("model-emissive-strength").evaluate(h,d,C),a.evaluatedRMEA[P][3]=O.a,a.emissionHeightBasedParams[P]=e.paint.get("model-height-based-emissive-strength-multiplier").evaluate(h,d,C),!a.hasTranslucentParts&&O.a<1&&(a.hasTranslucentParts=!0)}delete h.properties.part,uI(a,w!==a.evaluatedColor[2]||T!==a.evaluatedRMEA[2],this.modelTraits)}else a.evaluatedRMEA[0][2]=e.paint.get("model-emissive-strength").evaluate(h,d,C);a.evaluatedTranslation=e.paint.get("model-translation").evaluate(h,d,C),a.evaluatedScale=e.paint.get("model-scale").evaluate(h,d,C),this.updatePbrBuffer(a.node)||(this.needsUpload=!0)}this.dirty=!1}elevationUpdate(e,i,o,a){const h=e.findDEMTileFor(o);if(h&&(h.tileID.canonical!==this.terrainTile||i!==this.terrainExaggeration)){if(h.dem&&h.tileID.overscaledZ!==this.elevationReadFromZ){this.elevationReadFromZ=h.tileID.overscaledZ;const d=Kp.create(e,o,h);if(!d)return;this.modelTraits&Hp.HasMapboxMeshFeatures&&this.updateDEM(e,d,o,a);for(const y of this.getNodesInfo()){const w=y.node;if(!w.footprint||!w.footprint.vertices||!w.footprint.vertices.length)continue;const T=w.footprint.vertices;let C=d.getElevationAt(T[0].x,T[0].y,!0,!0);for(let P=1;P<T.length;P++)C=Math.min(C,d.getElevationAt(T[P].x,T[P].y,!0,!0));w.elevation=C}}this.terrainTile=h.tileID.canonical,this.terrainExaggeration=i}}updateDEM(e,i,o,a){let h=i._dem._modifiedForSources[a];if(h===void 0&&(i._dem._modifiedForSources[a]=[],h=i._dem._modifiedForSources[a]),h.includes(o.canonical))return;const d=i._dem.dim;h.push(o.canonical);let y=!1;for(const w of this.getNodesInfo()){const T=w.node;if(!T.footprint||!T.footprint.grid)continue;const C=T.footprint.grid,P=i.tileCoordToPixel(C.min.x,C.min.y),D=i.tileCoordToPixel(C.max.x,C.max.y),O=Math.min(Math.min(d-D.y,P.x),Math.min(P.y,d-D.x));if(O<0)continue;const N=de(O,2,5);let G=Math.max(0,P.x-N),q=Math.max(0,P.y-N),Y=Math.min(D.x+N,d-1),se=Math.min(D.y+N,d-1);for(let ve=q;ve<=se;++ve)for(let xe=G;xe<=Y;++xe)up[ve*d+xe]=255;let re=0,ae=0;for(let ve=0;ve<C.cellsY;++ve)for(let xe=0;xe<C.cellsX;++xe){if(!C.cells[ve*C.cellsX+xe])continue;const Pe=i.tileCoordToPixel(C.min.x+xe/C.xScale,C.min.y+ve/C.yScale),Me=i.tileCoordToPixel(C.min.x+(xe+1)/C.xScale,C.min.y+(ve+1)/C.yScale);for(let it=Pe.y;it<=Math.min(Me.y+1,d-1);++it)for(let Fe=Pe.x;Fe<=Math.min(Me.x+1,d-1);++Fe)up[it*d+Fe]===255&&(up[it*d+Fe]=0,re+=i.getElevationAtPixel(Fe,it),ae++)}const Ee=re/ae;G=Math.max(1,P.x-N),q=Math.max(1,P.y-N),Y=Math.min(D.x+N,d-2),se=Math.min(D.y+N,d-2),y=!0;for(let ve=q;ve<=se;++ve)for(let xe=G;xe<=Y;++xe)up[ve*d+xe]===0&&(b0[ve*d+xe]=i._dem.set(xe,ve,Ee));for(let ve=1;ve<N;++ve){G=Math.max(1,P.x-ve),q=Math.max(1,P.y-ve),Y=Math.min(D.x+ve,d-2),se=Math.min(D.y+ve,d-2);for(let xe=q;xe<=se;++xe)for(let Pe=G;Pe<=Y;++Pe){const Me=xe*d+Pe;if(up[Me]===255){let it=0,Fe=0,ot=-1,Dt=-1;for(let ht=-1;ht<=1;++ht)for(let bt=-1;bt<=1;++bt){const Rt=(xe+ht)*d+Pe+bt;if(up[Rt]>=ve)continue;const et=b0[Rt],Tt=Math.abs(et);Tt>Fe&&(it=et,Fe=Tt,ot=bt,Dt=ht)}if(Fe>.1){const ht=1-(ve+.5*Math.abs(ot*Dt))/N;let bt=i._dem.get(Pe,xe)+it*ht;const Rt=i._dem.get(Pe+ot,xe+Dt),et=i._dem.get(Pe-ot,xe-Dt,!0);(bt-Rt)*(bt-et)>0&&(bt=(Rt+et)/2),b0[Me]=i._dem.set(Pe,xe,bt),up[Me]=ve}}}}}y&&(i._demTile.needsDEMTextureUpload=!0,i._dem._timestamp=go.now())}setFilter(e){this.filter=e?Gc(e):null}getNodesInfo(){return this.filter?this.nodesInfo.filter((e=>this.filter.filter(new Wn(this.id.overscaledZ,{worldview:this.worldview}),e.feature,this.id.canonical))):this.nodesInfo}destroy(){const e=this.getNodesInfo();for(const i of e)rg(i.node),Yy(i.node)}isEmpty(){return!this.nodesInfo.length}updateReplacement(e,i){if(i.updateTime===this.replacementUpdateTime)return;this.replacementUpdateTime=i.updateTime;const o=i.getReplacementRegionsForTile(e.toUnwrapped());for(const a of this.getNodesInfo()){const h=a.node.footprint;a.hiddenByReplacement=!!h&&!o.find((d=>d.footprint===h))}}getHeightAtTileCoord(e,i){const o=[],a=[0,0,0],h=ct([]);for(const d of this.getNodesInfo()){const y=d.node.meshes[0],w=y.transformedAabb;if(e<w.min[0]||i<w.min[1]||e>w.max[0]||i>w.max[1])continue;if(d.node.hidden===!0)return{height:1/0,maxHeight:d.feature.properties.height,hidden:!1,verticalScale:d.evaluatedScale[2]};wt(h,d.node.matrix),a[0]=e,a[1]=i,Pn(a,a,h);const T=(a[0]-y.aabb.min[0])/(y.aabb.max[0]-y.aabb.min[0])*ap|0,C=Math.min(63,(a[1]-y.aabb.min[1])/(y.aabb.max[1]-y.aabb.min[1])*ap|0)*ap+Math.min(63,T),P=y.heightmap[C];if(!(P<0&&d.node.footprint))return d.hiddenByReplacement?void 0:{height:P,maxHeight:d.feature.properties.height,hidden:!1,verticalScale:d.evaluatedScale[2]};if(d.node.footprint.grid.query(new gt(e,i),new gt(e,i),o),o.length>0)return{height:void 0,maxHeight:d.feature.properties.height,hidden:d.hiddenByReplacement,verticalScale:d.evaluatedScale[2]}}}}function Jm(n,e){return n instanceof Tu&&!n.isLightConstant&&e}function cI(n,e,i,o,a,h,d,y){let w=(61440&e|(61440&e)>>4)>>8,T=(3840&e|(3840&e)>>4)>>4,C=240&e|(240&e)>>4;i[3]>0&&(w=di(w,255*i[0],i[3]),T=di(T,255*i[1],i[3]),C=di(C,255*i[2],i[3]));const P=w<<8|T,D=C<<8|Math.floor(255*o[3]),O=(function(ve){const xe=de(ve,0,2);return Math.min(Math.round(.5*xe*255),255)})(o[2])<<8|15*o[0]<<4|15*o[1],N=de(a[0],0,1),G=de(a[1],0,1),q=de(a[2],0,1),Y=de(a[3],0,1);let se,re,ae,Ee;if(N!==G&&d!==h&&G!==N){const ve=d-h;re=1/(ve*(G-N)),ae=-(h+ve*N)/(ve*(G-N));const xe=de(a[4],-1,1);Ee=Math.pow(10,xe),se=255*q<<8|255*Y}else se=65535,re=0,ae=1,Ee=1;if(n.emplaceBack(P,D,O,se,re,ae,Ee),y){const ve=y.length;y.clear();for(let xe=0;xe<ve;xe++)y.emplaceBack(P,D,O,se,re,ae,Ee)}}function uI(n,e,i){const o=n.node;let a=0;const h=i&Hp.HasMeshoptCompression;for(const d of o.meshes){if(o.lights&&o.lightMeshIndex===a||!d.featureData)continue;d.featureArray=new ku,d.featureArray.reserve(d.featureData.length);let y=e;for(const w of d.featureData){const T=h?65535&w:w>>16&65535,C=h?w>>16&65535:65535&w,P=(15&C)<8?15&C:0,D=n.evaluatedRMEA[P],O=n.evaluatedColor[P],N=n.emissionHeightBasedParams[P];let G;if(y&&P===2&&o.lights&&(G=new ku,G.resize(10*o.lights.length)),cI(d.featureArray,T,O,D,N,d.aabb.min[2],d.aabb.max[2],G),G&&y){y=!1;const q=o.meshes[o.lightMeshIndex];q.featureArray=G,q.featureArray._trim()}}d.featureArray._trim(),a++}}function eb(n,e,i,o){const a=1<<n.z;e.lat=oe((o/zt+n.y)/a),e.lng=te((i/zt+n.x)/a)}function hI(n,e,i,o){const a=n.getNodesInfo()[e];if(!a||a.hiddenByReplacement||!a.node.meshes)return;let h=Number.MAX_VALUE;const d=a.node,y=i.tile,w=o.calculatePosMatrix(y.tileID.toUnwrapped(),o.worldSize),T=a.evaluatedScale;let C=0;o.elevation&&d.elevation&&(C=d.elevation*o.elevation.exaggeration()),Ti(w,w,[(d.anchor?d.anchor[0]:0)*(T[0]-1),(d.anchor?d.anchor[1]:0)*(T[1]-1),C]),Ei(w,w,T);const P=i.queryGeometry,D=P.isPointQuery()?P.screenBounds:P.screenGeometry,O=function(G){const q=Nt([],w,G.matrix);Nt(q,o.expandedFarZProjMatrix,q);for(let Y=0;Y<G.meshes.length;++Y){const se=G.meshes[Y];if(Y===G.lightMeshIndex)continue;const re=x1(D,o,q,se.aabb);re!=null&&(h=Math.min(re,h))}if(G.children)for(const Y of G.children)O(Y)};if(O(d),h===Number.MAX_VALUE)return;const N=new L(0,0);return eb(y.tileID.canonical,N,a.node.anchor[0],a.node.anchor[1]),{intersectionZ:h,position:N,feature:a.feature}}Kt(Eg,"Tiled3dModelBucket",{omit:["layers"]}),Kt(Jw,"Tiled3dModelFeature");const dI={circle:class extends ho{constructor(n,e,i,o){super(n,{layout:Kc||(Kc=new Fr({"circle-sort-key":new Wt(Le.layout_circle["circle-sort-key"]),"circle-elevation-reference":new _t(Le.layout_circle["circle-elevation-reference"]),visibility:new _t(Le.layout_circle.visibility)})),paint:Fu||(Fu=new Fr({"circle-radius":new Wt(Le.paint_circle["circle-radius"]),"circle-color":new Wt(Le.paint_circle["circle-color"]),"circle-blur":new Wt(Le.paint_circle["circle-blur"]),"circle-opacity":new Wt(Le.paint_circle["circle-opacity"]),"circle-translate":new _t(Le.paint_circle["circle-translate"]),"circle-translate-anchor":new _t(Le.paint_circle["circle-translate-anchor"]),"circle-pitch-scale":new _t(Le.paint_circle["circle-pitch-scale"]),"circle-pitch-alignment":new _t(Le.paint_circle["circle-pitch-alignment"]),"circle-stroke-width":new Wt(Le.paint_circle["circle-stroke-width"]),"circle-stroke-color":new Wt(Le.paint_circle["circle-stroke-color"]),"circle-stroke-opacity":new Wt(Le.paint_circle["circle-stroke-opacity"]),"circle-emissive-strength":new _t(Le.paint_circle["circle-emissive-strength"]),"circle-color-use-theme":new Wt({type:"string",default:"default","property-type":"data-driven"}),"circle-stroke-color-use-theme":new Wt({type:"string",default:"default","property-type":"data-driven"})}))},e,i,o)}createBucket(n){return new Nn(n)}queryRadius(n){const e=n;return Is("circle-radius",this,e)+Is("circle-stroke-width",this,e)+Or(this.paint.get("circle-translate"))}queryIntersectsFeature(n,e,i,o,a,h,d,y){const w=Tc(this.paint.get("circle-translate"),this.paint.get("circle-translate-anchor"),h.angle,n.pixelToTileUnitsFactor),T=this.paint.get("circle-radius").evaluate(e,i)+this.paint.get("circle-stroke-width").evaluate(e,i);return $r(n,o,h,d,y,this.paint.get("circle-pitch-alignment")==="map",this.paint.get("circle-pitch-scale")==="map",w,T)}getProgramIds(){return["circle"]}getDefaultProgramParams(n,e,i){const o=bo(this);return{config:new Ss(this,{zoom:e,lut:i}),defines:o,overrideFog:!1}}is3D(n){return!n&&!!this.layout&&this.layout.get("circle-elevation-reference")!=="none"}hasElevation(){return this.layout&&this.layout.get("circle-elevation-reference")!=="none"}},heatmap:class extends ho{createBucket(n){return new cx(n)}constructor(n,e,i,o){super(n,{layout:ux||(ux=new Fr({visibility:new _t(Le.layout_heatmap.visibility)})),paint:hx||(hx=new Fr({"heatmap-radius":new Wt(Le.paint_heatmap["heatmap-radius"]),"heatmap-weight":new Wt(Le.paint_heatmap["heatmap-weight"]),"heatmap-intensity":new _t(Le.paint_heatmap["heatmap-intensity"]),"heatmap-color":new jc(Le.paint_heatmap["heatmap-color"]),"heatmap-opacity":new _t(Le.paint_heatmap["heatmap-opacity"]),"heatmap-color-use-theme":new Wt({type:"string",default:"default","property-type":"data-driven"})}))},e,i,o),this._updateColorRamp()}_handleSpecialPaintPropertyUpdate(n){n==="heatmap-color"&&this._updateColorRamp()}_updateColorRamp(){this.colorRamp=Em({expression:this._transitionablePaint._values["heatmap-color"].value.expression,evaluationKey:"heatmapDensity",image:this.colorRamp}),this.colorRampTexture=null}resize(){this.heatmapFbo&&(this.heatmapFbo.destroy(),this.heatmapFbo=null)}_clear(){this.heatmapFbo&&(this.heatmapFbo.destroy(),this.heatmapFbo=null),this.colorRampTexture&&(this.colorRampTexture.destroy(),this.colorRampTexture=null)}queryRadius(n){return Is("heatmap-radius",this,n)}queryIntersectsFeature(n,e,i,o,a,h,d,y){const w=this.paint.get("heatmap-radius").evaluate(e,i);return $r(n,o,h,d,y,!0,!0,new gt(0,0),w)}hasOffscreenPass(){return this.paint.get("heatmap-opacity")!==0&&this.visibility!=="none"}getProgramIds(){return["heatmap","heatmapTexture"]}getDefaultProgramParams(n,e,i){return n==="heatmap"?{config:new Ss(this,{zoom:e,lut:i}),overrideFog:!1}:{}}},hillshade:class extends ho{constructor(n,e,i,o){super(n,{layout:dx||(dx=new Fr({visibility:new _t(Le.layout_hillshade.visibility)})),paint:fx||(fx=new Fr({"hillshade-illumination-direction":new _t(Le.paint_hillshade["hillshade-illumination-direction"]),"hillshade-illumination-anchor":new _t(Le.paint_hillshade["hillshade-illumination-anchor"]),"hillshade-exaggeration":new _t(Le.paint_hillshade["hillshade-exaggeration"]),"hillshade-shadow-color":new _t(Le.paint_hillshade["hillshade-shadow-color"]),"hillshade-highlight-color":new _t(Le.paint_hillshade["hillshade-highlight-color"]),"hillshade-accent-color":new _t(Le.paint_hillshade["hillshade-accent-color"]),"hillshade-emissive-strength":new _t(Le.paint_hillshade["hillshade-emissive-strength"]),"hillshade-shadow-color-use-theme":new Wt({type:"string",default:"default","property-type":"data-driven"}),"hillshade-highlight-color-use-theme":new Wt({type:"string",default:"default","property-type":"data-driven"}),"hillshade-accent-color-use-theme":new Wt({type:"string",default:"default","property-type":"data-driven"})}))},e,i,o)}shouldRedrape(){return this.hasOffscreenPass()&&this.paint.get("hillshade-illumination-anchor")==="viewport"}hasOffscreenPass(){return this.paint.get("hillshade-exaggeration")!==0&&this.visibility!=="none"}getProgramIds(){return["hillshade","hillshadePrepare"]}getDefaultProgramParams(n,e,i){return{overrideFog:!1}}},fill:class extends ho{constructor(n,e,i,o){super(n,{layout:Cx||(Cx=new Fr({"fill-sort-key":new Wt(Le.layout_fill["fill-sort-key"]),visibility:new _t(Le.layout_fill.visibility),"fill-elevation-reference":new _t(Le.layout_fill["fill-elevation-reference"]),"fill-construct-bridge-guard-rail":new Wt(Le.layout_fill["fill-construct-bridge-guard-rail"])})),paint:Px||(Px=new Fr({"fill-antialias":new _t(Le.paint_fill["fill-antialias"]),"fill-opacity":new Wt(Le.paint_fill["fill-opacity"]),"fill-color":new Wt(Le.paint_fill["fill-color"]),"fill-outline-color":new Wt(Le.paint_fill["fill-outline-color"]),"fill-translate":new _t(Le.paint_fill["fill-translate"]),"fill-translate-anchor":new _t(Le.paint_fill["fill-translate-anchor"]),"fill-pattern":new Wt(Le.paint_fill["fill-pattern"]),"fill-pattern-cross-fade":new _t(Le.paint_fill["fill-pattern-cross-fade"]),"fill-emissive-strength":new _t(Le.paint_fill["fill-emissive-strength"]),"fill-z-offset":new Wt(Le.paint_fill["fill-z-offset"]),"fill-bridge-guard-rail-color":new Wt(Le.paint_fill["fill-bridge-guard-rail-color"]),"fill-tunnel-structure-color":new Wt(Le.paint_fill["fill-tunnel-structure-color"]),"fill-color-use-theme":new Wt({type:"string",default:"default","property-type":"data-driven"}),"fill-outline-color-use-theme":new Wt({type:"string",default:"default","property-type":"data-driven"}),"fill-bridge-guard-rail-color-use-theme":new Wt({type:"string",default:"default","property-type":"data-driven"}),"fill-tunnel-structure-color-use-theme":new Wt({type:"string",default:"default","property-type":"data-driven"})}))},e,i,o)}getProgramIds(){const n=this.paint.get("fill-pattern"),e=n&&n.constantOr(1),i=[e?"fillPattern":"fill"];return this.paint.get("fill-antialias")&&i.push(e&&!this.getPaintProperty("fill-outline-color")?"fillOutlinePattern":"fillOutline"),i}getDefaultProgramParams(n,e,i){return{config:new Ss(this,{zoom:e,lut:i}),overrideFog:!1}}recalculate(n,e){super.recalculate(n,e);const i=this.paint._values["fill-outline-color"];i.value.kind==="constant"&&i.value.value===void 0&&(this.paint._values["fill-outline-color"]=this.paint._values["fill-color"])}createBucket(n){return new Dy(n)}queryRadius(){return Or(this.paint.get("fill-translate"))}queryIntersectsFeature(n,e,i,o,a,h){return!n.queryGeometry.isAboveHorizon&&pr(la(n.tilespaceGeometry,this.paint.get("fill-translate"),this.paint.get("fill-translate-anchor"),h.angle,n.pixelToTileUnitsFactor),o)}isTileClipped(){return this.paint.get("fill-z-offset").constantOr(1)===0}is3D(n){if(this.paint.get("fill-z-offset").constantOr(1)!==0)return!0;const e=this.layout&&this.layout.get("fill-elevation-reference")!=="none";return n!=null?e&&!n:e}hasElevation(){return this.layout&&this.layout.get("fill-elevation-reference")!=="none"}hasShadowPass(){return this.layout&&this.layout.get("fill-elevation-reference")!=="none"}},"fill-extrusion":class extends ho{constructor(n,e,i,o){super(n,{layout:Qx||(Qx=new Fr({visibility:new _t(Le["layout_fill-extrusion"].visibility),"fill-extrusion-edge-radius":new _t(Le["layout_fill-extrusion"]["fill-extrusion-edge-radius"])})),paint:Jx||(Jx=new Fr({"fill-extrusion-opacity":new _t(Le["paint_fill-extrusion"]["fill-extrusion-opacity"]),"fill-extrusion-color":new Wt(Le["paint_fill-extrusion"]["fill-extrusion-color"]),"fill-extrusion-translate":new _t(Le["paint_fill-extrusion"]["fill-extrusion-translate"]),"fill-extrusion-translate-anchor":new _t(Le["paint_fill-extrusion"]["fill-extrusion-translate-anchor"]),"fill-extrusion-pattern":new Wt(Le["paint_fill-extrusion"]["fill-extrusion-pattern"]),"fill-extrusion-pattern-cross-fade":new _t(Le["paint_fill-extrusion"]["fill-extrusion-pattern-cross-fade"]),"fill-extrusion-height":new Wt(Le["paint_fill-extrusion"]["fill-extrusion-height"]),"fill-extrusion-base":new Wt(Le["paint_fill-extrusion"]["fill-extrusion-base"]),"fill-extrusion-height-alignment":new _t(Le["paint_fill-extrusion"]["fill-extrusion-height-alignment"]),"fill-extrusion-base-alignment":new _t(Le["paint_fill-extrusion"]["fill-extrusion-base-alignment"]),"fill-extrusion-vertical-gradient":new _t(Le["paint_fill-extrusion"]["fill-extrusion-vertical-gradient"]),"fill-extrusion-ambient-occlusion-intensity":new _t(Le["paint_fill-extrusion"]["fill-extrusion-ambient-occlusion-intensity"]),"fill-extrusion-ambient-occlusion-radius":new _t(Le["paint_fill-extrusion"]["fill-extrusion-ambient-occlusion-radius"]),"fill-extrusion-ambient-occlusion-wall-radius":new _t(Le["paint_fill-extrusion"]["fill-extrusion-ambient-occlusion-wall-radius"]),"fill-extrusion-ambient-occlusion-ground-radius":new _t(Le["paint_fill-extrusion"]["fill-extrusion-ambient-occlusion-ground-radius"]),"fill-extrusion-ambient-occlusion-ground-attenuation":new _t(Le["paint_fill-extrusion"]["fill-extrusion-ambient-occlusion-ground-attenuation"]),"fill-extrusion-flood-light-color":new _t(Le["paint_fill-extrusion"]["fill-extrusion-flood-light-color"]),"fill-extrusion-flood-light-intensity":new _t(Le["paint_fill-extrusion"]["fill-extrusion-flood-light-intensity"]),"fill-extrusion-flood-light-wall-radius":new Wt(Le["paint_fill-extrusion"]["fill-extrusion-flood-light-wall-radius"]),"fill-extrusion-flood-light-ground-radius":new Wt(Le["paint_fill-extrusion"]["fill-extrusion-flood-light-ground-radius"]),"fill-extrusion-flood-light-ground-attenuation":new _t(Le["paint_fill-extrusion"]["fill-extrusion-flood-light-ground-attenuation"]),"fill-extrusion-vertical-scale":new _t(Le["paint_fill-extrusion"]["fill-extrusion-vertical-scale"]),"fill-extrusion-rounded-roof":new _t(Le["paint_fill-extrusion"]["fill-extrusion-rounded-roof"]),"fill-extrusion-cutoff-fade-range":new _t(Le["paint_fill-extrusion"]["fill-extrusion-cutoff-fade-range"]),"fill-extrusion-emissive-strength":new Wt(Le["paint_fill-extrusion"]["fill-extrusion-emissive-strength"]),"fill-extrusion-line-width":new Wt(Le["paint_fill-extrusion"]["fill-extrusion-line-width"]),"fill-extrusion-cast-shadows":new _t(Le["paint_fill-extrusion"]["fill-extrusion-cast-shadows"]),"fill-extrusion-color-use-theme":new Wt({type:"string",default:"default","property-type":"data-driven"}),"fill-extrusion-flood-light-color-use-theme":new Wt({type:"string",default:"default","property-type":"data-driven"})}))},e,i,o),this._stats={numRenderedVerticesInShadowPass:0,numRenderedVerticesInTransparentPass:0}}createBucket(n){return new K_(n)}queryRadius(){return Or(this.paint.get("fill-extrusion-translate"))}is3D(n){return!0}hasShadowPass(){return this.paint.get("fill-extrusion-cast-shadows")}cutoffRange(){return this.paint.get("fill-extrusion-cutoff-fade-range")}canCastShadows(){return!0}getProgramIds(){return[this.paint.get("fill-extrusion-pattern").constantOr(1)?"fillExtrusionPattern":"fillExtrusion"]}queryIntersectsFeature(n,e,i,o,a,h,d,y,w){const T=Tc(this.paint.get("fill-extrusion-translate"),this.paint.get("fill-extrusion-translate-anchor"),h.angle,n.pixelToTileUnitsFactor),C=this.paint.get("fill-extrusion-height").evaluate(e,i),P=this.paint.get("fill-extrusion-base").evaluate(e,i),D=[0,0],O=y&&h.elevation,N=h.elevation?h.elevation.exaggeration():1,G=n.tile.getBucket(this);if(O&&G instanceof K_){const ae=G.centroidVertexArray,Ee=w+1;Ee<ae.length&&(D[0]=ae.geta_centroid_pos0(Ee),D[1]=ae.geta_centroid_pos1(Ee))}if(D[0]===0&&D[1]===1)return!1;h.projection.name==="globe"&&(o=Yx([o],[new gt(0,0),new gt(zt,zt)],n.tileID.canonical).map((ae=>ae.polygon)).flat());const q=O?y:null,[Y,se]=(function(ae,Ee,ve,xe,Pe,Me,it,Fe,ot,Dt,ht){return ae.projection.name==="globe"?(function(bt,Rt,et,Tt,Ve,tt,Lt,Et,li,Yt,vt){const At=[],ti=[],Zt=bt.projection.upVectorScale(vt,bt.center.lat,bt.worldSize).metersToTile,Bt=[0,0,0,1],Xt=[0,0,0,1],bi=(Gi,Bi,mn,Qi)=>{Gi[0]=Bi,Gi[1]=mn,Gi[2]=Qi,Gi[3]=1},Mi=Kx();et>0&&(et+=Mi),Tt+=Mi;for(const Gi of Rt){const Bi=[],mn=[];for(const Qi of Gi){const Ar=Qi.x+Ve.x,ue=Qi.y+Ve.y,he=bt.projection.projectTilePoint(Ar,ue,vt),Ye=bt.projection.upVector(vt,Qi.x,Qi.y);let kt=et,Ht=Tt;if(Lt){const jt=s1(Ar,ue,et,Tt,Lt,Et,li,Yt);kt+=jt.base,Ht+=jt.top}et!==0?bi(Bt,he.x+Ye[0]*Zt*kt,he.y+Ye[1]*Zt*kt,he.z+Ye[2]*Zt*kt):bi(Bt,he.x,he.y,he.z),bi(Xt,he.x+Ye[0]*Zt*Ht,he.y+Ye[1]*Zt*Ht,he.z+Ye[2]*Zt*Ht),Pn(Bt,Bt,tt),Pn(Xt,Xt,tt),Bi.push(new sp(Bt[0],Bt[1],Bt[2])),mn.push(new sp(Xt[0],Xt[1],Xt[2]))}At.push(Bi),ti.push(mn)}return[At,ti]})(ae,Ee,ve,xe,Pe,Me,it,Fe,ot,Dt,ht):it?(function(bt,Rt,et,Tt,Ve,tt,Lt,Et,li){const Yt=[],vt=[],At=[0,0,0,1];for(const ti of bt){const Zt=[],Bt=[];for(const Xt of ti){const bi=Xt.x+Tt.x,Mi=Xt.y+Tt.y,Gi=s1(bi,Mi,Rt,et,tt,Lt,Et,li);At[0]=bi,At[1]=Mi,At[2]=Gi.base,At[3]=1,Rn(At,At,Ve),At[3]=Math.max(At[3],1e-5);const Bi=new sp(At[0]/At[3],At[1]/At[3],At[2]/At[3]);At[0]=bi,At[1]=Mi,At[2]=Gi.top,At[3]=1,Rn(At,At,Ve),At[3]=Math.max(At[3],1e-5);const mn=new sp(At[0]/At[3],At[1]/At[3],At[2]/At[3]);Zt.push(Bi),Bt.push(mn)}Yt.push(Zt),vt.push(Bt)}return[Yt,vt]})(Ee,ve,xe,Pe,Me,it,Fe,ot,Dt):(function(bt,Rt,et,Tt,Ve){const tt=[],Lt=[],Et=Ve[8]*Rt,li=Ve[9]*Rt,Yt=Ve[10]*Rt,vt=Ve[11]*Rt,At=Ve[8]*et,ti=Ve[9]*et,Zt=Ve[10]*et,Bt=Ve[11]*et;for(const Xt of bt){const bi=[],Mi=[];for(const Gi of Xt){const Bi=Gi.x+Tt.x,mn=Gi.y+Tt.y,Qi=Ve[0]*Bi+Ve[4]*mn+Ve[12],Ar=Ve[1]*Bi+Ve[5]*mn+Ve[13],ue=Ve[2]*Bi+Ve[6]*mn+Ve[14],he=Ve[3]*Bi+Ve[7]*mn+Ve[15],Ye=Qi+Et,kt=Ar+li,Ht=ue+Yt,jt=Math.max(he+vt,1e-5),ei=Qi+At,Pi=Ar+ti,an=ue+Zt,ln=Math.max(he+Bt,1e-5);bi.push(new sp(Ye/jt,kt/jt,Ht/jt)),Mi.push(new sp(ei/ln,Pi/ln,an/ln))}tt.push(bi),Lt.push(Mi)}return[tt,Lt]})(Ee,ve,xe,Pe,Me)})(h,o,P,C,T,d,q,D,N,h.center.lat,n.tileID.canonical),re=n.queryGeometry;return(function(ae,Ee,ve){let xe=1/0;pr(ve,Ee)&&(xe=r1(ve,Ee[0]));for(let Pe=0;Pe<Ee.length;Pe++){const Me=Ee[Pe],it=ae[Pe];for(let Fe=0;Fe<Me.length-1;Fe++){const ot=Me[Fe],Dt=[ot,Me[Fe+1],it[Fe+1],it[Fe],ot];tr(ve,Dt)&&(xe=Math.min(xe,r1(ve,Dt)))}}return xe!==1/0&&xe})(Y,se,re.isPointQuery()?re.screenBounds:re.screenGeometry)}},building:class extends ho{constructor(n,e,i,o){super(n,{layout:P1||(P1=new Fr({visibility:new _t(Le.layout_building.visibility),"building-facade":new Wt(Le.layout_building["building-facade"]),"building-facade-floors":new Wt(Le.layout_building["building-facade-floors"]),"building-facade-window":new Wt(Le.layout_building["building-facade-window"]),"building-roof-shape":new Wt(Le.layout_building["building-roof-shape"]),"building-height":new Wt(Le.layout_building["building-height"]),"building-base":new Wt(Le.layout_building["building-base"])})),paint:R1||(R1=new Fr({"building-opacity":new _t(Le.paint_building["building-opacity"]),"building-ambient-occlusion-intensity":new _t(Le.paint_building["building-ambient-occlusion-intensity"]),"building-ambient-occlusion-ground-intensity":new _t(Le.paint_building["building-ambient-occlusion-ground-intensity"]),"building-ambient-occlusion-ground-radius":new _t(Le.paint_building["building-ambient-occlusion-ground-radius"]),"building-ambient-occlusion-ground-attenuation":new _t(Le.paint_building["building-ambient-occlusion-ground-attenuation"]),"building-vertical-scale":new _t(Le.paint_building["building-vertical-scale"]),"building-cast-shadows":new _t(Le.paint_building["building-cast-shadows"]),"building-color":new Wt(Le.paint_building["building-color"]),"building-emissive-strength":new Wt(Le.paint_building["building-emissive-strength"]),"building-facade-emissive-chance":new _t(Le.paint_building["building-facade-emissive-chance"]),"building-cutoff-fade-range":new _t(Le.paint_building["building-cutoff-fade-range"]),"building-color-use-theme":new Wt({type:"string",default:"default","property-type":"data-driven"})}))},e,i,o),this._stats={numRenderedVerticesInShadowPass:0,numRenderedVerticesInTransparentPass:0}}createBucket(n){return new C1(n)}hasShadowPass(){return this.paint.get("building-cast-shadows")}hasLightBeamPass(){return!0}canCastShadows(){return!0}is3D(n){return!0}},line:class extends ho{constructor(n,e,i,o){const a=V1();super(n,a,e,i,o),a.layout&&(this.layout=new xl(a.layout)),this.gradientVersion=0,this.hasElevatedBuckets=!1,this.hasNonElevatedBuckets=!1}_handleSpecialPaintPropertyUpdate(n){if(n==="line-gradient"){const e=this._transitionablePaint._values["line-gradient"].value.expression;this.stepInterpolant=e._styleExpression&&e._styleExpression.expression instanceof Hl,this.gradientVersion=(this.gradientVersion+1)%Number.MAX_SAFE_INTEGER}}gradientExpression(){return this._transitionablePaint._values["line-gradient"].value.expression}widthExpression(){return this._transitionablePaint._values["line-width"].value.expression}recalculate(n,e){super.recalculate(n,e),this.paint._values["line-floorwidth"]=(()=>{if(Um)return Um;const i=V1();return Um=new uS(i.paint.properties["line-width"].specification),Um.useIntegerZoom=!0,Um})().possiblyEvaluate(this._transitioningPaint._values["line-width"].value,n)}createBucket(n){return new e0(n)}getProgramIds(){return[this.paint.get("line-pattern").constantOr(1)?"linePattern":"line"]}getDefaultProgramParams(n,e,i){const o=B1(this);return{config:new Ss(this,{zoom:e,lut:i}),defines:o,overrideFog:!1}}queryRadius(n){const e=n,i=U1(Is("line-width",this,e),Is("line-gap-width",this,e)),o=Is("line-offset",this,e);return i/2+Math.abs(o)+Or(this.paint.get("line-translate"))}queryIntersectsFeature(n,e,i,o,a,h){if(n.queryGeometry.isAboveHorizon)return!1;const d=la(n.tilespaceGeometry,this.paint.get("line-translate"),this.paint.get("line-translate-anchor"),h.angle,n.pixelToTileUnitsFactor),y=n.pixelToTileUnitsFactor/2*U1(this.paint.get("line-width").evaluate(e,i),this.paint.get("line-gap-width").evaluate(e,i)),w=this.paint.get("line-offset").evaluate(e,i);return w&&(o=(function(T,C){const P=[],D=new gt(0,0);for(let O=0;O<T.length;O++){const N=T[O],G=[];for(let q=0;q<N.length;q++){const Y=N[q],se=N[q+1],re=q===0?D:Y.sub(N[q-1])._unit()._perp(),ae=q===N.length-1?D:se.sub(Y)._unit()._perp(),Ee=re._add(ae)._unit();Ee._mult(1/(Ee.x*ae.x+Ee.y*ae.y)),G.push(Ee._mult(C)._add(Y))}P.push(G)}return P})(o,w*n.pixelToTileUnitsFactor)),(function(T,C,P){for(let D=0;D<C.length;D++){const O=C[D];if(T.length>=3){for(let N=0;N<O.length;N++)if(mo(T,O[N]))return!0}if(ts(T,O,P))return!0}return!1})(d,o,y)}isTileClipped(){return this.hasNonElevatedBuckets}isDraped(n){return!this.hasElevatedBuckets||this.layout&&this.layout.get("line-elevation-reference")==="hd-road-markup"}hasElevation(){return this.layout&&this.layout.get("line-elevation-reference")!=="none"}},symbol:xg,background:class extends ho{constructor(n,e,i,o){super(n,{layout:Dw||(Dw=new Fr({visibility:new _t(Le.layout_background.visibility)})),paint:Lw||(Lw=new Fr({"background-pitch-alignment":new _t(Le.paint_background["background-pitch-alignment"]),"background-color":new _t(Le.paint_background["background-color"]),"background-pattern":new _t(Le.paint_background["background-pattern"]),"background-opacity":new _t(Le.paint_background["background-opacity"]),"background-emissive-strength":new _t(Le.paint_background["background-emissive-strength"]),"background-color-use-theme":new Wt({type:"string",default:"default","property-type":"data-driven"})}))},e,i,o)}getProgramIds(){return[this.paint.get("background-pattern")?"backgroundPattern":"background"]}getDefaultProgramParams(n,e,i){return{overrideFog:!1}}is3D(n){return this.paint.get("background-pitch-alignment")==="viewport"}},raster:Bw,"raster-particle":Hw,sky:class extends ho{constructor(n,e,i,o){super(n,{layout:Uw||(Uw=new Fr({visibility:new _t(Le.layout_sky.visibility)})),paint:jw||(jw=new Fr({"sky-type":new _t(Le.paint_sky["sky-type"]),"sky-atmosphere-sun":new _t(Le.paint_sky["sky-atmosphere-sun"]),"sky-atmosphere-sun-intensity":new _t(Le.paint_sky["sky-atmosphere-sun-intensity"]),"sky-gradient-center":new _t(Le.paint_sky["sky-gradient-center"]),"sky-gradient-radius":new _t(Le.paint_sky["sky-gradient-radius"]),"sky-gradient":new jc(Le.paint_sky["sky-gradient"]),"sky-atmosphere-halo-color":new _t(Le.paint_sky["sky-atmosphere-halo-color"]),"sky-atmosphere-color":new _t(Le.paint_sky["sky-atmosphere-color"]),"sky-opacity":new _t(Le.paint_sky["sky-opacity"]),"sky-gradient-use-theme":new Wt({type:"string",default:"default","property-type":"data-driven"}),"sky-atmosphere-halo-color-use-theme":new Wt({type:"string",default:"default","property-type":"data-driven"}),"sky-atmosphere-color-use-theme":new Wt({type:"string",default:"default","property-type":"data-driven"})}))},e,i,o),this._updateColorRamp()}_clear(){this.skyboxFbo&&(this.skyboxFbo.destroy(),this.skyboxFbo=null),this.colorRampTexture&&(this.colorRampTexture.destroy(),this.colorRampTexture=null),this._skyboxInvalidated=!0}_handleSpecialPaintPropertyUpdate(n){n==="sky-gradient"?this._updateColorRamp():n!=="sky-atmosphere-sun"&&n!=="sky-atmosphere-halo-color"&&n!=="sky-atmosphere-color"&&n!=="sky-atmosphere-sun-intensity"||(this._skyboxInvalidated=!0)}_updateColorRamp(){this.colorRamp=Em({expression:this._transitionablePaint._values["sky-gradient"].value.expression,evaluationKey:"skyRadialProgress"}),this.colorRampTexture&&(this.colorRampTexture.destroy(),this.colorRampTexture=null)}needsSkyboxCapture(n){if(this._skyboxInvalidated||!this.skyboxTexture||!this.skyboxGeometry)return!0;if(!this.paint.get("sky-atmosphere-sun")){const e=n.style.light.properties.get("position");return this._lightPosition.azimuthal!==e.azimuthal||this._lightPosition.polar!==e.polar}return!1}getCenter(n,e){if(this.paint.get("sky-type")==="atmosphere"){const o=this.paint.get("sky-atmosphere-sun"),a=!o,h=n.style.light,d=h.properties.get("position");return a&&h.properties.get("anchor")==="viewport"&&tn("The sun direction is attached to a light with viewport anchor, lighting may behave unexpectedly."),a?v0(d.azimuthal,90-d.polar,e):v0(o[0],90-o[1],e)}const i=this.paint.get("sky-gradient-center");return v0(i[0],90-i[1],e)}isSky(){return!0}markSkyboxValid(n){this._skyboxInvalidated=!1,this._lightPosition=n.style.light.properties.get("position")}hasOffscreenPass(){return!0}getProgramIds(){const n=this.paint.get("sky-type");return n==="atmosphere"?["skyboxCapture","skybox"]:n==="gradient"?["skyboxGradient"]:null}},slot:class extends ho{constructor(n,e,i,o){super(n,{paint:Gw||(Gw=new Fr({}))},e,null)}},model:class extends ho{constructor(n,e,i,o){super(n,{layout:Zw||(Zw=new Fr({visibility:new _t(Le.layout_model.visibility),"model-id":new Wt(Le.layout_model["model-id"])})),paint:Xw||(Xw=new Fr({"model-opacity":new Wt(Le.paint_model["model-opacity"]),"model-rotation":new Wt(Le.paint_model["model-rotation"]),"model-scale":new Wt(Le.paint_model["model-scale"]),"model-translation":new Wt(Le.paint_model["model-translation"]),"model-color":new Wt(Le.paint_model["model-color"]),"model-color-mix-intensity":new Wt(Le.paint_model["model-color-mix-intensity"]),"model-type":new _t(Le.paint_model["model-type"]),"model-cast-shadows":new _t(Le.paint_model["model-cast-shadows"]),"model-receive-shadows":new _t(Le.paint_model["model-receive-shadows"]),"model-ambient-occlusion-intensity":new _t(Le.paint_model["model-ambient-occlusion-intensity"]),"model-emissive-strength":new Wt(Le.paint_model["model-emissive-strength"]),"model-roughness":new Wt(Le.paint_model["model-roughness"]),"model-height-based-emissive-strength-multiplier":new Wt(Le.paint_model["model-height-based-emissive-strength-multiplier"]),"model-cutoff-fade-range":new _t(Le.paint_model["model-cutoff-fade-range"]),"model-front-cutoff":new _t(Le.paint_model["model-front-cutoff"]),"model-color-use-theme":new Wt({type:"string",default:"default","property-type":"data-driven"})}))},e,i,o),this._stats={numRenderedVerticesInShadowPass:0,numRenderedVerticesInTransparentPass:0}}createBucket(n){return new w0(n)}getProgramIds(){return["model"]}is3D(n){return!0}hasShadowPass(){return!0}canCastShadows(){return!0}hasLightBeamPass(){return!0}cutoffRange(){return this.paint.get("model-cutoff-fade-range")}queryRadius(n){return n instanceof Eg?zt-1:0}queryIntersectsFeature(n,e,i,o,a,h){if(!this.modelManager)return!1;const d=this.modelManager,y=n.tile.getBucket(this);if(!(y&&y instanceof w0))return!1;for(const w in y.instancesPerModel){const T=y.instancesPerModel[w],C=e.id!==void 0?e.id:e.properties&&e.properties.hasOwnProperty("id")?e.properties.id:void 0;if(T.idToFeaturesIndex.hasOwnProperty(C)){const P=T.features[T.idToFeaturesIndex[C]],D=d.getModel(w,this.scope);if(!D)return!1;let O=$t();const N=new L(0,0),G=y.canonical;let q=Number.MAX_VALUE;for(let Y=0;Y<P.instancedDataCount;++Y){const se=16*(P.instancedDataOffset+Y),re=T.instancedDataArray.float32,ae=[re[se+4],re[se+5],re[se+6]];eb(G,N,re[se],0|re[se+1]),w1(O,D,h,N,P.rotation,P.scale,ae,!1,!1,!1),h.projection.name==="globe"&&(O=Xy(O,h));const Ee=Nt([],h.projMatrix,O),ve=n.queryGeometry,xe=x1(ve.isPointQuery()?ve.screenBounds:ve.screenGeometry,h,Ee,D.aabb);xe!=null&&(q=Math.min(xe,q))}return q!==Number.MAX_VALUE&&q}}return!1}_handleOverridablePaintPropertyUpdate(n,e,i){return!(!this.layout||e.isDataDriven()||i.isDataDriven()||n!=="model-color"&&n!=="model-color-mix-intensity"&&n!=="model-rotation"&&n!=="model-scale"&&n!=="model-translation"&&n!=="model-emissive-strength")}_isPropertyZoomDependent(n){const e=this._transitionablePaint._values[n];return e!=null&&e.value!=null&&e.value.expression!=null&&e.value.expression instanceof Ca}isZoomDependent(){return this._isPropertyZoomDependent("model-scale")||this._isPropertyZoomDependent("model-rotation")||this._isPropertyZoomDependent("model-translation")}},clip:class extends ho{constructor(n,e,i,o){super(n,{layout:Rx||(Rx=new Fr({"clip-layer-types":new _t(Le.layout_clip["clip-layer-types"]),"clip-layer-scope":new _t(Le.layout_clip["clip-layer-scope"])})),paint:Mx||(Mx=new Fr({}))},e,i,o)}recalculate(n,e){super.recalculate(n,e)}createBucket(n){return new Dx(n)}is3D(n){return!0}}},T0=new un(0,0,0),E0={PATH_RULE_NON_ZERO:1,PATH_RULE_EVEN_ODD:2},S0={LINE_CAP_BUTT:1,LINE_CAP_ROUND:2,LINE_CAP_SQUARE:3},Sg={LINE_JOIN_MITER:1,LINE_JOIN_MITER_CLIP:2,LINE_JOIN_ROUND:3,LINE_JOIN_BEVEL:4},fI={PAINT_ORDER_FILL_AND_STROKE:1},e_={PATH_COMMAND_MOVE:1,PATH_COMMAND_LINE:2,PATH_COMMAND_QUAD:3,PATH_COMMAND_CUBIC:4,PATH_COMMAND_CLOSE:5},tb={MASK_TYPE_LUMINANCE:1};function pI(n,e,i){n===1&&e.icons.push((function(o,a){return(function(h){if(h.usvg_tree.height||(h.usvg_tree.height=h.usvg_tree.width),!h.metadata)return h;const{metadata:d}=h;if(d.content_area){const{content_area:y}=d;y.top==null&&(y.top=y.left),y.width==null&&(y.width=h.usvg_tree.width),y.height==null&&(y.height=y.width)}return d.stretch_x&&d.stretch_x.length&&ib(d,"x"),d.stretch_y&&d.stretch_y.length&&ib(d,"y"),h})(o.readFields(mI,{name:void 0},a))})(i,i.readVarint()+i.pos))}function ib(n,e){const i=[],o=n[`stretch_${e}`];let a=null;for(let h=0;h<o.length;h++)a===null?a=i.length===0?o[0]:i[i.length-1][1]+o[h]:(i.push([a,a+o[h]]),a=null);n[`stretch_${e}_areas`]=i}function mI(n,e,i){n===1?e.name=i.readString():n===2?e.metadata=(function(o,a){return o.readFields(_I,{stretch_x:null,stretch_y:null,stretch_x_areas:null,stretch_y_areas:null,variables:[]},a)})(i,i.readVarint()+i.pos):n===3&&(e.usvg_tree=(function(o,a){return o.readFields(vI,{width:20,children:[],linear_gradients:[],radial_gradients:[],clip_paths:[],masks:[]},a)})(i,i.readVarint()+i.pos),e.data="usvg_tree")}function _I(n,e,i){n===1?e.stretch_x=i.readPackedVarint():n===2?e.stretch_y=i.readPackedVarint():n===3?e.content_area=(function(o,a){return o.readFields(gI,{left:0},a)})(i,i.readVarint()+i.pos):n===4&&e.variables.push((function(o,a){return o.readFields(yI,{name:void 0},a)})(i,i.readVarint()+i.pos))}function gI(n,e,i){n===1?e.left=i.readVarint():n===2?e.width=i.readVarint():n===3?e.top=i.readVarint():n===4&&(e.height=i.readVarint())}function yI(n,e,i){n===1?e.name=i.readString():n===2&&(e.rgb_color=Cg(i.readVarint()),e.value="rgb_color")}function vI(n,e,i){n===1?e.width=e.height=i.readVarint():n===2?e.height=i.readVarint():n===3?e.children.push(Ig(i,i.readVarint()+i.pos)):n===4?e.linear_gradients.push((function(o,a){return o.readFields(II,{spread_method:1,stops:[],x1:0,y1:0,x2:1,y2:0},a)})(i,i.readVarint()+i.pos)):n===5?e.radial_gradients.push((function(o,a){return o.readFields(CI,{spread_method:1,stops:[],cx:.5,cy:.5,r:.5,fx:.5,fy:.5,fr:0},a)})(i,i.readVarint()+i.pos)):n===7?e.clip_paths.push((function(o,a){return o.readFields(PI,{children:[]},a)})(i,i.readVarint()+i.pos)):n===8&&e.masks.push((function(o,a){const h=o.readFields(RI,{left:0,width:20,mask_type:tb.MASK_TYPE_LUMINANCE,children:[]},a);return h.height==null&&(h.height=h.width),h.top==null&&(h.top=h.left),h})(i,i.readVarint()+i.pos))}function Ig(n,e){return n.readFields(xI,{},e)}function xI(n,e,i){n===1?(e.group=(function(o,a){return o.readFields(wI,{opacity:255,children:[]},a)})(i,i.readVarint()+i.pos),e.node="group"):n===2&&(e.path=(function(o,a){return o.readFields(TI,{paint_order:1,commands:[],step:1,diffs:[],rule:E0.PATH_RULE_NON_ZERO},a)})(i,i.readVarint()+i.pos),e.node="path")}function wI(n,e,i){n===1?e.transform=Ag(i,i.readVarint()+i.pos):n===2?e.opacity=i.readVarint():n===5?e.clip_path_idx=i.readVarint():n===6?e.mask_idx=i.readVarint():n===7&&e.children.push(Ig(i,i.readVarint()+i.pos))}function Ag(n,e){return n.readFields(bI,{sx:1,ky:0,kx:0,sy:1,tx:0,ty:0},e)}function bI(n,e,i){n===1?e.sx=i.readFloat():n===2?e.ky=i.readFloat():n===3?e.kx=i.readFloat():n===4?e.sy=i.readFloat():n===5?e.tx=i.readFloat():n===6&&(e.ty=i.readFloat())}function TI(n,e,i){n===1?e.fill=(function(o,a){return o.readFields(EI,{rgb_color:T0,paint:"rgb_color",opacity:255},a)})(i,i.readVarint()+i.pos):n===2?e.stroke=(function(o,a){return o.readFields(SI,{rgb_color:T0,paint:"rgb_color",dasharray:[],dashoffset:0,miterlimit:4,opacity:255,width:1,linecap:1,linejoin:1},a)})(i,i.readVarint()+i.pos):n===3?e.paint_order=i.readVarint():n===5?i.readPackedVarint(e.commands):n===6?e.step=i.readFloat():n===7?i.readPackedSVarint(e.diffs):n===8&&(e.rule=i.readVarint())}function EI(n,e,i){n===1?(e.rgb_color=Cg(i.readVarint()),e.paint="rgb_color"):n===2?(e.linear_gradient_idx=i.readVarint(),e.paint="linear_gradient_idx"):n===3?(e.radial_gradient_idx=i.readVarint(),e.paint="radial_gradient_idx"):n===5&&(e.opacity=i.readVarint())}function Cg(n){return new un((n>>16&255)/255,(n>>8&255)/255,(255&n)/255,1)}function SI(n,e,i){n===1?(e.rgb_color=Cg(i.readVarint()),e.paint="rgb_color"):n===2?(e.linear_gradient_idx=i.readVarint(),e.paint="linear_gradient_idx"):n===3?(e.radial_gradient_idx=i.readVarint(),e.paint="radial_gradient_idx"):n===5?i.readPackedFloat(e.dasharray):n===6?e.dashoffset=i.readFloat():n===7?e.miterlimit=i.readFloat():n===8?e.opacity=i.readVarint():n===9?e.width=i.readFloat():n===10?e.linecap=i.readVarint():n===11&&(e.linejoin=i.readVarint())}function II(n,e,i){n===1?e.transform=Ag(i,i.readVarint()+i.pos):n===2?e.spread_method=i.readVarint():n===3?e.stops.push(nb(i,i.readVarint()+i.pos)):n===4?e.x1=i.readFloat():n===5?e.y1=i.readFloat():n===6?e.x2=i.readFloat():n===7&&(e.y2=i.readFloat())}function nb(n,e){return n.readFields(AI,{offset:0,opacity:255,rgb_color:T0},e)}function AI(n,e,i){n===1?e.offset=i.readFloat():n===2?e.opacity=i.readVarint():n===3&&(e.rgb_color=Cg(i.readVarint()))}function CI(n,e,i){n===1?e.transform=Ag(i,i.readVarint()+i.pos):n===2?e.spread_method=i.readVarint():n===3?e.stops.push(nb(i,i.readVarint()+i.pos)):n===4?e.cx=i.readFloat():n===5?e.cy=i.readFloat():n===6?e.r=i.readFloat():n===7?e.fx=i.readFloat():n===8?e.fy=i.readFloat():n===9&&(e.fr=i.readFloat())}function PI(n,e,i){n===1?e.transform=Ag(i,i.readVarint()+i.pos):n===2?e.clip_path_idx=i.readVarint():n===3&&e.children.push(Ig(i,i.readVarint()+i.pos))}function RI(n,e,i){n===1?e.left=e.top=i.readFloat():n===2?e.width=e.height=i.readFloat():n===3?e.top=i.readFloat():n===4?e.height=i.readFloat():n===5?e.mask_type=i.readVarint():n===6?e.mask_idx=i.readVarint():n===7&&e.children.push(Ig(i,i.readVarint()+i.pos))}class MI{static calculate(e={},i=[]){const o=new Map,a=new Map;if(Object.keys(e).length===0)return o;i.forEach((h=>{a.set(h.name,h.rgb_color||new un(0,0,0))}));for(const[h,d]of Object.entries(e))a.has(h)?o.set(a.get(h).toString(),d):console.warn(`Ignoring unknown image variable "${h}"`);return o}}function Yp(n,e=255,i){const o=e/255,a=n.toString(),h=i.has(a)?i.get(a).clone():n.clone();return h.a*=o,h.toString()}function t_(n,e){if(!So()){const i=document.createElement("canvas");return i.width=n,i.height=e,i}return new OffscreenCanvas(n,e)}function DI(n,e){const i=MI.calculate(e.params,n.metadata?n.metadata.variables:[]),o=n.usvg_tree,a=o.width,h=o.height,d=e.transform?e.transform:new DOMMatrix,y=Math.max(1,Math.round(a*d.a)),w=Math.max(1,Math.round(h*d.d)),T=new DOMMatrix([y/a,0,0,w/h,0,0]),C=t_(y,w).getContext("2d");return I0(C,T,o,o,i),C.getImageData(0,0,y,w)}function I0(n,e,i,o,a){for(const h of o.children)rb(n,e,i,h,a)}function rb(n,e,i,o,a){o.group?(n.save(),(function(h,d,y,w,T){const C=w.mask_idx!=null?y.masks[w.mask_idx]:null,P=w.clip_path_idx!=null?y.clip_paths[w.clip_path_idx]:null;if(w.transform&&(d=Qp(w.transform).preMultiplySelf(d)),!(function(N,G,q){return N.opacity!==255||G||q})(w,P!=null,C!=null))return void I0(h,d,y,w,T);const D=t_(h.canvas.width,h.canvas.height),O=D.getContext("2d");I0(O,d,y,w,T),P&&hb(O,d,y,P),C&&db(O,d,y,C,T),h.globalAlpha=w.opacity/255,h.drawImage(D,0,0)})(n,e,i,o.group,a),n.restore()):o.path&&(n.save(),(function(h,d,y,w,T){h.setTransform(d),w.paint_order===fI.PAINT_ORDER_FILL_AND_STROKE?(sb(h,y,w,T),ab(h,y,w,T)):(ab(h,y,w,T),sb(h,y,w,T))})(n,e,i,o.path,a),n.restore())}function sb(n,e,i,o){const a=i.fill;if(!a)return;const h=a.opacity/255;switch(n.save(),n.beginPath(),fb(i,n),a.paint){case"rgb_color":n.fillStyle=Yp(a.rgb_color,a.opacity,o);break;case"linear_gradient_idx":{const d=e.linear_gradients[a.linear_gradient_idx];d.transform&&n.setTransform(Qp(d.transform).preMultiplySelf(n.getTransform())),n.fillStyle=lb(n,d,h,o);break}case"radial_gradient_idx":{const d=e.radial_gradients[a.radial_gradient_idx];d.transform&&n.setTransform(Qp(d.transform).preMultiplySelf(n.getTransform())),n.fillStyle=cb(n,d,h,o)}}n.fill(ob(i)),n.restore()}function ob(n){return n.rule===E0.PATH_RULE_NON_ZERO?"nonzero":n.rule===E0.PATH_RULE_EVEN_ODD?"evenodd":void 0}function ab(n,e,i,o){const a=i.stroke;if(!a)return;const h=pb(i);n.lineWidth=a.width,n.miterLimit=a.miterlimit,n.setLineDash(a.dasharray),n.lineDashOffset=a.dashoffset;const d=a.opacity/255;switch(a.paint){case"rgb_color":n.strokeStyle=Yp(a.rgb_color,a.opacity,o);break;case"linear_gradient_idx":n.strokeStyle=lb(n,e.linear_gradients[a.linear_gradient_idx],d,o,!0);break;case"radial_gradient_idx":n.strokeStyle=cb(n,e.radial_gradients[a.radial_gradient_idx],d,o,!0)}switch(a.linejoin){case Sg.LINE_JOIN_MITER_CLIP:case Sg.LINE_JOIN_MITER:n.lineJoin="miter";break;case Sg.LINE_JOIN_ROUND:n.lineJoin="round";break;case Sg.LINE_JOIN_BEVEL:n.lineJoin="bevel"}switch(a.linecap){case S0.LINE_CAP_BUTT:n.lineCap="butt";break;case S0.LINE_CAP_ROUND:n.lineCap="round";break;case S0.LINE_CAP_SQUARE:n.lineCap="square"}n.stroke(h)}function lb(n,e,i,o,a=!1){if(e.stops.length===1){const D=e.stops[0];return Yp(D.rgb_color,D.opacity*i,o)}const{x1:h,y1:d,x2:y,y2:w}=e;let T=new DOMPoint(h,d),C=new DOMPoint(y,w);if(a){const D=Qp(e.transform);T=D.transformPoint(T),C=D.transformPoint(C)}const P=n.createLinearGradient(T.x,T.y,C.x,C.y);for(const D of e.stops)P.addColorStop(D.offset,Yp(D.rgb_color,D.opacity*i,o));return P}function cb(n,e,i,o,a=!1){if(e.stops.length===1){const Y=e.stops[0];return Yp(Y.rgb_color,Y.opacity*i,o)}const h=Qp(e.transform),{fx:d,fy:y,fr:w,cx:T,cy:C,r:P}=e;let D=new DOMPoint(d,y),O=new DOMPoint(T,C),N=w,G=P;if(a){D=h.transformPoint(D),O=h.transformPoint(O);const Y=(h.a+h.d)/2;N=w*Y,G=e.r*Y}const q=n.createRadialGradient(D.x,D.y,N,O.x,O.y,G);for(const Y of e.stops)q.addColorStop(Y.offset,Yp(Y.rgb_color,Y.opacity*i,o));return q}function ub(n,e,i,o){const a=o.transform?Qp(o.transform).preMultiplySelf(e):e,h=t_(n.canvas.width,n.canvas.height),d=h.getContext("2d");for(const w of o.children)if(w.group)ub(d,a,i,w.group);else if(w.path){const T=w.path,C=new Path2D;C.addPath(pb(T),a),d.fill(C,ob(T))}const y=o.clip_path_idx!=null?i.clip_paths[o.clip_path_idx]:null;y&&hb(d,a,i,y),n.globalCompositeOperation="source-over",n.drawImage(h,0,0)}function hb(n,e,i,o){const a=t_(n.canvas.width,n.canvas.height);ub(a.getContext("2d"),e,i,o),n.globalCompositeOperation="destination-in",n.drawImage(a,0,0)}function db(n,e,i,o,a){if(o.children.length===0)return;const h=o.mask_idx!=null?i.masks[o.mask_idx]:null;h&&db(n,e,i,h,a);const d=n.canvas.width,y=n.canvas.height,w=t_(d,y),T=w.getContext("2d"),C=o.width,P=o.height,D=o.left,O=o.top,N=new Path2D,G=new Path2D;G.rect(D,O,C,P),N.addPath(G,e),T.clip(N);for(const se of o.children)rb(T,e,i,se,a);const q=T.getImageData(0,0,d,y),Y=q.data;if(o.mask_type===tb.MASK_TYPE_LUMINANCE)for(let se=0;se<Y.length;se+=4)Y[se+3]=Y[se+3]/255*(.2126*Y[se]+.7152*Y[se+1]+.0722*Y[se+2]);T.putImageData(q,0,0),n.globalCompositeOperation="destination-in",n.drawImage(w,0,0)}function Qp(n){return n?new DOMMatrix([n.sx,n.ky,n.kx,n.sy,n.tx,n.ty]):new DOMMatrix}function fb(n,e){const i=n.step;let o=n.diffs[0]*i,a=n.diffs[1]*i;e.moveTo(o,a);for(let h=0,d=2;h<n.commands.length;h++)switch(n.commands[h]){case e_.PATH_COMMAND_MOVE:o+=n.diffs[d++]*i,a+=n.diffs[d++]*i,e.moveTo(o,a);break;case e_.PATH_COMMAND_LINE:o+=n.diffs[d++]*i,a+=n.diffs[d++]*i,e.lineTo(o,a);break;case e_.PATH_COMMAND_QUAD:{const y=o+n.diffs[d++]*i,w=a+n.diffs[d++]*i;o=y+n.diffs[d++]*i,a=w+n.diffs[d++]*i,e.quadraticCurveTo(y,w,o,a);break}case e_.PATH_COMMAND_CUBIC:{const y=o+n.diffs[d++]*i,w=a+n.diffs[d++]*i,T=y+n.diffs[d++]*i,C=w+n.diffs[d++]*i;o=T+n.diffs[d++]*i,a=C+n.diffs[d++]*i,e.bezierCurveTo(y,w,T,C,o,a);break}case e_.PATH_COMMAND_CLOSE:e.closePath()}return e}function pb(n){return fb(n,new Path2D)}class Pg{constructor(e){this.capacity=e,this.cache=new Map}get(e){if(!this.cache.has(e))return;const i=this.cache.get(e);return this.cache.delete(e),this.cache.set(e,i),i}put(e,i){this.cache.has(e)?this.cache.delete(e):this.cache.size===this.capacity&&this.cache.delete(this.cache.keys().next().value),this.cache.set(e,i)}delete(e){this.cache.delete(e)}}Kt(Pg,"LRUCache");class A0{constructor(){this.cacheMap=new Map,this.cacheDependenciesMap=new Map}static _getImage(e){return new ko(e,e.data)}getFromCache(e,i,o){return this.cacheMap.has(o)||this.cacheMap.set(o,new Pg(150)),this.cacheMap.get(o).get(Mu(e.toString(),i))}setInCache(e,i,o,a){this.cacheDependenciesMap.has(a)||this.cacheDependenciesMap.set(a,new Map),this.cacheMap.has(a)||this.cacheMap.set(a,new Pg(150));const h=this.cacheDependenciesMap.get(a),d=Mu(e.id.toString(),o);h.get(d)||h.set(d,new Set);const y=this.cacheMap.get(a),w=e.toString();h.get(d).add(w),y.put(Mu(e.toString(),o),i)}removeImagesFromCacheByIds(e,i,o=0){if(!this.cacheMap.has(o)||!this.cacheDependenciesMap.has(o))return;const a=this.cacheMap.get(o),h=this.cacheDependenciesMap.get(o);for(const d of e){const y=Mu(d.toString(),i);if(h.has(y)){for(const w of h.get(y))a.delete(w);h.delete(y)}}}rasterize(e,i,o,a,h=DI){const d=this.getFromCache(e,o,a);if(d)return d.clone();const y=h(i.icon,e.options),w=A0._getImage(y);return this.setInCache(e,w,o,a),w.clone()}}class mb{constructor(e){this.size=e,this.minimums=[],this.maximums=[],this.leaves=[]}getElevation(e,i){const o=this.toIdx(e,i);return{min:this.minimums[o],max:this.maximums[o]}}isLeaf(e,i){return this.leaves[this.toIdx(e,i)]}toIdx(e,i){return i*this.size+e}}function _b(n,e,i,o){let a=0,h=Number.MAX_VALUE;for(let d=0;d<3;d++)if(Math.abs(o[d])<1e-15){if(i[d]<n[d]||i[d]>e[d])return null}else{const y=1/o[d];let w=(n[d]-i[d])*y,T=(e[d]-i[d])*y;if(w>T){const C=w;w=T,T=C}if(w>a&&(a=w),T<h&&(h=T),a>h)return null}return a}function gb(n,e,i,o,a,h,d,y,w,T,C){const P=o-n,D=a-e,O=h-i,N=d-n,G=y-e,q=w-i,Y=C[1]*q-C[2]*G,se=C[2]*N-C[0]*q,re=C[0]*G-C[1]*N,ae=P*Y+D*se+O*re;if(Math.abs(ae)<1e-15)return null;const Ee=1/ae,ve=T[0]-n,xe=T[1]-e,Pe=T[2]-i,Me=(ve*Y+xe*se+Pe*re)*Ee;if(Me<0||Me>1)return null;const it=xe*O-Pe*D,Fe=Pe*P-ve*O,ot=ve*D-xe*P,Dt=(C[0]*it+C[1]*Fe+C[2]*ot)*Ee;return Dt<0||Me+Dt>1?null:(N*it+G*Fe+q*ot)*Ee}function yb(n,e,i){return(n-e)/(i-e)}function vb(n,e,i,o,a,h,d,y,w){const T=1<<i,C=h-o,P=d-a,D=(n+1)/T*C+o,O=(e+0)/T*P+a,N=(e+1)/T*P+a;y[0]=(n+0)/T*C+o,y[1]=O,w[0]=D,w[1]=N}class xb{constructor(e){if(this.maximums=[],this.minimums=[],this.leaves=[],this.childOffsets=[],this.nodeCount=0,this.dem=e,this._siblingOffset=[[0,0],[1,0],[0,1],[1,1]],!this.dem)return;const i=(function(h){const d=Math.ceil(Math.log2(h.dim/8)),y=[];let w=Math.ceil(Math.pow(2,d));const T=1/w,C=(O,N,G,q,Y)=>{const se=q?1:0,re=(O+1)*G-se,ae=N*G,Ee=(N+1)*G-se;Y[0]=O*G,Y[1]=ae,Y[2]=re,Y[3]=Ee};let P=new mb(w);const D=[];for(let O=0;O<w*w;O++){C(O%w,Math.floor(O/w),T,!1,D);const N=xf(D[0],D[1],h),G=xf(D[2],D[1],h),q=xf(D[2],D[3],h),Y=xf(D[0],D[3],h);P.minimums.push(Math.min(N,G,q,Y)),P.maximums.push(Math.max(N,G,q,Y)),P.leaves.push(1)}for(y.push(P),w/=2;w>=1;w/=2){const O=y[y.length-1];P=new mb(w);for(let N=0;N<w*w;N++){C(N%w,Math.floor(N/w),2,!0,D);const G=O.getElevation(D[0],D[1]),q=O.getElevation(D[2],D[1]),Y=O.getElevation(D[2],D[3]),se=O.getElevation(D[0],D[3]),re=O.isLeaf(D[0],D[1]),ae=O.isLeaf(D[2],D[1]),Ee=O.isLeaf(D[2],D[3]),ve=O.isLeaf(D[0],D[3]),xe=Math.min(G.min,q.min,Y.min,se.min),Pe=Math.max(G.max,q.max,Y.max,se.max),Me=re&&ae&&Ee&&ve;P.maximums.push(Pe),P.minimums.push(xe),P.leaves.push(Pe-xe<=5&&Me?1:0)}y.push(P)}return y})(this.dem),o=i.length-1,a=i[o];this._addNode(a.minimums[0],a.maximums[0],a.leaves[0]),this._construct(i,0,0,o,0)}raycastRoot(e,i,o,a,h,d,y=1){return _b([e,i,-100],[o,a,this.maximums[0]*y],h,d)}raycast(e,i,o,a,h,d,y=1){if(!this.nodeCount)return null;const w=this.raycastRoot(e,i,o,a,h,d,y);if(w==null)return null;const T=[],C=[],P=[],D=[],O=[{idx:0,t:w,nodex:0,nodey:0,depth:0}];for(;O.length>0;){const{idx:N,t:G,nodex:q,nodey:Y,depth:se}=O.pop();if(this.leaves[N]){vb(q,Y,se,e,i,o,a,P,D);const ae=1<<se,Ee=(q+0)/ae,ve=(q+1)/ae,xe=(Y+0)/ae,Pe=(Y+1)/ae,Me=xf(Ee,xe,this.dem)*y,it=xf(ve,xe,this.dem)*y,Fe=xf(ve,Pe,this.dem)*y,ot=xf(Ee,Pe,this.dem)*y,Dt=gb(P[0],P[1],Me,D[0],P[1],it,D[0],D[1],Fe,h,d),ht=gb(D[0],D[1],Fe,P[0],D[1],ot,P[0],P[1],Me,h,d),bt=Math.min(Dt!==null?Dt:Number.MAX_VALUE,ht!==null?ht:Number.MAX_VALUE);if(bt!==Number.MAX_VALUE)return bt;{const Rt=Gt([],h,d,G);if(wb(Me,it,ot,Fe,yb(Rt[0],P[0],D[0]),yb(Rt[1],P[1],D[1]))>=Rt[2])return G}continue}let re=0;for(let ae=0;ae<this._siblingOffset.length;ae++){vb((q<<1)+this._siblingOffset[ae][0],(Y<<1)+this._siblingOffset[ae][1],se+1,e,i,o,a,P,D),P[2]=-100,D[2]=this.maximums[this.childOffsets[N]+ae]*y;const Ee=_b(P,D,h,d);if(Ee!=null){const ve=Ee;T[ae]=ve;let xe=!1;for(let Pe=0;Pe<re&&!xe;Pe++)ve>=T[C[Pe]]&&(C.splice(Pe,0,ae),xe=!0);xe||(C[re]=ae),re++}}for(let ae=0;ae<re;ae++){const Ee=C[ae];O.push({idx:this.childOffsets[N]+Ee,t:T[Ee],nodex:(q<<1)+this._siblingOffset[Ee][0],nodey:(Y<<1)+this._siblingOffset[Ee][1],depth:se+1})}}return null}_addNode(e,i,o){return this.minimums.push(e),this.maximums.push(i),this.leaves.push(o),this.childOffsets.push(0),this.nodeCount++}_construct(e,i,o,a,h){if(e[a].isLeaf(i,o)===1)return;this.childOffsets[h]||(this.childOffsets[h]=this.nodeCount);const d=a-1,y=e[d];let w=0,T=0;for(let C=0;C<this._siblingOffset.length;C++){const P=2*i+this._siblingOffset[C][0],D=2*o+this._siblingOffset[C][1],O=y.getElevation(P,D),N=y.isLeaf(P,D),G=this._addNode(O.min,O.max,N);N&&(w|=1<<C),T||(T=G)}for(let C=0;C<this._siblingOffset.length;C++)w&1<<C||this._construct(e,2*i+this._siblingOffset[C][0],2*o+this._siblingOffset[C][1],d,T+C)}}function wb(n,e,i,o,a,h){return di(di(n,i,h),di(e,o,h),a)}function xf(n,e,i){const o=i.dim,a=de(n*o-.5,0,o-1),h=de(e*o-.5,0,o-1),d=Math.floor(a),y=Math.floor(h),w=Math.min(d+1,o-1),T=Math.min(y+1,o-1);return wb(i.get(d,y),i.get(w,y),i.get(d,T),i.get(w,T),a-d,h-y)}const LI={mapbox:[6553.6,25.6,.1,1e4],terrarium:[256,1,1/256,32768]};function kI(n,e,i){return(256*n*256+256*e+i)/10-1e4}function zI(n,e,i){return 256*n+e+i/256-32768}class Rg{get tree(){return this._tree||this._buildQuadTree(),this._tree}constructor(e,i,o,a=!1){if(this.uid=e,i.height!==i.width)throw new RangeError("DEM tiles must be square");if(o&&o!=="mapbox"&&o!=="terrarium")return void tn(`"${o}" is not a valid encoding type. Valid types include "mapbox" and "terrarium".`);this.stride=i.height;const h=this.dim=i.height-2,d=new Uint32Array(i.data.buffer);if(this.pixels=new Uint8Array(i.data.buffer),this.floatView=new Float32Array(i.data.buffer),this.borderReady=a,this._modifiedForSources={},!a){for(let w=0;w<h;w++)d[this._idx(-1,w)]=d[this._idx(0,w)],d[this._idx(h,w)]=d[this._idx(h-1,w)],d[this._idx(w,-1)]=d[this._idx(w,0)],d[this._idx(w,h)]=d[this._idx(w,h-1)];d[this._idx(-1,-1)]=d[this._idx(0,0)],d[this._idx(h,-1)]=d[this._idx(h-1,0)],d[this._idx(-1,h)]=d[this._idx(0,h-1)],d[this._idx(h,h)]=d[this._idx(h-1,h-1)]}const y=o==="terrarium"?zI:kI;for(let w=0;w<d.length;++w){const T=4*w;this.floatView[w]=y(this.pixels[T],this.pixels[T+1],this.pixels[T+2])}this._timestamp=go.now()}_buildQuadTree(){this._tree=new xb(this)}get(e,i,o=!1){o&&(e=de(e,-1,this.dim),i=de(i,-1,this.dim));const a=this._idx(e,i);return this.floatView[a]}set(e,i,o){const a=this._idx(e,i),h=this.floatView[a];return this.floatView[a]=o,o-h}static getUnpackVector(e){return LI[e]}_idx(e,i){if(e<-1||e>=this.dim+1||i<-1||i>=this.dim+1)throw new RangeError("out of range source coordinates for DEM data");return(i+1)*this.stride+(e+1)}static pack(e,i){const o=[0,0,0,0],a=Rg.getUnpackVector(i);let h=Math.floor((e+a[3])/a[2]);return o[2]=h%256,h=Math.floor(h/256),o[1]=h%256,h=Math.floor(h/256),o[0]=h,o}getPixels(){return new _x({width:this.stride,height:this.stride},this.pixels)}backfillBorder(e,i,o){if(this.dim!==e.dim)throw new Error("dem dimension mismatch");let a=i*this.dim,h=i*this.dim+this.dim,d=o*this.dim,y=o*this.dim+this.dim;switch(i){case-1:a=h-1;break;case 1:h=a+1}switch(o){case-1:d=y-1;break;case 1:y=d+1}const w=-i*this.dim,T=-o*this.dim;for(let C=d;C<y;C++)for(let P=a;P<h;P++){const D=4*this._idx(P,C),O=4*this._idx(P+w,C+T);this.pixels[D+0]=e.pixels[O+0],this.pixels[D+1]=e.pixels[O+1],this.pixels[D+2]=e.pixels[O+2],this.pixels[D+3]=e.pixels[O+3]}}onDeserialize(){this._tree&&(this._tree.dem=this)}}function FI(n,e,i){n===1?e.headerLength=i.readFixed32():n===2?e.x=i.readVarint():n===3?e.y=i.readVarint():n===4?e.z=i.readVarint():n===5&&e.layers.push((function(o,a){return o.readFields(UI,{version:0,name:"",units:"",tileSize:0,buffer:0,pixelFormat:0,dataIndex:[]},a)})(i,i.readVarint()+i.pos))}function OI(n,e,i){n===1?(e.delta_filter=(function(o,a){return o.readFields(BI,{blockSize:0},a)})(i,i.readVarint()+i.pos),e.filter="delta_filter"):n===2?(i.readVarint(),e.filter="zigzag_filter"):n===3?(i.readVarint(),e.filter="bitshuffle_filter"):n===4&&(i.readVarint(),e.filter="byteshuffle_filter")}function BI(n,e,i){n===1&&(e.blockSize=i.readVarint())}function NI(n,e,i){n===1?(i.readVarint(),e.codec="gzip_data"):n===2?(i.readVarint(),e.codec="jpeg_image"):n===3?(i.readVarint(),e.codec="webp_image"):n===4&&(i.readVarint(),e.codec="png_image")}function VI(n,e,i){let o=0,a=0;n===1?e.firstByte=i.readFixed64():n===2?e.lastByte=i.readFixed64():n===3?e.filters.push((function(h,d){return h.readFields(OI,{},d)})(i,i.readVarint()+i.pos)):n===4?e.codec=(function(h,d){return h.readFields(NI,{},d)})(i,i.readVarint()+i.pos):n===5?a=i.readFloat():n===6?o=i.readFloat():n===7?e.bands.push(i.readString()):n===8?e.offset=i.readDouble():n===9&&(e.scale=i.readDouble()),e.offset===0&&(e.offset=a),e.scale===0&&(e.scale=o)}function UI(n,e,i){n===1?e.version=i.readVarint():n===2?e.name=i.readString():n===3?e.units=i.readString():n===4?e.tileSize=i.readVarint():n===5?e.buffer=i.readVarint():n===6?e.pixelFormat=i.readVarint():n===7&&e.dataIndex.push((function(o,a){return o.readFields(VI,{firstByte:0,lastByte:0,filters:[],codec:null,offset:0,scale:0,bands:[]},a)})(i,i.readVarint()+i.pos))}function jI(n,e,i){if(n===2)(function(o,a,h){o.readFields(GI,h,a)})(i,i.readVarint()+i.pos,e);else if(n===3)throw new Error("Not implemented")}function GI(n,e,i){if(n===1){let o=0;const a=i.readVarint()+i.pos;for(;i.pos<a;)e[o++]=i.readVarint()}}function HI(n,e){if(e.length!==4)throw new Error(`Expected data of dimension 4 but got ${e.length}.`);let i=e[3];for(let o=2;o>=1;o--){const a=o===1?1:0,h=o===2?1:0;for(let d=0;d<e[0];d++){const y=e[1]*d;for(let w=a;w<e[1];w++){const T=e[2]*(w+y);for(let C=h;C<e[2];C++){const P=e[3]*(C+T);for(let D=0;D<e[3];D++){const O=P+D;n[O]+=n[O-i]}}}}i*=e[o]}return n}function qI(n){for(let e=0,i=n.length;e<i;e++)n[e]=n[e]>>>1^-(1&n[e]);return n}function $I(n,e){switch(e){case"uint32":return n;case"uint16":for(let i=0;i<n.length;i+=2){const o=n[i],a=n[i+1];n[i]=(240&o)>>4|(61440&o)>>8|(240&a)<<4|61440&a,n[i+1]=15&o|(3840&o)>>4|(15&a)<<8|(3840&a)<<4}return n;case"uint8":for(let i=0;i<n.length;i+=4){const o=n[i],a=n[i+1],h=n[i+2],d=n[i+3];n[i+0]=(192&o)>>6|(192&a)>>4|(192&h)>>2|192&d,n[i+1]=(48&o)>>4|(48&a)>>2|48&h|(48&d)<<2,n[i+2]=(12&o)>>2|12&a|(12&h)<<2|(12&d)<<4,n[i+3]=3&o|(3&a)<<2|(3&h)<<4|(3&d)<<6}return n;default:throw new Error(`Invalid pixel format, "${e}"`)}}Kt(Rg,"DEMData"),Kt(xb,"DemMinMaxQuadTree",{omit:["dem"]});var Ec=Uint8Array,i_=Uint16Array,WI=Int32Array,bb=new Ec([0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0,0,0,0]),Tb=new Ec([0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13,0,0]),ZI=new Ec([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]),Eb=function(n,e){for(var i=new i_(31),o=0;o<31;++o)i[o]=e+=1<<n[o-1];var a=new WI(i[30]);for(o=1;o<30;++o)for(var h=i[o];h<i[o+1];++h)a[h]=h-i[o]<<5|o;return{b:i,r:a}},Sb=Eb(bb,2),Ib=Sb.b,XI=Sb.r;Ib[28]=258,XI[258]=28;for(var KI=Eb(Tb,0).b,Ab=new i_(32768),Os=0;Os<32768;++Os){var Jp=(43690&Os)>>1|(21845&Os)<<1;Ab[Os]=((65280&(Jp=(61680&(Jp=(52428&Jp)>>2|(13107&Jp)<<2))>>4|(3855&Jp)<<4))>>8|(255&Jp)<<8)>>1}var n_=function(n,e,i){for(var o=n.length,a=0,h=new i_(e);a<o;++a)n[a]&&++h[n[a]-1];var d,y=new i_(e);for(a=1;a<e;++a)y[a]=y[a-1]+h[a-1]<<1;d=new i_(1<<e);var w=15-e;for(a=0;a<o;++a)if(n[a])for(var T=a<<4|n[a],C=e-n[a],P=y[n[a]-1]++<<C,D=P|(1<<C)-1;P<=D;++P)d[Ab[P]>>w]=T;return d},r_=new Ec(288);for(Os=0;Os<144;++Os)r_[Os]=8;for(Os=144;Os<256;++Os)r_[Os]=9;for(Os=256;Os<280;++Os)r_[Os]=7;for(Os=280;Os<288;++Os)r_[Os]=8;var Cb=new Ec(32);for(Os=0;Os<32;++Os)Cb[Os]=5;var YI=n_(r_,9),QI=n_(Cb,5),C0=function(n){for(var e=n[0],i=1;i<n.length;++i)n[i]>e&&(e=n[i]);return e},Vu=function(n,e,i){var o=e/8|0;return(n[o]|n[o+1]<<8)>>(7&e)&i},P0=function(n,e){var i=e/8|0;return(n[i]|n[i+1]<<8|n[i+2]<<16)>>(7&e)},JI=["unexpected EOF","invalid block type","invalid length/literal","invalid distance","stream finished","no stream handler",,"no callback","invalid UTF-8 data","extra field too long","date not in range 1980-2099","filename too long","stream finishing","invalid zip data"],Uu=function(n,e,i){var o=new Error(e||JI[n]);if(o.code=n,Error.captureStackTrace&&Error.captureStackTrace(o,Uu),!i)throw o;return o},eA=new Ec(0),tA=typeof TextDecoder<"u"&&new TextDecoder;try{tA.decode(eA,{stream:!0})}catch{}const iA={gzip_data:"gzip"};class Qc extends Error{constructor(e){super(e),this.name="MRTError"}}const nA={0:"uint32",1:"uint32",2:"uint16",3:"uint8"},Pb={uint32:1,uint16:2,uint8:4},rA={uint32:Uint32Array,uint16:Uint16Array,uint8:Uint8Array};let R0;class Mg{constructor(e=5){this.x=NaN,this.y=NaN,this.z=NaN,this.layers={},this._cacheSize=e}getLayer(e){const i=this.layers[e];if(!i)throw new Qc(`Layer '${e}' not found`);return i}getHeaderLength(e){const i=new Uint8Array(e),o=new DataView(e);if(i[0]!==13)throw new Qc("File is not a valid MRT.");return o.getUint32(1,!0)}parseHeader(e){const i=new Uint8Array(e),o=this.getHeaderLength(e);if(i.length<o)throw new Qc(`Expected header with length >= ${o} but got buffer of length ${i.length}`);const a=new R0(i.subarray(0,o)).readFields(FI,{headerLength:0,x:0,y:0,z:0,layers:[]},void 0);if(!isNaN(this.x)&&(this.x!==a.x||this.y!==a.y||this.z!==a.z))throw new Qc(`Invalid attempt to parse header ${a.z}/${a.x}/${a.y} for tile ${this.z}/${this.x}/${this.y}`);this.x=a.x,this.y=a.y,this.z=a.z;for(const h of a.layers)this.layers[h.name]=new Rb(h,{cacheSize:this._cacheSize});return this}createDecodingTask(e){const i=[],o=this.getLayer(e.layerName);for(let a of e.blockIndices){const h=o.dataIndex[a],d=h.firstByte-e.firstByte,y=h.lastByte-e.firstByte;if(o._blocksInProgress.has(a))continue;const w={layerName:o.name,firstByte:d,lastByte:y,pixelFormat:o.pixelFormat,blockIndex:a,blockShape:[h.bands.length].concat(o.bandShape),buffer:o.buffer,codec:h.codec.codec,filters:h.filters.map((T=>T.filter))};o._blocksInProgress.add(a),i.push(w)}return new Mb(i,(()=>{i.forEach((a=>o._blocksInProgress.delete(a.blockIndex)))}),((a,h)=>{if(i.forEach((d=>o._blocksInProgress.delete(d.blockIndex))),a)throw a;h.forEach((d=>{this.getLayer(d.layerName).processDecodedData(d)}))}))}}class Rb{constructor({version:e,name:i,units:o,tileSize:a,pixelFormat:h,buffer:d,dataIndex:y},w){if(this.version=e,this.version!==1)throw new Qc(`Cannot parse raster layer encoded with MRT version ${e}`);this.name=i,this.units=o,this.tileSize=a,this.buffer=d,this.pixelFormat=nA[h],this.dataIndex=y,this.bandShape=[a+2*d,a+2*d,Pb[this.pixelFormat]],this._decodedBlocks=new Pg(w?w.cacheSize:5),this._blocksInProgress=new Set}get dimension(){return Pb[this.pixelFormat]}get cacheSize(){return this._decodedBlocks.capacity}getBandList(){return this.dataIndex.map((({bands:e})=>e)).flat()}processDecodedData(e){const i=e.blockIndex.toString();this._decodedBlocks.get(i)||this._decodedBlocks.put(i,e.data)}getBlockForBand(e){let i=0;switch(typeof e){case"string":for(const[o,a]of this.dataIndex.entries()){for(const[h,d]of a.bands.entries())if(d===e)return{bandIndex:i+h,blockIndex:o,blockBandIndex:h};i+=a.bands.length}break;case"number":for(const[o,a]of this.dataIndex.entries()){if(e>=i&&e<i+a.bands.length)return{bandIndex:e,blockIndex:o,blockBandIndex:e-i};i+=a.bands.length}break;default:throw new Qc(`Invalid band \`${JSON.stringify(e)}\`. Expected string or integer.`)}return{blockIndex:-1,blockBandIndex:-1}}getDataRange(e){let i=1/0,o=-1/0;const a=[],h=new Set;for(const d of e){const{blockIndex:y}=this.getBlockForBand(d);if(y<0)throw new Qc(`Invalid band: ${JSON.stringify(d)}`);const w=this.dataIndex[y];a.includes(y)||a.push(y),h.add(y),i=Math.min(i,w.firstByte),o=Math.max(o,w.lastByte)}if(h.size>this.cacheSize)throw new Qc(`Number of blocks to decode (${h.size}) exceeds cache size (${this.cacheSize}).`);return{layerName:this.name,firstByte:i,lastByte:o,blockIndices:a}}hasBand(e){const{blockIndex:i}=this.getBlockForBand(e);return i>=0}hasDataForBand(e){const{blockIndex:i}=this.getBlockForBand(e);return i>=0&&!!this._decodedBlocks.get(i.toString())}getBandView(e){const{blockIndex:i,blockBandIndex:o}=this.getBlockForBand(e);if(i<0)throw new Qc(`Band not found: ${JSON.stringify(e)}`);const a=this._decodedBlocks.get(i.toString());if(!a)throw new Qc(`Data for band ${JSON.stringify(e)} of layer "${this.name}" not decoded.`);const h=this.dataIndex[i],d=this.bandShape.reduce(((T,C)=>T*C),1),y=o*d,w=a.subarray(y,y+d);return{data:w,bytes:new Uint8Array(w.buffer).subarray(w.byteOffset,w.byteOffset+w.byteLength),tileSize:this.tileSize,buffer:this.buffer,pixelFormat:this.pixelFormat,dimension:this.dimension,offset:h.offset,scale:h.scale}}}Mg.setPbf=function(n){R0=n};class Mb{constructor(e,i,o){this.tasks=e,this._onCancel=i,this._onComplete=o,this._finalized=!1}cancel(){this._finalized||(this._onCancel(),this._finalized=!0)}complete(e,i){this._finalized||(this._onComplete(e,i),this._finalized=!0)}}Mg.performDecoding=function(n,e){const i=new Uint8Array(n);return Promise.all(e.tasks.map((o=>{const{layerName:a,firstByte:h,lastByte:d,pixelFormat:y,blockShape:w,blockIndex:T,filters:C,codec:P}=o,D=i.subarray(h,d+1),O=new Uint32Array(w[0]*w[1]*w[2]);let N;if(P!=="gzip_data")throw new Qc(`Unhandled codec: ${P}`);return N=(function(G,q){if(!globalThis.DecompressionStream&&q==="gzip_data")return Promise.resolve(((ae=(function(xe){xe[0]==31&&xe[1]==139&&xe[2]==8||Uu(6,"invalid gzip data");var Pe=xe[3],Me=10;4&Pe&&(Me+=2+(xe[10]|xe[11]<<8));for(var it=(Pe>>3&1)+(Pe>>4&1);it>0;it-=!xe[Me++]);return Me+(2&Pe)})(re=G))+8>re.length&&Uu(6,"invalid gzip data"),(function(xe,Pe,Me,it){var Fe=xe.length;if(!Fe||Pe.f&&!Pe.l)return Me||new Ec(0);var ot=!Me,Dt=ot||Pe.i!=2,ht=Pe.i;ot&&(Me=new Ec(3*Fe));var bt,Rt,et=function(Wr){var Cr=Me.length;if(Wr>Cr){var xr=new Ec(Math.max(2*Cr,Wr));xr.set(Me),Me=xr}},Tt=Pe.f||0,Ve=Pe.p||0,tt=Pe.b||0,Lt=Pe.l,Et=Pe.d,li=Pe.m,Yt=Pe.n,vt=8*Fe;do{if(!Lt){Tt=Vu(xe,Ve,1);var At=Vu(xe,Ve+1,3);if(Ve+=3,!At){var ti=xe[(ue=4+((Ve+7)/8|0))-4]|xe[ue-3]<<8,Zt=ue+ti;if(Zt>Fe){ht&&Uu(0);break}Dt&&et(tt+ti),Me.set(xe.subarray(ue,Zt),tt),Pe.b=tt+=ti,Pe.p=Ve=8*Zt,Pe.f=Tt;continue}if(At==1)Lt=YI,Et=QI,li=9,Yt=5;else if(At==2){var Bt=Vu(xe,Ve,31)+257,Xt=Vu(xe,Ve+10,15)+4,bi=Bt+Vu(xe,Ve+5,31)+1;Ve+=14;for(var Mi=new Ec(bi),Gi=new Ec(19),Bi=0;Bi<Xt;++Bi)Gi[ZI[Bi]]=Vu(xe,Ve+3*Bi,7);Ve+=3*Xt;var mn=C0(Gi),Qi=(1<<mn)-1,Ar=n_(Gi,mn);for(Bi=0;Bi<bi;){var ue,he=Ar[Vu(xe,Ve,Qi)];if(Ve+=15&he,(ue=he>>4)<16)Mi[Bi++]=ue;else{var Ye=0,kt=0;for(ue==16?(kt=3+Vu(xe,Ve,3),Ve+=2,Ye=Mi[Bi-1]):ue==17?(kt=3+Vu(xe,Ve,7),Ve+=3):ue==18&&(kt=11+Vu(xe,Ve,127),Ve+=7);kt--;)Mi[Bi++]=Ye}}var Ht=Mi.subarray(0,Bt),jt=Mi.subarray(Bt);li=C0(Ht),Yt=C0(jt),Lt=n_(Ht,li),Et=n_(jt,Yt)}else Uu(1);if(Ve>vt){ht&&Uu(0);break}}Dt&&et(tt+131072);for(var ei=(1<<li)-1,Pi=(1<<Yt)-1,an=Ve;;an=Ve){var ln=(Ye=Lt[P0(xe,Ve)&ei])>>4;if((Ve+=15&Ye)>vt){ht&&Uu(0);break}if(Ye||Uu(2),ln<256)Me[tt++]=ln;else{if(ln==256){an=Ve,Lt=null;break}var Zi=ln-254;ln>264&&(Zi=Vu(xe,Ve,(1<<($i=bb[Bi=ln-257]))-1)+Ib[Bi],Ve+=$i);var cr=Et[P0(xe,Ve)&Pi],Xr=cr>>4;if(cr||Uu(3),Ve+=15&cr,jt=KI[Xr],Xr>3){var $i=Tb[Xr];jt+=P0(xe,Ve)&(1<<$i)-1,Ve+=$i}if(Ve>vt){ht&&Uu(0);break}Dt&&et(tt+131072);var Rr=tt+Zi;if(tt<jt){var vr=0-jt,Jn=Math.min(jt,Rr);for(vr+tt<0&&Uu(3);tt<Jn;++tt)Me[tt]=(void 0)[vr+tt]}for(;tt<Rr;++tt)Me[tt]=Me[tt-jt]}}Pe.l=Lt,Pe.p=an,Pe.b=tt,Pe.f=Tt,Lt&&(Tt=1,Pe.m=li,Pe.d=Et,Pe.n=Yt)}while(!Tt);return tt!=Me.length&&ot?(bt=Me,((Rt=tt)==null||Rt>bt.length)&&(Rt=bt.length),new Ec(bt.subarray(0,Rt))):Me.subarray(0,tt)})(re.subarray(ae,-8),{i:2},new Ec(((Y=re)[(se=Y.length)-4]|Y[se-3]<<8|Y[se-2]<<16|Y[se-1]<<24)>>>0))));var Y,se,re,ae;const Ee=iA[q];if(!Ee)throw new Error(`Unhandled codec: ${q}`);const ve=new globalThis.DecompressionStream(Ee);return new Response(new Blob([G]).stream().pipeThrough(ve)).arrayBuffer().then((xe=>new Uint8Array(xe)))})(D,P).then((G=>((function(q,Y){q.readFields(jI,Y)})(new R0(G),O),new rA[y](O.buffer)))),N.then((G=>{for(let q=C.length-1;q>=0;q--)switch(C[q]){case"delta_filter":HI(G,w);break;case"zigzag_filter":qI(G);break;case"bitshuffle_filter":$I(G,y);break;default:throw new Qc(`Unhandled filter "${C[q]}"`)}return{layerName:a,blockIndex:T,data:G}})).catch((G=>{throw G}))})))},Kt(Mb,"MRTDecodingBatch",{omit:["_onCancel","_onComplete"]}),Kt(Mg,"MapboxRasterTile"),Kt(Rb,"MapboxRasterLayer",{omit:["_blocksInProgress"]});class Db{constructor(e){this._stringToNumber={},this._numberToString=[];for(let i=0;i<e.length;i++){const o=e[i];this._stringToNumber[o]=i,this._numberToString[i]=o}}encode(e){return this._stringToNumber[e]}decode(e){return this._numberToString[e]}}const sA=["id","tile","layer","source","sourceLayer","state"];class em{constructor(e,i,o,a,h){this.type="Feature",this._vectorTileFeature=e,this._z=i,this._x=o,this._y=a,this.properties=e.properties,this.id=h}clone(){const e=new em(this._vectorTileFeature,this._z,this._x,this._y,this.id);return this.state&&(e.state=Object.assign({},this.state)),this.layer&&(e.layer=Object.assign({},this.layer)),this.source&&(e.source=this.source),this.sourceLayer&&(e.sourceLayer=this.sourceLayer),e}get geometry(){return this._geometry===void 0&&(this._geometry=this._vectorTileFeature.toGeoJSON(this._x,this._y,this._z).geometry),this._geometry}set geometry(e){this._geometry=e}toJSON(){const e={type:"Feature",state:void 0,geometry:this.geometry,properties:this.properties};for(const i of sA)this[i]!==void 0&&(e[i]=this[i]);return e}}class Lb{constructor(e,i){this.tileID=e,this.x=e.canonical.x,this.y=e.canonical.y,this.z=e.canonical.z,this.grid=new ra(zt,16,0),this.featureIndexArray=new ud,this.promoteId=i,this.is3DTile=!1,this.serializedLayersCache=new Map}insert(e,i,o,a,h,d=0,y=0){const w=this.featureIndexArray.length;this.featureIndexArray.emplaceBack(o,a,h,d);const T=this.grid;for(let C=0;C<i.length;C++){const P=i[C],D=[1/0,1/0,-1/0,-1/0];for(let O=0;O<P.length;O++){const N=P[O];D[0]=Math.min(D[0],N.x),D[1]=Math.min(D[1],N.y),D[2]=Math.max(D[2],N.x),D[3]=Math.max(D[3],N.y)}y!==0&&(D[0]-=y,D[1]-=y,D[2]+=y,D[3]+=y),D[0]<zt&&D[1]<zt&&D[2]>=0&&D[3]>=0&&T.insert(w,D[0],D[1],D[2],D[3])}}loadVTLayers(){if(!this.vtLayers){this.vtLayers=new Qt(new sg(this.rawTileData)).layers,this.sourceLayerCoder=new Db(this.vtLayers?Object.keys(this.vtLayers).sort():["_geojsonTileLayer"]),this.vtFeatures={};for(const e in this.vtLayers)this.vtFeatures[e]=[]}return this.vtLayers}query(e,i){const{tilespaceGeometry:o,transform:a,tileTransform:h,pixelPosMatrix:d,availableImages:y,worldview:w}=i;this.loadVTLayers(),this.serializedLayersCache.clear();const T=o.bufferedTilespaceBounds,C=this.grid.query(T.min.x,T.min.y,T.max.x,T.max.y,((N,G,q,Y)=>Hr(o.bufferedTilespaceGeometry,N,G,q,Y)));C.sort(oA);let P=null;a.elevation&&C.length>0&&(P=Kp.create(a.elevation,this.tileID));const D={};let O;for(let N=0;N<C.length;N++){const G=C[N];if(G===O)continue;O=G;const q=this.featureIndexArray.get(G);let Y=null;this.is3DTile?this.loadMatchingModelFeature(D,q,e,o,a,w):this.loadMatchingFeature(D,q,e,y,w,((se,re,ae,Ee=0)=>(Y||(Y=Te(se,this.tileID.canonical,h)),re.queryIntersectsFeature(o,se,ae,Y,this.z,a,d,P,Ee))))}return D}loadMatchingFeature(e,i,o,a,h,d){const{featureIndex:y,bucketIndex:w,sourceLayerIndex:T,layoutVertexArrayOffset:C}=i,P=this.bucketLayerIDs[w],D=o.layers,O=Object.keys(D);if(O.length&&!Yi(O,P))return;const N=o.sourceCache,G=this.sourceLayerCoder.decode(T),q=this.vtLayers[G].feature(y),Y=this.getId(q,G);for(let se=0;se<P.length;se++){const re=P[se];if(!D[re])continue;const{styleLayer:ae,targets:Ee}=D[re];let ve={};Y!==void 0&&(ve=N.getFeatureState(ae.sourceLayer,Y));const xe=!d||d(q,ae,ve,C);if(!xe)continue;const Pe=new em(q,this.z,this.x,this.y,Y);Pe.tile=this.tileID.canonical,Pe.state=ve;let Me=this.serializedLayersCache.get(re);Me||(Me=ae.serialize(),Me.id=re,this.serializedLayersCache.set(re,Me)),Pe.source=Me.source,Pe.sourceLayer=Me["source-layer"],Pe.layer=Ge({},Me),Pe.layer.paint=kb(Me.paint,ae.paint,q,ve,a),Pe.layer.layout=kb(Me.layout,ae.layout,q,ve,a);let it=!1;for(const Fe of Ee){this.updateFeatureProperties(Pe,Fe);const{filter:ot}=Fe;if(ot){if(q.properties=Pe.properties,ot.needGeometry){const Dt=Ze(q,!0);if(!ot.filter(new Wn(this.tileID.overscaledZ,{worldview:h}),Dt,this.tileID.canonical))continue}else if(!ot.filter(new Wn(this.tileID.overscaledZ,{worldview:h}),q))continue}it=!0,Fe.targetId&&this.addFeatureVariant(Pe,Fe)}it&&this.appendToResult(e,re,y,Pe,xe)}}loadMatchingModelFeature(e,i,o,a,h,d){const{featureIndex:y,bucketIndex:w}=i,T=this.bucketLayerIDs[w],C=o.layers,P=Object.keys(C);if(!P.length||Yi(P,T))for(let D=0;D<T.length;D++){const O=T[D],{styleLayer:N,targets:G}=C[O];if(N.type!=="model")continue;const q=a.tile,Y=q.getBucket(N);if(!(Y&&Y instanceof Eg))continue;const se=hI(Y,y,a,h);if(!se)continue;const{z:re,x:ae,y:Ee}=q.tileID.canonical,{feature:ve,intersectionZ:xe,position:Pe}=se;let Me={};ve.id!==void 0&&(Me=o.sourceCache.getFeatureState(N.sourceLayer,ve.id));const it=new em({},re,ae,Ee,ve.id);it.tile=this.tileID.canonical,it.state=Me,it.properties=ve.properties,it.geometry={type:"Point",coordinates:[Pe.lng,Pe.lat]};let Fe=this.serializedLayersCache.get(O);Fe||(Fe=N.serialize(),Fe.id=O,this.serializedLayersCache.set(O,Fe)),it.source=Fe.source,it.sourceLayer=Fe["source-layer"],it.layer=Ge({},Fe);let ot=!1;for(const Dt of G){this.updateFeatureProperties(it,Dt);const{filter:ht}=Dt;if(ht){if(ve.properties=it.properties,ht.needGeometry){if(!ht.filter(new Wn(this.tileID.overscaledZ,{worldview:d}),ve,this.tileID.canonical))continue}else if(!ht.filter(new Wn(this.tileID.overscaledZ,{worldview:d}),ve))continue}ot=!0,Dt.targetId&&this.addFeatureVariant(it,Dt)}ot&&this.appendToResult(e,O,y,it,xe)}}updateFeatureProperties(e,i,o){if(i.properties){const a={};for(const h in i.properties){const d=i.properties[h].evaluate({zoom:this.z},e._vectorTileFeature,e.state,e.tile,o);d!=null&&(a[h]=d)}e.properties=a}}addFeatureVariant(e,i,o){const a={target:i.target,namespace:i.namespace,uniqueFeatureID:i.uniqueFeatureID};i.properties&&(a.properties=e.properties),e.variants=e.variants||{},e.variants[i.targetId]=e.variants[i.targetId]||[],e.variants[i.targetId].push(a)}appendToResult(e,i,o,a,h){let d=e[i];d===void 0&&(d=e[i]=[]),d.push({featureIndex:o,feature:a,intersectionZ:h})}lookupSymbolFeatures(e,i,o,a,h,d){const y={};this.loadVTLayers();for(const w of e)this.loadMatchingFeature(y,{bucketIndex:i,sourceLayerIndex:o,featureIndex:w,layoutVertexArrayOffset:0},a,h,d);return y}loadFeature(e){const{featureIndex:i,sourceLayerIndex:o}=e;this.loadVTLayers();const a=this.sourceLayerCoder.decode(o),h=this.vtFeatures[a];if(h[i])return h[i];const d=this.vtLayers[a].feature(i);return h[i]=d,d}hasLayer(e){for(const i of this.bucketLayerIDs)for(const o of i)if(e===o)return!0;return!1}getId(e,i){let o=e.id;if(this.promoteId){const a=Array.isArray(this.promoteId)||typeof this.promoteId!="object"?this.promoteId:this.promoteId[i];if(a!=null)if(Array.isArray(a)){if(!this.promoteIdExpression){const h=Zl(a);if(h.result!=="success"){const d=h.value.map((y=>`${y.key}: ${y.message}`)).join(", ");return void tn(`Failed to create expression for promoteId: ${d}`)}this.promoteIdExpression=h.value}this.promoteIdExpression._evaluator||(this.promoteIdExpression._evaluator=new Ph),o=this.promoteIdExpression.evaluate({zoom:0},e)}else o=e.properties[a];typeof o=="boolean"&&(o=Number(o))}return o}}function kb(n,e,i,o,a){return Ri(n,((h,d)=>{const y=e instanceof xl?e.get(d):null;return y&&y.evaluate?y.evaluate(i,o,void 0,a):y}))}function oA(n,e){return e-n}Kt(Lb,"FeatureIndex",{omit:["rawTileData","sourceLayerCoder"]});const zb=[Int8Array,Uint8Array,Uint8ClampedArray,Int16Array,Uint16Array,Int32Array,Uint32Array,Float32Array,Float64Array];class M0{static from(e){if(!(e instanceof ArrayBuffer))throw new Error("Data must be an instance of ArrayBuffer.");const[i,o]=new Uint8Array(e,0,2);if(i!==219)throw new Error("Data does not appear to be in a KDBush format.");const a=o>>4;if(a!==1)throw new Error(`Got v${a} data when expected v1.`);const h=zb[15&o];if(!h)throw new Error("Unrecognized array type.");const[d]=new Uint16Array(e,2,1),[y]=new Uint32Array(e,4,1);return new M0(y,d,h,e)}constructor(e,i=64,o=Float64Array,a){if(isNaN(e)||e<0)throw new Error(`Unpexpected numItems value: ${e}.`);this.numItems=+e,this.nodeSize=Math.min(Math.max(+i,2),65535),this.ArrayType=o,this.IndexArrayType=e<65536?Uint16Array:Uint32Array;const h=zb.indexOf(this.ArrayType),d=2*e*this.ArrayType.BYTES_PER_ELEMENT,y=e*this.IndexArrayType.BYTES_PER_ELEMENT,w=(8-y%8)%8;if(h<0)throw new Error(`Unexpected typed array class: ${o}.`);a&&a instanceof ArrayBuffer?(this.data=a,this.ids=new this.IndexArrayType(this.data,8,e),this.coords=new this.ArrayType(this.data,8+y+w,2*e),this._pos=2*e,this._finished=!0):(this.data=new ArrayBuffer(8+d+y+w),this.ids=new this.IndexArrayType(this.data,8,e),this.coords=new this.ArrayType(this.data,8+y+w,2*e),this._pos=0,this._finished=!1,new Uint8Array(this.data,0,2).set([219,16+h]),new Uint16Array(this.data,2,1)[0]=i,new Uint32Array(this.data,4,1)[0]=e)}add(e,i){const o=this._pos>>1;return this.ids[o]=o,this.coords[this._pos++]=e,this.coords[this._pos++]=i,o}finish(){const e=this._pos>>1;if(e!==this.numItems)throw new Error(`Added ${e} items when expected ${this.numItems}.`);return D0(this.ids,this.coords,this.nodeSize,0,this.numItems-1,0),this._finished=!0,this}range(e,i,o,a){if(!this._finished)throw new Error("Data not yet indexed - call index.finish().");const{ids:h,coords:d,nodeSize:y}=this,w=[0,h.length-1,0],T=[];for(;w.length;){const C=w.pop()||0,P=w.pop()||0,D=w.pop()||0;if(P-D<=y){for(let q=D;q<=P;q++){const Y=d[2*q],se=d[2*q+1];Y>=e&&Y<=o&&se>=i&&se<=a&&T.push(h[q])}continue}const O=D+P>>1,N=d[2*O],G=d[2*O+1];N>=e&&N<=o&&G>=i&&G<=a&&T.push(h[O]),(C===0?e<=N:i<=G)&&(w.push(D),w.push(O-1),w.push(1-C)),(C===0?o>=N:a>=G)&&(w.push(O+1),w.push(P),w.push(1-C))}return T}within(e,i,o){if(!this._finished)throw new Error("Data not yet indexed - call index.finish().");const{ids:a,coords:h,nodeSize:d}=this,y=[0,a.length-1,0],w=[],T=o*o;for(;y.length;){const C=y.pop()||0,P=y.pop()||0,D=y.pop()||0;if(P-D<=d){for(let q=D;q<=P;q++)Ob(h[2*q],h[2*q+1],e,i)<=T&&w.push(a[q]);continue}const O=D+P>>1,N=h[2*O],G=h[2*O+1];Ob(N,G,e,i)<=T&&w.push(a[O]),(C===0?e-o<=N:i-o<=G)&&(y.push(D),y.push(O-1),y.push(1-C)),(C===0?e+o>=N:i+o>=G)&&(y.push(O+1),y.push(P),y.push(1-C))}return w}}function D0(n,e,i,o,a,h){if(a-o<=i)return;const d=o+a>>1;Fb(n,e,d,o,a,h),D0(n,e,i,o,d-1,1-h),D0(n,e,i,d+1,a,1-h)}function Fb(n,e,i,o,a,h){for(;a>o;){if(a-o>600){const T=a-o+1,C=i-o+1,P=Math.log(T),D=.5*Math.exp(2*P/3),O=.5*Math.sqrt(P*D*(T-D)/T)*(C-T/2<0?-1:1);Fb(n,e,i,Math.max(o,Math.floor(i-C*D/T+O)),Math.min(a,Math.floor(i+(T-C)*D/T+O)),h)}const d=e[2*i+h];let y=o,w=a;for(s_(n,e,o,i),e[2*a+h]>d&&s_(n,e,o,a);y<w;){for(s_(n,e,y,w),y++,w--;e[2*y+h]<d;)y++;for(;e[2*w+h]>d;)w--}e[2*o+h]===d?s_(n,e,o,w):(w++,s_(n,e,w,a)),w<=i&&(o=w+1),i<=w&&(a=w-1)}}function s_(n,e,i,o){L0(n,i,o),L0(e,2*i,2*o),L0(e,2*i+1,2*o+1)}function L0(n,e,i){const o=n[e];n[e]=n[i],n[i]=o}function Ob(n,e,i,o){const a=n-i,h=e-o;return a*a+h*h}s.$=Ms,s.A=ba,s.B=vi,s.C=Mu,s.D=Vp,s.E=hl,s.F=2,s.G=qm,s.H=cw,s.I=Js,s.J=oc,s.K=class extends Tg{},s.L=Ta,s.M=Ma,s.N=vu,s.O=rh,s.P=gt,s.Q=Gf,s.R=ea,s.S=Bd,s.T=Wy,s.U=vc,s.V=Tg,s.W=Zh,s.X=Zl,s.Y=Ku,s.Z=zc,s._=uc,s.a=function(n){return ws.API_CDN_URL_REGEX.test(n)},s.a$=lt,s.a0=eo,s.a1=Cu,s.a2=qh,s.a3=Od,s.a4=function(n){const e=n.value;let i=[];if(!e)return i;const o=oc(e);return o!=="string"?(i=i.concat([new Tg(n.key,e,`string expected, "${o}" found`)]),i):(x0(e,!0)||(i=i.concat([new Tg(n.key,e,`invalid url "${e}"`)])),i)},s.a5=Le,s.a6=Ts,s.a7=Fr,s.a8=_t,s.a9=class{constructor(n){this.specification=n}possiblyEvaluate(n,e){return ns(n.expression.evaluate(e))}interpolate(n,e,i){return{x:di(n.x,e.x,i),y:di(n.y,e.y,i),z:di(n.z,e.z,i),azimuthal:di(n.azimuthal,e.azimuthal,i),polar:di(n.polar,e.polar,i)}}},s.aA=Rn,s.aB=fo,s.aC=mo,s.aD=H,s.aE=Ce,s.aF=function(n,e){const i={};for(let o=0;o<e.length;o++){const a=e[o];a in n&&(i[a]=n[a])}return i},s.aG=B,s.aH=X,s.aI=class{constructor(n){this.entries={},this.scheduler=n}request(n,e,i,o){const a=this.entries[n]=this.entries[n]||{callbacks:[]};if(a.result){const[h,d]=a.result;return this.scheduler?this.scheduler.add((()=>{o(h,d)}),e):o(h,d),()=>{}}return a.callbacks.push(o),a.cancel||(a.cancel=i(((h,d)=>{a.result=[h,d];for(const y of a.callbacks)this.scheduler?this.scheduler.add((()=>{y(h,d)}),e):y(h,d);setTimeout((()=>delete this.entries[n]),3e3)}))),()=>{a.result||(a.callbacks=a.callbacks.filter((h=>h!==o)),a.callbacks.length||(a.cancel(),delete this.entries[n]))}}},s.aJ=function(n,e,i){const o=JSON.stringify(n.request);return n.data&&(this.deduped.entries[o]={result:[null,n.data]}),this.deduped.request(o,{type:"parseTile",isSymbolTile:n.isSymbolTile,zoom:n.tileZoom},(a=>{const h=ru(n.request,((d,y,w,T)=>{d?a(d):y&&a(null,{vectorTile:i?void 0:new Qt(new sg(y)),rawData:y,cacheControl:w,expires:T})}));return()=>{h.cancel(),a()}}),e)},s.aK=function(n){ju++,ju>Kn&&(n.getActor().send("enforceCacheSizeLimit",lo),ju=0)},s.aL=function(n){return n<=1?1:Math.pow(2,Math.floor(Math.log(n)/Math.LN2))},s.aM=cs,s.aN=Bw,s.aO=Hw,s.aP=Ow,s.aQ=function(n,e){const i=document.createElement("video");i.muted=!0,i.onloadstart=function(){e(null,i)};for(let o=0;o<n.length;o++){const a=document.createElement("source");vd(n[o])||(i.crossOrigin="Anonymous"),a.src=n[o],i.appendChild(a)}return{cancel:()=>{}}},s.aR=Nm,s.aS=function(n){return fetch(n).then((e=>e.arrayBuffer())).then((e=>m1(e,0,n)))},s.aT=T1,s.aU=class{constructor(n,e,i,o){this.id=n,this.position=e!=null?new L(e[0],e[1]):new L(0,0),this.orientation=i??[0,0,0],this.nodes=o,this.uploaded=!1,this.aabb=new Si([1/0,1/0,1/0],[-1/0,-1/0,-1/0]),this.matrix=[]}_applyTransformations(n,e){if(Nt(n.matrix,e,n.matrix),n.meshes)for(const i of n.meshes){const o=Si.applyTransformFast(i.aabb,n.matrix);this.aabb.encapsulate(o)}if(n.children)for(const i of n.children)this._applyTransformations(i,n.matrix)}computeBoundsAndApplyParent(){const n=ct([]);for(const e of this.nodes)this._applyTransformations(e,n)}computeModelMatrix(n,e,i,o,a,h,d=!1){w1(this.matrix,this,n.transform,this.position,e,i,o,a,h,d)}upload(n){if(!this.uploaded){for(const e of this.nodes)Ky(e,n);for(const e of this.nodes)rg(e);this.uploaded=!0}}destroy(){for(const n of this.nodes)Yy(n)}},s.aV=yi,s.aW=Zm,s.aX=te,s.aY=oe,s.aZ=Du,s.a_=yr,s.aa=Wn,s.ab=Ca,s.ac=ge,s.ad=Pn,s.ae=Oe,s.af=Ae,s.ag=xl,s.ah=st,s.ai=di,s.aj=zt,s.ak=Nl,s.al=vn,s.am=un,s.an=class{constructor(n){this.specification=n}possiblyEvaluate(n,e){return(function([i,o]){const a=ns([1,i,o]);return{x:a.x,y:a.y,z:a.z}})(n.expression.evaluate(e))}interpolate(n,e,i){return{x:di(n.x,e.x,i),y:di(n.y,e.y,i),z:di(n.z,e.z,i)}}},s.ao=function(n,e,i=0,o=!0){const a=new gt(i,i),h=n.sub(a),d=e.add(a),y=[h,new gt(d.x,h.y),d,new gt(h.x,d.y)];return o&&y.push(h.clone()),y},s.ap=function(n,e){const i=[];for(let o=0;o<n.length;o++){const a=$e(o-1,-1,n.length-1),h=$e(o+1,-1,n.length-1),d=n[o],y=n[h],w=n[a].sub(d).unit(),T=y.sub(d).unit(),C=T.angleWithSep(w.x,w.y),P=w.add(T).unit().mult(-1*e/Math.sin(C/2));i.push(d.add(P))}return i},s.aq=Tw,s.ar=Hr,s.as=function(n,e,i=0){return kn(((e.x-i)*n.scale-n.x)*zt,(e.y*n.scale-n.y)*zt,le(e.z,e.y))},s.at=Ut,s.au=zi,s.av=En,s.aw=k1,s.ax=function(n){let e=1/0,i=1/0,o=-1/0,a=-1/0;for(const h of n)e=Math.min(e,h.x),i=Math.min(i,h.y),o=Math.max(o,h.x),a=Math.max(a,h.y);return{min:new gt(e,i),max:new gt(o,a)}},s.ay=de,s.az=Nt,s.b=function(n){return ws.API_FONTS_REGEX.test(n)},s.b$=h0,s.b0=Zf,s.b1=vg,s.b2=function(){Ra.isLoading()||Ra.isLoaded()||ed()!=="deferred"||Ud()},s.b3=Gc,s.b4=Ze,s.b5=em,s.b6=dn,s.b7=e0,s.b8=Dy,s.b9=Te,s.bA=function(n,e){const{x:i,y:o}=n.point,a=yt(i,o,n.worldSize/n._pixelsPerMercatorPixel,0,0);return Nt(a,a,qi(j(e)))},s.bB=Ie,s.bC=Yo,s.bD=function(n,e){return Math.hypot(e[0]-n[0],e[1]-n[1],e[2]-n[2])},s.bE=Gt,s.bF=on,s.bG=Ji,s.bH=Hm,s.bI=Pl,s.bJ=a0,s.bK=function(n,e,i,o,a){const h=5*e+2;n.float32[h+0]=i,n.float32[h+1]=o,n.float32[h+2]=a},s.bL=yg,s.bM=Xs,s.bN=Ba,s.bO=Oa,s.bP=gs,s.bQ=$e,s.bR=function(n,e,i,o){var a=new ne(4);return a[0]=n,a[1]=e,a[2]=i,a[3]=o,a},s.bS=Y_,s.bT=tr,s.bU=_o,s.bV=kx,s.bW=qw,s.bX=Bx,s.bY=zy,s.bZ=o0,s.b_=_w,s.ba=Mo,s.bb=ef,s.bc=U_,s.bd=kr,s.be=Bp,s.bf=y0,s.bg=function(n,e){const i=st(e.zoom);if(i===0)return j(n);const o=Je(n),a=Ft(o),h=H(o.getWest())*e.worldSize,d=H(o.getEast())*e.worldSize,y=X(o.getNorth())*e.worldSize,w=X(o.getSouth())*e.worldSize,T=[h,y,0],C=[d,y,0],P=[h,w,0],D=[d,w,0],O=wt([],e.globeMatrix);return Pn(T,T,O),Pn(C,C,O),Pn(P,P,O),Pn(D,D,O),a[0]=K(a[0],P,i),a[1]=K(a[1],D,i),a[2]=K(a[2],C,i),a[3]=K(a[3],T,i),Si.fromPoints(a)},s.bh=Oi,s.bi=wt,s.bj=ai,s.bk=K,s.bl=ch,s.bm=ip,s.bn=rt,s.bo=Ti,s.bp=Mg,s.bq=sg,s.br=ru,s.bs=function(n,e){const i=[];for(const o in n)o in e||i.push(o);return i},s.bt=Re,s.bu=["type","source","source-layer","minzoom","maxzoom","filter","layout"],s.bv=Vo,s.bw=function(n){var e=new ne(16);return e[0]=n[0],e[1]=n[1],e[2]=n[2],e[3]=n[3],e[4]=n[4],e[5]=n[5],e[6]=n[6],e[7]=n[7],e[8]=n[8],e[9]=n[9],e[10]=n[10],e[11]=n[11],e[12]=n[12],e[13]=n[13],e[14]=n[14],e[15]=n[15],e},s.bx=ct,s.by=_n,s.bz=$t,s.c=tu,s.c$=45,s.c0=M0,s.c1=Qe,s.c2=cn,s.c3=vs,s.c4=function(n,e,i){i*=.5;var o=e[0],a=e[1],h=e[2],d=e[3],y=Math.sin(i),w=Math.cos(i);return n[0]=o*w+a*y,n[1]=a*w-o*y,n[2]=h*w+d*y,n[3]=d*w-h*y,n},s.c5=Qo,s.c6=br,s.c7=function(n,e){return n[0]=-e[0],n[1]=-e[1],n[2]=-e[2],n[3]=e[3],n},s.c8=je,s.c9=function(n,e,i,o,a){var h,d=1/Math.tan(e/2);return n[0]=d/i,n[1]=0,n[2]=0,n[3]=0,n[4]=0,n[5]=d,n[6]=0,n[7]=0,n[8]=0,n[9]=0,n[11]=-1,n[12]=0,n[13]=0,n[15]=0,a!=null&&a!==1/0?(n[10]=(a+o)*(h=1/(o-a)),n[14]=2*a*o*h):(n[10]=-1,n[14]=-2*o),n},s.cA=Lo,s.cB=Ne,s.cC=function(n,e,i,o,a,h,d,y,w){if(w.name==="globe")return Ne(n,e,new Lo(i,o,a),!1);const T=Zm({z:i,x:o,y:a},w);return new Si([(h+T.x/T.scale)*e,e*(T.y/T.scale),d],[(h+T.x2/T.scale)*e,e*(T.y2/T.scale),y])},s.cD=function(n,e,i){return n[0]=Math.min(e[0],i[0]),n[1]=Math.min(e[1],i[1]),n[2]=Math.min(e[2],i[2]),n[3]=Math.min(e[3],i[3]),n},s.cE=function(n,e,i){return n[0]=Math.max(e[0],i[0]),n[1]=Math.max(e[1],i[1]),n[2]=Math.max(e[2],i[2]),n[3]=Math.max(e[3],i[3]),n},s.cF=function(n){const e=Math.round((n+45+360)%360/90)%4;return Q[e]},s.cG=pe,s.cH=Zn,s.cI=l,s.cJ=function(n){const e=ct(new Float64Array(16));Nt(e,n.pixelMatrix,n.globeMatrix);const i=[0,p,0],o=[0,_,0];return Pn(i,i,e),Pn(o,o,e),[i[0]>0&&i[0]<=n.width&&i[1]>0&&i[1]<=n.height&&!xi(n,new L(n.center.lat,90)),o[0]>0&&o[0]<=n.width&&o[1]>0&&o[1]<=n.height&&!xi(n,new L(n.center.lat,-90))]},s.cK=function(n,e){const{scale:i}=n.tileTransform,o=i*zt/(n.tileSize*Math.pow(2,e.zoom-n.tileID.overscaledZ+n.tileID.canonical.z));return(function(a,h,d){var y=h[1],w=h[2],T=h[3],C=d[0],P=d[1];return a[0]=h[0]*C,a[1]=y*C,a[2]=w*P,a[3]=T*P,a})(new Float32Array(4),e.inverseAdjustmentMatrix,[o,o])},s.cL=ig,s.cM=Ke,s.cN=_1,s.cO=function(n){const e=_1(n,!0);return Ie([],[e[0],e[1],e[4],e[5]])},s.cP=Ei,s.cQ=Dn,s.cR=en,s.cS=function(n){const{x:e,y:i}=n.point,{lng:o,lat:a}=n._center;return yt(e,i,n.worldSize,o,a)},s.cT=wi,s.cU=ke,s.cV=ca,s.cW=qr,s.cX=tp,s.cY=function(n,e,i){let o=0;for(let a=0;a<2;++a)n[a]>0&&(o+=(n[a]-0)*(n[a]-0)),e[a]<0&&(o+=(0-e[a])*(0-e[a]));return o},s.cZ=function(n){return n*n*n*n*n},s.c_=$,s.ca=function(n,e,i,o,a,h,d){var y=1/(e-i),w=1/(o-a),T=1/(h-d);return n[0]=-2*y,n[1]=0,n[2]=0,n[3]=0,n[4]=0,n[5]=-2*w,n[6]=0,n[7]=0,n[8]=0,n[9]=0,n[10]=2*T,n[11]=0,n[12]=(e+i)*y,n[13]=(a+o)*w,n[14]=(d+h)*T,n[15]=1,n},s.cb=Z,s.cc=function(n,e,i){n[4*e+0]=i[0],n[4*e+1]=i[1],n[4*e+2]=i[2],n[4*e+3]=i[3]},s.cd=io,s.ce=Sl,s.cf=as,s.cg=Li,s.ch=bc,s.ci=L,s.cj=Cw,s.ck=function(){var n=new ne(4);return ne!=Float32Array&&(n[1]=0,n[2]=0),n[0]=1,n[3]=1,n},s.cl=function(n,e,i){var o=e[0],a=e[1],h=e[2],d=e[3],y=Math.sin(i),w=Math.cos(i);return n[0]=o*w+h*y,n[1]=a*w+d*y,n[2]=o*-y+h*w,n[3]=a*-y+d*w,n},s.cm=function(n,e){return n[0]===e[0]&&n[1]===e[1]&&n[2]===e[2]&&n[3]===e[3]},s.cn=Bs,s.co=function(n){return Math.hypot(n[0],n[1],n[2],n[3])},s.cp=fa,s.cq=Bo,s.cr=el,s.cs=3,s.ct=2,s.cu=7,s.cv=6,s.cw=er,s.cx=We,s.cy=Bn,s.cz=g1,s.d=function(n){return ws.API_TILEJSON_REGEX.test(n)},s.d$=(n,e,i,o,a,h,d,y,w,T)=>{const C=n.transform,P=C.calculatePixelsToTileUnitsMatrix(e),D=i.paint.get("line-trim-color-use-theme").constantOr("default")==="none",O=C.pitch<15?z1(.07,.7,de((14-C.zoom)/5,0,1)):.07;return{u_matrix:O1(n,e,i,o),u_pixels_to_tile_units:P,u_device_pixel_ratio:h,u_width_scale:d,u_floor_width_scale:y,u_units_to_pixels:[1/C.pixelsToGLUnits[0],1/C.pixelsToGLUnits[1]],u_dash_image:0,u_gradient_image:1,u_image_height:a,u_texsize:N1(i)&&e.lineAtlasTexture?e.lineAtlasTexture.size:[0,0],u_tile_units_to_pixels:F1(e,n.transform),u_alpha_discard_threshold:0,u_trim_offset:w,u_trim_fade_range:i.paint.get("line-trim-fade-range"),u_trim_color:i.paint.get("line-trim-color").toPremultipliedRenderColor(D?null:i.lut).toArray01(),u_emissive_strength:i.paint.get("line-emissive-strength"),u_zbias_factor:O,u_tile_to_meter:_e(e.tileID.canonical,0),u_ground_shadow_factor:T}},s.d0=zu,s.d1=function(n,e,i){const o=Math.sqrt(n*n+e*e+i*i),a=o>0?Math.acos(i/o)*_a:0;let h=n!==0||e!==0?Math.atan2(-e,-n)*_a+90:0;return h<0&&(h+=360),[o,h,a]},s.d2=kn,s.d3=ns,s.d4=_e,s.d5=wn,s.d6=Si,s.d7=Gn,s.d8=function(n){return[Math.pow(n[0],1/2.2),Math.pow(n[1],1/2.2),Math.pow(n[2],1/2.2)]},s.d9=x0,s.dA=Je,s.dB=function(n){const e=pe-5;n=de(n,-e,e)/e*90;const i=Math.pow(Math.abs(Math.sin(vn(n))),3);return Math.round(i*(c.length-1))},s.dC=function(n,e,i,o){const a=e.getNorth(),h=e.getSouth(),d=e.getWest(),y=e.getEast(),w=1<<n.z,T=y-d,C=a-h,P=T/r,D=-C/c[i],O=[0,P,0,D,0,0,a,d,0];if(n.z>0){const N=180/o;St(O,O,[N/T+1,0,0,0,N/C+1,0,-.5*N/P,.5*N/D,1])}return O[2]=w,O[5]=n.x,O[8]=n.y,O},s.dD=j,s.dE=function(n,e,i){const o=ct(new Float64Array(16)),a=(e/(1<<n)-.5)*Math.PI*2;return Hn(o,i.globeMatrix,a),Float32Array.from(o)},s.dF=class{isDataAvailableAtPoint(n){const e=this._source();if(this.isUsingMockSource()||!e||n.y<0||n.y>1)return!1;const i=e.getSource().maxzoom,o=1<<i,a=Math.floor(n.x),h=Math.floor((n.x-a)*o),d=Math.floor(n.y*o),y=this.findDEMTileFor(new cs(i,a,i,h,d));return!(!y||!y.dem)}getAtPointOrZero(n,e=0){return this.getAtPoint(n,e)||0}getAtPoint(n,e,i=!0){if(this.isUsingMockSource())return null;e==null&&(e=null);const o=this._source();if(!o||n.y<0||n.y>1)return e;const a=o.getSource().maxzoom,h=1<<a,d=Math.floor(n.x),y=n.x-d,w=new cs(a,d,a,Math.floor(y*h),Math.floor(n.y*h)),T=this.findDEMTileFor(w);if(!T||!T.dem)return e;const C=T.dem,P=1<<T.tileID.canonical.z,D=(y*P-T.tileID.canonical.x)*C.dim,O=(n.y*P-T.tileID.canonical.y)*C.dim,N=Math.floor(D),G=Math.floor(O);return(i?this.exaggeration():1)*di(di(C.get(N,G),C.get(N,G+1),O-G),di(C.get(N+1,G),C.get(N+1,G+1),O-G),D-N)}getAtTileOffset(n,e,i){const o=1<<n.canonical.z;return this.getAtPointOrZero(new ge(n.wrap+(n.canonical.x+e/zt)/o,(n.canonical.y+i/zt)/o))}getAtTileOffsetFunc(n,e,i,o){return a=>{const h=this.getAtTileOffset(n,a.x,a.y),d=o.upVector(n.canonical,a.x,a.y);return Qe(d,d,h*o.upVectorScale(n.canonical,e,i).metersToTile),d}}getForTilePoints(n,e,i,o){if(this.isUsingMockSource())return!1;const a=Kp.create(this,n,o);return!!a&&(e.forEach((h=>{h[2]=this.exaggeration()*a.getElevationAt(h[0],h[1],i)})),!0)}getMinMaxForTile(n){if(this.isUsingMockSource())return null;const e=this.findDEMTileFor(n);if(!e||!e.dem)return null;const i=e.dem.tree,o=e.tileID,a=1<<n.canonical.z-o.canonical.z;let h=n.canonical.x/a-o.canonical.x,d=n.canonical.y/a-o.canonical.y,y=0;for(let w=0;w<n.canonical.z-o.canonical.z&&!i.leaves[y];w++){h*=2,d*=2;const T=2*Math.floor(d)+Math.floor(h);y=i.childOffsets[y]+T,h%=1,d%=1}return{min:this.exaggeration()*i.minimums[y],max:this.exaggeration()*i.maximums[y]}}getMinElevationBelowMSL(){throw new Error("Pure virtual method called.")}raycast(n,e,i){throw new Error("Pure virtual method called.")}pointCoordinate(n){throw new Error("Pure virtual method called.")}_source(){throw new Error("Pure virtual method called.")}isUsingMockSource(){throw new Error("Pure virtual method called.")}exaggeration(){throw new Error("Pure virtual method called.")}findDEMTileFor(n){throw new Error("Pure virtual method called.")}get visibleDemTiles(){throw new Error("Getter must be implemented in subclass.")}getMinMaxForVisibleTiles(){const n=this.visibleDemTiles;if(n.length===0)return null;let e=!1,i=Number.MAX_VALUE,o=Number.MIN_VALUE;for(const a of n){const h=this.getMinMaxForTile(a.tileID);h&&(i=Math.min(i,h.min),o=Math.max(o,h.max),e=!0)}return e?{min:i,max:o}:null}},s.dG=_x,s.dH=hd,s.dI=function(n,e){return[Math.pow(n[0],2.2)*e,Math.pow(n[1],2.2)*e,Math.pow(n[2],2.2)*e]},s.dJ=qe,s.dK=function(n,e){var i=Math.sin(e),o=Math.cos(e);return n[0]=o,n[1]=i,n[2]=0,n[3]=-i,n[4]=o,n[5]=0,n[6]=0,n[7]=0,n[8]=1,n},s.dL=ao,s.dM=$s,s.dN=rs,s.dO=Ns,s.dP=256,s.dQ=function(n,e){const i=[0,0,0];return Pn(i,i,Oi(j(e.canonical))),Pn(i,i,n),i},s.dR=n=>({u_matrix:new bc(n),u_texsize:new Li(n),u_pixels_to_tile_units:new df(n),u_device_pixel_ratio:new as(n),u_width_scale:new as(n),u_floor_width_scale:new as(n),u_image:new io(n),u_units_to_pixels:new Li(n),u_tile_units_to_pixels:new as(n),u_alpha_discard_threshold:new as(n),u_trim_offset:new Li(n),u_trim_fade_range:new Li(n),u_trim_color:new zu(n),u_emissive_strength:new as(n),u_zbias_factor:new as(n),u_tile_to_meter:new as(n),u_ground_shadow_factor:new Sl(n),u_pattern_transition:new as(n)}),s.dS=n=>({u_matrix:new bc(n),u_pixels_to_tile_units:new df(n),u_device_pixel_ratio:new as(n),u_width_scale:new as(n),u_floor_width_scale:new as(n),u_units_to_pixels:new Li(n),u_dash_image:new io(n),u_gradient_image:new io(n),u_image_height:new as(n),u_texsize:new Li(n),u_tile_units_to_pixels:new as(n),u_alpha_discard_threshold:new as(n),u_trim_offset:new Li(n),u_trim_fade_range:new Li(n),u_trim_color:new zu(n),u_emissive_strength:new as(n),u_zbias_factor:new as(n),u_tile_to_meter:new as(n),u_ground_shadow_factor:new Sl(n)}),s.dT=n=>({u_camera_to_center_distance:new as(n),u_extrude_scale:new df(n),u_device_pixel_ratio:new as(n),u_matrix:new bc(n),u_inv_rot_matrix:new bc(n),u_merc_center:new Li(n),u_tile_id:new Sl(n),u_zoom_transition:new as(n),u_up_dir:new Sl(n),u_emissive_strength:new as(n)}),s.dU=El,s.dV=vS,s.dW=bo,s.dX=(n,e,i,o,a,h)=>{const d=n.transform,y=d.projection.name==="globe";let w;if(h.paint.get("circle-pitch-alignment")==="map")if(y){const C=$s(d.zoom,e.canonical)*d._pixelsPerMercatorPixel;w=Float32Array.from([C,0,0,C])}else w=d.calculatePixelsToTileUnitsMatrix(i);else w=new Float32Array([d.pixelsToGLUnits[0],0,0,d.pixelsToGLUnits[1]]);const T={u_camera_to_center_distance:n.transform.getCameraToCenterDistance(d.projection),u_matrix:n.translatePosMatrix(e.projMatrix,i,h.paint.get("circle-translate"),h.paint.get("circle-translate-anchor")),u_device_pixel_ratio:go.devicePixelRatio,u_extrude_scale:w,u_inv_rot_matrix:qn,u_merc_center:[0,0],u_tile_id:[0,0,0],u_zoom_transition:0,u_up_dir:[0,0,0],u_emissive_strength:h.paint.get("circle-emissive-strength")};if(y){T.u_inv_rot_matrix=o,T.u_merc_center=a,T.u_tile_id=[e.canonical.x,e.canonical.y,1<<e.canonical.z],T.u_zoom_transition=st(d.zoom);const C=a[0]*zt,P=a[1]*zt;T.u_up_dir=d.projection.upVector(new Lo(0,0,0),C,P)}return T},s.dY=B1,s.dZ=Yn,s.d_=(n,e,i,o,a,h,d,y,w,T)=>{const C=n.transform,P=C.pitch<15?z1(.07,.7,de((14-C.zoom)/5,0,1)):.07,D=i.paint.get("line-trim-color-use-theme").constantOr("default")==="none";return{u_matrix:O1(n,e,i,o),u_texsize:e.imageAtlasTexture?e.imageAtlasTexture.size:[0,0],u_pixels_to_tile_units:C.calculatePixelsToTileUnitsMatrix(e),u_device_pixel_ratio:a,u_width_scale:h,u_floor_width_scale:d,u_image:0,u_tile_units_to_pixels:F1(e,C),u_units_to_pixels:[1/C.pixelsToGLUnits[0],1/C.pixelsToGLUnits[1]],u_alpha_discard_threshold:0,u_trim_offset:y,u_trim_fade_range:i.paint.get("line-trim-fade-range"),u_trim_color:i.paint.get("line-trim-color").toPremultipliedRenderColor(D?null:i.lut).toArray01(),u_emissive_strength:i.paint.get("line-emissive-strength"),u_zbias_factor:P,u_tile_to_meter:_e(e.tileID.canonical,0),u_ground_shadow_factor:w,u_pattern_transition:T}},s.da=function(n,e){return n.readFields(pI,{icons:[]},e)},s.db=Q_,s.dc=Wp,s.dd=c0,s.de=nu,s.df=Vd,s.dg=Ys,s.dh=ul,s.di=Vi,s.dj=function(n){const e=n.indexOf(Hc);return e>=0?n.slice(0,e):n},s.dk=function(n){return n.indexOf(Hc)>=0},s.dl=function(n){const e=n.lastIndexOf(Hc);return e>=0?n.slice(e+1):""},s.dm=function(n){const e=[],i=n.id;return i===void 0&&e.push({message:`layers.${i}: missing required property "id"`}),n.render===void 0&&e.push({message:`layers.${i}: missing required method "render"`}),n.renderingMode&&n.renderingMode!=="2d"&&n.renderingMode!=="3d"&&e.push({message:`layers.${i}: property "renderingMode" must be either "2d" or "3d"`}),e},s.dn=function(n,e,i,o){return n.type==="custom"?new lI(n,e):new dI[n.type](n,e,i,o)},s.dp=Ki,s.dq=function(n){const e=n.indexOf(Hc);return e>=0?n.slice(e+1):""},s.dr=class extends em{constructor(n,e){super(n._vectorTileFeature,n._z,n._x,n._y,n.id),n.state&&(this.state=Object.assign({},n.state)),this.target=e.target,this.namespace=e.namespace,e.properties&&(this.properties=e.properties),this.target&&("featuresetId"in this.target&&!this.target.importId||"layerId"in this.target)&&(this.source=n.source,this.sourceLayer=n.sourceLayer,this.layer=n.layer)}toJSON(){const n=super.toJSON();return n.target=this.target,n.namespace=this.namespace,n}},s.ds=oh,s.dt=Qs,s.du=function(n){return n({pluginStatus:ks,pluginURL:yc}),oh.on("pluginStateChange",n),n},s.dv=cf,s.dw=class extends $o{constructor(n){super(n),this.current=uf}set(n,e,i){if(this.fetchUniformLocation(n,e)){for(let o=0;o<9;o++)if(i[o]!==this.current[o]){this.current=i,this.gl.uniformMatrix3fv(this.location,!1,i);break}}}},s.dx=J,s.dy=function(n,e,i){const o=st(i.zoom),a=n.style.map._antialias,h=n.terrain&&n.terrain.exaggeration()>0;return o===0&&!a&&!h},s.dz=function(n){const e=n.pixelsPerMeter,i=e/Z(1,n.center.lat),o=ct(new Float64Array(16));return Ti(o,o,[n.point.x,n.point.y,0]),Ei(o,o,[i,i,e]),Float32Array.from(o)},s.e=ws,s.e$=ed,s.e0=ri,s.e1=Em,s.e2=le,s.e3=Ou,s.e4=K_,s.e5=Kx,s.e6=mf,s.e7=450,s.e8=7,s.e9=we,s.eA=function(n,e,i,o,a,h,d,y,w,T,C,P,D,O,N,G){var q=new ne(16);return q[0]=n,q[1]=e,q[2]=i,q[3]=o,q[4]=a,q[5]=h,q[6]=d,q[7]=y,q[8]=w,q[9]=T,q[10]=C,q[11]=P,q[12]=D,q[13]=O,q[14]=N,q[15]=G,q},s.eB=I,s.eC=Wf,s.eD=fh,s.eE=class{constructor(){this._updateTime=0,this._sourceIds=[],this._activeRegions=[],this._prevRegions=[],this._globalClipBounds={min:new gt(1/0,1/0),max:new gt(-1/0,-1/0)}}clear(){this._activeRegions.length>0&&++this._updateTime,this._activeRegions=[],this._prevRegions=[]}get updateTime(){return this._updateTime}getReplacementRegionsForTile(n,e=!1){const i=Fx(new gt(0,0),new gt(zt,zt),n),o=[];if(e&&!Ly(i,this._globalClipBounds))return o;for(const a of this._activeRegions){if(a.hiddenByOverlap||!Ly(i,a))continue;const h=gE(a.min,a.max,n);o.push({min:h.min,max:h.max,sourceId:this._sourceIds[a.priority],footprint:a.footprint,footprintTileId:a.tileId,order:a.order,clipMask:a.clipMask,clipScope:a.clipScope})}return o}setSources(n){this._setSources(n.map((e=>({getSourceId:()=>e.cache.id,getFootprints:()=>{const i=[];for(const o of e.cache.getVisibleCoordinates()){const a=e.cache.getTile(o).buckets[e.layer];a&&a.updateFootprints(o.toUnwrapped(),i)}return i},getOrder:()=>e.order,getClipMask:()=>e.clipMask,getClipScope:()=>e.clipScope}))))}_addSource(n){const e=n.getFootprints();if(e.length===0)return;const i=n.getOrder(),o=n.getClipMask(),a=n.getClipScope();for(const h of e){if(!h.footprint)continue;const d=Fx(h.footprint.min,h.footprint.max,h.id);this._activeRegions.push({min:d.min,max:d.max,hiddenByOverlap:!1,priority:this._sourceIds.length,tileId:h.id,footprint:h.footprint,order:i,clipMask:o,clipScope:a})}this._sourceIds.push(n.getSourceId())}_computeReplacement(){this._activeRegions.sort(((e,i)=>e.priority-i.priority||W_(e.min,i.min)||W_(e.max,i.max)||e.order-i.order||e.clipMask-i.clipMask||(function(o,a){const h=(d,y)=>d+y;return o.length-a.length||o.reduce(h,"").localeCompare(a.reduce(h,""))})(e.clipScope,i.clipScope)));let n=this._activeRegions.length!==this._prevRegions.length;if(!n){let e=0;for(;!n&&e!==this._activeRegions.length;){const i=this._activeRegions[e],o=this._prevRegions[e];n=i.priority!==o.priority||!zx(i,o)||i.order!==o.order||i.clipMask!==o.clipMask||!Vo(i.clipScope,o.clipScope),++e}}if(n){++this._updateTime;for(const i of this._activeRegions)i.order!==Rm&&(this._globalClipBounds.min.x=Math.min(this._globalClipBounds.min.x,i.min.x),this._globalClipBounds.min.y=Math.min(this._globalClipBounds.min.y,i.min.y),this._globalClipBounds.max.x=Math.max(this._globalClipBounds.max.x,i.max.x),this._globalClipBounds.max.y=Math.max(this._globalClipBounds.max.y,i.max.y));const e=i=>{const o=this._activeRegions;if(i>=o.length)return i;const a=o[i].priority;for(;i<o.length&&o[i].priority===a;)++i;return i};if(this._sourceIds.length>1){let i=0,o=e(i);for(;i!==o;){let a=i;const h=i;for(;a!==o;){const d=this._activeRegions[a];d.hiddenByOverlap=!1;for(let y=0;y<h;y++){const w=this._activeRegions[y];if(!w.hiddenByOverlap&&d.order===Rm&&Ly(d,w)&&(d.hiddenByOverlap=Ox(d.footprint,d.tileId,w.footprint,w.tileId),d.hiddenByOverlap))break}++a}i=o,o=e(i)}}}}_setSources(n){[this._prevRegions,this._activeRegions]=[this._activeRegions,[]],this._sourceIds=[];for(let e=n.length-1;e>=0;e--)this._addSource(n[e]);this._computeReplacement()}},s.eF=Rm,s.eG=class{constructor(n){this._createGrid(n),this._createPoles(n)}destroy(){this._poleIndexBuffer.destroy(),this._gridBuffer.destroy(),this._gridIndexBuffer.destroy(),this._poleNorthVertexBuffer.destroy(),this._poleSouthVertexBuffer.destroy();for(const n of this._poleSegments)n.destroy();for(const n of this._gridSegments)n.withSkirts.destroy(),n.withoutSkirts.destroy()}_fillGridMeshWithLods(n,e){const i=new Mo,o=new yr,a=[],h=n+1+2,d=e[0]+1,y=e[0]+1+(1+e.length),w=(T,C,P)=>{let D=T===h-1?T-2:T===0?T:T-1;return D+=P?24575:0,[D,C]};for(let T=0;T<h;++T)i.emplaceBack(...w(T,0,!0));for(let T=0;T<d;++T)for(let C=0;C<h;++C)i.emplaceBack(...w(C,T,(C===0||C===h-1)&&!0));for(let T=0;T<e.length;++T){const C=e[T];for(let P=0;P<h;++P)i.emplaceBack(...w(P,C,!0))}for(let T=0;T<e.length;++T){const C=o.length,P=e[T]+1+2,D=new yr;for(let G=0;G<P-1;G++){const q=G===P-2,Y=q?h*(y-e.length+T-G):h;for(let se=0;se<h-1;se++){const re=G*h+se;G===0||q||se===0||se===h-2?(D.emplaceBack(re+1,re,re+Y),D.emplaceBack(re+Y,re+Y+1,re+1)):(o.emplaceBack(re+1,re,re+Y),o.emplaceBack(re+Y,re+Y+1,re+1))}}const O=kr.simpleSegment(0,C,i.length,o.length-C);for(let G=0;G<D.uint16.length;G+=3)o.emplaceBack(D.uint16[G],D.uint16[G+1],D.uint16[G+2]);const N=kr.simpleSegment(0,C,i.length,o.length-C);a.push({withoutSkirts:O,withSkirts:N})}return{vertices:i,indices:o,segments:a}}_createGrid(n){const e=this._fillGridMeshWithLods(r,c);this._gridSegments=e.segments,this._gridBuffer=n.createVertexBuffer(e.vertices,U_.members),this._gridIndexBuffer=n.createIndexBuffer(e.indices,!0)}_createPoles(n){const e=new yr;for(let d=0;d<=r;d++)e.emplaceBack(0,d+1,d+2);this._poleIndexBuffer=n.createIndexBuffer(e,!0);const i=new Zc,o=new Zc,a=new Zc,h=new Zc;this._poleSegments=[];for(let d=0,y=0;d<tp;d++){const w=360/(1<<d);i.emplaceBack(0,-fo,0,.5,0),o.emplaceBack(0,-fo,0,.5,1),a.emplaceBack(0,-fo,0,.5,.5),h.emplaceBack(0,-fo,0,.5,.5);for(let T=0;T<=r;T++){let C=T/r,P=0;const D=di(0,w,C),[O,N,G]=v(In,An,D,fo);i.emplaceBack(O,N,G,C,P),o.emplaceBack(O,N,G,C,1-P);const q=vn(D);C=.5+.5*Math.sin(q),P=.5+.5*Math.cos(q),a.emplaceBack(O,N,G,C,P),h.emplaceBack(O,N,G,C,1-P)}this._poleSegments.push(kr.simpleSegment(y,0,66,64)),y+=66}this._poleNorthVertexBuffer=n.createVertexBuffer(i,Op,!1),this._poleSouthVertexBuffer=n.createVertexBuffer(o,Op,!1),this._texturedPoleNorthVertexBuffer=n.createVertexBuffer(a,Op,!1),this._texturedPoleSouthVertexBuffer=n.createVertexBuffer(h,Op,!1)}getGridBuffers(n,e){return[this._gridBuffer,this._gridIndexBuffer,e?this._gridSegments[n].withSkirts:this._gridSegments[n].withoutSkirts]}getPoleBuffers(n,e){return[e?this._texturedPoleNorthVertexBuffer:this._poleNorthVertexBuffer,e?this._texturedPoleSouthVertexBuffer:this._poleSouthVertexBuffer,this._poleIndexBuffer,this._poleSegments[n]]}},s.eH=Lx,s.eI=ce,s.eJ=function(){return!!document.fullscreenElement||!!document.webkitFullscreenElement},s.eK=be,s.eL=me,s.eM=function(n,e,i){return n[0]=e[0]/i[0],n[1]=e[1]/i[1],n[2]=e[2]/i[2],n},s.eN=Di,s.eO=b,s.eP=Un,s.eQ=$n,s.eR=function([n,e,i]){const o=Math.hypot(n,e,i),a=Math.atan2(n,i),h=.5*Math.PI-Math.acos(-e/o);return new L(ke(a),ke(h))},s.eS=fr,s.eT=Zy,s.eU=function(n){const e=n.navigator?n.navigator.userAgent:null;return!!(function(i){if(rr==null){const o=i.navigator?i.navigator.userAgent:null;rr=!!i.safari||!(!o||!(/\b(iPad|iPhone|iPod)\b/.test(o)||o.match("Safari")&&!o.match("Chrome")))}return rr})(n)&&!(!e||!(e.match("Version/15.4")||e.match("Version/15.5")||e.match(/CPU (OS|iPhone OS) (15_4|15_5) like Mac OS X/)))},s.eV=function(n,e){lo=n,Kn=e},s.eW=xi,s.eX=Pt,s.eY=function(n){const e=[0,0,0],i=ct(new Float64Array(16));return Nt(i,n.pixelMatrix,n.globeMatrix),Pn(e,e,i),new gt(e[0],e[1])},s.eZ=function(){const n=Fm;n&&(n.isPreloaded()&&n.numActive()===1?(n.release(Vy),Fm=null):console.warn("Could not clear WebWorkers since there are active Map instances that still reference it. The pre-warmed WebWorker pool can only be cleared when all map instances have been removed with map.remove()"))},s.e_=function(){Q_().acquire(Vy)},s.ea=function(n,e){if(n===e){var i=e[1],o=e[2],a=e[3],h=e[6],d=e[7],y=e[11];n[1]=e[4],n[2]=e[8],n[3]=e[12],n[4]=i,n[6]=e[9],n[7]=e[13],n[8]=o,n[9]=h,n[11]=e[14],n[12]=a,n[13]=d,n[14]=y}else n[0]=e[0],n[1]=e[4],n[2]=e[8],n[3]=e[12],n[4]=e[1],n[5]=e[5],n[6]=e[9],n[7]=e[13],n[8]=e[2],n[9]=e[6],n[10]=e[10],n[11]=e[14],n[12]=e[3],n[13]=e[7],n[14]=e[11],n[15]=e[15];return n},s.eb=aI,s.ec=hn,s.ed=tf,s.ee=256,s.ef=qi,s.eg=Do,s.eh=Hn,s.ei=function(n,e){return n[0]=e[0],n[1]=e[1],n[2]=e[2],n[3]=e[4],n[4]=e[5],n[5]=e[6],n[6]=e[8],n[7]=e[9],n[8]=e[10],n},s.ej=Zc,s.ek=Jd,s.el=Vc,s.em=function(n,e,i,o,a){return de((n-e)/(i-e)*(a-o)+o,o,a)},s.en=Fa,s.eo=function(n,e){var i=e[0],o=e[1],a=e[2],h=e[3],d=e[4],y=e[5],w=e[6],T=e[7],C=e[8],P=C*d-y*T,D=-C*h+y*w,O=T*h-d*w,N=i*P+o*D+a*O;return N?(n[0]=P*(N=1/N),n[1]=(-C*o+a*T)*N,n[2]=(y*o-a*d)*N,n[3]=D*N,n[4]=(C*i-a*w)*N,n[5]=(-y*i+a*h)*N,n[6]=O*N,n[7]=(-T*i+o*w)*N,n[8]=(d*i-o*h)*N,n):null},s.ep=2,s.eq=zn,s.er=Xy,s.es=[1,1,1],s.et=class{constructor(n,e,i,o){this.context=n,this.format=o,this.size=i,this.texture=n.gl.createTexture();const[a,h,d]=this.size,{gl:y}=n;y.bindTexture(y.TEXTURE_3D,this.texture),n.pixelStoreUnpackFlipY.set(!1),n.pixelStoreUnpack.set(1),n.pixelStoreUnpackPremultiplyAlpha.set(!1),y.texImage3D(y.TEXTURE_3D,0,this.format,a,h,d,0,qy(this.format),$y(this.format),e.data)}bind(n,e){const{context:i}=this,{gl:o}=i;o.bindTexture(o.TEXTURE_3D,this.texture),n!==this.minFilter&&(o.texParameteri(o.TEXTURE_3D,o.TEXTURE_MAG_FILTER,n),o.texParameteri(o.TEXTURE_3D,o.TEXTURE_MIN_FILTER,n),this.minFilter=n),e!==this.wrapS&&(o.texParameteri(o.TEXTURE_3D,o.TEXTURE_WRAP_S,e),o.texParameteri(o.TEXTURE_3D,o.TEXTURE_WRAP_T,e),this.wrapS=e)}destroy(){const{gl:n}=this.context;n.deleteTexture(this.texture),this.texture=null}},s.eu=Kp,s.ev=wr,s.ew=function(n,e,i,o){var a=e[0],h=e[1],d=e[2],y=e[3];return n[0]=a+o*(i[0]-a),n[1]=h+o*(i[1]-h),n[2]=d+o*(i[2]-d),n[3]=y+o*(i[3]-y),n},s.ex=Hp,s.ey=Tl,s.ez=zs,s.f=function(n){return btoa(encodeURIComponent(n).replace(/%([0-9A-F]{2})/g,((e,i)=>String.fromCharCode(+("0x"+i)))))},s.f0=function(n,e,i=!1){if(ks===js.deferred||ks===js.loading||ks===js.loaded)throw new Error("setRTLTextPlugin cannot be called multiple times.");yc=go.resolveURL(n),ks=js.deferred,Jh=e,ps(),i||Ud()},s.f1=function(n){Up=go.resolveURL(n),jp||(jp=new Vp(Q_(),new hl)),jp.broadcast("setMeshoptUrl",Up)},s.f2=c1,s.f3=function(n){jy=go.resolveURL(n),jp||(jp=new Vp(Q_(),new hl)),jp.broadcast("setDracoUrl",jy)},s.f4=l1,s.f5=zm,s.f6=function(n){const e=Ol();if(!e)return;const i=e.delete(Ir);n&&i.then((()=>n())).catch(n)},s.f7=op,s.f8=Kt,s.f9=pf,s.fa=Nu,s.fb=Db,s.fc=Lb,s.fd=M1,s.fe=qt,s.ff="hd_road_elevation",s.fg=zr,s.fh=Ri,s.fi=rp,s.fj=l0,s.fk=cp,s.fl=function(n,e,i,o,a,h,d,y=1,w,T,C){n.createArrays(),n.tilePixelRatio=zt/(512*n.overscaling),n.compareText={},n.iconsNeedLinear=!1;const P=n.layers[0].layout,D=n.layers[0]._unevaluatedLayout._values,O={};O.scaleFactor=y,O.textSizeScaleRange=P.get("text-size-scale-range"),O.iconSizeScaleRange=P.get("icon-size-scale-range");const[N,G]=O.textSizeScaleRange,[q,Y]=O.iconSizeScaleRange;O.textScaleFactor=de(O.scaleFactor,N,G),O.iconScaleFactor=de(O.scaleFactor,q,Y);const se=D["text-size"],re=D["icon-size"];if(n.textSizeData.kind==="composite"){const{minZoom:Me,maxZoom:it}=n.textSizeData;O.compositeTextSizes=[se.possiblyEvaluate(new Wn(Me,{worldview:C}),h),se.possiblyEvaluate(new Wn(it,{worldview:C}),h)]}if(n.iconSizeData.kind==="composite"){const{minZoom:Me,maxZoom:it}=n.iconSizeData;O.compositeIconSizes=[re.possiblyEvaluate(new Wn(Me,{worldview:C}),h),re.possiblyEvaluate(new Wn(it,{worldview:C}),h)]}O.layoutTextSize=se.possiblyEvaluate(new Wn(d+1,{worldview:C}),h),O.layoutIconSize=re.possiblyEvaluate(new Wn(d+1,{worldview:C}),h),O.textMaxSize=se.possiblyEvaluate(new Wn(18,{worldview:C}),h);const ae=P.get("symbol-placement"),Ee=P.get("text-rotation-alignment")==="map"&&ae!=="point",ve=P.get("text-size");let xe=!1;const Pe=[];for(const Me of n.features){const it=P.get("text-font").evaluate(Me,{},h).join(","),Fe=ve.evaluate(Me,{},h)*O.textScaleFactor,ot=O.layoutTextSize.evaluate(Me,{},h)*O.textScaleFactor,Dt=O.layoutIconSize.evaluate(Me,{},h)*O.iconScaleFactor,ht={horizontal:{},vertical:void 0},bt=Me.text;let Rt,et=[0,0];if(bt){const Xt=bt.toString(),bi=P.get("text-letter-spacing").evaluate(Me,{},h)*_o,Mi=P.get("text-line-height").evaluate(Me,{},h)*_o,Gi=Nd(Xt)?bi:0,Bi=P.get("text-anchor").evaluate(Me,{},h),mn=P.get("text-variable-anchor");if(!mn){const Ye=P.get("text-radial-offset").evaluate(Me,{},h);if(Ye)et=_w(Bi,[Ye*_o,u0]);else{const kt=P.get("text-offset").evaluate(Me,{},h);et=[kt[0]*_o,kt[1]*_o]}}let Qi=Ee?"center":P.get("text-justify").evaluate(Me,{},h);const Ar=ae==="point",ue=Ar?P.get("text-max-width").evaluate(Me,{},h)*_o:1/0,he=Ye=>{n.allowVerticalPlacement&&Xl(Xt)&&(ht.vertical=s0(bt,e,i,a,it,ue,Mi,Bi,Ye,Gi,et,Pl.vertical,!0,ot,Fe,w))};if(!Ee&&mn){const Ye=Qi==="auto"?mn.map((Ht=>h0(Ht))):[Qi];let kt=!1;for(let Ht=0;Ht<Ye.length;Ht++){const jt=Ye[Ht];if(!ht.horizontal[jt])if(kt)ht.horizontal[jt]=ht.horizontal[0];else{const ei=s0(bt,e,i,a,it,ue,Mi,"center",jt,Gi,et,Pl.horizontal,!1,ot,Fe,w);ei&&(ht.horizontal[jt]=ei,kt=ei.positionedLines.length===1)}}he("left")}else{if(Qi==="auto"&&(Qi=h0(Bi)),Ar||P.get("text-writing-mode").indexOf("horizontal")>=0||!Xl(Xt)){const Ye=s0(bt,e,i,a,it,ue,Mi,Bi,Qi,Gi,et,Pl.horizontal,!1,ot,Fe,w);Ye&&(ht.horizontal[Qi]=Ye)}he(Ar?"left":Qi)}}let Tt,Ve,tt,Lt,Et,li,Yt=!1;const vt=P.get("icon-text-fit").evaluate(Me,{},h);if(Me.icon&&Me.icon.hasPrimary()){const Xt=yw(Me.icon,n.iconSizeData,D["icon-size"],h,n.zoom,Me,w,O.iconScaleFactor,C);Tt=Xt.iconPrimary,tt=Xt.iconSecondary;const bi=Tt.toString();if(Ve=o.get(bi),Ve&&(Et=P.get("icon-offset").evaluate(Me,{},h),li=P.get("icon-anchor").evaluate(Me,{},h),Rt=OS(a.get(bi),tt?a.get(tt.toString()):void 0,Et,li),Yt=Ve.sdf,n.sdfIcons===void 0?n.sdfIcons=Ve.sdf:n.sdfIcons!==Ve.sdf&&tn("Style sheet warning: Cannot mix SDF and non-SDF icons in one buffer"),(Ve.pixelRatio!==n.pixelRatio||P.get("icon-rotate").constantOr(1)!==0)&&(n.iconsNeedLinear=!0)),tt){const Mi=tt.toString();Lt=o.get(Mi)}}xe=xe||!(!Me.icon||!Me.icon.hasSecondary());const At=d0(ht.horizontal)||ht.vertical;n.iconsInText||(n.iconsInText=!!At&&At.iconsInText);const ti=ot*O.textScaleFactor/_o,{defaultShapedIcon:Zt,verticallyShapedIcon:Bt}=WS(n,Rt,P,Me,h,ht,ti,Et,vt);vt!=="none"&&Rt&&(ew(Rt)||tw(Rt))&&(ug(0,Ve,Tt,Rt,Zt,vt,T,o,a),ug(0,Lt,tt,Rt,Zt,vt,T,o,a),Bt&&(ug(0,Ve,Tt,Rt,Bt,vt,T,o,a),ug(0,Lt,tt,Rt,Bt,vt,T,o,a))),Rt=Zt,Pe.push({feature:Me,shapedTextOrientations:ht,shapedText:At,shapedIcon:Rt,iconPrimary:Tt,iconSecondary:tt,iconOffset:Et,iconAnchor:li,verticallyShapedIcon:Bt,layoutTextSize:ot,layoutIconSize:Dt,textOffset:et,isSDFIcon:Yt,iconTextFit:vt})}return{featureData:Pe,sizes:O,hasAnySecondaryIcon:xe,textAlongLine:Ee,symbolPlacement:ae}},s.fm=uw,s.fn=function(n,e,i,o,a,h,d,y,w,T){const{featureData:C,hasAnySecondaryIcon:P,sizes:D,textAlongLine:O,symbolPlacement:N}=e;for(const G of C){const{shapedIcon:q,verticallyShapedIcon:Y,feature:se,shapedTextOrientations:re,shapedText:ae,layoutTextSize:Ee,textOffset:ve,isSDFIcon:xe,iconPrimary:Pe,iconSecondary:Me,iconTextFit:it,iconOffset:Fe}=G;vw(q,T.iconPositions,Pe,Me),vw(Y,T.iconPositions,Pe,Me),$S(re,T.iconPositions),qS(Pe,Me,T.iconPositions),(ae||q)&&ZS(n,se,re,q,Y,w,D,Ee,0,ve,xe,o,a,d,y,P,it,Fe,O,N)}i&&n.generateCollisionDebugBuffers(h,n.collisionBoxArray,D.textScaleFactor)},s.fo=Qt,s.fp=Rg,s.fq=Ue,s.fr=function(n){let e=0;if(new Uint32Array(n,0,1)[0]!==h1){const i=new Uint32Array(n,0,7),[,,o,a,h,d]=i;e=i.byteLength+a+h+d+h,(o!==n.byteLength||e>=n.byteLength)&&tn("Invalid b3dm header information.")}return m1(n,e)},s.fs=function(n,e){const i=T1(n);for(const o of i){for(const a of o.meshes)ZE(a);o.lights&&(o.lightMeshIndex=o.meshes.length,o.meshes.push(XE(o.lights,e)))}return i},s.ft=Eg,s.fu=jn,s.fv=o1,s.fw=Ra,s.fx=js,s.fy=function(n){ec(),ya?.then((e=>{e.keys().then((i=>{for(let o=0;o<i.length-n;o++)e.delete(i[o]).catch((a=>tn(a.message)))})).catch((i=>tn(i.message)))})).catch((e=>tn(e.message)))},s.g=function(n,e){return Qs(Ge(n,{method:"GET"}),e)},s.h=Ge,s.i=function(n){return ws.API_STYLE_REGEX.test(n)&&!tu(n)},s.j=function(n){return n.indexOf("mapbox:")===0},s.k=ol,s.l=iu,s.m=function(n){return decodeURIComponent(atob(n).split("").map((e=>"%"+("00"+e.charCodeAt(0).toString(16)).slice(-2))).join(""))},s.n=function(n,e){return Qs(Ge(n,{type:"json"}),e)},s.o=jo,s.p=function(n,e){return Qs(Ge(n,{method:"POST"}),e)},s.q=go,s.r=ko,s.s=function(n){try{const e=self[n];return e.setItem("_mapbox_test_",1),e.removeItem("_mapbox_test_"),!0}catch{return!1}},s.t=So,s.u=function(){return(function n(e){return e?(e^Math.random()*(16>>e/4)).toString(16):([1e7]+-[1e3]+-4e3+-8e3+-1e11).replace(/[018]/g,n)})()},s.v=function(n){return!!n&&/^[0-9a-f]{8}-[0-9a-f]{4}-[4][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i.test(n)},s.w=tn,s.x=function(){return Uy||(Uy=new op),Uy},s.y=A0,s.z=ds})),z(["./shared"],(function(s){function ee(ke){const Q=ke?ke.url.toString():void 0;return Q?performance.getEntriesByName(Q):[]}function ne(ke){if(typeof ke=="number"||typeof ke=="boolean"||typeof ke=="string"||ke==null)return JSON.stringify(ke);if(Array.isArray(ke)){let J="[";for(const ce of ke)J+=`${ne(ce)},`;return`${J}]`}let Q="{";for(const J of Object.keys(ke).sort())Q+=`${J}:${ne(ke[J])},`;return`${Q}}`}function Ie(ke){let Q="";for(const J of s.bu)Q+=`/${ne(ke[J])}`;return Q}class qe{constructor(Q){this.keyCache={},this._layers={},this._layerConfigs={},Q&&this.replace(Q)}replace(Q,J){this._layerConfigs={},this._layers={},this.update(Q,[],J)}update(Q,J,ce){this._options=ce;for(const de of Q)this._layerConfigs[de.id]=de,(this._layers[de.id]=s.dn(de,this.scope,null,this._options)).compileFilter(ce),this.keyCache[de.id]&&delete this.keyCache[de.id];for(const de of J)delete this.keyCache[de],delete this._layerConfigs[de],delete this._layers[de];this.familiesBySource={};const be=(function(de,Ae){const $e={};for(let Ge=0;Ge<de.length;Ge++){const Ct=de[Ge];let lt=Ae&&Ae[Ct.id];lt||(Ct.type==="symbol"?lt=Ct.id:(lt=Ie(Ct),Ct.type==="line"&&Ct.paint&&(function yi(Ri){return typeof Ri=="string"&&Ri==="line-progress"||(Array.isArray(Ri)?Ri.some(yi):!(!Ri||typeof Ri!="object")&&Object.values(Ri).some(yi))})(Ct.paint["line-width"])&&(lt+=`/${ne(Ct.paint["line-width"])}`))),Ae&&(Ae[Ct.id]=lt);let ri=$e[lt];ri||(ri=$e[lt]=[]),ri.push(Ct)}const Re=[];for(const Ge in $e)Re.push($e[Ge]);return Re})(Object.values(this._layerConfigs),this.keyCache);for(const de of be){const Ae=de.map((ri=>this._layers[ri.id])),$e=Ae[0];if($e.visibility==="none")continue;const Re=$e.source||"";let Ge=this.familiesBySource[Re];Ge||(Ge=this.familiesBySource[Re]={});const Ct=$e.sourceLayer||"_geojsonTileLayer";let lt=Ge[Ct];lt||(lt=Ge[Ct]=[]),lt.push(Ae)}}}const Xe=1*s.fa;class St{constructor(Q){const J={},ce=[];for(const $e in Q){const Re=Q[$e],Ge=J[$e]={};for(const Ct in Re.glyphs){const lt=Re.glyphs[+Ct];if(!lt||lt.bitmap.width===0||lt.bitmap.height===0)continue;const ri=lt.metrics.localGlyph?Xe:1,yi={x:0,y:0,w:lt.bitmap.width+2*ri,h:lt.bitmap.height+2*ri};ce.push(yi),Ge[Ct]=yi}}const{w:be,h:de}=s.H(ce),Ae=new s.f9({width:be||1,height:de||1});for(const $e in Q){const Re=Q[$e];for(const Ge in Re.glyphs){const Ct=Re.glyphs[+Ge];if(!Ct||Ct.bitmap.width===0||Ct.bitmap.height===0)continue;const lt=J[$e][Ge],ri=Ct.metrics.localGlyph?Xe:1;s.f9.copy(Ct.bitmap,Ae,{x:0,y:0},{x:lt.x+ri,y:lt.y+ri},Ct.bitmap)}}this.image=Ae,this.positions=J}}s.f8(St,"GlyphAtlas");class $t{constructor(Q){this.tileID=new s.aM(Q.tileID.overscaledZ,Q.tileID.wrap,Q.tileID.canonical.z,Q.tileID.canonical.x,Q.tileID.canonical.y),this.tileZoom=Q.tileZoom,this.uid=Q.uid,this.zoom=Q.zoom,this.lut=Q.lut,this.canonical=Q.tileID.canonical,this.pixelRatio=Q.pixelRatio,this.tileSize=Q.tileSize,this.source=Q.source,this.scope=Q.scope,this.overscaling=this.tileID.overscaleFactor(),this.showCollisionBoxes=Q.showCollisionBoxes,this.collectResourceTiming=!!Q.request&&Q.request.collectResourceTiming,this.promoteId=Q.promoteId,this.isSymbolTile=Q.isSymbolTile,this.tileTransform=s.aW(Q.tileID.canonical,Q.projection),this.projection=Q.projection,this.worldview=Q.worldview,this.localizableLayerIds=Q.localizableLayerIds,this.brightness=Q.brightness,this.extraShadowCaster=!!Q.extraShadowCaster,this.tessellationStep=Q.tessellationStep,this.scaleFactor=Q.scaleFactor,this.worldview=Q.worldview}parse(Q,J,ce,be,de,Ae){this.status="parsing",this.data=Q,this.collisionBoxArray=new s.b0;const $e=new s.fb(Object.keys(Q.layers).sort()),Re=new s.fc(this.tileID,this.promoteId);Re.bucketLayerIDs=[];const Ge={},Ct=new s.fd(256,256),lt={featureIndex:Re,iconDependencies:new Map,patternDependencies:new Map,glyphDependencies:{},lineAtlas:Ct,availableImages:ce,brightness:this.brightness,scaleFactor:this.scaleFactor,elevationFeatures:void 0},ri=[],yi=J.familiesBySource[this.source];for(const Ki in yi){const Vi=Q.layers[Ki];if(!Vi)continue;let Yi=!1,Xn=!1,tn=!1;for(const jn of yi[Ki])jn[0].type==="symbol"?Yi=!0:Xn=!0,jn[0].is3D()&&jn[0].type!=="model"&&(tn=!0);if(this.extraShadowCaster&&!tn||this.isSymbolTile===!0&&!Yi||this.isSymbolTile===!1&&!Xn)continue;Vi.version===1&&s.w(`Vector tile source "${this.source}" layer "${Ki}" does not use vector tile spec v2 and therefore may have some rendering errors.`);const Nr=$e.encode(Ki),Fn=[];let ns=!1;for(let jn=0,dn=0;jn<Vi.length;jn++){const rr=Vi.feature(jn),br=Re.getId(rr,Ki);if(this.localizableLayerIds&&this.localizableLayerIds.has(Ki)){const Tr=rr.properties?rr.properties.worldview:null;if(this.worldview&&typeof Tr=="string")if(Tr==="all")rr.properties.$localized=!0;else{if(!Tr.split(",").includes(this.worldview))continue;rr.properties.$localized=!0,rr.properties.worldview=this.worldview}}!ns&&rr.properties&&rr.properties.hasOwnProperty(s.fe)&&(ns=!0),Fn.push({feature:rr,id:br,index:dn,sourceLayerIndex:Nr}),dn++}ns&&!lt.elevationFeatures&&Q.layers.hasOwnProperty(s.ff)&&(lt.elevationFeatures=s.fg.parseFrom(Q.layers[s.ff],this.canonical));for(const jn of yi[Ki]){const dn=jn[0];if(this.extraShadowCaster&&(!dn.is3D()||dn.type==="model")||this.isSymbolTile!==void 0&&dn.type==="symbol"!==this.isSymbolTile||dn.minzoom&&this.zoom<Math.floor(dn.minzoom)||dn.maxzoom&&this.zoom>=dn.maxzoom||dn.visibility==="none")continue;ct(jn,this.zoom,lt.brightness,ce,this.worldview);const rr=Ge[dn.id]=dn.createBucket({index:Re.bucketLayerIDs.length,layers:jn,zoom:this.zoom,lut:this.lut,canonical:this.canonical,pixelRatio:this.pixelRatio,overscaling:this.overscaling,collisionBoxArray:this.collisionBoxArray,sourceLayerIndex:Nr,sourceID:this.source,projection:this.projection.spec,tessellationStep:this.tessellationStep,styleDefinedModelURLs:be,worldview:this.worldview});Re.bucketLayerIDs.push(jn.map((Tr=>s.C(Tr.id,Tr.scope))));let br=rr.prepare?rr.prepare():null;br!=null?(br=br.then((()=>rr.populate(Fn,lt,this.tileID.canonical,this.tileTransform))),ri.push(br)):rr.populate(Fn,lt,this.tileID.canonical,this.tileTransform)}}const Ri=()=>{let Ki,Vi,Yi,Xn,tn,Nr;Ct.trim();const Fn={type:"maybePrepare",isSymbolTile:this.isSymbolTile,zoom:this.zoom},ns=()=>{if(Ki)return this.status="done",Ae(Ki);if(this.extraShadowCaster)this.status="done",Ae(null,{buckets:Object.values(Ge).filter((dn=>!dn.isEmpty())),featureIndex:Re,collisionBoxArray:null,glyphAtlasImage:null,lineAtlas:null,imageAtlas:null,brightness:lt.brightness,glyphMap:null,iconMap:null,glyphPositions:null});else if(Vi&&Yi&&Xn){const dn=new St(Vi),rr=new Map;for(const[us,rs]of Yi.entries()){const{imagePosition:Ns}=s.fj(us,rs,s.fk);rr.set(us,Ns)}const br={};for(const us in Ge){const rs=Ge[us];rs instanceof s.b1&&(ct(rs.layers,this.zoom,lt.brightness,ce,this.worldview),br[us]=s.fl(rs,Vi,dn.positions,Yi,rr,this.tileID.canonical,this.tileZoom,this.scaleFactor,this.pixelRatio,tn,this.worldview))}const Tr={iconsPending:!0,patternsPending:!0};this.rasterizeIfNeeded(de,Yi,tn,(()=>{Tr.iconsPending=!1,jn(br,dn,Tr)})),this.rasterizeIfNeeded(de,Xn,Nr,(()=>{Tr.patternsPending=!1,jn(br,dn,Tr)}))}},jn=(dn,rr,br,Tr)=>{if(br.iconsPending||br.patternsPending)return;const us=new s.fm(Yi,Xn,this.lut);for(const rs in Ge){const Ns=Ge[rs];if(rs in dn)s.fn(Ns,dn[rs],this.showCollisionBoxes,ce,this.tileID.canonical,this.tileZoom,this.projection,this.brightness,Yi,us);else if(Ns.hasPattern&&(Ns instanceof s.b7||Ns instanceof s.b8||Ns instanceof s.e4)){ct(Ns.layers,this.zoom,lt.brightness,ce,this.worldview);const Ks=Object.fromEntries(us.patternPositions);Ns.addFeatures(lt,this.tileID.canonical,Ks,ce,this.tileTransform,this.brightness)}}this.status="done",Ae(null,{buckets:Object.values(Ge).filter((rs=>!rs.isEmpty())),featureIndex:Re,collisionBoxArray:this.collisionBoxArray,glyphAtlasImage:rr.image,lineAtlas:Ct,imageAtlas:us,brightness:lt.brightness})};if(!this.extraShadowCaster){const dn=s.fh(lt.glyphDependencies,(Tr=>Object.keys(Tr).map(Number)));Object.keys(dn).length?de.send("getGlyphs",{uid:this.uid,stacks:dn},((Tr,us)=>{Ki||(Ki=Tr,Vi=us,ns())}),void 0,!1,Fn):Vi={};const rr=Array.from(lt.iconDependencies.keys()).map((Tr=>s.I.parse(Tr)));rr.length?de.send("getImages",{images:rr,source:this.source,scope:this.scope,tileID:this.tileID,type:"icons"},((Tr,us)=>{Ki||(Ki=Tr,Yi=new Map,tn=this.updateImageMapAndGetImageTaskQueue(Yi,us,lt.iconDependencies),ns())}),void 0,!1,Fn):(Yi=new Map,tn=new Map);const br=Array.from(lt.patternDependencies.keys()).map((Tr=>s.I.parse(Tr)));br.length?de.send("getImages",{images:br,source:this.source,scope:this.scope,tileID:this.tileID,type:"patterns"},((Tr,us)=>{Ki||(Ki=Tr,Xn=new Map,Nr=this.updateImageMapAndGetImageTaskQueue(Xn,us,lt.patternDependencies),ns())}),void 0,!1,Fn):(Xn=new Map,Nr=new Map)}if(lt.elevationFeatures&&lt.elevationFeatures.length>0){const dn=[];for(const br of Object.values(Ge))if(br instanceof s.b8){const Tr=br.getUnevaluatedPortalGraph();Tr&&dn.push(Tr)}const rr=s.fi.evaluate(dn);for(const br of Object.values(Ge))if(br instanceof s.b8){const Tr=Q.layers[$e.decode(br.sourceLayerIndex)];br.setEvaluatedPortalGraph(rr,Tr,this.tileID.canonical,lt.availableImages,lt.brightness)}}ns()};ri.length>0?Promise.allSettled(ri).then(Ri).catch(Ae):Ri()}rasterizeIfNeeded(Q,J,ce,be){Array.from(J.values()).some((de=>de.usvg))?this.rasterize(Q,J,ce,be):be()}updateImageMapAndGetImageTaskQueue(Q,J,ce){const be=new Map;for(const de of J.keys()){const Ae=ce.get(de)||[];for(const $e of Ae){const Re=$e.toString(),Ge=J.get($e.id.toString());Ge.usvg?be.has(Re)||(be.set(Re,$e),Q.set(Re,Object.assign({},Ge))):Q.set(Re,Ge)}}return be}rasterize(Q,J,ce,be){this.rasterizeTask=Q.send("rasterizeImages",{scope:this.scope,tasks:ce},((de,Ae)=>{if(!de)for(const[$e,Re]of Ae.entries()){const Ge=Object.assign(J.get($e),{data:Re});J.set($e,Ge)}be()}))}cancelRasterize(){this.rasterizeTask&&this.rasterizeTask.cancel()}}function ct(ke,Q,J,ce,be){const de=new s.aa(Q,{brightness:J,worldview:be});for(const Ae of ke)Ae.recalculate(de,ce)}class wt extends s.E{constructor(Q,J,ce,be,de,Ae,$e){super(),this.actor=Q,this.layerIndex=J,this.availableImages=ce,this.availableModels=be,this.loadVectorData=Ae||s.aJ,this.loading={},this.loaded={},this.deduped=new s.aI(Q.scheduler),this.isSpriteLoaded=de,this.scheduler=Q.scheduler,this.brightness=$e}loadTile(Q,J){const ce=Q.uid,be=Q&&Q.request,de=be&&be.collectResourceTiming,Ae=this.loading[ce]=new $t(Q);Ae.abort=this.loadVectorData(Q,(($e,Re)=>{const Ge=!this.loading[ce];if(delete this.loading[ce],Ae.cancelRasterize(),Ge||$e||!Re)return Ae.status="done",Ge||(this.loaded[ce]=Ae),J($e);const Ct=Re.rawData,lt={};Re.expires&&(lt.expires=Re.expires),Re.cacheControl&&(lt.cacheControl=Re.cacheControl),Ae.vectorTile=Re.vectorTile||new s.fo(new s.bq(Ct));const ri=()=>{Ae.parse(Ae.vectorTile,this.layerIndex,this.availableImages,this.availableModels,this.actor,((yi,Ri)=>{if(yi||!Ri)return J(yi);const Ki={};if(de){const Vi=ee(be);Vi.length>0&&(Ki.resourceTiming=JSON.parse(JSON.stringify(Vi)))}J(null,s.h({rawTileData:Ct.slice(0)},Ri,lt,Ki))}))};this.isSpriteLoaded?ri():this.once("isSpriteLoaded",(()=>{this.scheduler?this.scheduler.add(ri,{type:"parseTile",isSymbolTile:Q.isSymbolTile,zoom:Q.tileZoom}):ri()})),this.loaded=this.loaded||{},this.loaded[ce]=Ae}))}reloadTile(Q,J){const ce=this.loaded,be=Q.uid;if(ce&&ce[be]){const de=ce[be];de.scaleFactor=Q.scaleFactor,de.showCollisionBoxes=Q.showCollisionBoxes,de.projection=Q.projection,de.brightness=Q.brightness,de.tileTransform=s.aW(Q.tileID.canonical,Q.projection),de.extraShadowCaster=Q.extraShadowCaster,de.lut=Q.lut,de.worldview=Q.worldview;const Ae=($e,Re)=>{const Ge=de.reloadCallback;Ge&&(delete de.reloadCallback,de.parse(de.vectorTile,this.layerIndex,this.availableImages,this.availableModels,this.actor,Ge)),J($e,Re)};de.status==="parsing"?de.reloadCallback=Ae:de.status==="done"&&(de.vectorTile?de.parse(de.vectorTile,this.layerIndex,this.availableImages,this.availableModels,this.actor,Ae):Ae())}else J(null,void 0)}abortTile(Q,J){const ce=Q.uid,be=this.loading[ce];be&&(be.abort&&be.abort(),delete this.loading[ce]),J()}removeTile(Q,J){const ce=this.loaded,be=Q.uid;ce&&ce[be]&&delete ce[be],J()}}class Nt{loadTile(Q,J){const{uid:ce,encoding:be,rawImageData:de,padding:Ae}=Q,$e=ImageBitmap&&de instanceof ImageBitmap?this.getImageData(de,Ae):de;J(null,new s.fp(ce,$e,be,Ae<1))}reloadTile(Q,J){J(null,null)}abortTile(Q,J){J()}removeTile(Q,J){J()}getImageData(Q,J){this.offscreenCanvas&&this.offscreenCanvasContext||(this.offscreenCanvas=new OffscreenCanvas(Q.width,Q.height),this.offscreenCanvasContext=this.offscreenCanvas.getContext("2d",{willReadFrequently:!0})),this.offscreenCanvas.width=Q.width,this.offscreenCanvas.height=Q.height,this.offscreenCanvasContext.drawImage(Q,0,0,Q.width,Q.height);const ce=this.offscreenCanvasContext.getImageData(-J,-J,Q.width+2*J,Q.height+2*J);return this.offscreenCanvasContext.clearRect(0,0,this.offscreenCanvas.width,this.offscreenCanvas.height),ce}}s.bp.setPbf(s.bq);class Ti{constructor(Q){this._mrt=new s.bp(Q.partial?30:1/0),this._isHeaderLoaded=!1,this.uid=Q.uid,this.tileID=Q.tileID,this.source=Q.source}parse(Q,J){const ce=this._mrt;this.status="parsing",this._entireBuffer=Q;try{ce.parseHeader(Q),this._isHeaderLoaded=!0;const be=[];for(const de in ce.layers){const Ae=ce.getLayer(de),$e=Ae.getDataRange(Ae.getBandList()),Re=ce.createDecodingTask($e),Ge=Q.slice($e.firstByte,$e.lastByte+1),Ct=s.bp.performDecoding(Ge,Re).then((lt=>Re.complete(null,lt))).catch((lt=>Re.complete(lt,null)));be.push(Ct)}Promise.allSettled(be).then((()=>J(null,ce))).catch((de=>J(de)))}catch(be){J(be)}}}class Ei{constructor(Q){this.actor=Q,this.loading={},this.loaded={}}loadTile(Q,J){const ce=Q.uid,be=Q.request,de=this.loading[ce]=new Ti(Q),{cancel:Ae}=s.br(be,(($e,Re,Ge,Ct)=>{const lt=!this.loading[ce];if(delete this.loading[ce],lt||$e||!Re)return de.status="done",lt||(this.loaded[ce]=de),J($e);de.parse(Re,((ri,yi)=>{if(ri||!yi)return J(ri);J(null,yi,Ge,Ct)})),this.loaded[ce]=de}));de.abort=Ae}reloadTile(Q,J){J(null,void 0)}abortTile(Q,J){const ce=Q.uid,be=this.loading[ce];be&&(be.abort&&be.abort(),delete this.loading[ce]),J()}removeTile(Q,J){const ce=Q.uid;this.loaded[ce]&&delete this.loaded[ce],J()}decodeRasterArray(Q,J){s.bp.performDecoding(Q.buffer,Q.task).then((ce=>J(null,ce))).catch((ce=>J(ce)))}}const en=s.fq.prototype.toGeoJSON;class Hn{constructor(Q){this._feature=Q,this.extent=s.aj,this.type=Q.type,this.properties=Q.tags,"id"in Q&&!isNaN(Q.id)&&(this.id=parseInt(Q.id,10))}loadGeometry(){if(this._feature.type===1){const Q=[];for(const J of this._feature.geometry)Q.push([new s.P(J[0],J[1])]);return Q}{const Q=[];for(const J of this._feature.geometry){const ce=[];for(const be of J)ce.push(new s.P(be[0],be[1]));Q.push(ce)}return Q}}toGeoJSON(Q,J,ce){return en.call(this,Q,J,ce)}}class _n{constructor(Q,J){this.name=Q,this.extent=s.aj,this.length=J.length,this._jsonFeatures=J}feature(Q){return new Hn(this._jsonFeatures[Q])}}class rt{constructor(Q){this.layers={},this.extent=s.aj;for(const J of Object.keys(Q))this.layers[J]=new _n(J,Q[J])}}const De=64/4096,je=128;class Ke{constructor(){this.features=new Map}clear(){this.features.clear()}load(Q=[],J){for(const ce of Q){const be=ce.id;if(be==null)continue;let de=this.features.get(be);de&&this.updateCache(de,J),ce.geometry?(de=ut(ce),this.updateCache(de,J),this.features.set(be,de)):this.features.delete(be),this.updateCache(de,J)}}updateCache(Q,J){for(const{canonical:ce,uid:be}of Object.values(J)){const{z:de,x:Ae,y:$e}=ce;We(Q,Math.pow(2,de),Ae,$e)&&delete J[be]}}getTile(Q,J,ce){const be=Math.pow(2,Q),de=[];for(const Ae of this.features.values())We(Ae,be,J,ce)&&de.push(wn(Ae,be,J,ce));return{features:de}}getFeatures(){return[...this.features.values()]}}function We({minX:ke,minY:Q,maxX:J,maxY:ce},be,de,Ae){return ke<(de+1+De)/be&&Q<(Ae+1+De)/be&&J>(de-De)/be&&ce>(Ae-De)/be}function ut(ke){const{id:Q,geometry:J,properties:ce}=ke;if(!J)return;if(J.type==="GeometryCollection")throw new Error("GeometryCollection not supported in dynamic mode.");const{type:be,coordinates:de}=J,Ae={id:Q,type:1,geometry:[],tags:ce,minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0},$e=Ae.geometry;if(be==="Point")Oe(de,$e,Ae);else if(be==="MultiPoint")for(const Re of de)Oe(Re,$e,Ae);else if(be==="LineString")Ae.type=2,kn(de,$e,Ae);else if(be==="MultiLineString")Ae.type=2,$n(de,$e,Ae);else if(be==="Polygon")Ae.type=3,$n(de,$e,Ae,!0);else{if(be!=="MultiPolygon")throw new Error("Input data is not a valid GeoJSON object.");Ae.type=3;for(const Re of de)$n(Re,$e,Ae,!0)}return Ae}function Oe([ke,Q],J,ce){const be=s.aD(ke);let de=s.aH(Q);de=de<0?0:de>1?1:de,J.push(be,de),ce.minX=Math.min(ce.minX,be),ce.minY=Math.min(ce.minY,de),ce.maxX=Math.max(ce.maxX,be),ce.maxY=Math.max(ce.maxY,de)}function kn(ke,Q,J,ce=!1,be=!1){const de=[];for(const Ae of ke)Oe(Ae,de,J);Q.push(de),ce&&(function(Ae,$e){let Re=0;for(let Ge=0,Ct=Ae.length,lt=Ct-2;Ge<Ct;lt=Ge,Ge+=2)Re+=(Ae[Ge]-Ae[lt])*(Ae[Ge+1]+Ae[lt+1]);if(Re>0===$e)for(let Ge=0,Ct=Ae.length;Ge<Ct/2;Ge+=2){const lt=Ae[Ge],ri=Ae[Ge+1];Ae[Ge]=Ae[Ct-2-Ge],Ae[Ge+1]=Ae[Ct-1-Ge],Ae[Ct-2-Ge]=lt,Ae[Ct-1-Ge]=ri}})(de,be)}function $n(ke,Q,J,ce=!1){for(let be=0;be<ke.length;be++)kn(ke[be],Q,J,ce,be===0)}function wn(ke,Q,J,ce){const{id:be,type:de,geometry:Ae,tags:$e}=ke,Re=[];if(de===1)(function(Ge,Ct,lt,ri,yi){for(let Ri=0;Ri<Ge.length;Ri+=2){const Ki=Math.round(s.aj*(Ge[Ri+0]*Ct-lt)),Vi=Math.round(s.aj*(Ge[Ri+1]*Ct-ri));yi.push([Ki,Vi])}})(Ae,Q,J,ce,Re);else for(const Ge of Ae)Gn(Ge,Q,J,ce,Re);return{id:be,type:de,geometry:Re,tags:$e}}function Gn(ke,Q,J,ce,be){const de=-je,Ae=s.aj+je;let $e;for(let Re=0;Re<ke.length-2;Re+=2){let Ge=Math.round(s.aj*(ke[Re+0]*Q-J)),Ct=Math.round(s.aj*(ke[Re+1]*Q-ce)),lt=Math.round(s.aj*(ke[Re+2]*Q-J)),ri=Math.round(s.aj*(ke[Re+3]*Q-ce));const yi=lt-Ge,Ri=ri-Ct;Ge<de&&lt<de||(Ge<de?(Ct+=Math.round(Ri*((de-Ge)/yi)),Ge=de):lt<de&&(ri=Ct+Math.round(Ri*((de-Ge)/yi)),lt=de),Ct<de&&ri<de||(Ct<de?(Ge+=Math.round(yi*((de-Ct)/Ri)),Ct=de):ri<de&&(lt=Ge+Math.round(yi*((de-Ct)/Ri)),ri=de),Ge>=Ae&&lt>=Ae||(Ge>=Ae?(Ct+=Math.round(Ri*((Ae-Ge)/yi)),Ge=Ae):lt>=Ae&&(ri=Ct+Math.round(Ri*((Ae-Ge)/yi)),lt=Ae),Ct>=Ae&&ri>=Ae||(Ct>=Ae?(Ge+=Math.round(yi*((Ae-Ct)/Ri)),Ct=Ae):ri>=Ae&&(lt=Ge+Math.round(yi*((Ae-Ct)/Ri)),ri=Ae),$e&&Ge===$e[$e.length-1][0]&&Ct===$e[$e.length-1][1]||($e=[[Ge,Ct]],be.push($e)),$e.push([lt,ri])))))}}function wi({name:ke,features:Q},J){J.writeStringField(1,ke),J.writeVarintField(5,s.aj);const ce=new Map,be=new Map,de={keys:ce,values:be,feature:null};for(const Ae of Q)de.feature=Ae,J.writeMessage(2,Ui,de);for(const Ae of ce.keys())J.writeStringField(3,Ae);for(const Ae of be.keys())J.writeMessage(4,Un,Ae)}function Ui(ke,Q){const J=ke.feature;J.id===void 0||isNaN(+J.id)||Q.writeVarintField(1,+J.id),J.tags&&Q.writeMessage(2,Ai,ke),Q.writeVarintField(3,J.type),Q.writeMessage(4,ji,J)}function Ai({keys:ke,values:Q,feature:J},ce){for(const be of Object.keys(J.tags)){let de=J.tags[be];if(de===null)continue;let Ae=ke.get(be);Ae===void 0&&(Ae=ke.size,ke.set(be,Ae)),ce.writeVarint(Ae);const $e=typeof de;$e!=="string"&&$e!=="boolean"&&$e!=="number"&&(de=JSON.stringify(de));let Re=Q.get(de);Re===void 0&&(Re=Q.size,Q.set(de,Re)),ce.writeVarint(Re)}}function Qe(ke,Q){return(Q<<3)+(7&ke)}function Gt(ke){return ke<<1^ke>>31}function ji(ke,Q){const{geometry:J,type:ce}=ke;let be=0,de=0;if(ce===1){Q.writeVarint(Qe(1,J.length));for(const Ae of J){const $e=Ae[0]-be,Re=Ae[1]-de;Q.writeVarint(Gt($e)),Q.writeVarint(Gt(Re)),be+=$e,de+=Re}}else for(const Ae of J){Q.writeVarint(Qe(1,1));const $e=Ae.length-(ce===3?1:0);for(let Re=0;Re<$e;Re++){Re===1&&Q.writeVarint(Qe(2,$e-1));const Ge=Ae[Re][0]-be,Ct=Ae[Re][1]-de;Q.writeVarint(Gt(Ge)),Q.writeVarint(Gt(Ct)),be+=Ge,de+=Ct}ce===3&&Q.writeVarint(Qe(7,1))}}function Un(ke,Q){const J=typeof ke;J==="string"?Q.writeStringField(1,ke):J==="boolean"?Q.writeBooleanField(7,ke):J==="number"&&(ke%1!=0?Q.writeDoubleField(3,ke):ke<0?Q.writeSVarintField(6,ke):Q.writeVarintField(5,ke))}const zn={minZoom:0,maxZoom:16,minPoints:2,radius:40,extent:512,nodeSize:64,log:!1,generateId:!1,reduce:null,map:ke=>ke},zi=Math.fround||(Ji=new Float32Array(1),ke=>(Ji[0]=+ke,Ji[0]));var Ji;const on=3,er=5,Pn=6;class ao{constructor(Q){this.options=Object.assign(Object.create(zn),Q),this.trees=new Array(this.options.maxZoom+1),this.stride=this.options.reduce?7:6,this.clusterProps=[]}load(Q){const{log:J,minZoom:ce,maxZoom:be}=this.options;J&&console.time("total time");const de=`prepare ${Q.length} points`;J&&console.time(de),this.points=Q;const Ae=[];for(let Re=0;Re<Q.length;Re++){const Ge=Q[Re];if(!Ge.geometry)continue;const[Ct,lt]=Ge.geometry.coordinates,ri=zi(Bs(Ct)),yi=zi(Ut(lt));Ae.push(ri,yi,1/0,Re,-1,1),this.options.reduce&&Ae.push(0)}let $e=this.trees[be+1]=this._createTree(Ae);J&&console.timeEnd(de);for(let Re=be;Re>=ce;Re--){const Ge=+Date.now();$e=this.trees[Re]=this._createTree(this._cluster($e,Re)),J&&console.log("z%d: %d clusters in %dms",Re,$e.numItems,+Date.now()-Ge)}return J&&console.timeEnd("total time"),this}getClusters(Q,J){let ce=((Q[0]+180)%360+360)%360-180;const be=Math.max(-90,Math.min(90,Q[1]));let de=Q[2]===180?180:((Q[2]+180)%360+360)%360-180;const Ae=Math.max(-90,Math.min(90,Q[3]));if(Q[2]-Q[0]>=360)ce=-180,de=180;else if(ce>de){const lt=this.getClusters([ce,be,180,Ae],J),ri=this.getClusters([-180,be,de,Ae],J);return lt.concat(ri)}const $e=this.trees[this._limitZoom(J)],Re=$e.range(Bs(ce),Ut(Ae),Bs(de),Ut(be)),Ge=$e.data,Ct=[];for(const lt of Re){const ri=this.stride*lt;Ct.push(Ge[ri+er]>1?Bo(Ge,ri,this.clusterProps):this.points[Ge[ri+on]])}return Ct}getChildren(Q){const J=this._getOriginId(Q),ce=this._getOriginZoom(Q),be="No cluster with the specified id.",de=this.trees[ce];if(!de)throw new Error(be);const Ae=de.data;if(J*this.stride>=Ae.length)throw new Error(be);const $e=this.options.radius/(this.options.extent*Math.pow(2,ce-1)),Re=de.within(Ae[J*this.stride],Ae[J*this.stride+1],$e),Ge=[];for(const Ct of Re){const lt=Ct*this.stride;Ae[lt+4]===Q&&Ge.push(Ae[lt+er]>1?Bo(Ae,lt,this.clusterProps):this.points[Ae[lt+on]])}if(Ge.length===0)throw new Error(be);return Ge}getLeaves(Q,J,ce){const be=[];return this._appendLeaves(be,Q,J=J||10,ce=ce||0,0),be}getTile(Q,J,ce){const be=this.trees[this._limitZoom(Q)],de=Math.pow(2,Q),{extent:Ae,radius:$e}=this.options,Re=$e/Ae,Ge=(ce-Re)/de,Ct=(ce+1+Re)/de,lt={features:[]};return this._addTileFeatures(be.range((J-Re)/de,Ge,(J+1+Re)/de,Ct),be.data,J,ce,de,lt),J===0&&this._addTileFeatures(be.range(1-Re/de,Ge,1,Ct),be.data,de,ce,de,lt),J===de-1&&this._addTileFeatures(be.range(0,Ge,Re/de,Ct),be.data,-1,ce,de,lt),lt.features.length?lt:null}getClusterExpansionZoom(Q){let J=this._getOriginZoom(Q)-1;for(;J<=this.options.maxZoom;){const ce=this.getChildren(Q);if(J++,ce.length!==1)break;Q=ce[0].properties.cluster_id}return J}_appendLeaves(Q,J,ce,be,de){const Ae=this.getChildren(J);for(const $e of Ae){const Re=$e.properties;if(Re&&Re.cluster?de+Re.point_count<=be?de+=Re.point_count:de=this._appendLeaves(Q,Re.cluster_id,ce,be,de):de<be?de++:Q.push($e),Q.length===ce)break}return de}_createTree(Q){const J=new s.c0(Q.length/this.stride|0,this.options.nodeSize,Float32Array);for(let ce=0;ce<Q.length;ce+=this.stride)J.add(Q[ce],Q[ce+1]);return J.finish(),J.data=Q,J}_addTileFeatures(Q,J,ce,be,de,Ae){for(const $e of Q){const Re=$e*this.stride,Ge=J[Re+er]>1;let Ct,lt,ri;if(Ge)Ct=Yo(J,Re,this.clusterProps),lt=J[Re],ri=J[Re+1];else{const Ki=this.points[J[Re+on]];Ct=Ki.properties;const[Vi,Yi]=Ki.geometry.coordinates;lt=Bs(Vi),ri=Ut(Yi)}const yi={type:1,geometry:[[Math.round(this.options.extent*(lt*de-ce)),Math.round(this.options.extent*(ri*de-be))]],tags:Ct};let Ri;Ri=Ge||this.options.generateId?J[Re+on]:this.points[J[Re+on]].id,Ri!==void 0&&(yi.id=Ri),Ae.features.push(yi)}}_limitZoom(Q){return Math.max(this.options.minZoom,Math.min(Math.floor(+Q),this.options.maxZoom+1))}_cluster(Q,J){const{radius:ce,extent:be,reduce:de,minPoints:Ae}=this.options,$e=ce/(be*Math.pow(2,J)),Re=Q.data,Ge=[],Ct=this.stride;for(let lt=0;lt<Re.length;lt+=Ct){if(Re[lt+2]<=J)continue;Re[lt+2]=J;const ri=Re[lt],yi=Re[lt+1],Ri=Q.within(Re[lt],Re[lt+1],$e),Ki=Re[lt+er];let Vi=Ki;for(const Yi of Ri){const Xn=Yi*Ct;Re[Xn+2]>J&&(Vi+=Re[Xn+er])}if(Vi>Ki&&Vi>=Ae){let Yi,Xn=ri*Ki,tn=yi*Ki,Nr=-1;const Fn=(lt/Ct<<5)+(J+1)+this.points.length;for(const ns of Ri){const jn=ns*Ct;if(Re[jn+2]<=J)continue;Re[jn+2]=J;const dn=Re[jn+er];Xn+=Re[jn]*dn,tn+=Re[jn+1]*dn,Re[jn+4]=Fn,de&&(Yi||(Yi=this._map(Re,lt,!0),Nr=this.clusterProps.length,this.clusterProps.push(Yi)),de(Yi,this._map(Re,jn)))}Re[lt+4]=Fn,Ge.push(Xn/Vi,tn/Vi,1/0,Fn,-1,Vi),de&&Ge.push(Nr)}else{for(let Yi=0;Yi<Ct;Yi++)Ge.push(Re[lt+Yi]);if(Vi>1)for(const Yi of Ri){const Xn=Yi*Ct;if(!(Re[Xn+2]<=J)){Re[Xn+2]=J;for(let tn=0;tn<Ct;tn++)Ge.push(Re[Xn+tn])}}}}return Ge}_getOriginId(Q){return Q-this.points.length>>5}_getOriginZoom(Q){return(Q-this.points.length)%32}_map(Q,J,ce){if(Q[J+er]>1){const Ae=this.clusterProps[Q[J+Pn]];return ce?Object.assign({},Ae):Ae}const be=this.points[Q[J+on]].properties,de=this.options.map(be);return ce&&de===be?Object.assign({},de):de}}function Bo(ke,Q,J){return{type:"Feature",id:ke[Q+on],properties:Yo(ke,Q,J),geometry:{type:"Point",coordinates:[(ce=ke[Q],360*(ce-.5)),Di(ke[Q+1])]}};var ce}function Yo(ke,Q,J){const ce=ke[Q+er],be=ce>=1e4?`${Math.round(ce/1e3)}k`:ce>=1e3?Math.round(ce/100)/10+"k":ce,de=ke[Q+Pn],Ae=de===-1?{}:Object.assign({},J[de]);return Object.assign(Ae,{cluster:!0,cluster_id:ke[Q+on],point_count:ce,point_count_abbreviated:be})}function Bs(ke){return ke/360+.5}function Ut(ke){const Q=Math.sin(ke*Math.PI/180),J=.5-.25*Math.log((1+Q)/(1-Q))/Math.PI;return J<0?0:J>1?1:J}function Di(ke){const Q=(180-360*ke)*Math.PI/180;return 360*Math.atan(Math.exp(Q))/Math.PI-90}function cn(ke,Q,J,ce){let be=ce;const de=Q+(J-Q>>1);let Ae,$e=J-Q;const Re=ke[Q],Ge=ke[Q+1],Ct=ke[J],lt=ke[J+1];for(let ri=Q+3;ri<J;ri+=3){const yi=wr(ke[ri],ke[ri+1],Re,Ge,Ct,lt);if(yi>be)Ae=ri,be=yi;else if(yi===be){const Ri=Math.abs(ri-de);Ri<$e&&(Ae=ri,$e=Ri)}}be>ce&&(Ae-Q>3&&cn(ke,Q,Ae,ce),ke[Ae+2]=be,J-Ae>3&&cn(ke,Ae,J,ce))}function wr(ke,Q,J,ce,be,de){let Ae=be-J,$e=de-ce;if(Ae!==0||$e!==0){const Re=((ke-J)*Ae+(Q-ce)*$e)/(Ae*Ae+$e*$e);Re>1?(J=be,ce=de):Re>0&&(J+=Ae*Re,ce+=$e*Re)}return Ae=ke-J,$e=Q-ce,Ae*Ae+$e*$e}function Zn(ke,Q,J,ce){const be={id:ke??null,type:Q,geometry:J,tags:ce,minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0};if(Q==="Point"||Q==="MultiPoint"||Q==="LineString")fr(be,J);else if(Q==="Polygon")fr(be,J[0]);else if(Q==="MultiLineString")for(const de of J)fr(be,de);else if(Q==="MultiPolygon")for(const de of J)fr(be,de[0]);return be}function fr(ke,Q){for(let J=0;J<Q.length;J+=3)ke.minX=Math.min(ke.minX,Q[J]),ke.minY=Math.min(ke.minY,Q[J+1]),ke.maxX=Math.max(ke.maxX,Q[J]),ke.maxY=Math.max(ke.maxY,Q[J+1])}function Rn(ke,Q,J,ce){if(!Q.geometry)return;const be=Q.geometry.coordinates;if(be&&be.length===0)return;const de=Q.geometry.type,Ae=Math.pow(J.tolerance/((1<<J.maxZoom)*J.extent),2);let $e=[],Re=Q.id;if(J.promoteId?Re=Q.properties[J.promoteId]:J.generateId&&(Re=ce||0),de==="Point")ar(be,$e);else if(de==="MultiPoint")for(const Ge of be)ar(Ge,$e);else if(de==="LineString")vs(be,$e,Ae,!1);else if(de==="MultiLineString"){if(J.lineMetrics){for(const Ge of be)$e=[],vs(Ge,$e,Ae,!1),ke.push(Zn(Re,"LineString",$e,Q.properties));return}Qo(be,$e,Ae,!1)}else if(de==="Polygon")Qo(be,$e,Ae,!0);else{if(de!=="MultiPolygon"){if(de==="GeometryCollection"){for(const Ge of Q.geometry.geometries)Rn(ke,{id:Re,geometry:Ge,properties:Q.properties},J,ce);return}throw new Error("Input data is not a valid GeoJSON object.")}for(const Ge of be){const Ct=[];Qo(Ge,Ct,Ae,!0),$e.push(Ct)}}ke.push(Zn(Re,de,$e,Q.properties))}function ar(ke,Q){Q.push(Fa(ke[0]),Sr(ke[1]),0)}function vs(ke,Q,J,ce){let be,de,Ae=0;for(let Re=0;Re<ke.length;Re++){const Ge=Fa(ke[Re][0]),Ct=Sr(ke[Re][1]);Q.push(Ge,Ct,0),Re>0&&(Ae+=ce?(be*Ct-Ge*de)/2:Math.sqrt(Math.pow(Ge-be,2)+Math.pow(Ct-de,2))),be=Ge,de=Ct}const $e=Q.length-3;Q[2]=1,cn(Q,0,$e,J),Q[$e+2]=1,Q.size=Math.abs(Ae),Q.start=0,Q.end=Q.size}function Qo(ke,Q,J,ce){for(let be=0;be<ke.length;be++){const de=[];vs(ke[be],de,J,ce),Q.push(de)}}function Fa(ke){return ke/360+.5}function Sr(ke){const Q=Math.sin(ke*Math.PI/180),J=.5-.25*Math.log((1+Q)/(1-Q))/Math.PI;return J<0?0:J>1?1:J}function Lr(ke,Q,J,ce,be,de,Ae,$e){if(ce/=Q,de>=(J/=Q)&&Ae<ce)return ke;if(Ae<J||de>=ce)return null;const Re=[];for(const Ge of ke){const Ct=Ge.geometry;let lt=Ge.type;const ri=be===0?Ge.minX:Ge.minY,yi=be===0?Ge.maxX:Ge.maxY;if(ri>=J&&yi<ce){Re.push(Ge);continue}if(yi<J||ri>=ce)continue;let Ri=[];if(lt==="Point"||lt==="MultiPoint")da(Ct,Ri,J,ce,be);else if(lt==="LineString")fa(Ct,Ri,J,ce,be,!1,$e.lineMetrics);else if(lt==="MultiLineString")xs(Ct,Ri,J,ce,be,!1);else if(lt==="Polygon")xs(Ct,Ri,J,ce,be,!0);else if(lt==="MultiPolygon")for(const Ki of Ct){const Vi=[];xs(Ki,Vi,J,ce,be,!0),Vi.length&&Ri.push(Vi)}if(Ri.length){if($e.lineMetrics&&lt==="LineString"){for(const Ki of Ri)Re.push(Zn(Ge.id,lt,Ki,Ge.tags));continue}lt!=="LineString"&&lt!=="MultiLineString"||(Ri.length===1?(lt="LineString",Ri=Ri[0]):lt="MultiLineString"),lt!=="Point"&&lt!=="MultiPoint"||(lt=Ri.length===3?"Point":"MultiPoint"),Re.push(Zn(Ge.id,lt,Ri,Ge.tags))}}return Re.length?Re:null}function da(ke,Q,J,ce,be){for(let de=0;de<ke.length;de+=3){const Ae=ke[de+be];Ae>=J&&Ae<=ce&&Xs(Q,ke[de],ke[de+1],ke[de+2])}}function fa(ke,Q,J,ce,be,de,Ae){let $e=pa(ke);const Re=be===0?Oa:ma;let Ge,Ct,lt=ke.start;for(let Vi=0;Vi<ke.length-3;Vi+=3){const Yi=ke[Vi],Xn=ke[Vi+1],tn=ke[Vi+2],Nr=ke[Vi+3],Fn=ke[Vi+4],ns=be===0?Yi:Xn,jn=be===0?Nr:Fn;let dn=!1;Ae&&(Ge=Math.sqrt(Math.pow(Yi-Nr,2)+Math.pow(Xn-Fn,2))),ns<J?jn>J&&(Ct=Re($e,Yi,Xn,Nr,Fn,J),Ae&&($e.start=lt+Ge*Ct)):ns>ce?jn<ce&&(Ct=Re($e,Yi,Xn,Nr,Fn,ce),Ae&&($e.start=lt+Ge*Ct)):Xs($e,Yi,Xn,tn),jn<J&&ns>=J&&(Ct=Re($e,Yi,Xn,Nr,Fn,J),dn=!0),jn>ce&&ns<=ce&&(Ct=Re($e,Yi,Xn,Nr,Fn,ce),dn=!0),!de&&dn&&(Ae&&($e.end=lt+Ge*Ct),Q.push($e),$e=pa(ke)),Ae&&(lt+=Ge)}let ri=ke.length-3;const yi=ke[ri],Ri=ke[ri+1],Ki=be===0?yi:Ri;Ki>=J&&Ki<=ce&&Xs($e,yi,Ri,ke[ri+2]),ri=$e.length-3,de&&ri>=3&&($e[ri]!==$e[0]||$e[ri+1]!==$e[1])&&Xs($e,$e[0],$e[1],$e[2]),$e.length&&Q.push($e)}function pa(ke){const Q=[];return Q.size=ke.size,Q.start=ke.start,Q.end=ke.end,Q}function xs(ke,Q,J,ce,be,de){for(const Ae of ke)fa(Ae,Q,J,ce,be,de,!1)}function Xs(ke,Q,J,ce){ke.push(Q,J,ce)}function Oa(ke,Q,J,ce,be,de){const Ae=(de-Q)/(ce-Q);return Xs(ke,de,J+(be-J)*Ae,1),Ae}function ma(ke,Q,J,ce,be,de){const Ae=(de-J)/(be-J);return Xs(ke,Q+(ce-Q)*Ae,de,1),Ae}function Ba(ke,Q){const J=[];for(let ce=0;ce<ke.length;ce++){const be=ke[ce],de=be.type;let Ae;if(de==="Point"||de==="MultiPoint"||de==="LineString")Ae=Na(be.geometry,Q);else if(de==="MultiLineString"||de==="Polygon"){Ae=[];for(const $e of be.geometry)Ae.push(Na($e,Q))}else if(de==="MultiPolygon"){Ae=[];for(const $e of be.geometry){const Re=[];for(const Ge of $e)Re.push(Na(Ge,Q));Ae.push(Re)}}J.push(Zn(be.id,de,Ae,be.tags))}return J}function Na(ke,Q){const J=[];J.size=ke.size,ke.start!==void 0&&(J.start=ke.start,J.end=ke.end);for(let ce=0;ce<ke.length;ce+=3)J.push(ke[ce]+Q,ke[ce+1],ke[ce+2]);return J}function Rl(ke,Q){if(ke.transformed)return ke;const J=1<<ke.z,ce=ke.x,be=ke.y;for(const de of ke.features){const Ae=de.geometry,$e=de.type;if(de.geometry=[],$e===1)for(let Re=0;Re<Ae.length;Re+=2)de.geometry.push(nr(Ae[Re],Ae[Re+1],Q,J,ce,be));else for(let Re=0;Re<Ae.length;Re++){const Ge=[];for(let Ct=0;Ct<Ae[Re].length;Ct+=2)Ge.push(nr(Ae[Re][Ct],Ae[Re][Ct+1],Q,J,ce,be));de.geometry.push(Ge)}}return ke.transformed=!0,ke}function nr(ke,Q,J,ce,be,de){return[Math.round(J*(ke*ce-be)),Math.round(J*(Q*ce-de))]}function Ml(ke,Q,J,ce,be){const de=Q===be.maxZoom?0:be.tolerance/((1<<Q)*be.extent),Ae={features:[],numPoints:0,numSimplified:0,numFeatures:ke.length,source:null,x:J,y:ce,z:Q,transformed:!1,minX:2,minY:1,maxX:-1,maxY:0};for(const $e of ke)Dl(Ae,$e,de,be);return Ae}function Dl(ke,Q,J,ce){const be=Q.geometry,de=Q.type,Ae=[];if(ke.minX=Math.min(ke.minX,Q.minX),ke.minY=Math.min(ke.minY,Q.minY),ke.maxX=Math.max(ke.maxX,Q.maxX),ke.maxY=Math.max(ke.maxY,Q.maxY),de==="Point"||de==="MultiPoint")for(let $e=0;$e<be.length;$e+=3)Ae.push(be[$e],be[$e+1]),ke.numPoints++,ke.numSimplified++;else if(de==="LineString")gs(Ae,be,ke,J,!1,!1);else if(de==="MultiLineString"||de==="Polygon")for(let $e=0;$e<be.length;$e++)gs(Ae,be[$e],ke,J,de==="Polygon",$e===0);else if(de==="MultiPolygon")for(let $e=0;$e<be.length;$e++){const Re=be[$e];for(let Ge=0;Ge<Re.length;Ge++)gs(Ae,Re[Ge],ke,J,!0,Ge===0)}if(Ae.length){let $e=Q.tags||null;if(de==="LineString"&&ce.lineMetrics){$e={};for(const Ge in Q.tags)$e[Ge]=Q.tags[Ge];$e.mapbox_clip_start=be.start/be.size,$e.mapbox_clip_end=be.end/be.size}const Re={geometry:Ae,type:de==="Polygon"||de==="MultiPolygon"?3:de==="LineString"||de==="MultiLineString"?2:1,tags:$e};Q.id!==null&&(Re.id=Q.id),ke.features.push(Re)}}function gs(ke,Q,J,ce,be,de){const Ae=ce*ce;if(ce>0&&Q.size<(be?Ae:ce))return void(J.numPoints+=Q.length/3);const $e=[];for(let Re=0;Re<Q.length;Re+=3)(ce===0||Q[Re+2]>Ae)&&(J.numSimplified++,$e.push(Q[Re],Q[Re+1])),J.numPoints++;be&&(function(Re,Ge){let Ct=0;for(let lt=0,ri=Re.length,yi=ri-2;lt<ri;yi=lt,lt+=2)Ct+=(Re[lt]-Re[yi])*(Re[lt+1]+Re[yi+1]);if(Ct>0===Ge)for(let lt=0,ri=Re.length;lt<ri/2;lt+=2){const yi=Re[lt],Ri=Re[lt+1];Re[lt]=Re[ri-2-lt],Re[lt+1]=Re[ri-1-lt],Re[ri-2-lt]=yi,Re[ri-1-lt]=Ri}})($e,de),ke.push($e)}const Jo={maxZoom:14,indexMaxZoom:5,indexMaxPoints:1e5,tolerance:3,extent:4096,buffer:64,lineMetrics:!1,promoteId:null,generateId:!1,debug:0};class Ac{constructor(Q,J){const ce=(J=this.options=(function(de,Ae){for(const $e in Ae)de[$e]=Ae[$e];return de})(Object.create(Jo),J)).debug;if(ce&&console.time("preprocess data"),J.maxZoom<0||J.maxZoom>24)throw new Error("maxZoom should be in the 0-24 range");if(J.promoteId&&J.generateId)throw new Error("promoteId and generateId cannot be used together.");let be=(function(de,Ae){const $e=[];if(de.type==="FeatureCollection")for(let Re=0;Re<de.features.length;Re++)Rn($e,de.features[Re],Ae,Re);else Rn($e,de.type==="Feature"?de:{geometry:de},Ae);return $e})(Q,J);this.tiles={},this.tileCoords=[],ce&&(console.timeEnd("preprocess data"),console.log("index: maxZoom: %d, maxPoints: %d",J.indexMaxZoom,J.indexMaxPoints),console.time("generate tiles"),this.stats={},this.total=0),be=(function(de,Ae){const $e=Ae.buffer/Ae.extent;let Re=de;const Ge=Lr(de,1,-1-$e,$e,0,-1,2,Ae),Ct=Lr(de,1,1-$e,2+$e,0,-1,2,Ae);return(Ge||Ct)&&(Re=Lr(de,1,-$e,1+$e,0,-1,2,Ae)||[],Ge&&(Re=Ba(Ge,1).concat(Re)),Ct&&(Re=Re.concat(Ba(Ct,-1)))),Re})(be,J),be.length&&this.splitTile(be,0,0,0),ce&&(be.length&&console.log("features: %d, points: %d",this.tiles[0].numFeatures,this.tiles[0].numPoints),console.timeEnd("generate tiles"),console.log("tiles generated:",this.total,JSON.stringify(this.stats)))}splitTile(Q,J,ce,be,de,Ae,$e){const Re=[Q,J,ce,be],Ge=this.options,Ct=Ge.debug;for(;Re.length;){be=Re.pop(),ce=Re.pop(),J=Re.pop(),Q=Re.pop();const lt=1<<J,ri=No(J,ce,be);let yi=this.tiles[ri];if(!yi&&(Ct>1&&console.time("creation"),yi=this.tiles[ri]=Ml(Q,J,ce,be,Ge),this.tileCoords.push({z:J,x:ce,y:be}),Ct)){Ct>1&&(console.log("tile z%d-%d-%d (features: %d, points: %d, simplified: %d)",J,ce,be,yi.numFeatures,yi.numPoints,yi.numSimplified),console.timeEnd("creation"));const dn=`z${J}`;this.stats[dn]=(this.stats[dn]||0)+1,this.total++}if(yi.source=Q,de==null){if(J===Ge.indexMaxZoom||yi.numPoints<=Ge.indexMaxPoints)continue}else{if(J===Ge.maxZoom||J===de)continue;if(de!=null){const dn=de-J;if(ce!==Ae>>dn||be!==$e>>dn)continue}}if(yi.source=null,Q.length===0)continue;Ct>1&&console.time("clipping");const Ri=.5*Ge.buffer/Ge.extent,Ki=.5-Ri,Vi=.5+Ri,Yi=1+Ri;let Xn=null,tn=null,Nr=null,Fn=null,ns=Lr(Q,lt,ce-Ri,ce+Vi,0,yi.minX,yi.maxX,Ge),jn=Lr(Q,lt,ce+Ki,ce+Yi,0,yi.minX,yi.maxX,Ge);Q=null,ns&&(Xn=Lr(ns,lt,be-Ri,be+Vi,1,yi.minY,yi.maxY,Ge),tn=Lr(ns,lt,be+Ki,be+Yi,1,yi.minY,yi.maxY,Ge),ns=null),jn&&(Nr=Lr(jn,lt,be-Ri,be+Vi,1,yi.minY,yi.maxY,Ge),Fn=Lr(jn,lt,be+Ki,be+Yi,1,yi.minY,yi.maxY,Ge),jn=null),Ct>1&&console.timeEnd("clipping"),Re.push(Xn||[],J+1,2*ce,2*be),Re.push(tn||[],J+1,2*ce,2*be+1),Re.push(Nr||[],J+1,2*ce+1,2*be),Re.push(Fn||[],J+1,2*ce+1,2*be+1)}}getTile(Q,J,ce){Q=+Q,J=+J,ce=+ce;const be=this.options,{extent:de,debug:Ae}=be;if(Q<0||Q>24)return null;const $e=1<<Q,Re=No(Q,J=J+$e&$e-1,ce);if(this.tiles[Re])return Rl(this.tiles[Re],de);Ae>1&&console.log("drilling down to z%d-%d-%d",Q,J,ce);let Ge,Ct=Q,lt=J,ri=ce;for(;!Ge&&Ct>0;)Ct--,lt>>=1,ri>>=1,Ge=this.tiles[No(Ct,lt,ri)];return Ge&&Ge.source?(Ae>1&&(console.log("found parent tile z%d-%d-%d",Ct,lt,ri),console.time("drilling down")),this.splitTile(Ge.source,Ct,lt,ri,Q,J,ce),Ae>1&&console.timeEnd("drilling down"),this.tiles[Re]?Rl(this.tiles[Re],de):null):null}}function No(ke,Q,J){return 32*((1<<ke)*J+Q)+ke}function gt(ke,Q){const J=ke.tileID.canonical;if(!this._geoJSONIndex)return void Q(null,null);const ce=this._geoJSONIndex.getTile(J.z,J.x,J.y);if(!ce)return void Q(null,null);const be=Ge=>Ge.tags&&"3d_elevation_id"in Ge.tags&&"source"in Ge.tags&&Ge.tags.source==="elevation",de=ce.features.filter((Ge=>be(Ge)));let Ae={_geojsonTileLayer:ce.features};de.length>0&&(Ae={_geojsonTileLayer:ce.features.filter((Ge=>!be(Ge))),hd_road_elevation:de});const $e=new rt(Ae),Re=(function(Ge){const Ct=new s.bq;for(const lt of Object.keys(Ge))Ct.writeMessage(3,wi,{name:lt,features:Ge[lt]});return Ct.finish()})(Ae).buffer;Q(null,{vectorTile:$e,rawData:Re})}class Vo extends wt{constructor(Q,J,ce,be,de,Ae,$e){super(Q,J,ce,be,de,gt,$e),Ae&&(this.loadGeoJSON=Ae),this._dynamicIndex=new Ke}loadData(Q,J){const ce=Q&&Q.request,be=ce&&ce.collectResourceTiming;this._geoJSONIndex=null,this.loadGeoJSON(Q,((de,Ae)=>{if(de||!Ae)return J(de);if(typeof Ae!="object")return J(new Error(`Input data given to '${Q.source}' is not a valid GeoJSON object.`));{try{if(Q.filter){const Re=s.X(Q.filter,{type:"boolean","property-type":"data-driven",overridable:!1,transition:!1});if(Re.result==="error")throw new Error(Re.value.map((Ge=>`${Ge.key}: ${Ge.message}`)).join(", "));Ae.features=Ae.features.filter((Ge=>Re.value.evaluate({zoom:0},Ge)))}Q.dynamic?(Ae.type==="Feature"&&(Ae={type:"FeatureCollection",features:[Ae]}),Q.append||(this._dynamicIndex.clear(),this.loaded={}),this._dynamicIndex.load(Ae.features,this.loaded),Q.cluster&&(Ae.features=this._dynamicIndex.getFeatures())):this.loaded={},this._geoJSONIndex=Q.cluster?new ao((function({superclusterOptions:Re,clusterProperties:Ge}){if(!Ge||!Re)return Re;const Ct={},lt={},ri={accumulated:null,zoom:0},yi={properties:null},Ri=Object.keys(Ge);for(const Ki of Ri){const[Vi,Yi]=Ge[Ki],Xn=s.X(Yi),tn=s.X(typeof Vi=="string"?[Vi,["accumulated"],["get",Ki]]:Vi);Ct[Ki]=Xn.value,lt[Ki]=tn.value}return Re.map=Ki=>{yi.properties=Ki;const Vi={};for(const Yi of Ri)Vi[Yi]=Ct[Yi].evaluate(ri,yi);return Vi},Re.reduce=(Ki,Vi)=>{yi.properties=Vi;for(const Yi of Ri)ri.accumulated=Ki[Yi],Ki[Yi]=lt[Yi].evaluate(ri,yi)},Re})(Q)).load(Ae.features):Q.dynamic?this._dynamicIndex:(function(Re,Ge){return new Ac(Re,Ge)})(Ae,Q.geojsonVtOptions)}catch(Re){return J(Re)}const $e={};if(be){const Re=ee(ce);Re&&($e.resourceTiming={},$e.resourceTiming[Q.source]=JSON.parse(JSON.stringify(Re)))}J(null,$e)}}))}reloadTile(Q,J){const ce=this.loaded;return ce&&ce[Q.uid]?Q.partial?J(null,void 0):super.reloadTile(Q,J):this.loadTile(Q,J)}loadGeoJSON(Q,J){if(Q.request)s.n(Q.request,J);else{if(typeof Q.data!="string")return J(new Error(`Input data given to '${Q.source}' is not a valid GeoJSON object.`));setTimeout((()=>{try{return J(null,JSON.parse(Q.data))}catch{return J(new Error(`Input data given to '${Q.source}' is not a valid GeoJSON object.`))}}),0)}}getClusterExpansionZoom(Q,J){try{J(null,this._geoJSONIndex.getClusterExpansionZoom(Q.clusterId))}catch(ce){J(ce)}}getClusterChildren(Q,J){try{J(null,this._geoJSONIndex.getChildren(Q.clusterId))}catch(ce){J(ce)}}getClusterLeaves(Q,J){try{J(null,this._geoJSONIndex.getLeaves(Q.clusterId,Q.limit,Q.offset))}catch(ce){J(ce)}}}class eu{constructor(Q,J,ce){this.tileID=new s.aM(Q.tileID.overscaledZ,Q.tileID.wrap,Q.tileID.canonical.z,Q.tileID.canonical.x,Q.tileID.canonical.y),this.tileZoom=Q.tileZoom,this.uid=Q.uid,this.zoom=Q.zoom,this.canonical=Q.tileID.canonical,this.pixelRatio=Q.pixelRatio,this.tileSize=Q.tileSize,this.source=Q.source,this.overscaling=this.tileID.overscaleFactor(),this.projection=Q.projection,this.brightness=J,this.worldview=ce}parse(Q,J,ce,be){this.status="parsing";const de=new s.aM(ce.tileID.overscaledZ,ce.tileID.wrap,ce.tileID.canonical.z,ce.tileID.canonical.x,ce.tileID.canonical.y),Ae=[],$e=J.familiesBySource[ce.source],Re=new s.fc(de,ce.promoteId);Re.bucketLayerIDs=[],Re.is3DTile=!0,s.fr(Q).then((Ge=>{if(!Ge)return be(new Error("Could not parse tile"));const Ct=Ge.json.extensionsUsed&&Ge.json.extensionsUsed.includes("MAPBOX_mesh_features")||Ge.json.asset.extras&&Ge.json.asset.extras.MAPBOX_mesh_features,lt=Ge.json.extensionsUsed&&Ge.json.extensionsUsed.includes("EXT_meshopt_compression"),ri=new s.aa(this.zoom,{brightness:this.brightness,worldview:this.worldview});for(const yi in $e)for(const Ri of $e[yi]){const Ki=Ri[0];Re.bucketLayerIDs.push(Ri.map((Xn=>s.C(Xn.id,Xn.scope)))),Ki.recalculate(ri,[]);const Vi=s.fs(Ge,1/s.d4(ce.tileID.canonical)),Yi=new s.ft(Ri,Vi,de,Ct,lt,this.brightness,Re,this.worldview);Ct||(Yi.needsUpload=!0),Ae.push(Yi),Yi.evaluate(Ki)}this.status="done",be(null,{buckets:Ae,featureIndex:Re,collisionBoxArray:null,glyphAtlasImage:null,lineAtlas:null,imageAtlas:null,brightness:null})})).catch((Ge=>be(new Error(Ge.message))))}}class _a{constructor(Q,J,ce,be,de,Ae,$e,Re){this.actor=Q,this.layerIndex=J,this.availableImages=ce,this.availableModels=be,this.brightness=$e,this.loading={},this.loaded={},this.worldview=Re}loadTile(Q,J){const ce=Q.uid,be=this.loading[ce]=new eu(Q,this.brightness,this.worldview);s.br(Q.request,((de,Ae)=>{const $e=!this.loading[ce];return delete this.loading[ce],$e||de?(be.status="done",$e||(this.loaded[ce]=be),J(de)):Ae&&Ae.byteLength!==0?void be.parse(Ae,this.layerIndex,Q,((Re,Ge)=>{be.status="done",this.loaded=this.loaded||{},this.loaded[ce]=be,Re||!Ge?J(Re):J(null,Ge)})):(be.status="done",this.loaded[ce]=be,J())}))}reloadTile(Q,J){const ce=this.loaded,be=Q.uid;if(ce&&ce[be]){const de=ce[be];de.projection=Q.projection,de.brightness=Q.brightness;const Ae=($e,Re)=>{de.reloadCallback&&(delete de.reloadCallback,this.loadTile(Q,J)),J($e,Re)};de.status==="parsing"?de.reloadCallback=Ae:de.status==="done"&&this.loadTile(Q,J)}}abortTile(Q,J){const ce=Q.uid;this.loading[ce]&&delete this.loading[ce],J()}removeTile(Q,J){const ce=this.loaded,be=Q.uid;ce&&ce[be]&&delete ce[be],J()}}class vn{constructor(Q){this.self=Q,this.actor=new s.fv(Q,this),this.layerIndexes={},this.availableImages={},this.availableModels={},this.isSpriteLoaded={},this.imageRasterizer=new s.y,this.rtlPluginParsingListeners=[],this.projections={},this.defaultProjection=s.cj({name:"mercator"}),this.workerSourceTypes={vector:wt,geojson:Vo,"raster-dem":Nt,"raster-array":Ei,"batched-model":_a},this.workerSources={},this.self.registerWorkerSource=(J,ce)=>{if(this.workerSourceTypes[J])throw new Error(`Worker source with name "${J}" already registered.`);this.workerSourceTypes[J]=ce},this.self.registerRTLTextPlugin=J=>{if(s.fw.isParsed())throw new Error("RTL text plugin already registered.");s.fw.setState({pluginStatus:s.fx.parsed,pluginURL:s.fw.getPluginURL()}),s.fw.applyArabicShaping=J.applyArabicShaping,s.fw.processBidirectionalText=J.processBidirectionalText,s.fw.processStyledBidirectionalText=J.processStyledBidirectionalText;for(const ce of this.rtlPluginParsingListeners)ce(null,!0);this.rtlPluginParsingListeners=[]}}clearCaches(Q,J,ce){delete this.layerIndexes[Q],delete this.availableImages[Q],delete this.availableModels[Q],delete this.workerSources[Q],ce()}checkIfReady(Q,J,ce){ce()}setReferrer(Q,J){this.referrer=J}spriteLoaded(Q,J){this.isSpriteLoaded[Q]||(this.isSpriteLoaded[Q]={});const{scope:ce,isLoaded:be}=J;if(this.isSpriteLoaded[Q][ce]=be,this.workerSources[Q]&&this.workerSources[Q][ce])for(const de in this.workerSources[Q][ce]){const Ae=this.workerSources[Q][ce][de];for(const $e in Ae){const Re=Ae[$e];Re instanceof wt&&(Re.isSpriteLoaded=be,Re.fire(new s.A("isSpriteLoaded")))}}}setImages(Q,J,ce){this.availableImages[Q]||(this.availableImages[Q]={});const{scope:be,images:de}=J;if(this.availableImages[Q][be]=de,this.workerSources[Q]&&this.workerSources[Q][be]){for(const Ae in this.workerSources[Q][be]){const $e=this.workerSources[Q][be][Ae];for(const Re in $e)$e[Re].availableImages=de}ce()}else ce()}setModels(Q,{scope:J,models:ce},be){if(this.availableModels[Q]||(this.availableModels[Q]={}),this.availableModels[Q][J]=ce,this.workerSources[Q]&&this.workerSources[Q][J]){for(const de in this.workerSources[Q][J]){const Ae=this.workerSources[Q][J][de];for(const $e in Ae)Ae[$e].availableModels=ce}be()}else be()}setProjection(Q,J){this.projections[Q]=s.cj(J)}setBrightness(Q,J,ce){this.brightness=J,ce()}setWorldview(Q,J,ce){this.worldview=J,ce()}setLayers(Q,J,ce){this.getLayerIndex(Q,J.scope).replace(J.layers,J.options),ce()}updateLayers(Q,J,ce){this.getLayerIndex(Q,J.scope).update(J.layers,J.removedIds,J.options),ce()}loadTile(Q,J,ce){J.projection=this.projections[Q]||this.defaultProjection,this.getWorkerSource(Q,J.type,J.source,J.scope).loadTile(J,ce)}decodeRasterArray(Q,J,ce){this.getWorkerSource(Q,J.type,J.source,J.scope).decodeRasterArray(J,ce)}reloadTile(Q,J,ce){J.projection=this.projections[Q]||this.defaultProjection,this.getWorkerSource(Q,J.type,J.source,J.scope).reloadTile(J,ce)}abortTile(Q,J,ce){this.getWorkerSource(Q,J.type,J.source,J.scope).abortTile(J,ce)}removeTile(Q,J,ce){this.getWorkerSource(Q,J.type,J.source,J.scope).removeTile(J,ce)}removeSource(Q,J,ce){if(!(this.workerSources[Q]&&this.workerSources[Q][J.scope]&&this.workerSources[Q][J.scope][J.type]&&this.workerSources[Q][J.scope][J.type][J.source]))return;const be=this.workerSources[Q][J.scope][J.type][J.source];delete this.workerSources[Q][J.scope][J.type][J.source],be.removeSource!==void 0?be.removeSource(J,ce):ce()}loadWorkerSource(Q,J,ce){try{this.self.importScripts(J.url),ce()}catch(be){ce(be.toString())}}syncRTLPluginState(Q,J,ce){if(s.fw.isParsed())ce(null,!0);else if(s.fw.isParsing())this.rtlPluginParsingListeners.push(ce);else try{s.fw.setState(J);const be=s.fw.getPluginURL();!s.fw.isLoaded()||s.fw.isParsed()||s.fw.isParsing()||be==null||(s.fw.setState({pluginStatus:s.fx.parsing,pluginURL:s.fw.getPluginURL()}),this.self.importScripts(be),s.fw.isParsed()?ce(null,!0):this.rtlPluginParsingListeners.push(ce))}catch(be){ce(be.toString())}}setDracoUrl(Q,J){this.dracoUrl=J}getAvailableImages(Q,J){this.availableImages[Q]||(this.availableImages[Q]={});let ce=this.availableImages[Q][J];return ce||(ce=[]),ce}getAvailableModels(Q,J){this.availableModels[Q]||(this.availableModels[Q]={});let ce=this.availableModels[Q][J];return ce||(ce={}),ce}getLayerIndex(Q,J){this.layerIndexes[Q]||(this.layerIndexes[Q]={});let ce=this.layerIndexes[Q][J];return ce||(ce=this.layerIndexes[Q][J]=new qe,ce.scope=J),ce}getWorkerSource(Q,J,ce,be){const de=this.workerSources;return de[Q]||(de[Q]={}),de[Q][be]||(de[Q][be]={}),de[Q][be][J]||(de[Q][be][J]={}),this.isSpriteLoaded[Q]||(this.isSpriteLoaded[Q]={}),de[Q][be][J][ce]||(de[Q][be][J][ce]=new this.workerSourceTypes[J]({send:(Ae,$e,Re,Ge,Ct,lt)=>this.actor.send(Ae,$e,Re,Q,Ct,lt),scheduler:this.actor.scheduler},this.getLayerIndex(Q,be),this.getAvailableImages(Q,be),this.getAvailableModels(Q,be),this.isSpriteLoaded[Q][be],void 0,this.brightness,this.worldview)),de[Q][be][J][ce]}rasterizeImagesWorker(Q,J,ce){const be=new Map;for(const[de,{image:Ae,imageVariant:$e}]of J.tasks.entries()){const Re=this.imageRasterizer.rasterize($e,Ae,J.scope,Q);be.set(de,Re)}ce(void 0,be)}removeRasterizedImages(Q,J,ce){this.imageRasterizer.removeImagesFromCacheByIds(J.imageIds,J.scope,Q),ce()}enforceCacheSizeLimit(Q,J){s.fy(J)}getWorkerPerformanceMetrics(Q,J,ce){ce(void 0,void 0)}}return s.fu(self)&&(self.worker=new vn(self)),vn})),z(["./shared"],(function(s){var ee="3.14.0";const ne={create:"create",load:"load",fullLoad:"fullLoad"},Ie={mark(l){performance.mark(l)},measure(l,t,r){performance.measure(l,t,r)}};function qe(l){const t=l.name.split("?")[0];return s.a(t)&&t.includes("mapbox-gl.js")?"javascript":s.a(t)&&t.includes("mapbox-gl.css")?"css":s.b(t)?"fontRange":s.c(t)?"sprite":s.i(t)?"style":s.d(t)?"tilejson":"other"}var Xe,St={},$t=(function(){if(Xe)return St;function l(c){return!t(c)}function t(c){return typeof window>"u"||typeof document>"u"?"not a browser":(function(){if(!("Worker"in window&&"Blob"in window&&"URL"in window))return!1;var _,v,b=new Blob([""],{type:"text/javascript"}),I=URL.createObjectURL(b);try{v=new Worker(I),_=!0}catch{_=!1}return v&&v.terminate(),URL.revokeObjectURL(I),_})()?(function(){var _=document.createElement("canvas");_.width=_.height=1;var v=_.getContext("2d");if(!v)return!1;var b=v.getImageData(0,0,1,1);return b&&b.width===_.width})()?(r[p=c&&c.failIfMajorPerformanceCaveat]===void 0&&(r[p]=(function(_){var v,b=(function(I){var M=document.createElement("canvas"),L=Object.create(l.webGLContextAttributes);return L.failIfMajorPerformanceCaveat=I,M.getContext("webgl2",L)})(_);if(!b)return!1;try{v=b.createShader(b.VERTEX_SHADER)}catch{return!1}return!(!v||b.isContextLost())&&(b.shaderSource(v,"void main() {}"),b.compileShader(v),b.getShaderParameter(v,b.COMPILE_STATUS)===!0)})(p)),r[p]?document.documentMode?"insufficient ECMAScript 6 support":void 0:"insufficient WebGL2 support"):"insufficient Canvas/getImageData support":"insufficient worker support";var p}Xe=1,St.supported=l,St.notSupportedReason=t;var r={};return l.webGLContextAttributes={antialias:!1,alpha:!0,stencil:!0,depth:!0},St})();function ct(l,t,r){const c=document.createElement(l);return t!=null&&(c.className=t),r&&r.appendChild(c),c}function wt(l,t,r){const c=document.createElementNS("http://www.w3.org/2000/svg",l);for(const p of Object.keys(t))c.setAttributeNS(null,p,String(t[p]));return r&&r.appendChild(c),c}const Nt=typeof document<"u"?document.documentElement&&document.documentElement.style:null,Ti=Nt&&Nt.userSelect!==void 0?"userSelect":"WebkitUserSelect";let Ei;function en(){Nt&&Ti&&(Ei=Nt[Ti],Nt[Ti]="none")}function Hn(){Nt&&Ti&&(Nt[Ti]=Ei)}function _n(l){l.preventDefault(),l.stopPropagation(),window.removeEventListener("click",_n,!0)}function rt(){window.addEventListener("click",_n,!0),window.setTimeout((()=>{window.removeEventListener("click",_n,!0)}),0)}function De(l,t){const r=l.getBoundingClientRect();return We(l,r,t)}function je(l,t){const r=l.getBoundingClientRect(),c=[];for(let p=0;p<t.length;p++)c.push(We(l,r,t[p]));return c}function Ke(l){return/firefox/i.test(navigator.userAgent)&&/macintosh/i.test(navigator.userAgent)&&l.button===2&&l.ctrlKey?0:l.button}function We(l,t,r){const c=l.offsetWidth===t.width?1:l.offsetWidth/t.width;return new s.P((r.clientX-t.left)*c,(r.clientY-t.top)*c)}const ut="01",Oe="NO_ACCESS_TOKEN";class kn{constructor(t,r,c){this._transformRequestFn=t,this._customAccessToken=r,this._silenceAuthErrors=!!c,this._createSkuToken()}_createSkuToken(){const t=(function(){let r="";for(let c=0;c<10;c++)r+="0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ"[Math.floor(62*Math.random())];return{token:["1",ut,r].join(""),tokenExpiresAt:Date.now()+432e5}})();this._skuToken=t.token,this._skuTokenExpiresAt=t.tokenExpiresAt}_isSkuTokenExpired(){return Date.now()>this._skuTokenExpiresAt}transformRequest(t,r){return this._transformRequestFn&&this._transformRequestFn(t,r)||{url:t}}normalizeStyleURL(t,r){if(!s.j(t))return t;const c=wn(t);return c.params.push(`sdk=js-${ee}`),c.path=`/styles/v1${c.path}`,this._makeAPIURL(c,this._customAccessToken||r)}normalizeGlyphsURL(t,r){if(!s.j(t))return t;const c=wn(t);return c.path=`/fonts/v1${c.path}`,this._makeAPIURL(c,this._customAccessToken||r)}normalizeModelURL(t,r){if(!s.j(t))return t;const c=wn(t);return c.path=`/models/v1${c.path}`,this._makeAPIURL(c,this._customAccessToken||r)}normalizeSourceURL(t,r,c,p){if(!s.j(t))return t;const _=wn(t);return _.path=`/v4/${_.authority}.json`,_.params.push("secure"),c&&_.params.push(`language=${c}`),p&&_.params.push(`worldview=${p}`),this._makeAPIURL(_,this._customAccessToken||r)}normalizeIconsetURL(t,r){const c=wn(t);return s.j(t)?(c.path=`/styles/v1${c.path}/iconset.pbf`,this._makeAPIURL(c,this._customAccessToken||r)):Gn(c)}normalizeSpriteURL(t,r,c,p){const _=wn(t);return s.j(t)?(_.path=`/styles/v1${_.path}/sprite${r}${c}`,this._makeAPIURL(_,this._customAccessToken||p)):(_.path+=`${r}${c}`,Gn(_))}normalizeTileURL(t,r,c){if(this._isSkuTokenExpired()&&this._createSkuToken(),t&&!s.j(t))return t;const p=wn(t);p.path=p.path.replace(/(\.(png|jpg)\d*)(?=$)/,`${r||c&&p.authority!=="raster"&&c===512?"@2x":""}${s.l.supported?".webp":"$1"}`),p.authority==="raster"?p.path=`/${s.e.RASTER_URL_PREFIX}${p.path}`:p.authority==="rasterarrays"?p.path=`/${s.e.RASTERARRAYS_URL_PREFIX}${p.path}`:p.authority==="3dtiles"?p.path=`/${s.e.TILES3D_URL_PREFIX}${p.path}`:(p.path=p.path.replace(/^.+\/v4\//,"/"),p.path=`/${s.e.TILE_URL_VERSION}${p.path}`);const _=this._customAccessToken||(function(v){for(const b of v){const I=b.match(/^access_token=(.*)$/);if(I)return I[1]}return null})(p.params)||s.e.ACCESS_TOKEN;return s.e.REQUIRE_ACCESS_TOKEN&&_&&this._skuToken&&p.params.push(`sku=${this._skuToken}`),this._makeAPIURL(p,_)}canonicalizeTileURL(t,r){const c=wn(t);if(!c.path.match(/^(\/v4\/|\/(raster|rasterarrays)\/v1\/)/)||!c.path.match(/\.[\w]+$/))return t;let p="mapbox://";c.path.match(/^\/raster\/v1\//)?p+=`raster/${c.path.replace(`/${s.e.RASTER_URL_PREFIX}/`,"")}`:c.path.match(/^\/rasterarrays\/v1\//)?p+=`rasterarrays/${c.path.replace(`/${s.e.RASTERARRAYS_URL_PREFIX}/`,"")}`:p+=`tiles/${c.path.replace(`/${s.e.TILE_URL_VERSION}/`,"")}`;let _=c.params;return r&&(_=_.filter((v=>!v.match(/^access_token=/)))),_.length&&(p+=`?${_.join("&")}`),p}canonicalizeTileset(t,r){const c=!!r&&s.j(r),p=[];for(const _ of t.tiles||[])s.k(_)?p.push(this.canonicalizeTileURL(_,c)):p.push(_);return p}_makeAPIURL(t,r){const c="See https://docs.mapbox.com/api/overview/#access-tokens-and-token-scopes",p=wn(s.e.API_URL);if(t.protocol=p.protocol,t.authority=p.authority,t.protocol==="http"){const _=t.params.indexOf("secure");_>=0&&t.params.splice(_,1)}if(p.path!=="/"&&(t.path=`${p.path}${t.path}`),!s.e.REQUIRE_ACCESS_TOKEN)return Gn(t);if(r=r||s.e.ACCESS_TOKEN,!this._silenceAuthErrors){if(!r)throw new Error(`An API access token is required to use Mapbox GL. ${c}`);if(r[0]==="s")throw new Error(`Use a public access token (pk.*) with Mapbox GL, not a secret access token (sk.*). ${c}`)}return t.params=t.params.filter((_=>_.indexOf("access_token")===-1)),t.params.push(`access_token=${r||""}`),Gn(t)}}const $n=/^(\w+):\/\/([^/?]*)(\/[^?]+)?\??(.+)?/;function wn(l){const t=l.match($n);if(!t)throw new Error("Unable to parse URL object");return{protocol:t[1],authority:t[2],path:t[3]||"/",params:t[4]?t[4].split("&"):[]}}function Gn(l){const t=l.params.length?`?${l.params.join("&")}`:"";return`${l.protocol}://${l.authority}${l.path}${t}`}const wi="mapbox.eventData";function Ui(l){if(!l)return null;const t=l.split(".");if(!t||t.length!==3)return null;try{return JSON.parse(s.m(t[1]))}catch{return null}}class Ai{constructor(t){this.type=t,this.anonId=null,this.eventData={},this.queue=[],this.pendingRequest=null}getStorageKey(t){const r=Ui(s.e.ACCESS_TOKEN);let c="";return c=r&&r.u?s.f(r.u):s.e.ACCESS_TOKEN||"",t?`${wi}.${t}:${c}`:`${wi}:${c}`}fetchEventData(){const t=s.s("localStorage"),r=this.getStorageKey(),c=this.getStorageKey("uuid");if(t)try{const p=localStorage.getItem(r);p&&(this.eventData=JSON.parse(p));const _=localStorage.getItem(c);_&&(this.anonId=_)}catch{s.w("Unable to read from LocalStorage")}}saveEventData(){const t=s.s("localStorage"),r=this.getStorageKey(),c=this.getStorageKey("uuid"),p=this.anonId;if(t&&p)try{localStorage.setItem(c,p),Object.keys(this.eventData).length>=1&&localStorage.setItem(r,JSON.stringify(this.eventData))}catch{s.w("Unable to write to LocalStorage")}}processRequests(t){}postEvent(t,r,c,p){if(!s.e.EVENTS_URL)return;const _=wn(s.e.EVENTS_URL);_.params.push(`access_token=${p||s.e.ACCESS_TOKEN||""}`);const v={event:this.type,created:new Date(t).toISOString()},b=r?s.h(v,r):v,I={url:Gn(_),headers:{"Content-Type":"text/plain"},body:JSON.stringify([b])};this.pendingRequest=s.p(I,(M=>{this.pendingRequest=null,c(M),this.saveEventData(),this.processRequests(p)}))}queueRequest(t,r){this.queue.push(t),this.processRequests(r)}}const Qe=new class extends Ai{constructor(l){super("appUserTurnstile"),this._customAccessToken=l}postTurnstileEvent(l,t){s.e.EVENTS_URL&&s.e.ACCESS_TOKEN&&Array.isArray(l)&&l.some((r=>s.j(r)||s.k(r)))&&this.queueRequest(Date.now(),t)}processRequests(l){if(this.pendingRequest||this.queue.length===0)return;this.anonId&&this.eventData.lastSuccess&&this.eventData.tokenU||this.fetchEventData();const t=Ui(s.e.ACCESS_TOKEN),r=t?t.u:s.e.ACCESS_TOKEN;let c=r!==this.eventData.tokenU;s.v(this.anonId)||(this.anonId=s.u(),c=!0);const p=this.queue.shift();if(this.eventData.lastSuccess){const _=new Date(this.eventData.lastSuccess),v=new Date(p),b=(p-this.eventData.lastSuccess)/864e5;c=c||b>=1||b<-1||_.getDate()!==v.getDate()}else c=!0;c?this.postEvent(p,{sdkIdentifier:"mapbox-gl-js",sdkVersion:ee,skuId:ut,"enabled.telemetry":!1,userId:this.anonId},(_=>{_||(this.eventData.lastSuccess=p,this.eventData.tokenU=r)}),l):this.processRequests()}},Gt=Qe.postTurnstileEvent.bind(Qe),ji=new class extends Ai{constructor(){super("map.load"),this.success={},this.skuToken=""}postMapLoadEvent(l,t,r,c){this.skuToken=t,this.errorCb=c,s.e.EVENTS_URL&&(r||s.e.ACCESS_TOKEN?this.queueRequest({id:l,timestamp:Date.now()},r):this.errorCb(new Error(Oe)))}processRequests(l){if(this.pendingRequest||this.queue.length===0)return;const{id:t,timestamp:r}=this.queue.shift();t&&this.success[t]||(this.anonId||this.fetchEventData(),s.v(this.anonId)||(this.anonId=s.u()),this.postEvent(r,{sdkIdentifier:"mapbox-gl-js",sdkVersion:ee,skuId:ut,skuToken:this.skuToken,userId:this.anonId},(c=>{c?this.errorCb(c):t&&(this.success[t]=!0)}),l))}remove(){this.errorCb=null}},Un=ji.postMapLoadEvent.bind(ji),zn=new class extends Ai{constructor(){super("style.load"),this.eventIdPerMapInstanceMap=new Map,this.mapInstanceIdMap=new WeakMap}getMapInstanceId(l){let t=this.mapInstanceIdMap.get(l);return t||(t=s.u(),this.mapInstanceIdMap.set(l,t)),t}getEventId(l){const t=this.eventIdPerMapInstanceMap.get(l)||0;return this.eventIdPerMapInstanceMap.set(l,t+1),t}postStyleLoadEvent(l,t){const{map:r,style:c,importedStyles:p}=t;if(!s.e.EVENTS_URL||!l&&!s.e.ACCESS_TOKEN)return;const _=this.getMapInstanceId(r),v={mapInstanceId:_,eventId:this.getEventId(_),style:c};p.length&&(v.importedStyles=p),this.queueRequest({timestamp:Date.now(),payload:v},l)}processRequests(l){if(this.pendingRequest||this.queue.length===0)return;const{timestamp:t,payload:r}=this.queue.shift();this.postEvent(t,r,(()=>{}),l)}},zi=zn.postStyleLoadEvent.bind(zn),Ji=new class extends Ai{constructor(){super("gljs.performance")}postPerformanceEvent(l,t){s.e.EVENTS_URL&&(l||s.e.ACCESS_TOKEN)&&this.queueRequest({timestamp:Date.now(),performanceData:t},l)}processRequests(l){if(this.pendingRequest||this.queue.length===0)return;const{timestamp:t,performanceData:r}=this.queue.shift(),c=(function(p){const _=performance.getEntriesByType("resource"),v=performance.getEntriesByType("mark"),b=(function(V){const $={};if(V){for(const H in V)if(H!=="other")for(const X of V[H]){const Z=`${H}ResolveRangeMin`,te=`${H}ResolveRangeMax`,oe=`${H}RequestCount`,le=`${H}RequestCachedCount`;$[Z]=Math.min($[Z]||1/0,X.startTime),$[te]=Math.max($[te]||-1/0,X.responseEnd);const pe=ye=>{$[ye]===void 0&&($[ye]=0),++$[ye]};X.transferSize!==void 0&&X.transferSize===0&&pe(le),pe(oe)}}return $})((function(V,$){const H={};if(V)for(const X of V){const Z=$(X);H[Z]===void 0&&(H[Z]=[]),H[Z].push(X)}return H})(_,qe)),I=window.devicePixelRatio,M=navigator.connection||navigator.mozConnection||navigator.webkitConnection,L=M?M.effectiveType:void 0,B={counters:[],metadata:[],attributes:[]},F=(V,$,H)=>{H!=null&&V.push({name:$,value:H.toString()})};for(const V in b)F(B.counters,V,b[V]);if(p.interactionRange[0]!==1/0&&p.interactionRange[1]!==-1/0&&(F(B.counters,"interactionRangeMin",p.interactionRange[0]),F(B.counters,"interactionRangeMax",p.interactionRange[1])),v)for(const V of Object.keys(ne)){const $=ne[V],H=v.find((X=>X.name===$));H&&F(B.counters,$,H.startTime)}return F(B.counters,"visibilityHidden",p.visibilityHidden),F(B.attributes,"style",(function(V){if(V)for(const $ of V){const H=$.name.split("?")[0];if(s.i(H)){const X=H.split("/").slice(-2);if(X.length===2)return`mapbox://styles/${X[0]}/${X[1]}`}}})(_)),F(B.attributes,"terrainEnabled",p.terrainEnabled?"true":"false"),F(B.attributes,"fogEnabled",p.fogEnabled?"true":"false"),F(B.attributes,"projection",p.projection),F(B.attributes,"zoom",p.zoom),F(B.metadata,"devicePixelRatio",I),F(B.metadata,"connectionEffectiveType",L),F(B.metadata,"navigatorUserAgent",navigator.userAgent),F(B.metadata,"screenWidth",window.screen.width),F(B.metadata,"screenHeight",window.screen.height),F(B.metadata,"windowWidth",window.innerWidth),F(B.metadata,"windowHeight",window.innerHeight),F(B.metadata,"mapWidth",p.width/I),F(B.metadata,"mapHeight",p.height/I),F(B.metadata,"webglRenderer",p.renderer),F(B.metadata,"webglVendor",p.vendor),F(B.metadata,"sdkVersion",ee),F(B.metadata,"sdkIdentifier","mapbox-gl-js"),B})(r);for(const p of c.metadata);for(const p of c.counters);for(const p of c.attributes);this.postEvent(t,c,(()=>{}),l)}},on=Ji.postPerformanceEvent.bind(Ji),er=new class extends Ai{constructor(){super("map.auth"),this.success={},this.skuToken=""}getSession(l,t,r,c){if(!s.e.API_URL||!s.e.SESSION_PATH)return;const p=wn(s.e.API_URL+s.e.SESSION_PATH);p.params.push(`sku=${t||""}`),p.params.push(`access_token=${c||s.e.ACCESS_TOKEN||""}`);const _={url:Gn(p),headers:{"Content-Type":"text/plain"}};this.pendingRequest=s.g(_,(v=>{this.pendingRequest=null,r(v),this.saveEventData(),this.processRequests(c)}))}getSessionAPI(l,t,r,c){this.skuToken=t,this.errorCb=c,s.e.SESSION_PATH&&s.e.API_URL&&(r||s.e.ACCESS_TOKEN?this.queueRequest({id:l,timestamp:Date.now()},r):this.errorCb(new Error(Oe)))}processRequests(l){if(this.pendingRequest||this.queue.length===0)return;const{id:t,timestamp:r}=this.queue.shift();t&&this.success[t]||this.getSession(r,this.skuToken,(c=>{c?this.errorCb(c):t&&(this.success[t]=!0)}),l)}remove(){this.errorCb=null}},Pn=er.getSessionAPI.bind(er),ao=new Set;function Bo(l,t){t?ao.add(l):ao.delete(l)}class Yo{constructor(){this._changed=!1,this._updatedLayers={},this._removedLayers={},this._updatedSourceCaches={},this._updatedPaintProps=new Set,this._updatedImages={}}isDirty(){return this._changed}setDirty(){this._changed=!0}getUpdatedSourceCaches(){return this._updatedSourceCaches}updateSourceCache(t,r){this._updatedSourceCaches[t]=r,this.setDirty()}discardSourceCacheUpdate(t){delete this._updatedSourceCaches[t]}updateLayer(t){const r=t.scope;this._updatedLayers[r]=this._updatedLayers[r]||new Set,this._updatedLayers[r].add(t.id),this.setDirty()}removeLayer(t){const r=t.scope;this._removedLayers[r]=this._removedLayers[r]||{},this._updatedLayers[r]=this._updatedLayers[r]||new Set,this._removedLayers[r][t.id]=t,this._updatedLayers[r].delete(t.id),this._updatedPaintProps.delete(t.fqid),this.setDirty()}getRemovedLayer(t){return this._removedLayers[t.scope]?this._removedLayers[t.scope][t.id]:null}discardLayerRemoval(t){this._removedLayers[t.scope]&&delete this._removedLayers[t.scope][t.id]}getLayerUpdatesByScope(){const t={};for(const r in this._updatedLayers)t[r]=t[r]||{},t[r].updatedIds=Array.from(this._updatedLayers[r].values());for(const r in this._removedLayers)t[r]=t[r]||{},t[r].removedIds=Object.keys(this._removedLayers[r]);return t}getUpdatedPaintProperties(){return this._updatedPaintProps}updatePaintProperties(t){this._updatedPaintProps.add(t.fqid),this.setDirty()}getUpdatedImages(t){return this._updatedImages[t]?Array.from(this._updatedImages[t].values()):[]}updateImage(t,r){this._updatedImages[r]=this._updatedImages[r]||new Set,this._updatedImages[r].add(s.I.toString(t)),this.setDirty()}resetUpdatedImages(t){this._updatedImages[t]&&this._updatedImages[t].clear()}reset(){this._changed=!1,this._updatedLayers={},this._removedLayers={},this._updatedSourceCaches={},this._updatedPaintProps.clear(),this._updatedImages={}}}function Bs(l){const{userImage:t}=l;return!!(t&&t.render&&t.render())&&(l.data.replace(new Uint8Array(t.data.buffer)),!0)}class Ut extends s.E{constructor(t){super(),this.imageProviders=new Map,this.images=new Map,this.updatedImages=new Map,this.callbackDispatchedThisFrame=new Map,this.loaded=new Map,this.requestors=[],this.patterns=new Map,this.patternsInFlight=new Set,this.atlasImage=new Map,this.atlasTexture=new Map,this.dirty=!0,this.spriteFormat=t,t!=="raster"&&s.t()&&(this.imageRasterizerDispatcher=new s.D(s.x(),this,"Image Rasterizer Worker",1))}addScope(t){this.loaded.set(t,!1),this.imageProviders.set(t,new Map),this.images.set(t,new Map),this.updatedImages.set(t,new Set),this.callbackDispatchedThisFrame.set(t,new Set),this.patterns.set(t,new Map),this.atlasImage.set(t,new s.r({width:1,height:1}))}removeScope(t){this.loaded.delete(t),this.imageProviders.delete(t),this.images.delete(t),this.updatedImages.delete(t),this.callbackDispatchedThisFrame.delete(t),this.patterns.delete(t),this.atlasImage.delete(t);const r=this.atlasTexture.get(t);r&&(r.destroy(),this.atlasTexture.delete(t))}addImageProvider(t,r){this.imageProviders.has(r)||this.imageProviders.set(r,new Map),this.imageProviders.get(r).set(t.id,t)}removeImageProvider(t,r){this.imageProviders.has(r)&&this.imageProviders.get(r).delete(t)}getPendingImageProviders(){const t=[];for(const r of this.imageProviders.values())for(const c of r.values())c.hasPendingRequests()&&t.push(c);return t}get imageRasterizer(){return this._imageRasterizer||(this._imageRasterizer=new s.y),this._imageRasterizer}isLoaded(){for(const t of this.loaded.keys())if(!this.loaded.get(t))return!1;return!0}setLoaded(t,r){if(this.loaded.get(r)!==t&&(this.loaded.set(r,t),t)){for(const{ids:c,callback:p}of this.requestors)this._notify(c,r,p);this.requestors=[]}}hasImage(t,r){return!!this.getImage(t,r)}getImage(t,r){return this.images.get(r).get(t.toString())}addImage(t,r,c){this._validate(t,c)&&this.images.get(r).set(t.toString(),c)}_validate(t,r){let c=!0;return this._validateStretch(r.stretchX,r.data&&r.data.width)||(this.fire(new s.z(new Error(`Image "${t.name}" has invalid "stretchX" value`))),c=!1),this._validateStretch(r.stretchY,r.data&&r.data.height)||(this.fire(new s.z(new Error(`Image "${t.name}" has invalid "stretchY" value`))),c=!1),this._validateContent(r.content,r)||(this.fire(new s.z(new Error(`Image "${t.name}" has invalid "content" value`))),c=!1),c}_validateStretch(t,r){if(!t)return!0;let c=0;for(const p of t){if(p[0]<c||p[1]<p[0]||r<p[1])return!1;c=p[1]}return!0}_validateContent(t,r){return t?t.length!==4||!r.usvg&&(t[0]<0||r.data.width<t[0]||t[1]<0||r.data.height<t[1]||t[2]<0||r.data.width<t[2]||t[3]<0||r.data.height<t[3])?!1:!(t[2]<t[0]||t[3]<t[1]):!0}updateImage(t,r,c){const p=this.images.get(r).get(t.toString());c.version=p.version+1,this.images.get(r).set(t.toString(),c),this.updatedImages.get(r).add(t),this.removeFromImageRasterizerCache(t,r)}clearUpdatedImages(t){this.updatedImages.get(t).clear()}removeFromImageRasterizerCache(t,r){this.spriteFormat!=="raster"&&(s.t()?this.imageRasterizerDispatcher.getActor().send("removeRasterizedImages",{imageIds:[t],scope:r}):this.imageRasterizer.removeImagesFromCacheByIds([t],r))}removeImage(t,r){const c=this.images.get(r),p=c.get(t.toString());c.delete(t.toString()),this.patterns.get(r).delete(t.toString()),this.removeFromImageRasterizerCache(t,r),p.userImage&&p.userImage.onRemove&&p.userImage.onRemove()}listImages(t){return Array.from(this.images.get(t).keys()).map((r=>s.I.from(r)))}getImages(t,r,c){const p=[],_=[],v=this.imageProviders.get(r);for(const L of t){if(!L.iconsetId){p.push(L);continue}const B=v.get(L.iconsetId);B&&(this.getImage(L,r)?_.push(L):B.addPendingRequest(L))}if(p.length===0)return void this._notify(_,r,c);let b=!0;const I=!!this.loaded.get(r),M=this.images.get(r);if(!I)for(const L of p)M.has(L.toString())||(b=!1);I||b?this._notify(p,r,c):this.requestors.push({ids:p,scope:r,callback:c})}rasterizeImages(t,r){const c=new Map,{tasks:p,scope:_}=t;for(const[v,b]of p.entries()){const I=this.getImage(b.id,_);I&&c.set(v,{image:I,imageVariant:b})}this._rasterizeImages(_,c,r)}_rasterizeImages(t,r,c){if(s.t())this.imageRasterizerDispatcher.getActor().send("rasterizeImagesWorker",{tasks:r,scope:t},c);else{const p=new Map;for(const[_,{image:v,imageVariant:b}]of r.entries())p.set(_,this.imageRasterizer.rasterize(b,v,t,0));c(void 0,p)}}getUpdatedImages(t){return this.updatedImages.get(t)||new Set}_notify(t,r,c){const p=this.images.get(r),_=new Map;for(const v of t){if(!p.get(v.toString())){if(v.iconsetId)continue;this.fire(new s.A("styleimagemissing",{id:v.name}))}const b=p.get(v.toString());if(!b){s.w(`Image "${v.name}" could not be loaded. Please make sure you have added the image with map.addImage() or a "sprite" property in your style. You can provide missing images by listening for the "styleimagemissing" map event.`);continue}const I={data:b.usvg?null:b.data.clone(),pixelRatio:b.pixelRatio,sdf:b.sdf,usvg:b.usvg,version:b.version,stretchX:b.stretchX,stretchY:b.stretchY,content:b.content,hasRenderCallback:!!(b.userImage&&b.userImage.render)};b.usvg&&Object.assign(I,{width:b.icon.usvg_tree.width,height:b.icon.usvg_tree.height}),_.set(s.I.toString(v),I)}c(null,_)}getPixelSize(t){const{width:r,height:c}=this.atlasImage.get(t);return{width:r,height:c}}getPattern(t,r,c){const p=t.toString(),_=this.patterns.get(r),v=_.get(p),b=this.getImage(t,r);if(!b)return null;if(v){if(v.position.version===b.version)return v.position;v.position.version=b.version}else{if(b.usvg&&!b.data){const I=this.getPatternInFlightId(p,r);if(this.patternsInFlight.has(I))return null;this.patternsInFlight.add(I);const M=new s.B(t).scaleSelf(s.q.devicePixelRatio),L=new Map([[M.toString(),{image:b,imageVariant:M}]]);return this._rasterizeImages(r,L,((B,F)=>this.storePatternImage(M,r,b,c,F))),null}this.storePattern(t,r,b)}return this._updatePatternAtlas(r,c),_.get(p).position}getPatternInFlightId(t,r){return s.C(t,r)}hasPatternsInFlight(){return this.patternsInFlight.size!==0}storePatternImage(t,r,c,p,_){const v=t.toString(),b=_?_.get(v):void 0;b&&(c.data=b,this.storePattern(t.id,r,c),this._updatePatternAtlas(r,p),this.patternsInFlight.delete(this.getPatternInFlightId(t.id.toString(),r)))}storePattern(t,r,c){const p={w:c.data.width+2*s.F,h:c.data.height+2*s.F,x:0,y:0},_=new s.G(p,c,s.F);this.patterns.get(r).set(t.toString(),{bin:p,position:_})}destroyAtlasTextures(){for(const t of this.atlasTexture.values())t&&t.destroy();this.atlasTexture.clear()}bind(t,r){const c=t.gl;let p=this.atlasTexture.get(r);p?this.dirty&&(p.update(this.atlasImage.get(r)),this.dirty=!1):(p=new s.T(t,this.atlasImage.get(r),c.RGBA8),this.atlasTexture.set(r,p)),p.bind(c.LINEAR,c.CLAMP_TO_EDGE)}_updatePatternAtlas(t,r){const c=this.patterns.get(t),p=Array.from(c.values()).map((({bin:M})=>M)),{w:_,h:v}=s.H(p),b=this.atlasImage.get(t);b.resize({width:_||1,height:v||1});const I=this.images.get(t);for(const[M,{bin:L,position:B}]of c.entries()){let F=B.padding;const V=L.x+F,$=L.y+F,H=I.get(M).data,X=H.width,Z=H.height;F=F>1?F-1:F,s.r.copy(H,b,{x:0,y:0},{x:V,y:$},{width:X,height:Z},r),s.r.copy(H,b,{x:0,y:Z-F},{x:V,y:$-F},{width:X,height:F},r),s.r.copy(H,b,{x:0,y:0},{x:V,y:$+Z},{width:X,height:F},r),s.r.copy(H,b,{x:X-F,y:0},{x:V-F,y:$},{width:F,height:Z},r),s.r.copy(H,b,{x:0,y:0},{x:V+X,y:$},{width:F,height:Z},r),s.r.copy(H,b,{x:X-F,y:Z-F},{x:V-F,y:$-F},{width:F,height:F},r),s.r.copy(H,b,{x:0,y:Z-F},{x:V+X,y:$-F},{width:F,height:F},r),s.r.copy(H,b,{x:0,y:0},{x:V+X,y:$+Z},{width:F,height:F},r),s.r.copy(H,b,{x:X-F,y:0},{x:V-F,y:$+Z},{width:F,height:F},r)}this.dirty=!0}beginFrame(){for(const t of this.images.keys())this.callbackDispatchedThisFrame.set(t,new Set)}dispatchRenderCallbacks(t,r){const c=this.images.get(r);for(const p of t){if(this.callbackDispatchedThisFrame.get(r).has(p.toString()))continue;this.callbackDispatchedThisFrame.get(r).add(p.toString());const _=c.get(p.toString());Bs(_)&&this.updateImage(p,r,_)}}destroy(){this.imageRasterizerDispatcher&&this.imageRasterizerDispatcher.remove()}}function Di(l){const t=l.key,r=l.value,c=l.valueSpec||{},p=l.objectElementValidators||{},_=l.style,v=l.styleSpec;let b=[];const I=s.J(r);if(I!=="object")return[new s.V(t,r,`object expected, ${I} found`)];for(const M in r){const L=M.split(".")[0];let B;p[L]?B=p[L]:c[L]?B=nr:p["*"]?B=p["*"]:c["*"]&&(B=nr),B?b=b.concat(B({key:(t&&`${t}.`)+M,value:r[M],valueSpec:c[L]||c["*"],style:_,styleSpec:v,object:r,objectKey:M},r)):b.push(new s.K(t,r[M],`unknown property "${M}"`))}for(const M in c)p[M]||c[M].required&&c[M].default===void 0&&r[M]===void 0&&b.push(new s.V(t,r,`missing required property "${M}"`));return b}function cn(l){const t=l.value,r=l.valueSpec,c=l.style,p=l.styleSpec,_=l.key,v=l.arrayElementValidator||nr;if(s.J(t)!=="array")return[new s.V(_,t,`array expected, ${s.J(t)} found`)];if(r.length&&t.length!==r.length)return[new s.V(_,t,`array length ${r.length} expected, length ${t.length} found`)];if(r["min-length"]&&t.length<r["min-length"])return[new s.V(_,t,`array length at least ${r["min-length"]} expected, length ${t.length} found`)];let b={type:r.value,values:r.values,minimum:r.minimum,maximum:r.maximum,function:void 0};p.$version<7&&(b.function=r.function),s.J(r.value)==="object"&&(b=r.value);let I=[];for(let M=0;M<t.length;M++)I=I.concat(v({array:t,arrayIndex:M,value:t[M],valueSpec:b,style:c,styleSpec:p,key:`${_}[${M}]`},!0));return I}function wr(l){const t=l.key,r=l.value,c=l.valueSpec;let p=s.J(r);if(p==="number"&&r!=r&&(p="NaN"),p!=="number")return[new s.V(t,r,`number expected, ${p} found`)];if("minimum"in c){let _=c.minimum;if(s.J(c.minimum)==="array"&&(_=c.minimum[l.arrayIndex]),r<_)return[new s.V(t,r,`${r} is less than the minimum value ${_}`)]}if("maximum"in c){let _=c.maximum;if(s.J(c.maximum)==="array"&&(_=c.maximum[l.arrayIndex]),r>_)return[new s.V(t,r,`${r} is greater than the maximum value ${_}`)]}return[]}function Zn(l){const t=l.valueSpec,r=s.M(l.value.type);let c,p,_,v={};const b=r!=="categorical"&&l.value.property===void 0,I=!b,M=s.J(l.value.stops)==="array"&&s.J(l.value.stops[0])==="array"&&s.J(l.value.stops[0][0])==="object",L=Di({key:l.key,value:l.value,valueSpec:l.styleSpec.function,style:l.style,styleSpec:l.styleSpec,objectElementValidators:{stops:function(V){if(r==="identity")return[new s.V(V.key,V.value,'identity function may not have a "stops" property')];let $=[];const H=V.value;return $=$.concat(cn({key:V.key,value:H,valueSpec:V.valueSpec,style:V.style,styleSpec:V.styleSpec,arrayElementValidator:B})),s.J(H)==="array"&&H.length===0&&$.push(new s.V(V.key,H,"array must have at least one stop")),$},default:function(V){return nr({key:V.key,value:V.value,valueSpec:t,style:V.style,styleSpec:V.styleSpec})}}});return r==="identity"&&b&&L.push(new s.V(l.key,l.value,'missing required property "property"')),r==="identity"||l.value.stops||L.push(new s.V(l.key,l.value,'missing required property "stops"')),r==="exponential"&&l.valueSpec.expression&&!s.N(l.valueSpec)&&L.push(new s.V(l.key,l.value,"exponential functions not supported")),l.styleSpec.$version>=8&&(I&&!s.O(l.valueSpec)?L.push(new s.V(l.key,l.value,"property functions not supported")):b&&!s.Q(l.valueSpec)&&L.push(new s.V(l.key,l.value,"zoom functions not supported"))),r!=="categorical"&&!M||l.value.property!==void 0||L.push(new s.V(l.key,l.value,'"property" property is required')),L;function B(V){let $=[];const H=V.value,X=V.key;if(s.J(H)!=="array")return[new s.V(X,H,`array expected, ${s.J(H)} found`)];if(H.length!==2)return[new s.V(X,H,`array length 2 expected, length ${H.length} found`)];if(M){if(s.J(H[0])!=="object")return[new s.V(X,H,`object expected, ${s.J(H[0])} found`)];if(H[0].zoom===void 0)return[new s.V(X,H,"object stop key must have zoom")];if(H[0].value===void 0)return[new s.V(X,H,"object stop key must have value")];const Z=s.M(H[0].zoom);if(typeof Z!="number")return[new s.V(X,H[0].zoom,"stop zoom values must be numbers")];if(_&&_>Z)return[new s.V(X,H[0].zoom,"stop zoom values must appear in ascending order")];Z!==_&&(_=Z,p=void 0,v={}),$=$.concat(Di({key:`${X}[0]`,value:H[0],valueSpec:{zoom:{}},style:V.style,styleSpec:V.styleSpec,objectElementValidators:{zoom:wr,value:F}}))}else $=$.concat(F({key:`${X}[0]`,value:H[0],style:V.style,styleSpec:V.styleSpec},H));return s.S(s.U(H[1]))?$.concat([new s.V(`${X}[1]`,H[1],"expressions are not allowed in function stops.")]):$.concat(nr({key:`${X}[1]`,value:H[1],valueSpec:t,style:V.style,styleSpec:V.styleSpec}))}function F(V,$){const H=s.J(V.value),X=s.M(V.value),Z=V.value!==null?V.value:$;if(c){if(H!==c)return[new s.V(V.key,Z,`${H} stop domain type must match previous stop domain type ${c}`)]}else c=H;if(H!=="number"&&H!=="string"&&H!=="boolean"&&typeof X!="number"&&typeof X!="string"&&typeof X!="boolean")return[new s.V(V.key,Z,"stop domain value must be a number, string, or boolean")];if(H!=="number"&&r!=="categorical"){let te=`number expected, ${H} found`;return s.O(t)&&r===void 0&&(te+='\nIf you intended to use a categorical function, specify `"type": "categorical"`.'),[new s.V(V.key,Z,te)]}return r!=="categorical"||H!=="number"||typeof X=="number"&&isFinite(X)&&Math.floor(X)===X?r!=="categorical"&&H==="number"&&typeof X=="number"&&typeof p=="number"&&p!==void 0&&X<p?[new s.V(V.key,Z,"stop domain values must appear in ascending order")]:(p=X,r==="categorical"&&X in v?[new s.V(V.key,Z,"stop domain values must be unique")]:(v[X]=!0,[])):[new s.V(V.key,Z,`integer expected, found ${String(X)}`)]}}function fr(l){const t=(l.expressionContext==="property"?s.W:s.X)(s.U(l.value),l.valueSpec);if(t.result==="error")return t.value.map((c=>new s.V(`${l.key}${c.key}`,l.value,c.message)));const r=t.value.expression||t.value._styleExpression.expression;if(l.expressionContext==="property"&&l.propertyKey==="text-font"&&!r.outputDefined())return[new s.V(l.key,l.value,`Invalid data expression for "${l.propertyKey}". Output values must be contained as literals within the expression.`)];if(l.expressionContext==="property"&&l.propertyType==="layout"&&!s.Y(r))return[new s.V(l.key,l.value,'"feature-state" data expressions are not supported with layout properties.')];if(l.expressionContext==="filter")return Rn(r,l);if(l.expressionContext&&l.expressionContext.indexOf("cluster")===0){if(!s.Z(r,["zoom","feature-state"]))return[new s.V(l.key,l.value,'"zoom" and "feature-state" expressions are not supported with cluster properties.')];if(l.expressionContext==="cluster-initial"&&!s._(r))return[new s.V(l.key,l.value,"Feature data expressions are not supported with initial expression part of cluster properties.")]}return[]}function Rn(l,t){const r=new Set(["zoom","feature-state","pitch","distance-from-center"]);if(t.valueSpec&&t.valueSpec.expression)for(const p of t.valueSpec.expression.parameters)r.delete(p);if(r.size===0)return[];const c=[];return l instanceof s.$&&r.has(l.name)?[new s.V(t.key,t.value,`["${l.name}"] expression is not supported in a filter for a ${t.object.type} layer with id: ${t.object.id}`)]:(l.eachChild((p=>{c.push(...Rn(p,t))})),c)}function ar(l){const t=l.key,r=l.value,c=l.valueSpec,p=[];return Array.isArray(c.values)?c.values.indexOf(s.M(r))===-1&&p.push(new s.V(t,r,`expected one of [${c.values.join(", ")}], ${JSON.stringify(r)} found`)):Object.keys(c.values).indexOf(s.M(r))===-1&&p.push(new s.V(t,r,`expected one of [${Object.keys(c.values).join(", ")}], ${JSON.stringify(r)} found`)),p}function vs(l){return s.a1(s.U(l.value))?fr(s.L({},l,{expressionContext:"filter",valueSpec:l.styleSpec[`filter_${l.layerType||"fill"}`]})):Qo(l)}function Qo(l){const t=l.value,r=l.key;if(s.J(t)!=="array")return[new s.V(r,t,`array expected, ${s.J(t)} found`)];const c=l.styleSpec;let p,_=[];if(t.length<1)return[new s.V(r,t,"filter array must have at least 1 element")];switch(_=_.concat(ar({key:`${r}[0]`,value:t[0],valueSpec:c.filter_operator,style:l.style,styleSpec:l.styleSpec})),s.M(t[0])){case"<":case"<=":case">":case">=":t.length>=2&&s.M(t[1])==="$type"&&_.push(new s.V(r,t,`"$type" cannot be use with operator "${t[0]}"`));case"==":case"!=":t.length!==3&&_.push(new s.V(r,t,`filter array for operator "${t[0]}" must have 3 elements`));case"in":case"!in":t.length>=2&&(p=s.J(t[1]),p!=="string"&&_.push(new s.V(`${r}[1]`,t[1],`string expected, ${p} found`)));for(let v=2;v<t.length;v++)p=s.J(t[v]),s.M(t[1])==="$type"?_=_.concat(ar({key:`${r}[${v}]`,value:t[v],valueSpec:c.geometry_type,style:l.style,styleSpec:l.styleSpec})):p!=="string"&&p!=="number"&&p!=="boolean"&&_.push(new s.V(`${r}[${v}]`,t[v],`string, number, or boolean expected, ${p} found`));break;case"any":case"all":case"none":for(let v=1;v<t.length;v++)_=_.concat(Qo({key:`${r}[${v}]`,value:t[v],style:l.style,styleSpec:l.styleSpec}));break;case"has":case"!has":p=s.J(t[1]),t.length!==2?_.push(new s.V(r,t,`filter array for "${t[0]}" operator must have 2 elements`)):p!=="string"&&_.push(new s.V(`${r}[1]`,t[1],`string expected, ${p} found`))}return _}function Fa(l,t){const r=l.key,c=l.style,p=l.layer,_=l.styleSpec,v=l.value,b=l.objectKey,I=_[`${t}_${l.layerType}`];if(!I)return[];const M=b.match(/^(.*)-use-theme$/);if(t==="paint"&&M&&I[M[1]])return s.S(v)?[].concat(nr({key:l.key,value:v,valueSpec:{type:"string",expression:{interpolated:!1,parameters:["zoom","feature"]},"property-type":"data-driven"},style:c,styleSpec:_,expressionContext:"property",propertyType:t,propertyKey:b})):nr({key:r,value:v,valueSpec:{type:"string"},style:c,styleSpec:_});const L=b.match(/^(.*)-transition$/);if(t==="paint"&&L&&I[L[1]]&&I[L[1]].transition)return nr({key:r,value:v,valueSpec:_.transition,style:c,styleSpec:_});const B=l.valueSpec||I[b];if(!B)return[new s.K(r,v,`unknown property "${b}"`)];let F;if(s.J(v)==="string"&&s.O(B)&&!B.tokens&&(F=/^{([^}]+)}$/.exec(v))){const $=`\`{ "type": "identity", "property": ${F?JSON.stringify(F[1]):'"_"'} }\``;return[new s.V(r,v,`"${b}" does not support interpolation syntax
Use an identity property function instead: ${$}.`)]}const V=[];if(l.layerType==="symbol")b!=="text-field"||!c||c.glyphs||c.imports||V.push(new s.V(r,v,'use of "text-field" requires a style "glyphs" property')),b==="text-font"&&s.a2(s.U(v))&&s.M(v.type)==="identity"&&V.push(new s.V(r,v,'"text-font" does not support identity functions'));else if(l.layerType==="model"&&t==="paint"&&p&&p.layout&&p.layout.hasOwnProperty("model-id")&&s.O(B)&&(s.a3(B)||s.Q(B))){const $=s.W(s.U(v),B),H=$.value.expression||$.value._styleExpression.expression;H&&!s.Z(H,["measure-light"])&&(b==="model-emissive-strength"&&s._(H)&&s.Y(H)||V.push(new s.V(r,v,`${b} does not support measure-light expressions when the model layer source is vector tile or GeoJSON.`)))}return V.concat(nr({key:l.key,value:v,valueSpec:B,style:c,styleSpec:_,expressionContext:"property",propertyType:t,propertyKey:b}))}function Sr(l){return Fa(l,"paint")}function Lr(l){return Fa(l,"layout")}function da(l){let t=[];const r=l.value,c=l.key,p=l.style,_=l.styleSpec;r.type||r.ref||t.push(new s.V(c,r,'either "type" or "ref" is required'));let v=s.M(r.type);const b=s.M(r.ref);if(r.id){const I=s.M(r.id);for(let M=0;M<l.arrayIndex;M++){const L=p.layers[M];s.M(L.id)===I&&t.push(new s.V(c,r.id,`duplicate layer id "${r.id}", previously used at line ${L.id.__line__}`))}}if("ref"in r){let I;["type","source","source-layer","filter","layout"].forEach((M=>{M in r&&t.push(new s.V(c,r[M],`"${M}" is prohibited for ref layers`))})),p.layers.forEach((M=>{s.M(M.id)===b&&(I=M)})),I?I.ref?t.push(new s.V(c,r.ref,"ref cannot reference another ref layer")):v=s.M(I.type):typeof b=="string"&&t.push(new s.V(c,r.ref,`ref layer "${b}" not found`))}else if(v!=="background"&&v!=="sky"&&v!=="slot")if(r.source){const I=p.sources&&p.sources[r.source],M=I&&s.M(I.type);I?M==="vector"&&v==="raster"?t.push(new s.V(c,r.source,`layer "${r.id}" requires a raster source`)):M==="raster"&&v!=="raster"?t.push(new s.V(c,r.source,`layer "${r.id}" requires a vector source`)):M!=="vector"||r["source-layer"]?M==="raster-dem"&&v!=="hillshade"?t.push(new s.V(c,r.source,"raster-dem source can only be used with layer type 'hillshade'.")):M!=="raster-array"||["raster","raster-particle"].includes(v)?v==="line"&&r.paint&&(r.paint["line-gradient"]||r.paint["line-trim-offset"])&&M==="geojson"&&!I.lineMetrics?t.push(new s.V(c,r,`layer "${r.id}" specifies a line-gradient, which requires the GeoJSON source to have \`lineMetrics\` enabled.`)):v==="raster-particle"&&M!=="raster-array"&&t.push(new s.V(c,r.source,`layer "${r.id}" requires a 'raster-array' source.`)):t.push(new s.V(c,r.source,"raster-array source can only be used with layer type 'raster'.")):t.push(new s.V(c,r,`layer "${r.id}" must specify a "source-layer"`)):t.push(new s.V(c,r.source,`source "${r.source}" not found`))}else t.push(new s.V(c,r,'missing required property "source"'));return t=t.concat(Di({key:c,value:r,valueSpec:_.layer,style:l.style,styleSpec:l.styleSpec,objectElementValidators:{"*":()=>[],type:()=>nr({key:`${c}.type`,value:r.type,valueSpec:_.layer.type,style:l.style,styleSpec:l.styleSpec,object:r,objectKey:"type"}),filter:I=>vs(s.L({layerType:v},I)),layout:I=>Di({layer:r,key:I.key,value:I.value,valueSpec:{},style:I.style,styleSpec:I.styleSpec,objectElementValidators:{"*":M=>Lr(s.L({layerType:v},M))}}),paint:I=>Di({layer:r,key:I.key,value:I.value,valueSpec:{},style:I.style,styleSpec:I.styleSpec,objectElementValidators:{"*":M=>Sr(s.L({layerType:v,layer:r},M))}})}})),t}function fa(l){const t=l.value,r=l.key,c=s.J(t);return c!=="string"?[new s.V(r,t,`string expected, ${c} found`)]:[]}const pa={promoteId:function l({key:t,value:r}){if(s.J(r)==="string")return fa({key:t,value:r});if(Array.isArray(r)){const c=[],p=s.U(r),_=s.X(p);return _.result==="error"&&_.value.forEach((v=>{c.push(new s.V(`${t}${v.key}`,null,`${v.message}`))})),s.Z(_.value.expression,["zoom","heatmap-density","line-progress","raster-value","sky-radial-progress","accumulated","is-supported-script","pitch","distance-from-center","measure-light","raster-particle-speed"])||c.push(new s.V(`${t}`,null,"promoteId expression should be only feature dependent")),c}{const c=[];for(const p in r)c.push(...l({key:`${t}.${p}`,value:r[p]}));return c}}};function xs(l){const t=l.value,r=l.key,c=l.styleSpec,p=l.style;if(!t.type)return[new s.V(r,t,'"type" is required')];const _=s.M(t.type);let v=[];switch(["vector","raster","raster-dem","raster-array"].includes(_)&&(t.url||t.tiles||v.push(new s.K(r,t,'Either "url" or "tiles" is required.'))),_){case"vector":case"raster":case"raster-dem":case"raster-array":return v=v.concat(Di({key:r,value:t,valueSpec:c[`source_${_.replace("-","_")}`],style:l.style,styleSpec:c,objectElementValidators:pa})),v;case"geojson":if(v=Di({key:r,value:t,valueSpec:c.source_geojson,style:p,styleSpec:c,objectElementValidators:pa}),t.cluster)for(const b in t.clusterProperties){const[I,M]=t.clusterProperties[b],L=typeof I=="string"?[I,["accumulated"],["get",b]]:I;v.push(...fr({key:`${r}.${b}.map`,value:M,expressionContext:"cluster-map"})),v.push(...fr({key:`${r}.${b}.reduce`,value:L,expressionContext:"cluster-reduce"}))}return v;case"video":return Di({key:r,value:t,valueSpec:c.source_video,style:p,styleSpec:c});case"image":return Di({key:r,value:t,valueSpec:c.source_image,style:p,styleSpec:c});case"canvas":return[new s.V(r,null,"Please use runtime APIs to add canvas sources, rather than including them in stylesheets.","source.canvas")];default:return ar({key:`${r}.type`,value:t.type,valueSpec:{values:Xs(c)}})}}function Xs(l){return l.source.reduce(((t,r)=>{const c=l[r];return c.type.type==="enum"&&(t=t.concat(Object.keys(c.type.values))),t}),[])}function Oa(l){const t=l.value,r=l.styleSpec,c=r.light,p=l.style;let _=[];const v=s.J(t);if(t===void 0)return _;if(v!=="object")return _=_.concat([new s.V("light",t,`object expected, ${v} found`)]),_;for(const b in t){const I=b.match(/^(.*)-transition$/),M=b.match(/^(.*)-use-theme$/);_=_.concat(M&&c[M[1]]?nr({key:b,value:t[b],valueSpec:{type:"string"},style:p,styleSpec:r}):I&&c[I[1]]&&c[I[1]].transition?nr({key:b,value:t[b],valueSpec:r.transition,style:p,styleSpec:r}):c[b]?nr({key:b,value:t[b],valueSpec:c[b],style:p,styleSpec:r}):[new s.V(b,t[b],`unknown property "${b}"`)])}return _}function ma(l){const t=l.value;let r=[];if(!t)return r;const c=s.J(t);if(c!=="object")return r=r.concat([new s.V("light-3d",t,`object expected, ${c} found`)]),r;const p=l.styleSpec,_=p["light-3d"],v=l.key,b=l.style,I=l.style.lights;for(const B of["type","id"])if(!(B in t))return r=r.concat([new s.V("light-3d",t,`missing property ${B} on light`)]),r;if(t.type&&I)for(let B=0;B<l.arrayIndex;B++){const F=s.M(t.type),V=I[B];s.M(V.type)===F&&r.push(new s.V(v,t.id,`duplicate light type "${t.type}", previously defined at line ${V.id.__line__}`))}const M=`properties_light_${t.type}`;if(!(M in p))return r=r.concat([new s.V("light-3d",t,`Invalid light type ${t.type}`)]),r;const L=p[M];for(const B in t)if(B==="properties"){const F=t[B],V=s.J(F);if(V!=="object")return r=r.concat([new s.V("properties",F,`object expected, ${V} found`)]),r;for(const $ in F){const H=$.match(/^(.*)-transition$/),X=$.match(/^(.*)-use-theme$/);r=r.concat(X&&L[X[1]]?nr({key:B,value:F[$],valueSpec:{type:"string"},style:b,styleSpec:p}):H&&L[H[1]]&&L[H[1]].transition?nr({key:B,value:t[B],valueSpec:p.transition,style:b,styleSpec:p}):L[$]?nr({key:$,value:F[$],valueSpec:L[$],style:b,styleSpec:p}):[new s.K(l.key,F[$],`unknown property "${$}"`)])}}else r=r.concat(_[B]?nr({key:B,value:t[B],valueSpec:_[B],style:b,styleSpec:p}):[new s.K(B,t[B],`unknown property "${B}"`)]);return r}function Ba(l){const t=l.value,r=l.key,c=l.style,p=l.styleSpec,_=p.terrain;let v=[];const b=s.J(t);if(t===void 0||b==="null")return v;if(b!=="object")return v=v.concat([new s.V("terrain",t,`object expected, ${b} found`)]),v;for(const I in t){const M=I.match(/^(.*)-transition$/),L=I.match(/^(.*)-use-theme$/);v=v.concat(L&&_[L[1]]?nr({key:I,value:t[I],valueSpec:{type:"string"},style:c,styleSpec:p}):M&&_[M[1]]&&_[M[1]].transition?nr({key:I,value:t[I],valueSpec:p.transition,style:c,styleSpec:p}):_[I]?nr({key:I,value:t[I],valueSpec:_[I],style:c,styleSpec:p}):[new s.K(I,t[I],`unknown property "${I}"`)])}if(t.source){const I=c.sources&&c.sources[t.source],M=I&&s.M(I.type);I?M!=="raster-dem"&&v.push(new s.V(r,t.source,`terrain cannot be used with a source of type ${String(M)}, it only be used with a "raster-dem" source type`)):v.push(new s.V(r,t.source,`source "${t.source}" not found`))}else v.push(new s.V(r,t,'terrain is missing required property "source"'));return v}function Na(l){const t=l.value,r=l.style,c=l.styleSpec,p=c.fog;let _=[];const v=s.J(t);if(t===void 0)return _;if(v!=="object")return _=_.concat([new s.V("fog",t,`object expected, ${v} found`)]),_;for(const b in t){const I=b.match(/^(.*)-transition$/),M=b.match(/^(.*)-use-theme$/);_=_.concat(M&&p[M[1]]?nr({key:b,value:t[b],valueSpec:{type:"string"},style:r,styleSpec:c}):I&&p[I[1]]&&p[I[1]].transition?nr({key:b,value:t[b],valueSpec:c.transition,style:r,styleSpec:c}):p[b]?nr({key:b,value:t[b],valueSpec:p[b],style:r,styleSpec:c}):[new s.K(b,t[b],`unknown property "${b}"`)])}return _}const Rl={"*":()=>[],array:cn,boolean:function(l){const t=l.value,r=l.key,c=s.J(t);return c!=="boolean"?[new s.V(r,t,`boolean expected, ${c} found`)]:[]},number:wr,color:function(l){const t=l.key,r=l.value,c=s.J(r);return c!=="string"?[new s.V(t,r,`color expected, ${c} found`)]:s.a0.parseCSSColor(r)===null?[new s.V(t,r,`color expected, "${r}" found`)]:[]},enum:ar,filter:vs,function:Zn,layer:da,object:Di,source:xs,model:s.a4,light:Oa,"light-3d":ma,terrain:Ba,fog:Na,string:fa,formatted:function(l){return fa(l).length===0?[]:fr(l)},resolvedImage:function(l){return fa(l).length===0?[]:fr(l)},projection:function(l){const t=l.value,r=l.styleSpec,c=r.projection,p=l.style;let _=[];const v=s.J(t);if(v==="object")for(const b in t)_=_.concat(nr({key:b,value:t[b],valueSpec:c[b],style:p,styleSpec:r}));else v!=="string"&&(_=_.concat([new s.V("projection",t,`object or string expected, ${v} found`)]));return _},import:function(l){const{value:t,styleSpec:r}=l,{data:c,...p}=t;Object.defineProperty(p,"__line__",{value:t.__line__,enumerable:!1});let _=Di(s.L({},l,{value:p,valueSpec:r.import}));return s.M(p.id)===""&&_.push(new s.V(`${l.key}.id`,p,"import id can't be an empty string")),c&&(_=_.concat(Dl(c,r,{key:`${l.key}.data`}))),_},iconset:function(l){const t=l.value,r=l.key,c=l.styleSpec,p=l.style;if(!t.type)return[new s.V(r,t,'"type" is required')];const _=s.M(t.type);let v=[];if(v=v.concat(Di({key:r,value:t,valueSpec:c[`iconset_${_}`],style:p,styleSpec:c})),_==="source"&&t.source){const b=p.sources&&p.sources[t.source],I=b&&s.M(b.type);b?I!=="raster-array"&&v.push(new s.V(r,t.source,`iconset cannot be used with a source of type ${String(I)}, it only be used with a "raster-array" source type`)):v.push(new s.V(r,t.source,`source "${t.source}" not found`))}return v}};function nr(l,t=!1){const r=l.value,c=l.valueSpec,p=l.styleSpec;if(c.expression&&s.a2(s.M(r)))return Zn(l);if(c.expression&&s.S(s.U(r)))return fr(l);if(c.type&&Rl[c.type]){const _=Rl[c.type](l);return t===!0&&_.length>0&&s.J(l.value)==="array"?fr(l):_}return Di(s.L({},l,{valueSpec:c.type?p[c.type]:c}))}function Ml(l){const t=l.value,r=l.key,c=fa(l);return c.length||(t.indexOf("{fontstack}")===-1&&c.push(new s.V(r,t,'"glyphs" url must include a "{fontstack}" token')),t.indexOf("{range}")===-1&&c.push(new s.V(r,t,'"glyphs" url must include a "{range}" token'))),c}function Dl(l,t=s.a5,r={}){return nr({key:r.key||"",value:l,valueSpec:t.$root,styleSpec:t,style:l,objectElementValidators:{glyphs:Ml,"*":()=>[]}})}function gs(l,t=s.a5){return be(Dl(l,t))}const Jo=l=>be(xs(l)),Ac=l=>be(Oa(l)),No=l=>be(ma(l)),gt=l=>be(Ba(l)),Vo=l=>be(Na(l)),eu=l=>be((function(t){const r=t.value,c=t.style,p=t.styleSpec,_=p.snow;let v=[];const b=s.J(r);if(r===void 0)return v;if(b!=="object")return v=v.concat([new s.V("snow",r,`object expected, ${b} found`)]),v;for(const I in r){const M=I.match(/^(.*)-transition$/);v=v.concat(M&&_[M[1]]&&_[M[1]].transition?nr({key:I,value:r[I],valueSpec:p.transition,style:c,styleSpec:p}):_[I]?nr({key:I,value:r[I],valueSpec:_[I],style:c,styleSpec:p}):[new s.K(I,r[I],`unknown property "${I}"`)])}return v})(l)),_a=l=>be((function(t){const r=t.value,c=t.style,p=t.styleSpec,_=p.rain;let v=[];const b=s.J(r);if(r===void 0)return v;if(b!=="object")return v=v.concat([new s.V("rain",r,`object expected, ${b} found`)]),v;for(const I in r){const M=I.match(/^(.*)-transition$/);v=v.concat(M&&_[M[1]]&&_[M[1]].transition?nr({key:I,value:r[I],valueSpec:p.transition,style:c,styleSpec:p}):_[I]?nr({key:I,value:r[I],valueSpec:_[I],style:c,styleSpec:p}):[new s.K(I,r[I],`unknown property "${I}"`)])}return v})(l)),vn=l=>be(da(l)),ke=l=>be(vs(l)),Q=l=>be(Sr(l)),J=l=>be(Lr(l)),ce=l=>be(s.a4(l));function be(l){return l.slice().sort(((t,r)=>t.line&&r.line?t.line-r.line:0))}function de(l,t){let r=!1;if(t&&t.length)for(const c of t)c instanceof s.K?s.w(c.message):(l.fire(new s.z(new Error(c.message))),r=!0);return r}let Ae;class $e extends s.E{constructor(t,r="flat"){super(),this._transitionable=new s.a6(Ae||(Ae=new s.a7({anchor:new s.a8(s.a5.light.anchor),position:new s.a9(s.a5.light.position),color:new s.a8(s.a5.light.color),intensity:new s.a8(s.a5.light.intensity)}))),this.setLight(t,r),this._transitioning=this._transitionable.untransitioned()}getLight(){return this._transitionable.serialize()}setLight(t,r,c={}){this._validate(Ac,t,c)||(this._transitionable.setTransitionOrValue(t),this.id=r)}updateTransitions(t){this._transitioning=this._transitionable.transitioned(t,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(t){this.properties=this._transitioning.possiblyEvaluate(t)}_validate(t,r,c){return(!c||c.validate!==!1)&&de(this,t.call(gs,s.h({value:r,style:{glyphs:!0,sprite:!0},styleSpec:s.a5})))}}let Re=class extends s.E{constructor(l,t,r,c,p){super(),this.scope=r,this._transitionable=new s.a6(new s.a7({source:new s.a8(s.a5.terrain.source),exaggeration:new s.a8(s.a5.terrain.exaggeration)}),r,c),this._transitionable.setTransitionOrValue(l,c),this._transitioning=this._transitionable.untransitioned(),this.drapeRenderMode=t,this.worldview=p}get(){return this._transitionable.serialize()}set(l,t){this._transitionable.setTransitionOrValue(l,t)}updateTransitions(l){this._transitioning=this._transitionable.transitioned(l,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(l){this.properties=this._transitioning.possiblyEvaluate(l)}getExaggeration(l){return this._transitioning.possiblyEvaluate(new s.aa(l,{worldview:this.worldview})).get("exaggeration")}getAttenuationRange(){if(!this.isZoomDependent())return null;const l=this._transitionable._values.exaggeration;if(!l)return null;const t=l.value.expression;if(!t)return null;let r=-1,c=-1,p=1;for(const _ of t.zoomStops)p=t.evaluate(new s.aa(_,{worldview:this.worldview})),p>.01?(r=_,c=-1):c=_;return p<.01&&r>0&&c>r?[r,c]:null}isZoomDependent(){const l=this._transitionable._values.exaggeration;return l!=null&&l.value!=null&&l.value.expression!=null&&l.value.expression instanceof s.ab}};const Ge=45,Ct=65,lt=.05;function ri(l,t,r,c){const p=s.af(Ge,Ct,r),[_,v]=yi(l,c);let b=1-Math.min(1,Math.exp((t-_)/(v-_)*-6));return b*=b*b,b=Math.min(1,1.00747*b),b*p*l.alpha}function yi(l,t){const r=.5/Math.tan(.5*t);return[l.range[0]+r,l.range[1]+r]}function Ri(l,t,r,c,p){const _=s.ad([],[t,r,c],p.mercatorFogMatrix);return ri(l,s.ae(_),p.pitch,p._fov)}function Ki(l,t,r,c,p,_,v){const b=[[r,c,0],[p,c,0],[p,_,0],[r,_,0]];let I=Number.MAX_VALUE,M=-Number.MAX_VALUE;for(const L of b){const B=s.ad([],L,t),F=s.ae(B);I=Math.min(I,F),M=Math.max(M,F)}return[ri(l,I,v.pitch,v._fov),ri(l,M,v.pitch,v._fov)]}class Vi extends s.E{constructor(t,r,c,p){super();const _=new s.a7({range:new s.a8(s.a5.fog.range),color:new s.a8(s.a5.fog.color),"color-use-theme":new s.a8({type:"string","property-type":"data-constant",default:"default"}),"high-color":new s.a8(s.a5.fog["high-color"]),"high-color-use-theme":new s.a8({type:"string","property-type":"data-constant",default:"default"}),"space-color":new s.a8(s.a5.fog["space-color"]),"space-color-use-theme":new s.a8({type:"string","property-type":"data-constant",default:"default"}),"horizon-blend":new s.a8(s.a5.fog["horizon-blend"]),"star-intensity":new s.a8(s.a5.fog["star-intensity"]),"vertical-range":new s.a8(s.a5.fog["vertical-range"])});this._transitionable=new s.a6(_,c,new Map(p)),this.set(t,p),this._transitioning=this._transitionable.untransitioned(),this._transform=r,this.properties=new s.ag(_),this.scope=c}get state(){const t=this._transform,r=t.projection.name==="globe",c=s.ah(t.zoom),p=this.properties.get("range"),_=[.5,3];return{range:r?[s.ai(_[0],p[0],c),s.ai(_[1],p[1],c)]:p,horizonBlend:this.properties.get("horizon-blend"),alpha:this.properties.get("color").a}}get(){return this._transitionable.serialize()}set(t,r,c={}){if(this._validate(Vo,t,c))return;const p=s.h({},t);for(const _ of Object.keys(s.a5.fog))p[_]===void 0&&(p[_]=s.a5.fog[_].default);this._options=p,this._transitionable.setTransitionOrValue(this._options,r)}getOpacity(t){if(!this._transform.projection.supportsFog)return 0;const r=this.properties&&this.properties.get("color")||1;return(this._transform.projection.name==="globe"?1:s.af(Ge,Ct,t))*r.a}getOpacityAtLatLng(t,r){return this._transform.projection.supportsFog?(function(c,p,_){const v=s.ac.fromLngLat(p),b=_.elevation?_.elevation.getAtPointOrZero(v):0;return Ri(c,v.x,v.y,b,_)})(this.state,t,r):0}getOpacityForTile(t){if(!this._transform.projection.supportsFog)return[1,1];const r=this._transform.calculateFogTileMatrix(t.toUnwrapped());return Ki(this.state,r,0,0,s.aj,s.aj,this._transform)}getOpacityForBounds(t,r,c,p,_){return this._transform.projection.supportsFog?Ki(this.state,t,r,c,p,_,this._transform):[1,1]}getFovAdjustedRange(t){return this._transform.projection.supportsFog?yi(this.state,t):[0,1]}isVisibleOnFrustum(t){if(!this._transform.projection.supportsFog)return!1;const r=[4,5,6,7];for(const c of r){const p=t.points[c];let _;if(p[2]>=0)_=p;else{const v=t.points[c-4];_=s.ak(v,p,v[2]/(v[2]-p[2]))}if(Ri(this.state,_[0],_[1],0,this._transform)>=lt)return!0}return!1}updateConfig(t){this._transitionable.setTransitionOrValue(this._options,new Map(t))}updateTransitions(t){this._transitioning=this._transitionable.transitioned(t,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(t){this.properties=this._transitioning.possiblyEvaluate(t)}_validate(t,r,c){return(!c||c.validate!==!1)&&de(this,t.call(gs,s.h({value:r,style:{glyphs:!0,sprite:!0},styleSpec:s.a5})))}}let Yi,Xn,tn,Nr,Fn=class extends s.E{constructor(l,t,r,c){super();const p=Yi||(Yi=new s.a7({density:new s.a8(s.a5.snow.density),intensity:new s.a8(s.a5.snow.intensity),color:new s.a8(s.a5.snow.color),opacity:new s.a8(s.a5.snow.opacity),vignette:new s.a8(s.a5.snow.vignette),"vignette-color":new s.a8(s.a5.snow["vignette-color"]),"center-thinning":new s.a8(s.a5.snow["center-thinning"]),direction:new s.a8(s.a5.snow.direction),"flake-size":new s.a8(s.a5.snow["flake-size"])}));this._transitionable=new s.a6(p,r,new Map(c)),this.set(l,c),this._transitioning=this._transitionable.untransitioned(),this.properties=new s.ag(p),this.scope=r}get state(){const l=this.properties.get("opacity"),t=this.properties.get("color"),r=this.properties.get("direction"),c=s.al(r[0]),p=-Math.max(s.al(r[1]),.01),_=[Math.cos(c)*Math.cos(p),Math.sin(c)*Math.cos(p),Math.sin(p)],v=this.properties.get("vignette"),b=this.properties.get("vignette-color");return b.a=v,{density:this.properties.get("density"),intensity:this.properties.get("intensity"),color:new s.am(t.r,t.g,t.b,t.a*l),direction:_,centerThinning:this.properties.get("center-thinning"),flakeSize:this.properties.get("flake-size"),vignetteColor:b}}get(){return this._transitionable.serialize()}set(l,t,r={}){if(this._validate(eu,l,r))return;const c=s.h({},l);for(const p of Object.keys(s.a5.snow))c[p]===void 0&&(c[p]=s.a5.snow[p].default);this._options=c,this._transitionable.setTransitionOrValue(this._options,t)}updateConfig(l){this._transitionable.setTransitionOrValue(this._options,new Map(l))}updateTransitions(l){this._transitioning=this._transitionable.transitioned(l,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(l){this.properties=this._transitioning.possiblyEvaluate(l)}_validate(l,t,r){return(!r||r.validate!==!1)&&de(this,l.call(gs,s.h({value:t,style:{glyphs:!0,sprite:!0},styleSpec:s.a5})))}},ns=class extends s.E{constructor(l,t,r,c){super();const p=Xn||(Xn=new s.a7({density:new s.a8(s.a5.rain.density),intensity:new s.a8(s.a5.rain.intensity),color:new s.a8(s.a5.rain.color),opacity:new s.a8(s.a5.rain.opacity),vignette:new s.a8(s.a5.rain.vignette),"vignette-color":new s.a8(s.a5.rain["vignette-color"]),"center-thinning":new s.a8(s.a5.rain["center-thinning"]),direction:new s.a8(s.a5.rain.direction),"droplet-size":new s.a8(s.a5.rain["droplet-size"]),"distortion-strength":new s.a8(s.a5.rain["distortion-strength"])}));this._transitionable=new s.a6(p,r,new Map(c)),this.set(l,c),this._transitioning=this._transitionable.untransitioned(),this.properties=new s.ag(p),this.scope=r}get state(){const l=this.properties.get("opacity"),t=this.properties.get("color"),r=this.properties.get("direction"),c=s.al(r[0]),p=-Math.max(s.al(r[1]),.01),_=[Math.cos(c)*Math.cos(p),Math.sin(c)*Math.cos(p),Math.sin(p)],v=this.properties.get("vignette-color");return v.a=this.properties.get("vignette"),{density:this.properties.get("density"),intensity:this.properties.get("intensity"),color:new s.am(t.r,t.g,t.b,t.a*l),direction:_,centerThinning:this.properties.get("center-thinning"),dropletSize:this.properties.get("droplet-size"),distortionStrength:this.properties.get("distortion-strength"),vignetteColor:v}}get(){return this._transitionable.serialize()}set(l,t,r={}){if(this._validate(_a,l,r))return;const c=s.h({},l);for(const p of Object.keys(s.a5.rain))c[p]===void 0&&(c[p]=s.a5.rain[p].default);this._options=c,this._transitionable.setTransitionOrValue(this._options,t)}updateConfig(l){this._transitionable.setTransitionOrValue(this._options,new Map(l))}updateTransitions(l){this._transitioning=this._transitionable.transitioned(l,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(l){this.properties=this._transitioning.possiblyEvaluate(l)}_validate(l,t,r){return(!r||r.validate!==!1)&&de(this,l.call(gs,s.h({value:t,style:{glyphs:!0,sprite:!0},styleSpec:s.a5})))}};class jn extends s.E{constructor(t,r,c,p){super(),this.scope=c,this._options=t,this.properties=new s.ag(r),this._transitionable=new s.a6(r,c,new Map(p)),this._transitionable.setTransitionOrValue(t.properties),this._transitioning=this._transitionable.untransitioned()}updateConfig(t){this._transitionable.setTransitionOrValue(this._options.properties,new Map(t))}updateTransitions(t){this._transitioning=this._transitionable.transitioned(t,this._transitioning)}hasTransition(){return this._transitioning.hasTransition()}recalculate(t){this.properties=this._transitioning.possiblyEvaluate(t)}get(){return this._options.properties=this._transitionable.serialize(),this._options}set(t,r){this._options=t,this._transitionable.setTransitionOrValue(t.properties,r)}shadowsEnabled(){return!!this.properties&&this.properties.get("cast-shadows")===!0}}class dn{constructor(t,r,c){this.screenBounds=t,this.cameraPoint=c.getCameraPoint(),this._screenRaycastCache={},this._cameraRaycastCache={},this.isAboveHorizon=r,this.screenGeometry=this.bufferedScreenGeometry(0),this.screenGeometryMercator=this._bufferedScreenMercator(0,c)}static createFromScreenPoints(t,r){let c,p;if(t instanceof s.P||typeof t[0]=="number"){const _=s.P.convert(t);c=[_],p=r.isPointAboveHorizon(_)}else{const _=s.P.convert(t[0]),v=s.P.convert(t[1]),b=_.add(v)._div(2);c=[_,v],p=s.ao(_,v).every((I=>r.isPointAboveHorizon(I)))&&r.isPointAboveHorizon(b)}return new dn(c,p,r)}isPointQuery(){return this.screenBounds.length===1}bufferedScreenGeometry(t){return s.ao(this.screenBounds[0],this.screenBounds.length===1?this.screenBounds[0]:this.screenBounds[1],t)}bufferedCameraGeometry(t){const r=this.screenBounds[0],c=this.screenBounds.length===1?this.screenBounds[0].add(new s.P(1,1)):this.screenBounds[1],p=s.ao(r,c,0,!1);return this.cameraPoint.y>c.y&&(this.cameraPoint.x>r.x&&this.cameraPoint.x<c.x?p.splice(3,0,this.cameraPoint):this.cameraPoint.x>=c.x?p[2]=this.cameraPoint:this.cameraPoint.x<=r.x&&(p[3]=this.cameraPoint)),s.ap(p,t)}bufferedCameraGeometryGlobe(t){const r=this.screenBounds[0],c=this.screenBounds.length===1?this.screenBounds[0].add(new s.P(1,1)):this.screenBounds[1],p=s.ao(r,c,t),_=this.cameraPoint.clone();switch(3*((_.y>r.y)+(_.y>c.y))+((_.x>r.x)+(_.x>c.x))){case 0:p[0]=_,p[4]=_.clone();break;case 1:p.splice(1,0,_);break;case 2:p[1]=_;break;case 3:p.splice(4,0,_);break;case 5:p.splice(2,0,_);break;case 6:p[3]=_;break;case 7:p.splice(3,0,_);break;case 8:p[2]=_}return p}containsTile(t,r,c,p=0){const _=t.queryPadding/r._pixelsPerMercatorPixel+1,v=c?this._bufferedCameraMercator(_,r):this._bufferedScreenMercator(_,r);let b=t.tileID.wrap+(v.unwrapped?p:0);const I=v.polygon.map((X=>s.aq(t.tileTransform,X,b)));if(!s.ar(I,0,0,s.aj,s.aj))return;b=t.tileID.wrap+(this.screenGeometryMercator.unwrapped?p:0);const M=this.screenGeometryMercator.polygon.map((X=>s.as(t.tileTransform,X,b))),L=M.map((X=>new s.P(X[0],X[1]))),B=r.getFreeCameraOptions().position||new s.ac(0,0,0),F=s.as(t.tileTransform,B,b),V=M.map((X=>{const Z=s.at(X,X,F);return s.au(Z,Z),new s.av(F,Z)})),$=s.aw(t,1,r.zoom)*r._pixelsPerMercatorPixel;return{queryGeometry:this,tilespaceGeometry:L,tilespaceRays:V,bufferedTilespaceGeometry:I,bufferedTilespaceBounds:(H=s.ax(I),H.min.x=s.ay(H.min.x,0,s.aj),H.min.y=s.ay(H.min.y,0,s.aj),H.max.x=s.ay(H.max.x,0,s.aj),H.max.y=s.ay(H.max.y,0,s.aj),H),tile:t,tileID:t.tileID,pixelToTileUnitsFactor:$};var H}_bufferedScreenMercator(t,r){const c=Tr(t);if(this._screenRaycastCache[c])return this._screenRaycastCache[c];{let p;return p=r.projection.name==="globe"?this._projectAndResample(this.bufferedScreenGeometry(t),r):{polygon:this.bufferedScreenGeometry(t).map((_=>r.pointCoordinate3D(_))),unwrapped:!0},this._screenRaycastCache[c]=p,p}}_bufferedCameraMercator(t,r){const c=Tr(t);if(this._cameraRaycastCache[c])return this._cameraRaycastCache[c];{let p;return p=r.projection.name==="globe"?this._projectAndResample(this.bufferedCameraGeometryGlobe(t),r):{polygon:this.bufferedCameraGeometry(t).map((_=>r.pointCoordinate3D(_))),unwrapped:!0},this._cameraRaycastCache[c]=p,p}}_projectAndResample(t,r){const c=(function(_,v){const b=s.az([],v.pixelMatrix,v.globeMatrix),I=[0,-s.aB,0,1],M=[0,s.aB,0,1],L=[0,0,0,1];s.aA(I,I,b),s.aA(M,M,b),s.aA(L,L,b);const B=new s.P(I[0]/I[3],I[1]/I[3]),F=new s.P(M[0]/M[3],M[1]/M[3]),V=s.aC(_,B)&&I[3]<L[3],$=s.aC(_,F)&&M[3]<L[3];if(!V&&!$)return null;const H=(function(we,me,_e){for(let ge=1;ge<we.length;ge++){const Be=br(me.pointCoordinate3D(we[ge-1]).x),Ce=br(me.pointCoordinate3D(we[ge]).x);if(_e<0){if(Be<Ce)return{idx:ge,t:-Be/(Ce-1-Be)}}else if(Ce<Be)return{idx:ge,t:(1-Be)/(Ce+1-Be)}}return null})(_,v,V?-1:1);if(!H)return null;const{idx:X,t:Z}=H;let te=X>1?rr(_.slice(0,X),v):[],oe=X<_.length?rr(_.slice(X),v):[];te=te.map((we=>new s.P(br(we.x),we.y))),oe=oe.map((we=>new s.P(br(we.x),we.y)));const le=[...te];le.length===0&&le.push(oe[oe.length-1]);const pe=s.ai(le[le.length-1].y,(oe.length===0?te[0]:oe[0]).y,Z);let ye;return ye=V?[new s.P(0,pe),new s.P(0,0),new s.P(1,0),new s.P(1,pe)]:[new s.P(1,pe),new s.P(1,1),new s.P(0,1),new s.P(0,pe)],le.push(...ye),oe.length===0?le.push(te[0]):le.push(...oe),{polygon:le.map((we=>new s.ac(we.x,we.y))),unwrapped:!1}})(t,r);if(c)return c;const p=(function(_,v){let b=!1,I=-1/0,M=0;for(let B=0;B<_.length-1;B++)_[B].x>I&&(I=_[B].x,M=B);for(let B=0;B<_.length-1;B++){const F=(M+B)%(_.length-1),V=_[F],$=_[F+1];Math.abs(V.x-$.x)>.5&&(V.x<$.x?(V.x+=1,F===0&&(_[_.length-1].x+=1)):($.x+=1,F+1===_.length-1&&(_[0].x+=1)),b=!0)}const L=s.aD(v.center.lng);return b&&L<Math.abs(L-1)&&_.forEach((B=>{B.x-=1})),{polygon:_,unwrapped:b}})(rr(t,r).map((_=>new s.P(br(_.x),_.y))),r);return{polygon:p.polygon.map((_=>new s.ac(_.x,_.y))),unwrapped:p.unwrapped}}}function rr(l,t){return s.aE(l,(r=>{const c=t.pointCoordinate3D(r);r.x=c.x,r.y=c.y}),1/256)}function br(l){return l<0?1+l%1:l%1}function Tr(l){return 100*l|0}function us(l,t,r,c,p){const _=function(b,I){if(b)return p(b);if(I){if(l.url&&I.tiles&&l.tiles&&delete l.tiles,I.variants){if(!Array.isArray(I.variants))return p(new Error("variants must be an array"));for(const L of I.variants){if(L==null||typeof L!="object"||L.constructor!==Object)return p(new Error("variant must be an object"));if(!Array.isArray(L.capabilities))return p(new Error("capabilities must be an array"));if(L.capabilities.length===1&&L.capabilities[0]==="meshopt"){I=s.h(I,L);break}}}const M=s.aF(s.h({},I,l),["tilejson","tiles","minzoom","maxzoom","attribution","mapbox_logo","bounds","extra_bounds","scheme","tileSize","encoding","vector_layers","raster_layers","worldview_options","worldview_default","worldview"]);M.tiles=t.canonicalizeTileset(M,l.url),p(null,M)}},v=(function(b,I,M){if(!b)return null;if(!I&&!M)return b;M=M||b.worldview_default;const L=Object.values(b.language||{});if(L.length===0)return null;const B=Object.values(b.worldview||{});if(B.length===0)return null;const F=L.every(($=>$===I)),V=B.every(($=>$===M));return F&&V?b:I in(b.language_options||{})||M in(b.worldview_options||{})?null:b.language_options&&b.worldview_options?b:null})(l.data,r,c);return v?s.q.frame((()=>_(null,v))):l.url?s.n(t.transformRequest(t.normalizeSourceURL(l.url,null,r,c),s.R.Source),_):s.q.frame((()=>{const{data:b,...I}=l;_(null,I)}))}function rs(l,t){const r=Math.pow(2,t.z),c=Math.floor(s.aD(l.getWest())*r),p=Math.floor(s.aH(l.getNorth())*r),_=Math.ceil(s.aD(l.getEast())*r),v=Math.ceil(s.aH(l.getSouth())*r);return t.x>=c&&t.x<_&&t.y>=p&&t.y<v}class Ns{constructor(t,r,c){this.bounds=t?s.aG.convert(this.validateBounds(t)):null,this.minzoom=r||0,this.maxzoom=c||24}validateBounds(t){return Array.isArray(t)&&t.length===4?[Math.max(-180,t[0]),Math.max(-90,t[1]),Math.min(180,t[2]),Math.min(90,t[3])]:[-180,-90,180,90]}addExtraBounds(t){if(t){this.extraBounds||(this.extraBounds=[]);for(const r of t)this.extraBounds.push(s.aG.convert(this.validateBounds(r)))}}contains(t){if(t.z>this.maxzoom||t.z<this.minzoom||this.bounds&&!rs(this.bounds,t))return!1;if(!this.extraBounds)return!0;for(const r of this.extraBounds)if(rs(r,t))return!0;return!1}static fromTileJSON(t){if(!t.bounds&&!t.extra_bounds)return null;const r=new Ns(t.bounds,t.minzoom,t.maxzoom);return r.addExtraBounds(t.extra_bounds),r}}class Ks extends s.E{constructor(t,r,c,p){if(super(),this.id=t,this.dispatcher=c,this.type="vector",this.minzoom=0,this.maxzoom=22,this.scheme="xyz",this.tileSize=512,this.reparseOverscaled=!0,this.isTileClipped=!0,this._loaded=!1,s.h(this,s.aF(r,["url","scheme","tileSize","promoteId"])),this._options=s.h({type:"vector"},r),this._collectResourceTiming=!!r.collectResourceTiming,this.tileSize!==512)throw new Error("vector tile sources must have a tileSize of 512");this.setEventedParent(p),this._tileWorkers={},this._deduped=new s.aI}load(t){this._loaded=!1,this.fire(new s.A("dataloading",{dataType:"source"}));const r=Array.isArray(this.map._language)?this.map._language.join():this.map._language,c=this.map.getWorldview();this._tileJSONRequest=us(this._options,this.map._requestManager,r,c,((p,_)=>{if(this._tileJSONRequest=null,this._loaded=!0,p)r&&console.warn(`Ensure that your requested language string is a valid BCP-47 code or list of codes. Found: ${r}`),c&&console.warn(`Requested worldview strings must be a valid ISO alpha-2 code. Found: ${c}`),this.fire(new s.z(p));else if(_){if(s.h(this,_),this.hasWorldviews=!!_.worldview_options,_.worldview_default&&(this.worldviewDefault=_.worldview_default),_.vector_layers){this.vectorLayers=_.vector_layers,this.vectorLayerIds=[],this.localizableLayerIds=new Set;for(const v of _.vector_layers)this.vectorLayerIds.push(v.id),_.worldview&&_.worldview[v.source]&&this.localizableLayerIds.add(v.id)}this.tileBounds=Ns.fromTileJSON(_),Gt(_.tiles,this.map._requestManager._customAccessToken),this.fire(new s.A("data",{dataType:"source",sourceDataType:"metadata"})),this.fire(new s.A("data",{dataType:"source",sourceDataType:"content"}))}t&&t(p)}))}loaded(){return this._loaded}hasTile(t){return!this.tileBounds||this.tileBounds.contains(t.canonical)}onAdd(t){this.map=t,this.load()}reload(){this.cancelTileJSONRequest();const t=s.C(this.id,this.scope);this.load((()=>this.map.style.clearSource(t)))}setTiles(t){return this._options.tiles=t,this.reload(),this}setUrl(t){return this.url=t,this._options.url=t,this.reload(),this}onRemove(t){this.cancelTileJSONRequest()}serialize(){return s.h({},this._options)}loadTile(t,r){const c=t.tileID.canonical.url(this.tiles,this.scheme),p=this.map._requestManager.normalizeTileURL(c),_=this.map._requestManager.transformRequest(p,s.R.Tile),v=this.map.style?this.map.style.getLut(this.scope):null,b=v?{image:v.image.clone()}:null,I={request:_,data:void 0,uid:t.uid,tileID:t.tileID,tileZoom:t.tileZoom,zoom:t.tileID.overscaledZ,maxZoom:this.maxzoom,lut:b,tileSize:this.tileSize*t.tileID.overscaleFactor(),type:this.type,source:this.id,scope:this.scope,pixelRatio:s.q.devicePixelRatio,showCollisionBoxes:this.map.showCollisionBoxes,promoteId:this.promoteId,isSymbolTile:t.isSymbolTile,brightness:this.map.style&&this.map.style.getBrightness()||0,extraShadowCaster:t.isExtraShadowCaster,tessellationStep:this.map._tessellationStep,scaleFactor:this.map.getScaleFactor(),worldview:this.map.getWorldview()||this.worldviewDefault};if(this.hasWorldviews&&s.j(c)&&(I.localizableLayerIds=this.localizableLayerIds),I.request.collectResourceTiming=this._collectResourceTiming,t.actor&&t.state!=="expired")t.state==="loading"?t.reloadCallback=r:t.request=t.actor.send("reloadTile",I,M.bind(this));else if(t.actor=this._tileWorkers[p]=this._tileWorkers[p]||this.dispatcher.getActor(),this.dispatcher.ready)t.request=t.actor.send("loadTile",I,M.bind(this),void 0,!0);else{const L=s.aJ.call({deduped:this._deduped},I,((B,F)=>{B||!F?M.call(this,B):(I.data={cacheControl:F.cacheControl,expires:F.expires,rawData:F.rawData.slice(0)},t.actor&&t.actor.send("loadTile",I,M.bind(this),void 0,!0))}),!0);t.request={cancel:L}}function M(L,B){return delete t.request,t.aborted?r(null):L&&L.status!==404?r(L):(B&&B.resourceTiming&&(t.resourceTiming=B.resourceTiming),this.map._refreshExpiredTiles&&B&&t.setExpiryData(B),t.loadVectorData(B,this.map.painter),s.aK(this.dispatcher),r(null),void(t.reloadCallback&&(this.loadTile(t,t.reloadCallback),t.reloadCallback=null)))}}abortTile(t){t.request&&(t.request.cancel(),delete t.request),t.actor&&t.actor.send("abortTile",{uid:t.uid,type:this.type,source:this.id,scope:this.scope})}unloadTile(t,r){t.actor&&t.actor.send("removeTile",{uid:t.uid,type:this.type,source:this.id,scope:this.scope}),t.destroy()}hasTransition(){return!1}afterUpdate(){this._tileWorkers={}}cancelTileJSONRequest(){this._tileJSONRequest&&(this._tileJSONRequest.cancel(),this._tileJSONRequest=null)}}class ws extends s.E{constructor(t,r,c,p){super(),this.id=t,this.dispatcher=c,this.setEventedParent(p),this.type="raster",this.minzoom=0,this.maxzoom=22,this.roundZoom=!0,this.scheme="xyz",this.tileSize=512,this._loaded=!1,this._options=s.h({type:"raster"},r),s.h(this,s.aF(r,["url","scheme","tileSize"]))}load(t){this._loaded=!1,this.fire(new s.A("dataloading",{dataType:"source"}));const r=this.map.getWorldview();this._tileJSONRequest=us(this._options,this.map._requestManager,null,r,((c,p)=>{this._tileJSONRequest=null,this._loaded=!0,c?this.fire(new s.z(c)):p&&(s.h(this,p),p.raster_layers&&(this.rasterLayers=p.raster_layers,this.rasterLayerIds=this.rasterLayers.map((_=>_.id))),this.tileBounds=Ns.fromTileJSON(p),Gt(p.tiles),this.fire(new s.A("data",{dataType:"source",sourceDataType:"metadata"})),this.fire(new s.A("data",{dataType:"source",sourceDataType:"content"}))),t&&t(c)}))}loaded(){return this._loaded}onAdd(t){this.map=t,this.load()}reload(){this.cancelTileJSONRequest();const t=s.C(this.id,this.scope);this.load((()=>this.map.style.clearSource(t)))}setTiles(t){return this._options.tiles=t,this.reload(),this}setUrl(t){return this.url=t,this._options.url=t,this.reload(),this}onRemove(t){this.cancelTileJSONRequest()}serialize(){return s.h({},this._options)}hasTile(t){return!this.tileBounds||this.tileBounds.contains(t.canonical)}loadTile(t,r){const c=s.q.devicePixelRatio>=2,p=this.map._requestManager.normalizeTileURL(t.tileID.canonical.url(this.tiles,this.scheme),c,this.tileSize);t.request=s.o(this.map._requestManager.transformRequest(p,s.R.Tile),((_,v,b,I)=>(delete t.request,t.aborted?(t.state="unloaded",r(null)):_?(t.state="errored",r(_)):v?(this.map._refreshExpiredTiles&&t.setExpiryData({cacheControl:b,expires:I}),t.setTexture(v,this.map.painter),t.state="loaded",s.aK(this.dispatcher),void r(null)):r(null))))}abortTile(t,r){t.request&&(t.request.cancel(),delete t.request),r&&r()}unloadTile(t,r){t.texture&&t.texture instanceof s.T?(t.destroy(!0),t.texture&&t.texture instanceof s.T&&this.map.painter.saveTileTexture(t.texture)):t.destroy(),r&&r()}hasTransition(){return!1}cancelTileJSONRequest(){this._tileJSONRequest&&(this._tileJSONRequest.cancel(),this._tileJSONRequest=null)}}class ol extends ws{constructor(t,r,c,p){super(t,r,c,p),this.type="raster-array",this.maxzoom=22,this.partial=!0,this._options=s.h({type:"raster-array"},r)}triggerRepaint(t){const r=this.map.painter._terrain,c=this.map.style.getSourceCache(this.id);r&&r.enabled&&c&&r._clearRenderCacheForTile(c.id,t.tileID),this.map.triggerRepaint()}loadTile(t,r){const c=this.map._requestManager.normalizeTileURL(t.tileID.canonical.url(this.tiles,this.scheme),!1,this.tileSize),p=this.map._requestManager.transformRequest(c,s.R.Tile),_={request:p,uid:t.uid,tileID:t.tileID,type:this.type,source:this.id,scope:this.scope,partial:this.partial};t.source=this.id,t.scope=this.scope,t.requestParams=p,t.actor||(t.actor=this.dispatcher.getActor());const v=(b,I,M,L)=>{if(delete t.request,t.aborted)return t.state="unloaded",r(null);if(b)return b.name==="AbortError"?void 0:(t.state="errored",r(b));if(this.map._refreshExpiredTiles&&I&&t.setExpiryData({cacheControl:M,expires:L}),this.partial)t.state="empty";else{if(!I)return r(null);t.state="loaded",t._isHeaderLoaded=!0,t._mrt=I}r(null)};t.request=this.partial?t.fetchHeader(void 0,v.bind(this)):t.actor.send("loadTile",_,v.bind(this),void 0,!0)}abortTile(t){t.request&&(t.request.cancel(),delete t.request),t.actor&&t.actor.send("abortTile",{uid:t.uid,type:this.type,source:this.id,scope:this.scope})}unloadTile(t,r){const c=t.texturePerLayer;if(t.flushAllQueues(),c.size){t.destroy(!0);for(const p of c.values())this.map.painter.saveTileTexture(p)}else t.destroy()}prepareTile(t,r,c,p){t._isHeaderLoaded&&(t.state!=="empty"&&(t.state="reloading"),t.fetchBand(r,c,p,((_,v)=>{if(_)return t.state="errored",this.fire(new s.z(_)),void this.triggerRepaint(t);v&&(t._isHeaderLoaded=!0,t.setTexturePerLayer(c,v,this.map.painter),t.state="loaded",this.triggerRepaint(t))})))}getInitialBand(t){if(!this.rasterLayers)return 0;const r=this.rasterLayers.find((({id:_})=>_===t)),c=r&&r.fields,p=c&&c.bands&&c.bands;return p?p[0]:0}getTextureDescriptor(t,r,c){if(!t)return;const p=r.sourceLayer||this.rasterLayerIds&&this.rasterLayerIds[0];if(!p)return;let _=null;r instanceof s.aN?_=r.paint.get("raster-array-band"):r instanceof s.aO&&(_=r.paint.get("raster-particle-array-band"));const v=_||this.getInitialBand(p);if(v==null)return;if(!t.textureDescriptorPerLayer.get(r.id))return void this.prepareTile(t,p,r.id,v);if(t.updateNeeded(r.id,v)&&!c)return;const b=t.textureDescriptorPerLayer.get(r.id);return Object.assign({},b,{texture:t.texturePerLayer.get(r.id)})}getImages(t,r){const c=new Map;for(const p of t)for(const _ of r){const[v,b]=_.split("/"),I=p.getLayer(v);if(!I||!I.hasBand(b)||!I.hasDataForBand(b))continue;const{bytes:M,tileSize:L,buffer:B}=I.getBandView(b),F=L+2*B,V={data:new s.r({width:F,height:F},M),pixelRatio:2,sdf:!1,usvg:!1,version:0};c.set(_,V)}return c}}const tu={vector:Ks,raster:ws,"raster-dem":class extends ws{constructor(l,t,r,c){super(l,t,r,c),this.type="raster-dem",this.maxzoom=22,this._options=s.h({type:"raster-dem"},t),this.encoding=t.encoding||"mapbox"}loadTile(l,t){const r=this.map._requestManager.normalizeTileURL(l.tileID.canonical.url(this.tiles,this.scheme),!1,this.tileSize);function c(p,_){p&&(l.state="errored",t(p)),_&&(l.dem=_,l.dem.onDeserialize(),l.needsHillshadePrepare=!0,l.needsDEMTextureUpload=!0,l.state="loaded",t(null))}l.request=s.o(this.map._requestManager.transformRequest(r,s.R.Tile),(function(p,_,v,b){if(delete l.request,l.aborted)l.state="unloaded",t(null);else if(p)l.state="errored",t(p);else if(_){this.map._refreshExpiredTiles&&l.setExpiryData({cacheControl:v,expires:b});const I=ImageBitmap&&_ instanceof ImageBitmap&&s.t(),M=1-(_.width-s.aL(_.width))/2;M<1||l.neighboringTiles||(l.neighboringTiles=this._getNeighboringTiles(l.tileID));const L=I?_:s.q.getImageData(_,M),B={uid:l.uid,tileID:l.tileID,source:this.id,type:this.type,scope:this.scope,rawImageData:L,encoding:this.encoding,padding:M};l.actor&&l.state!=="expired"||(l.actor=this.dispatcher.getActor(),l.actor.send("loadTile",B,c.bind(this),void 0,!0))}}).bind(this))}_getNeighboringTiles(l){const t=l.canonical,r=Math.pow(2,t.z),c=(t.x-1+r)%r,p=t.x===0?l.wrap-1:l.wrap,_=(t.x+1+r)%r,v=t.x+1===r?l.wrap+1:l.wrap,b={};return b[new s.aM(l.overscaledZ,p,t.z,c,t.y).key]={backfilled:!1},b[new s.aM(l.overscaledZ,v,t.z,_,t.y).key]={backfilled:!1},t.y>0&&(b[new s.aM(l.overscaledZ,p,t.z,c,t.y-1).key]={backfilled:!1},b[new s.aM(l.overscaledZ,l.wrap,t.z,t.x,t.y-1).key]={backfilled:!1},b[new s.aM(l.overscaledZ,v,t.z,_,t.y-1).key]={backfilled:!1}),t.y+1<r&&(b[new s.aM(l.overscaledZ,p,t.z,c,t.y+1).key]={backfilled:!1},b[new s.aM(l.overscaledZ,l.wrap,t.z,t.x,t.y+1).key]={backfilled:!1},b[new s.aM(l.overscaledZ,v,t.z,_,t.y+1).key]={backfilled:!1}),b}},"raster-array":ol,geojson:class extends s.E{constructor(l,t,r,c){super(),this.id=l,this.type="geojson",this.minzoom=0,this.maxzoom=18,this.tileSize=512,this.isTileClipped=!0,this.reparseOverscaled=!0,this._loaded=!1,this.actor=r.getActor(),this.setEventedParent(c),this._data=t.data,this._options=s.h({},t),this._collectResourceTiming=t.collectResourceTiming,t.maxzoom!==void 0&&(this.maxzoom=t.maxzoom),t.minzoom!==void 0&&(this.minzoom=t.minzoom),t.type&&(this.type=t.type),t.attribution&&(this.attribution=t.attribution),this.promoteId=t.promoteId;const p=s.aj/this.tileSize;this.workerOptions=s.h({source:this.id,scope:this.scope,cluster:t.cluster||!1,geojsonVtOptions:{buffer:(t.buffer!==void 0?t.buffer:128)*p,tolerance:(t.tolerance!==void 0?t.tolerance:.375)*p,extent:s.aj,maxZoom:this.maxzoom,lineMetrics:t.lineMetrics||!1,generateId:t.generateId||!1},superclusterOptions:{maxZoom:t.clusterMaxZoom!==void 0?t.clusterMaxZoom:this.maxzoom-1,minPoints:Math.max(2,t.clusterMinPoints||2),extent:s.aj,radius:(t.clusterRadius!==void 0?t.clusterRadius:50)*p,log:!1,generateId:t.generateId||!1},clusterProperties:t.clusterProperties,filter:t.filter,dynamic:t.dynamic},t.workerOptions)}onAdd(l){this.map=l,this.setData(this._data)}setData(l){return this._data=l,this._updateWorkerData(),this}updateData(l){if(!this._options.dynamic)return this.fire(new s.z(new Error("Can't call updateData on a GeoJSON source with dynamic set to false.")));if(typeof l!="string"&&(l.type==="Feature"&&(l={type:"FeatureCollection",features:[l]}),l.type!=="FeatureCollection"))return this.fire(new s.z(new Error("Data to update should be a feature or a feature collection.")));if(this._coalesce&&typeof l!="string"&&typeof this._data!="string"&&this._data.type==="FeatureCollection"){const t=new Map;for(const r of this._data.features)t.set(r.id,r);for(const r of l.features)t.set(r.id,r);this._data.features=[...t.values()]}else this._data=l;return this._updateWorkerData(!0),this}getClusterExpansionZoom(l,t){return this.actor.send("geojson.getClusterExpansionZoom",{clusterId:l,source:this.id,scope:this.scope},t),this}getClusterChildren(l,t){return this.actor.send("geojson.getClusterChildren",{clusterId:l,source:this.id,scope:this.scope},t),this}getClusterLeaves(l,t,r,c){return this.actor.send("geojson.getClusterLeaves",{source:this.id,scope:this.scope,clusterId:l,limit:t,offset:r},c),this}_updateWorkerData(l=!1){if(this._pendingLoad)return void(this._coalesce=!0);this.fire(new s.A("dataloading",{dataType:"source"})),this._loaded=!1;const t=s.h({append:l},this.workerOptions);t.scope=this.scope;const r=this._data;typeof r=="string"?(t.request=this.map._requestManager.transformRequest(s.q.resolveURL(r),s.R.Source),t.request.collectResourceTiming=this._collectResourceTiming):t.data=JSON.stringify(r),this._pendingLoad=this.actor.send(`${this.type}.loadData`,t,((c,p)=>{if(this._loaded=!0,this._pendingLoad=null,c)this.fire(new s.z(c));else{const _={dataType:"source",sourceDataType:this._metadataFired?"content":"metadata"};this._collectResourceTiming&&p&&p.resourceTiming&&p.resourceTiming[this.id]&&(_.resourceTiming=p.resourceTiming[this.id]),l&&(this._partialReload=!0),this.fire(new s.A("data",_)),this._partialReload=!1,this._metadataFired=!0}this._coalesce&&(this._updateWorkerData(l),this._coalesce=!1)}))}loaded(){return this._loaded}reload(){const l=s.C(this.id,this.scope);this.map.style.clearSource(l),this._updateWorkerData()}loadTile(l,t){const r=l.actor?"reloadTile":"loadTile";l.actor=this.actor;const c=this.map.style?this.map.style.getLut(this.scope):null,p=c?{image:c.image.clone()}:null,_=this._partialReload,v={type:this.type,uid:l.uid,tileID:l.tileID,tileZoom:l.tileZoom,zoom:l.tileID.overscaledZ,maxZoom:this.maxzoom,tileSize:this.tileSize,source:this.id,lut:p,scope:this.scope,pixelRatio:s.q.devicePixelRatio,showCollisionBoxes:this.map.showCollisionBoxes,promoteId:this.promoteId,brightness:this.map.style&&this.map.style.getBrightness()||0,extraShadowCaster:l.isExtraShadowCaster,scaleFactor:this.map.getScaleFactor(),partial:_,worldview:this.map.getWorldview()};l.request=this.actor.send(r,v,((b,I)=>_&&!I?(l.state="loaded",t(null)):(delete l.request,l.destroy(),l.aborted?t(null):b?t(b):(l.loadVectorData(I,this.map.painter,r==="reloadTile"),t(null)))),void 0,r==="loadTile")}abortTile(l){l.request&&(l.request.cancel(),delete l.request),l.aborted=!0}unloadTile(l,t){this.actor.send("removeTile",{uid:l.uid,type:this.type,source:this.id,scope:this.scope}),l.destroy()}onRemove(l){this._pendingLoad&&this._pendingLoad.cancel()}serialize(){return s.h({},this._options,{type:this.type,data:this._data})}hasTransition(){return!1}},video:class extends s.aP{constructor(l,t,r,c){super(l,t,r,c),this.roundZoom=!0,this.type="video",this.options=t}load(){this._loaded=!1;const l=this.options;this.urls=[];for(const t of l.urls)this.urls.push(this.map._requestManager.transformRequest(t,s.R.Source).url);s.aQ(this.urls,((t,r)=>{this._loaded=!0,t?this.fire(new s.z(t)):r&&(this.video=r,this.video.loop=!0,this.video.setAttribute("playsinline",""),this.video.addEventListener("playing",(()=>{this.map.triggerRepaint()})),this.map&&this.video.play(),this._finishLoading())}))}pause(){this.video&&this.video.pause()}play(){this.video&&this.video.play()}seek(l){if(this.video){const t=this.video.seekable;l<t.start(0)||l>t.end(0)?this.fire(new s.z(new s.V(`sources.${this.id}`,null,`Playback for this video can be set only between the ${t.start(0)} and ${t.end(0)}-second mark.`))):this.video.currentTime=l}}getVideo(){return this.video}onAdd(l){this.map||(this.map=l,this.load(),this.video&&(this.video.play(),this.setCoordinates(this.coordinates)))}prepare(){if(Object.keys(this.tiles).length===0||this.video.readyState<2)return;const l=this.map.painter.context,t=l.gl;this.texture?this.video.paused||(this.texture.bind(t.LINEAR,t.CLAMP_TO_EDGE),t.texSubImage2D(t.TEXTURE_2D,0,0,0,t.RGBA,t.UNSIGNED_BYTE,this.video)):(this.texture=new s.T(l,this.video,t.RGBA8),this.texture.bind(t.LINEAR,t.CLAMP_TO_EDGE),this.width=this.video.videoWidth,this.height=this.video.videoHeight),this._prepareData(l)}serialize(){return{type:"video",urls:this.urls,coordinates:this.coordinates}}hasTransition(){return this.video&&!this.video.paused}},image:s.aP,model:class extends s.E{constructor(l,t,r,c){super(),this.id=l,this.type="model",this.models=[],this._loaded=!1,this._options=t}load(){const l=[];for(const t in this._options.models){const r=this._options.models[t],c=s.aS(this.map._requestManager.transformRequest(r.uri,s.R.Model).url).then((p=>{if(!p)return;const _=s.aT(p),v=new s.aU(t,r.position,r.orientation,_);v.computeBoundsAndApplyParent(),this.models.push(v)})).catch((p=>{this.fire(new s.z(new Error(`Could not load model ${t} from ${r.uri}: ${p.message}`)))}));l.push(c)}Promise.allSettled(l).then((()=>{this._loaded=!0,this.fire(new s.A("data",{dataType:"source",sourceDataType:"metadata"}))})).catch((t=>{this._loaded=!0,this.fire(new s.z(new Error(`Could not load models: ${t.message}`)))}))}onAdd(l){this.map=l,this.load()}hasTransition(){return!1}loaded(){return this._loaded}getModels(){return this.models}loadTile(l,t){}serialize(){return this._options}},"batched-model":class extends s.E{constructor(l,t,r,c){super(),this.type="batched-model",this.id=l,this.tileSize=512,this._options=t,this.tiles=this._options.tiles,this.maxzoom=t.maxzoom||19,this.minzoom=t.minzoom||0,this.roundZoom=!0,this.usedInConflation=!0,this.dispatcher=r,this.reparseOverscaled=!1,this.scheme="xyz",this._loaded=!1,this.setEventedParent(c)}onAdd(l){this.map=l,this.load()}reload(){this.cancelTileJSONRequest();const l=s.C(this.id,this.scope);this.load((()=>this.map.style.clearSource(l)))}cancelTileJSONRequest(){this._tileJSONRequest&&(this._tileJSONRequest.cancel(),this._tileJSONRequest=null)}load(l){this._loaded=!1,this.fire(new s.A("dataloading",{dataType:"source"}));const t=Array.isArray(this.map._language)?this.map._language.join():this.map._language,r=this.map.getWorldview();this._tileJSONRequest=us(this._options,this.map._requestManager,t,r,((c,p)=>{this._tileJSONRequest=null,this._loaded=!0,c?(t&&console.warn(`Ensure that your requested language string is a valid BCP-47 code or list of codes. Found: ${t}`),r&&r.length!==2&&console.warn(`Requested worldview strings must be a valid ISO alpha-2 code. Found: ${r}`),this.fire(new s.z(c))):p&&(s.h(this,p),p.bounds&&(this.tileBounds=new Ns(p.bounds,this.minzoom,this.maxzoom)),Gt(p.tiles,this.map._requestManager._customAccessToken),this.fire(new s.A("data",{dataType:"source",sourceDataType:"metadata"})),this.fire(new s.A("data",{dataType:"source",sourceDataType:"content"}))),l&&l(c)}))}hasTransition(){return!1}hasTile(l){return!this.tileBounds||this.tileBounds.contains(l.canonical)}loaded(){return this._loaded}loadTile(l,t){const r=this.map._requestManager.normalizeTileURL(l.tileID.canonical.url(this.tiles,this.scheme)),c={request:this.map._requestManager.transformRequest(r,s.R.Tile),data:void 0,uid:l.uid,tileID:l.tileID,tileZoom:l.tileZoom,zoom:l.tileID.overscaledZ,tileSize:this.tileSize*l.tileID.overscaleFactor(),type:this.type,source:this.id,scope:this.scope,showCollisionBoxes:this.map.showCollisionBoxes,isSymbolTile:l.isSymbolTile,brightness:this.map.style&&this.map.style.getBrightness()||0,pixelRatio:s.q.devicePixelRatio,promoteId:this.promoteId};if(l.actor&&l.state!=="expired")if(l.state==="loading")l.reloadCallback=t;else{if(l.buckets){const _=Object.values(l.buckets);for(const v of _)v.dirty=!0;return void(l.state="loaded")}l.request=l.actor.send("reloadTile",c,p.bind(this))}else l.actor=this.dispatcher.getActor(),l.request=l.actor.send("loadTile",c,p.bind(this),void 0,!0);function p(_,v){return l.aborted?t(null):_&&_.status!==404?t(_):(this.map._refreshExpiredTiles&&v&&l.setExpiryData(v),l.loadModelData(v,this.map.painter),l.state="loaded",void t(null))}}serialize(){return s.h({},this._options)}},canvas:class extends s.aP{constructor(l,t,r,c){super(l,t,r,c),t.coordinates?Array.isArray(t.coordinates)&&t.coordinates.length===4&&!t.coordinates.some((p=>!Array.isArray(p)||p.length!==2||p.some((_=>typeof _!="number"))))||this.fire(new s.z(new s.V(`sources.${l}`,null,'"coordinates" property must be an array of 4 longitude/latitude array pairs'))):this.fire(new s.z(new s.V(`sources.${l}`,null,'missing required property "coordinates"'))),t.animate&&typeof t.animate!="boolean"&&this.fire(new s.z(new s.V(`sources.${l}`,null,'optional "animate" property must be a boolean value'))),t.canvas?typeof t.canvas=="string"||t.canvas instanceof HTMLCanvasElement||this.fire(new s.z(new s.V(`sources.${l}`,null,'"canvas" must be either a string representing the ID of the canvas element from which to read, or an HTMLCanvasElement instance'))):this.fire(new s.z(new s.V(`sources.${l}`,null,'missing required property "canvas"'))),this.options=t,this.animate=t.animate===void 0||t.animate}load(){this._loaded=!0,this.canvas||(this.canvas=this.options.canvas instanceof HTMLCanvasElement?this.options.canvas:document.getElementById(this.options.canvas)),this.width=this.canvas.width,this.height=this.canvas.height,this._hasInvalidDimensions()?this.fire(new s.z(new Error("Canvas dimensions cannot be less than or equal to zero."))):(this.play=function(){this._playing=!0,this.map.triggerRepaint()},this.pause=function(){this._playing&&(this.prepare(),this._playing=!1)},this._finishLoading())}getCanvas(){return this.canvas}onAdd(l){this.map=l,this.load(),this.canvas&&this.animate&&this.play()}onRemove(l){this.pause()}prepare(){let l=!1;if(this.canvas.width!==this.width&&(this.width=this.canvas.width,l=!0),this.canvas.height!==this.height&&(this.height=this.canvas.height,l=!0),this._hasInvalidDimensions()||Object.keys(this.tiles).length===0)return;const t=this.map.painter.context;this.texture?!l&&!this._playing||this.texture instanceof s.aR||this.texture.update(this.canvas,{premultiply:!0}):this.texture=new s.T(t,this.canvas,t.gl.RGBA8,{premultiply:!0}),this._prepareData(t)}serialize(){return{type:"canvas",coordinates:this.coordinates}}hasTransition(){return this._playing}_hasInvalidDimensions(){for(const l of[this.canvas.width,this.canvas.height])if(isNaN(l)||l<=0)return!0;return!1}},custom:class extends s.E{constructor(l,t,r,c){super(),this.id=l,this.type="custom",this._dataType="raster",this._dispatcher=r,this._implementation=t,this.setEventedParent(c),this.scheme="xyz",this.minzoom=0,this.maxzoom=22,this.tileSize=512,this._loaded=!1,this.roundZoom=!0,this._implementation||this.fire(new s.z(new Error(`Missing implementation for ${this.id} custom source`))),this._implementation.loadTile||this.fire(new s.z(new Error(`Missing loadTile implementation for ${this.id} custom source`))),this._implementation.bounds&&(this.tileBounds=new Ns(this._implementation.bounds,this.minzoom,this.maxzoom)),t.update=this._update.bind(this),t.clearTiles=this._clearTiles.bind(this),t.coveringTiles=this._coveringTiles.bind(this),s.h(this,s.aF(t,["dataType","scheme","minzoom","maxzoom","tileSize","attribution","minTileCacheSize","maxTileCacheSize"]))}serialize(){return s.aF(this,["type","scheme","minzoom","maxzoom","tileSize","attribution"])}load(){this._loaded=!0,this.fire(new s.A("data",{dataType:"source",sourceDataType:"metadata"})),this.fire(new s.A("data",{dataType:"source",sourceDataType:"content"}))}loaded(){return this._loaded}onAdd(l){this.map=l,this._loaded=!1,this.fire(new s.A("dataloading",{dataType:"source"})),this._implementation.onAdd&&this._implementation.onAdd(l),this.load()}onRemove(l){this._implementation.onRemove&&this._implementation.onRemove(l)}hasTile(l){if(this._implementation.hasTile){const{x:t,y:r,z:c}=l.canonical;return this._implementation.hasTile({x:t,y:r,z:c})}return!this.tileBounds||this.tileBounds.contains(l.canonical)}loadTile(l,t){const{x:r,y:c,z:p}=l.tileID.canonical,_=new AbortController;l.request=Promise.resolve(this._implementation.loadTile({x:r,y:c,z:p},{signal:_.signal})).then((function(v){return delete l.request,l.aborted?(l.state="unloaded",t(null)):v===void 0?(l.state="errored",t(null)):v===null?(this.loadTileData(l,{width:this.tileSize,height:this.tileSize,data:null}),l.state="loaded",t(null)):(function(b){return b instanceof ImageData||b instanceof HTMLCanvasElement||b instanceof ImageBitmap||b instanceof HTMLImageElement})(v)?(this.loadTileData(l,v),l.state="loaded",void t(null)):(l.state="errored",t(new Error(`Can't infer data type for ${this.id}, only raster data supported at the moment`)))}).bind(this)).catch((v=>{v.name!=="AbortError"&&(l.state="errored",t(v))})),l.request.cancel=()=>_.abort()}loadTileData(l,t){l.setTexture(t,this.map.painter)}unloadTile(l,t){if(l.texture&&l.texture instanceof s.T?(l.destroy(!0),l.texture&&l.texture instanceof s.T&&this.map.painter.saveTileTexture(l.texture)):l.destroy(),this._implementation.unloadTile){const{x:r,y:c,z:p}=l.tileID.canonical;this._implementation.unloadTile({x:r,y:c,z:p})}t&&t()}abortTile(l,t){l.request&&l.request.cancel&&(l.request.cancel(),delete l.request),t&&t()}hasTransition(){return!1}_coveringTiles(){return this.map.transform.coveringTiles({tileSize:this.tileSize,minzoom:this.minzoom,maxzoom:this.maxzoom,roundZoom:this.roundZoom}).map((l=>({x:l.canonical.x,y:l.canonical.y,z:l.canonical.z})))}_clearTiles(){const l=s.C(this.id,this.scope);this.map.style.clearSource(l)}_update(){this.fire(new s.A("data",{dataType:"source",sourceDataType:"content"}))}}},Ll=function(l,t,r,c){const p=new tu[t.type](l,t,r,c);if(p.id!==l)throw new Error(`Expected Source id to be ${l} instead of ${p.id}`);return s.aV(["load","abort","unload","serialize","prepare"],p),p};function kl(l,t,r=""){return`${r}:${t.id||""}:${t.layer.id}:${(function(c){if("layerId"in c)return`layer:${c.layerId}`;{const{featuresetId:p,importId:_}=c;return`featureset:${p}${_?`:import:${_}`:""}`}})(l.target)}`}function al(l,t,r,c=""){if(l.uniqueFeatureID){const p=kl(l,t,c);if(r.has(p))return!0;r.add(p)}return!1}function zl(l,t,r,c,p=!1){const _=t.sourceCache.transform,v=t.sourceCache.tilesIn(l,t.has3DLayers,p);v.sort(So);const b=[];for(const I of v){const M=I.tile.queryRenderedFeatures(t,I,r,c,_,p);Object.keys(M).length&&b.push({wrappedTileID:I.tile.tileID.wrapped().key,queryResults:M})}return b.length===0?{}:(function(I){const M={},L={};for(const B of I){const F=B.queryResults,V=B.wrappedTileID,$=L[V]=L[V]||{};for(const H in F){const X=F[H],Z=$[H]=$[H]||{},te=M[H]=M[H]||[];for(const oe of X)Z[oe.featureIndex]||(Z[oe.featureIndex]=!0,te.push(oe))}}return M})(b)}function Jl(l,t,r,c,p,_){const v={},b=c.queryRenderedSymbols(l),I=[];for(const M of Object.keys(b).map(Number))I.push(p[M]);I.sort(So);for(const M of I){const L=M.featureIndex.lookupSymbolFeatures(b[M.bucketInstanceId],M.bucketIndex,M.sourceLayerIndex,t,r,_);for(const B in L){const F=v[B]=v[B]||[],V=L[B];V.sort((($,H)=>{const X=M.featureSortOrder;if(X){const Z=X.indexOf($.featureIndex);return X.indexOf(H.featureIndex)-Z}return H.featureIndex-$.featureIndex}));for(const $ of V)F.push($)}}return v}function ga(l,t){const r=l.getRenderableIds().map((_=>l.getTileByID(_))),c=[],p={};for(let _=0;_<r.length;_++){const v=r[_],b=v.tileID.canonical.key;p[b]||(p[b]=!0,v.querySourceFeatures(c,t))}return c}function So(l,t){const r=l.tileID,c=t.tileID;return r.overscaledZ-c.overscaledZ||r.canonical.y-c.canonical.y||r.wrap-c.wrap||r.canonical.x-c.canonical.x}function go(l,t){const r={};if(!t)return r;for(const c of l){const p=c.layerIds.map((_=>t.getLayer(_))).filter(Boolean);if(p.length!==0){c.layers=p,c.stateDependentLayerIds&&(c.stateDependentLayers=c.stateDependentLayerIds.map((_=>p.filter((v=>v.id===_))[0])));for(const _ of p)r[_.fqid]=c}}return r}const Vs=32,Ys=33,Ir=new Uint16Array(8184);for(let l=0;l<2046;l++){let t=l+2,r=0,c=0,p=0,_=0,v=0,b=0;for(1&t?p=_=v=Vs:r=c=b=Vs;(t>>=1)>1;){const M=r+p>>1,L=c+_>>1;1&t?(p=r,_=c,r=v,c=b):(r=p,c=_,p=v,_=b),v=M,b=L}const I=4*l;Ir[I+0]=r,Ir[I+1]=c,Ir[I+2]=p,Ir[I+3]=_}const lo=new Uint16Array(2178),Kn=new Uint8Array(1089),Va=new Uint16Array(1089);function ya(l){return l===0?-.03125:l===32?.03125:0}const Fl={type:2,extent:s.aj,loadGeometry:()=>[[new s.P(0,0),new s.P(s.aj+1,0),new s.P(s.aj+1,s.aj+1),new s.P(0,s.aj+1),new s.P(0,0)]]};class Ol{constructor(t,r,c,p,_,v){this.tileID=t,this.uid=s.a$(),this.uses=0,this.tileSize=r,this.tileZoom=c,this.buckets={},this.expirationTime=null,this.queryPadding=0,this.hasSymbolBuckets=!1,this.hasRTLText=!1,this.dependencies={},this.isRaster=_,p&&p.style&&(this._lastUpdatedBrightness=p.style.getBrightness()),this.expiredRequestCount=0,this.state="loading",p&&p.transform&&(this.projection=p.transform.projection),this.worldview=v}registerFadeDuration(t){const r=t+this.timeAdded;r<s.q.now()||this.fadeEndTime&&r<this.fadeEndTime||(this.fadeEndTime=r)}wasRequested(){return this.state==="errored"||this.state==="loaded"||this.state==="reloading"}get tileTransform(){return this._tileTransform||(this._tileTransform=s.aW(this.tileID.canonical,this.projection)),this._tileTransform}loadVectorData(t,r,c){if(this.unloadVectorData(),this.state="loaded",t){t.featureIndex&&(this.latestFeatureIndex=t.featureIndex,t.rawTileData?(this.latestRawTileData=t.rawTileData,this.latestFeatureIndex.rawTileData=t.rawTileData):this.latestRawTileData&&(this.latestFeatureIndex.rawTileData=this.latestRawTileData)),this.collisionBoxArray=t.collisionBoxArray,this.buckets=go(t.buckets,r.style),this.hasSymbolBuckets=!1;for(const p in this.buckets){const _=this.buckets[p];if(_ instanceof s.b1){if(this.hasSymbolBuckets=!0,!c)break;_.justReloaded=!0}}if(this.hasRTLText=!1,this.hasSymbolBuckets)for(const p in this.buckets){const _=this.buckets[p];if(_ instanceof s.b1&&_.hasRTLText){this.hasRTLText=!0,s.b2();break}}this.queryPadding=0;for(const p in this.buckets){const _=this.buckets[p],v=r.style.getOwnLayer(p);if(!v)continue;const b=v.queryRadius(_);this.queryPadding=Math.max(this.queryPadding,b)}t.imageAtlas&&(this.imageAtlas=t.imageAtlas),t.glyphAtlasImage&&(this.glyphAtlasImage=t.glyphAtlasImage),t.lineAtlas&&(this.lineAtlas=t.lineAtlas),this._lastUpdatedBrightness=t.brightness}else this.collisionBoxArray=new s.b0}unloadVectorData(){if(this.hasData()){for(const t in this.buckets)this.buckets[t].destroy();this.buckets={},this.imageAtlas&&(this.imageAtlas=null),this.lineAtlas&&(this.lineAtlas=null),this.imageAtlasTexture&&this.imageAtlasTexture.destroy(),this.glyphAtlasTexture&&this.glyphAtlasTexture.destroy(),this.lineAtlasTexture&&this.lineAtlasTexture.destroy(),this._tileBoundsBuffer&&(this._tileBoundsBuffer.destroy(),this._tileBoundsIndexBuffer.destroy(),this._tileBoundsSegments.destroy(),this._tileBoundsBuffer=null),this._tileDebugBuffer&&(this._tileDebugBuffer.destroy(),this._tileDebugSegments.destroy(),this._tileDebugBuffer=null),this._tileDebugIndexBuffer&&(this._tileDebugIndexBuffer.destroy(),this._tileDebugIndexBuffer=null),this._globeTileDebugBorderBuffer&&(this._globeTileDebugBorderBuffer.destroy(),this._globeTileDebugBorderBuffer=null),this._tileDebugTextBuffer&&(this._tileDebugTextBuffer.destroy(),this._tileDebugTextSegments.destroy(),this._tileDebugTextIndexBuffer.destroy(),this._tileDebugTextBuffer=null),this._globeTileDebugTextBuffer&&(this._globeTileDebugTextBuffer.destroy(),this._globeTileDebugTextBuffer=null),this.latestFeatureIndex=null,this.state="unloaded"}}loadModelData(t,r,c){t&&(t.resourceTiming&&(this.resourceTiming=t.resourceTiming),this.buckets=Object.assign({},this.buckets,go(t.buckets,r.style)),t.featureIndex&&(this.latestFeatureIndex=t.featureIndex))}getBucket(t){return this.buckets[t.fqid]}upload(t){for(const p in this.buckets){const _=this.buckets[p];_.uploadPending()&&_.upload(t)}const r=t.gl,c=this.imageAtlas;c&&!c.uploaded&&(this.imageAtlasTexture=new s.T(t,c.image,r.RGBA8,{useMipmap:!!c.patternPositions.size}),this.imageAtlas.uploaded=!0),this.glyphAtlasImage&&(this.glyphAtlasTexture=new s.T(t,this.glyphAtlasImage,r.R8),this.glyphAtlasImage=null),this.lineAtlas&&!this.lineAtlas.uploaded&&(this.lineAtlasTexture=new s.T(t,this.lineAtlas.image,r.R8),this.lineAtlas.uploaded=!0)}prepare(t,r,c){if(this.imageAtlas&&this.imageAtlasTexture&&this.imageAtlas.patchUpdatedImages(t,this.imageAtlasTexture,c),!r||!this.latestFeatureIndex||!this.latestFeatureIndex.rawTileData)return;const p=r.style.getBrightness();(this._lastUpdatedBrightness||p)&&(this._lastUpdatedBrightness&&p&&Math.abs(this._lastUpdatedBrightness-p)<.001||(this.updateBuckets(r,this._lastUpdatedBrightness!==p),this._lastUpdatedBrightness=p))}queryRenderedFeatures(t,r,c,p,_,v){if(!this.latestFeatureIndex||!this.latestFeatureIndex.rawTileData&&!this.latestFeatureIndex.is3DTile)return{};const b=(function(I,M){const L=s.bn([],[.5*I.width,.5*-I.height,1]);return s.bo(L,L,[1,-1,0]),s.az(L,L,I.calculateProjMatrix(M.toUnwrapped())),Float32Array.from(L)})(_,this.tileID);return this.latestFeatureIndex.query(t,{tilespaceGeometry:r,pixelPosMatrix:b,transform:p,availableImages:c,tileTransform:this.tileTransform,worldview:this.worldview})}querySourceFeatures(t,r){const c=this.latestFeatureIndex;if(!c||!c.rawTileData)return;const p=c.loadVTLayers(),_=r?r.sourceLayer:"",v=p._geojsonTileLayer||p[_];if(!v)return;const b=s.b3(r&&r.filter),{z:I,x:M,y:L}=this.tileID.canonical,B={z:I,x:M,y:L};for(let F=0;F<v.length;F++){const V=v.feature(F);if(b.needGeometry){const X=s.b4(V,!0);if(!b.filter(new s.aa(this.tileID.overscaledZ,{worldview:this.worldview}),X,this.tileID.canonical))continue}else if(!b.filter(new s.aa(this.tileID.overscaledZ,{worldview:this.worldview}),V))continue;const $=c.getId(V,_),H=new s.b5(V,I,M,L,$);H.tile=B,t.push(H)}}loaded(){return this.state==="loaded"||this.state==="errored"}hasData(){return this.state==="loaded"||this.state==="reloading"||this.state==="expired"}patternsLoaded(){return!!this.imageAtlas&&!!this.imageAtlas.patternPositions.size}setExpiryData(t){const r=this.expirationTime;if(t.cacheControl){const c=s.b6(t.cacheControl);c["max-age"]&&(this.expirationTime=Date.now()+1e3*c["max-age"])}else t.expires&&(this.expirationTime=new Date(t.expires).getTime());if(this.expirationTime){const c=Date.now();let p=!1;if(this.expirationTime>c)p=!1;else if(r)if(this.expirationTime<r)p=!0;else{const _=this.expirationTime-r;_?this.expirationTime=c+Math.max(_,3e4):p=!0}else p=!0;p?(this.expiredRequestCount++,this.state="expired"):this.expiredRequestCount=0}}getExpiryTimeout(){if(this.expirationTime)return this.expiredRequestCount?1e3*(1<<Math.min(this.expiredRequestCount-1,31)):Math.min(this.expirationTime-new Date().getTime(),Math.pow(2,31)-1)}refreshFeatureState(t){this.latestFeatureIndex&&(this.latestFeatureIndex.rawTileData||this.latestFeatureIndex.is3DTile)&&t&&this.updateBuckets(t)}updateBuckets(t,r){if(!this.latestFeatureIndex||!t.style)return;const c=this.latestFeatureIndex.loadVTLayers(),p=t.style.listImages(),_=t.style.getBrightness();for(const v in this.buckets){if(!t.style.hasLayer(v))continue;const b=this.buckets[v],I=b.layers[0],M=I.sourceLayer||"_geojsonTileLayer",L=c[M],B=t.style.getLayerSourceCache(I);let F={};B&&(F=B._state.getState(M,void 0));const V=this.imageAtlas?Object.fromEntries(this.imageAtlas.patternPositions):{},$=Object.keys(F).length>0&&!r;$&&!b.stateDependentLayers.length&&!r||b.update(F,L,p,V,$?b.stateDependentLayers:b.layers,r,_),(b instanceof s.b7||b instanceof s.b8)&&t._terrain&&t._terrain.enabled&&B&&b.uploadPending()&&t._terrain._clearRenderCacheForTile(B.id,this.tileID);const H=t&&t.style&&t.style.getOwnLayer(v);H&&(this.queryPadding=Math.max(this.queryPadding,H.queryRadius(b)))}}holdingForFade(){return this.symbolFadeHoldUntil!==void 0}symbolFadeFinished(){return!this.symbolFadeHoldUntil||this.symbolFadeHoldUntil<s.q.now()}clearFadeHold(){this.symbolFadeHoldUntil=void 0}setHoldDuration(t){this.symbolFadeHoldUntil=s.q.now()+t}setTexture(t,r){const c=r.context,p=c.gl;this.texture=this.texture||r.getTileTexture(t.width),this.texture&&this.texture instanceof s.T?this.texture.update(t):(this.texture=new s.T(c,t,p.RGBA8,{useMipmap:!0}),this.texture.bind(p.LINEAR,p.CLAMP_TO_EDGE))}setDependencies(t,r){const c={};for(const p of r)c[p]=!0;this.dependencies[t]=c}hasDependency(t,r){for(const c of t){const p=this.dependencies[c];if(p){for(const _ of r)if(p[_])return!0}}return!1}clearQueryDebugViz(){}_makeDebugTileBoundsBuffers(t,r){if(!r||r.name==="mercator"||this._tileDebugBuffer)return;const c=s.b9(Fl,this.tileID.canonical,this.tileTransform)[0],p=new s.ba,_=new s.bb;for(let v=0;v<c.length;v++){const{x:b,y:I}=c[v];p.emplaceBack(b,I),_.emplaceBack(v)}_.emplaceBack(0),this._tileDebugIndexBuffer=t.createIndexBuffer(_),this._tileDebugBuffer=t.createVertexBuffer(p,s.bc.members),this._tileDebugSegments=s.bd.simpleSegment(0,0,p.length,_.length)}_makeTileBoundsBuffers(t,r){if(this._tileBoundsBuffer||!r||r.name==="mercator")return;const c=s.b9(Fl,this.tileID.canonical,this.tileTransform)[0];let p,_;if(this.isRaster){const v=(function(b,I){const M=s.aW(b,I),L=Math.pow(2,b.z);for(let X=0;X<Ys;X++)for(let Z=0;Z<Ys;Z++){const te=s.aX((b.x+(Z+ya(Z))/Vs)/L),oe=s.aY((b.y+(X+ya(X))/Vs)/L),le=I.project(te,oe),pe=X*Ys+Z;lo[2*pe+0]=Math.round((le.x*M.scale-M.x)*s.aj),lo[2*pe+1]=Math.round((le.y*M.scale-M.y)*s.aj)}Kn.fill(0),Va.fill(0);for(let X=2045;X>=0;X--){const Z=4*X,te=Ir[Z+0],oe=Ir[Z+1],le=Ir[Z+2],pe=Ir[Z+3],ye=te+le>>1,we=oe+pe>>1,me=ye+we-oe,_e=we+te-ye,ge=oe*Ys+te,Be=pe*Ys+le,Ce=we*Ys+ye,nt=Math.hypot((lo[2*ge+0]+lo[2*Be+0])/2-lo[2*Ce+0],(lo[2*ge+1]+lo[2*Be+1])/2-lo[2*Ce+1])>=16;Kn[Ce]=Kn[Ce]||(nt?1:0),X<1022&&(Kn[Ce]=Kn[Ce]||Kn[(oe+_e>>1)*Ys+(te+me>>1)]||Kn[(pe+_e>>1)*Ys+(le+me>>1)])}const B=new s.aZ,F=new s.a_;let V=0;function $(X,Z){const te=Z*Ys+X;return Va[te]===0&&(B.emplaceBack(lo[2*te+0],lo[2*te+1],X*s.aj/Vs,Z*s.aj/Vs),Va[te]=++V),Va[te]-1}function H(X,Z,te,oe,le,pe){const ye=X+te>>1,we=Z+oe>>1;if(Math.abs(X-le)+Math.abs(Z-pe)>1&&Kn[we*Ys+ye])H(le,pe,X,Z,ye,we),H(te,oe,le,pe,ye,we);else{const me=$(X,Z),_e=$(te,oe),ge=$(le,pe);F.emplaceBack(me,_e,ge)}}return H(0,0,Vs,Vs,Vs,0),H(Vs,Vs,0,0,0,Vs),{vertices:B,indices:F}})(this.tileID.canonical,r);p=v.vertices,_=v.indices}else{p=new s.aZ,_=new s.a_;for(const{x:b,y:I}of c)p.emplaceBack(b,I,0,0);const v=s.be(p.int16.subarray(0,4*p.length),void 0,4);for(let b=0;b<v.length;b+=3)_.emplaceBack(v[b],v[b+1],v[b+2])}this._tileBoundsBuffer=t.createVertexBuffer(p,s.bf.members),this._tileBoundsIndexBuffer=t.createIndexBuffer(_),this._tileBoundsSegments=s.bd.simpleSegment(0,0,p.length,_.length)}_makeGlobeTileDebugBuffers(t,r){const c=r.projection;if(!c||c.name!=="globe"||r.freezeTileCoverage)return;const p=this.tileID.canonical,_=s.bg(p,r),v=s.bh(_),b=s.ah(r.zoom);let I;b>0&&(I=s.bi(new Float64Array(16),r.globeMatrix)),this._makeGlobeTileDebugBorderBuffer(t,p,r,v,I,b),this._makeGlobeTileDebugTextBuffer(t,p,r,v,I,b)}_globePoint(t,r,c,p,_,v,b){let I=s.bj(t,r,c);if(v){const M=1<<c.z,L=s.aD(p.center.lng),B=s.aH(p.center.lat),F=(c.x+.5)/M-L;let V=0;F>.5?V=-1:F<-.5&&(V=1);let $=(t/s.aj+c.x)/M+V,H=(r/s.aj+c.y)/M;$=($-L)*p._pixelsPerMercatorPixel+L,H=(H-B)*p._pixelsPerMercatorPixel+B;const X=[$*p.worldSize,H*p.worldSize,0];s.ad(X,X,v),I=s.bk(I,X,b)}return s.ad(I,I,_)}_makeGlobeTileDebugBorderBuffer(t,r,c,p,_,v){const b=new s.ba,I=new s.bb,M=new s.bl,L=(F,V,$,H,X)=>{const Z=($-F)/(X-1),te=(H-V)/(X-1),oe=b.length;for(let le=0;le<X;le++){const pe=F+le*Z,ye=V+le*te;b.emplaceBack(pe,ye);const we=this._globePoint(pe,ye,r,c,p,_,v);M.emplaceBack(we[0],we[1],we[2]),I.emplaceBack(oe+le)}},B=s.aj;L(0,0,B,0,16),L(B,0,B,B,16),L(B,B,0,B,16),L(0,B,0,0,16),this._tileDebugIndexBuffer=t.createIndexBuffer(I),this._tileDebugBuffer=t.createVertexBuffer(b,s.bc.members),this._globeTileDebugBorderBuffer=t.createVertexBuffer(M,s.bm.members),this._tileDebugSegments=s.bd.simpleSegment(0,0,b.length,I.length)}_makeGlobeTileDebugTextBuffer(t,r,c,p,_,v){const b=s.aj/4,I=new s.ba,M=new s.a_,L=new s.bl,B=25;M.reserve(32),I.reserve(B),L.reserve(B);const F=(V,$)=>B*V+$;for(let V=0;V<B;V++){const $=V*b;for(let H=0;H<B;H++){const X=H*b;I.emplaceBack(X,$);const Z=this._globePoint(X,$,r,c,p,_,v);L.emplaceBack(Z[0],Z[1],Z[2])}}for(let V=0;V<4;V++)for(let $=0;$<4;$++){const H=F(V,$),X=F(V,$+1),Z=F(V+1,$),te=F(V+1,$+1);M.emplaceBack(H,X,Z),M.emplaceBack(Z,X,te)}this._tileDebugTextIndexBuffer=t.createIndexBuffer(M),this._tileDebugTextBuffer=t.createVertexBuffer(I,s.bc.members),this._globeTileDebugTextBuffer=t.createVertexBuffer(L,s.bm.members),this._tileDebugTextSegments=s.bd.simpleSegment(0,0,B,32)}destroy(t=!1){for(const r in this.buckets)this.buckets[r].destroy();this.buckets={},this.imageAtlas&&(this.imageAtlas=null),this.lineAtlas&&(this.lineAtlas=null),this.imageAtlasTexture&&(this.imageAtlasTexture.destroy(),delete this.imageAtlasTexture),this.glyphAtlasTexture&&(this.glyphAtlasTexture.destroy(),delete this.glyphAtlasTexture),this.lineAtlasTexture&&(this.lineAtlasTexture.destroy(),delete this.lineAtlasTexture),this._tileBoundsBuffer&&(this._tileBoundsBuffer.destroy(),this._tileBoundsIndexBuffer.destroy(),this._tileBoundsSegments.destroy(),this._tileBoundsBuffer=null),this._tileDebugBuffer&&(this._tileDebugBuffer.destroy(),this._tileDebugSegments.destroy(),this._tileDebugBuffer=null),this._tileDebugIndexBuffer&&(this._tileDebugIndexBuffer.destroy(),this._tileDebugIndexBuffer=null),this._globeTileDebugBorderBuffer&&(this._globeTileDebugBorderBuffer.destroy(),this._globeTileDebugBorderBuffer=null),this._tileDebugTextBuffer&&(this._tileDebugTextBuffer.destroy(),this._tileDebugTextSegments.destroy(),this._tileDebugTextIndexBuffer.destroy(),this._tileDebugTextBuffer=null),this._globeTileDebugTextBuffer&&(this._globeTileDebugTextBuffer.destroy(),this._globeTileDebugTextBuffer=null),!t&&this.texture&&this.texture instanceof s.T&&(this.texture.destroy(),delete this.texture),this.hillshadeFBO&&(this.hillshadeFBO.destroy(),delete this.hillshadeFBO),this.dem&&delete this.dem,this.neighboringTiles&&delete this.neighboringTiles,this.demTexture&&(this.demTexture.destroy(),delete this.demTexture),this.rasterParticleState&&(this.rasterParticleState.destroy(),delete this.rasterParticleState),this.latestFeatureIndex=null,this.state="unloaded"}}s.bp.setPbf(s.bq);class ec extends Ol{constructor(t,r,c,p,_){super(t,r,c,p,_),this._workQueuePerLayer=new Map,this._fetchQueuePerLayer=new Map,this._isHeaderLoaded=!1,this.textureDescriptorPerLayer=new Map,this.texturePerLayer=new Map}getLayers(){return this._mrt?Object.values(this._mrt.layers):[]}getLayer(t){return this._mrt&&this._mrt.getLayer(t)}setTexturePerLayer(t,r,c){const p=c.context,_=p.gl;let v=this.texturePerLayer.get(t)||c.getTileTexture(r.width);v&&v instanceof s.T?v.update(r,{premultiply:!1}):v=new s.T(p,r,_.RGBA8,{premultiply:!1}),this.texturePerLayer.has(t)||this.texturePerLayer.set(t,v)}flushQueues(t){const r=this._workQueuePerLayer.get(t)||[],c=this._fetchQueuePerLayer.get(t)||[];for(;r.length;)r.pop()();for(;c.length;)c.pop()()}flushAllQueues(){for(const t of this._workQueuePerLayer.keys()){const r=this._workQueuePerLayer.get(t)||[];for(;r.length;)r.pop()()}for(const t of this._fetchQueuePerLayer.keys()){const r=this._fetchQueuePerLayer.get(t)||[];for(;r.length;)r.pop()()}}fetchHeader(t=16384,r){const c=this._mrt=new s.bp(30),p=Object.assign({},this.requestParams,{headers:{Range:"bytes=0-"+(t-1)}});return this.entireBuffer=null,this.request=s.br(p,((_,v,b,I)=>{if(_)r(_);else try{const M=c.getHeaderLength(v);if(M>t)return void(this.request=this.fetchHeader(M,r));c.parseHeader(v),this._isHeaderLoaded=!0;let L=0;for(const B of Object.values(c.layers))L=Math.max(L,B.dataIndex[B.dataIndex.length-1].lastByte);v.byteLength>=L&&(this.entireBuffer=v),r(null,this.entireBuffer||v,b,I)}catch(M){r(M)}})),this.request}fetchBand(t,r,c,p){const _=this._mrt;if(!this._isHeaderLoaded||!_)return void p(new Error("Tile header is not ready"));const v=this.actor;if(!v)return void p(new Error("Can't fetch tile band without an actor"));let b;const I=(F,V)=>{if(b.complete(F,V),F)return void p(F);this.updateTextureDescriptor(t,r,c);const $=this.textureDescriptorPerLayer.get(r);p(null,$&&$.img)},M=(F,V)=>{if(F)return p(F);const $=v.send("decodeRasterArray",{type:"raster-array",source:this.source,scope:this.scope,tileID:this.tileID,uid:this.uid,buffer:V,task:b},I,void 0,!0),H=this._workQueuePerLayer.get(r)||[];H.push((()=>{$&&$.cancel(),b.cancel()})),this._workQueuePerLayer.has(r)||this._workQueuePerLayer.set(r,H)},L=_.getLayer(t);if(!L)return void p(new Error(`Unknown sourceLayer "${t}"`));if(L.hasDataForBand(c)){this.updateTextureDescriptor(t,r,c);const F=this.textureDescriptorPerLayer.get(r);return void p(null,F?F.img:null)}const B=L.getDataRange([c]);if(b=_.createDecodingTask(B),!b||b.tasks.length)if(this.flushQueues(r),this.entireBuffer)M(null,this.entireBuffer.slice(B.firstByte,B.lastByte+1));else{const F=Object.assign({},this.requestParams,{headers:{Range:`bytes=${B.firstByte}-${B.lastByte}`}}),V=s.br(F,M),$=this._fetchQueuePerLayer.get(r)||[];$.push((()=>{V.cancel(),b.cancel()})),this._fetchQueuePerLayer.has(r)||this._fetchQueuePerLayer.set(r,$)}else p(null)}updateNeeded(t,r){return(!this.textureDescriptorPerLayer.get(t)||this.textureDescriptorPerLayer.get(t).band!==r)&&this.state!=="errored"}updateTextureDescriptor(t,r,c){if(!this._mrt)return;const p=this._mrt.getLayer(t);if(!p||!p.hasBand(c)||!p.hasDataForBand(c))return;const{bytes:_,tileSize:v,buffer:b,offset:I,scale:M}=p.getBandView(c),L=v+2*b,B=new s.r({width:L,height:L},_),F=this.texturePerLayer.get(r);F&&F instanceof s.T&&F.update(B,{premultiply:!1}),this.textureDescriptorPerLayer.set(r,{layer:t,band:c,img:B,buffer:b,offset:I,tileSize:v,format:p.pixelFormat,mix:[M,256*M,65536*M,16777216*M]})}destroy(t=!1){if(super.destroy(t),delete this._mrt,!t)for(const r of this.texturePerLayer.values())r&&r instanceof s.T&&r.destroy();this.texturePerLayer.clear(),this.textureDescriptorPerLayer.clear(),this.fbo&&(this.fbo.destroy(),delete this.fbo),delete this.request,delete this.requestParams,this._isHeaderLoaded=!1}}class ju{constructor(t,r){this.max=t,this.onRemove=r,this.reset()}reset(){for(const t in this.data)for(const r of this.data[t])r.timeout&&clearTimeout(r.timeout),this.onRemove(r.value);return this.data={},this.order=[],this}add(t,r,c){const p=t.wrapped().key;this.data[p]===void 0&&(this.data[p]=[]);const _={value:r,timeout:void 0};if(c!==void 0&&(_.timeout=setTimeout((()=>{this.remove(t,_)}),c)),this.data[p].push(_),this.order.push(p),this.order.length>this.max){const v=this._getAndRemoveByKey(this.order[0]);v&&this.onRemove(v)}return this}has(t){return t.wrapped().key in this.data}getAndRemove(t){return this.has(t)?this._getAndRemoveByKey(t.wrapped().key):null}_getAndRemoveByKey(t){const r=this.data[t].shift();return r.timeout&&clearTimeout(r.timeout),this.data[t].length===0&&delete this.data[t],this.order.splice(this.order.indexOf(t),1),r.value}getByKey(t){const r=this.data[t];return r?r[0].value:null}get(t){return this.has(t)?this.data[t.wrapped().key][0].value:null}remove(t,r){if(!this.has(t))return this;const c=t.wrapped().key,p=r===void 0?0:this.data[c].indexOf(r),_=this.data[c][p];return this.data[c].splice(p,1),_.timeout&&clearTimeout(_.timeout),this.data[c].length===0&&delete this.data[c],this.onRemove(_.value),this.order.splice(this.order.indexOf(c),1),this}setMaxSize(t){for(this.max=t;this.order.length>this.max;){const r=this._getAndRemoveByKey(this.order[0]);r&&this.onRemove(r)}return this}filter(t){const r=[];for(const c in this.data)for(const p of this.data[c])t(p.value)||r.push(p);for(const c of r)this.remove(c.value.tileID,c)}}class iu{constructor(){this.state={},this.stateChanges={},this.deletedStates={}}updateState(t,r,c){const p=String(r);if(this.stateChanges[t]=this.stateChanges[t]||{},this.stateChanges[t][p]=this.stateChanges[t][p]||{},s.h(this.stateChanges[t][p],c),this.deletedStates[t]===null){this.deletedStates[t]={};for(const _ in this.state[t])_!==p&&(this.deletedStates[t][_]=null)}else if(this.deletedStates[t]&&this.deletedStates[t][p]===null){this.deletedStates[t][p]={};for(const _ in this.state[t][p])c[_]||(this.deletedStates[t][p][_]=null)}else for(const _ in c)this.deletedStates[t]&&this.deletedStates[t][p]&&this.deletedStates[t][p][_]===null&&delete this.deletedStates[t][p][_]}removeFeatureState(t,r,c){if(this.deletedStates[t]===null)return;const p=String(r);if(this.deletedStates[t]=this.deletedStates[t]||{},c&&r!==void 0)this.deletedStates[t][p]!==null&&(this.deletedStates[t][p]=this.deletedStates[t][p]||{},this.deletedStates[t][p][c]=null);else if(r!==void 0)if(this.stateChanges[t]&&this.stateChanges[t][p])for(c in this.deletedStates[t][p]={},this.stateChanges[t][p])this.deletedStates[t][p][c]=null;else this.deletedStates[t][p]=null;else this.deletedStates[t]=null}getState(t,r){const c=this.state[t]||{},p=this.stateChanges[t]||{},_=this.deletedStates[t];if(_===null)return{};if(r!==void 0){const b=String(r),I=s.h({},c[b],p[b]);if(_){const M=_[r];if(M===null)return{};for(const L in M)delete I[L]}return I}const v=s.h({},c,p);if(_)for(const b in _)delete v[b];return v}initializeTileState(t,r){t.refreshFeatureState(r)}coalesceChanges(t,r){const c={};for(const p in this.stateChanges){this.state[p]=this.state[p]||{};const _={};for(const v in this.stateChanges[p])this.state[p][v]||(this.state[p][v]={}),s.h(this.state[p][v],this.stateChanges[p][v]),_[v]=this.state[p][v];c[p]=_}for(const p in this.deletedStates){this.state[p]=this.state[p]||{};const _={};if(this.deletedStates[p]===null)for(const v in this.state[p])_[v]={},this.state[p][v]={};else for(const v in this.deletedStates[p]){if(this.deletedStates[p][v]===null)this.state[p][v]={};else if(this.state[p][v])for(const b of Object.keys(this.deletedStates[p][v]))delete this.state[p][v][b];_[v]=this.state[p][v]}c[p]=c[p]||{},s.h(c[p],_)}if(this.stateChanges={},this.deletedStates={},Object.keys(c).length!==0)for(const p in t)t[p].refreshFeatureState(r)}}class ys extends s.E{constructor(t,r,c){super(),this.id=t,this._onlySymbols=c,r.on("data",(p=>{p.dataType==="source"&&p.sourceDataType==="metadata"&&(this._sourceLoaded=!0),this._sourceLoaded&&!this._paused&&p.dataType==="source"&&p.sourceDataType==="content"&&(this.reload(),this.transform&&this.update(this.transform))})),r.on("error",(()=>{this._sourceErrored=!0})),this._source=r,this._tiles={},this._cache=new ju(0,this._unloadTile.bind(this)),this._timers={},this._cacheTimers={},this._minTileCacheSize=r.minTileCacheSize,this._maxTileCacheSize=r.maxTileCacheSize,this._loadedParentTiles={},this.castsShadows=!1,this.tileCoverLift=0,this._coveredTiles={},this._shadowCasterTiles={},this._state=new iu,this._isRaster=this._source.type==="raster"||this._source.type==="raster-dem"||this._source.type==="raster-array"||this._source.type==="custom"&&this._source._dataType==="raster"}onAdd(t){this.map=t,this._minTileCacheSize=this._minTileCacheSize===void 0&&t?t._minTileCacheSize:this._minTileCacheSize,this._maxTileCacheSize=this._maxTileCacheSize===void 0&&t?t._maxTileCacheSize:this._maxTileCacheSize}loaded(){if(this._sourceErrored)return!0;if(!this._sourceLoaded||!this._source.loaded())return!1;for(const t in this._tiles)if(!this._tiles[t].loaded())return!1;return!0}getSource(){return this._source}pause(){this._paused=!0}resume(){if(!this._paused)return;const t=this._shouldReloadOnResume;this._paused=!1,this._shouldReloadOnResume=!1,t&&this.reload(),this.transform&&this.update(this.transform)}_loadTile(t,r){return t.isSymbolTile=this._onlySymbols,t.isExtraShadowCaster=this._shadowCasterTiles[t.tileID.key],this._source.loadTile(t,r)}_unloadTile(t){if(this._source.unloadTile)return this._source.unloadTile(t)}_abortTile(t){if(this._source.abortTile)return this._source.abortTile(t)}serialize(){return this._source.serialize()}prepare(t){this._source.prepare&&this._source.prepare(),this._state.coalesceChanges(this._tiles,this.map?this.map.painter:null);for(const r in this._tiles){const c=this._tiles[r];c.upload(t),c.prepare(this.map.style.imageManager,this.map?this.map.painter:null,this._source.scope)}}getIds(){return Object.values(this._tiles).map((t=>t.tileID)).sort(bs).map((t=>t.key))}getRenderableIds(t,r){const c=[];for(const p in this._tiles)this._isIdRenderable(+p,t,r)&&c.push(this._tiles[p]);return t?c.sort(((p,_)=>{const v=p.tileID,b=_.tileID,I=new s.P(v.canonical.x,v.canonical.y)._rotate(this.transform.angle),M=new s.P(b.canonical.x,b.canonical.y)._rotate(this.transform.angle);return v.overscaledZ-b.overscaledZ||M.y-I.y||M.x-I.x})).map((p=>p.tileID.key)):c.map((p=>p.tileID)).sort(bs).map((p=>p.key))}hasRenderableParent(t){const r=this.findLoadedParent(t,0);return!!r&&this._isIdRenderable(r.tileID.key)}_isIdRenderable(t,r,c){return this._tiles[t]&&this._tiles[t].hasData()&&!this._coveredTiles[t]&&(r||!this._tiles[t].holdingForFade())&&(c||!this._shadowCasterTiles[t])}reload(){if(this._paused)this._shouldReloadOnResume=!0;else{this._cache.reset();for(const t in this._tiles)this._tiles[t].state!=="errored"&&this._reloadTile(+t,"reloading")}}_reloadTile(t,r){const c=this._tiles[t];c&&(c.state!=="loading"&&(c.state=r),this._loadTile(c,this._tileLoaded.bind(this,c,t,r)))}_tileLoaded(t,r,c,p){if(p)if(t.state="errored",p.status!==404)this._source.fire(new s.z(p,{tile:t}));else{if(this._source.fire(new s.A("data",{dataType:"source",sourceDataType:"error",sourceId:this._source.id,tile:t})),!(t.tileID.key in this._loadedParentTiles))return;if(this._source.type==="raster-dem"&&this.usedForTerrain&&this.map.painter.terrain){const _=this.map.painter.terrain;this.update(this.transform,_.getScaledDemTileSize(),!0),_.resetTileLookupCache(this.id)}else this.update(this.transform)}else t.timeAdded=s.q.now(),c==="expired"&&(t.refreshedUponExpiration=!0),this._setTileReloadTimer(r,t),this._source.type==="raster-dem"&&t.dem&&this._backfillDEM(t),this._state.initializeTileState(t,this.map?this.map.painter:null),this._source.fire(new s.A("data",{dataType:"source",tile:t,coord:t.tileID,sourceCacheId:this.id}))}_backfillDEM(t){const r=this.getRenderableIds();for(let p=0;p<r.length;p++){const _=r[p];if(t.neighboringTiles&&t.neighboringTiles[_]){const v=this.getTileByID(_);c(t,v),c(v,t)}}function c(p,_){if(!p.dem||p.dem.borderReady)return;p.needsHillshadePrepare=!0,p.needsDEMTextureUpload=!0;let v=_.tileID.canonical.x-p.tileID.canonical.x;const b=_.tileID.canonical.y-p.tileID.canonical.y,I=Math.pow(2,p.tileID.canonical.z),M=_.tileID.key;v===0&&b===0||Math.abs(b)>1||(Math.abs(v)>1&&(Math.abs(v+I)===1?v+=I:Math.abs(v-I)===1&&(v-=I)),_.dem&&p.dem&&(p.dem.backfillBorder(_.dem,v,b),p.neighboringTiles&&p.neighboringTiles[M]&&(p.neighboringTiles[M].backfilled=!0)))}}getTile(t){return this.getTileByID(t.key)}getTileByID(t){return this._tiles[t]}_retainLoadedChildren(t,r,c,p){for(const _ in this._tiles){let v=this._tiles[_];if(p[_]||!v.hasData()||v.tileID.overscaledZ<=r||v.tileID.overscaledZ>c)continue;let b=v.tileID;for(;v&&v.tileID.overscaledZ>r+1;){const M=v.tileID.scaledTo(v.tileID.overscaledZ-1);v=this._tiles[M.key],v&&v.hasData()&&(b=M)}let I=b;for(;I.overscaledZ>r;)if(I=I.scaledTo(I.overscaledZ-1),t[I.key]){p[b.key]=b;break}}}findLoadedParent(t,r){if(t.key in this._loadedParentTiles){const c=this._loadedParentTiles[t.key];return c&&c.tileID.overscaledZ>=r?c:null}for(let c=t.overscaledZ-1;c>=r;c--){const p=t.scaledTo(c),_=this._getLoadedTile(p);if(_)return _}}_getLoadedTile(t){const r=this._tiles[t.key];return r&&r.hasData()?r:this._cache.getByKey(this._source.reparseOverscaled?t.wrapped().key:t.canonical.key)}updateCacheSize(t,r){r=r||this._source.tileSize;const c=Math.ceil(t.width/r)+1,p=Math.ceil(t.height/r)+1,_=Math.floor(c*p*5),v=typeof this._minTileCacheSize=="number"?Math.max(this._minTileCacheSize,_):_,b=typeof this._maxTileCacheSize=="number"?Math.min(this._maxTileCacheSize,v):v;this._cache.setMaxSize(b)}handleWrapJump(t){const r=Math.round((t-(this._prevLng===void 0?t:this._prevLng))/360);if(this._prevLng=t,r){const c={};for(const p in this._tiles){const _=this._tiles[p];_.tileID=_.tileID.unwrapTo(_.tileID.wrap+r),c[_.tileID.key]=_}this._tiles=c;for(const p in this._timers)clearTimeout(this._timers[p]),delete this._timers[p];for(const p in this._tiles)this._setTileReloadTimer(+p,this._tiles[p])}}update(t,r,c,p,_){if(this.transform=t,!this._sourceLoaded||this._paused||this.transform.freezeTileCoverage||this.usedForTerrain&&!c)return;this.updateCacheSize(t,r),this.transform.projection.name!=="globe"&&this.handleWrapJump(this.transform.center.lng),this._shadowCasterTiles={},this._coveredTiles={};const v=this._source.type==="batched-model";let b,I=this._source.maxzoom;const M=this.map&&this.map.painter?this.map.painter._terrain:null;if(M&&M.sourceCache===this&&M.attenuationRange()){const F=M.attenuationRange()[0],V=Math.floor(F)-Math.log2(M.getDemUpscale());I>V&&(I=V)}if(this.used||this.usedForTerrain){if(this._source.tileID)b=t.getVisibleUnwrappedCoordinates(this._source.tileID).map((F=>new s.aM(F.canonical.z,F.wrap,F.canonical.z,F.canonical.x,F.canonical.y)));else if(this.tileCoverLift!==0){const F=t.clone();F.tileCoverLift=this.tileCoverLift,b=F.coveringTiles({tileSize:r||this._source.tileSize,minzoom:this._source.minzoom,maxzoom:I,roundZoom:this._source.roundZoom&&!c,reparseOverscaled:this._source.reparseOverscaled,isTerrainDEM:this.usedForTerrain,calculateQuadrantVisibility:v}),this._source.minzoom<=1&&t.projection.name==="globe"&&(b.push(new s.aM(1,0,1,0,0)),b.push(new s.aM(1,0,1,1,0)),b.push(new s.aM(1,0,1,0,1)),b.push(new s.aM(1,0,1,1,1)))}else if(b=t.coveringTiles({tileSize:r||this._source.tileSize,minzoom:this._source.minzoom,maxzoom:I,roundZoom:this._source.roundZoom&&!c,reparseOverscaled:this._source.reparseOverscaled,isTerrainDEM:this.usedForTerrain,calculateQuadrantVisibility:v}),this._source.hasTile){const F=this._source.hasTile.bind(this._source);b=b.filter((V=>F(V)))}}else b=[];if(b.length>0&&this.transform.projection.name!=="globe"&&!this.usedForTerrain&&!Uo(this._source.type)){const F=t.coveringZoomLevel({tileSize:r||this._source.tileSize,roundZoom:this._source.roundZoom&&!c}),V=Math.min(F,this._source.maxzoom);if(v){const $=t.extendTileCover(b,V);for(const H of $)b.push(H)}else if(_){const $=t.extendTileCoverToNearPlane(b,this.transform.getFrustum(V),V);for(const H of $)b.push(H)}else if(this.castsShadows&&p){const $=t.extendTileCover(b,V,p);for(const H of $)this._shadowCasterTiles[H.key]=!0,b.push(H)}}const L=this._updateRetainedTiles(b);if(Uo(this._source.type)&&b.length!==0){const F={},V={},$=Object.keys(L);for(const X of $){const Z=L[X],te=this._tiles[X];if(!te||te.fadeEndTime&&te.fadeEndTime<=s.q.now())continue;const oe=this.findLoadedParent(Z,Math.max(Z.overscaledZ-ys.maxOverzooming,this._source.minzoom));oe&&(this._addTile(oe.tileID),F[oe.tileID.key]=oe.tileID),V[X]=Z}const H=b[b.length-1].overscaledZ;for(const X in this._tiles){const Z=this._tiles[X];if(L[X]||!Z.hasData())continue;let te=Z.tileID;for(;te.overscaledZ>H;){te=te.scaledTo(te.overscaledZ-1);const oe=this._tiles[te.key];if(oe&&oe.hasData()&&V[te.key]){L[X]=Z.tileID;break}}}for(const X in F)L[X]||(this._coveredTiles[X]=!0,L[X]=F[X])}for(const F in L)this._tiles[F].clearFadeHold();const B=s.bs(this._tiles,L);for(const F of B){const V=this._tiles[F];V.hasSymbolBuckets&&!V.holdingForFade()?V.setHoldDuration(this.map._fadeDuration):V.hasSymbolBuckets&&!V.symbolFadeFinished()||this._removeTile(+F)}this._updateLoadedParentTileCache(),this._onlySymbols&&this._source.afterUpdate&&this._source.afterUpdate()}releaseSymbolFadeTiles(){for(const t in this._tiles)this._tiles[t].holdingForFade()&&this._removeTile(+t)}_updateRetainedTiles(t){const r={};if(t.length===0)return r;const c={},p=t.reduce(((M,L)=>Math.min(M,L.overscaledZ)),1/0),_=t[0].overscaledZ,v=Math.max(_-ys.maxOverzooming,this._source.minzoom),b=Math.max(_+ys.maxUnderzooming,this._source.minzoom),I={};for(const M of t){const L=this._addTile(M);r[M.key]=M,L.hasData()||p<this._source.maxzoom&&(I[M.key]=M)}this._retainLoadedChildren(I,p,b,r);for(const M of t){let L=this._tiles[M.key];if(L.hasData())continue;if(M.canonical.z>=this._source.maxzoom){const F=M.children(this._source.maxzoom)[0],V=this.getTile(F);if(V&&V.hasData()){r[F.key]=F;continue}}else{const F=M.children(this._source.maxzoom);if(r[F[0].key]&&r[F[1].key]&&r[F[2].key]&&r[F[3].key])continue}let B=L.wasRequested();for(let F=M.overscaledZ-1;F>=v;--F){const V=M.scaledTo(F);if(c[V.key]||(c[V.key]=!0,L=this.getTile(V),!L&&B&&(L=this._addTile(V)),L&&(r[V.key]=V,B=L.wasRequested(),L.hasData())))break}}return r}_updateLoadedParentTileCache(){this._loadedParentTiles={};for(const t in this._tiles){const r=[];let c,p=this._tiles[t].tileID;for(;p.overscaledZ>0;){if(p.key in this._loadedParentTiles){c=this._loadedParentTiles[p.key];break}r.push(p.key);const _=p.scaledTo(p.overscaledZ-1);if(c=this._getLoadedTile(_),c)break;p=_}for(const _ of r)this._loadedParentTiles[_]=c}}_addTile(t){let r=this._tiles[t.key];if(r)return r.isExtraShadowCaster!==!0||this._shadowCasterTiles[t.key]||this._reloadTile(t.key,"reloading"),r;r=this._cache.getAndRemove(t),r&&(this._setTileReloadTimer(t.key,r),r.tileID=t,this._state.initializeTileState(r,this.map?this.map.painter:null),this._cacheTimers[t.key]&&(clearTimeout(this._cacheTimers[t.key]),delete this._cacheTimers[t.key],this._setTileReloadTimer(t.key,r)));const c=!!r;if(!c){const p=this.map?this.map.painter:null,_=this._source.tileSize*t.overscaleFactor();r=this._source.type==="raster-array"?new ec(t,_,this.transform.tileZoom,p,this._isRaster):new Ol(t,_,this.transform.tileZoom,p,this._isRaster,this._source.worldview),this._loadTile(r,this._tileLoaded.bind(this,r,t.key,r.state))}return r.uses++,this._tiles[t.key]=r,c||this._source.fire(new s.A("dataloading",{tile:r,coord:r.tileID,dataType:"source"})),r}_setTileReloadTimer(t,r){t in this._timers&&(clearTimeout(this._timers[t]),delete this._timers[t]);const c=r.getExpiryTimeout();c&&(this._timers[t]=setTimeout((()=>{this._reloadTile(t,"expired"),delete this._timers[t]}),c))}_removeTile(t){const r=this._tiles[t];r&&(r.uses--,delete this._tiles[t],this._timers[t]&&(clearTimeout(this._timers[t]),delete this._timers[t]),r.uses>0||(r.hasData()&&r.state!=="reloading"||r.state==="empty"?this._cache.add(r.tileID,r,r.getExpiryTimeout()):(r.aborted=!0,this._abortTile(r),this._unloadTile(r))))}clearTiles(){this._shouldReloadOnResume=!1,this._paused=!1;for(const t in this._tiles)this._removeTile(+t);this._source._clear&&this._source._clear(),this._cache.reset(),this.map&&this.usedForTerrain&&this.map.painter.terrain&&this.map.painter.terrain.resetTileLookupCache(this.id)}tilesIn(t,r,c){const p=[],_=this.transform;if(!_)return p;const v=_.projection.name==="globe",b=s.aD(_.center.lng);for(const I in this._tiles){const M=this._tiles[I];if(c&&M.clearQueryDebugViz(),M.holdingForFade())continue;let L;if(v){const B=M.tileID.canonical;if(B.z===0){const F=[Math.abs(s.ay(b,...Io(B,-1))-b),Math.abs(s.ay(b,...Io(B,1))-b)];L=[0,2*F.indexOf(Math.min(...F))-1]}else{const F=[Math.abs(s.ay(b,...Io(B,-1))-b),Math.abs(s.ay(b,...Io(B,0))-b),Math.abs(s.ay(b,...Io(B,1))-b)];L=[F.indexOf(Math.min(...F))-1]}}else L=[0];for(const B of L){const F=t.containsTile(M,_,r,B);F&&p.push(F)}}return p}getShadowCasterCoordinates(){return this._getRenderableCoordinates(!1,!0)}getVisibleCoordinates(t){return this._getRenderableCoordinates(t)}_getRenderableCoordinates(t,r){const c=this.getRenderableIds(t,r).map((_=>this._tiles[_].tileID)),p=this.transform.projection.name==="globe";for(const _ of c)_.projMatrix=this.transform.calculateProjMatrix(_.toUnwrapped()),_.expandedProjMatrix=p?this.transform.calculateProjMatrix(_.toUnwrapped(),!1,!0):_.projMatrix;return c}sortCoordinatesByDistance(t){const r=t.slice(),c=this.transform._camera.position,p=this.transform._camera.forward(),_={};for(const v of r){const b=1/(1<<v.canonical.z);_[v.key]=((v.canonical.x+.5)*b+v.wrap-c[0])*p[0]+((v.canonical.y+.5)*b-c[1])*p[1]-c[2]*p[2]}return r.sort(((v,b)=>_[v.key]-_[b.key])),r}hasTransition(){if(this._source.hasTransition())return!0;if(Uo(this._source.type))for(const t in this._tiles){const r=this._tiles[t];if(r.fadeEndTime!==void 0&&r.fadeEndTime>=s.q.now())return!0}return!1}setFeatureState(t,r,c){this._state.updateState(t=t||"_geojsonTileLayer",r,c)}removeFeatureState(t,r,c){this._state.removeFeatureState(t=t||"_geojsonTileLayer",r,c)}getFeatureState(t,r){return this._state.getState(t=t||"_geojsonTileLayer",r)}setDependencies(t,r,c){const p=this._tiles[t];p&&p.setDependencies(r,c)}reloadTilesForDependencies(t,r){for(const c in this._tiles)this._tiles[c].hasDependency(t,r)&&this._reloadTile(+c,"reloading");this._cache.filter((c=>!c.hasDependency(t,r)))}_preloadTiles(t,r){if(!this._sourceLoaded){const I=()=>{this._sourceLoaded&&(this._source.off("data",I),this._preloadTiles(t,r))};return void this._source.on("data",I)}const c=new Map,p=Array.isArray(t)?t:[t],_=this.map.painter.terrain,v=this.usedForTerrain&&_?_.getScaledDemTileSize():this._source.tileSize;for(const I of p){const M=I.coveringTiles({tileSize:v,minzoom:this._source.minzoom,maxzoom:this._source.maxzoom,roundZoom:this._source.roundZoom&&!this.usedForTerrain,reparseOverscaled:this._source.reparseOverscaled,isTerrainDEM:this.usedForTerrain});for(const L of M)c.set(L.key,L);this.usedForTerrain&&I.updateElevation(!1)}const b=Array.from(c.values());s.bt(b,((I,M)=>{const L=new Ol(I,this._source.tileSize*I.overscaleFactor(),this.transform.tileZoom,this.map.painter,this._isRaster,this._source.worldview);this._loadTile(L,(B=>{this._source.type==="raster-dem"&&L.dem&&this._backfillDEM(L),M(B,L)}))}),r)}}function bs(l,t){const r=Math.abs(2*l.wrap)-+(l.wrap<0),c=Math.abs(2*t.wrap)-+(t.wrap<0);return l.overscaledZ-t.overscaledZ||c-r||t.canonical.y-l.canonical.y||t.canonical.x-l.canonical.x}function Uo(l){return l==="raster"||l==="image"||l==="video"||l==="custom"}function Io(l,t){const r=1<<l.z;return[l.x/r+t,(l.x+1)/r+t]}ys.maxOverzooming=10,ys.maxUnderzooming=3;class tc{constructor(t){this.style=t,this.layersGotHidden=!1,this.layers=[]}processLayersChanged(){this.layers=[];const t=!1,r=!1;for(const c in this.style._mergedLayers){const p=this.style._mergedLayers[c];if(p.type==="fill-extrusion"||p.type==="building")this.layers.push({layer:p,visible:t,visibilityChanged:r});else if(p.type==="model"){const _=this.style.getLayerSource(p);_&&_.type==="batched-model"&&this.layers.push({layer:p,visible:t,visibilityChanged:r})}}}onNewFrame(t){this.layersGotHidden=!1;for(const r of this.layers){const c=r.layer;let p=!1;c.type==="fill-extrusion"?p=!c.isHidden(t)&&c.paint.get("fill-extrusion-opacity")>0:c.type==="building"?p=!c.isHidden(t)&&c.paint.get("building-opacity")>0:c.type==="model"&&(p=!c.isHidden(t)&&c.paint.get("model-opacity").constantOr(1)>0),this.layersGotHidden=this.layersGotHidden||!p&&r.visible,r.visible=p}}updateZOffset(t,r){this.currentBuildingBuckets=[];for(const p of this.layers){const _=p.layer,v=this.style.getLayerSourceCache(_);let b=1;_.type==="fill-extrusion"?b=p.visible?_.paint.get("fill-extrusion-vertical-scale"):0:_.type==="building"&&(b=p.visible?_.paint.get("building-vertical-scale"):0);let I=v?v.getTile(r):null;if(!I&&v)for(const M in v._tiles){const L=v._tiles[M];if(r.canonical.isChildOf(L.tileID.canonical)){I=L;break}}this.currentBuildingBuckets.push({bucket:I?I.getBucket(_):null,tileID:I?I.tileID:r,verticalScale:b})}t.hasAnyZOffset=!1;let c=!1;for(let p=0;p<t.symbolInstances.length;p++){const _=t.symbolInstances.get(p),v=_.zOffset,b=this._getHeightAtTileOffset(r,_.tileAnchorX,_.tileAnchorY);_.zOffset=b!==Number.NEGATIVE_INFINITY?b:v,c||v===_.zOffset||(c=!0),t.hasAnyZOffset||_.zOffset===0||(t.hasAnyZOffset=!0)}c&&(t.zOffsetBuffersNeedUpload=!0,t.zOffsetSortDirty=!0)}_mapCoordToOverlappingTile(t,r,c,p){let _=r,v=c;if(t.canonical.z!==p.canonical.z){const b=p.canonical,I=1/(1<<t.canonical.z-b.z);_=(r+t.canonical.x*s.aj)*I-b.x*s.aj|0,v=(c+t.canonical.y*s.aj)*I-b.y*s.aj|0}return{tileX:_,tileY:v}}_getHeightAtTileOffset(t,r,c){let p,_;for(let v=0;v<this.layers.length;++v){const b=this.layers[v].layer;if(b.type!=="fill-extrusion"&&b.type!=="building")continue;const{bucket:I,tileID:M,verticalScale:L}=this.currentBuildingBuckets[v];if(!I)continue;const{tileX:B,tileY:F}=this._mapCoordToOverlappingTile(t,r,c,M),V=I.getHeightAtTileCoord(B,F);V&&V.height!==void 0&&(V.hidden?p=V.height:_=Math.max(V.height*L,_||0))}if(_!==void 0)return _;for(let v=0;v<this.layers.length;++v){const b=this.layers[v];if(b.layer.type!=="model"||!b.visible)continue;const{bucket:I,tileID:M}=this.currentBuildingBuckets[v];if(!I)continue;const{tileX:L,tileY:B}=this._mapCoordToOverlappingTile(t,r,c,M),F=I.getHeightAtTileCoord(L,B);if(F&&!F.hidden)return F.height===void 0&&p!==void 0?Math.min(F.maxHeight,p)*F.verticalScale:F.height?F.height*F.verticalScale:Number.NEGATIVE_INFINITY}return this.layersGotHidden?0:Number.NEGATIVE_INFINITY}}function va(l,t){const r={};for(const c in l)c!=="ref"&&(r[c]=l[c]);return s.bu.forEach((c=>{c in t&&(r[c]=t[c])})),r}function ea(l){l=l.slice();const t=Object.create(null);for(let r=0;r<l.length;r++)t[l[r].id]=l[r];for(let r=0;r<l.length;r++)"ref"in l[r]&&(l[r]=va(l[r],t[l[r].ref]));return l}const xn={setStyle:"setStyle",addLayer:"addLayer",removeLayer:"removeLayer",setPaintProperty:"setPaintProperty",setLayoutProperty:"setLayoutProperty",setSlot:"setSlot",setFilter:"setFilter",addSource:"addSource",removeSource:"removeSource",setGeoJSONSourceData:"setGeoJSONSourceData",setLayerZoomRange:"setLayerZoomRange",setLayerProperty:"setLayerProperty",setCenter:"setCenter",setZoom:"setZoom",setBearing:"setBearing",setPitch:"setPitch",setSprite:"setSprite",setGlyphs:"setGlyphs",setTransition:"setTransition",setLight:"setLight",setTerrain:"setTerrain",setFog:"setFog",setSnow:"setSnow",setRain:"setRain",setCamera:"setCamera",setLights:"setLights",setProjection:"setProjection",addImport:"addImport",removeImport:"removeImport",updateImport:"updateImport",addIconset:"addIconset",removeIconset:"removeIconset"};function nu(l,t,r){r.push({command:xn.addSource,args:[l,t[l]]})}function Qs(l,t,r){t.push({command:xn.removeSource,args:[l]}),r[l]=!0}function ru(l,t,r,c){Qs(l,r,c),nu(l,t,r)}function vd(l,t,r){let c;for(c in l[r])if(l[r].hasOwnProperty(c)&&c!=="data"&&!s.bv(l[r][c],t[r][c]))return!1;for(c in t[r])if(t[r].hasOwnProperty(c)&&c!=="data"&&!s.bv(l[r][c],t[r][c]))return!1;return!0}function xa(l,t,r,c,p,_){let v;for(v in t=t||{},l=l||{})l.hasOwnProperty(v)&&(s.bv(l[v],t[v])||r.push({command:_,args:[c,v,t[v],p]}));for(v in t)t.hasOwnProperty(v)&&!l.hasOwnProperty(v)&&(s.bv(l[v],t[v])||r.push({command:_,args:[c,v,t[v],p]}))}function wa(l){return l.id}function ll(l,t){return l[t.id]=t,l}function jo(l,t,r){const c=t.createTileMatrix(l,l.worldSize,r.toUnwrapped());return s.az(new Float32Array(16),l.projMatrix,c)}function Ua(l,t,r){if(t.projection.name===r.projection.name)return l.projMatrix;const c=r.clone();return c.setProjection(t.projection),jo(c,t.getProjection(),l)}function ja(l,t,r){return t.name===r.projection.name?l.projMatrix:jo(r,t,l)}class ic{constructor(t,r){this.reset(t,r)}reset(t,r){this.points=t||[],this._distances=[0];for(let c=1;c<this.points.length;c++)this._distances[c]=this._distances[c-1]+this.points[c].dist(this.points[c-1]);this.length=this._distances[this._distances.length-1],this.padding=Math.min(r||0,.5*this.length),this.paddedLength=this.length-2*this.padding}lerp(t){if(this.points.length===1)return this.points[0];t=s.ay(t,0,1);let r=1,c=this._distances[r];const p=t*this.paddedLength+this.padding;for(;c<p&&r<this._distances.length;)c=this._distances[++r];const _=r-1,v=this._distances[_],b=c-v,I=b>0?(p-v)/b:0;return this.points[_].mult(1-I).add(this.points[r].mult(I))}}class Yr{constructor(t,r,c){const p=this.boxCells=[],_=this.circleCells=[];this.xCellCount=Math.ceil(t/c),this.yCellCount=Math.ceil(r/c);for(let v=0;v<this.xCellCount*this.yCellCount;v++)p.push([]),_.push([]);this.circleKeys=[],this.boxKeys=[],this.bboxes=[],this.circles=[],this.width=t,this.height=r,this.xScale=this.xCellCount/t,this.yScale=this.yCellCount/r,this.boxUid=0,this.circleUid=0}keysLength(){return this.boxKeys.length+this.circleKeys.length}insert(t,r,c,p,_){this._forEachCell(r,c,p,_,this._insertBoxCell,this.boxUid++),this.boxKeys.push(t),this.bboxes.push(r),this.bboxes.push(c),this.bboxes.push(p),this.bboxes.push(_)}insertCircle(t,r,c,p){this._forEachCell(r-p,c-p,r+p,c+p,this._insertCircleCell,this.circleUid++),this.circleKeys.push(t),this.circles.push(r),this.circles.push(c),this.circles.push(p)}_insertBoxCell(t,r,c,p,_,v){this.boxCells[_].push(v)}_insertCircleCell(t,r,c,p,_,v){this.circleCells[_].push(v)}_query(t,r,c,p,_,v){if(c<0||t>this.width||p<0||r>this.height)return!_&&[];const b=[];if(t<=0&&r<=0&&this.width<=c&&this.height<=p){if(_)return!0;for(let I=0;I<this.boxKeys.length;I++)b.push({key:this.boxKeys[I],x1:this.bboxes[4*I],y1:this.bboxes[4*I+1],x2:this.bboxes[4*I+2],y2:this.bboxes[4*I+3]});for(let I=0;I<this.circleKeys.length;I++){const M=this.circles[3*I],L=this.circles[3*I+1],B=this.circles[3*I+2];b.push({key:this.circleKeys[I],x1:M-B,y1:L-B,x2:M+B,y2:L+B})}return v?b.filter(v):b}return this._forEachCell(t,r,c,p,this._queryCell,b,{hitTest:_,seenUids:{box:{},circle:{}}},v),_?b.length>0:b}_queryCircle(t,r,c,p,_){const v=t-c,b=t+c,I=r-c,M=r+c;if(b<0||v>this.width||M<0||I>this.height)return!p&&[];const L=[];return this._forEachCell(v,I,b,M,this._queryCellCircle,L,{hitTest:p,circle:{x:t,y:r,radius:c},seenUids:{box:{},circle:{}}},_),p?L.length>0:L}query(t,r,c,p,_){return this._query(t,r,c,p,!1,_)}hitTest(t,r,c,p,_){return this._query(t,r,c,p,!0,_)}hitTestCircle(t,r,c,p){return this._queryCircle(t,r,c,!0,p)}_queryCell(t,r,c,p,_,v,b,I){const M=b.seenUids,L=this.boxCells[_];if(L!==null){const F=this.bboxes;for(const V of L)if(!M.box[V]){M.box[V]=!0;const $=4*V;if(t<=F[$+2]&&r<=F[$+3]&&c>=F[$+0]&&p>=F[$+1]&&(!I||I(this.boxKeys[V]))){if(b.hitTest)return v.push(!0),!0;v.push({key:this.boxKeys[V],x1:F[$],y1:F[$+1],x2:F[$+2],y2:F[$+3]})}}}const B=this.circleCells[_];if(B!==null){const F=this.circles;for(const V of B)if(!M.circle[V]){M.circle[V]=!0;const $=3*V;if(this._circleAndRectCollide(F[$],F[$+1],F[$+2],t,r,c,p)&&(!I||I(this.circleKeys[V]))){if(b.hitTest)return v.push(!0),!0;{const H=F[$],X=F[$+1],Z=F[$+2];v.push({key:this.circleKeys[V],x1:H-Z,y1:X-Z,x2:H+Z,y2:X+Z})}}}}}_queryCellCircle(t,r,c,p,_,v,b,I){const M=b.circle,L=b.seenUids,B=this.boxCells[_];if(B!==null){const V=this.bboxes;for(const $ of B)if(!L.box[$]){L.box[$]=!0;const H=4*$;if(this._circleAndRectCollide(M.x,M.y,M.radius,V[H+0],V[H+1],V[H+2],V[H+3])&&(!I||I(this.boxKeys[$])))return v.push(!0),!0}}const F=this.circleCells[_];if(F!==null){const V=this.circles;for(const $ of F)if(!L.circle[$]){L.circle[$]=!0;const H=3*$;if(this._circlesCollide(V[H],V[H+1],V[H+2],M.x,M.y,M.radius)&&(!I||I(this.circleKeys[$])))return v.push(!0),!0}}}_forEachCell(t,r,c,p,_,v,b,I){const M=this._convertToXCellCoord(t),L=this._convertToYCellCoord(r),B=this._convertToXCellCoord(c),F=this._convertToYCellCoord(p);for(let V=M;V<=B;V++)for(let $=L;$<=F;$++)if(_.call(this,t,r,c,p,this.xCellCount*$+V,v,b,I))return}_convertToXCellCoord(t){return Math.max(0,Math.min(this.xCellCount-1,Math.floor(t*this.xScale)))}_convertToYCellCoord(t){return Math.max(0,Math.min(this.yCellCount-1,Math.floor(t*this.yScale)))}_circlesCollide(t,r,c,p,_,v){const b=p-t,I=_-r,M=c+v;return M*M>b*b+I*I}_circleAndRectCollide(t,r,c,p,_,v,b){const I=(v-p)/2,M=Math.abs(t-(p+I));if(M>I+c)return!1;const L=(b-_)/2,B=Math.abs(r-(_+L));if(B>L+c)return!1;if(M<=I||B<=L)return!0;const F=M-I,V=B-L;return F*F+V*V<=c*c}}const nc={unknown:0,flipRequired:1,flipNotRequired:2},Gu=Math.tan(85*Math.PI/180);function cl(l,t,r,c,p,_,v){const b=s.bz();if(r)if(_.name==="globe"){const I=s.bA(p,t);s.az(b,b,I)}else{const I=s.bB([],v);b[0]=I[0],b[1]=I[1],b[4]=I[2],b[5]=I[3],c||s.by(b,b,p.angle)}else s.az(b,p.labelPlaneMatrix,l);return b}function ul(l,t,r,c,p,_,v){const b=cl(l,t,r,c,p,_,v);return _.name==="globe"&&r||(b[2]=b[6]=b[10]=b[14]=0),b}function ba(l,t,r,c,p,_,v){if(r){if(_.name==="globe"){const b=cl(l,t,r,c,p,_,v);return s.bi(b,b),s.az(b,l,b),b}{const b=s.bw(l),I=s.bx([]);return I[0]=v[0],I[1]=v[1],I[4]=v[2],I[5]=v[3],s.az(b,b,I),c||s.by(b,b,-p.angle),b}}return p.glCoordMatrix}function ds(l,t,r,c){const p=[l,t,r,1];r?s.aA(p,p,c):xd(p,p,c);const _=p[3];return p[0]/=_,p[1]/=_,p[2]/=_,p}function Cc(l,t){return Math.min(.5+l/t*.5,1.5)}function Ao(l,t){const r=l[0]/l[3],c=l[1]/l[3];return r>=-t[0]&&r<=t[0]&&c>=-t[1]&&c<=t[1]}function hl(l,t,r,c,p,_,v,b,I,M){const L=r.transform,B=c?l.textSizeData:l.iconSizeData,F=s.bH(B,r.transform.zoom),V=L.projection.name==="globe",$=[256/r.width*2+1,256/r.height*2+1],H=c?l.text.dynamicLayoutVertexArray:l.icon.dynamicLayoutVertexArray;H.clear();let X=null;V&&(X=c?l.text.globeExtVertexArray:l.icon.globeExtVertexArray);const Z=l.lineVertexArray,te=c?l.text.placedSymbolArray:l.icon.placedSymbolArray,oe=r.transform.width/r.transform.height;let le,pe=!1;for(let ye=0;ye<te.length;ye++){const we=te.get(ye),{numGlyphs:me,writingMode:_e}=we;if(_e!==s.bI.vertical||pe||le===s.bI.horizontal||(pe=!0),le=_e,(we.hidden||_e===s.bI.vertical)&&!pe){Go(me,H);continue}pe=!1;const ge=new s.P(we.tileAnchorX,we.tileAnchorY);let{x:Be,y:Ce,z:nt}=L.projection.projectTilePoint(ge.x,ge.y,M.canonical);if(I){const[Qt,oi,qt]=I(ge);Be+=Qt,Ce+=oi,nt+=qt}const He=[Be,Ce,nt,1];if(s.aA(He,He,t),!Ao(He,$)){Go(me,H);continue}const at=He[3],mt=Cc(r.transform.getCameraToCenterDistance(L.projection),at),ze=s.bJ(B,F,we),Te=v?ze/mt:ze*mt,Ze=ds(Be,Ce,nt,p);if(Ze[3]<=0){Go(me,H);continue}let Ue={};const dt=s.al(l.layers[0].layout.get("text-max-angle")),ft=Math.cos(dt),xt=v?null:I,It=Pc(we,Te,!1,b,t,p,_,l.glyphOffsetArray,Z,H,X,Ze,ge,Ue,oe,xt,L.projection,M,v,ft);pe=It.useVertical,xt&&It.needsFlipping&&(Ue={}),(It.notEnoughRoom||pe||It.needsFlipping&&Pc(we,Te,!0,b,t,p,_,l.glyphOffsetArray,Z,H,X,Ze,ge,Ue,oe,xt,L.projection,M,v,ft).notEnoughRoom)&&Go(me,H)}c?(l.text.dynamicLayoutVertexBuffer.updateData(H),X&&l.text.globeExtVertexBuffer&&l.text.globeExtVertexBuffer.updateData(X)):(l.icon.dynamicLayoutVertexBuffer.updateData(H),X&&l.icon.globeExtVertexBuffer&&l.icon.globeExtVertexBuffer.updateData(X))}function Js(l,t,r,c,p,_,v,b,I,M,L,B,F,V,$,H,X){const{lineStartIndex:Z,glyphStartIndex:te,segment:oe}=b,le=te+b.numGlyphs,pe=Z+b.lineLength,ye=t.getoffsetX(te),we=t.getoffsetX(le-1),me=Bl(l*ye,r,c,p,_,v,oe,Z,pe,I,M,L,B,F,!0,V,$,H,X);if(!me)return null;const _e=Bl(l*we,r,c,p,_,v,oe,Z,pe,I,M,L,B,F,!0,V,$,H,X);return _e?{first:me,last:_e}:null}function Ga(l,t,r,c){return l===s.bI.horizontal&&Math.abs(c)>Math.abs(r)?{useVertical:!0}:l===s.bI.vertical?c>0?{needsFlipping:!0}:null:t!==nc.unknown&&(function(p,_){return p===0||Math.abs(_/p)>Gu})(r,c)?t===nc.flipRequired?{needsFlipping:!0}:null:r<0?{needsFlipping:!0}:null}function Pc(l,t,r,c,p,_,v,b,I,M,L,B,F,V,$,H,X,Z,te,oe){const le=t/24,pe=l.lineOffsetX*le,ye=l.lineOffsetY*le,{lineStartIndex:we,glyphStartIndex:me,numGlyphs:_e,segment:ge,writingMode:Be,flipState:Ce}=l,nt=we+l.lineLength,He=at=>{if(L){const[Ze,Ue,dt]=at.up,ft=M.length;s.bK(L,ft+0,Ze,Ue,dt),s.bK(L,ft+1,Ze,Ue,dt),s.bK(L,ft+2,Ze,Ue,dt),s.bK(L,ft+3,Ze,Ue,dt)}const[mt,ze,Te]=at.point;s.bL(M,mt,ze,Te,at.angle)};if(_e>1){const at=Js(le,b,pe,ye,r,B,F,l,I,_,V,H,!1,X,Z,te,oe);if(!at)return{notEnoughRoom:!0};if(c&&!r){let[mt,ze,Te]=at.first.point,[Ze,Ue,dt]=at.last.point;[mt,ze]=ds(mt,ze,Te,v),[Ze,Ue]=ds(Ze,Ue,dt,v);const ft=Ga(Be,Ce,(Ze-mt)*$,Ue-ze);if(l.flipState=ft&&ft.needsFlipping?nc.flipRequired:nc.flipNotRequired,ft)return ft}He(at.first);for(let mt=me+1;mt<me+_e-1;mt++){const ze=Bl(le*b.getoffsetX(mt),pe,ye,r,B,F,ge,we,nt,I,_,V,H,!1,!1,X,Z,te,oe);if(!ze)return M.length-=4*(mt-me),{notEnoughRoom:!0};He(ze)}He(at.last)}else{if(c&&!r){const mt=ds(F.x,F.y,0,p),ze=we+ge+1,Te=new s.P(I.getx(ze),I.gety(ze)),Ze=ds(Te.x,Te.y,0,p),Ue=Ze[3]>0?Ze:un(F,Te,mt,1,p,void 0,X,Z.canonical),dt=Ga(Be,Ce,(Ue[0]-mt[0])*$,Ue[1]-mt[1]);if(l.flipState=dt&&dt.needsFlipping?nc.flipRequired:nc.flipNotRequired,dt)return dt}const at=Bl(le*b.getoffsetX(me),pe,ye,r,B,F,ge,we,nt,I,_,V,H,!1,!1,X,Z,te,oe);if(!at)return{notEnoughRoom:!0};He(at)}return{}}function eo(l,t,r,c,p){const{x:_,y:v,z:b}=c.projectTilePoint(l.x,l.y,t);if(!p)return ds(_,v,b,r);const[I,M,L]=p(l);return ds(_+I,v+M,b+L,r)}function un(l,t,r,c,p,_,v,b){const I=eo(l.sub(t)._unit()._add(l),b,p,v,_);return s.at(I,r,I),s.au(I,I),s.bE(I,r,I,c)}function Bl(l,t,r,c,p,_,v,b,I,M,L,B,F,V,$,H,X,Z,te){const oe=c?l-t:l+t;let le=oe>0?1:-1,pe=0;c&&(le*=-1,pe=Math.PI),le<0&&(pe+=Math.PI);let ye=b+v+(le>0?0:1)|0,we=p,me=p,_e=0,ge=0;const Be=Math.abs(oe),Ce=[],nt=[];let He=_,at=He,mt=s.bC([]);const ze=()=>un(at,He,me,Be-_e+1,L,F,H,X.canonical);for(;_e+ge<=Be;){if(ye+=le,ye<b||ye>=I)return null;if(me=we,at=He,Ce.push(me),V&&nt.push(at),He=new s.P(M.getx(ye),M.gety(ye)),we=B[ye],!we){const qt=eo(He,X.canonical,L,H,F);we=qt[3]>0?B[ye]=qt:ze()}_e+=ge;const Qt=s.at([],we,me),oi=s.bD(me,we);if(r&&oi>0&&ge>0&&s.bG(mt,Qt)/(ge*oi)<te)return null;ge=oi,mt=Qt}$&&F&&(B[ye]&&(we=ze(),ge=s.bD(me,we),mt=s.at([],we,me)),B[ye]=we);const Te=(Be-_e)/ge,Ze=He.sub(at)._mult(Te)._add(at),Ue=s.bE([],me,mt,Te);let dt=[0,0,1],ft=mt[0],xt=mt[1];if(Z&&(dt=H.upVector(X.canonical,Ze.x,Ze.y),dt[0]!==0||dt[1]!==0||dt[2]!==1)){const Qt=[dt[2],0,-dt[0]],oi=s.bF([],dt,Qt);s.au(Qt,Qt),s.au(oi,oi),ft=s.bG(mt,Qt),xt=s.bG(mt,oi)}if(r){const Qt=s.bF([],dt,mt);s.au(Qt,Qt),s.bE(Ue,Ue,Qt,r*le)}const It=pe+Math.atan2(xt,ft);return Ce.push(Ue),V&&nt.push(Ze),{point:Ue,angle:It,path:Ce,tilePath:nt,up:dt}}function Go(l,t){const r=t.length,c=r+4*l;t.resize(c),t.float32.fill(-1/0,4*r,4*c)}function xd(l,t,r){const c=t[0],p=t[1];return l[0]=r[0]*c+r[4]*p+r[12],l[1]=r[1]*c+r[5]*p+r[13],l[3]=r[3]*c+r[7]*p+r[15],l}const di=100;class Nl{constructor(t,r,c=new Yr(t.width+200,t.height+200,25),p=new Yr(t.width+200,t.height+200,25)){this.transform=t,this.grid=c,this.ignoredGrid=p,this.pitchfactor=Math.cos(t._pitch)*t.cameraToCenterDistance,this.screenRightBoundary=t.width+di,this.screenBottomBoundary=t.height+di,this.gridRightBoundary=t.width+200,this.gridBottomBoundary=t.height+200,this.fogState=r}placeCollisionBox(t,r,c,p,_,v,b,I,M,L,B){let F=c.projectedAnchorX,V=c.projectedAnchorY,$=c.projectedAnchorZ;const H=c.tileAnchorX,X=c.tileAnchorY,Z=c.elevation,te=c.tileID,oe=t.getProjection();if(Z&&te){const[nt,He,at]=oe.upVector(te.canonical,c.tileAnchorX,c.tileAnchorY),mt=oe.upVectorScale(te.canonical,this.transform.center.lat,this.transform.worldSize).metersToTile;F+=nt*Z*mt,V+=He*Z*mt,$+=at*Z*mt}const le=t.projection.name==="globe",pe=t.projection.name==="globe"?s.ah(this.transform.zoom):0;if(te&&le&&pe<1&&!v){const nt=1<<te.canonical.z,He=s.bM(H,X);s.bN(He,He,1/s.aj),s.bO(He,He,s.bM(te.canonical.x,te.canonical.y)),s.bN(He,He,1/nt),s.bP(He,He,s.bM(p[0],p[1])),He[0]=s.bQ(He[0],-.5,.5),s.bN(He,He,s.aj);const at=s.bR(He[0],He[1],s.aj/(2*Math.PI),1);s.aA(at,at,_),F=s.ai(F,at[0],pe),V=s.ai(V,at[1],pe),$=s.ai($,at[2],pe)}const ye=this.projectAndGetPerspectiveRatio(L,F,V,$,c.tileID,oe.name==="globe"||!!Z||this.transform.pitch>0,oe),we=M*ye.perspectiveRatio,me=(c.x1*r+b.x-c.padding)*we+ye.point.x,_e=(c.y1*r+b.y-c.padding)*we+ye.point.y,ge=(c.x2*r+b.x+c.padding)*we+ye.point.x,Be=(c.y2*r+b.y+c.padding)*we+ye.point.y,Ce=ye.perspectiveRatio<=.55||ye.occluded;return!this.isInsideGrid(me,_e,ge,Be)||!I&&this.grid.hitTest(me,_e,ge,Be,B)||Ce?{box:[],offscreen:!1,occluded:ye.occluded}:{box:[me,_e,ge,Be],offscreen:this.isOffscreen(me,_e,ge,Be),occluded:!1}}placeCollisionCircles(t,r,c,p,_,v,b,I,M,L,B,F,V,$,H){const X=[],Z=this.transform.elevation,te=t.getProjection(),oe=Z?Z.getAtTileOffsetFunc(H,this.transform.center.lat,this.transform.worldSize,te):null,le=new s.P(c.tileAnchorX,c.tileAnchorY);let{x:pe,y:ye,z:we}=te.projectTilePoint(le.x,le.y,H.canonical);if(oe){const[dt,ft,xt]=oe(le);pe+=dt,ye+=ft,we+=xt}const me=te.name==="globe",_e=this.projectAndGetPerspectiveRatio(b,pe,ye,we,H,me||!!Z||this.transform.pitch>0,te),{perspectiveRatio:ge}=_e,Be=(B?v/ge:v*ge)/s.bU,Ce=ds(pe,ye,we,I),nt=c.lineOffsetX*Be,He=c.lineOffsetY*Be,at=s.al(t.layers[0].layout.get("text-max-angle")),mt=Math.cos(at),ze=_e.signedDistanceFromCamera>0?Js(Be,_,nt,He,!1,Ce,le,c,p,I,{},Z&&!B?oe:null,B&&!!Z,te,H,B,mt):null;let Te=!1,Ze=!1,Ue=!0;if(ze&&!_e.occluded){const dt=.5*V*ge+$,ft=new s.P(-100,-100),xt=new s.P(this.screenRightBoundary,this.screenBottomBoundary),It=new ic,{first:Qt,last:oi}=ze,qt=Qt.path.length;let si=[];for(let Fi=qt-1;Fi>=1;Fi--)si.push(Qt.path[Fi]);for(let Fi=1;Fi<oi.path.length;Fi++)si.push(oi.path[Fi]);const Jt=2.5*dt;M&&(si=si.map((([Fi,Hi,gn],ki)=>(oe&&!me&&(gn=oe(ki<qt-1?Qt.tilePath[qt-1-ki]:oi.tilePath[ki-qt+2])[2]),ds(Fi,Hi,gn,M)))),si.some((Fi=>Fi[3]<=0))&&(si=[]));let Ci=[];if(si.length>0){let Fi=1/0,Hi=-1/0,gn=1/0,ki=-1/0;for(const En of si)Fi=Math.min(Fi,En[0]),gn=Math.min(gn,En[1]),Hi=Math.max(Hi,En[0]),ki=Math.max(ki,En[1]);Hi>=ft.x&&Fi<=xt.x&&ki>=ft.y&&gn<=xt.y&&(Ci=[si.map((En=>new s.P(En[0],En[1])))],(Fi<ft.x||Hi>xt.x||gn<ft.y||ki>xt.y)&&(Ci=s.bS(Ci,ft.x,ft.y,xt.x,xt.y)))}for(const Fi of Ci){It.reset(Fi,.25*dt);let Hi=0;Hi=It.length<=.5*dt?1:Math.ceil(It.paddedLength/Jt)+1;for(let gn=0;gn<Hi;gn++){const ki=gn/Math.max(Hi-1,1),En=It.lerp(ki),Dn=En.x+di,sr=En.y+di;X.push(Dn,sr,dt,0);const Ni=Dn-dt,Sn=sr-dt,pn=Dn+dt,Bn=sr+dt;if(Ue=Ue&&this.isOffscreen(Ni,Sn,pn,Bn),Ze=Ze||this.isInsideGrid(Ni,Sn,pn,Bn),!r&&this.grid.hitTestCircle(Dn,sr,dt,F)&&(Te=!0,!L))return{circles:[],offscreen:!1,collisionDetected:Te,occluded:!1}}}}return{circles:!L&&Te||!Ze?[]:X,offscreen:Ue,collisionDetected:Te,occluded:_e.occluded}}queryRenderedSymbols(t){if(t.length===0||this.grid.keysLength()===0&&this.ignoredGrid.keysLength()===0)return{};const r=[];let c=1/0,p=1/0,_=-1/0,v=-1/0;for(const L of t){const B=new s.P(L.x+di,L.y+di);c=Math.min(c,B.x),p=Math.min(p,B.y),_=Math.max(_,B.x),v=Math.max(v,B.y),r.push(B)}const b=this.grid.query(c,p,_,v).concat(this.ignoredGrid.query(c,p,_,v)),I={},M={};for(const L of b){const B=L.key;if(I[B.bucketInstanceId]===void 0&&(I[B.bucketInstanceId]={}),I[B.bucketInstanceId][B.featureIndex])continue;const F=[new s.P(L.x1,L.y1),new s.P(L.x2,L.y1),new s.P(L.x2,L.y2),new s.P(L.x1,L.y2)];s.bT(r,F)&&(I[B.bucketInstanceId][B.featureIndex]=!0,M[B.bucketInstanceId]===void 0&&(M[B.bucketInstanceId]=[]),M[B.bucketInstanceId].push(B.featureIndex))}return M}insertCollisionBox(t,r,c,p,_){(r?this.ignoredGrid:this.grid).insert({bucketInstanceId:c,featureIndex:p,collisionGroupID:_},t[0],t[1],t[2],t[3])}insertCollisionCircles(t,r,c,p,_){const v=r?this.ignoredGrid:this.grid,b={bucketInstanceId:c,featureIndex:p,collisionGroupID:_};for(let I=0;I<t.length;I+=4)v.insertCircle(b,t[I],t[I+1],t[I+2])}projectAndGetPerspectiveRatio(t,r,c,p,_,v,b){const I=[r,c,p,1];let M=!1;p||this.transform.pitch>0?(s.aA(I,I,t),this.fogState&&_&&b.name!=="globe"&&(M=(function(F,V,$,H,X,Z){const te=Z.calculateFogTileMatrix(X),oe=[V,$,H];return s.ad(oe,oe,te),ri(F,s.ae(oe),Z.pitch,Z._fov)})(this.fogState,r,c,p,_.toUnwrapped(),this.transform)>.9)):xd(I,I,t);const L=I[3];return{point:new s.P((I[0]/L+1)/2*this.transform.width+di,(-I[1]/L+1)/2*this.transform.height+di),perspectiveRatio:Math.min(.5+this.transform.getCameraToCenterDistance(b)/L*.5,1.5),signedDistanceFromCamera:L,occluded:v&&I[2]>L||M}}isOffscreen(t,r,c,p){return c<di||t>=this.screenRightBoundary||p<di||r>this.screenBottomBoundary}isInsideGrid(t,r,c,p){return c>=0&&t<this.gridRightBoundary&&p>=0&&r<this.gridBottomBoundary}getViewportMatrix(){const t=s.bx([]);return s.bo(t,t,[-100,-100,0]),t}}class Ha{constructor(t,r,c,p){this.opacity=t?Math.max(0,Math.min(1,t.opacity+(t.placed?r:-r))):p&&c?1:0,this.placed=c}isHidden(){return this.opacity===0&&!this.placed}}class Ta{constructor(t,r,c,p,_,v=!1){this.text=new Ha(t?t.text:null,r,c,_),this.icon=new Ha(t?t.icon:null,r,p,_),this.clipped=v}isHidden(){return this.text.isHidden()&&this.icon.isHidden()}}class co{constructor(t,r,c,p=!1){this.text=t,this.icon=r,this.skipFade=c,this.clipped=p}}class su{constructor(){this.invProjMatrix=s.bz(),this.viewportMatrix=s.bz(),this.circles=[]}}class rc{constructor(t,r,c,p,_){this.bucketInstanceId=t,this.featureIndex=r,this.sourceLayerIndex=c,this.bucketIndex=p,this.tileID=_}}class ni{constructor(t){this.crossSourceCollisions=t,this.maxGroupID=0,this.collisionGroups={}}get(t){if(this.crossSourceCollisions)return{ID:0,predicate:null};if(!this.collisionGroups[t]){const r=++this.maxGroupID;this.collisionGroups[t]={ID:r,predicate:c=>c.collisionGroupID===r}}return this.collisionGroups[t]}}function bn(l,t,r,c,p){const{horizontalAlign:_,verticalAlign:v}=s.bZ(l),b=-(_-.5)*t,I=-(v-.5)*r,M=s.b_(l,c);return new s.P(b+M[0]*p,I+M[1]*p)}function Mn(l,t,r,c,p){const _=new s.P(l,t);return r&&_._rotate(c?p:-p),_}class Cs{constructor(t,r,c,p,_,v){this.transform=t.clone(),this.projection=t.projection.name,this.collisionIndex=new Nl(this.transform,_),this.buildingIndex=v,this.placements={},this.opacities={},this.variableOffsets={},this.stale=!1,this.commitTime=0,this.fadeDuration=r,this.retainedQueryData={},this.collisionGroups=new ni(c),this.collisionCircleArrays={},this.prevPlacement=p,p&&(p.prevPlacement=void 0),this.placedOrientations={}}getBucketParts(t,r,c,p,_=1){const v=c.getBucket(r),b=c.latestFeatureIndex;if(!v||!b||r.fqid!==v.layerIds[0])return;const I=v.layers[0].layout,M=v.layers[0].paint,L=c.collisionBoxArray,B=Math.pow(2,this.transform.zoom-c.tileID.overscaledZ),F=c.tileSize/s.aj,V=c.tileID.toUnwrapped();this.transform.setProjection(v.projection);const $=(H=c.tileID,X=v.getProjection(),Z=this.transform,X.name===this.projection?Z.calculateProjMatrix(H.toUnwrapped()):jo(Z,X,H));var H,X,Z;const te=I.get("text-pitch-alignment")==="map",oe=I.get("text-rotation-alignment")==="map";r.compileFilter(r.options);const le=r.dynamicFilter(),pe=r.dynamicFilterNeedsFeature(),ye=this.transform.calculatePixelsToTileUnitsMatrix(c),we=ul($,c.tileID.canonical,te,oe,this.transform,v.getProjection(),ye);let me=null;const _e=v.getProjection().createInversionMatrix(this.transform,c.tileID.canonical);if(te){const Te=ba($,c.tileID.canonical,te,oe,this.transform,v.getProjection(),ye);me=s.az([],this.transform.labelPlaneMatrix,Te)}let ge=null;le&&c.latestFeatureIndex&&(ge={unwrappedTileID:V,dynamicFilter:le,dynamicFilterNeedsFeature:pe}),this.retainedQueryData[v.bucketInstanceId]=new rc(v.bucketInstanceId,b,v.sourceLayerIndex,v.index,c.tileID);const[Be,Ce]=v.layers[0].layout.get("text-size-scale-range"),nt=s.ay(_,Be,Ce),[He,at]=I.get("icon-size-scale-range"),mt=s.ay(_,He,at),ze={bucket:v,layout:I,paint:M,posMatrix:$,invMatrix:_e,mercatorCenter:[s.aD(this.transform.center.lng),s.aH(this.transform.center.lat)],textLabelPlaneMatrix:we,labelToScreenMatrix:me,clippingData:ge,scale:B,textPixelRatio:F,holdingForFade:c.holdingForFade(),collisionBoxArray:L,partiallyEvaluatedTextSize:s.bH(v.textSizeData,this.transform.zoom,nt),partiallyEvaluatedIconSize:s.bH(v.iconSizeData,this.transform.zoom,mt),collisionGroup:this.collisionGroups.get(v.sourceID),latestFeatureIndex:c.latestFeatureIndex};if(p)for(const Te of v.sortKeyRanges){const{sortKey:Ze,symbolInstanceStart:Ue,symbolInstanceEnd:dt}=Te;t.push({sortKey:Ze,symbolInstanceStart:Ue,symbolInstanceEnd:dt,parameters:ze})}else t.push({symbolInstanceStart:0,symbolInstanceEnd:v.symbolInstances.length,parameters:ze})}attemptAnchorPlacement(t,r,c,p,_,v,b,I,M,L,B,F,V,$,H,X,Z,te,oe,le,pe){const{textOffset0:ye,textOffset1:we,crossTileID:me}=H,_e=[ye,we],ge=bn(t,v,b,_e,I),Be=this.collisionIndex.placeCollisionBox(Z,I,r,c,p,_,Mn(ge.x,ge.y,M,L,this.transform.angle),$,B,F,V.predicate);if(oe){const Ce=Z.getSymbolInstanceIconSize(pe,this.transform.zoom,H.placedIconSymbolIndex);if(this.collisionIndex.placeCollisionBox(Z,Ce,oe,c,p,_,Mn(ge.x,ge.y,M,L,this.transform.angle),$,B,F,V.predicate).box.length===0)return}if(Be.box.length>0){let Ce;return this.prevPlacement&&this.prevPlacement.variableOffsets[me]&&this.prevPlacement.placements[me]&&this.prevPlacement.placements[me].text&&(Ce=this.prevPlacement.variableOffsets[me].anchor),this.variableOffsets[me]={textOffset:_e,width:v,height:b,anchor:t,textScale:I,prevAnchor:Ce},this.markUsedJustification(Z,t,H,te),Z.allowVerticalPlacement&&(this.markUsedOrientation(Z,te,H),this.placedOrientations[me]=te),{shift:ge,placedGlyphBoxes:Be}}}placeLayerBucketPart(t,r,c,p,_=1){const{bucket:v,layout:b,paint:I,posMatrix:M,textLabelPlaneMatrix:L,labelToScreenMatrix:B,clippingData:F,textPixelRatio:V,mercatorCenter:$,invMatrix:H,holdingForFade:X,collisionBoxArray:Z,partiallyEvaluatedTextSize:te,partiallyEvaluatedIconSize:oe,collisionGroup:le,latestFeatureIndex:pe}=t.parameters,ye=b.get("text-optional"),we=b.get("icon-optional"),me=b.get("text-allow-overlap"),_e=b.get("icon-allow-overlap"),ge=b.get("text-rotation-alignment")==="map",Be=b.get("icon-rotation-alignment")==="map",Ce=b.get("text-pitch-alignment")==="map",nt=I.get("symbol-z-offset"),He=b.get("symbol-elevation-reference")==="sea",at=b.get("symbol-placement"),[mt,ze]=b.get("text-size-scale-range"),[Te,Ze]=b.get("icon-size-scale-range"),Ue=s.ay(_,mt,ze),dt=s.ay(_,Te,Ze),ft=b.get("text-variable-anchor"),xt=ge&&at!=="point",It=Be&&at!=="point",Qt=ft&&v.hasTextData(),oi=v.hasIconTextFit()&&Qt&&v.hasIconData();this.transform.setProjection(v.projection);const qt=Qt||xt,si=It||oi;let Jt=me&&(_e||!v.hasIconData()||we),Ci=_e&&(me||!v.hasTextData()||ye);const Fi=!nt.isConstant();!v.collisionArrays&&Z&&v.deserializeCollisionBoxes(Z),c&&p&&v.updateCollisionDebugBuffers(this.transform.zoom,Z,Ue,dt);const Hi=(ki,En,Dn)=>{const{crossTileID:sr,numVerticalGlyphVertices:Ni}=ki;let Sn=null;if(F&&F.dynamicFilterNeedsFeature||Fi){const Hr=this.retainedQueryData[v.bucketInstanceId];Sn=pe.loadFeature({featureIndex:ki.featureIndex,bucketIndex:Hr.bucketIndex,sourceLayerIndex:Hr.sourceLayerIndex,layoutVertexArrayOffset:0})}if(F&&!(0,F.dynamicFilter)({zoom:this.transform.zoom,pitch:this.transform.pitch},Sn,this.retainedQueryData[v.bucketInstanceId].tileID.canonical,new s.P(ki.tileAnchorX,ki.tileAnchorY),this.transform.calculateDistanceTileData(F.unwrappedTileID)))return this.placements[sr]=new co(!1,!1,!1,!0),void r.add(sr);const pn=nt.evaluate(Sn,{});if(r.has(sr))return;if(X)return void(this.placements[sr]=new co(!1,!1,!1));let Bn=!1,Si=!1,Qn=!0,Ln=!1,zr=!1,Tn=null,Nn={box:null,offscreen:null,occluded:null},tr={box:null},ls=null,pr=null,ts=null,Hs=0,po=0,no=0;Dn.textFeatureIndex?Hs=Dn.textFeatureIndex:ki.useRuntimeCollisionCircles&&(Hs=ki.featureIndex),Dn.verticalTextFeatureIndex&&(po=Dn.verticalTextFeatureIndex);const qs=Hr=>{Hr.tileID=this.retainedQueryData[v.bucketInstanceId].tileID;const qr=this.transform.elevation;Hr.elevation=He?pn:pn+(qr?qr.getAtTileOffset(Hr.tileID,Hr.tileAnchorX,Hr.tileAnchorY):0),Hr.elevation+=ki.zOffset},Fs=Dn.textBox;if(Fs){qs(Fs);const Hr=lr=>{let ms=s.bI.horizontal;if(v.allowVerticalPlacement&&!lr&&this.prevPlacement){const Is=this.prevPlacement.placedOrientations[sr];Is&&(this.placedOrientations[sr]=Is,ms=Is,this.markUsedOrientation(v,ms,ki))}return ms},qr=(lr,ms)=>{if(v.allowVerticalPlacement&&Ni>0&&Dn.verticalTextBox){for(const Is of v.writingModes)if(Is===s.bI.vertical?(Nn=ms(),tr=Nn):Nn=lr(),Nn&&Nn.box&&Nn.box.length)break}else Nn=lr()};if(ft){let lr=ft;if(this.prevPlacement&&this.prevPlacement.variableOffsets[sr]){const Or=this.prevPlacement.variableOffsets[sr];lr.indexOf(Or.anchor)>0&&(lr=lr.filter((la=>la!==Or.anchor)),lr.unshift(Or.anchor))}const ms=(Or,la,Tc)=>{const Kc=v.getSymbolInstanceTextSize(te,ki,this.transform.zoom,En),Fu=(Or.x2-Or.x1)*Kc+2*Or.padding,Yc=(Or.y2-Or.y1)*Kc+2*Or.padding,Lo=ki.hasIconTextFit&&!_e?la:null;Lo&&qs(Lo);let el={box:[],offscreen:!1,occluded:!1};const cs=me?2*lr.length:lr.length;for(let ca=0;ca<cs;++ca){const Ou=this.attemptAnchorPlacement(lr[ca%lr.length],Or,$,H,qt,Fu,Yc,Kc,ge,Ce,V,M,le,ca>=lr.length,ki,En,v,Tc,Lo,te,oe);if(Ou&&(el=Ou.placedGlyphBoxes,el&&el.box&&el.box.length)){Bn=!0,Tn=Ou.shift;break}}return el};qr((()=>ms(Fs,Dn.iconBox,s.bI.horizontal)),(()=>{const Or=Dn.verticalTextBox;return Or&&qs(Or),v.allowVerticalPlacement&&!(Nn&&Nn.box&&Nn.box.length)&&Ni>0&&Or?ms(Or,Dn.verticalIconBox,s.bI.vertical):{box:null,offscreen:null,occluded:null}})),Nn&&(Bn=Nn.box,Qn=Nn.offscreen,Ln=Nn.occluded);const Is=Hr(!(!Nn||!Nn.box));if(!Bn&&this.prevPlacement){const Or=this.prevPlacement.variableOffsets[sr];Or&&(this.variableOffsets[sr]=Or,this.markUsedJustification(v,Or.anchor,ki,Is))}}else{const lr=(ms,Is)=>{const Or=v.getSymbolInstanceTextSize(te,ki,this.transform.zoom,En,_),la=this.collisionIndex.placeCollisionBox(v,Or,ms,$,H,qt,new s.P(0,0),me,V,M,le.predicate);return la&&la.box&&la.box.length&&(this.markUsedOrientation(v,Is,ki),this.placedOrientations[sr]=Is),la};qr((()=>lr(Fs,s.bI.horizontal)),(()=>{const ms=Dn.verticalTextBox;return v.allowVerticalPlacement&&Ni>0&&ms?(qs(ms),lr(ms,s.bI.vertical)):{box:null,offscreen:null,occluded:null}})),Hr(!!(Nn&&Nn.box&&Nn.box.length))}}if(ls=Nn,Bn=ls&&ls.box&&ls.box.length>0,Qn=ls&&ls.offscreen,Ln=ls&&ls.occluded,ki.useRuntimeCollisionCircles){const Hr=v.text.placedSymbolArray.get(ki.centerJustifiedTextSymbolIndex>=0?ki.centerJustifiedTextSymbolIndex:ki.verticalPlacedTextSymbolIndex),qr=s.bJ(v.textSizeData,te,Hr),lr=b.get("text-padding");pr=this.collisionIndex.placeCollisionCircles(v,me,Hr,v.lineVertexArray,v.glyphOffsetArray,qr,M,L,B,c,Ce,le.predicate,ki.collisionCircleDiameter*qr/s.bU,lr,this.retainedQueryData[v.bucketInstanceId].tileID),Bn=me||pr.circles.length>0&&!pr.collisionDetected,Qn=Qn&&pr.offscreen,Ln=pr.occluded}if(Dn.iconFeatureIndex&&(no=Dn.iconFeatureIndex),Dn.iconBox){const Hr=qr=>{qs(qr);const lr=ki.hasIconTextFit&&Tn?Mn(Tn.x,Tn.y,ge,Ce,this.transform.angle):new s.P(0,0),ms=v.getSymbolInstanceIconSize(oe,this.transform.zoom,ki.placedIconSymbolIndex);return this.collisionIndex.placeCollisionBox(v,ms,qr,$,H,si,lr,_e,V,M,le.predicate)};tr&&tr.box&&tr.box.length&&Dn.verticalIconBox?(ts=Hr(Dn.verticalIconBox),Si=ts.box.length>0):(ts=Hr(Dn.iconBox),Si=ts.box.length>0),Qn=Qn&&ts.offscreen,zr=ts.occluded}const Wo=ye||ki.numHorizontalGlyphVertices===0&&Ni===0,aa=we||ki.numIconVertices===0;if(Wo||aa?aa?Wo||(Si=Si&&Bn):Bn=Si&&Bn:Si=Bn=Si&&Bn,Bn&&ls&&ls.box&&this.collisionIndex.insertCollisionBox(ls.box,b.get("text-ignore-placement"),v.bucketInstanceId,tr&&tr.box&&po?po:Hs,le.ID),Si&&ts&&this.collisionIndex.insertCollisionBox(ts.box,b.get("icon-ignore-placement"),v.bucketInstanceId,no,le.ID),pr&&(Bn&&this.collisionIndex.insertCollisionCircles(pr.circles,b.get("text-ignore-placement"),v.bucketInstanceId,Hs,le.ID),c)){const Hr=v.bucketInstanceId;let qr=this.collisionCircleArrays[Hr];qr===void 0&&(qr=this.collisionCircleArrays[Hr]=new su);for(let lr=0;lr<pr.circles.length;lr+=4)qr.circles.push(pr.circles[lr+0]),qr.circles.push(pr.circles[lr+1]),qr.circles.push(pr.circles[lr+2]),qr.circles.push(pr.collisionDetected?1:0)}const mo=v.projection.name!=="globe";Jt=Jt&&(mo||!Ln),Ci=Ci&&(mo||!zr),this.placements[sr]=new co(Bn||Jt,Si||Ci,Qn||v.justReloaded),r.add(sr)},gn=this.retainedQueryData[v.bucketInstanceId].tileID;if(v.elevationType==="offset"&&this.buildingIndex&&this.buildingIndex.updateZOffset(v,gn),v.elevationType==="road"&&v.updateRoadElevation(gn.canonical),v.updateZOffset(),v.sortFeaturesByY){const ki=v.getSortedSymbolIndexes(this.transform.angle);for(let En=ki.length-1;En>=0;--En){const Dn=ki[En];Hi(v.symbolInstances.get(Dn),Dn,v.collisionArrays[Dn])}v.hasAnyZOffset&&s.w(`${v.layerIds[0]} layer symbol-z-elevate: symbols are not sorted by elevation if symbol-z-order is evaluated to viewport-y`)}else if(v.hasAnyZOffset){const ki=v.getSortedIndexesByZOffset();for(let En=0;En<ki.length;++En){const Dn=ki[En];Hi(v.symbolInstances.get(Dn),Dn,v.collisionArrays[Dn])}}else for(let ki=t.symbolInstanceStart;ki<t.symbolInstanceEnd;ki++)Hi(v.symbolInstances.get(ki),ki,v.collisionArrays[ki]);if(c&&v.bucketInstanceId in this.collisionCircleArrays){const ki=this.collisionCircleArrays[v.bucketInstanceId];s.bi(ki.invProjMatrix,M),ki.viewportMatrix=this.collisionIndex.getViewportMatrix()}v.justReloaded=!1}markUsedJustification(t,r,c,p){const{leftJustifiedTextSymbolIndex:_,centerJustifiedTextSymbolIndex:v,rightJustifiedTextSymbolIndex:b,verticalPlacedTextSymbolIndex:I,crossTileID:M}=c,L=s.b$(r),B=p===s.bI.vertical?I:L==="left"?_:L==="center"?v:L==="right"?b:-1;_>=0&&(t.text.placedSymbolArray.get(_).crossTileID=B>=0&&_!==B?0:M),v>=0&&(t.text.placedSymbolArray.get(v).crossTileID=B>=0&&v!==B?0:M),b>=0&&(t.text.placedSymbolArray.get(b).crossTileID=B>=0&&b!==B?0:M),I>=0&&(t.text.placedSymbolArray.get(I).crossTileID=B>=0&&I!==B?0:M)}markUsedOrientation(t,r,c){const p=r===s.bI.horizontal||r===s.bI.horizontalOnly?r:0,_=r===s.bI.vertical?r:0,{leftJustifiedTextSymbolIndex:v,centerJustifiedTextSymbolIndex:b,rightJustifiedTextSymbolIndex:I,verticalPlacedTextSymbolIndex:M}=c,L=t.text.placedSymbolArray;v>=0&&(L.get(v).placedOrientation=p),b>=0&&(L.get(b).placedOrientation=p),I>=0&&(L.get(I).placedOrientation=p),M>=0&&(L.get(M).placedOrientation=_)}commit(t){this.commitTime=t,this.zoomAtLastRecencyCheck=this.transform.zoom;const r=this.prevPlacement;let c=!1;this.prevZoomAdjustment=r?r.zoomAdjustment(this.transform.zoom):0;const p=r?r.symbolFadeChange(t):1,_=r?r.opacities:{},v=r?r.variableOffsets:{},b=r?r.placedOrientations:{};for(const I in this.placements){const M=this.placements[I],L=_[I];L?(this.opacities[I]=new Ta(L,p,M.text,M.icon,null,M.clipped),c=c||M.text!==L.text.placed||M.icon!==L.icon.placed):(this.opacities[I]=new Ta(null,p,M.text,M.icon,M.skipFade,M.clipped),c=c||M.text||M.icon)}for(const I in _){const M=_[I];if(!this.opacities[I]){const L=new Ta(M,p,!1,!1);L.isHidden()||(this.opacities[I]=L,c=c||M.text.placed||M.icon.placed)}}for(const I in v)this.variableOffsets[I]||!this.opacities[I]||this.opacities[I].isHidden()||(this.variableOffsets[I]=v[I]);for(const I in b)this.placedOrientations[I]||!this.opacities[I]||this.opacities[I].isHidden()||(this.placedOrientations[I]=b[I]);c?this.lastPlacementChangeTime=t:typeof this.lastPlacementChangeTime!="number"&&(this.lastPlacementChangeTime=r?r.lastPlacementChangeTime:t)}updateLayerOpacities(t,r,c,p){const _=new Set;for(const v of r){const b=v.getBucket(t);b&&v.latestFeatureIndex&&t.fqid===b.layerIds[0]&&(this.updateBucketOpacities(b,_,v,v.collisionBoxArray,c,p,v.tileID,t.scope),b.elevationType==="offset"&&this.buildingIndex&&this.buildingIndex.updateZOffset(b,v.tileID),b.elevationType==="road"&&b.updateRoadElevation(v.tileID.canonical),b.updateZOffset())}}updateBucketOpacities(t,r,c,p,_,v,b,I){t.hasTextData()&&t.text.opacityVertexArray.clear(),t.hasIconData()&&t.icon.opacityVertexArray.clear(),t.hasIconCollisionBoxData()&&t.iconCollisionBox.collisionVertexArray.clear(),t.hasTextCollisionBoxData()&&t.textCollisionBox.collisionVertexArray.clear();const M=t.layers[0].layout,L=t.layers[0].paint,B=!!t.layers[0].dynamicFilter(),F=new Ta(null,0,!1,!1,!0),V=M.get("text-allow-overlap"),$=M.get("icon-allow-overlap"),H=M.get("text-variable-anchor"),X=M.get("text-rotation-alignment")==="map",Z=M.get("text-pitch-alignment")==="map",te=L.get("symbol-z-offset"),oe=M.get("symbol-elevation-reference")==="sea",le=!te.isConstant(),pe=new Ta(null,0,V&&($||!t.hasIconData()||M.get("icon-optional")),$&&(V||!t.hasTextData()||M.get("text-optional")),!0);!t.collisionArrays&&p&&(t.hasIconCollisionBoxData()||t.hasTextCollisionBoxData())&&t.deserializeCollisionBoxes(p);const ye=(me,_e,ge)=>{for(let Be=0;Be<_e/4;Be++)me.opacityVertexArray.emplaceBack(ge)};let we=0;v&&t.updateReplacement(b,v);for(let me=0;me<t.symbolInstances.length;me++){const _e=t.symbolInstances.get(me),{numHorizontalGlyphVertices:ge,numVerticalGlyphVertices:Be,crossTileID:Ce,numIconVertices:nt,tileAnchorX:He,tileAnchorY:at}=_e;let mt=null;const ze=this.retainedQueryData[t.bucketInstanceId];le&&_e&&ze&&(mt=c.latestFeatureIndex.loadFeature({featureIndex:_e.featureIndex,bucketIndex:ze.bucketIndex,sourceLayerIndex:ze.sourceLayerIndex,layoutVertexArrayOffset:0}));const Te=te.evaluate(mt,{}),Ze=r.has(Ce);let Ue=this.opacities[Ce];Ze?Ue=F:Ue||(Ue=pe,this.opacities[Ce]=Ue),r.add(Ce);const dt=ge>0||Be>0,ft=nt>0,xt=this.placedOrientations[Ce],It=xt===s.bI.vertical,Qt=xt===s.bI.horizontal||xt===s.bI.horizontalOnly;!dt&&!ft||Ue.isHidden()||we++;let oi=!1;if((dt||ft)&&v)for(const qt of t.activeReplacements){if(s.bV(qt,_,s.bW.Symbol,I)||qt.min.x>He||He>qt.max.x||qt.min.y>at||at>qt.max.y)continue;const si=s.bX(He,at,b.canonical,qt.footprintTileId.canonical);if(oi=s.bY(si,qt.footprint),oi)break}if(dt){const qt=oi?R:Ho(Ue.text);ye(t.text,ge,It?R:qt),ye(t.text,Be,Qt?R:qt);const si=Ue.text.isHidden(),{leftJustifiedTextSymbolIndex:Jt,centerJustifiedTextSymbolIndex:Ci,rightJustifiedTextSymbolIndex:Fi,verticalPlacedTextSymbolIndex:Hi}=_e,gn=t.text.placedSymbolArray,ki=si||It?1:0;Jt>=0&&(gn.get(Jt).hidden=ki),Ci>=0&&(gn.get(Ci).hidden=ki),Fi>=0&&(gn.get(Fi).hidden=ki),Hi>=0&&(gn.get(Hi).hidden=si||Qt?1:0);const En=this.variableOffsets[Ce];En&&this.markUsedJustification(t,En.anchor,_e,xt);const Dn=this.placedOrientations[Ce];Dn&&(this.markUsedJustification(t,"left",_e,Dn),this.markUsedOrientation(t,Dn,_e))}if(ft){const qt=oi?R:Ho(Ue.icon),{placedIconSymbolIndex:si,verticalPlacedIconSymbolIndex:Jt}=_e,Ci=t.icon.placedSymbolArray,Fi=Ue.icon.isHidden()?1:0;si>=0&&(ye(t.icon,nt,It?R:qt),Ci.get(si).hidden=Fi),Jt>=0&&(ye(t.icon,_e.numVerticalIconVertices,Qt?R:qt),Ci.get(Jt).hidden=Fi)}if(t.hasIconCollisionBoxData()||t.hasTextCollisionBoxData()){const qt=t.collisionArrays[me];if(qt){let si=new s.P(0,0),Jt=!0;if(qt.textBox||qt.verticalTextBox){if(H){const Fi=this.variableOffsets[Ce];Fi?(si=bn(Fi.anchor,Fi.width,Fi.height,Fi.textOffset,Fi.textScale),X&&si._rotate(Z?this.transform.angle:-this.transform.angle)):Jt=!1}B&&(Jt=!Ue.clipped),qt.textBox&&qa(t.textCollisionBox.collisionVertexArray,Ue.text.placed,!Jt||It,Te,oe,si.x,si.y),qt.verticalTextBox&&qa(t.textCollisionBox.collisionVertexArray,Ue.text.placed,!Jt||Qt,Te,oe,si.x,si.y)}const Ci=Jt&&!!(!Qt&&qt.verticalIconBox);qt.iconBox&&qa(t.iconCollisionBox.collisionVertexArray,Ue.icon.placed,Ci,Te,oe,_e.hasIconTextFit?si.x:0,_e.hasIconTextFit?si.y:0),qt.verticalIconBox&&qa(t.iconCollisionBox.collisionVertexArray,Ue.icon.placed,!Ci,Te,oe,_e.hasIconTextFit?si.x:0,_e.hasIconTextFit?si.y:0)}}}if(t.fullyClipped=we===0,t.sortFeatures(this.transform.angle),this.retainedQueryData[t.bucketInstanceId]&&(this.retainedQueryData[t.bucketInstanceId].featureSortOrder=t.featureSortOrder),t.hasTextData()&&t.text.opacityVertexBuffer&&t.text.opacityVertexBuffer.updateData(t.text.opacityVertexArray),t.hasIconData()&&t.icon.opacityVertexBuffer&&t.icon.opacityVertexBuffer.updateData(t.icon.opacityVertexArray),t.hasIconCollisionBoxData()&&t.iconCollisionBox.collisionVertexBuffer&&t.iconCollisionBox.collisionVertexBuffer.updateData(t.iconCollisionBox.collisionVertexArray),t.hasTextCollisionBoxData()&&t.textCollisionBox.collisionVertexBuffer&&t.textCollisionBox.collisionVertexBuffer.updateData(t.textCollisionBox.collisionVertexArray),t.bucketInstanceId in this.collisionCircleArrays){const me=this.collisionCircleArrays[t.bucketInstanceId];t.placementInvProjMatrix=me.invProjMatrix,t.placementViewportMatrix=me.viewportMatrix,t.collisionCircleArray=me.circles,delete this.collisionCircleArrays[t.bucketInstanceId]}}symbolFadeChange(t){return this.fadeDuration===0?1:(t-this.commitTime)/this.fadeDuration+this.prevZoomAdjustment}zoomAdjustment(t){return Math.max(0,(this.transform.zoom-t)/1.5)}hasTransitions(t){return this.stale||t-this.lastPlacementChangeTime<this.fadeDuration}stillRecent(t,r){const c=this.zoomAtLastRecencyCheck===r?1-this.zoomAdjustment(r):1;return this.zoomAtLastRecencyCheck=r,this.commitTime+this.fadeDuration*c>t}setStale(){this.stale=!0}}function qa(l,t,r,c,p,_,v){l.emplaceBack(t?1:0,r?1:0,_||0,v||0,c,p?1:0),l.emplaceBack(t?1:0,r?1:0,_||0,v||0,c,p?1:0),l.emplaceBack(t?1:0,r?1:0,_||0,v||0,c,p?1:0),l.emplaceBack(t?1:0,r?1:0,_||0,v||0,c,p?1:0)}const On=Math.pow(2,25),ou=Math.pow(2,24),sc=Math.pow(2,17),Vl=Math.pow(2,16),Vr=Math.pow(2,9),ss=Math.pow(2,8),wd=Math.pow(2,1);function Ho(l){if(l.opacity===0&&!l.placed)return 0;if(l.opacity===1&&l.placed)return 4294967295;const t=l.placed?1:0,r=Math.floor(127*l.opacity);return r*On+t*ou+r*sc+t*Vl+r*Vr+t*ss+r*wd+t}const R=0;class W{constructor(t){this._sortAcrossTiles=t.layout.get("symbol-z-order")!=="viewport-y"&&t.layout.get("symbol-sort-key").constantOr(1)!==void 0,this._currentTileIndex=0,this._currentPartIndex=0,this._seenCrossTileIDs=new Set,this._bucketParts=[]}continuePlacement(t,r,c,p,_,v){const b=this._bucketParts;for(;this._currentTileIndex<t.length;)if(r.getBucketParts(b,p,t[this._currentTileIndex],this._sortAcrossTiles,v),this._currentTileIndex++,_())return!0;for(this._sortAcrossTiles&&(this._sortAcrossTiles=!1,b.sort(((I,M)=>I.sortKey-M.sortKey)));this._currentPartIndex<b.length;){const I=b[this._currentPartIndex];if(r.placeLayerBucketPart(I,this._seenCrossTileIDs,c,I.symbolInstanceStart===0,v),this._currentPartIndex++,_())return!0}return!1}}class ie{constructor(t,r,c,p,_,v,b,I,M){this.placement=new Cs(t,_,v,b,I,M),this._currentPlacementIndex=r.length-1,this._forceFullPlacement=c,this._showCollisionBoxes=p,this._done=!1}isDone(){return this._done}continuePlacement(t,r,c,p,_){const v=s.q.now(),b=()=>{const I=s.q.now()-v;return!this._forceFullPlacement&&I>2};for(;this._currentPlacementIndex>=0;){const I=r[t[this._currentPlacementIndex]],M=this.placement.collisionIndex.transform.zoom;if(I.type==="symbol"&&(!I.minzoom||I.minzoom<=M)&&(!I.maxzoom||I.maxzoom>M)){const L=I,B=L.layout.get("symbol-z-elevate"),F=L.layout.get("symbol-sort-key").constantOr(1)!==void 0,V=L.layout.get("symbol-z-order"),$=V==="viewport-y"||V==="auto"&&!(V!=="viewport-y"&&F),H=L.layout.get("text-allow-overlap")||L.layout.get("icon-allow-overlap")||L.layout.get("text-ignore-placement")||L.layout.get("icon-ignore-placement"),X=$&&H,Z=this._inProgressLayer=this._inProgressLayer||new W(L),te=s.C(I.source,I.scope);if(Z.continuePlacement(B||X?p[te]:c[te],this.placement,this._showCollisionBoxes,I,b,_))return;delete this._inProgressLayer}this._currentPlacementIndex--}this._done=!0}commit(t){return this.placement.commit(t),this.placement}}const Se=512/s.aj/2;class pt{constructor(t,r,c){this.tileID=t,this.bucketInstanceId=c,this.index=new s.c0(r.length,16,Int32Array),this.keys=[],this.crossTileIDs=[];const p=t.canonical.x*s.aj,_=t.canonical.y*s.aj;for(let v=0;v<r.length;v++){const{key:b,crossTileID:I,tileAnchorX:M,tileAnchorY:L}=r.get(v),B=Math.floor((p+M)*Se),F=Math.floor((_+L)*Se);this.index.add(B,F),this.keys.push(b),this.crossTileIDs.push(I)}this.index.finish()}findMatches(t,r,c){const p=this.tileID.canonical.z<r.canonical.z?1:Math.pow(2,this.tileID.canonical.z-r.canonical.z),_=Se/Math.pow(2,r.canonical.z-this.tileID.canonical.z),v=r.canonical.x*s.aj,b=r.canonical.y*s.aj;for(let I=0;I<t.length;I++){const M=t.get(I);if(M.crossTileID)continue;const{key:L,tileAnchorX:B,tileAnchorY:F}=M,V=Math.floor((v+B)*_),$=Math.floor((b+F)*_),H=this.index.range(V-p,$-p,V+p,$+p).sort(((X,Z)=>X-Z));for(const X of H){const Z=this.crossTileIDs[X];if(this.keys[X]===L&&!c.has(Z)){c.add(Z),M.crossTileID=Z;break}}}}}class Mt{constructor(){this.maxCrossTileID=0}generate(){return++this.maxCrossTileID}}class vi{constructor(){this.indexes={},this.usedCrossTileIDs={},this.lng=0}handleWrapJump(t){const r=Math.round((t-this.lng)/360);if(r!==0)for(const c in this.indexes){const p=this.indexes[c],_={};for(const v in p){const b=p[v];b.tileID=b.tileID.unwrapTo(b.tileID.wrap+r),_[b.tileID.key]=b}this.indexes[c]=_}this.lng=t}addBucket(t,r,c){if(this.indexes[t.overscaledZ]&&this.indexes[t.overscaledZ][t.key]){if(this.indexes[t.overscaledZ][t.key].bucketInstanceId===r.bucketInstanceId)return!1;this.removeBucketCrossTileIDs(t.overscaledZ,this.indexes[t.overscaledZ][t.key])}for(let _=0;_<r.symbolInstances.length;_++)r.symbolInstances.get(_).crossTileID=0;this.usedCrossTileIDs[t.overscaledZ]||(this.usedCrossTileIDs[t.overscaledZ]=new Set);const p=this.usedCrossTileIDs[t.overscaledZ];for(const _ in this.indexes){const v=this.indexes[_];if(Number(_)>t.overscaledZ)for(const b in v){const I=v[b];I.tileID.isChildOf(t)&&I.findMatches(r.symbolInstances,t,p)}else{const b=v[t.scaledTo(Number(_)).key];b&&b.findMatches(r.symbolInstances,t,p)}}for(let _=0;_<r.symbolInstances.length;_++){const v=r.symbolInstances.get(_);v.crossTileID||(v.crossTileID=c.generate(),p.add(v.crossTileID))}return this.indexes[t.overscaledZ]===void 0&&(this.indexes[t.overscaledZ]={}),this.indexes[t.overscaledZ][t.key]=new pt(t,r.symbolInstances,r.bucketInstanceId),!0}removeBucketCrossTileIDs(t,r){for(const c of r.crossTileIDs)this.usedCrossTileIDs[t].delete(c)}removeStaleBuckets(t){let r=!1;for(const c in this.indexes){const p=this.indexes[c];for(const _ in p)t[p[_].bucketInstanceId]||(this.removeBucketCrossTileIDs(c,p[_]),delete p[_],r=!0)}return r}}class Yn{constructor(){this.layerIndexes={},this.crossTileIDs=new Mt,this.maxBucketInstanceId=0,this.bucketsInCurrentPlacement={}}addLayer(t,r,c,p){let _=this.layerIndexes[t.fqid];_===void 0&&(_=this.layerIndexes[t.fqid]=new vi);let v=!1;const b={};p.name!=="globe"&&_.handleWrapJump(c);for(const I of r){const M=I.getBucket(t);M&&t.fqid===M.layerIds[0]&&(M.bucketInstanceId||(M.bucketInstanceId=++this.maxBucketInstanceId),_.addBucket(I.tileID,M,this.crossTileIDs)&&(v=!0),b[M.bucketInstanceId]=!0)}return _.removeStaleBuckets(b)&&(v=!0),v}pruneUnusedLayers(t){const r={};t.forEach((c=>{r[c]=!0}));for(const c in this.layerIndexes)r[c]||delete this.layerIndexes[c]}}const fs=771;class ui{constructor(t,r,c,p){this.blendFunction=t,this.blendColor=r.toNonPremultipliedRenderColor(null),this.mask=c,this.blendEquation=p}}ui.Replace=[1,0,1,0],ui.disabled=new ui(ui.Replace,s.am.transparent,[!1,!1,!1,!1]),ui.unblended=new ui(ui.Replace,s.am.transparent,[!0,!0,!0,!0]),ui.alphaBlended=new ui([1,fs,1,fs],s.am.transparent,[!0,!0,!0,!0]),ui.alphaBlendedNonPremultiplied=new ui([770,fs,770,fs],s.am.transparent,[!0,!0,!0,!0]),ui.multiply=new ui([774,0,774,0],s.am.transparent,[!0,!0,!0,!0]);class Vt{constructor(t,r,c){this.func=t,this.mask=r,this.range=c}}Vt.ReadOnly=!1,Vt.ReadWrite=!0,Vt.disabled=new Vt(519,Vt.ReadOnly,[0,1]);const Ur=7680;class _i{constructor(t,r,c,p,_,v){this.test=t,this.ref=r,this.mask=c,this.fail=p,this.depthFail=_,this.pass=v}}_i.disabled=new _i({func:519,mask:0},0,0,Ur,Ur,Ur);const gr=1029,dl=2305;class gi{constructor(t,r,c){this.enable=t,this.mode=r,this.frontFace=c}}function au(l,t){const r=s.c6(l,3);s.c8(l,t),s.cc(l,3,r)}function lu(l,t){const r=s.c3([]);return s.c4(r,r,-t),s.c5(r,r,-l),r}function oc(l,t){const r=[l[0],l[1],0],c=[t[0],t[1],0];if(s.ae(r)>=1e-15){const v=s.au([],r);s.c1(c,v,s.bG(c,v)),t[0]=c[0],t[1]=c[1]}const p=s.bF([],t,l);if(s.c2(p)<1e-15)return null;const _=Math.atan2(-p[1],p[0]);return lu(Math.atan2(Math.sqrt(l[0]*l[0]+l[1]*l[1]),-l[2]),_)}gi.disabled=new gi(!1,gr,dl),gi.backCCW=new gi(!0,gr,dl),gi.backCW=new gi(!0,gr,2304),gi.frontCW=new gi(!0,1028,2304),gi.frontCCW=new gi(!0,1028,dl);class cu{constructor(t,r){this.position=t,this.orientation=r}get position(){return this._position}set position(t){if(t){const r=t instanceof s.ac?t:new s.ac(t[0],t[1],t[2]);this._renderWorldCopies&&(r.x=s.bQ(r.x,0,1)),this._position=r}else this._position=null}lookAtPoint(t,r){if(this.orientation=null,!this.position)return;const c=this.position,p=this._elevation?this._elevation.getAtPointOrZero(s.ac.fromLngLat(t)):0,_=s.ac.fromLngLat(t,p),v=[_.x-c.x,_.y-c.y,_.z-c.z];r||(r=[0,0,1]),r[2]=Math.abs(r[2]),this.orientation=oc(v,r)}setPitchBearing(t,r){this.orientation=lu(s.al(t),s.al(-r))}}class $a{constructor(t,r){this._transform=s.bx([]),this.orientation=r,this.position=t}get mercatorPosition(){const t=this.position;return new s.ac(t[0],t[1],t[2])}get position(){const t=s.c6(this._transform,3);return[t[0],t[1],t[2]]}set position(t){var r;t&&s.cc(this._transform,3,[(r=t)[0],r[1],r[2],1])}get orientation(){return this._orientation}set orientation(t){this._orientation=t||s.c3([]),t&&au(this._transform,this._orientation)}getPitchBearing(){const t=this.forward(),r=this.right();return{bearing:Math.atan2(-r[1],r[0]),pitch:Math.atan2(Math.sqrt(t[0]*t[0]+t[1]*t[1]),-t[2])}}setPitchBearing(t,r){this._orientation=lu(t,r),au(this._transform,this._orientation)}forward(){const t=s.c6(this._transform,2);return[-t[0],-t[1],-t[2]]}up(){const t=s.c6(this._transform,1);return[-t[0],-t[1],-t[2]]}right(){const t=s.c6(this._transform,0);return[t[0],t[1],t[2]]}getCameraToWorld(t,r){const c=new Float64Array(16);return s.bi(c,this.getWorldToCamera(t,r)),c}getCameraToWorldMercator(){return this._transform}getWorldToCameraPosition(t,r,c){const p=this.position;s.c1(p,p,-t);const _=new Float64Array(16);return s.bn(_,[c,c,c]),s.bo(_,_,p),_[10]*=r,_}getWorldToCamera(t,r){const c=new Float64Array(16),p=new Float64Array(4),_=this.position;return s.c7(p,this._orientation),s.c1(_,_,-t),s.c8(c,p),s.bo(c,c,_),c[1]*=-1,c[5]*=-1,c[9]*=-1,c[13]*=-1,c[8]*=r,c[9]*=r,c[10]*=r,c[11]*=r,c}getCameraToClipPerspective(t,r,c,p){const _=new Float64Array(16);return s.c9(_,t,r,c,p),_}getCameraToClipOrthographic(t,r,c,p,_,v){const b=new Float64Array(16);return s.ca(b,t,r,c,p,_,v),b}getDistanceToElevation(t,r=!1){const c=t===0?0:s.cb(t,r?s.aY(this.position[1]):this.position[1]),p=this.forward();return(c-this.position[2])/p[2]}clone(){return new $a([...this.position],[...this.orientation])}}const Co={BaseColor:5,MetallicRoughness:6,Normal:7,Occlusion:8,Emission:9,LUT:10,ShadowMap0:11};class Ph{constructor(t=0,r=0,c=0,p=0){if(isNaN(t)||t<0||isNaN(r)||r<0||isNaN(c)||c<0||isNaN(p)||p<0)throw new Error("Invalid value for edge-insets, top, bottom, left and right must all be numbers");this.top=t,this.bottom=r,this.left=c,this.right=p}interpolate(t,r,c){return r.top!=null&&t.top!=null&&(this.top=s.ai(t.top,r.top,c)),r.bottom!=null&&t.bottom!=null&&(this.bottom=s.ai(t.bottom,r.bottom,c)),r.left!=null&&t.left!=null&&(this.left=s.ai(t.left,r.left,c)),r.right!=null&&t.right!=null&&(this.right=s.ai(t.right,r.right,c)),this}getCenter(t,r){const c=s.ay((this.left+t-this.right)/2,0,t),p=s.ay((this.top+r-this.bottom)/2,0,r);return new s.P(c,p)}equals(t){return this.top===t.top&&this.bottom===t.bottom&&this.left===t.left&&this.right===t.right}clone(){return new Ph(this.top,this.bottom,this.left,this.right)}toJSON(){return{top:this.top,bottom:this.bottom,left:this.left,right:this.right}}}const Ms=15;class bd{constructor(t,r,c,p,_,v,b){this.tileSize=512,this._renderWorldCopies=_===void 0||_,this._minZoom=t||0,this._maxZoom=r||22,this._minPitch=c??0,this._maxPitch=p??60,this.setProjection(v),this.setMaxBounds(b),this.width=0,this.height=0,this._center=new s.ci(0,0),this.zoom=0,this.angle=0,this._fov=.6435011087932844,this._pitch=0,this._nearZ=0,this._farZ=0,this._unmodified=!0,this._edgeInsets=new Ph,this._projMatrixCache={},this._alignedProjMatrixCache={},this._fogTileMatrixCache={},this._expandedProjMatrixCache={},this._distanceTileDataCache={},this._camera=new $a,this._centerAltitude=0,this._averageElevation=0,this.cameraElevationReference="ground",this._pixelsPerMercatorPixel=1,this.globeRadius=0,this.globeCenterInViewSpace=[0,0,0],this._tileCoverLift=0,this.freezeTileCoverage=!1,this._horizonShift=.1,this._orthographicProjectionAtLowPitch=!1,this._allowWorldUnderZoom=!1}clone(){const t=new bd(this._minZoom,this._maxZoom,this._minPitch,this.maxPitch,this._renderWorldCopies,this.getProjection(),this.maxBounds);return t._elevation=this._elevation,t._centerAltitude=this._centerAltitude,t._centerAltitudeValidForExaggeration=this._centerAltitudeValidForExaggeration,t.tileSize=this.tileSize,t.mercatorFromTransition=this.mercatorFromTransition,t.width=this.width,t.height=this.height,t.cameraElevationReference=this.cameraElevationReference,t._center=this._center,t._setZoom(this.zoom),t._seaLevelZoom=this._seaLevelZoom,t.angle=this.angle,t._fov=this._fov,t._pitch=this._pitch,t._nearZ=this._nearZ,t._farZ=this._farZ,t._averageElevation=this._averageElevation,t._orthographicProjectionAtLowPitch=this._orthographicProjectionAtLowPitch,t._unmodified=this._unmodified,t._edgeInsets=this._edgeInsets.clone(),t._camera=this._camera.clone(),t._calcMatrices(),t.freezeTileCoverage=this.freezeTileCoverage,t.frustumCorners=this.frustumCorners,t._allowWorldUnderZoom=this._allowWorldUnderZoom,t}get isOrthographic(){return this.projection.name!=="globe"&&this._orthographicProjectionAtLowPitch&&this.pitch<Ms}get elevation(){return this._elevation}set elevation(t){this._elevation!==t&&(this._elevation=t,this._updateCameraOnTerrain(),this._calcMatrices())}get depthOcclusionForSymbolsAndCircles(){return this.projection.name!=="globe"&&!this.isOrthographic}updateElevation(t,r=!1){const c=this._elevation&&this._elevation.exaggeration()!==this._centerAltitudeValidForExaggeration;(this._seaLevelZoom==null||c)&&this._updateCameraOnTerrain(),(t||c)&&this._constrainCamera(r),this._calcMatrices()}getProjection(){return s.aF(this.projection,["name","center","parallels"])}setProjection(t){this.projectionOptions=t||{name:"mercator"};const r=this.projection?this.getProjection():void 0;this.projection=s.cj(this.projectionOptions);const c=this.getProjection(),p=!s.bv(r,c);return p&&this._calcMatrices(),this.mercatorFromTransition=!1,p}setOrthographicProjectionAtLowPitch(t){return this._orthographicProjectionAtLowPitch!==t&&(this._orthographicProjectionAtLowPitch=t,this._calcMatrices(),!0)}setMercatorFromTransition(){const t=this.projection.name;this.mercatorFromTransition=!0,this.projectionOptions={name:"mercator"},this.projection=s.cj({name:"mercator"});const r=t!==this.projection.name;return r&&this._calcMatrices(),r}get minZoom(){return this._minZoom}set minZoom(t){this._minZoom!==t&&(this._minZoom=t,this.zoom=Math.max(this.zoom,t))}get maxZoom(){return this._maxZoom}set maxZoom(t){this._maxZoom!==t&&(this._maxZoom=t,this.zoom=Math.min(this.zoom,t))}get minPitch(){return this._minPitch}set minPitch(t){this._minPitch!==t&&(this._minPitch=t,this.pitch=Math.max(this.pitch,t))}get maxPitch(){return this._maxPitch}set maxPitch(t){this._maxPitch!==t&&(this._maxPitch=t,this.pitch=Math.min(this.pitch,t))}get renderWorldCopies(){return this._renderWorldCopies&&this.projection.supportsWorldCopies===!0}set renderWorldCopies(t){t===void 0?t=!0:t===null&&(t=!1),this._renderWorldCopies=t}get worldSize(){return this.tileSize*this.scale}get cameraWorldSizeForFog(){const t=Math.max(this._camera.getDistanceToElevation(this._averageElevation),Number.EPSILON);return this._worldSizeFromZoom(this._zoomFromMercatorZ(t))}get cameraWorldSize(){const t=Math.max(this._camera.getDistanceToElevation(this._averageElevation,!0),Number.EPSILON);return this._worldSizeFromZoom(this._zoomFromMercatorZ(t))}get pixelsPerMeter(){return this.projection.pixelsPerMeter(this.center.lat,this.worldSize)}get cameraPixelsPerMeter(){return s.cb(1,this.center.lat)*this.cameraWorldSizeForFog}get centerOffset(){return this.centerPoint._sub(this.size._div(2))}get size(){return new s.P(this.width,this.height)}get bearing(){return s.bQ(this.rotation,-180,180)}set bearing(t){this.rotation=t}get rotation(){return-this.angle/Math.PI*180}set rotation(t){const r=-t*Math.PI/180;this.angle!==r&&(this._unmodified=!1,this.angle=r,this._calcMatrices(),this.rotationMatrix=s.ck(),s.cl(this.rotationMatrix,this.rotationMatrix,this.angle))}get pitch(){return this._pitch/Math.PI*180}set pitch(t){const r=s.ay(t,this.minPitch,this.maxPitch)/180*Math.PI;this._pitch!==r&&(this._unmodified=!1,this._pitch=r,this._calcMatrices())}get aspect(){return this.width/this.height}get fov(){return this._fov/Math.PI*180}set fov(t){t=Math.max(.01,Math.min(60,t)),this._fov!==t&&(this._unmodified=!1,this._fov=s.al(t),this._calcMatrices())}get fovX(){return this._fov}get fovY(){const t=1/Math.tan(.5*this.fovX);return 2*Math.atan(1/this.aspect/t)}get averageElevation(){return this._averageElevation}set averageElevation(t){this._averageElevation=t,this._calcFogMatrices(),this._distanceTileDataCache={}}get zoom(){return this._zoom}set zoom(t){const r=Math.min(Math.max(t,this.minZoom),this.maxZoom);this._zoom!==r&&(this._unmodified=!1,this._setZoom(r),this._updateSeaLevelZoom(),this._constrain(),this._calcMatrices())}_setZoom(t){this._zoom=t,this.scale=this.zoomScale(t),this.tileZoom=Math.floor(t),this.zoomFraction=t-this.tileZoom}get tileCoverLift(){return this._tileCoverLift}set tileCoverLift(t){this._tileCoverLift!==t&&(this._tileCoverLift=t)}_updateCameraOnTerrain(){const t=this.elevation?this.elevation.getAtPoint(this.locationCoordinate(this.center),Number.NEGATIVE_INFINITY):Number.NEGATIVE_INFINITY,r=this.elevation&&t===Number.NEGATIVE_INFINITY&&this.elevation.visibleDemTiles.length>0&&this.elevation.exaggeration()>0&&this._centerAltitudeValidForExaggeration;if(!this._elevation||t===Number.NEGATIVE_INFINITY&&(!r||!this._centerAltitude))return this._centerAltitude=0,this._seaLevelZoom=null,void(this._centerAltitudeValidForExaggeration=void 0);const c=this._elevation;r||this._centerAltitude&&this._centerAltitudeValidForExaggeration&&c.exaggeration()&&this._centerAltitudeValidForExaggeration!==c.exaggeration()?(this._centerAltitude=this._centerAltitude/this._centerAltitudeValidForExaggeration*c.exaggeration(),this._centerAltitudeValidForExaggeration=c.exaggeration()):(this._centerAltitude=t||0,this._centerAltitudeValidForExaggeration=c.exaggeration()),this._updateSeaLevelZoom()}_updateSeaLevelZoom(){if(this._centerAltitudeValidForExaggeration===void 0)return;const t=Math.max(0,(this.pixelsPerMeter*this._centerAltitude+this.cameraToCenterDistance)/this.worldSize);this._seaLevelZoom=this._zoomFromMercatorZ(t)}sampleAverageElevation(){if(!this._elevation)return 0;const t=this._elevation,r=[[.5,.2],[.3,.5],[.5,.5],[.7,.5],[.5,.8]],c=this.horizonLineFromTop();let p=0,_=0;for(let v=0;v<r.length;v++){const b=new s.P(r[v][0]*this.width,c+r[v][1]*(this.height-c)),I=t.pointCoordinate(b);if(!I)continue;const M=1/Math.hypot(I[0]-this._camera.position[0],I[1]-this._camera.position[1]);p+=I[3]*M,_+=M}return _===0?NaN:p/_}get center(){return this._center}set center(t){t.lat===this._center.lat&&t.lng===this._center.lng||(this._unmodified=!1,this._center=t,this._terrainEnabled()&&(this.cameraElevationReference==="ground"?this._updateCameraOnTerrain():this._updateZoomFromElevation()),this._constrain(),this._calcMatrices())}_updateZoomFromElevation(){if(this._seaLevelZoom==null||!this._elevation)return;const t=this._seaLevelZoom,r=this._elevation.getAtPointOrZero(this.locationCoordinate(this.center)),c=this.pixelsPerMeter/this.worldSize*r,p=this._mercatorZfromZoom(t),_=this._mercatorZfromZoom(this._maxZoom),v=Math.max(p-c,_);this._setZoom(this._zoomFromMercatorZ(v))}get padding(){return this._edgeInsets.toJSON()}set padding(t){this._edgeInsets.equals(t)||(this._unmodified=!1,this._edgeInsets.interpolate(this._edgeInsets,t,1),this._calcMatrices())}computeZoomRelativeTo(t){const r=this.rayIntersectionCoordinate(this.pointRayIntersection(this.centerPoint,t.toAltitude()));let c;c=t.z<this._camera.position[2]?[r.x,r.y,r.z]:[t.x,t.y,t.z];const p=s.ae(s.at([],this._camera.position,c));return s.ay(this._zoomFromMercatorZ(p),this._minZoom,this._maxZoom)}setFreeCameraOptions(t){if(!this.height||!t.position&&!t.orientation)return;this._updateCameraState();let r=!1;if(t.orientation&&!s.cm(t.orientation,this._camera.orientation)&&(r=this._setCameraOrientation(t.orientation)),t.position){const c=[t.position.x,t.position.y,t.position.z];s.cn(c,this._camera.position)||(this._setCameraPosition(c),r=!0)}r&&(this._updateStateFromCamera(),this.recenterOnTerrain())}getFreeCameraOptions(){this._updateCameraState();const t=this._camera.position,r=new cu;return r.position=new s.ac(t[0],t[1],t[2]),r.orientation=this._camera.orientation,r._elevation=this.elevation,r._renderWorldCopies=this.renderWorldCopies,r}_setCameraOrientation(t){if(!s.co(t))return!1;s.cp(t,t);const r=s.cq([],[0,0,-1],t),c=s.cq([],[0,-1,0],t);if(c[2]<0)return!1;const p=oc(r,c);return!!p&&(this._camera.orientation=p,!0)}_setCameraPosition(t){const r=this.zoomScale(this.minZoom)*this.tileSize,c=this.zoomScale(this.maxZoom)*this.tileSize,p=this.cameraToCenterDistance;t[2]=s.ay(t[2],p/c,p/r),this._camera.position=t}get centerPoint(){return this._edgeInsets.getCenter(this.width,this.height)}get fovAboveCenter(){return this._fov*(.5+this.centerOffset.y/this.height)}isPaddingEqual(t){return this._edgeInsets.equals(t)}interpolatePadding(t,r,c){this._unmodified=!1,this._edgeInsets.interpolate(t,r,c),this._constrain(),this._calcMatrices()}coveringZoomLevel(t){const r=(t.roundZoom?Math.round:Math.floor)(this.zoom+this.scaleZoom(this.tileSize/t.tileSize));return Math.max(0,r)}getVisibleUnwrappedCoordinates(t){const r=[new s.cr(0,t)];if(this.renderWorldCopies){const c=this.pointCoordinate(new s.P(0,0)),p=this.pointCoordinate(new s.P(this.width,0)),_=this.pointCoordinate(new s.P(this.width,this.height)),v=this.pointCoordinate(new s.P(0,this.height)),b=Math.floor(Math.min(c.x,p.x,_.x,v.x)),I=Math.floor(Math.max(c.x,p.x,_.x,v.x)),M=1;for(let L=b-M;L<=I+M;L++)L!==0&&r.push(new s.cr(L,t))}return r}isLODDisabled(t){return(!t||this.pitch<=60)&&this._edgeInsets.top<=this._edgeInsets.bottom&&!this._elevation&&!this.projection.isReprojectedInTileSpace}extendTileCover(t,r,c){let p=[];const _=c!=null,v=!_;if(v&&this.zoom<r||_&&c[0]===0&&c[1]===0)return p;const b=new Set,I=(L,B,F,V,$)=>{const H=s.cV(B,L,F,V,$);b.has(H)||(p.push(new s.aM(L,B,F,V,$)),b.add(H))};for(let L=0;L<t.length;L++){const B=t[L];if(v&&B.canonical.z!==r)continue;const F=B.canonical,V=B.overscaledZ,$=B.wrap,H=1<<F.z,X=F.x+1<H,Z=F.x>0,te=F.y+1<H,oe=F.y>0,le=B.wrap-(Z?0:1),pe=B.wrap+(X?0:1),ye=Z?F.x-1:H-1,we=X?F.x+1:0;if(_)c[0]<0?(I(V,pe,F.z,we,F.y),c[1]<0&&te&&(I(V,$,F.z,F.x,F.y+1),I(V,pe,F.z,we,F.y+1)),c[1]>0&&oe&&(I(V,$,F.z,F.x,F.y-1),I(V,pe,F.z,we,F.y-1))):c[0]>0?(I(V,le,F.z,ye,F.y),c[1]<0&&te&&(I(V,$,F.z,F.x,F.y+1),I(V,le,F.z,ye,F.y+1)),c[1]>0&&oe&&(I(V,$,F.z,F.x,F.y-1),I(V,le,F.z,ye,F.y-1))):c[1]<0&&te?I(V,$,F.z,F.x,F.y+1):oe&&I(V,$,F.z,F.x,F.y-1);else{const me=B.visibleQuadrants;1&me&&(I(V,le,F.z,ye,F.y),oe&&(I(V,$,F.z,F.x,F.y-1),I(V,le,F.z,ye,F.y-1))),2&me&&(I(V,pe,F.z,we,F.y),oe&&(I(V,$,F.z,F.x,F.y-1),I(V,pe,F.z,we,F.y-1))),4&me&&(I(V,le,F.z,ye,F.y),te&&(I(V,$,F.z,F.x,F.y+1),I(V,le,F.z,ye,F.y+1))),8&me&&(I(V,pe,F.z,we,F.y),te&&(I(V,$,F.z,F.x,F.y+1),I(V,pe,F.z,we,F.y+1)))}}const M=[];for(const L of p)p.some((B=>L.isChildOf(B)))||M.push(L);if(p=M.filter((L=>!t.some((B=>!!(L.overscaledZ<r&&B.isChildOf(L))||L.equals(B)||L.isChildOf(B))))),v){const L=1<<r,B=this.projection.name==="globe"?this._camera.mercatorPosition:this.pointCoordinate(this.getCameraPoint()),F=[L*B.x,L*B.y],V=4,$=V*V;p=p.filter((H=>{const X=H.canonical.x+.5-F[0],Z=H.canonical.y+.5-F[1];return X*X+Z*Z<$}))}return p}extendTileCoverToNearPlane(t,r,c){const p=[],_=new Set;for(const te of t)_.add(te.key);const v=(te,oe,le,pe,ye)=>{const we=s.cV(oe,te,le,pe,ye);_.has(we)||(p.push(new s.aM(te,oe,le,pe,ye)),_.add(we))},b=t.reduce(((te,oe)=>Math.max(te,oe.overscaledZ)),c),I=1<<c,M=[new s.P(0,0),new s.P(s.aj,0),new s.P(s.aj,s.aj),new s.P(0,s.aj)],L=new s.P(0,0),B=new s.P(0,0),F=(te,oe)=>{const le=Math.floor(te[0]),pe=Math.floor(te[1]),ye=(te[0]-le)*s.aj,we=(te[1]-pe)*s.aj,me=Math.floor(oe[0]),_e=Math.floor(oe[1]),ge=(oe[0]-me)*s.aj,Be=(oe[1]-_e)*s.aj;for(let Ce=-1;Ce<=1;Ce++){const nt=le+Ce;if(!(nt<0||nt>=I)){L.x=ye-Ce*s.aj,B.x=ge-(nt-me)*s.aj;for(let He=-1;He<=1;He++){const at=pe+He;L.y=we-He*s.aj,B.y=Be-(at-_e)*s.aj,s.cW(L,B,M)&&v(b,0,c,nt,at)}}}},V=r.points,$=V[s.cs],H=V[s.ct],X=this._projectToGround($,V[s.cu]),Z=this._projectToGround(H,V[s.cv]);return F($,X),F(H,Z),p}_projectToGround(t,r){return s.cw(s.cx(),t,r,t[2]/(t[2]-r[2]))}coveringTiles(t){let r=this.coveringZoomLevel(t);const c=r,p=this.elevation&&this.elevation.exaggeration(),_=p&&!t.isTerrainDEM,v=this.projection.name==="mercator";if(t.minzoom!==void 0&&r<t.minzoom)return[];t.maxzoom!==void 0&&r>t.maxzoom&&(r=t.maxzoom);const b=this.locationCoordinate(this.center),I=this.center.lat,M=1<<r,L=[M*b.x,M*b.y,0],B=this.projection.name==="globe",F=!B,V=s.cy.fromInvProjectionMatrix(this.invProjMatrix,this.worldSize,r,F),$=B?this._camera.mercatorPosition:this.pointCoordinate(this.getCameraPoint()),H=M*s.cb(1,this.center.lat),X=this._camera.position[2]/s.cb(1,this.center.lat),Z=[M*$.x,M*$.y,X*(F?1:H)],te=B||p,oe=this.cameraToCenterDistance/t.tileSize*(t.roundZoom?1:.502),le=this.isLODDisabled(!0)?r:0;let pe;if(this._elevation&&t.isTerrainDEM)pe=1e4*this._elevation.exaggeration();else if(this._elevation){const Te=this._elevation.getMinMaxForVisibleTiles();pe=Te?Te.max:this._centerAltitude}else pe=this._centerAltitude;const ye=t.isTerrainDEM?-pe:this._elevation?this._elevation.getMinElevationBelowMSL():0,we=this.projection.isReprojectedInTileSpace?s.cz(this):1,me=Te=>{const Ue=new s.ac(Te.x+25e-6,Te.y,Te.z),dt=new s.ac(Te.x,Te.y+25e-6,Te.z),ft=Te.toLngLat(),xt=Ue.toLngLat(),It=dt.toLngLat(),Qt=this.locationCoordinate(ft),oi=this.locationCoordinate(xt),qt=this.locationCoordinate(It),si=Math.hypot(oi.x-Qt.x,oi.y-Qt.y),Jt=Math.hypot(qt.x-Qt.x,qt.y-Qt.y);return Math.sqrt(si*Jt)*we/25e-6},_e=Te=>{const Ze=pe,Ue=ye;return{aabb:s.cC(this,M,0,0,0,Te,Ue,Ze,this.projection),zoom:0,x:0,y:0,minZ:Ue,maxZ:Ze,wrap:Te,fullyVisible:!1}},ge=[];let Be=[];const Ce=r,nt=t.reparseOverscaled?c:r,He=(X-this._centerAltitude)*H,at=Te=>{if(!this._elevation||!Te.tileID||!v)return;const Ze=this._elevation.getMinMaxForTile(Te.tileID),Ue=Te.aabb;Ze?(Ue.min[2]=Ze.min,Ue.max[2]=Ze.max,Ue.center[2]=(Ue.min[2]+Ue.max[2])/2):(Te.shouldSplit=ze(Te),Te.shouldSplit||(Ue.min[2]=Ue.max[2]=Ue.center[2]=this._centerAltitude))},mt=(Te,Ze)=>{if(.707*Ze<Te)return 1;const Ue=Ze/Te;return Ue/(1.4144271570014144+(Math.pow(1.1,Ue-1.4144271570014144+1)-1)/(1.1-1)-1)},ze=Te=>{if(Te.zoom<le)return!0;if(Te.zoom===Ce)return!1;if(Te.shouldSplit!=null)return Te.shouldSplit;const Ze=Te.aabb.distanceX(Z),Ue=Te.aabb.distanceY(Z);let dt=He,ft=1;if(B){dt=Te.aabb.distanceZ(Z);const Jt=Math.pow(2,Te.zoom),Ci=s.aY((Te.y+1)/Jt),Fi=s.aY(Te.y/Jt),Hi=Math.min(Math.max(I,Ci),Fi),gn=s.c_(Hi)/s.c_(I);if(ft=Hi===I?1/Math.max(1,this._mercatorScaleRatio-.3):Math.min(1,gn/this._mercatorScaleRatio),this.zoom<=s.cX&&Te.zoom===Ce-1&&gn>=.9)return!0}else if(_&&(dt=Te.aabb.distanceZ(Z)*H),this.projection.isReprojectedInTileSpace&&c<=5){const Jt=Math.pow(2,Te.zoom),Ci=me(new s.ac((Te.x+.5)/Jt,(Te.y+.5)/Jt));ft=Ci>.85?1:Ci}if(!v){const Jt=Math.sqrt(Ze*Ze+Ue*Ue+dt*dt);let Ci=(1<<Ce-Te.zoom)*oe*ft;return Ci*=mt(Math.max(dt,He),Jt),Jt<Ci}let xt=Number.MAX_VALUE,It=0;const Qt=Te.aabb.getCorners(),oi=[];for(const Jt of Qt){s.at(oi,Jt,Z),B||(_?oi[2]*=H:oi[2]=He);const Ci=s.bG(oi,this._camera.forward());Ci<xt&&(xt=Ci,It=Math.abs(oi[2]))}let qt=(1<<Ce-Te.zoom)*oe*ft;if(qt*=mt(Math.max(It,He),xt),xt<qt)return!0;const si=Te.aabb.closestPoint(L);return si[0]===L[0]&&si[1]===L[1]};if(this.renderWorldCopies)for(let Te=1;Te<=3;Te++)ge.push(_e(-Te)),ge.push(_e(Te));for(ge.push(_e(0));ge.length>0;){const Te=ge.pop(),Ze=Te.x,Ue=Te.y;let dt=Te.fullyVisible;const ft=()=>this.projection.name==="globe"&&(Te.y===0||Te.y===(1<<Te.zoom)-1);if(!dt){let xt=te?Te.aabb.intersects(V):Te.aabb.intersectsFlat(V);if(xt===0&&ft()){const It=new s.cA(Te.zoom,Ze,Ue);xt=s.cB(this,M,It,!0).intersects(V)}if(xt===0)continue;dt=xt===2}if(Te.zoom!==Ce&&ze(Te))for(let xt=0;xt<4;xt++){const It=(Ze<<1)+xt%2,Qt=(Ue<<1)+(xt>>1),oi={aabb:v?Te.aabb.quadrant(xt):s.cC(this,M,Te.zoom+1,It,Qt,Te.wrap,Te.minZ,Te.maxZ,this.projection),zoom:Te.zoom+1,x:It,y:Qt,wrap:Te.wrap,fullyVisible:dt,tileID:void 0,shouldSplit:void 0,minZ:Te.minZ,maxZ:Te.maxZ};_&&!B&&(oi.tileID=new s.aM(Te.zoom+1===Ce?nt:Te.zoom+1,Te.wrap,Te.zoom+1,It,Qt),at(oi)),ge.push(oi)}else{const xt=Te.zoom===Ce?nt:Te.zoom;if(t.minzoom&&t.minzoom>xt)continue;let It=0;if(!dt){let si=te?Te.aabb.intersectsPrecise(V):Te.aabb.intersectsPreciseFlat(V);if(si===0&&ft()){const Jt=new s.cA(Te.zoom,Ze,Ue);si=s.cB(this,M,Jt,!0).intersectsPrecise(V)}if(si===0)continue;if(t.calculateQuadrantVisibility)if(V.containsPoint(Te.aabb.center))It=15;else for(let Jt=0;Jt<4;Jt++)Te.aabb.quadrant(Jt).intersects(V)!==0&&(It|=1<<Jt)}const Qt=L[0]-(.5+Ze+(Te.wrap<<Te.zoom))*(1<<r-Te.zoom),oi=L[1]-.5-Ue,qt=Te.tileID?Te.tileID:new s.aM(xt,Te.wrap,Te.zoom,Ze,Ue);t.calculateQuadrantVisibility&&(qt.visibleQuadrants=It),Be.push({tileID:qt,distanceSq:Qt*Qt+oi*oi})}}if(this.fogCullDistSq){const Te=this.fogCullDistSq,Ze=this.horizonLineFromTop();Be=Be.filter((Ue=>{const dt=[0,0,0,1],ft=[s.aj,s.aj,0,1],xt=this.calculateFogTileMatrix(Ue.tileID.toUnwrapped());s.aA(dt,dt,xt),s.aA(ft,ft,xt);const It=s.cD([],dt,ft),Qt=s.cE([],dt,ft),oi=s.cY(It,Qt);if(oi===0)return!0;let qt=!1;const si=this._elevation;if(si&&oi>Te&&Ze!==0){const Jt=this.calculateProjMatrix(Ue.tileID.toUnwrapped());let Ci;t.isTerrainDEM||(Ci=si.getMinMaxForTile(Ue.tileID)),Ci||(Ci={min:ye,max:pe});const Fi=s.cF(this.rotation),Hi=[Fi[0]*s.aj,Fi[1]*s.aj,Ci.max];s.ad(Hi,Hi,Jt),qt=(1-Hi[1])*this.height*.5<Ze}return oi<Te||qt}))}return Be.sort(((Te,Ze)=>Te.distanceSq-Ze.distanceSq)).map((Te=>Te.tileID))}resize(t,r){this.width=t,this.height=r,this.pixelsToGLUnits=[2/t,-2/r],this._constrain(),this._calcMatrices()}get unmodified(){return this._unmodified}zoomScale(t){return Math.pow(2,t)}scaleZoom(t){return Math.log(t)/Math.LN2}project(t){const r=s.ay(t.lat,-s.cG,s.cG),c=this.projection.project(t.lng,r);return new s.P(c.x*this.worldSize,c.y*this.worldSize)}unproject(t){return this.projection.unproject(t.x/this.worldSize,t.y/this.worldSize)}get point(){return this.project(this.center)}get pointMerc(){return this.point._div(this.worldSize)}get pixelsPerMeterRatio(){return this.pixelsPerMeter/s.cb(1,this.center.lat)/this.worldSize}setLocationAtPoint(t,r){let c,p;const _=this.centerPoint;if(this.projection.name==="globe"){const b=this.worldSize;c=(r.x-_.x)/b,p=(r.y-_.y)/b}else{const b=this.pointCoordinate(r),I=this.pointCoordinate(_);c=b.x-I.x,p=b.y-I.y}const v=this.locationCoordinate(t);this.setLocation(new s.ac(v.x-c,v.y-p))}setLocation(t){this.center=this.coordinateLocation(t),this.projection.wrap&&(this.center=this.center.wrap())}locationPoint(t,r){return this.projection.locationPoint(this,t,r)}locationPoint3D(t,r){return this.projection.locationPoint(this,t,r,!0)}pointLocation(t){return this.coordinateLocation(this.pointCoordinate(t))}pointLocation3D(t,r){return this.coordinateLocation(this.pointCoordinate3D(t,r))}locationCoordinate(t,r){const c=r?s.cb(r,t.lat):void 0,p=this.projection.project(t.lng,t.lat);return new s.ac(p.x,p.y,c)}coordinateLocation(t){return this.projection.unproject(t.x,t.y)}pointRayIntersection(t,r){const c=r??this._centerAltitude,p=[t.x,t.y,0,1],_=[t.x,t.y,1,1];s.aA(p,p,this.pixelMatrixInverse),s.aA(_,_,this.pixelMatrixInverse);const v=_[3];s.cH(p,p,1/p[3]),s.cH(_,_,1/v);const b=p[2],I=_[2];return{p0:p,p1:_,t:b===I?0:(c-b)/(I-b)}}screenPointToMercatorRay(t){const r=[t.x,t.y,0,1],c=[t.x,t.y,1,1];return s.aA(r,r,this.pixelMatrixInverse),s.aA(c,c,this.pixelMatrixInverse),s.cH(r,r,1/r[3]),s.cH(c,c,1/c[3]),r[2]=s.cb(r[2],this._center.lat)*this.worldSize,c[2]=s.cb(c[2],this._center.lat)*this.worldSize,s.cH(r,r,1/this.worldSize),s.cH(c,c,1/this.worldSize),new s.av([r[0],r[1],r[2]],s.au([],s.at([],c,r)))}rayIntersectionCoordinate(t){const{p0:r,p1:c,t:p}=t,_=s.cb(r[2],this._center.lat),v=s.cb(c[2],this._center.lat);return new s.ac(s.ai(r[0],c[0],p)/this.worldSize,s.ai(r[1],c[1],p)/this.worldSize,s.ai(_,v,p))}pointCoordinate(t,r=this._centerAltitude){return this.projection.pointCoordinate(this,t.x,t.y,r)}pointCoordinate3D(t,r){if(!this.elevation)return this.pointCoordinate(t,r);let c=this.projection.pointCoordinate3D(this,t.x,t.y);if(c)return new s.ac(c[0],c[1],c[2]);let p=0,_=this.horizonLineFromTop();if(t.y>_)return this.pointCoordinate(t,r);const v=.02*_,b=t.clone();for(let I=0;I<10&&_-p>v;I++){b.y=s.ai(p,_,.66);const M=this.projection.pointCoordinate3D(this,b.x,b.y);M?(_=b.y,c=M):p=b.y}return c?new s.ac(c[0],c[1],c[2]):this.pointCoordinate(t)}isPointAboveHorizon(t){return this.projection.isPointAboveHorizon(this,t)}isPointOnSurface(t){if(t.y<0||t.y>this.height||t.x<0||t.x>this.width)return!1;if(this.elevation||this.zoom>=s.cI)return!this.isPointAboveHorizon(t);const r=this.pointCoordinate(t);return r.y>=0&&r.y<=1}_coordinatePoint(t,r){const c=r&&this.elevation?this.elevation.getAtPointOrZero(t,this._centerAltitude):this._centerAltitude,p=[t.x*this.worldSize,t.y*this.worldSize,c+t.toAltitude(),1];return s.aA(p,p,this.pixelMatrix),p[3]>0?new s.P(p[0]/p[3],p[1]/p[3]):new s.P(Number.MAX_VALUE,Number.MAX_VALUE)}_getBoundsNonRectangular(){const{top:t,left:r}=this._edgeInsets,c=this.height-this._edgeInsets.bottom,p=this.width-this._edgeInsets.right,_=this.pointLocation3D(new s.P(r,t)),v=this.pointLocation3D(new s.P(p,t)),b=this.pointLocation3D(new s.P(p,c)),I=this.pointLocation3D(new s.P(r,c));let M=Math.min(_.lng,v.lng,b.lng,I.lng),L=Math.max(_.lng,v.lng,b.lng,I.lng),B=Math.min(_.lat,v.lat,b.lat,I.lat),F=Math.max(_.lat,v.lat,b.lat,I.lat);const V=Math.pow(2,-this.zoom)/16*270,$=this.projection.name==="globe"?1:4,H=(X,Z,te,oe,le)=>{const pe=(X+te)/2,ye=(Z+oe)/2,we=new s.P(pe,ye),{lng:me,lat:_e}=this.pointLocation3D(we),ge=Math.max(0,M-me,B-_e,me-L,_e-F);M=Math.min(M,me),L=Math.max(L,me),B=Math.min(B,_e),F=Math.max(F,_e),(le<$||ge>V)&&(H(X,Z,pe,ye,le+1),H(pe,ye,te,oe,le+1))};if(H(r,t,p,t,1),H(p,t,p,c,1),H(p,c,r,c,1),H(r,c,r,t,1),this.projection.name==="globe"){const[X,Z]=s.cJ(this);X?(F=90,L=180,M=-180):Z&&(B=-90,L=180,M=-180)}return new s.aG(new s.ci(M,B),new s.ci(L,F))}_getBoundsRectangular(t,r){const{top:c,left:p}=this._edgeInsets,_=this.height-this._edgeInsets.bottom,v=this.width-this._edgeInsets.right,b=new s.P(p,c),I=new s.P(v,c),M=new s.P(v,_),L=new s.P(p,_);let B=this.pointCoordinate(b,t),F=this.pointCoordinate(I,t);const V=this.pointCoordinate(M,r),$=this.pointCoordinate(L,r),H=(X,Z)=>(Z.y-X.y)/(Z.x-X.x);return B.y>1&&F.y>=0?B=new s.ac((1-$.y)/H($,B)+$.x,1):B.y<0&&F.y<=1&&(B=new s.ac(-$.y/H($,B)+$.x,0)),F.y>1&&B.y>=0?F=new s.ac((1-V.y)/H(V,F)+V.x,1):F.y<0&&B.y<=1&&(F=new s.ac(-V.y/H(V,F)+V.x,0)),new s.aG().extend(this.coordinateLocation(B)).extend(this.coordinateLocation(F)).extend(this.coordinateLocation($)).extend(this.coordinateLocation(V))}_getBoundsRectangularTerrain(){const t=this.elevation;if(!t.visibleDemTiles.length||t.isUsingMockSource())return this._getBoundsRectangular(0,0);const r=t.visibleDemTiles.reduce(((c,p)=>{if(p.dem){const _=p.dem.tree;c.min=Math.min(c.min,_.minimums[0]),c.max=Math.max(c.max,_.maximums[0])}return c}),{min:Number.MAX_VALUE,max:0});return this._getBoundsRectangular(r.min*t.exaggeration(),r.max*t.exaggeration())}getBounds(){return this.projection.name==="mercator"||this.projection.name==="equirectangular"?this._terrainEnabled()?this._getBoundsRectangularTerrain():this._getBoundsRectangular(0,0):this._getBoundsNonRectangular()}horizonLineFromTop(t=!0){const r=this.height/2/Math.tan(this._fov/2)/Math.tan(Math.max(this._pitch,.1))-this.centerOffset.y,c=this.height/2-r*(1-this._horizonShift);return t?Math.max(0,c):c}getMaxBounds(){return this.maxBounds}setMaxBounds(t){this.maxBounds=t,this.minLat=-s.cG,this.maxLat=s.cG,this.minLng=-180,this.maxLng=180,t&&(this.minLat=t.getSouth(),this.maxLat=t.getNorth(),this.minLng=t.getWest(),this.maxLng=t.getEast(),this.maxLng<this.minLng&&(this.maxLng+=360)),this.worldMinX=s.aD(this.minLng)*this.tileSize,this.worldMaxX=s.aD(this.maxLng)*this.tileSize,this.worldMinY=s.aH(this.maxLat)*this.tileSize,this.worldMaxY=s.aH(this.minLat)*this.tileSize,this._constrain()}calculatePosMatrix(t,r){return this.projection.createTileMatrix(this,r,t)}calculateDistanceTileData(t){const r=t.key,c=this._distanceTileDataCache;if(c[r])return c[r];const p=t.canonical,_=1/this.height,v=this.cameraWorldSize,b=v/this.zoomScale(p.z),I=(p.x+Math.pow(2,p.z)*t.wrap)*b,M=p.y*b,L=this.point;L.x*=v/this.worldSize,L.y*=v/this.worldSize;const B=this.angle,F=Math.sin(-B),V=-Math.cos(-B);return c[r]={bearing:[F,V],center:[(L.x-I)*_,(L.y-M)*_],scale:b/s.aj*_},c[r]}calculateFogTileMatrix(t){const r=t.key,c=this._fogTileMatrixCache;if(c[r])return c[r];const p=this.projection.createTileMatrix(this,this.cameraWorldSizeForFog,t);return s.az(p,this.worldToFogMatrix,p),c[r]=new Float32Array(p),c[r]}calculateProjMatrix(t,r=!1,c=!1){const p=t.key;let _;if(_=c?this._expandedProjMatrixCache:r?this._alignedProjMatrixCache:this._projMatrixCache,_[p])return _[p];const v=this.calculatePosMatrix(t,this.worldSize);let b;return b=this.projection.isReprojectedInTileSpace?this.mercatorMatrix:c?this.expandedFarZProjMatrix:r?this.alignedProjMatrix:this.projMatrix,s.az(v,b,v),_[p]=new Float32Array(v),_[p]}calculatePixelsToTileUnitsMatrix(t){const r=t.tileID.key,c=this._pixelsToTileUnitsCache;if(c[r])return c[r];const p=s.cK(t,this);return c[r]=p,c[r]}customLayerMatrix(){return this.mercatorMatrix.slice()}globeToMercatorMatrix(){if(this.projection.name==="globe"){const t=1/this.worldSize,r=s.bn([],[t,t,t]);return s.az(r,r,this.globeMatrix),r}}recenterOnTerrain(){if(!this._elevation||this.projection.name==="globe")return;const t=this._elevation;this._updateCameraState();const r=s.cb(1,this._center.lat)*this.worldSize,c=this._computeCameraPosition(r),p=this._camera.forward(),_=s.cb(1,this._center.lat);c[2]/=_,p[2]/=_,s.au(p,p);const v=t.raycast(c,p,t.exaggeration());if(v){const b=s.bE([],c,p,v),I=new s.ac(b[0],b[1],s.cb(b[2],s.aY(b[1]))),M=(I.z+s.ae([I.x-c[0],I.y-c[1],I.z-c[2]*_]))*this._pixelsPerMercatorPixel;this._seaLevelZoom=this._zoomFromMercatorZ(M),this._centerAltitude=I.toAltitude(),this._center=this.coordinateLocation(I),this._updateZoomFromElevation(),this._constrain(),this._calcMatrices()}}_constrainCamera(t=!1){if(!this._elevation)return;const r=this._elevation,c=s.cb(1,this._center.lat)*this.worldSize,p=this._computeCameraPosition(c),_=r.getAtPointOrZero(new s.ac(...p)),v=this.pixelsPerMeter/this.worldSize*_,b=this._minimumHeightOverTerrain(),I=p[2]-v;if(I<=b)if(I<0||t){const M=this.locationCoordinate(this._center,this._centerAltitude),L=[p[0],p[1],M.z-p[2]],B=s.ae(L);L[2]-=(b-I)/this._pixelsPerMercatorPixel;const F=s.ae(L);if(F===0)return;s.c1(L,L,B/F*this._pixelsPerMercatorPixel),this._camera.position=[p[0],p[1],M.z*this._pixelsPerMercatorPixel-L[2]],this._updateStateFromCamera()}else this._isCameraConstrained=!0}_constrain(){if(!this.center||!this.width||!this.height||this._constraining)return;this._constraining=!0;const t=this.projection.name==="globe"||this.mercatorFromTransition;if(this.projection.isReprojectedInTileSpace||t){const F=this.center;return F.lat=s.ay(F.lat,this.minLat,this.maxLat),(this.maxBounds||!this.renderWorldCopies&&!t)&&(F.lng=s.ay(F.lng,this.minLng,this.maxLng)),this.center=F,void(this._constraining=!1)}const r=this._unmodified,{x:c,y:p}=this.point;let _=0,v=c,b=p;const I=this.width/2,M=this.height/2,L=this.worldMinY*this.scale,B=this.worldMaxY*this.scale;if(p-M<L&&(b=L+M),p+M>B&&(b=B-M),B-L<this.height&&(_=Math.max(_,this.height/(B-L)),b=(B+L)/2),this.maxBounds||!this._renderWorldCopies||!this.projection.wrap){const F=this.worldMinX*this.scale,V=this.worldMaxX*this.scale,$=this.worldSize/2-(F+V)/2;v=(c+$+this.worldSize)%this.worldSize-$,v-I<F&&(v=F+I),v+I>V&&(v=V-I),V-F<this.width&&(_=Math.max(_,this.width/(V-F)),v=(V+F)/2)}v===c&&b===p||this._allowWorldUnderZoom||(this.center=this.unproject(new s.P(v,b))),_&&!this._allowWorldUnderZoom&&(this.zoom+=this.scaleZoom(_)),this._constrainCamera(),this._unmodified=r,this._constraining=!1}_minZoomForBounds(){let t=Math.max(0,this.scaleZoom(Math.max(0,this.height)/(this.worldMaxY-this.worldMinY)));return this.maxBounds&&(t=Math.max(t,this.scaleZoom(this.width/(this.worldMaxX-this.worldMinX)))),t}_maxCameraBoundsDistance(){return this._mercatorZfromZoom(this._minZoomForBounds())}_calcMatrices(){if(!this.height)return;const t=this.centerOffset,r=this.projection.name==="globe",c=this.pixelsPerMeter;this.projection.name==="globe"&&(this._mercatorScaleRatio=s.cb(1,this.center.lat)/s.cb(1,s.c$));const p=s.cL(this.projection,this.zoom,this.width,this.height,1024);this._pixelsPerMercatorPixel=this.projection.pixelSpaceConversion(this.center.lat,this.worldSize,p),this.cameraToCenterDistance=.5/Math.tan(.5*this._fov)*this.height*this._pixelsPerMercatorPixel,this._updateCameraState(),this._farZ=this.projection.farthestPixelDistance(this),this._nearZ=this.height/50;const _=this.projection.zAxisUnit==="meters"?c:1,v=this._camera.getWorldToCamera(this.worldSize,_);let b;const I=this._camera.getCameraToClipPerspective(this._fov,this.width/this.height,this._nearZ,this._farZ);if(I[8]=2*-t.x/this.width,I[9]=2*t.y/this.height,this.isOrthographic){let _e=.5*this.height/Math.tan(this._fov/2)*1*Math.tan(.5*this._fov),ge=_e*this.aspect,Be=-ge,Ce=-_e;ge-=t.x,Be-=t.x,_e+=t.y,Ce+=t.y,b=this._camera.getCameraToClipOrthographic(Be,ge,Ce,_e,this._nearZ,this._farZ),((nt,He,at,mt)=>{for(let ze=0;ze<16;ze++)nt[ze]=s.ai(He[ze],at[ze],mt)})(b,b,I,s.cZ(this.pitch>=Ms?1:this.pitch/Ms))}else b=I;const M=s.cM([],I,v);let L=s.cM([],b,v);if(this.projection.isReprojectedInTileSpace){const _e=this.locationCoordinate(this.center),ge=s.bx([]);s.bo(ge,ge,[_e.x*this.worldSize,_e.y*this.worldSize,0]),s.az(ge,ge,s.cN(this)),s.bo(ge,ge,[-_e.x*this.worldSize,-_e.y*this.worldSize,0]),s.az(L,L,ge),s.az(M,M,ge),this.inverseAdjustmentMatrix=s.cO(this)}else this.inverseAdjustmentMatrix=[1,0,0,1];if(this.mercatorMatrix=s.cP([],L,[this.worldSize,this.worldSize,this.worldSize/_,1]),this.projMatrix=L,this.invProjMatrix=s.bi(new Float64Array(16),this.projMatrix),r){const _e=this._camera.getCameraToClipPerspective(this._fov,this.width/this.height,this._nearZ,1/0);_e[8]=2*-t.x/this.width,_e[9]=2*t.y/this.height,this.expandedFarZProjMatrix=s.cM([],_e,v)}else this.expandedFarZProjMatrix=this.projMatrix;const B=s.bi([],b);this.frustumCorners=s.cQ.fromInvProjectionMatrix(B,this.horizonLineFromTop(),this.height),this.cameraFrustum=s.cy.fromInvProjectionMatrix(this.invProjMatrix,this.worldSize,0,!r);const F=new Float32Array(16);s.bx(F),s.cP(F,F,[1,-1,1]),s.cR(F,F,this._pitch),s.by(F,F,this.angle);const V=s.c9(new Float32Array(16),this._fov,this.width/this.height,this._nearZ,this._farZ);this.starsProjMatrix=s.bw(V);const $=(Math.PI/2-this._pitch)*(this.height/this._fov)*this._horizonShift;V[8]=2*-t.x/this.width,V[9]=2*(t.y+$)/this.height,this.skyboxMatrix=s.az(F,V,F);const H=this.point,X=H.x,Z=H.y,te=this.width%2/2,oe=this.height%2/2,le=Math.cos(this.angle),pe=Math.sin(this.angle),ye=X-Math.round(X)+le*te+pe*oe,we=Z-Math.round(Z)+le*oe+pe*te,me=new Float64Array(L);if(s.bo(me,me,[ye>.5?ye-1:ye,we>.5?we-1:we,0]),this.alignedProjMatrix=me,L=s.bz(),s.cP(L,L,[this.width/2,-this.height/2,1]),s.bo(L,L,[1,-1,0]),this.labelPlaneMatrix=L,L=s.bz(),s.cP(L,L,[1,-1,1]),s.bo(L,L,[-1,-1,0]),s.cP(L,L,[2/this.width,2/this.height,1]),this.glCoordMatrix=L,this.pixelMatrix=s.az(new Float64Array(16),this.labelPlaneMatrix,M),this._calcFogMatrices(),this._distanceTileDataCache={},L=s.bi(new Float64Array(16),this.pixelMatrix),!L)throw new Error("failed to invert matrix");if(this.pixelMatrixInverse=L,this.projection.name==="globe"||this.mercatorFromTransition){this.globeMatrix=s.cS(this);const _e=[this.globeMatrix[12],this.globeMatrix[13],this.globeMatrix[14]];this.globeCenterInViewSpace=s.ad(_e,_e,v),this.globeRadius=this.worldSize/2/Math.PI-1}else this.globeMatrix=L;this._projMatrixCache={},this._alignedProjMatrixCache={},this._pixelsToTileUnitsCache={},this._expandedProjMatrixCache={}}_calcFogMatrices(){this._fogTileMatrixCache={};const t=this.cameraWorldSizeForFog,r=this.cameraPixelsPerMeter,c=this._camera.position,p=1/this.height/this._pixelsPerMercatorPixel,_=[t,t,r];s.c1(_,_,p),s.c1(c,c,-1),s.cT(c,c,_);const v=s.bz();s.bo(v,v,c),s.cP(v,v,_),this.mercatorFogMatrix=v,this.worldToFogMatrix=this._camera.getWorldToCameraPosition(t,r,p)}_computeCameraPosition(t){const r=(t=t||this.pixelsPerMeter)/this.pixelsPerMeter,c=this._camera.forward(),p=this.point,_=this._mercatorZfromZoom(this._seaLevelZoom?this._seaLevelZoom:this._zoom)*r-t/this.worldSize*this._centerAltitude;return[p.x/this.worldSize-c[0]*_,p.y/this.worldSize-c[1]*_,t/this.worldSize*this._centerAltitude-c[2]*_]}_updateCameraState(){this.height&&(this._camera.setPitchBearing(this._pitch,this.angle),this._camera.position=this._computeCameraPosition())}_translateCameraConstrained(t){const r=this._maxCameraBoundsDistance()*Math.cos(this._pitch),c=this._camera.position[2],p=t[2];let _=1;this.projection.wrap&&(this.center=this.center.wrap()),p>0&&(_=Math.min((r-c)/p,1)),this._camera.position=s.bE([],this._camera.position,t,_),this._updateStateFromCamera()}_updateStateFromCamera(){const t=this._camera.position,r=this._camera.forward(),{pitch:c,bearing:p}=this._camera.getPitchBearing(),_=s.cb(this._centerAltitude,this.center.lat)*this._pixelsPerMercatorPixel,v=this._mercatorZfromZoom(this._maxZoom)*Math.cos(s.al(this._maxPitch)),b=Math.max((t[2]-_)/Math.cos(c),v),I=this._zoomFromMercatorZ(b);s.bE(t,t,r,b),this._pitch=s.ay(c,s.al(this.minPitch),s.al(this.maxPitch)),this.angle=s.bQ(p,-Math.PI,Math.PI),this._setZoom(s.ay(I,this._minZoom,this._maxZoom)),this._updateSeaLevelZoom(),this._center=this.coordinateLocation(new s.ac(t[0],t[1],t[2])),this._unmodified=!1,this._constrain(),this._calcMatrices()}_worldSizeFromZoom(t){return Math.pow(2,t)*this.tileSize}_mercatorZfromZoom(t){return this.cameraToCenterDistance/this._worldSizeFromZoom(t)}_minimumHeightOverTerrain(){const t=Math.min(this._seaLevelZoom!=null?this._seaLevelZoom:this._zoom,this._maxZoom)+4;return this._mercatorZfromZoom(t)}_zoomFromMercatorZ(t){return this.scaleZoom(this.cameraToCenterDistance/(Math.max(0,t)*this.tileSize))}zoomFromMercatorZAdjusted(t){let r=0,c=s.cI,p=0,_=1/0;for(;c-r>1e-6&&c>r;){const v=r+.5*(c-r),b=this.tileSize*Math.pow(2,v),I=this.getCameraToCenterDistance(this.projection,v,b),M=this.scaleZoom(I/(Math.max(0,t)*this.tileSize)),L=Math.abs(v-M);L<_&&(_=L,p=v),v<M?r=v:c=v}return p}_terrainEnabled(){return!(!this._elevation||!this.projection.supportsTerrain&&(s.w("Terrain is not yet supported with alternate projections. Use mercator or globe to enable terrain."),1))}anyCornerOffEdge(t,r){const c=Math.min(t.x,r.x),p=Math.max(t.x,r.x),_=Math.min(t.y,r.y),v=Math.max(t.y,r.y);if(_<this.horizonLineFromTop(!1))return!0;if(this.projection.name!=="mercator")return!1;const b=[new s.P(c,_),new s.P(p,v),new s.P(c,v),new s.P(p,_)],I=this.renderWorldCopies?-3:0,M=this.renderWorldCopies?4:1;for(const L of b){const B=this.pointRayIntersection(L);if(B.t<0)return!0;const F=this.rayIntersectionCoordinate(B);if(F.x<I||F.y<0||F.x>M||F.y>1)return!0}return!1}isHorizonVisible(){return this.pitch+s.cU(this.fovAboveCenter)>88||this.anyCornerOffEdge(new s.P(0,0),new s.P(this.width,this.height))}zoomDeltaToMovement(t,r){const c=s.ae(s.at([],this._camera.position,t)),p=this._zoomFromMercatorZ(c)+r;return c-this._mercatorZfromZoom(p)}getCameraPoint(){if(this.projection.name==="globe"){const t=(function([r,c,p],_){const v=[r,c,p,1];s.aA(v,v,_);const b=v[3]=Math.max(v[3],1e-6);return v[0]/=b,v[1]/=b,v[2]/=b,v})([this.globeMatrix[12],this.globeMatrix[13],this.globeMatrix[14]],this.pixelMatrix);return new s.P(t[0],t[1])}{const t=Math.tan(this._pitch)*(this.cameraToCenterDistance||1);return this.centerPoint.add(new s.P(0,t))}}getCameraToCenterDistance(t,r=this.zoom,c=this.worldSize){const p=s.cL(t,r,this.width,this.height,1024),_=t.pixelSpaceConversion(this.center.lat,c,p);let v=.5/Math.tan(.5*this._fov)*this.height*_;return this.isOrthographic&&(v=s.ai(1,v,s.cZ(this.pitch>=Ms?1:this.pitch/Ms))),v}getWorldToCameraMatrix(){const t=this._camera.getWorldToCamera(this.worldSize,this.projection.zAxisUnit==="meters"?this.pixelsPerMeter:1);return this.projection.name==="globe"&&s.az(t,t,this.globeMatrix),t}getFrustum(t){return s.cy.fromInvProjectionMatrix(this.invProjMatrix,this.worldSize,t,this.projection.zAxisUnit==="meters")}}const ta=(l,t)=>{if(t>0&&l.terrain&&s.w("Cutoff is currently disabled on terrain"),t<=0||l.terrain)return{shouldRenderCutoff:!1,uniformValues:{u_cutoff_params:[0,0,0,1]}};const r=l.transform,c=Math.max(Math.abs(r._zoom-(l.minCutoffZoom-1)),1),p=r.isLODDisabled(!1)?s.af(60,45,r.pitch):s.af(30,15,r.pitch),_=r._farZ-r._nearZ,v=t*r.height,b=((1-(I=p))*r.cameraToCenterDistance+I*(r._farZ+v))*c;var I;return{shouldRenderCutoff:p<1,uniformValues:{u_cutoff_params:[r._nearZ,r._farZ,(b-r._nearZ)/_,(b-v-r._nearZ)/_]}}},Ds={cascadeCount:2,normalOffset:3,shadowMapResolution:2048};class Rh{constructor(t,r){this.aabb=t,this.lastCascade=r}}class Td{add(t,r){const c=this.receivers[t.key];c!==void 0?(c.aabb.min[0]=Math.min(c.aabb.min[0],r.min[0]),c.aabb.min[1]=Math.min(c.aabb.min[1],r.min[1]),c.aabb.min[2]=Math.min(c.aabb.min[2],r.min[2]),c.aabb.max[0]=Math.max(c.aabb.max[0],r.max[0]),c.aabb.max[1]=Math.max(c.aabb.max[1],r.max[1]),c.aabb.max[2]=Math.max(c.aabb.max[2],r.max[2])):this.receivers[t.key]=new Rh(r,null)}clear(){this.receivers={}}get(t){return this.receivers[t.key]}computeRequiredCascades(t,r,c){const p=s.d6.fromPoints(t.points);let _=0;for(const v in this.receivers){const b=this.receivers[v];if(!b||!p.intersectsAabb(b.aabb))continue;b.aabb.min=p.closestPoint(b.aabb.min),b.aabb.max=p.closestPoint(b.aabb.max);const I=b.aabb.getCorners();for(let M=0;M<c.length;M++){let L=!0;for(const B of I){const F=[B[0]*r,B[1]*r,B[2]];if(s.ad(F,F,c[M].matrix),F[0]<-1||F[0]>1||F[1]<-1||F[1]>1){L=!1;break}}if(b.lastCascade=M,_=Math.max(_,M),L)break}}return _+1}}class vm{constructor(t){this.painter=t,this._enabled=!1,this._shadowLayerCount=0,this._numCascadesToRender=0,this._cascades=[],this._groundShadowTiles=[],this._receivers=new Td,this._depthMode=new Vt(t.context.gl.LEQUAL,Vt.ReadWrite,[0,1]),this._uniformValues={u_light_matrix_0:new Float32Array(16),u_light_matrix_1:new Float32Array(16),u_shadow_intensity:0,u_fade_range:[0,0],u_shadow_normal_offset:[1,1,1],u_shadow_texel_size:1,u_shadow_map_resolution:1,u_shadow_direction:[0,0,1],u_shadow_bias:[36e-5,.0012,.012],u_shadowmap_0:0,u_shadowmap_1:0},this._forceDisable=!1,this.useNormalOffset=!1,t.tp.registerParameter(this,["Shadows"],"_forceDisable",{label:"forceDisable"},(()=>{this.painter.style.map.triggerRepaint()})),t.tp.registerParameter(Ds,["Shadows"],"cascadeCount",{min:1,max:2,step:1}),t.tp.registerParameter(Ds,["Shadows"],"normalOffset",{min:0,max:10,step:.05}),t.tp.registerParameter(Ds,["Shadows"],"shadowMapResolution",{min:32,max:2048,step:32}),t.tp.registerBinding(this,["Shadows"],"_numCascadesToRender",{readonly:!0,label:"numCascadesToRender"})}destroy(){for(const t of this._cascades)t.texture.destroy(),t.framebuffer.destroy();this._cascades=[]}updateShadowParameters(t,r){const c=this.painter;if(this._enabled=!1,this._shadowLayerCount=0,this._receivers.clear(),!r||!r.properties)return;const p=r.properties.get("shadow-intensity");if(!r.shadowsEnabled()||p<=0||(this._shadowLayerCount=c.style.order.reduce((($,H)=>{const X=c.style._mergedLayers[H];return $+(X.hasShadowPass()&&!X.isHidden(t.zoom)?1:0)}),0),this._enabled=this._shadowLayerCount>0,!this.enabled))return;const _=c.context,v=Ds.shadowMapResolution,b=Ds.shadowMapResolution;if(this._cascades.length===0||Ds.shadowMapResolution!==this._cascades[0].texture.size[0]){this._cascades=[];for(let $=0;$<Ds.cascadeCount;++$){const H=c._shadowMapDebug,X=_.gl,Z=_.createFramebuffer(v,b,H,"texture"),te=new s.T(_,{width:v,height:b,data:null},X.DEPTH_COMPONENT16);if(Z.depthAttachment.set(te.texture),H){const oe=new s.T(_,{width:v,height:b,data:null},X.RGBA8);Z.colorAttachment.set(oe.texture)}this._cascades.push({framebuffer:Z,texture:te,matrix:[],far:0,boundingSphereRadius:0,frustum:new s.cy,scale:0})}}this.shadowDirection=Rc(r);let I=0;if(t.elevation){const $=t.elevation,H=[1e4,-1e4];$.visibleDemTiles.filter((X=>X.dem)).forEach((X=>{const Z=X.dem.tree;H[0]=Math.min(H[0],Z.minimums[0]),H[1]=Math.max(H[1],Z.maximums[0])})),H[0]!==1e4&&(I=(H[1]-H[0])*$.exaggeration())}const M=1.5*t.cameraToCenterDistance,L=3*M,B=new Float64Array(16);for(let $=0;$<this._cascades.length;++$){const H=this._cascades[$];let X=t.height/50,Z=1;Ds.cascadeCount===1?Z=L:$===0?Z=M:(X=M,Z=L);const[te,oe]=uu(t,this.shadowDirection,X,Z,Ds.shadowMapResolution,I);H.scale=t.scale,H.matrix=te,H.boundingSphereRadius=oe,s.bi(B,H.matrix),H.frustum=s.cy.fromInvProjectionMatrix(B,1,0,!0),H.far=Z}const F=this._cascades.length-1;this._uniformValues.u_fade_range=[.75*this._cascades[F].far,this._cascades[F].far],this._uniformValues.u_shadow_intensity=p,this._uniformValues.u_shadow_direction=[this.shadowDirection[0],this.shadowDirection[1],this.shadowDirection[2]],this._uniformValues.u_shadow_texel_size=1/Ds.shadowMapResolution,this._uniformValues.u_shadow_map_resolution=Ds.shadowMapResolution,this._uniformValues.u_shadowmap_0=Co.ShadowMap0,this._uniformValues.u_shadowmap_1=Co.ShadowMap0+1,this._groundShadowTiles=c.transform.coveringTiles({tileSize:512,renderWorldCopies:!0});const V=c.transform.elevation;for(const $ of this._groundShadowTiles){let H={min:0,max:0};if(V){const X=V.getMinMaxForTile($);X&&(H=X)}this.addShadowReceiver($.toUnwrapped(),H.min,H.max)}}get enabled(){return this._enabled&&!this._forceDisable}set enabled(t){this._enabled=t}drawShadowPass(t,r){if(!this.enabled)return;const c=this.painter,p=c.context;this._numCascadesToRender=this._receivers.computeRequiredCascades(c.transform.getFrustum(0),c.transform.worldSize,this._cascades),p.viewport.set([0,0,Ds.shadowMapResolution,Ds.shadowMapResolution]);for(let _=0;_<this._numCascadesToRender;++_){c.currentShadowCascade=_,p.bindFramebuffer.set(this._cascades[_].framebuffer.framebuffer),p.clear({color:s.am.white,depth:1});for(const v of t.order){const b=t._mergedLayers[v];if(!b.hasShadowPass()||b.isHidden(c.transform.zoom))continue;const I=t.getLayerSourceCache(b),M=I?r[I.id]:void 0;(b.type==="model"||M&&M.length)&&c.renderLayer(c,I,b,M)}}c.currentShadowCascade=0}drawGroundShadows(){if(!this.enabled)return;const t=this.painter,r=t.style,c=t.context,p=c.gl,_=r.directionalLight,v=r.ambientLight;if(!_||!v)return;const b=[],I=ta(t,t.longestCutoffRange);I.shouldRenderCutoff&&b.push("RENDER_CUTOFF"),b.push("RENDER_SHADOWS","DEPTH_TEXTURE"),this.useNormalOffset&&b.push("NORMAL_OFFSET");const M=lc(r,_,v),L=new Vt(p.LEQUAL,Vt.ReadOnly,t.depthRangeFor3D),B=new _i({func:p.EQUAL,mask:255},0,255,p.KEEP,p.KEEP,p.KEEP);for(const F of this._groundShadowTiles){const V=F.toUnwrapped(),$=t.isTileAffectedByFog(F),H=t.getOrCreateProgram("groundShadow",{defines:b,overrideFog:$});this.setupShadows(V,H),t.uploadCommonUniforms(c,H,V,null,I);const X={u_matrix:t.transform.calculateProjMatrix(V),u_ground_shadow_factor:M};H.draw(t,p.TRIANGLES,L,B,ui.multiply,gi.disabled,X,"ground_shadow",t.tileExtentBuffer,t.quadTriangleIndexBuffer,t.tileExtentSegments,null,t.transform.zoom,null,null)}}getShadowPassColorMode(){return this.painter._shadowMapDebug?ui.unblended:ui.disabled}getShadowPassDepthMode(){return this._depthMode}getShadowCastingLayerCount(){return this._shadowLayerCount}calculateShadowPassMatrixFromTile(t){const r=this.painter.transform,c=r.calculatePosMatrix(t,r.worldSize);return s.az(c,this._cascades[this.painter.currentShadowCascade].matrix,c),Float32Array.from(c)}calculateShadowPassMatrixFromMatrix(t){return s.az(t,this._cascades[this.painter.currentShadowCascade].matrix,t),Float32Array.from(t)}setupShadows(t,r,c){if(!this.enabled)return;const p=this.painter.transform,_=this.painter.context,v=_.gl,b=this._uniformValues,I=new Float64Array(16),M=p.calculatePosMatrix(t,p.worldSize);for(let L=0;L<this._cascades.length;L++)s.az(I,this._cascades[L].matrix,M),b[L===0?"u_light_matrix_0":"u_light_matrix_1"]=Float32Array.from(I),_.activeTexture.set(v.TEXTURE0+Co.ShadowMap0+L),this._cascades[L].texture.bindExtraParam(v.LINEAR,v.LINEAR,v.CLAMP_TO_EDGE,v.CLAMP_TO_EDGE,v.GREATER);if(this.useNormalOffset=!!c,this.useNormalOffset){const L=s.d4(t.canonical),B=2/p.tileSize*s.aj/Ds.shadowMapResolution,F=B*this._cascades[0].boundingSphereRadius,V=B*this._cascades[this._cascades.length-1].boundingSphereRadius,$=(c==="vector-tile"?1:3)*(function(H,X,Z,te,oe){const le=s.ay((H-22)/-22,0,1);return .125*(1-le)+4*le})(p.zoom);b.u_shadow_normal_offset=[L,F*$,V*$],b.u_shadow_bias=[1e-4,.0012,.012]}else b.u_shadow_bias=[36e-5,.0012,.012];r.setShadowUniformValues(_,b)}setupShadowsFromMatrix(t,r,c=!1){if(!this.enabled)return;const p=this.painter.context,_=p.gl,v=this._uniformValues,b=new Float64Array(16);for(let I=0;I<Ds.cascadeCount;I++)s.az(b,this._cascades[I].matrix,t),v[I===0?"u_light_matrix_0":"u_light_matrix_1"]=Float32Array.from(b),p.activeTexture.set(_.TEXTURE0+Co.ShadowMap0+I),this._cascades[I].texture.bindExtraParam(_.LINEAR,_.LINEAR,_.CLAMP_TO_EDGE,_.CLAMP_TO_EDGE,_.GREATER);if(this.useNormalOffset=c,c){const I=Ds.normalOffset;v.u_shadow_normal_offset=[1,I,I],v.u_shadow_bias=[6e-5,.0012,.012]}else v.u_shadow_bias=[36e-5,.0012,.012];r.setShadowUniformValues(p,v)}getShadowUniformValues(){return this._uniformValues}getCurrentCascadeFrustum(){return this._cascades[this.painter.currentShadowCascade].frustum}computeSimplifiedTileShadowVolume(t,r,c,p){if(p[2]>=0)return{};const _=(function(I,M,L){const B=L/(1<<I.canonical.z);return new s.d6([I.canonical.x*B+I.wrap*L,I.canonical.y*B+I.wrap*L,0],[(I.canonical.x+1)*B+I.wrap*L,(I.canonical.y+1)*B+I.wrap*L,M])})(t,r,c).getCorners(),v=r/-p[2];p[0]<0?(s.d5(_[0],_[0],[p[0]*v,0,0]),s.d5(_[3],_[3],[p[0]*v,0,0])):p[0]>0&&(s.d5(_[1],_[1],[p[0]*v,0,0]),s.d5(_[2],_[2],[p[0]*v,0,0])),p[1]<0?(s.d5(_[0],_[0],[0,p[1]*v,0]),s.d5(_[1],_[1],[0,p[1]*v,0])):p[1]>0&&(s.d5(_[2],_[2],[0,p[1]*v,0]),s.d5(_[3],_[3],[0,p[1]*v,0]));const b={};return b.vertices=_,b.planes=[ac(_[1],_[0],_[4]),ac(_[2],_[1],_[5]),ac(_[3],_[2],_[6]),ac(_[0],_[3],_[7])],b}addShadowReceiver(t,r,c){this._receivers.add(t,s.d6.fromTileIdAndHeight(t,r,c))}getMaxCascadeForTile(t){const r=this._receivers.get(t);return r&&r.lastCascade?r.lastCascade:0}}function ac(l,t,r){const c=s.at([],r,t),p=s.at([],l,t),_=s.bF([],c,p),v=s.ae(_);return v===0?[0,0,1,0]:(s.c1(_,_,1/v),[_[0],_[1],_[2],-s.bG(_,t)])}function Rc(l){const t=l.properties.get("direction"),r=s.d1(t.x,t.y,t.z);r[2]=s.ay(r[2],0,75);const c=s.d3([r[0],r[1],r[2]]);return s.d2(c.x,c.y,c.z)}function lc(l,t,r){const c=t.properties.get("color-use-theme")==="none",p=t.properties.get("color"),_=t.properties.get("intensity"),v=t.properties.get("direction"),b=[v.x,v.y,v.z],I=r.properties.get("color-use-theme")==="none",M=r.properties.get("color"),L=r.properties.get("intensity"),B=Math.max(s.bG([0,0,1],b),0),F=[0,0,0];s.c1(F,M.toPremultipliedRenderColor(I?null:l.getLut(t.scope)).toArray01Linear().slice(0,3),L);const V=[0,0,0];return s.c1(V,p.toPremultipliedRenderColor(c?null:l.getLut(r.scope)).toArray01Linear().slice(0,3),B*_),s.d8([F[0]>0?F[0]/(F[0]+V[0]):0,F[1]>0?F[1]/(F[1]+V[1]):0,F[2]>0?F[2]/(F[2]+V[2]):0])}function uu(l,t,r,c,p,_){const v=l.zoom,b=l.scale,I=l.worldSize,M=1/I,L=l.aspect,B=Math.sqrt(1+L*L)*Math.tan(.5*l.fovX),F=B*B,V=c-r,$=c+r;let H,X;F>V/$?(H=c,X=c*B):(H=.5*$*(1+F),X=.5*Math.sqrt(V*V+2*(c*c+r*r)*F+$*$*F*F));const Z=l.projection.pixelsPerMeter(l.center.lat,I),te=l._camera.getCameraToWorldMercator(),oe=[0,0,-H*M];s.ad(oe,oe,te);let le=X*M;const pe=l._edgeInsets;if(!(pe.left===0&&pe.top===0&&pe.right===0&&pe.bottom===0||pe.left===pe.right&&pe.top===pe.bottom)){const dt=l._camera.getWorldToCamera(l.worldSize,l.projection.zAxisUnit==="meters"?Z:1),ft=l._camera.getCameraToClipPerspective(l._fov,l.width/l.height,r,c);ft[8]=2*-l.centerOffset.x/l.width,ft[9]=2*l.centerOffset.y/l.height;const xt=new Float64Array(16);s.cM(xt,ft,dt);const It=new Float64Array(16);s.bi(It,xt);const Qt=s.cy.fromInvProjectionMatrix(It,I,v,!0);for(const oi of Qt.points){const qt=((ye=oi)[0]/=b,ye[1]/=b,ye[2]=s.cb(ye[2],l._center.lat),ye);le=Math.max(le,s.c2(s.d7([],oe,qt)))}}var ye;le*=p/(p-1);const we=Math.acos(t[2]),me=Math.atan2(-t[0],-t[1]),_e=new $a;_e.position=oe,_e.setPitchBearing(we,me);const ge=_e.getWorldToCamera(I,Z),Be=le*I,Ce=Math.min(l._mercatorZfromZoom(17)*I*-2,-2*Be),nt=_e.getCameraToClipOrthographic(-Be,Be,-Be,Be,Ce,(Be+_*Z)/t[2]),He=new Float64Array(16);s.az(He,nt,ge);const at=s.d2(Math.floor(1e6*oe[0])/1e6*I,Math.floor(1e6*oe[1])/1e6*I,0),mt=.5*p,ze=[0,0,0];s.ad(ze,at,He),s.c1(ze,ze,mt);const Te=[Math.floor(ze[0]),Math.floor(ze[1]),Math.floor(ze[2])],Ze=[0,0,0];s.at(Ze,ze,Te),s.c1(Ze,Ze,-1/mt);const Ue=new Float64Array(16);return s.bx(Ue),s.bo(Ue,Ue,Ze),s.az(He,Ue,He),[He,Be]}class Mf extends s.E{constructor(t){super(),this.requestManager=t,this.models={"":{}},this.modelUris={"":{}},this.modelByURL={},this.numModelsLoading={}}loadModel(t,r){return s.aS(this.requestManager.transformRequest(r,s.R.Model).url).then((c=>{if(!c)return;const p=s.aT(c),_=new s.aU(t,void 0,void 0,p);return _.computeBoundsAndApplyParent(),_})).catch((c=>{if(c&&c.status===404)return null;this.fire(new s.z(new Error(`Could not load model ${t} from ${r}: ${c.message}`)))}))}load(t,r,c={forceReload:!1}){this.models[r]||(this.models[r]={});const p=Object.keys(t),_=[],v=[];for(const b of p){const I=t[b];this.hasURLBeenRequested(I)&&!c.forceReload||(this.modelByURL[I]={modelId:b,scope:r},_.push(this.loadModel(b,I)),v.push(b)),this.models[r][b]||(this.models[r][b]={model:null,numReferences:1})}this.numModelsLoading[r]=(this.numModelsLoading[r]||0)+v.length,Promise.allSettled(_).then((b=>{for(let I=0;I<b.length;I++){const{status:M}=b[I];if(M==="rejected")continue;const{value:L}=b[I];this.models[r][v[I]]||(this.models[r][v[I]]={model:null,numReferences:1}),this.models[r][v[I]].model=L}this.numModelsLoading[r]-=v.length,this.fire(new s.A("data",{dataType:"style"}))})).catch((b=>{this.fire(new s.z(new Error(`Could not load models: ${b.message}`)))}))}isLoaded(){for(const t in this.numModelsLoading)if(this.numModelsLoading[t]>0)return!1;return!0}hasModel(t,r,c={exactIdMatch:!1}){return!!(c.exactIdMatch?this.getModel(t,r):this.getModelByURL(this.modelUris[r][t]))}getModel(t,r){return this.models[r]||(this.models[r]={}),this.models[r][t]?this.models[r][t].model:void 0}getModelByURL(t){if(!t)return null;const r=this.modelByURL[t];return r?this.models[r.scope][r.modelId].model:null}hasModelBeenAdded(t,r){return this.models[r]&&this.models[r][t]!==void 0}getModelURIs(t){return this.modelUris[t]||{}}addModel(t,r,c){this.models[c]||(this.models[c]={}),this.modelUris[c]||(this.modelUris[c]={});const p=this.requestManager.normalizeModelURL(r);if((this.hasModel(t,c,{exactIdMatch:!0})||this.hasModelBeenAdded(t,c))&&this.modelUris[c][t]===p)this.models[c][t].numReferences++;else if(this.hasURLBeenRequested(p)){const{scope:_,modelId:v}=this.modelByURL[p];this.models[_][v].numReferences++}else this.modelUris[c][t]=p,this.load({[t]:this.modelUris[c][t]},c)}addModelURLs(t,r){this.models[r]||(this.models[r]={}),this.modelUris[r]||(this.modelUris[r]={});const c=this.modelUris[r];for(const p in t)c[p]=this.requestManager.normalizeModelURL(t[p])}reloadModels(t){this.load(this.modelUris[t],t,{forceReload:!0})}addModelsFromBucket(t,r){this.models[r]||(this.models[r]={}),this.modelUris[r]||(this.modelUris[r]={});const c={};for(const p of t)this.hasModel(p,r,{exactIdMatch:!0})||this.hasURLBeenRequested(p)?this.models[r][p].numReferences++:this.modelUris[r][p]&&!this.hasURLBeenRequested(p)?c[p]=this.modelUris[r][p]:!this.hasURLBeenRequested(p)&&s.d9(p,!1)&&(this.modelUris[r][p]=this.requestManager.normalizeModelURL(p),c[p]=this.modelUris[r][p]);this.load(c,r)}hasURLBeenRequested(t){return this.modelByURL[t]!==void 0}removeModel(t,r,c=!1,p=!1){if(this.models[r]&&this.models[r][t]&&(this.models[r][t].numReferences--,this.models[r][t].numReferences===0||p)){const _=this.modelUris[r][t];c||delete this.modelUris[r][t],delete this.modelByURL[_];const v=this.models[r][t].model;if(!v)return;delete this.models[r][t],v.destroy()}}destroy(){for(const t of Object.keys(this.models))for(const r of Object.keys(this.models[t])){const c=this.models[t][r].model;delete this.models[t][r],c&&c.destroy()}this.models={"":{}},this.modelUris={"":{}},this.modelByURL={},this.numModelsLoading={}}listModels(t){return this.models[t]||(this.models[t]={}),Object.keys(this.models[t])}upload(t,r){this.models[r]||(this.models[r]={});for(const c in this.models[r])this.models[r][c].model&&this.models[r][c].model.upload(t.context)}}const Mh=new s.a7({data:new s.a8(s.a5.colorTheme.data)});class Df{constructor(t){this._scope=t,this._buildingQueryParams={target:{featuresetId:"building-outline",importId:this._scope}},this._floorQueryParams={target:{featuresetId:"floor-outline",importId:this._scope}}}execute(t){const r=this._makeBuildingsQueryArea(t),c=this._makeFloorsQueryArea(t),p=t.queryRenderedFeatures(r,this._buildingQueryParams).filter((b=>b.properties.shape_type==="building")).reduce(((b,I)=>{const M=I.properties.id;return I.properties.shape_type!=="building"||b.some((L=>L.properties.id===M))||b.push(I),b}),[]),_=t.queryRenderedFeatures(c,this._floorQueryParams).filter((b=>b.properties.shape_type==="floor")).reduce(((b,I)=>{const M=I.properties.id;return I.properties.shape_type!=="floor"||b.some((L=>L.properties.id===M))||b.push(I),b}),[]),v=[t.getCenter().lng,t.getCenter().lat];return{floors:_,building:this._findBuildingAtCenter(v,p)||(p.length>0?p[0]:null)}}_makeBuildingsQueryArea(t){const r=t.transform.width,c=t.transform.height,p=Math.min(r,c),_=p*(1/8),v=p*(1/8),b=.5*(r-_),I=.5*(c-v);return[new s.P(b,I),new s.P(b+_,I+v)]}_makeFloorsQueryArea(t){const r=t.transform.width,c=t.transform.height,p=r*(2/3),_=c*(2/3),v=.5*(r-p),b=.5*(c-_);return[new s.P(v,b),new s.P(v+p,b+_)]}_findBuildingAtCenter(t,r){for(const c of r)if(c.geometry.type==="Polygon"&&this._pointInPolygon(t,c.geometry.coordinates[0]))return c;return null}_pointInPolygon(t,r){let c=!1;for(let p=0,_=r.length-1;p<r.length;_=p++){const v=r[p][0],b=r[p][1],I=r[_][1];b>t[1]!=I>t[1]&&t[0]<(r[_][0]-v)*(t[1]-b)/(I-b)+v&&(c=!c)}return c}}class Mc{constructor(){this._selectedFloorId=null,this._selectedBuildingId=null,this._floors=[]}setBuildingId(t){this._selectedBuildingId=t}setFloors(t){if(this._floors=t.filter((r=>r.properties.building_id===this._selectedBuildingId)),!this._selectedFloorId||!this._floors.map((r=>r.properties.id)).includes(this._selectedFloorId)){const r=this._floors.map((c=>({id:c.properties.id,level:c.properties.floor_level}))).reduce(((c,p)=>{const _=Math.abs(c.level-1),v=Math.abs(p.level-1);return v<_||v===_&&p.level>c.level?p:c}));this._selectedFloorId=r.id}}setFloorId(t){this._selectedFloorId=t}getSelectedFloorId(){return this._selectedFloorId}getCurrentBuildingFloors(){return this._floors}reset(){this._selectedFloorId=null,this._selectedBuildingId=null,this._floors=[]}}const xm={"mbx-indoor-level-selected":{default:["literal",[]]}};function Tp(l){return l=l||{},Object.assign(l,xm)}class wm extends s.E{constructor(t){super(),s.aV(["_onLoad","_onMove"],this),this._map=t,this._floorSelectionState=new Mc,this._queryIndoor(),this._map.on("load",this._onLoad),this._map.on("move",this._onMove)}destroy(){this._map.indoor.off("load",this._onLoad),this._map.indoor.off("move",this._onMove),this._map=null,this._floorSelectionState=null}_onLoad(){this._map.style.forEachFragmentStyle((t=>{t.stylesheet.indoor&&(this._indoorDataQuery?this.fire(new s.z(new Error("Multiple indoor map styles detected, simultaneous usage is not allowed currently."))):(this._scope=t.scope,this._indoorDataQuery=new Df(this._scope)))})),this._map._addIndoorControl(),this._queryIndoor()}_onMove(){this._queryIndoor()}_queryIndoor(){if(!this._indoorDataQuery||!this._map.isStyleLoaded())return;if(this._map.transform.zoom<16)return void this._clearIndoorData();const t=this._indoorDataQuery.execute(this._map);t&&t.floors.length!==0?(this._floorSelectionState.getSelectedFloorId()||this._map._addIndoorControl(),this._selectFloors(t)):this._clearIndoorData()}_selectFloors(t){if(t.building)this._floorSelectionState.setBuildingId(t.building.properties.id),this._floorSelectionState.setFloors(t.floors),this._updateUI();else{const r=this._floorSelectionState.getSelectedFloorId();if(r&&t.floors.some((c=>c.properties.id===r)))return;this._clearIndoorData()}}_clearIndoorData(){this._floorSelectionState.reset(),this._map._removeIndoorControl(),this._map.setConfigProperty(this._scope,"mbx-indoor-level-selected",["literal",[]])}_updateUI(){const t=this._floorSelectionState.getCurrentBuildingFloors().map((c=>({id:c.properties.id,name:c.properties.name,shortName:c.properties.floor_level,levelOrder:c.properties.floor_level}))),r=this._floorSelectionState.getSelectedFloorId();r?(this._updateIndoorConfig(),this.fire(new s.A("indoorupdate",{selectedFloorId:r,floors:t}))):console.warn("IndoorManager: Selected floor is not set")}_updateIndoorConfig(){const t=this._floorSelectionState.getSelectedFloorId();t?this._map.setConfigProperty(this._scope,"mbx-indoor-level-selected",["literal",[t]]):console.warn("IndoorManager: Selected floor is not set")}selectFloor(t){this._floorSelectionState.setFloorId(t),this._updateIndoorConfig()}}function Wa(l){if(!l.metadata||!l.metadata.content_area)return;const t=s.q.devicePixelRatio,{left:r,top:c,width:p,height:_}=l.metadata.content_area,v=r*t,b=c*t;return[v,b,v+p*t,b+_*t]}function Hu(l){if(l)return l.map((([t,r])=>[t*s.q.devicePixelRatio,r*s.q.devicePixelRatio]))}class Ed{constructor(t,r,c){this.id=t,this.scope=r,this.sourceCache=c,this.pendingRequests=new Set,this.missingRequests=new Set}addPendingRequest(t){this.missingRequests.has(t.name)||this.pendingRequests.has(t.name)||this.pendingRequests.add(t.name)}hasPendingRequests(){return this.pendingRequests.size>0}resolvePendingRequests(){const t=new Map;if(!this.sourceCache.loaded())return t;const r=this.sourceCache.getVisibleCoordinates();if(r.length===0)return t;const c=this.sourceCache.getSource();if(!(c instanceof ol))return t;const p=r.map((v=>this.sourceCache.getTile(v))),_=c.getImages(p,Array.from(this.pendingRequests));for(const[v,b]of _)t.set(s.I.from({name:v,iconsetId:this.id}),b),this.pendingRequests.delete(v);for(const v of this.pendingRequests)this.missingRequests.add(v);return this.pendingRequests.clear(),t}}const cc=(l,t)=>de(l,t&&t.filter((r=>r.identifier!=="source.canvas"))),Lf=s.aF(xn,["addLayer","removeLayer","setLights","setPaintProperty","setLayoutProperty","setSlot","setFilter","addSource","removeSource","setLayerZoomRange","setLight","setTransition","setGeoJSONSourceData","setTerrain","setFog","setSnow","setRain","setProjection","setCamera","addImport","removeImport","updateImport","addIconset","removeIconset"]),kf=s.aF(xn,["setCenter","setZoom","setBearing","setPitch"]),qu=new Set(["background","sky","slot","custom"]),Dc={version:8,layers:[],sources:{}},Dh={duration:300,delay:0};class yo extends s.E{constructor(t,r={}){super(),this.map=t,this.scope=r.scope||"",this.globalId=null,this.fragments=[],this.importDepth=r.importDepth||0,this.importsCache=r.importsCache||new Map,this.resolvedImports=r.resolvedImports||new Set,this.transition=s.h({},Dh),this._buildingIndex=new tc(this),this.crossTileSymbolIndex=new Yn,this._mergedOrder=[],this._drapedFirstOrder=[],this._mergedLayers={},this._mergedSourceCaches={},this._mergedOtherSourceCaches={},this._mergedSymbolSourceCaches={},this._clipLayerPresent=!1,this._has3DLayers=!1,this._hasCircleLayers=!1,this._hasSymbolLayers=!1,this._changes=r.styleChanges||new Yo,this.dispatcher=r.dispatcher?r.dispatcher:new s.D(s.db(),this),r.imageManager?this.imageManager=r.imageManager:(this.imageManager=new Ut(this.map._spriteFormat),this.imageManager.setEventedParent(this)),this.imageManager.addScope(this.scope),this.glyphManager=r.glyphManager?r.glyphManager:new s.dc(t._requestManager,r.localFontFamily?s.dd.all:r.localIdeographFontFamily?s.dd.ideographs:s.dd.none,r.localFontFamily||r.localIdeographFontFamily),r.modelManager?this.modelManager=r.modelManager:(this.modelManager=new Mf(t._requestManager),this.modelManager.setEventedParent(this)),this._layers={},this._sourceCaches={},this._otherSourceCaches={},this._symbolSourceCaches={},this._loaded=!1,this._precompileDone=!1,this._shouldPrecompile=!1,this._availableImages=[],this._availableModels={},this._order=[],this._markersNeedUpdate=!1,this.options=r.configOptions?r.configOptions:new Map,this._configDependentLayers=r.configDependentLayers?r.configDependentLayers:new Set,this._config=r.config,this._styleColorTheme={lut:null,lutLoading:!1,lutLoadingCorrelationID:0,colorTheme:null,colorThemeOverride:r.colorThemeOverride},this._styleColorThemeForScope={},this._initialConfig=r.initialConfig,this.dispatcher.broadcast("setReferrer",s.de());const c=this;this._rtlTextPluginCallback=yo.registerForPluginStateChange((p=>{c.dispatcher.broadcast("syncRTLPluginState",{pluginStatus:p.pluginStatus,pluginURL:p.pluginURL},((_,v)=>{if(s.df(_),v&&v.every((b=>b)))for(const b in c._sourceCaches){const I=c._sourceCaches[b],M=I.getSource().type;M!=="vector"&&M!=="geojson"||I.reload()}}))})),this.on("data",(p=>{if(p.dataType!=="source"||p.sourceDataType!=="metadata")return;const _=this.getOwnSource(p.sourceId);if(_&&_.vectorLayerIds)for(const v in this._layers){const b=this._layers[v];b.source===_.id&&this._validateLayer(b)}}))}load(t){return t?(typeof t=="string"?this.loadURL(t):this.loadJSON(t),this):this}_getGlobalId(t){if(!t)return null;if(typeof t=="string"){if(s.j(t))return t;const r=s.dg(t);if(!r.startsWith("http"))try{return new URL(r,location.href).toString()}catch{return r}return r}return`json://${s.dh(JSON.stringify(t))}`}_diffStyle(t,r,c){this.globalId=this._getGlobalId(t);const p=(_,v)=>{try{v(null,this.setState(_,c))}catch(b){v(b,!1)}};if(typeof t=="string"){const _=this.map._requestManager.normalizeStyleURL(t),v=this.map._requestManager.transformRequest(_,s.R.Style);s.n(v,((b,I)=>{b?this.fire(new s.z(b)):I&&p(I,r)}))}else typeof t=="object"&&p(t,r)}loadURL(t,r={}){this.fire(new s.A("dataloading",{dataType:"style"}));const c=typeof r.validate=="boolean"?r.validate:!s.j(t);this.globalId=this._getGlobalId(t),t=this.map._requestManager.normalizeStyleURL(t,r.accessToken),this.resolvedImports.add(t);const p=this.importsCache.get(t);if(p)return this._load(p,c);const _=this.map._requestManager.transformRequest(t,s.R.Style);this._request=s.n(_,((v,b)=>{if(this._request=null,v)this.fire(new s.z(v));else if(b)return this.importsCache.set(t,b),this._load(b,c)}))}loadJSON(t,r={}){this.fire(new s.A("dataloading",{dataType:"style"})),this.globalId=this._getGlobalId(t),this._request=s.q.frame((()=>{this._request=null,this._load(t,r.validate!==!1)}))}loadEmpty(){this.fire(new s.A("dataloading",{dataType:"style"})),this._load(Dc,!1)}_loadImports(t,r,c){if(this.importDepth>=4)return s.w("Style doesn't support nesting deeper than 5"),Promise.resolve();const p=[];for(const _ of t){const v=this._createFragmentStyle(_),b=new Promise((L=>{v.once("style.import.load",L),v.once("error",L)})).then((()=>this.mergeAll()));if(p.push(b),this.resolvedImports.has(_.url)){v.loadEmpty();continue}const I=_.data||this.importsCache.get(_.url);I?(v.loadJSON(I,{validate:r}),this._isInternalStyle(I)&&(v.globalId=null)):_.url?v.loadURL(_.url,{validate:r}):v.loadEmpty();const M={style:v,id:_.id,config:_.config};if(c){const L=this.fragments.findIndex((({id:B})=>B===c));this.fragments=this.fragments.slice(0,L).concat(M).concat(this.fragments.slice(L))}else this.fragments.push(M)}return Promise.allSettled(p)}getImportGlobalIds(t=this,r=new Set){for(const c of t.fragments)c.style.globalId&&r.add(c.style.globalId),this.getImportGlobalIds(c.style,r);return[...r.values()]}_createFragmentStyle(t){const r=this.scope?s.C(t.id,this.scope):t.id;let c;const p=this._initialConfig&&this._initialConfig[r];(t.config||p)&&(c=s.h({},t.config,p));const _=new yo(this.map,{scope:r,styleChanges:this._changes,importDepth:this.importDepth+1,importsCache:this.importsCache,resolvedImports:new Set(this.resolvedImports),dispatcher:this.dispatcher,imageManager:this.imageManager,glyphManager:this.glyphManager,modelManager:this.modelManager,config:c,configOptions:this.options,colorThemeOverride:t["color-theme"],configDependentLayers:this._configDependentLayers});return _.setEventedParent(this.map,{style:_}),_}_reloadImports(){this.mergeAll(),this._updateMapProjection(),this.updateConfigDependencies(),this.map._triggerCameraUpdate(this.camera),this.dispatcher.broadcast("setLayers",{layers:this._serializeLayers(this._order),scope:this.scope,options:this.options}),this._shouldPrecompile=this.map._precompilePrograms&&this.isRootStyle()}_isInternalStyle(t){return this.isRootStyle()&&(t.fragment||!!t.schema&&t.fragment!==!1)}_load(t,r){const c=t.indoor?Tp(t.schema):t.schema;if(this._isInternalStyle(t)){const v=s.h({},Dc,{imports:[{id:"basemap",data:t,url:""}]});return void this._load(v,r)}if(this.updateConfig(this._config,c),r&&cc(this,gs(t)))return;this._loaded=!0,this.stylesheet=s.di(t);const p=()=>{for(const M in t.sources)this.addSource(M,t.sources[M],{validate:!1,isInitialLoad:!0});if(t.iconsets)for(const M in t.iconsets)this.addIconset(M,t.iconsets[M]);t.sprite?this._loadIconset(t.sprite):(this.imageManager.setLoaded(!0,this.scope),this.dispatcher.broadcast("spriteLoaded",{scope:this.scope,isLoaded:!0})),!this.glyphManager.url&&t.glyphs&&this.glyphManager.setURL(t.glyphs);const v=ea(this.stylesheet.layers);if(this._order=v.map((M=>M.id)),this.stylesheet.light&&s.w("The `light` root property is deprecated, prefer using `lights` with `flat` light type instead."),this.stylesheet.lights)if(this.stylesheet.lights.length===1&&this.stylesheet.lights[0].type==="flat"){const M=this.stylesheet.lights[0];this.light=new $e(M.properties,M.id)}else this.setLights(this.stylesheet.lights);this.light||(this.light=new $e(this.stylesheet.light)),this._layers={};for(const M of v){const L=s.dn(M,this.scope,this._styleColorTheme.lut,this.options);L.configDependencies.size!==0&&this._configDependentLayers.add(L.fqid),L.setEventedParent(this,{layer:{id:L.id}}),this._layers[L.id]=L;const B=this.getOwnLayerSourceCache(L),F=!!this.directionalLight&&this.directionalLight.shadowsEnabled();B&&L.canCastShadows()&&F&&(B.castsShadows=!0)}this.stylesheet.featuresets&&this.setFeaturesetSelectors(this.stylesheet.featuresets),this.stylesheet.models&&this.addModelURLs(this.stylesheet.models);const b=this.stylesheet.terrain;b&&(this.checkCanvasFingerprintNoise(),this.disableElevatedTerrain||this.terrainSetForDrapingOnly()||this._createTerrain(b,1)),this.stylesheet.fog&&this._createFog(this.stylesheet.fog),this.stylesheet.snow&&this._createSnow(this.stylesheet.snow),this.stylesheet.rain&&this._createRain(this.stylesheet.rain),this.stylesheet.transition&&this.setTransition(this.stylesheet.transition),this.fire(new s.A("data",{dataType:"style"}));const I=this.isRootStyle();t.imports?this._loadImports(t.imports,r).then((()=>{this._reloadImports(),this.fire(new s.A(I?"style.load":"style.import.load"))})).catch((M=>{this.fire(new s.z(new Error("Failed to load imports",M))),this.fire(new s.A(I?"style.load":"style.import.load"))})):(this._reloadImports(),this.fire(new s.A(I?"style.load":"style.import.load")))};this._styleColorTheme.colorTheme=this.stylesheet["color-theme"];const _=this._styleColorTheme.colorThemeOverride?this._styleColorTheme.colorThemeOverride:this._styleColorTheme.colorTheme;if(_){const v=this._evaluateColorThemeData(_);this._loadColorTheme(v).then((()=>{p()})).catch((b=>{s.w(`Couldn't load color theme from the stylesheet: ${b}`),p()}))}else this._styleColorTheme.lut=null,p()}isRootStyle(){return this.importDepth===0}mergeAll(){let t,r,c,p,_,v,b,I,M,L;const B={};this.terrain&&this.terrain.scope!==this.scope&&delete this.terrain,this.forEachFragmentStyle((F=>{if(F.stylesheet){if(F.light!=null&&(t=F.light),F.stylesheet.lights)for(const V of F.stylesheet.lights)V.type==="ambient"&&F.ambientLight!=null&&(r=F.ambientLight),V.type==="directional"&&F.directionalLight!=null&&(c=F.directionalLight);p=this._prioritizeTerrain(p,F.terrain,F.stylesheet.terrain),F.stylesheet.fog&&F.fog!=null&&(_=F.fog),F.stylesheet.snow&&F.snow!=null&&(v=F.snow),F.stylesheet.rain&&F.rain!=null&&(b=F.rain),F.stylesheet.camera!=null&&(L=F.stylesheet.camera),F.stylesheet.projection!=null&&(I=F.stylesheet.projection),F.stylesheet.transition!=null&&(M=F.stylesheet.transition),B[F.scope]=F._styleColorTheme}})),this.light=t,this.ambientLight=r,this.directionalLight=c,this.fog=_,this.snow=v,this.rain=b,this._styleColorThemeForScope=B,p===null?delete this.terrain:this.terrain=p,this.camera=L||{"camera-projection":"perspective"},this.projection=I||{name:"mercator"},this.transition=s.h({},Dh,M),this.mergeSources(),this.mergeLayers()}forEachFragmentStyle(t){const r=c=>{for(const p of c.fragments)r(p.style);t(c)};r(this)}_prioritizeTerrain(t,r,c){const p=t&&t.drapeRenderMode===0;return c===null?r&&r.drapeRenderMode===0?r:p?t:null:r!=null&&(!t||p||r&&r.drapeRenderMode===1)?r:t}mergeTerrain(){let t;this.terrain&&this.terrain.scope!==this.scope&&delete this.terrain,this.forEachFragmentStyle((r=>{t=this._prioritizeTerrain(t,r.terrain,r.stylesheet.terrain)})),t===null?delete this.terrain:this.terrain=t}mergeProjection(){let t;this.forEachFragmentStyle((r=>{r.stylesheet.projection!=null&&(t=r.stylesheet.projection)})),this.projection=t||{name:"mercator"}}mergeSources(){const t={},r={},c={};this.forEachFragmentStyle((p=>{for(const _ in p._sourceCaches){const v=s.C(_,p.scope);t[v]=p._sourceCaches[_]}for(const _ in p._otherSourceCaches){const v=s.C(_,p.scope);r[v]=p._otherSourceCaches[_]}for(const _ in p._symbolSourceCaches){const v=s.C(_,p.scope);c[v]=p._symbolSourceCaches[_]}})),this._mergedSourceCaches=t,this._mergedOtherSourceCaches=r,this._mergedSymbolSourceCaches=c}mergeLayers(){const t={},r=[],c={};this._mergedSlots=[],this._has3DLayers=!1,this._hasCircleLayers=!1,this._hasSymbolLayers=!1,this.forEachFragmentStyle((_=>{for(const v of _._order){const b=_._layers[v];if(b.type==="slot"){const I=s.dj(v);if(t[I])continue;t[I]=[]}b.slot&&t[b.slot]?t[b.slot].push(b):r.push(b)}})),this._mergedOrder=[];const p=(_=[])=>{for(const v of _)if(v.type==="slot"){const b=s.dj(v.id);t[b]&&p(t[b]),this._mergedSlots.push(b)}else{const b=s.C(v.id,v.scope);this._mergedOrder.push(b),c[b]=v,v.is3D(!!this.terrain)&&(this._has3DLayers=!0),v.type==="circle"&&(this._hasCircleLayers=!0),v.type==="symbol"&&(this._hasSymbolLayers=!0),v.type==="clip"&&(this._clipLayerPresent=!0)}};p(r),this._mergedOrder.sort(((_,v)=>{const b=c[_],I=c[v];return b.hasInitialOcclusionOpacityProperties?I.is3D(!!this.terrain)?1:0:b.is3D(!!this.terrain)&&I.hasInitialOcclusionOpacityProperties?-1:0})),this._mergedLayers=c,this.updateDrapeFirstLayers(),this._buildingIndex.processLayersChanged()}terrainSetForDrapingOnly(){return!!this.terrain&&this.terrain.drapeRenderMode===0}getCamera(){return this.stylesheet.camera}setCamera(t){return this.stylesheet.camera=s.h({},this.stylesheet.camera,t),this.camera=this.stylesheet.camera,this}_evaluateColorThemeData(t){return t.data?(function(r,c,p,_){const v=s.h({},c);for(const I of Object.keys(s.a5.colorTheme))v[I]===void 0&&(v[I]=s.a5.colorTheme[I].default);const b=new s.a6(Mh,r,new Map(p));return b.setTransitionOrValue(v,p),b.untransitioned().possiblyEvaluate(new s.aa(0,{worldview:void 0}))})(this.scope,t,this.options).get("data"):null}_loadColorTheme(t){this._styleColorTheme.lutLoading=!0,this._styleColorTheme.lutLoadingCorrelationID+=1;const r=this._styleColorTheme.lutLoadingCorrelationID;return new Promise(((c,p)=>{const _="data:image/png;base64,";if(!t||t.length===0)return this._styleColorTheme.lut=null,this._styleColorTheme.lutLoading=!1,void c();let v=t;v.startsWith(_)||(v=_+v);const b=s.I.from("mapbox-reserved-lut"),I=new Image;I.src=v,I.onerror=()=>{this._styleColorTheme.lutLoading=!1,p(new Error("Failed to load image data"))},I.onload=()=>{if(this._styleColorTheme.lutLoadingCorrelationID!==r)return void c();this._styleColorTheme.lutLoading=!1;const{width:M,height:L,data:B}=s.q.getImageData(I);if(L>32)return void p(new Error("The height of the image must be less than or equal to 32 pixels."));if(M!==L*L)return void p(new Error("The width of the image must be equal to the height squared."));this.getImage(b)&&this.removeImage(b),this.addImage(b,{data:new s.r({width:M,height:L},B),pixelRatio:1,sdf:!1,usvg:!1,version:0});const F=this.imageManager.getImage(b,this.scope);F?(this._styleColorTheme.lut={image:F.data,data:t},c()):p(new Error("Missing LUT image."))}}))}getLut(t){const r=this._styleColorThemeForScope[t];return r?r.lut:null}setProjection(t){t?this.stylesheet.projection=t:delete this.stylesheet.projection,this.mergeProjection(),this._updateMapProjection()}applyProjectionUpdate(){this._loaded&&(this.dispatcher.broadcast("setProjection",this.map.transform.projectionOptions),this.map.transform.projection.requiresDraping?(this.getTerrain()||this.stylesheet.terrain)&&!this.disableElevatedTerrain||this.setTerrainForDraping():this.terrainSetForDrapingOnly()&&this.setTerrain(null,0))}_updateMapProjection(){this.isRootStyle()&&(this.map._useExplicitProjection?this.applyProjectionUpdate():this.map._prioritizeAndUpdateProjection(null,this.projection))}_loadSprite(t){this._spriteRequest=(function(r,c,p){let _,v,b;const I=s.q.devicePixelRatio>1?"@2x":"";let M=s.n(c.transformRequest(c.normalizeSpriteURL(r,I,".json"),s.R.SpriteJSON),((F,V)=>{M=null,b||(b=F,_=V,B())})),L=s.o(c.transformRequest(c.normalizeSpriteURL(r,I,".png"),s.R.SpriteImage),((F,V)=>{L=null,b||(b=F,v=V,B())}));function B(){if(b)p(b);else if(_&&v){const F=s.q.getImageData(v),V={};for(const $ in _){const{width:H,height:X,x:Z,y:te,sdf:oe,pixelRatio:le,stretchX:pe,stretchY:ye,content:we}=_[$],me=new s.r({width:H,height:X});s.r.copy(F,me,{x:Z,y:te},{x:0,y:0},{width:H,height:X},null),V[$]={data:me,pixelRatio:le,sdf:oe,stretchX:pe,stretchY:ye,content:we,usvg:!1}}p(null,V)}}return{cancel(){M&&(M.cancel(),M=null),L&&(L.cancel(),L=null)}}})(t,this.map._requestManager,((r,c)=>{if(this._spriteRequest=null,r)this.fire(new s.z(r));else if(c){const p=new Map;for(const _ in c)p.set(s.I.from(_),c[_]);this.addImages(p)}this.imageManager.setLoaded(!0,this.scope),this.dispatcher.broadcast("spriteLoaded",{scope:this.scope,isLoaded:!0}),this.fire(new s.A("data",{dataType:"style"}))}))}addIconset(t,r){if(r.type==="sprite")return void this._loadSprite(r.url);const c=this.getOwnSourceCache(r.source);if(!c)return void this.fire(new s.z(new Error(`Source "${r.source}" as specified by iconset "${t}" does not exist and cannot be used as an iconset source`)));const p=c.getSource();if(p.type!=="raster-array")return void this.fire(new s.z(new Error(`Source "${r.source}" as specified by iconset "${t}" is not a "raster-array" source and cannot be used as an iconset source`)));p.partial=!1;const _=new Ed(t,this.scope,c);this.imageManager.addImageProvider(_,this.scope)}removeIconset(t){this.imageManager.removeImageProvider(t,this.scope)}_loadIconset(t){if(!s.j(t)&&this.map._spriteFormat!=="icon_set"||this.map._spriteFormat==="raster")return void this._loadSprite(t);const r=this.map._spriteFormat==="auto";var c,p;this._spriteRequest=(p=(_,v)=>{if(this._spriteRequest=null,_)r?this._loadSprite(t):this.fire(new s.z(_));else if(v){const b=new Map;for(const I in v)b.set(s.I.from(I),v[I]);this.addImages(b)}this.imageManager.setLoaded(!0,this.scope),this.dispatcher.broadcast("spriteLoaded",{scope:this.scope,isLoaded:!0}),this.fire(new s.A("data",{dataType:"style"}))},s.br((c=this.map._requestManager).transformRequest(c.normalizeIconsetURL(t),s.R.Iconset),((_,v)=>{if(_)return void p(_);const b={},I=s.da(new s.bq(v));for(const M of I.icons){const L={version:1,pixelRatio:s.q.devicePixelRatio,content:Wa(M),stretchX:M.metadata?Hu(M.metadata.stretch_x_areas):void 0,stretchY:M.metadata?Hu(M.metadata.stretch_y_areas):void 0,sdf:!1,usvg:!0,icon:M};b[M.name]=L}p(null,b)})))}_validateLayer(t){const r=this.getOwnSource(t.source);if(!r)return;const c=t.sourceLayer;c&&(r.type==="geojson"||r.vectorLayerIds&&r.vectorLayerIds.indexOf(c)===-1)&&this.fire(new s.z(new Error(`Source layer "${c}" does not exist on source "${r.id}" as specified by style layer "${t.id}"`)))}loaded(){if(!this._loaded||Object.keys(this._changes.getUpdatedSourceCaches()).length)return!1;for(const t in this._sourceCaches)if(!this._sourceCaches[t].loaded())return!1;if(!this.imageManager.isLoaded()||this.imageManager.hasPatternsInFlight()||!this.modelManager.isLoaded()||this._styleColorTheme.lutLoading)return!1;for(const{style:t}of this.fragments)if(!t.loaded())return!1;return!0}_serializeImports(){if(this.stylesheet.imports)return this.stylesheet.imports.map(((t,r)=>{const c=this.fragments[r];return c&&c.style&&(t.data=c.style.serialize()),t}))}_serializeSources(){const t={};for(const r in this._sourceCaches){const c=this._sourceCaches[r].getSource();t[c.id]||(t[c.id]=c.serialize())}return t}_serializeLayers(t){const r=[];for(const c of t){const p=this._layers[c];p&&p.type!=="custom"&&r.push(p.serialize())}return r}hasLightTransitions(){return!(!this.light||!this.light.hasTransition())||!(!this.ambientLight||!this.ambientLight.hasTransition())||!(!this.directionalLight||!this.directionalLight.hasTransition())}hasFogTransition(){return!!this.fog&&this.fog.hasTransition()}hasSnowTransition(){return!!this.snow&&this.snow.hasTransition()}hasRainTransition(){return!!this.rain&&this.rain.hasTransition()}hasTransitions(){if(this.hasLightTransitions()||this.hasFogTransition()||this.hasSnowTransition()||this.hasRainTransition())return!0;for(const t in this._sourceCaches)if(this._sourceCaches[t].hasTransition())return!0;for(const t in this._layers)if(this._layers[t].hasTransition())return!0;return!1}get order(){return this.terrain?this._drapedFirstOrder:this._mergedOrder}_getOrder(t){return t?this.order:this._mergedOrder}isLayerDraped(t){return!!this.terrain&&t.isDraped(this.getLayerSourceCache(t))}_checkLoaded(){if(!this._loaded)throw new Error("Style is not done loading")}_checkLayer(t){const r=this.getOwnLayer(t);if(r)return r;this.fire(new s.z(new Error(`The layer '${t}' does not exist in the map's style.`)))}_checkSource(t){const r=this.getOwnSource(t);if(r)return r;this.fire(new s.z(new Error(`The source '${t}' does not exist in the map's style.`)))}precompilePrograms(t,r){const c=this.map.painter;if(c)for(let p=t.minzoom||0;p<(t.maxzoom||25.5);p++){const _=t.getProgramIds();if(_)for(const v of _){const b=t.getDefaultProgramParams(v,r.zoom,this._styleColorTheme.lut);b&&(c.style=this,this.fog&&(c._fogVisible=!0,b.overrideFog=!0,c.getOrCreateProgram(v,b)),c._fogVisible=!1,b.overrideFog=!1,c.getOrCreateProgram(v,b),(this.stylesheet.terrain||this.stylesheet.projection&&this.stylesheet.projection.name==="globe")&&(b.overrideRtt=!0,c.getOrCreateProgram(v,b)))}}}update(t){if(!this._loaded)return;this.ambientLight&&this.ambientLight.recalculate(t),this.directionalLight&&this.directionalLight.recalculate(t);const r=this.calculateLightsBrightness();t.brightness=r||0,r!==this._brightness&&(this._brightness=r,this.dispatcher.broadcast("setBrightness",r)),t.worldview!==this._worldview&&(this._worldview=t.worldview,this.dispatcher.broadcast("setWorldview",this._worldview));const c=this._changes.isDirty();let p=!1;if(this._changes.isDirty()){const b=this._changes.getLayerUpdatesByScope();for(const I in b){const{updatedIds:M,removedIds:L}=b[I];(M||L)&&(this._updateWorkerLayers(I,M,L),p=!0)}this.updateSourceCaches(),this._updateTilesForChangedImages(),this.updateLayers(t),this.light&&this.light.updateTransitions(t),this.ambientLight&&this.ambientLight.updateTransitions(t),this.directionalLight&&this.directionalLight.updateTransitions(t),this.fog&&this.fog.updateTransitions(t),this.snow&&this.snow.updateTransitions(t),this.rain&&this.rain.updateTransitions(t),this._changes.reset()}const _={};for(const b in this._mergedSourceCaches){const I=this._mergedSourceCaches[b];_[b]=I.used,I.used=!1,I.tileCoverLift=0}for(const b of this._mergedOrder){const I=this._mergedLayers[b];if(I.recalculate(t,this._availableImages),!I.isHidden(t.zoom)){const M=this.getLayerSourceCache(I);M&&(M.used=!0,M.tileCoverLift=Math.max(M.tileCoverLift,I.tileCoverLift()))}!this._precompileDone&&this._shouldPrecompile&&("requestIdleCallback"in window?requestIdleCallback((()=>{this.precompilePrograms(I,t)})):this.precompilePrograms(I,t))}this._shouldPrecompile&&(this._precompileDone=!0),this.terrain&&p&&this.mergeLayers();const v=this.imageManager.getPendingImageProviders();for(const b of v)b.sourceCache.used=!0;for(const b in _){const I=this._mergedSourceCaches[b];_[b]!==I.used&&I.getSource().fire(new s.A("data",{sourceDataType:"visibility",dataType:"source",sourceId:I.getSource().id}))}this.light&&this.light.recalculate(t),this.terrain&&this.terrain.recalculate(t),this.fog&&this.fog.recalculate(t),this.snow&&this.snow.recalculate(t),this.rain&&this.rain.recalculate(t),this.z=t.zoom,this._markersNeedUpdate&&(this._updateMarkersOpacity(),this._markersNeedUpdate=!1),this.imageManager.clearUpdatedImages(this.scope),c&&this.fire(new s.A("data",{dataType:"style"}))}updateImageProviders(){const t=this.imageManager.getPendingImageProviders();for(const r of t){const c=r.resolvePendingRequests(),p=this.getFragmentStyle(r.scope);p&&p.addImages(c)}}_updateTilesForChangedImages(){const t={};for(const r in this._mergedSourceCaches){const c=this._mergedSourceCaches[r].getSource().scope;t[c]=t[c]||this._changes.getUpdatedImages(c),t[c].length!==0&&this._mergedSourceCaches[r].reloadTilesForDependencies(["icons","patterns"],t[c])}for(const r in t)this._changes.resetUpdatedImages(r)}_updateWorkerLayers(t,r,c){const p=this.getFragmentStyle(t);p&&this.dispatcher.broadcast("updateLayers",{layers:r?p._serializeLayers(r):[],scope:t,removedIds:c||[],options:p.options})}setState(t,r){if(this._checkLoaded(),cc(this,gs(t)))return!1;(t=s.di(t)).layers=ea(t.layers);const c=(function(v,b){if(!v)return[{command:xn.setStyle,args:[b]}];let I=[];try{if(!s.bv(v.version,b.version))return[{command:xn.setStyle,args:[b]}];if(s.bv(v.center,b.center)||I.push({command:xn.setCenter,args:[b.center]}),s.bv(v.zoom,b.zoom)||I.push({command:xn.setZoom,args:[b.zoom]}),s.bv(v.bearing,b.bearing)||I.push({command:xn.setBearing,args:[b.bearing]}),s.bv(v.pitch,b.pitch)||I.push({command:xn.setPitch,args:[b.pitch]}),s.bv(v.sprite,b.sprite)||I.push({command:xn.setSprite,args:[b.sprite]}),s.bv(v.glyphs,b.glyphs)||I.push({command:xn.setGlyphs,args:[b.glyphs]}),s.bv(v.imports,b.imports)||(function(V=[],$=[],H){$=$||[];const X=(V=V||[]).map(wa),Z=$.map(wa),te=V.reduce(ll,{}),oe=$.reduce(ll,{}),le=X.slice();let pe,ye,we,me;for(pe=0,ye=0;pe<X.length;pe++)we=X[pe],oe.hasOwnProperty(we)?ye++:(H.push({command:xn.removeImport,args:[we]}),le.splice(le.indexOf(we,ye),1));for(pe=0,ye=0;pe<Z.length;pe++)we=Z[Z.length-1-pe],le[le.length-1-pe]!==we&&(te.hasOwnProperty(we)?(H.push({command:xn.removeImport,args:[we]}),le.splice(le.lastIndexOf(we,le.length-ye),1)):ye++,me=le[le.length-pe],H.push({command:xn.addImport,args:[oe[we],me]}),le.splice(le.length-pe,0,we));for(const _e of $){const ge=te[_e.id];ge&&(delete ge.data,s.bv(ge,_e)||H.push({command:xn.updateImport,args:[_e.id,_e]}))}})(v.imports,b.imports,I),s.bv(v.transition,b.transition)||I.push({command:xn.setTransition,args:[b.transition]}),s.bv(v.light,b.light)||I.push({command:xn.setLight,args:[b.light]}),s.bv(v.fog,b.fog)||I.push({command:xn.setFog,args:[b.fog]}),s.bv(v.snow,b.snow)||I.push({command:xn.setSnow,args:[b.snow]}),s.bv(v.rain,b.rain)||I.push({command:xn.setRain,args:[b.rain]}),s.bv(v.projection,b.projection)||I.push({command:xn.setProjection,args:[b.projection]}),s.bv(v.lights,b.lights)||I.push({command:xn.setLights,args:[b.lights]}),s.bv(v.camera,b.camera)||I.push({command:xn.setCamera,args:[b.camera]}),s.bv(v.iconsets,b.iconsets)||(function(V,$,H){let X;for(X in $=$||{},V=V||{})V.hasOwnProperty(X)&&($.hasOwnProperty(X)||H.push({command:xn.removeIconset,args:[X]}));for(X in $){if(!$.hasOwnProperty(X))continue;const Z=$[X];V.hasOwnProperty(X)?s.bv(V[X],Z)||(H.push({command:xn.removeIconset,args:[X]}),H.push({command:xn.addIconset,args:[X,Z]})):H.push({command:xn.addIconset,args:[X,Z]})}})(v.iconsets,b.iconsets,I),!s.bv(v["color-theme"],b["color-theme"]))return[{command:xn.setStyle,args:[b]}];const M={},L=[];(function(V,$,H,X){let Z;for(Z in $=$||{},V=V||{})V.hasOwnProperty(Z)&&($.hasOwnProperty(Z)||Qs(Z,H,X));for(Z in $){if(!$.hasOwnProperty(Z))continue;const te=$[Z];V.hasOwnProperty(Z)?s.bv(V[Z],te)||(V[Z].type==="geojson"&&te.type==="geojson"&&vd(V,$,Z)?H.push({command:xn.setGeoJSONSourceData,args:[Z,te.data]}):ru(Z,$,H,X)):nu(Z,$,H)}})(v.sources,b.sources,L,M);const B=[];v.layers&&v.layers.forEach((V=>{V.source&&M[V.source]?I.push({command:xn.removeLayer,args:[V.id]}):B.push(V)}));let F=v.terrain;F&&M[F.source]&&(I.push({command:xn.setTerrain,args:[void 0]}),F=void 0),I=I.concat(L),s.bv(F,b.terrain)||I.push({command:xn.setTerrain,args:[b.terrain]}),(function(V,$,H){$=$||[];const X=(V=V||[]).map(wa),Z=$.map(wa),te=V.reduce(ll,{}),oe=$.reduce(ll,{}),le=X.slice(),pe=Object.create(null);let ye,we,me,_e,ge,Be,Ce;for(ye=0,we=0;ye<X.length;ye++)me=X[ye],oe.hasOwnProperty(me)?we++:(H.push({command:xn.removeLayer,args:[me]}),le.splice(le.indexOf(me,we),1));for(ye=0,we=0;ye<Z.length;ye++)me=Z[Z.length-1-ye],le[le.length-1-ye]!==me&&(te.hasOwnProperty(me)?(H.push({command:xn.removeLayer,args:[me]}),le.splice(le.lastIndexOf(me,le.length-we),1)):we++,Be=le[le.length-ye],H.push({command:xn.addLayer,args:[oe[me],Be]}),le.splice(le.length-ye,0,me),pe[me]=!0);for(ye=0;ye<Z.length;ye++)if(me=Z[ye],_e=te[me],ge=oe[me],!pe[me]&&!s.bv(_e,ge))if(s.bv(_e.source,ge.source)&&s.bv(_e["source-layer"],ge["source-layer"])&&s.bv(_e.type,ge.type)){for(Ce in xa(_e.layout,ge.layout,H,me,null,xn.setLayoutProperty),xa(_e.paint,ge.paint,H,me,null,xn.setPaintProperty),s.bv(_e.slot,ge.slot)||H.push({command:xn.setSlot,args:[me,ge.slot]}),s.bv(_e.filter,ge.filter)||H.push({command:xn.setFilter,args:[me,ge.filter]}),s.bv(_e.minzoom,ge.minzoom)&&s.bv(_e.maxzoom,ge.maxzoom)||H.push({command:xn.setLayerZoomRange,args:[me,ge.minzoom,ge.maxzoom]}),_e)_e.hasOwnProperty(Ce)&&Ce!=="layout"&&Ce!=="paint"&&Ce!=="filter"&&Ce!=="metadata"&&Ce!=="minzoom"&&Ce!=="maxzoom"&&Ce!=="slot"&&(Ce.indexOf("paint.")===0?xa(_e[Ce],ge[Ce],H,me,Ce.slice(6),xn.setPaintProperty):s.bv(_e[Ce],ge[Ce])||H.push({command:xn.setLayerProperty,args:[me,Ce,ge[Ce]]}));for(Ce in ge)ge.hasOwnProperty(Ce)&&!_e.hasOwnProperty(Ce)&&Ce!=="layout"&&Ce!=="paint"&&Ce!=="filter"&&Ce!=="metadata"&&Ce!=="minzoom"&&Ce!=="maxzoom"&&Ce!=="slot"&&(Ce.indexOf("paint.")===0?xa(_e[Ce],ge[Ce],H,me,Ce.slice(6),xn.setPaintProperty):s.bv(_e[Ce],ge[Ce])||H.push({command:xn.setLayerProperty,args:[me,Ce,ge[Ce]]}))}else H.push({command:xn.removeLayer,args:[me]}),Be=le[le.lastIndexOf(me)+1],H.push({command:xn.addLayer,args:[ge,Be]})})(B,b.layers,I)}catch(M){console.warn("Unable to compute style diff:",M),I=[{command:xn.setStyle,args:[b]}]}return I})(this.serialize(),t).filter((v=>!(v.command in kf)));if(c.length===0)return!1;const p=c.filter((v=>!(v.command in Lf)));if(p.length>0)throw new Error(`Unimplemented: ${p.map((v=>v.command)).join(", ")}.`);const _=[];return c.forEach((v=>{_.push(this[v.command](...v.args))})),r&&Promise.all(_).then(r).catch(r),this.stylesheet=t,this.mergeAll(),this.dispatcher.broadcast("setLayers",{layers:this._serializeLayers(this._order),scope:this.scope,options:this.options}),!0}_updateWorkerImages(){this._availableImages=this.imageManager.listImages(this.scope),this.dispatcher.broadcast("setImages",{scope:this.scope,images:this._availableImages})}_updateWorkerModels(){this._availableModels=this.modelManager.getModelURIs(this.scope),this.dispatcher.broadcast("setModels",{scope:this.scope,models:this._availableModels})}addImages(t){if(t.size===0)return this;for(const[r,c]of t.entries()){if(this.getImage(r))return this.fire(new s.z(new Error(`An image with the name "${r.name}" already exists.`)));this.imageManager.addImage(r,this.scope,c),this._changes.updateImage(r,this.scope)}return this._updateWorkerImages(),this.fire(new s.A("data",{dataType:"style"})),this}addImage(t,r){return this.getImage(t)?this.fire(new s.z(new Error(`An image with the name "${t.name}" already exists.`))):(this.imageManager.addImage(t,this.scope,r),this._changes.updateImage(t,this.scope),this._updateWorkerImages(),this.fire(new s.A("data",{dataType:"style"})),this)}updateImage(t,r,c=!1){this.imageManager.updateImage(t,this.scope,r),c&&(this._changes.updateImage(t,this.scope),this._updateWorkerImages(),this.fire(new s.A("data",{dataType:"style"})))}getImage(t){return this.imageManager.getImage(t,this.scope)}removeImage(t){return this.getImage(t)?(this.imageManager.removeImage(t,this.scope),this._changes.updateImage(t,this.scope),this._updateWorkerImages(),this.fire(new s.A("data",{dataType:"style"})),this):this.fire(new s.z(new Error("No image with this name exists.")))}listImages(){return this._checkLoaded(),this._availableImages.slice()}addModelURLs(t){return this.modelManager.addModelURLs(t,this.scope),this._updateWorkerModels(),this.fire(new s.A("data",{dataType:"style"})),this}addModel(t,r,c={}){return this._checkLoaded(),this._validate(ce,`models.${t}`,r,null,c)||(this.modelManager.addModel(t,r,this.scope),this.fire(new s.A("data",{dataType:"style"}))),this}hasModel(t){return this.modelManager.hasModel(t,this.scope)}removeModel(t){return this.hasModel(t)?(this.modelManager.removeModel(t,this.scope,!1,!0),this.fire(new s.A("data",{dataType:"style"})),this):this.fire(new s.z(new Error("No model with this ID exists.")))}listModels(){return this._checkLoaded(),this.modelManager.listModels(this.scope)}addSource(t,r,c={}){if(this._checkLoaded(),this.getOwnSource(t)!==void 0)throw new Error(`There is already a source with ID "${t}".`);if(!r.type)throw new Error(`The type property must be defined, but only the following properties were given: ${Object.keys(r).join(", ")}.`);if(["vector","raster","geojson","video","image"].indexOf(r.type)>=0&&this._validate(Jo,`sources.${t}`,r,null,c))return;this.map&&this.map._collectResourceTiming&&(r.collectResourceTiming=!0);const p=Ll(t,r,this.dispatcher,this);p.scope=this.scope,p.setEventedParent(this,(()=>({isSourceLoaded:this._isSourceCacheLoaded(p.id),source:p.serialize(),sourceId:p.id})));const _=v=>{const b=(v?"symbol:":"other:")+p.id,I=s.C(b,this.scope),M=this._sourceCaches[b]=new ys(I,p,v);(v?this._symbolSourceCaches:this._otherSourceCaches)[p.id]=M,M.onAdd(this.map)};_(!1),r.type!=="vector"&&r.type!=="geojson"||_(!0),p.onAdd&&p.onAdd(this.map),c.isInitialLoad||(this.mergeSources(),this._changes.setDirty())}removeSource(t){this._checkLoaded();const r=this.getOwnSource(t);if(!r)throw new Error("There is no source with this ID");for(const p in this._layers)if(this._layers[p].source===t)return this.fire(new s.z(new Error(`Source "${t}" cannot be removed while layer "${p}" is using it.`)));if(this.terrain&&this.terrain.scope===this.scope&&this.terrain.get().source===t)return this.fire(new s.z(new Error(`Source "${t}" cannot be removed while terrain is using it.`)));if(this.stylesheet.iconsets){const p=Object.entries(this.stylesheet.iconsets).find((([_,v])=>v.type==="source"&&v.source===t));if(p)return this.fire(new s.z(new Error(`Source "${t}" cannot be removed while iconset "${p[0]}" is using it.`)))}const c=this.getOwnSourceCaches(t);for(const p of c){const _=s.dj(p.id);delete this._sourceCaches[_],this._changes.discardSourceCacheUpdate(p.id),p.fire(new s.A("data",{sourceDataType:"metadata",dataType:"source",sourceId:p.getSource().id})),p.setEventedParent(null),p.clearTiles()}return delete this._otherSourceCaches[t],delete this._symbolSourceCaches[t],this.mergeSources(),r.setEventedParent(null),r.onRemove&&r.onRemove(this.map),this._changes.setDirty(),this}setGeoJSONSourceData(t,r){this._checkLoaded(),this.getOwnSource(t).setData(r),this._changes.setDirty()}getOwnSource(t){const r=this.getOwnSourceCache(t);return r&&r.getSource()}getOwnSources(){const t=[];for(const r in this._otherSourceCaches){const c=this.getOwnSourceCache(r);c&&t.push(c.getSource())}return t}areTilesLoaded(){const t=this._mergedSourceCaches;for(const r in t){const c=t[r]._tiles;for(const p in c){const _=c[p];if(_.state!=="loaded"&&_.state!=="errored")return!1}}return!0}setLights(t){if(this._checkLoaded(),!t)return delete this.ambientLight,void delete this.directionalLight;const r=this._getTransitionParameters();for(const _ of t){if(this._validate(No,"lights",_))return;switch(_.type){case"ambient":if(this.ambientLight){const v=this.ambientLight;v.set(_),v.updateTransitions(r)}else this.ambientLight=new jn(_,tn||(tn=new s.a7({color:new s.a8(s.a5.properties_light_ambient.color),"color-use-theme":new s.a8({type:"string",default:"default","property-type":"data-constant"}),intensity:new s.a8(s.a5.properties_light_ambient.intensity)})),this.scope,this.options);break;case"directional":if(this.directionalLight){const v=this.directionalLight;v.set(_),v.updateTransitions(r)}else this.directionalLight=new jn(_,Nr||(Nr=new s.a7({direction:new s.an(s.a5.properties_light_directional.direction),color:new s.a8(s.a5.properties_light_directional.color),"color-use-theme":new s.a8({type:"string",default:"default","property-type":"data-constant"}),intensity:new s.a8(s.a5.properties_light_directional.intensity),"cast-shadows":new s.a8(s.a5.properties_light_directional["cast-shadows"]),"shadow-quality":new s.a8(s.a5.properties_light_directional["shadow-quality"]),"shadow-intensity":new s.a8(s.a5.properties_light_directional["shadow-intensity"])})),this.scope,this.options)}}const c=Object.assign(r,{worldview:this.map.getWorldview()}),p=new s.aa(this.z||0,c);this.ambientLight&&this.ambientLight.recalculate(p),this.directionalLight&&this.directionalLight.recalculate(p),this._brightness=this.calculateLightsBrightness(),this.dispatcher.broadcast("setBrightness",this._brightness)}calculateLightsBrightness(){const t=this.directionalLight,r=this.ambientLight;if(!t||!r)return;const c=F=>.2126*(F[0]<=.03928?F[0]/12.92:Math.pow((F[0]+.055)/1.055,2.4))+.7152*(F[1]<=.03928?F[1]/12.92:Math.pow((F[1]+.055)/1.055,2.4))+.0722*(F[2]<=.03928?F[2]/12.92:Math.pow((F[2]+.055)/1.055,2.4)),p=t.properties.get("color").toNonPremultipliedRenderColor(null).toArray01(),_=t.properties.get("intensity"),v=t.properties.get("direction"),b=1-s.d1(v.x,v.y,v.z)[2]/90,I=c(p)*_*b,M=r.properties.get("color").toNonPremultipliedRenderColor(null).toArray01(),L=r.properties.get("intensity"),B=c(M)*L;return Number(((I+B)/2).toFixed(6))}getBrightness(){return this._brightness}getLights(){if(!this.enable3dLights())return null;const t=[];return this.directionalLight&&t.push(this.directionalLight.get()),this.ambientLight&&t.push(this.ambientLight.get()),t}enable3dLights(){return!!this.ambientLight&&!!this.directionalLight}getFragmentStyle(t){if(t==null||t===""&&this.isRootStyle())return this;if(s.dk(t)){const r=s.dl(t),c=this.fragments.find((({id:_})=>_===r));if(!c)return;const p=s.dj(t);return c.style.getFragmentStyle(p)}{const r=this.fragments.find((({id:c})=>c===t));return r?r.style:void 0}}setFeaturesetSelectors(t){if(!t)return;const r={},c=(p,_="")=>`${p}::${_}`;this._featuresetSelectors={};for(const p in t){const _=this._featuresetSelectors[p]=[];for(const v of t[p].selectors){if(v.featureNamespace){const I=this.getOwnLayer(v.layer);if(!I){s.w(`Layer is undefined for selector: ${v.layer}`);continue}const M=c(I.source,I.sourceLayer);if(M in r&&r[M]!==v.featureNamespace){s.w(`"featureNamespace ${v.featureNamespace} of featureset ${p}'s selector is not associated to the same source, skip this selector`);continue}r[M]=v.featureNamespace}let b;if(v.properties)for(const I in v.properties){const M=s.X(v.properties[I]);M.result==="success"&&(b=b||{},b[I]=M.value)}_.push({layerId:v.layer,namespace:v.featureNamespace,properties:b,uniqueFeatureID:v._uniqueFeatureID})}}}getFeaturesetDescriptors(t){const r=this.getFragmentStyle(t);if(!r||!r.stylesheet.featuresets)return[];const c=[];for(const p in r.stylesheet.featuresets)c.push({featuresetId:p,importId:r.scope?r.scope:void 0});return c}getFeaturesetLayers(t,r){const c=this.getFragmentStyle(r),p=c.stylesheet.featuresets;if(!p||!p[t])return this.fire(new s.z(new Error(`The featureset '${t}' does not exist in the map's style and cannot be queried.`))),[];const _=[];for(const v of p[t].selectors){const b=c.getOwnLayer(v.layer);b&&_.push(b)}return _}getConfigProperty(t,r){const c=this.getFragmentStyle(t);if(!c)return null;const p=s.C(r,c.scope),_=c.options.get(p),v=_?_.value||_.default:null;return v?v.serialize():null}setConfigProperty(t,r,c){const p=this.getFragmentStyle(t);if(!p)return;const _=p.stylesheet.indoor?Tp(p.stylesheet.schema):p.stylesheet.schema;if(!_||!_[r])return;const v=s.X(c);if(v.result!=="success")return void cc(this,v.value);const b=v.value.expression,I=s.C(r,p.scope),M=p.options.get(I);if(!M)return;let L;const{minValue:B,maxValue:F,stepValue:V,type:$,values:H}=_[r],X=s.X(_[r].default);X.result==="success"&&(L=X.value.expression),L?(this.options.set(I,Object.assign({},M,{value:b,default:L,minValue:B,maxValue:F,stepValue:V,type:$,values:H})),this.updateConfigDependencies(r)):this.fire(new s.z(new Error(`No schema defined for the config option "${r}" in the "${t}" fragment.`)))}getConfig(t){const r=this.getFragmentStyle(t);if(!r)return null;const c=r.stylesheet.schema;if(!c)return null;const p={};for(const _ in c){const v=s.C(_,r.scope),b=r.options.get(v),I=b?b.value||b.default:null;p[_]=I?I.serialize():null}return p}setConfig(t,r){const c=this.getFragmentStyle(t);c&&(c.updateConfig(r,c.stylesheet.schema),this.updateConfigDependencies())}getSchema(t){const r=this.getFragmentStyle(t);return r?r.stylesheet.schema:null}setSchema(t,r){const c=this.getFragmentStyle(t);c&&(c.stylesheet.schema=r,c.updateConfig(c._config,r),this.updateConfigDependencies())}updateConfig(t,r){if(this._config=t,t||r)if(r)for(const c in r){let p,_;const v=s.X(r[c].default);if(v.result==="success"&&(p=v.value.expression),t&&t[c]!==void 0){const F=s.X(t[c]);F.result==="success"&&(_=F.value.expression)}const{minValue:b,maxValue:I,stepValue:M,type:L,values:B}=r[c];if(p){const F=s.C(c,this.scope);this.options.set(F,{default:p,value:_,minValue:b,maxValue:I,stepValue:M,type:L,values:B})}else this.fire(new s.z(new Error(`No schema defined for config option "${c}".`)))}else this.fire(new s.z(new Error("Attempting to set config for a style without schema.")))}updateConfigDependencies(t){for(const r of this._configDependentLayers){const c=this.getLayer(r);if(c){if(t&&!c.configDependencies.has(t))continue;c.possiblyEvaluateVisibility(),this._updateLayer(c)}}this.ambientLight&&this.ambientLight.updateConfig(this.options),this.directionalLight&&this.directionalLight.updateConfig(this.options),this.fog&&this.fog.updateConfig(this.options),this.snow&&this.snow.updateConfig(this.options),this.rain&&this.rain.updateConfig(this.options),this.forEachFragmentStyle((r=>{const c=r._styleColorTheme.colorThemeOverride?r._styleColorTheme.colorThemeOverride:r._styleColorTheme.colorTheme;if(c){const p=r._evaluateColorThemeData(c);(!r._styleColorTheme.lut&&p!==""||r._styleColorTheme.lut&&p!==r._styleColorTheme.lut.data)&&r.setColorTheme(c)}})),this._changes.setDirty()}addLayer(t,r,c={}){this._checkLoaded();const p=t.id;if(this._layers[p])return void this.fire(new s.z(new Error(`Layer with id "${p}" already exists on this map`)));let _;if(t.type==="custom"){if(cc(this,s.dm(t)))return;_=s.dn(t,this.scope,this._styleColorTheme.lut,this.options)}else{if(typeof t.source=="object"&&(this.addSource(p,t.source),t=s.di(t),t=s.h(t,{source:p})),this._validate(vn,`layers.${p}`,t,{arrayIndex:-1},c))return;_=s.dn(t,this.scope,this._styleColorTheme.lut,this.options),this._validateLayer(_),_.setEventedParent(this,{layer:{id:p}})}_.configDependencies.size!==0&&this._configDependentLayers.add(_.fqid);let v=this._order.length;if(r){const L=this._order.indexOf(r);if(L===-1)return void this.fire(new s.z(new Error(`Layer with id "${r}" does not exist on this map.`)));_.slot===this._layers[r].slot?v=L:s.w(`Layer with id "${r}" has a different slot. Layers can only be rearranged within the same slot.`)}this._order.splice(v,0,p),this._layerOrderChanged=!0,this._layers[p]=_;const b=this.getOwnLayerSourceCache(_),I=!!this.directionalLight&&this.directionalLight.shadowsEnabled();b&&_.canCastShadows()&&I&&(b.castsShadows=!0);const M=this._changes.getRemovedLayer(_);if(M&&_.source&&b&&_.type!=="custom"){this._changes.discardLayerRemoval(_);const L=s.C(_.source,_.scope);M.type!==_.type?this._changes.updateSourceCache(L,"clear"):(this._changes.updateSourceCache(L,"reload"),b.pause())}this._updateLayer(_),_.onAdd&&_.onAdd(this.map),_.scope=this.scope,this.mergeLayers()}moveLayer(t,r){this._checkLoaded();const c=this._checkLayer(t);if(!c||t===r)return;const p=this._order.indexOf(t);this._order.splice(p,1);let _=this._order.length;if(r){const v=this._order.indexOf(r);if(v===-1)return void this.fire(new s.z(new Error(`Layer with id "${r}" does not exist on this map.`)));c.slot===this._layers[r].slot?_=v:s.w(`Layer with id "${r}" has a different slot. Layers can only be rearranged within the same slot.`)}this._order.splice(_,0,t),this._changes.setDirty(),this._layerOrderChanged=!0,this.mergeLayers()}removeLayer(t){this._checkLoaded();const r=this._checkLayer(t);if(!r)return;r.setEventedParent(null);const c=this._order.indexOf(t);this._order.splice(c,1),delete this._layers[t],this._changes.setDirty(),this._layerOrderChanged=!0,this._configDependentLayers.delete(r.fqid),this._changes.removeLayer(r);const p=this.getOwnLayerSourceCache(r);if(p&&p.castsShadows){let _=!1;for(const v in this._layers)if(this._layers[v].source===r.source&&this._layers[v].canCastShadows()){_=!0;break}p.castsShadows=_}r.onRemove&&r.onRemove(this.map),this.mergeLayers()}getOwnLayer(t){return this._layers[t]}hasLayer(t){return t in this._mergedLayers}hasLayerType(t){for(const r in this._layers)if(this._layers[r].type===t)return!0;return!1}setLayerZoomRange(t,r,c){this._checkLoaded();const p=this._checkLayer(t);p&&(p.minzoom===r&&p.maxzoom===c||(r!=null&&(p.minzoom=r),c!=null&&(p.maxzoom=c),this._updateLayer(p)))}getSlots(){return this._checkLoaded(),this._mergedSlots}setSlot(t,r){this._checkLoaded();const c=this._checkLayer(t);c&&c.slot!==r&&(c.slot=r,this._updateLayer(c))}setFilter(t,r,c={}){this._checkLoaded();const p=this._checkLayer(t);if(p&&!s.bv(p.filter,r))return r==null?(p.filter=void 0,void this._updateLayer(p)):void(this._validate(ke,`layers.${p.id}.filter`,r,{layerType:p.type},c)||(p.filter=s.di(r),this._updateLayer(p)))}getFilter(t){const r=this._checkLayer(t);if(r)return s.di(r.filter)}setLayoutProperty(t,r,c,p={}){this._checkLoaded();const _=this._checkLayer(t);if(_&&!s.bv(_.getLayoutProperty(r),c)){if(c!=null&&(!p||p.validate!==!1)&&cc(_,J.call(gs,{key:`layers.${t}.layout.${r}`,layerType:_.type,objectKey:r,value:c,styleSpec:s.a5,style:{glyphs:!0,sprite:!0}})))return;_.setLayoutProperty(r,c),_.configDependencies.size!==0&&this._configDependentLayers.add(_.fqid),this._updateLayer(_)}}getLayoutProperty(t,r){const c=this._checkLayer(t);if(c)return c.getLayoutProperty(r)}setPaintProperty(t,r,c,p={}){this._checkLoaded();const _=this._checkLayer(t);if(!_||s.bv(_.getPaintProperty(r),c)||c!=null&&(!p||p.validate!==!1)&&cc(_,Q.call(gs,{key:`layers.${t}.paint.${r}`,layerType:_.type,objectKey:r,value:c,styleSpec:s.a5})))return;const v=_.setPaintProperty(r,c);_.configDependencies.size!==0&&this._configDependentLayers.add(_.fqid),v&&this._updateLayer(_),this._changes.updatePaintProperties(_)}getPaintProperty(t,r){const c=this._checkLayer(t);if(c)return c.getPaintProperty(r)}setFeatureState(t,r){if(this._checkLoaded(),"target"in t){if("featuresetId"in t.target){const{featuresetId:I,importId:M}=t.target,L=this.getFragmentStyle(M),B=L.getFeaturesetLayers(I);for(const{source:F,sourceLayer:V}of B)L.setFeatureState({id:t.id,source:F,sourceLayer:V},r)}else if("layerId"in t.target){const{layerId:I}=t.target,M=this.getLayer(I);this.setFeatureState({id:t.id,source:M.source,sourceLayer:M.sourceLayer},r)}return}const c=t.source,p=t.sourceLayer,_=this._checkSource(c);if(!_)return;const v=_.type;if(v==="geojson"&&p)return void this.fire(new s.z(new Error("GeoJSON sources cannot have a sourceLayer parameter.")));if(v==="vector"&&!p)return void this.fire(new s.z(new Error("The sourceLayer parameter must be provided for vector source types.")));t.id===void 0&&this.fire(new s.z(new Error("The feature id parameter must be provided.")));const b=this.getOwnSourceCaches(c);for(const I of b)I.setFeatureState(p,t.id,r)}removeFeatureState(t,r){if(this._checkLoaded(),"target"in t){if("featuresetId"in t.target){const{featuresetId:I,importId:M}=t.target,L=this.getFragmentStyle(M),B=L.getFeaturesetLayers(I);for(const{source:F,sourceLayer:V}of B)L.removeFeatureState({id:t.id,source:F,sourceLayer:V},r)}else if("layerId"in t.target){const{layerId:I}=t.target,M=this.getLayer(I);this.removeFeatureState({id:t.id,source:M.source,sourceLayer:M.sourceLayer},r)}return}const c=t.source,p=this._checkSource(c);if(!p)return;const _=p.type,v=_==="vector"?t.sourceLayer:void 0;if(_==="vector"&&!v)return void this.fire(new s.z(new Error("The sourceLayer parameter must be provided for vector source types.")));if(r&&typeof t.id!="string"&&typeof t.id!="number")return void this.fire(new s.z(new Error("A feature id is required to remove its specific state property.")));const b=this.getOwnSourceCaches(c);for(const I of b)I.removeFeatureState(v,t.id,r)}getFeatureState(t){if(this._checkLoaded(),"target"in t){let _;if("featuresetId"in t.target){const{featuresetId:v,importId:b}=t.target,I=this.getFragmentStyle(b),M=I.getFeaturesetLayers(v);for(const{source:L,sourceLayer:B}of M){const F=I.getFeatureState({id:t.id,source:L,sourceLayer:B});if(F&&!_)_=F;else if(!s.bv(_,F))return void this.fire(new s.z(new Error("The same feature id exists in multiple sources in the featureset, but their feature states are not consistent through the sources.")))}}else if("layerId"in t.target){const{layerId:v}=t.target,b=this.getLayer(v);_=this.getFeatureState({id:t.id,source:b.source,sourceLayer:b.sourceLayer})}return _}const r=t.source,c=t.sourceLayer,p=this._checkSource(r);if(p){if(p.type!=="vector"||c)return t.id===void 0&&this.fire(new s.z(new Error("The feature id parameter must be provided."))),this.getOwnSourceCaches(r)[0].getFeatureState(c,t.id);this.fire(new s.z(new Error("The sourceLayer parameter must be provided for vector source types.")))}}setTransition(t){return this.stylesheet.transition=s.h({},this.stylesheet.transition,t),this.transition=this.stylesheet.transition,this}getTransition(){return s.h({},this.stylesheet.transition)}serialize(){this._checkLoaded();const t=this.getTerrain(),r=t&&this.terrain&&this.terrain.scope===this.scope?t:this.stylesheet.terrain;return s.dp({version:this.stylesheet.version,name:this.stylesheet.name,metadata:this.stylesheet.metadata,fragment:this.stylesheet.fragment,iconsets:this.stylesheet.iconsets,imports:this._serializeImports(),schema:this.stylesheet.schema,camera:this.stylesheet.camera,light:this.stylesheet.light,lights:this.stylesheet.lights,terrain:r,fog:this.stylesheet.fog,snow:this.stylesheet.snow,rain:this.stylesheet.rain,center:this.stylesheet.center,"color-theme":this.stylesheet["color-theme"],zoom:this.stylesheet.zoom,bearing:this.stylesheet.bearing,pitch:this.stylesheet.pitch,sprite:this.stylesheet.sprite,glyphs:this.stylesheet.glyphs,transition:this.stylesheet.transition,projection:this.stylesheet.projection,sources:this._serializeSources(),layers:this._serializeLayers(this._order)},(c=>c!==void 0))}_updateFilteredLayers(t){for(const r of Object.values(this._mergedLayers))t(r)&&this._updateLayer(r)}_updateLayer(t){this._changes.updateLayer(t);const r=this.getLayerSourceCache(t),c=s.C(t.source,t.scope),p=this._changes.getUpdatedSourceCaches();t.source&&!p[c]&&r&&r.getSource().type!=="raster"&&(this._changes.updateSourceCache(c,"reload"),r.pause()),t.invalidateCompiledFilter()}_flattenAndSortRenderedFeatures(t){const r=b=>this._mergedLayers[b].is3D(!!this.terrain),c=this.order,p={},_=[];for(let b=c.length-1;b>=0;b--){const I=c[b];if(r(I)){p[I]=b;for(const M of t){const L=M[I];if(L)for(const B of L)_.push(B)}}}_.sort(((b,I)=>I.intersectionZ-b.intersectionZ));const v=[];for(let b=c.length-1;b>=0;b--){const I=c[b];if(r(I))for(let M=_.length-1;M>=0;M--){const L=_[M].feature;if(L.layer&&p[L.layer.id]<b)break;v.push(L),_.pop()}else for(const M of t){const L=M[I];if(L)for(const B of L)v.push(B.feature)}}return v}queryRenderedFeatures(t,r,c){let p;r&&!Array.isArray(r)&&r.filter&&(this._validate(ke,"queryRenderedFeatures.filter",r.filter,null,r),p=s.b3(r.filter));const _={},v=L=>{if(qu.has(L.type))return;const B=this.getOwnLayerSourceCache(L),F=_[B.id]=_[B.id]||{sourceCache:B,layers:{},has3DLayers:!1};L.is3D(!!this.terrain)&&(F.has3DLayers=!0),F.layers[L.fqid]=F.layers[L.fqid]||{styleLayer:L,targets:[]},F.layers[L.fqid].targets.push({filter:p})};if(r&&r.layers){if(!Array.isArray(r.layers))return this.fire(new s.z(new Error("parameters.layers must be an Array."))),[];for(const L of r.layers){const B=this._layers[L];if(!B)return this.fire(new s.z(new Error(`The layer '${L}' does not exist in the map's style and cannot be queried for features.`))),[];v(B)}}else for(const L in this._layers)v(this._layers[L]);const b=this._queryRenderedFeatures(t,_,c),I=this._flattenAndSortRenderedFeatures(b),M=[];for(const L of I)s.dq(L.layer.id)===this.scope&&M.push(L);return M}queryRenderedFeatureset(t,r,c){let p;r&&!Array.isArray(r)&&r.filter&&(this._validate(ke,"queryRenderedFeatures.filter",r.filter,null,r),p=s.b3(r.filter));const _="mock",v=[];if(r&&r.target)v.push(Object.assign({},r,{targetId:_,filter:p}));else{const L=this.getFeaturesetDescriptors();for(const B of L)v.push({targetId:_,filter:p,target:B});for(const{style:B}of this.fragments){const F=B.getFeaturesetDescriptors();for(const V of F)v.push({targetId:_,filter:p,target:V})}}const b=this.queryRenderedTargets(t,v,c),I=[],M=new Set;for(const L of b)for(const B of L.variants[_])al(B,L,M)||I.push(new s.dr(L,B));return I}queryRenderedTargets(t,r,c){const p={},_=(b,I,M,L)=>{const B=p[I.id]=p[I.id]||{sourceCache:I,layers:{},has3DLayers:!1};if(B.layers[b.fqid]=B.layers[b.fqid]||{styleLayer:b,targets:[]},b.is3D(!!this.terrain)&&(B.has3DLayers=!0),!L)return M.uniqueFeatureID=!1,void B.layers[b.fqid].targets.push(M);B.layers[b.fqid].targets.push(Object.assign({},M,{namespace:L.namespace,properties:L.properties,uniqueFeatureID:L.uniqueFeatureID}))};for(const b of r)if("featuresetId"in b.target){const{featuresetId:I,importId:M}=b.target,L=this.getFragmentStyle(M);if(!L||!L._featuresetSelectors)continue;const B=L._featuresetSelectors[I];if(!B){this.fire(new s.z(new Error(`The featureset '${I}' does not exist in the map's style and cannot be queried for features.`)));continue}for(const F of B){const V=L.getOwnLayer(F.layerId);V&&!qu.has(V.type)&&_(V,L.getOwnLayerSourceCache(V),b,F)}}else if("layerId"in b.target){const{layerId:I}=b.target,M=this.getLayer(I);if(!M||qu.has(M.type))continue;_(M,this.getLayerSourceCache(M),b)}const v=this._queryRenderedFeatures(t,p,c);return this._flattenAndSortRenderedFeatures(v)}_queryRenderedFeatures(t,r,c){const p=[],_=!!this.map._showQueryGeometry,v=dn.createFromScreenPoints(t,c);for(const b in r){const I=zl(v,r[b],this._availableImages,c,_);Object.keys(I).length&&p.push(I)}if(this.placement)for(const b in r){if(!r[b].sourceCache._onlySymbols)continue;const I=Jl(v.screenGeometry,r[b],this._availableImages,this.placement.collisionIndex,this.placement.retainedQueryData,this.map.getWorldview());Object.keys(I).length&&p.push(I)}return p}querySourceFeatures(t,r){const c=r&&r.filter;c&&this._validate(ke,"querySourceFeatures.filter",c,null,r);let p=[];const _=this.getOwnSourceCaches(t);for(const v of _)p=p.concat(ga(v,r));return p}addSourceType(t,r,c){return yo.getSourceType(t)?c(new Error(`A source type called "${t}" already exists.`)):(yo.setSourceType(t,r),r.workerSourceURL?void this.dispatcher.broadcast("loadWorkerSource",{name:t,url:r.workerSourceURL},c):c(null,null))}getFlatLight(){return this.light.getLight()}setFlatLight(t,r,c={}){this._checkLoaded();const p=this.light.getLight();let _=!1;for(const b in t)if(!s.bv(t[b],p[b])){_=!0;break}if(!_)return;const v=this._getTransitionParameters();this.light.setLight(t,r,c),this.light.updateTransitions(v)}getTerrain(){return this.terrain&&this.terrain.drapeRenderMode===1?this.terrain.get():null}setTerrainForDraping(){this.setTerrain({source:"",exaggeration:0},0)}checkCanvasFingerprintNoise(){this.disableElevatedTerrain===void 0&&(this.disableElevatedTerrain=s.q.hasCanvasFingerprintNoise(),this.disableElevatedTerrain&&s.w("Terrain and hillshade are disabled because of Canvas2D limitations when fingerprinting protection is enabled (e.g. in private browsing mode)."))}setTerrain(t,r=1){if(this._checkLoaded(),!t)return this.terrainSetForDrapingOnly()||(delete this.terrain,this.map.transform.projection.requiresDraping&&this.setTerrainForDraping()),r===0&&delete this.terrain,t===null?this.stylesheet.terrain=null:delete this.stylesheet.terrain,this._force3DLayerUpdate(),void(this._markersNeedUpdate=!0);this.checkCanvasFingerprintNoise();let c=t;const p=t.source==null;if(r===1){if(this.disableElevatedTerrain)return;if(typeof c.source=="object"){const b="terrain-dem-src";this.addSource(b,c.source),c=s.di(c),c=s.h(c,{source:b})}const _=s.h({},c),v={};if(this.terrain&&p){_.source=this.terrain.get().source;const b=this.terrain?this.getFragmentStyle(this.terrain.scope):null;b&&(v.style=b.serialize())}if(this._validate(gt,"terrain",_,v))return}if(!this.terrain||this.terrain.scope!==this.scope&&!p||this.terrain&&r!==this.terrain.drapeRenderMode){if(!c)return;this._createTerrain(c,r),this.fire(new s.A("data",{dataType:"style"}))}else{const _=this.terrain,v=_.get();for(const b of Object.keys(s.a5.terrain))!c.hasOwnProperty(b)&&s.a5.terrain[b].default&&(c[b]=s.a5.terrain[b].default);for(const b in t)if(!s.bv(t[b],v[b])){_.set(t,this.options),this.stylesheet.terrain=t;const I=this._getTransitionParameters({duration:0});_.updateTransitions(I),this.fire(new s.A("data",{dataType:"style"}));break}}this.mergeTerrain(),this.updateDrapeFirstLayers(),this._markersNeedUpdate=!0}_createFog(t){const r=this.fog=new Vi(t,this.map.transform,this.scope,this.options);this.stylesheet.fog=r.get();const c=this._getTransitionParameters({duration:0});r.updateTransitions(c)}_createSnow(t){const r=this.snow=new Fn(t,this.map.transform,this.scope,this.options);this.stylesheet.snow=r.get();const c=this._getTransitionParameters({duration:0});r.updateTransitions(c)}_createRain(t){const r=this.rain=new ns(t,this.map.transform,this.scope,this.options);this.stylesheet.rain=r.get();const c=this._getTransitionParameters({duration:0});r.updateTransitions(c)}_updateMarkersOpacity(){this.map._markers.length!==0&&this.map._requestDomTask((()=>{for(const t of this.map._markers)t._evaluateOpacity()}))}getFog(){return this.fog?this.fog.get():null}setFog(t){if(this._checkLoaded(),!t)return delete this.fog,delete this.stylesheet.fog,void(this._markersNeedUpdate=!0);if(this.fog){const r=this.fog;if(!s.bv(r.get(),t)){r.set(t,this.options),this.stylesheet.fog=r.get();const c=this._getTransitionParameters({duration:0});r.updateTransitions(c)}}else this._createFog(t);this._markersNeedUpdate=!0}getSnow(){return this.snow?this.snow.get():null}setSnow(t){if(this._checkLoaded(),!t)return delete this.snow,void delete this.stylesheet.snow;if(this.snow){const r=this.snow;if(!s.bv(r.get(),t)){r.set(t,this.options),this.stylesheet.snow=r.get();const c=this._getTransitionParameters({duration:0});r.updateTransitions(c)}}else this._createSnow(t);this._markersNeedUpdate=!0}getRain(){return this.rain?this.rain.get():null}setRain(t){if(this._checkLoaded(),!t)return delete this.rain,void delete this.stylesheet.rain;if(this.rain){const r=this.rain;if(!s.bv(r.get(),t)){r.set(t,this.options),this.stylesheet.rain=r.get();const c=this._getTransitionParameters({duration:0});r.updateTransitions(c)}}else this._createRain(t);this._markersNeedUpdate=!0}_reloadColorTheme(){const t=()=>{for(const p in this._layers)this._layers[p].lut=this._styleColorTheme.lut;for(const p in this._sourceCaches)this._sourceCaches[p].clearTiles()},r=this._styleColorTheme.colorThemeOverride?this._styleColorTheme.colorThemeOverride:this._styleColorTheme.colorTheme;if(!r)return this._styleColorTheme.lut=null,void t();const c=this._evaluateColorThemeData(r);this._loadColorTheme(c).then((()=>{this.fire(new s.A("colorthemeset")),t()})).catch((p=>{s.w(`Couldn't set color theme: ${p}`)}))}setColorTheme(t){this._checkLoaded(),this._styleColorTheme.colorThemeOverride&&s.w("Note: setColorTheme is called on a style with a color-theme override, the passed color-theme won't be visible."),this._styleColorTheme.colorTheme=t,this._reloadColorTheme()}setImportColorTheme(t,r){const c=this.getFragmentStyle(t);c&&(c._styleColorTheme.colorThemeOverride=r,c._reloadColorTheme())}_getTransitionParameters(t){return{now:s.q.now(),transition:s.h(this.transition,t)}}updateDrapeFirstLayers(){if(!this.terrain)return;const t=[],r=[];for(const c of this._mergedOrder)this.isLayerDraped(this._mergedLayers[c])?t.push(c):r.push(c);this._drapedFirstOrder=[],this._drapedFirstOrder.push(...t),this._drapedFirstOrder.push(...r)}_createTerrain(t,r){const c=this.terrain=new Re(t,r,this.scope,this.options,this.map.getWorldview());r===1&&(this.stylesheet.terrain=t),this.mergeTerrain(),this.updateDrapeFirstLayers(),this._force3DLayerUpdate();const p=this._getTransitionParameters({duration:0});c.updateTransitions(p)}_force3DLayerUpdate(){for(const t in this._layers){const r=this._layers[t];r.type==="fill-extrusion"&&this._updateLayer(r)}}_forceSymbolLayerUpdate(){for(const t in this._layers){const r=this._layers[t];r.type==="symbol"&&this._updateLayer(r)}}_validate(t,r,c,p,_={}){if(_&&_.validate===!1)return!1;const v=s.h({},this.serialize());return cc(this,t.call(gs,s.h({key:r,style:v,value:c,styleSpec:s.a5},p)))}_remove(){this._request&&(this._request.cancel(),this._request=null),this._spriteRequest&&(this._spriteRequest.cancel(),this._spriteRequest=null),s.ds.off("pluginStateChange",this._rtlTextPluginCallback);for(const t in this._mergedLayers)this._mergedLayers[t].setEventedParent(null);for(const t in this._mergedSourceCaches)this._mergedSourceCaches[t].clearTiles(),this._mergedSourceCaches[t].setEventedParent(null);this.imageManager.removeScope(this.scope),this.setEventedParent(null),delete this.fog,delete this.snow,delete this.rain,delete this.terrain,delete this.ambientLight,delete this.directionalLight,this.isRootStyle()&&(this.imageManager.setEventedParent(null),this.imageManager.destroy(),this.modelManager.setEventedParent(null),this.modelManager.destroy(),this.dispatcher.remove())}clearSource(t){const r=this.getSourceCaches(t);for(const c of r)c.clearTiles()}clearSources(){for(const t in this._mergedSourceCaches)this._mergedSourceCaches[t].clearTiles()}clearLayers(){for(const t in this._mergedLayers){const r=this._mergedLayers[t];r._clear&&r._clear()}}reloadSource(t){const r=this.getSourceCaches(t);for(const c of r)c.resume(),c.reload()}reloadSources(){for(const t of this.getSources())t.reload&&t.reload()}reloadModels(){this.modelManager.reloadModels(""),this.forEachFragmentStyle((t=>{t.modelManager.reloadModels(t.scope)}))}updateSources(t){let r;this.directionalLight&&(r=Rc(this.directionalLight));const c=new Set;for(const p in this._mergedLayers){const _=this._mergedLayers[p];_.hasElevation()&&!c.has(_.source)&&c.add(_.source)}for(const p in this._mergedSourceCaches){const _=this._mergedSourceCaches[p],v=c.has(_._source.id);_.update(t,void 0,void 0,r,v)}}_generateCollisionBoxes(){for(const t in this._sourceCaches){const r=this._sourceCaches[t];r.resume(),r.reload()}}_updatePlacement(t,r,c,p,_,v,b=!1){let I=!1,M=!1;const L={},B={};for(const F of this._mergedOrder){const V=this._mergedLayers[F];if(V.type!=="symbol")continue;const $=s.C(V.source,V.scope);let H=L[$];if(!H){const Z=this.getLayerSourceCache(V);if(!Z)continue;const te=Z.getRenderableIds(!0).map((oe=>Z.getTileByID(oe)));B[$]=te.slice(),H=L[$]=te.sort(((oe,le)=>le.tileID.overscaledZ-oe.tileID.overscaledZ||(oe.tileID.isLessThan(le.tileID)?-1:1)))}const X=this.crossTileSymbolIndex.addLayer(V,H,r.center.lng,r.projection);I=I||X}if(this.crossTileSymbolIndex.pruneUnusedLayers(this._mergedOrder),b=b||this._layerOrderChanged||p===0,this._layerOrderChanged&&this.fire(new s.A("neworder")),(b||!this.pauseablePlacement||this.pauseablePlacement.isDone()&&!this.placement.stillRecent(s.q.now(),r.zoom))&&(this.pauseablePlacement=new ie(r,this._mergedOrder,b,c,p,_,this.placement,this.fog&&r.projection.supportsFog?this.fog.state:null,this._buildingIndex),this._layerOrderChanged=!1),this.pauseablePlacement.isDone()?this.placement.setStale():(this.pauseablePlacement.continuePlacement(this._mergedOrder,this._mergedLayers,L,B,this.map.painter.scaleFactor),this.pauseablePlacement.isDone()&&(this.placement=this.pauseablePlacement.commit(s.q.now()),M=!0),I&&this.pauseablePlacement.placement.setStale()),M||I){this._buildingIndex.onNewFrame(r.zoom);for(let F=0;F<this._mergedOrder.length;F++){const V=this._mergedLayers[this._mergedOrder[F]];if(V.type!=="symbol")continue;const $=this.isLayerClipped(V);this.placement.updateLayerOpacities(V,L[s.C(V.source,V.scope)],F,$?v:null)}}return{needsRerender:!this.pauseablePlacement.isDone()||this.placement.hasTransitions(s.q.now())}}_releaseSymbolFadeTiles(){for(const t in this._sourceCaches)this._sourceCaches[t].releaseSymbolFadeTiles()}addImport(t,r){this._checkLoaded();const c=this.stylesheet.imports=this.stylesheet.imports||[];if(c.findIndex((({id:_})=>_===t.id))!==-1)return void this.fire(new s.z(new Error(`Import with id '${t.id}' already exists in the map's style.`)));if(!r)return c.push(t),this._loadImports([t],!0);const p=c.findIndex((({id:_})=>_===r));return p===-1&&this.fire(new s.z(new Error(`Import with id "${r}" does not exist on this map.`))),this.stylesheet.imports=c.slice(0,p).concat(t).concat(c.slice(p)),this._loadImports([t],!0,r)}updateImport(t,r){this._checkLoaded();const c=this.stylesheet.imports||[],p=this.getImportIndex(t);return p===-1?this:typeof r=="string"?(this.setImportUrl(t,r),this):(r.url&&r.url!==c[p].url&&this.setImportUrl(t,r.url),s.bv(r.config,c[p].config)||this.setImportConfig(t,r.config,r.data.schema),s.bv(r.data,c[p].data)||this.setImportData(t,r.data),this)}moveImport(t,r){this._checkLoaded();let c=this.stylesheet.imports||[];const p=this.getImportIndex(t);if(p===-1)return this;const _=this.getImportIndex(r);if(_===-1)return this;const v=c[p],b=this.fragments[p];return c=c.filter((({id:I})=>I!==t)),this.fragments=this.fragments.filter((({id:I})=>I!==t)),this.stylesheet.imports=c.slice(0,_).concat(v).concat(c.slice(_)),this.fragments=this.fragments.slice(0,_).concat(b).concat(this.fragments.slice(_)),this.mergeLayers(),this}setImportUrl(t,r){this._checkLoaded();const c=this.stylesheet.imports||[],p=this.getImportIndex(t);if(p===-1)return this;c[p].url=r;const _=this.fragments[p];return _.style=this._createFragmentStyle(c[p]),_.style.on("style.import.load",(()=>this.mergeAll())),_.style.loadURL(r),this}setImportData(t,r){this._checkLoaded();const c=this.getImportIndex(t),p=this.stylesheet.imports||[];return c===-1?this:r?(this.fragments[c].style.setState(r),this._reloadImports(),this):(delete p[c].data,this.setImportUrl(t,p[c].url))}setImportConfig(t,r,c){this._checkLoaded();const p=this.getImportIndex(t),_=this.stylesheet.imports||[];if(p===-1)return this;r?_[p].config=r:delete _[p].config;const v=this.fragments[p];c&&v.style.stylesheet&&(v.style.stylesheet.schema=c);const b=v.style.stylesheet&&v.style.stylesheet.schema;return v.config=r,v.style.updateConfig(r,b),this.updateConfigDependencies(),this}removeImport(t){this._checkLoaded();const r=this.stylesheet.imports||[],c=this.getImportIndex(t);c!==-1&&(r.splice(c,1),this.fragments[c].style._remove(),this.fragments.splice(c,1),this._reloadImports())}getImportIndex(t){const r=(this.stylesheet.imports||[]).findIndex((c=>c.id===t));return r===-1&&this.fire(new s.z(new Error(`Import '${t}' does not exist in the map's style and cannot be updated.`))),r}getLayer(t){return this._mergedLayers[t]}getSources(){const t=[];for(const r in this._mergedOtherSourceCaches){const c=this._mergedOtherSourceCaches[r];c&&t.push(c.getSource())}return t}getSource(t,r){const c=this.getSourceCache(t,r);return c&&c.getSource()}getLayerSource(t){const r=this.getLayerSourceCache(t);return r&&r.getSource()}getSourceCache(t,r){const c=s.C(t,r);return this._mergedOtherSourceCaches[c]}getLayerSourceCache(t){const r=s.C(t.source,t.scope);return t.type==="symbol"?this._mergedSymbolSourceCaches[r]:this._mergedOtherSourceCaches[r]}getSourceCaches(t){if(t==null)return Object.values(this._mergedSourceCaches);const r=[];return this._mergedOtherSourceCaches[t]&&r.push(this._mergedOtherSourceCaches[t]),this._mergedSymbolSourceCaches[t]&&r.push(this._mergedSymbolSourceCaches[t]),r}updateSourceCaches(){const t=this._changes.getUpdatedSourceCaches();for(const r in t){const c=t[r];c==="reload"?this.reloadSource(r):c==="clear"&&this.clearSource(r)}}updateLayers(t){const r=this._changes.getUpdatedPaintProperties();for(const c of r){const p=this.getLayer(c);p&&p.updateTransitions(t)}}getGlyphsUrl(){return this.stylesheet.glyphs}setGlyphsUrl(t){this.stylesheet.glyphs=t,this.glyphManager.setURL(t)}getImages(t,r,c){this.imageManager.getImages(r.images,r.scope,c),this._updateTilesForChangedImages();const p=v=>{if(v){const b=r.images.map((I=>s.I.toString(I)));v.setDependencies(r.tileID.key,r.type,b)}},_=s.C(r.source,r.scope);p(this._mergedOtherSourceCaches[_]),p(this._mergedSymbolSourceCaches[_]),r.images.some((v=>v.iconsetId))&&this.fire(new s.A("data",{dataType:"style"}))}rasterizeImages(t,r,c){this.imageManager.rasterizeImages(r,c)}getGlyphs(t,r,c){this.glyphManager.getGlyphs(r.stacks,c)}getResource(t,r,c){return s.dt(r,c)}getOwnSourceCache(t){return this._otherSourceCaches[t]}getOwnLayerSourceCache(t){return t.type==="symbol"?this._symbolSourceCaches[t.source]:this._otherSourceCaches[t.source]}getOwnSourceCaches(t){const r=[];return this._otherSourceCaches[t]&&r.push(this._otherSourceCaches[t]),this._symbolSourceCaches[t]&&r.push(this._symbolSourceCaches[t]),r}_isSourceCacheLoaded(t){const r=this.getOwnSourceCaches(t);return r.length===0?(this.fire(new s.z(new Error(`There is no source with ID '${t}'`))),!1):r.every((c=>c.loaded()))}has3DLayers(){return this._has3DLayers}hasSymbolLayers(){return this._hasSymbolLayers}hasCircleLayers(){return this._hasCircleLayers}isLayerClipped(t,r){if(!this._clipLayerPresent&&t.type!=="fill-extrusion"&&t.type!=="building")return!1;const c=t.type==="fill-extrusion"&&(t.sourceLayer==="building"||t.sourceLayer==="procedural_buildings"),p=t.type==="building";if(t.is3D(!!this.terrain)){if(c||p||r&&r.type==="batched-model"||t.type==="model")return!0}else if(t.type==="symbol")return!0;return!1}_clearWorkerCaches(){this.dispatcher.broadcast("clearCaches")}destroy(){this._clearWorkerCaches(),this.fragments.forEach((t=>{t.style._remove()})),this.terrainSetForDrapingOnly()&&(delete this.terrain,delete this.stylesheet.terrain)}}yo.getSourceType=function(l){return tu[l]},yo.setSourceType=function(l,t){tu[l]=t},yo.registerForPluginStateChange=s.du;var Lh=`
#define EPSILON 0.0000001
#define PI 3.141592653589793
#ifdef RENDER_CUTOFF
float cutoff_opacity(vec4 cutoff_params,float depth) {float near=cutoff_params.x;float far=cutoff_params.y;float cutoffStart=cutoff_params.z;float cutoffEnd=cutoff_params.w;float linearDepth=(depth-near)/(far-near);return clamp((linearDepth-cutoffStart)/(cutoffEnd-cutoffStart),0.0,1.0);}
#endif`,Ul=`
out vec4 glFragColor;highp float unpack_depth(highp vec4 rgba_depth)
{const highp vec4 bit_shift=vec4(1.0/(255.0*255.0*255.0),1.0/(255.0*255.0),1.0/255.0,1.0);return dot(rgba_depth,bit_shift)*2.0-1.0;}highp vec4 pack_depth(highp float ndc_z) {highp float depth=ndc_z*0.5+0.5;const highp vec4 bit_shift=vec4(255.0*255.0*255.0,255.0*255.0,255.0,1.0);const highp vec4 bit_mask =vec4(0.0,1.0/255.0,1.0/255.0,1.0/255.0);highp vec4 res=fract(depth*bit_shift);res-=res.xxyz*bit_mask;return res;}
#ifdef INDICATOR_CUTOUT
uniform vec3 u_indicator_cutout_centers;uniform vec4 u_indicator_cutout_params;
#endif
vec4 applyCutout(vec4 color,float height) {
#ifdef INDICATOR_CUTOUT
float verticalFadeRange=u_indicator_cutout_centers.z*0.25;float holeMinOpacity=mix(1.0,u_indicator_cutout_params.x,smoothstep(u_indicator_cutout_centers.z,u_indicator_cutout_centers.z+verticalFadeRange,height));float holeRadius=max(u_indicator_cutout_params.y,0.0);float holeAspectRatio=u_indicator_cutout_params.z;float fadeStart=u_indicator_cutout_params.w;float distA=distance(vec2(gl_FragCoord.x,gl_FragCoord.y*holeAspectRatio),vec2(u_indicator_cutout_centers[0],u_indicator_cutout_centers[1]*holeAspectRatio));return color*min(smoothstep(fadeStart,holeRadius,distA)+holeMinOpacity,1.0);
#else
return color;
#endif
}
#ifdef DEBUG_WIREFRAME
#define HANDLE_WIREFRAME_DEBUG \\
glFragColor=vec4(0.7,0.0,0.0,0.7); \\
gl_FragDepth=gl_FragCoord.z-0.0001;
#else
#define HANDLE_WIREFRAME_DEBUG
#endif
#ifdef RENDER_CUTOFF
uniform highp vec4 u_cutoff_params;in float v_cutoff_opacity;
#endif
vec4 textureLodCustom(sampler2D image,highp vec2 pos,highp vec2 lod_coord) {highp vec2 size=vec2(textureSize(image,0));highp vec2 dx=dFdx(lod_coord.xy*size);highp vec2 dy=dFdy(lod_coord.xy*size);highp float delta_max_sqr=max(dot(dx,dx),dot(dy,dy));highp float lod=0.5*log2(delta_max_sqr);return textureLod(image,pos,lod);}vec4 applyLUT(highp sampler3D lut,vec4 col) {vec3 size=vec3(textureSize(lut,0));vec3 uvw=(col.rbg*float(size-1.0)+0.5)/size;return vec4(texture(lut,uvw).rgb,col.a);}vec3 applyLUT(highp sampler3D lut,vec3 col) {return applyLUT(lut,vec4(col,1.0)).rgb;}`,Lc=`
#define EXTENT 8192.0
#define RAD_TO_DEG 180.0/PI
#define DEG_TO_RAD PI/180.0
#define GLOBE_RADIUS EXTENT/PI/2.0
float wrap(float n,float min,float max) {float d=max-min;float w=mod(mod(n-min,d)+d,d)+min;return (w==min) ? max : w;}
#ifdef PROJECTION_GLOBE_VIEW
vec3 mercator_tile_position(mat4 matrix,vec2 tile_anchor,vec3 tile_id,vec2 mercator_center) {
#ifndef PROJECTED_POS_ON_VIEWPORT
float tiles=tile_id.z;vec2 mercator=(tile_anchor/EXTENT+tile_id.xy)/tiles;mercator-=mercator_center;mercator.x=wrap(mercator.x,-0.5,0.5);vec4 mercator_tile=vec4(mercator.xy*EXTENT,EXTENT/(2.0*PI),1.0);mercator_tile=matrix*mercator_tile;return mercator_tile.xyz;
#else
return vec3(0.0);
#endif
}vec3 mix_globe_mercator(vec3 globe,vec3 mercator,float t) {return mix(globe,mercator,t);}mat3 globe_mercator_surface_vectors(vec3 pos_normal,vec3 up_dir,float zoom_transition) {vec3 normal=zoom_transition==0.0 ? pos_normal : normalize(mix(pos_normal,up_dir,zoom_transition));vec3 xAxis=normalize(vec3(normal.z,0.0,-normal.x));vec3 yAxis=normalize(cross(normal,xAxis));return mat3(xAxis,yAxis,normal);}
#endif
vec2 unpack_float(const float packedValue) {int packedIntValue=int(packedValue);int v0=packedIntValue/256;return vec2(v0,packedIntValue-v0*256);}vec2 unpack_opacity(const float packedOpacity) {int intOpacity=int(packedOpacity)/2;return vec2(float(intOpacity)/127.0,mod(packedOpacity,2.0));}vec4 decode_color(const vec2 encodedColor) {return vec4(
unpack_float(encodedColor[0])/255.0,unpack_float(encodedColor[1])/255.0
);}float unpack_mix_vec2(const vec2 packedValue,const float t) {return mix(packedValue[0],packedValue[1],t);}vec4 unpack_mix_color(const vec4 packedColors,const float t) {vec4 minColor=decode_color(vec2(packedColors[0],packedColors[1]));vec4 maxColor=decode_color(vec2(packedColors[2],packedColors[3]));return mix(minColor,maxColor,t);}vec2 get_pattern_pos(const vec2 pixel_coord_upper,const vec2 pixel_coord_lower,const vec2 pattern_size,const vec2 units_to_pixels,const vec2 pos) {vec2 offset=mod(mod(mod(pixel_coord_upper,pattern_size)*256.0,pattern_size)*256.0+pixel_coord_lower,pattern_size);return (units_to_pixels*pos+offset)/pattern_size;}vec2 get_pattern_pos(const vec2 pixel_coord_upper,const vec2 pixel_coord_lower,const vec2 pattern_size,const float tile_units_to_pixels,const vec2 pos) {return get_pattern_pos(pixel_coord_upper,pixel_coord_lower,pattern_size,vec2(tile_units_to_pixels),pos);}float mercatorXfromLng(float lng) {return (180.0+lng)/360.0;}float mercatorYfromLat(float lat) {return (180.0-(RAD_TO_DEG*log(tan(PI/4.0+lat/2.0*DEG_TO_RAD))))/360.0;}vec3 latLngToECEF(vec2 latLng) {latLng=DEG_TO_RAD*latLng;float cosLat=cos(latLng[0]);float sinLat=sin(latLng[0]);float cosLng=cos(latLng[1]);float sinLng=sin(latLng[1]);float sx=cosLat*sinLng*GLOBE_RADIUS;float sy=-sinLat*GLOBE_RADIUS;float sz=cosLat*cosLng*GLOBE_RADIUS;return vec3(sx,sy,sz);}
#ifdef RENDER_CUTOFF
uniform vec4 u_cutoff_params;out float v_cutoff_opacity;
#endif
const vec4 AWAY=vec4(-1000.0,-1000.0,-1000.0,1);const float skirtOffset=24575.0;vec3 decomposeToPosAndSkirt(vec2 posWithComposedSkirt)
{float skirt=float(posWithComposedSkirt.x >=skirtOffset);vec2 pos=posWithComposedSkirt-vec2(skirt*skirtOffset,0.0);return vec3(pos,skirt);}`,Sd="in highp vec3 a_pos_3f;uniform lowp mat4 u_matrix;out highp vec3 v_uv;void main() {const mat3 half_neg_pi_around_x=mat3(1.0,0.0, 0.0,0.0,0.0,-1.0,0.0,1.0, 0.0);v_uv=half_neg_pi_around_x*a_pos_3f;vec4 pos=u_matrix*vec4(a_pos_3f,1.0);gl_Position=pos.xyww;}",hu=`
#define ELEVATION_SCALE 7.0
#define ELEVATION_OFFSET 450.0
#ifdef PROJECTION_GLOBE_VIEW
uniform vec3 u_tile_tl_up;uniform vec3 u_tile_tr_up;uniform vec3 u_tile_br_up;uniform vec3 u_tile_bl_up;uniform float u_tile_up_scale;vec3 elevationVector(vec2 pos) {vec2 uv=pos/EXTENT;vec3 up=normalize(mix(
mix(u_tile_tl_up,u_tile_tr_up,uv.xxx),mix(u_tile_bl_up,u_tile_br_up,uv.xxx),uv.yyy));return up*u_tile_up_scale;}
#else
vec3 elevationVector(vec2 pos) { return vec3(0,0,1); }
#endif
#ifdef TERRAIN
uniform highp sampler2D u_dem;uniform highp sampler2D u_dem_prev;uniform vec2 u_dem_tl;uniform vec2 u_dem_tl_prev;uniform float u_dem_scale;uniform float u_dem_scale_prev;uniform float u_dem_size;uniform float u_dem_lerp;uniform float u_exaggeration;uniform float u_meter_to_dem;uniform mat4 u_label_plane_matrix_inv;vec4 tileUvToDemSample(vec2 uv,float dem_size,float dem_scale,vec2 dem_tl) {vec2 pos=dem_size*(uv*dem_scale+dem_tl)+1.0;vec2 f=fract(pos);return vec4((pos-f+0.5)/(dem_size+2.0),f);}float currentElevation(vec2 apos) {
#ifdef TERRAIN_DEM_FLOAT_FORMAT
vec2 pos=(u_dem_size*(apos/8192.0*u_dem_scale+u_dem_tl)+1.5)/(u_dem_size+2.0);return u_exaggeration*texture(u_dem,pos).r;
#else
float dd=1.0/(u_dem_size+2.0);vec4 r=tileUvToDemSample(apos/8192.0,u_dem_size,u_dem_scale,u_dem_tl);vec2 pos=r.xy;vec2 f=r.zw;float tl=texture(u_dem,pos).r;float tr=texture(u_dem,pos+vec2(dd,0)).r;float bl=texture(u_dem,pos+vec2(0,dd)).r;float br=texture(u_dem,pos+vec2(dd,dd)).r;return u_exaggeration*mix(mix(tl,tr,f.x),mix(bl,br,f.x),f.y);
#endif
}float prevElevation(vec2 apos) {
#ifdef TERRAIN_DEM_FLOAT_FORMAT
vec2 pos=(u_dem_size*(apos/8192.0*u_dem_scale_prev+u_dem_tl_prev)+1.5)/(u_dem_size+2.0);return u_exaggeration*texture(u_dem_prev,pos).r;
#else
float dd=1.0/(u_dem_size+2.0);vec4 r=tileUvToDemSample(apos/8192.0,u_dem_size,u_dem_scale_prev,u_dem_tl_prev);vec2 pos=r.xy;vec2 f=r.zw;float tl=texture(u_dem_prev,pos).r;float tr=texture(u_dem_prev,pos+vec2(dd,0)).r;float bl=texture(u_dem_prev,pos+vec2(0,dd)).r;float br=texture(u_dem_prev,pos+vec2(dd,dd)).r;return u_exaggeration*mix(mix(tl,tr,f.x),mix(bl,br,f.x),f.y);
#endif
}
#ifdef TERRAIN_VERTEX_MORPHING
float elevation(vec2 apos) {
#ifdef ZERO_EXAGGERATION
return 0.0;
#endif
float nextElevation=currentElevation(apos);float prevElevation=prevElevation(apos);return mix(prevElevation,nextElevation,u_dem_lerp);}
#else
float elevation(vec2 apos) {
#ifdef ZERO_EXAGGERATION
return 0.0;
#endif
return currentElevation(apos);}
#endif
vec4 fourSample(vec2 pos,vec2 off) {float tl=texture(u_dem,pos).r;float tr=texture(u_dem,pos+vec2(off.x,0.0)).r;float bl=texture(u_dem,pos+vec2(0.0,off.y)).r;float br=texture(u_dem,pos+off).r;return vec4(tl,tr,bl,br);}float flatElevation(vec2 pack) {vec2 apos=floor(pack/8.0);vec2 span=10.0*(pack-apos*8.0);vec2 uvTex=(apos-vec2(1.0,1.0))/8190.0;float size=u_dem_size+2.0;float dd=1.0/size;vec2 pos=u_dem_size*(uvTex*u_dem_scale+u_dem_tl)+1.0;vec2 f=fract(pos);pos=(pos-f+0.5)*dd;vec4 h=fourSample(pos,vec2(dd));float z=mix(mix(h.x,h.y,f.x),mix(h.z,h.w,f.x),f.y);vec2 w=floor(0.5*(span*u_meter_to_dem-1.0));vec2 d=dd*w;h=fourSample(pos-d,2.0*d+vec2(dd));vec4 diff=abs(h.xzxy-h.ywzw);vec2 slope=min(vec2(0.25),u_meter_to_dem*0.5*(diff.xz+diff.yw)/(2.0*w+vec2(1.0)));vec2 fix=slope*span;float base=z+max(fix.x,fix.y);return u_exaggeration*base;}float elevationFromUint16(float word) {return u_exaggeration*(word/ELEVATION_SCALE-ELEVATION_OFFSET);}
#else
float elevation(vec2 pos) { return 0.0; }
#endif
#ifdef DEPTH_OCCLUSION
uniform highp sampler2D u_depth;uniform highp vec2 u_depth_size_inv;uniform highp vec2 u_depth_range_unpack;uniform highp float u_occluder_half_size;uniform highp float u_occlusion_depth_offset;
#ifdef DEPTH_D24
float unpack_depth(float depth) {return depth*u_depth_range_unpack.x+u_depth_range_unpack.y;}vec4 unpack_depth4(vec4 depth) {return depth*u_depth_range_unpack.x+vec4(u_depth_range_unpack.y);}
#else
highp float unpack_depth_rgba(vec4 rgba_depth)
{const highp vec4 bit_shift=vec4(1.0/(255.0*255.0*255.0),1.0/(255.0*255.0),1.0/255.0,1.0);return dot(rgba_depth,bit_shift)*2.0-1.0;}
#endif
bool isOccluded(vec4 frag) {vec3 coord=frag.xyz/frag.w;
#ifdef DEPTH_D24
float depth=unpack_depth(texture(u_depth,(coord.xy+1.0)*0.5).r);
#else
float depth=unpack_depth_rgba(texture(u_depth,(coord.xy+1.0)*0.5));
#endif
return coord.z+u_occlusion_depth_offset > depth;}highp vec4 getCornerDepths(vec2 coord) {highp vec3 df=vec3(u_occluder_half_size*u_depth_size_inv,0.0);highp vec2 uv=0.5*coord.xy+0.5;
#ifdef DEPTH_D24
highp vec4 depth=vec4(
texture(u_depth,uv-df.xz).r,texture(u_depth,uv+df.xz).r,texture(u_depth,uv-df.zy).r,texture(u_depth,uv+df.zy).r
);depth=unpack_depth4(depth);
#else
highp vec4 depth=vec4(
unpack_depth_rgba(texture(u_depth,uv-df.xz)),unpack_depth_rgba(texture(u_depth,uv+df.xz)),unpack_depth_rgba(texture(u_depth,uv-df.zy)),unpack_depth_rgba(texture(u_depth,uv+df.zy))
);
#endif
return depth;}highp float occlusionFadeMultiSample(vec4 frag) {highp vec3 coord=frag.xyz/frag.w;highp vec2 uv=0.5*coord.xy+0.5;int NX=3;int NY=4;highp vec2 df=u_occluder_half_size*u_depth_size_inv;highp vec2 oneStep=2.0*u_occluder_half_size*u_depth_size_inv/vec2(NX-1,NY-1);highp float res=0.0;for (int y=0; y < NY;++y) {for (int x=0; x < NX;++x) {
#ifdef DEPTH_D24
highp float depth=unpack_depth(texture(u_depth,uv-df+vec2(float(x)*oneStep.x,float(y)*oneStep.y)).r);
#else
highp float depth=unpack_depth_rgba(texture(u_depth,uv-df+vec2(float(x)*oneStep.x,float(y)*oneStep.y)));
#endif
res+=1.0-clamp(300.0*(coord.z+u_occlusion_depth_offset-depth),0.0,1.0);}}res=clamp(2.0*res/float(NX*NY)-0.5,0.0,1.0);return res;}highp float occlusionFade(vec4 frag) {highp vec3 coord=frag.xyz/frag.w;highp vec4 depth=getCornerDepths(coord.xy);return dot(vec4(0.25),vec4(1.0)-clamp(300.0*(vec4(coord.z+u_occlusion_depth_offset)-depth),0.0,1.0));}
#else
bool isOccluded(vec4 frag) { return false; }highp float occlusionFade(vec4 frag) { return 1.0; }highp float occlusionFadeMultiSample(vec4 frag) { return 1.0; }
#endif//DEPTH_OCCLUSION`,uo=`#ifdef FOG
uniform mediump vec4 u_fog_color;uniform mediump vec2 u_fog_range;uniform mediump float u_fog_horizon_blend;uniform mediump mat4 u_fog_matrix;out vec3 v_fog_pos;float fog_range(float depth) {return (depth-u_fog_range[0])/(u_fog_range[1]-u_fog_range[0]);}float fog_horizon_blending(vec3 camera_dir) {float t=max(0.0,camera_dir.z/u_fog_horizon_blend);return u_fog_color.a*exp(-3.0*t*t);}float fog_opacity(float t) {const float decay=6.0;float falloff=1.0-min(1.0,exp(-decay*t));falloff*=falloff*falloff;return u_fog_color.a*min(1.0,1.00747*falloff);}vec3 fog_position(vec3 pos) {return (u_fog_matrix*vec4(pos,1.0)).xyz;}vec3 fog_position(vec2 pos) {return fog_position(vec3(pos,0.0));}float fog(vec3 pos) {float depth=length(pos);float opacity=fog_opacity(fog_range(depth));return opacity*fog_horizon_blending(pos/depth);}
#endif`,$u=`#ifdef FOG
uniform mediump vec4 u_fog_color;uniform mediump vec2 u_fog_range;uniform mediump float u_fog_horizon_blend;uniform mediump vec2 u_fog_vertical_limit;uniform mediump float u_fog_temporal_offset;in vec3 v_fog_pos;uniform highp vec3 u_frustum_tl;uniform highp vec3 u_frustum_tr;uniform highp vec3 u_frustum_br;uniform highp vec3 u_frustum_bl;uniform highp vec3 u_globe_pos;uniform highp float u_globe_radius;uniform highp vec2 u_viewport;uniform float u_globe_transition;uniform int u_is_globe;float fog_range(float depth) {return (depth-u_fog_range[0])/(u_fog_range[1]-u_fog_range[0]);}float fog_horizon_blending(vec3 camera_dir) {float t=max(0.0,camera_dir.z/u_fog_horizon_blend);return u_fog_color.a*exp(-3.0*t*t);}float fog_opacity(float t) {const float decay=6.0;float falloff=1.0-min(1.0,exp(-decay*t));falloff*=falloff*falloff;return u_fog_color.a*min(1.0,1.00747*falloff);}float globe_glow_progress() {highp vec2 uv=gl_FragCoord.xy/u_viewport;
#ifdef FLIP_Y
uv.y=1.0-uv.y;
#endif
highp vec3 ray_dir=mix(
mix(u_frustum_tl,u_frustum_tr,uv.x),mix(u_frustum_bl,u_frustum_br,uv.x),1.0-uv.y);highp vec3 dir=normalize(ray_dir);highp vec3 closest_point=dot(u_globe_pos,dir)*dir;highp float sdf=length(closest_point-u_globe_pos)/u_globe_radius;return sdf+PI*0.5;}float fog_opacity(vec3 pos) {float depth=length(pos);return fog_opacity(fog_range(depth));}vec3 fog_apply(vec3 color,vec3 pos,float opacity_limit) {float depth=length(pos);float opacity;if (u_is_globe==1) {float glow_progress=globe_glow_progress();float t=mix(glow_progress,depth,u_globe_transition);opacity=fog_opacity(fog_range(t));} else {opacity=fog_opacity(fog_range(depth));opacity*=fog_horizon_blending(pos/depth);}return mix(color,u_fog_color.rgb,min(opacity,opacity_limit));}vec3 fog_apply(vec3 color,vec3 pos) {return fog_apply(color,pos,1.0);}vec4 fog_apply_from_vert(vec4 color,float fog_opac) {float alpha=EPSILON+color.a;color.rgb=mix(color.rgb/alpha,u_fog_color.rgb,fog_opac)*alpha;return color;}vec3 fog_apply_sky_gradient(vec3 camera_ray,vec3 sky_color) {float horizon_blend=fog_horizon_blending(normalize(camera_ray));return mix(sky_color,u_fog_color.rgb,horizon_blend);}vec4 fog_apply_premultiplied(vec4 color,vec3 pos) {float alpha=EPSILON+color.a;color.rgb=fog_apply(color.rgb/alpha,pos)*alpha;return color;}vec4 fog_apply_premultiplied(vec4 color,vec3 pos,float heightMeters) {float verticalProgress=(u_fog_vertical_limit.x > 0.0 || u_fog_vertical_limit.y > 0.0) ? smoothstep(u_fog_vertical_limit.x,u_fog_vertical_limit.y,heightMeters) : 0.0;float opacityLimit=1.0-smoothstep(0.9,1.0,fog_opacity(pos));return mix(fog_apply_premultiplied(color,pos),color,min(verticalProgress,opacityLimit));}vec3 fog_dither(vec3 color) {return color;}vec4 fog_dither(vec4 color) {return vec4(fog_dither(color.rgb),color.a);}
#endif`,zt=`#ifdef RASTER_ARRAY
uniform highp sampler2D u_image0;uniform sampler2D u_image1;const vec4 NODATA=vec4(1);ivec4 _raTexLinearCoord(highp vec2 texCoord,highp vec2 texResolution,out highp vec2 fxy) {texCoord=texCoord*texResolution-0.5;fxy=fract(texCoord);texCoord-=fxy;return ivec4(texCoord.xxyy+vec2(1.5,0.5).xyxy);}vec2 _raTexLinearMix(highp vec2 fxy,highp vec4 colorMix,highp float colorOffset,highp vec4 t00,highp vec4 t10,highp vec4 t01,highp vec4 t11) {vec2 c00=t00==NODATA ? vec2(0) : vec2(colorOffset+dot(t00,colorMix),1);vec2 c10=t10==NODATA ? vec2(0) : vec2(colorOffset+dot(t10,colorMix),1);vec2 c01=t01==NODATA ? vec2(0) : vec2(colorOffset+dot(t01,colorMix),1);vec2 c11=t11==NODATA ? vec2(0) : vec2(colorOffset+dot(t11,colorMix),1);return mix(mix(c01,c11,fxy.x),mix(c00,c10,fxy.x),fxy.y);}vec2 raTexture2D_image0_linear(highp vec2 texCoord,highp vec2 texResolution,highp vec4 colorMix,highp float colorOffset) {vec2 fxy;ivec4 c=_raTexLinearCoord(texCoord,texResolution,fxy);return _raTexLinearMix(fxy,colorMix,colorOffset,texelFetch(u_image0,c.yz,0),texelFetch(u_image0,c.xz,0),texelFetch(u_image0,c.yw,0),texelFetch(u_image0,c.xw,0)
);}vec2 raTexture2D_image1_linear(highp vec2 texCoord,highp vec2 texResolution,highp vec4 colorMix,highp float colorOffset) {vec2 fxy;ivec4 c=_raTexLinearCoord(texCoord,texResolution,fxy);return _raTexLinearMix(fxy,colorMix,colorOffset,texelFetch(u_image1,c.yz,0),texelFetch(u_image1,c.xz,0),texelFetch(u_image1,c.yw,0),texelFetch(u_image1,c.xw,0)
);}vec2 raTexture2D_image0_nearest(highp vec2 texCoord,highp vec2 texResolution,highp vec4 colorMix,highp float colorOffset) {vec4 t=texelFetch(u_image0,ivec2(texCoord*texResolution),0);return t==NODATA ? vec2(0) : vec2(colorOffset+dot(t,colorMix),1);}vec2 raTexture2D_image1_nearest(highp vec2 texCoord,highp vec2 texResolution,highp vec4 colorMix,highp float colorOffset) {vec4 t=texelFetch(u_image1,ivec2(texCoord*texResolution),0);return t==NODATA ? vec2(0) : vec2(colorOffset+dot(t,colorMix),1);}
#endif`,Wu=`#ifdef RASTER_ARRAY
uniform sampler2D u_velocity;uniform mediump vec2 u_velocity_res;uniform mediump float u_max_speed;const vec4 NO_DATA=vec4(1);const vec2 INVALID_VELOCITY=vec2(-1);uniform highp vec2 u_uv_offset;uniform highp float u_data_offset;uniform highp vec2 u_data_scale;ivec4 rasterArrayLinearCoord(highp vec2 texCoord,highp vec2 texResolution,out highp vec2 fxy) {texCoord=texCoord*texResolution-0.5;fxy=fract(texCoord);texCoord-=fxy;return ivec4(texCoord.xxyy+vec2(1.5,0.5).xyxy);}highp vec2 lookup_velocity(highp vec2 uv) {uv=u_uv_offset.x+u_uv_offset.y*uv;highp vec2 fxy;ivec4 c=rasterArrayLinearCoord(uv,u_velocity_res,fxy);highp vec4 tl=texelFetch(u_velocity,c.yz,0);highp vec4 tr=texelFetch(u_velocity,c.xz,0);highp vec4 bl=texelFetch(u_velocity,c.yw,0);highp vec4 br=texelFetch(u_velocity,c.xw,0);if (tl==NO_DATA) {return INVALID_VELOCITY;}if (tr==NO_DATA) {return INVALID_VELOCITY;}if (bl==NO_DATA) {return INVALID_VELOCITY;}if (br==NO_DATA) {return INVALID_VELOCITY;}highp vec4 t=mix(mix(bl,br,fxy.x),mix(tl,tr,fxy.x),fxy.y);highp vec2 velocity=u_data_offset+vec2(dot(t.rg,u_data_scale),dot(t.ba,u_data_scale));velocity.y=-velocity.y;velocity/=max(u_max_speed,length(velocity));return velocity;}
#endif
uniform highp float u_particle_pos_scale;uniform highp vec2 u_particle_pos_offset;highp vec4 pack_pos_to_rgba(highp vec2 p) {highp vec2 v=(p+u_particle_pos_offset)/u_particle_pos_scale;highp vec4 r=vec4(v.x,fract(v.x*255.0),v.y,fract(v.y*255.0));return vec4(r.x-r.y/255.0,r.y,r.z-r.w/255.0,r.w);}highp vec2 unpack_pos_from_rgba(highp vec4 v) {v=floor(v*255.0+0.5)/255.0;highp vec2 p=vec2(v.x+(v.y/255.0),v.z+(v.w/255.0));return u_particle_pos_scale*p-u_particle_pos_offset;}`,kh=`#ifdef RENDER_SHADOWS
uniform mediump vec3 u_shadow_direction;uniform highp vec3 u_shadow_normal_offset;vec3 shadow_normal_offset(vec3 normal) {float tileInMeters=u_shadow_normal_offset[0];vec3 n=vec3(-normal.xy,tileInMeters*normal.z);float dotScale=min(1.0-dot(normal,u_shadow_direction),1.0)*0.5+0.5;return n*dotScale;}vec3 shadow_normal_offset_model(vec3 normal) {vec3 transformed_normal=vec3(-normal.xy,normal.z);float NDotL=dot(normalize(transformed_normal),u_shadow_direction);float dotScale=min(1.0-NDotL,1.0)*0.5+0.5;return normal*dotScale;}float shadow_normal_offset_multiplier0() {return u_shadow_normal_offset[1];}float shadow_normal_offset_multiplier1() {return u_shadow_normal_offset[2];}
#endif//RENDER_SHADOWS`,zh=`#ifdef RENDER_SHADOWS
precision highp sampler2DShadow;uniform sampler2DShadow u_shadowmap_0;uniform sampler2DShadow u_shadowmap_1;uniform float u_shadow_intensity;uniform float u_shadow_map_resolution;uniform float u_shadow_texel_size;uniform highp vec3 u_shadow_normal_offset;uniform vec2 u_fade_range;uniform mediump vec3 u_shadow_direction;uniform highp vec3 u_shadow_bias;float shadow_sample(sampler2DShadow shadowmap,highp vec3 pos,highp float bias) {
#ifdef CLIP_ZERO_TO_ONE
highp vec3 coord=vec3(pos.xy*0.5+0.5,pos.z-bias);
#else
highp vec3 coord=vec3(pos.xy*0.5+0.5,pos.z*0.5+0.5-bias);
#endif
return texture(shadowmap,coord);}float shadow_occlusion(highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth,highp float bias) {light_view_pos0.xyz/=light_view_pos0.w;
#ifdef SHADOWS_SINGLE_CASCADE
vec2 abs_bounds=abs(light_view_pos0.xy);if (abs_bounds.x >=1.0 || abs_bounds.y >=1.0) {return 0.0;}return shadow_sample(u_shadowmap_0,light_view_pos0.xyz,bias);
#else
light_view_pos1.xyz/=light_view_pos1.w;vec4 abs_bounds=abs(vec4(light_view_pos0.xy,light_view_pos1.xy));if (abs_bounds.x < 1.0 && abs_bounds.y < 1.0) {return shadow_sample(u_shadowmap_0,light_view_pos0.xyz,bias);}if (abs_bounds.z >=1.0 || abs_bounds.w >=1.0) {return 0.0;}float occlusion1=shadow_sample(u_shadowmap_1,light_view_pos1.xyz,bias);return clamp(mix(occlusion1,0.0,smoothstep(u_fade_range.x,u_fade_range.y,view_depth)),0.0,1.0);
#endif
}highp float calculate_shadow_bias(float NDotL) {
#ifdef NORMAL_OFFSET
return 0.5*u_shadow_bias.x;
#else
return 0.5*(u_shadow_bias.x+clamp(u_shadow_bias.y*tan(acos(NDotL)),0.0,u_shadow_bias.z));
#endif
}float shadowed_light_factor_normal(vec3 N,highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth) {float NDotL=dot(N,u_shadow_direction);float bias=calculate_shadow_bias(NDotL);float occlusion=shadow_occlusion(light_view_pos0,light_view_pos1,view_depth,bias);return mix(0.0,(1.0-(u_shadow_intensity*occlusion))*NDotL,step(0.0,NDotL));}float shadowed_light_factor_normal_opacity(vec3 N,highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth,float shadow_opacity) {float NDotL=dot(N,u_shadow_direction);float bias=calculate_shadow_bias(NDotL);float occlusion=shadow_occlusion(light_view_pos0,light_view_pos1,view_depth,bias)*shadow_opacity;return mix(0.0,(1.0-(u_shadow_intensity*occlusion))*NDotL,step(0.0,NDotL));}float shadowed_light_factor_normal_unbiased(vec3 N,highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth) {float NDotL=dot(N,u_shadow_direction);float bias=0.0;float occlusion=shadow_occlusion(light_view_pos0,light_view_pos1,view_depth,bias);return mix(0.0,(1.0-(u_shadow_intensity*occlusion))*NDotL,step(0.0,NDotL));}highp vec2 compute_receiver_plane_depth_bias(highp vec3 pos_dx,highp vec3 pos_dy)
{highp vec2 biasUV=vec2(
pos_dy.y*pos_dx.z-pos_dx.y*pos_dy.z,pos_dx.x*pos_dy.z-pos_dy.x*pos_dx.z);biasUV*=1.0/((pos_dx.x*pos_dy.y)-(pos_dx.y*pos_dy.x));return biasUV;}float shadowed_light_factor_plane_bias(highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth) {highp vec3 light_view_pos0_xyz=light_view_pos0.xyz/light_view_pos0.w*0.5+0.5;highp vec3 light_view_pos0_ddx=dFdx(light_view_pos0_xyz);highp vec3 light_view_pos0_ddy=dFdy(light_view_pos0_xyz);highp vec2 plane_depth_bias=compute_receiver_plane_depth_bias(light_view_pos0_ddx,light_view_pos0_ddy);highp float bias=dot(vec2(u_shadow_texel_size,u_shadow_texel_size),plane_depth_bias)+0.0001;float occlusion=shadow_occlusion(light_view_pos0,light_view_pos1,view_depth,bias);return 1.0-(u_shadow_intensity*occlusion);}float shadowed_light_factor(highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth) {float bias=0.0;float occlusion=shadow_occlusion(light_view_pos0,light_view_pos1,view_depth,bias);return 1.0-(u_shadow_intensity*occlusion);}float shadow_occlusion(float ndotl,highp vec4 light_view_pos0,highp vec4 light_view_pos1,float view_depth) {float bias=calculate_shadow_bias(ndotl);return shadow_occlusion(light_view_pos0,light_view_pos1,view_depth,bias);}
#endif`;const Zu=[];Sa(Lh,Zu),Sa(Lc,Zu),Sa(Ul,Zu);const kc={"_prelude_fog.vertex.glsl":uo,"_prelude_terrain.vertex.glsl":hu,"_prelude_shadow.vertex.glsl":kh,"_prelude_fog.fragment.glsl":$u,"_prelude_shadow.fragment.glsl":zh,"_prelude_lighting.glsl":`
#ifdef LIGHTING_3D_MODE
uniform mediump vec3 u_lighting_ambient_color;uniform mediump vec3 u_lighting_directional_dir;uniform mediump vec3 u_lighting_directional_color;uniform mediump vec3 u_ground_radiance;float calculate_ambient_directional_factor(vec3 normal) {float NdotL=dot(normal,u_lighting_directional_dir);const float factor_reduction_max=0.3;float dir_luminance=dot(u_lighting_directional_color,vec3(0.2126,0.7152,0.0722));float directional_factor_min=1.0-factor_reduction_max*min(dir_luminance,1.0);float ambient_directional_factor=mix(directional_factor_min,1.0,min((NdotL+1.0),1.0));const float vertical_factor_min=0.92;float vertical_factor=mix(vertical_factor_min,1.0,normal.z*0.5+0.5);return vertical_factor*ambient_directional_factor;}vec3 linearProduct(vec3 srgbIn,vec3 k) {return srgbIn*pow(k,vec3(1./2.2));}vec3 apply_lighting(vec3 color,vec3 normal,float dir_factor) {float ambient_directional_factor=calculate_ambient_directional_factor(normal);vec3 ambient_contrib=ambient_directional_factor*u_lighting_ambient_color;vec3 directional_contrib=u_lighting_directional_color*dir_factor;return linearProduct(color,ambient_contrib+directional_contrib);}vec4 apply_lighting(vec4 color,vec3 normal,float dir_factor) {return vec4(apply_lighting(color.rgb,normal,dir_factor),color.a);}vec3 apply_lighting(vec3 color,vec3 normal) {float dir_factor=max(dot(normal,u_lighting_directional_dir),0.0);return apply_lighting(color.rgb,normal,dir_factor);}vec4 apply_lighting(vec4 color,vec3 normal) {float dir_factor=max(dot(normal,u_lighting_directional_dir),0.0);return vec4(apply_lighting(color.rgb,normal,dir_factor),color.a);}vec3 apply_lighting_ground(vec3 color) {return color*u_ground_radiance;}vec4 apply_lighting_ground(vec4 color) {return vec4(apply_lighting_ground(color.rgb),color.a);}float calculate_NdotL(vec3 normal) {const float ext=0.70710678118;return (clamp(dot(normal,u_lighting_directional_dir),-ext,1.0)+ext)/(1.0+ext);}vec4 apply_lighting_with_emission_ground(vec4 color,float emissive_strength) {return mix(apply_lighting_ground(color),color,emissive_strength);}vec3 compute_flood_lighting(vec3 flood_light_color,float fully_occluded_factor,float occlusion,vec3 ground_shadow_factor) {vec3 fully_occluded_color=flood_light_color*mix(ground_shadow_factor,vec3(1.0),fully_occluded_factor);float occlusion_ramp=smoothstep(0.0,0.2,1.0-occlusion);return mix(fully_occluded_color,flood_light_color,occlusion_ramp);}vec3 compute_emissive_draped(vec3 unlit_color,float fully_occluded_factor,float occlusion,vec3 ground_shadow_factor) {vec3 fully_occluded_color=unlit_color*mix(ground_shadow_factor,vec3(1.0),fully_occluded_factor);return mix(fully_occluded_color,unlit_color,1.0-occlusion);}
#endif//LIGHTING_3D_MODE`,"_prelude_raster_array.glsl":zt,"_prelude_raster_particle.glsl":Wu},Ea={};fn("",hu),fn($u,uo),fn(zh,kh),fn(zt,""),fn(Wu,"");const Fh=fn(Ul,Lc),qo=Lh;var du={background:fn(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
uniform vec4 u_color;uniform float u_opacity;
#ifdef LIGHTING_3D_MODE
in vec4 v_color;
#endif
void main() {vec4 out_color;
#ifdef LIGHTING_3D_MODE
out_color=v_color;
#else
out_color=u_color;
#endif
#ifdef FOG
out_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));
#endif
glFragColor=out_color*u_opacity;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_lighting.glsl"
in vec2 a_pos;uniform mat4 u_matrix;
#ifdef LIGHTING_3D_MODE
uniform mediump vec4 u_color;out vec4 v_color;uniform float u_emissive_strength;
#endif
void main() {gl_Position=u_matrix*vec4(a_pos,0,1);
#ifdef LIGHTING_3D_MODE
v_color=apply_lighting_with_emission_ground(u_color,u_emissive_strength);
#endif
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
}`),backgroundPattern:fn(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
uniform vec2 u_pattern_tl;uniform vec2 u_pattern_br;uniform vec2 u_texsize;uniform float u_opacity;uniform float u_emissive_strength;uniform sampler2D u_image;in highp vec2 v_pos;void main() {highp vec2 imagecoord=mod(v_pos,1.0);highp vec2 pos=mix(u_pattern_tl/u_texsize,u_pattern_br/u_texsize,imagecoord);vec4 out_color=textureLodCustom(u_image,pos,v_pos);
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);
#endif
#ifdef FOG
out_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));
#endif
glFragColor=out_color*u_opacity;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
uniform mat4 u_matrix;uniform vec2 u_pattern_size;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform vec2 u_pattern_units_to_pixels;in vec2 a_pos;out highp vec2 v_pos;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);v_pos=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,u_pattern_size,u_pattern_units_to_pixels,a_pos);
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
}`),building:fn(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_shadow.fragment.glsl"
#include "_prelude_lighting.glsl"
const float window_depth=0.5;const float ao_radius=0.2;in vec4 v_color;in highp vec3 v_normal;in highp vec3 v_pos;
#ifdef BUILDING_FAUX_FACADE
in lowp float v_faux_facade;in highp float v_faux_facade_ed;in highp vec2 v_faux_facade_window;in highp vec2 v_faux_facade_floor;in highp vec2 v_faux_facade_range;in highp float v_aspect;in highp vec3 v_tbn_0;in highp vec3 v_tbn_1;in highp vec3 v_tbn_2;in highp vec4 v_faux_color_emissive;uniform float u_faux_facade_ao_intensity;
#endif
#ifdef RENDER_SHADOWS
in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in float v_depth_shadows;
#endif
uniform lowp float u_opacity;uniform vec3 u_camera_pos;uniform highp float u_tile_to_meter;uniform float u_facade_emissive_chance;vec3 linearTosRGB(in vec3 color) {return pow(color,vec3(1./2.2));}
#ifdef BUILDING_FAUX_FACADE
float hash12(in vec2 p) {vec3 p3 =fract(vec3(p.xyx)*0.1031);p3+=dot(p3,p3.yzx+33.33);return fract((p3.x+p3.y)*p3.z);}float min3(in vec3 v) {return min(min(v.x,v.y),v.z);}vec2 get_uv_mask_id(in vec2 q,out float mask,out vec2 id) {vec2 p=q;mask=step(v_faux_facade_range.x,p.y)*step(p.y,v_faux_facade_range.y);p.y=p.y-v_faux_facade_range.x;vec2 uv=modf(p/v_faux_facade_floor,id);vec4 d=(v_faux_facade_floor.xyxy+vec4(-v_faux_facade_window,v_faux_facade_window))*0.5;vec4 edge=d/v_faux_facade_floor.xyxy;vec2 m=step(edge.xy,uv)*step(uv,edge.zw);mask*=m.x*m.y;uv-=vec2(0.5);uv*=vec2(0.5)/(vec2(0.5)-edge.xy);uv+=vec2(0.5);return uv;}float ray_unit_box(in vec3 ray_o,in vec3 ray_d,in vec3 bmin,in vec3 bmax) {vec3 planes=mix(bmin,bmax,step(0.0,ray_d));vec3 t=(planes-ray_o)/ray_d;return min3(t);}float get_emissive(in vec2 id) {if (u_facade_emissive_chance > 0.0) {return (step(hash12(id),u_facade_emissive_chance)+0.05)*v_faux_color_emissive.a;}return 0.0;}vec3 get_shade_info(in vec3 v,in vec3 v_normalized,in vec3 color,in vec2 id,in mat3 tbn,inout vec3 out_normal,inout float out_emissive) {vec3 out_color=color;vec3 abs_v=abs(v_normalized);bool x_major=abs_v.x >=abs_v.y && abs_v.x >=abs_v.z;bool y_major=abs_v.y >=abs_v.x && abs_v.y >=abs_v.z;bool z_major=abs_v.z >=abs_v.x && abs_v.z >=abs_v.y;
#if 0
if (x_major) {out_color=v.x > 0.0 ? vec3(1.0,0.0,0.0) : vec3(0.0,1.0,1.0);} else if (y_major) {out_color=v.y > 0.0 ? vec3(0.0,1.0,0.0) : vec3(1.0,0.0,1.0);} else if (z_major) {out_color=v.z > 0.0 ? vec3(0.0,0.0,1.0) : vec3(1.0,1.0,0.0);}out_emissive=1.0;
#else
if (x_major) {out_normal=sign(v.x)*tbn[0];} else if (y_major) {out_normal=vec3(0.0,0.0,-sign(v.y));} else if (z_major) {out_color=v_faux_color_emissive.rgb;out_emissive=v.z <=0.0 ? get_emissive(id) : out_emissive;}float ao=1.0;if (u_faux_facade_ao_intensity > 0.0) {vec4 ao_range=v_faux_facade_window.xxyy*0.5-vec4(0,ao_radius,0,ao_radius);vec2 ao_range_z=vec2(window_depth*0.5)-vec2(0.0,ao_radius);if (x_major || y_major) {ao*=smoothstep(-ao_range_z.x,-ao_range_z.y,v.z);} else if (z_major) {ao*=smoothstep(-ao_range.x,-ao_range.y,v.x)*(1.0-smoothstep(ao_range.y,ao_range.x,v.x));ao*=smoothstep(-ao_range.z,-ao_range.w,v.y)*(1.0-smoothstep(ao_range.w,ao_range.z,v.y));}ao=mix(1.0,min(1.0,ao+0.25),u_faux_facade_ao_intensity);}out_color*=ao;
#endif
return out_color;}
#endif
vec3 apply_lighting_linear(in vec3 color,in vec3 normal,in float dir_factor) {float ambient_directional_factor=calculate_ambient_directional_factor(normal);vec3 ambient_contrib=ambient_directional_factor*u_lighting_ambient_color;vec3 directional_contrib=u_lighting_directional_color*dir_factor;return color*(ambient_contrib+directional_contrib);}void main() {vec3 normal=normalize(v_normal);vec3 base_color=v_color.rgb;float emissive=v_color.a;
#ifdef BUILDING_FAUX_FACADE
if (v_faux_facade > 0.0) {mat3 tbn=mat3(v_tbn_0,v_tbn_1,v_tbn_2);vec3 v=vec3(v_pos.xy,v_pos.z/u_tile_to_meter)-u_camera_pos;vec3 view_tangent=transpose(tbn)*v;vec2 q=vec2(v_faux_facade_ed,v_pos.z);float mask=0.0;vec2 id=vec2(0.0);vec2 uv=get_uv_mask_id(q,mask,id);uv*=v_faux_facade_window;vec3 bmin=vec3(0.0,0.0,-window_depth);vec3 bmax=bmin+vec3(v_faux_facade_window,window_depth);vec3 ray_o=vec3(uv,0.0);vec3 ray_d=normalize(view_tangent);float t_min=ray_unit_box(ray_o,ray_d,bmin,bmax);vec3 hit=ray_o+t_min*ray_d;vec3 r=vec3(v_faux_facade_window,-window_depth);hit-=r*0.5;vec3 normalized=hit/r;vec3 out_normal=normal;float out_emissive=emissive;vec3 room_color=get_shade_info(hit,normalized,base_color,id,tbn,out_normal,out_emissive);base_color=mix(base_color,room_color,mask);normal=mix(normal,out_normal,mask);emissive=mix(emissive,out_emissive,mask);}
#endif
vec4 color=vec4(base_color,1.0);vec3 xy_flipped_normal=vec3(-normal.xy,normal.z);float shadowed_lighting_factor=0.0;
#ifdef RENDER_SHADOWS
shadowed_lighting_factor=shadowed_light_factor_normal(xy_flipped_normal,v_pos_light_view_0,v_pos_light_view_1,v_depth_shadows);
#else
shadowed_lighting_factor=dot(normal,u_lighting_directional_dir);
#endif
color.rgb=apply_lighting_linear(color.rgb,xy_flipped_normal,shadowed_lighting_factor);color.rgb=mix(color.rgb,base_color.rgb,emissive);
#ifdef FOG
color=fog_dither(fog_apply_premultiplied(color,v_fog_pos,v_pos.z));
#endif
color.rgb=linearTosRGB(color.rgb);color*=u_opacity;
#ifdef INDICATOR_CUTOUT
color=applyCutout(color,v_pos.z);
#endif
glFragColor=color; 
#ifdef DEBUG_SHOW_NORMALS
color.rgb=xy_flipped_normal*0.5+vec3(0.5,0.5,0.5);color.a=1.0;glFragColor=color;
#endif
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_shadow.vertex.glsl"
in vec3 a_pos_3f;in vec3 a_normal_3;in vec3 a_centroid_3;in vec4 a_faux_facade_data;in vec2 a_faux_facade_vertical_range;uniform mat4 u_matrix;uniform mat4 u_normal_matrix;uniform highp float u_tile_to_meter;out vec4 v_color;out vec3 v_normal;out highp vec3 v_pos;
#ifdef BUILDING_FAUX_FACADE
out lowp float v_faux_facade;out highp float v_faux_facade_ed;out highp vec2 v_faux_facade_window;out highp vec2 v_faux_facade_floor;out highp vec2 v_faux_facade_range;out highp float v_aspect;out highp vec3 v_tbn_0;out highp vec3 v_tbn_1;out highp vec3 v_tbn_2;out highp vec4 v_faux_color_emissive;
#endif
#ifdef RENDER_SHADOWS
uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out float v_depth_shadows;
#endif
const float MAX_UINT_16=65535.0;const float MAX_INT_16=32767.0;const float MAX_UINT_8=255.0;const float TWO_POW_8=256.0;vec3 sRGBToLinear(vec3 srgbIn) {return pow(srgbIn,vec3(2.2));}
#ifdef BUILDING_FAUX_FACADE
mat3 get_tbn(in vec3 normal) {const vec3 bitangent=vec3(0.0,0.0,1.0);vec3 tangent=normalize(vec3(normal.y,-normal.x,0.0));return mat3(tangent,bitangent,normal);}
#endif
#pragma mapbox: define-attribute-vertex-shader-only highp vec2 part_color_emissive
#pragma mapbox: define-attribute-vertex-shader-only highp vec2 faux_facade_color_emissive
void main() {
#pragma mapbox: initialize-attribute-custom highp vec2 part_color_emissive
#pragma mapbox: initialize-attribute-custom highp vec2 faux_facade_color_emissive
vec4 color_emissive=decode_color(part_color_emissive);v_color=vec4(sRGBToLinear(color_emissive.rgb),color_emissive.a);vec3 a_normal_3f=a_normal_3/MAX_INT_16;v_normal=vec3(u_normal_matrix*vec4(a_normal_3f,0.0));float hidden=0.0;
#ifdef BUILDING_FAUX_FACADE
v_faux_facade=a_faux_facade_data.x;if (v_faux_facade > 0.0) {v_faux_facade_ed=a_faux_facade_data.x *u_tile_to_meter;float window_x_perc=floor(a_faux_facade_data.y/TWO_POW_8);float window_y_perc=a_faux_facade_data.y-TWO_POW_8*window_x_perc;vec2 window_perc=vec2(window_x_perc,window_y_perc)/MAX_UINT_8;v_faux_facade_floor=(a_faux_facade_data.zw/MAX_UINT_16*EXTENT)*u_tile_to_meter;v_faux_facade_window=window_perc*v_faux_facade_floor;v_faux_facade_range=(a_faux_facade_vertical_range/MAX_UINT_16*EXTENT)*u_tile_to_meter;v_aspect=v_faux_facade_window.x/v_faux_facade_window.y;mat3 tbn=get_tbn(normalize(v_normal));v_tbn_0=tbn[0];v_tbn_1=tbn[1];v_tbn_2=tbn[2];v_faux_color_emissive=decode_color(faux_facade_color_emissive);v_faux_color_emissive.rgb=sRGBToLinear(v_faux_color_emissive.rgb);}
#endif
v_pos=a_pos_3f;
#ifdef RENDER_CUTOFF
vec4 ground=u_matrix*vec4(a_centroid_3,1.0);v_cutoff_opacity=cutoff_opacity(u_cutoff_params,ground.z);hidden=float(v_cutoff_opacity==0.0);v_pos.z*=v_cutoff_opacity;
#endif
#ifdef RENDER_SHADOWS
vec3 shadow_pos=v_pos;
#ifdef NORMAL_OFFSET
vec3 offset=shadow_normal_offset_model(v_normal);shadow_pos+=offset*shadow_normal_offset_multiplier0();
#endif
v_pos_light_view_0=u_light_matrix_0*vec4(shadow_pos,1.0);v_pos_light_view_1=u_light_matrix_1*vec4(shadow_pos,1.0);v_depth_shadows=gl_Position.w;
#endif
#ifdef FOG
v_fog_pos=fog_position(v_pos);
#endif
gl_Position=mix(u_matrix*vec4(v_pos,1),AWAY,hidden);}`),buildingBloom:fn(`in vec4 v_color_emissive;
#pragma mapbox: define-attribute highp vec4 bloom_attenuation
#pragma mapbox: initialize-attribute highp vec4 bloom_attenuation
float saturate(float val) {return clamp(val,0.0,1.0);}void main() {float emission=v_color_emissive.a;float opacity=1.0;
#ifdef HAS_ATTRIBUTE_a_bloom_attenuation
float distance=length(vec2(1.3*max(0.0,abs(bloom_attenuation.x)-bloom_attenuation.z),bloom_attenuation.y));distance+= mix(0.5,0.0,clamp(emission-1.0,0.0,1.0));opacity*=saturate(1.0-distance*distance);
#endif
glFragColor=vec4(v_color_emissive.rgb,1.0)*opacity;}`,`in vec3 a_pos_3f;
#pragma mapbox: define-attribute-vertex-shader-only highp vec2 part_color_emissive
#pragma mapbox: define-attribute highp vec4 bloom_attenuation
out vec4 v_color_emissive;uniform mat4 u_matrix;vec3 sRGBToLinear(vec3 srgbIn) {return pow(srgbIn,vec3(2.2));}void main() {
#pragma mapbox: initialize-attribute-custom highp vec2 part_color_emissive
#pragma mapbox: initialize-attribute highp vec4 bloom_attenuation
#ifdef HAS_ATTRIBUTE_a_part_color_emissive
vec4 color_emissive=decode_color(part_color_emissive);float part_emissive=color_emissive.a*5.0;v_color_emissive=vec4(sRGBToLinear(color_emissive.rgb),part_emissive);
#else
v_color_emissive=vec4(1.0);
#endif
gl_Position=u_matrix*vec4(a_pos_3f,1.0);}`),buildingDepth:fn(`in highp float v_depth;void main() {
#ifndef DEPTH_TEXTURE
glFragColor=pack_depth(v_depth);
#endif
}`,"in vec3 a_pos_3f;uniform mat4 u_matrix;out highp float v_depth;void main() {gl_Position=u_matrix*vec4(a_pos_3f,1.0);v_depth=gl_Position.z/gl_Position.w;}"),circle:fn(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
in vec3 v_data;in float v_visibility;
#pragma mapbox: define highp vec4 color
#pragma mapbox: define mediump float radius
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
#pragma mapbox: define highp vec4 stroke_color
#pragma mapbox: define mediump float stroke_width
#pragma mapbox: define lowp float stroke_opacity
uniform float u_emissive_strength;void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize mediump float radius
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize highp vec4 stroke_color
#pragma mapbox: initialize mediump float stroke_width
#pragma mapbox: initialize lowp float stroke_opacity
vec2 extrude=v_data.xy;float blur_positive=blur < 0.0 ? 0.0 : 1.0;lowp float antialiasblur=v_data.z;float extrude_length=length(extrude)+antialiasblur*(1.0-blur_positive);float antialiased_blur=-max(abs(blur),antialiasblur);float antialiase_blur_opacity=smoothstep(0.0,antialiasblur,extrude_length-1.0);float opacity_t=blur_positive==1.0 ? 
smoothstep(0.0,-antialiased_blur,1.0-extrude_length) : 
smoothstep(antialiased_blur,0.0,extrude_length-1.0)-antialiase_blur_opacity;float color_t=stroke_width < 0.01 ? 0.0 : smoothstep(
antialiased_blur,0.0,extrude_length-radius/(radius+stroke_width)
);vec4 out_color=mix(color*opacity,stroke_color*stroke_opacity,color_t);
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);
#endif
#ifdef FOG
out_color=fog_apply_premultiplied(out_color,v_fog_pos);
#endif
glFragColor=out_color*(v_visibility*opacity_t);
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_terrain.vertex.glsl"
#define NUM_VISIBILITY_RINGS 2
#define INV_SQRT2 0.70710678
#define ELEVATION_BIAS 0.0001
#define NUM_SAMPLES_PER_RING 16
uniform mat4 u_matrix;uniform mat2 u_extrude_scale;uniform lowp float u_device_pixel_ratio;uniform highp float u_camera_to_center_distance;in vec2 a_pos;
#ifdef PROJECTION_GLOBE_VIEW
in vec3 a_pos_3;in vec3 a_pos_normal_3;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_tile_id;uniform float u_zoom_transition;uniform vec3 u_up_dir;
#endif
#ifdef ELEVATED_ROADS
in float a_circle_z_offset;
#endif
out vec3 v_data;out float v_visibility;
#pragma mapbox: define highp vec4 color
#pragma mapbox: define mediump float radius
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
#pragma mapbox: define highp vec4 stroke_color
#pragma mapbox: define mediump float stroke_width
#pragma mapbox: define lowp float stroke_opacity
vec2 calc_offset(vec2 extrusion,float radius,float stroke_width, float view_scale) {return extrusion*(radius+stroke_width)*u_extrude_scale*view_scale;}float cantilevered_elevation(vec2 pos,float radius,float stroke_width,float view_scale) {vec2 c1=pos+calc_offset(vec2(-1,-1),radius,stroke_width,view_scale);vec2 c2=pos+calc_offset(vec2(1,-1),radius,stroke_width,view_scale);vec2 c3=pos+calc_offset(vec2(1,1),radius,stroke_width,view_scale);vec2 c4=pos+calc_offset(vec2(-1,1),radius,stroke_width,view_scale);float h1=elevation(c1)+ELEVATION_BIAS;float h2=elevation(c2)+ELEVATION_BIAS;float h3=elevation(c3)+ELEVATION_BIAS;float h4=elevation(c4)+ELEVATION_BIAS;return max(h4,max(h3,max(h1,h2)));}float circle_elevation(vec2 pos) {
#if defined(TERRAIN)
return elevation(pos)+ELEVATION_BIAS;
#else
return 0.0;
#endif
}vec4 project_vertex(vec2 extrusion,vec4 world_center,vec4 projected_center,float radius,float stroke_width, float view_scale,mat3 surface_vectors) {vec2 sample_offset=calc_offset(extrusion,radius,stroke_width,view_scale);
#ifdef PITCH_WITH_MAP
#ifdef PROJECTION_GLOBE_VIEW
return u_matrix*( world_center+vec4(sample_offset.x*surface_vectors[0]+sample_offset.y*surface_vectors[1],0) );
#else
return u_matrix*( world_center+vec4(sample_offset,0,0) );
#endif
#else
return projected_center+vec4(sample_offset,0,0);
#endif
}float get_sample_step() {
#ifdef PITCH_WITH_MAP
return 2.0*PI/float(NUM_SAMPLES_PER_RING);
#else
return PI/float(NUM_SAMPLES_PER_RING);
#endif
}void main(void) {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize mediump float radius
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize highp vec4 stroke_color
#pragma mapbox: initialize mediump float stroke_width
#pragma mapbox: initialize lowp float stroke_opacity
vec2 extrude=vec2(mod(a_pos,2.0)*2.0-1.0);vec2 circle_center=floor(a_pos*0.5);vec4 world_center;mat3 surface_vectors;
#ifdef PROJECTION_GLOBE_VIEW
vec3 pos_normal_3=a_pos_normal_3/16384.0;surface_vectors=globe_mercator_surface_vectors(pos_normal_3,u_up_dir,u_zoom_transition);vec3 surface_extrusion=extrude.x*surface_vectors[0]+extrude.y*surface_vectors[1];vec3 globe_elevation=elevationVector(circle_center)*circle_elevation(circle_center);vec3 globe_pos=a_pos_3+surface_extrusion+globe_elevation;vec3 mercator_elevation=u_up_dir*u_tile_up_scale*circle_elevation(circle_center);vec3 merc_pos=mercator_tile_position(u_inv_rot_matrix,circle_center,u_tile_id,u_merc_center)+surface_extrusion+mercator_elevation;vec3 pos=mix_globe_mercator(globe_pos,merc_pos,u_zoom_transition);world_center=vec4(pos,1);
#else 
surface_vectors=mat3(1.0);float height=circle_elevation(circle_center);world_center=vec4(circle_center,height,1);
#endif
#ifdef ELEVATED_ROADS
world_center.z+=a_circle_z_offset+ELEVATION_BIAS;
#endif
vec4 projected_center=u_matrix*world_center;float view_scale=0.0;
#ifdef PITCH_WITH_MAP
#ifdef SCALE_WITH_MAP
view_scale=1.0;
#else
view_scale=projected_center.w/u_camera_to_center_distance;
#endif
#else
#ifdef SCALE_WITH_MAP
view_scale=u_camera_to_center_distance;
#else
view_scale=projected_center.w;
#endif
#endif
gl_Position=project_vertex(extrude,world_center,projected_center,radius,stroke_width,view_scale,surface_vectors);float visibility=0.0;
#ifdef TERRAIN
float step=get_sample_step();vec4 occlusion_world_center;vec4 occlusion_projected_center;
#ifdef PITCH_WITH_MAP
float cantilevered_height=cantilevered_elevation(circle_center,radius,stroke_width,view_scale);occlusion_world_center=vec4(circle_center,cantilevered_height,1);occlusion_projected_center=u_matrix*occlusion_world_center;
#else
occlusion_world_center=world_center;occlusion_projected_center=projected_center;
#endif
for(int ring=0; ring < NUM_VISIBILITY_RINGS; ring++) {float scale=(float(ring)+1.0)/float(NUM_VISIBILITY_RINGS);for(int i=0; i < NUM_SAMPLES_PER_RING; i++) {vec2 extrusion=vec2(cos(step*float(i)),-sin(step*float(i)))*scale;vec4 frag_pos=project_vertex(extrusion,occlusion_world_center,occlusion_projected_center,radius,stroke_width,view_scale,surface_vectors);visibility+=float(!isOccluded(frag_pos));}}visibility/=float(NUM_VISIBILITY_RINGS)*float(NUM_SAMPLES_PER_RING);
#else
visibility=1.0;
#endif
#ifdef PROJECTION_GLOBE_VIEW
visibility=1.0;
#endif
v_visibility=visibility;lowp float antialiasblur=1.0/u_device_pixel_ratio/(radius+stroke_width);v_data=vec3(extrude.x,extrude.y,antialiasblur);
#ifdef FOG
v_fog_pos=fog_position(world_center.xyz);
#endif
}`),clippingMask:fn("void main() {glFragColor=vec4(1.0);}","in vec2 a_pos;uniform mat4 u_matrix;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);}"),heatmap:fn(`#include "_prelude_fog.fragment.glsl"
uniform highp float u_intensity;in vec2 v_extrude;
#pragma mapbox: define highp float weight
#define GAUSS_COEF 0.3989422804014327
void main() {
#pragma mapbox: initialize highp float weight
float d=-0.5*3.0*3.0*dot(v_extrude,v_extrude);float val=weight*u_intensity*GAUSS_COEF*exp(d);glFragColor=vec4(val,1.0,1.0,1.0);
#ifdef FOG
if (u_is_globe==0) {glFragColor.r*=pow(1.0-fog_opacity(v_fog_pos),2.0);}
#endif
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_terrain.vertex.glsl"
#include "_prelude_fog.vertex.glsl"
uniform mat4 u_matrix;uniform float u_extrude_scale;uniform float u_opacity;uniform float u_intensity;in vec2 a_pos;
#ifdef PROJECTION_GLOBE_VIEW
in vec3 a_pos_3;in vec3 a_pos_normal_3;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_tile_id;uniform float u_zoom_transition;uniform vec3 u_up_dir;
#endif
out vec2 v_extrude;
#pragma mapbox: define highp float weight
#pragma mapbox: define mediump float radius
const highp float ZERO=1.0/255.0/16.0;
#define GAUSS_COEF 0.3989422804014327
void main(void) {
#pragma mapbox: initialize highp float weight
#pragma mapbox: initialize mediump float radius
vec2 unscaled_extrude=vec2(mod(a_pos,2.0)*2.0-1.0);float S=sqrt(-2.0*log(ZERO/weight/u_intensity/GAUSS_COEF))/3.0;v_extrude=S*unscaled_extrude;vec2 extrude=v_extrude*radius*u_extrude_scale;vec2 tilePos=floor(a_pos*0.5);vec3 pos;
#ifdef PROJECTION_GLOBE_VIEW
vec3 pos_normal_3=a_pos_normal_3/16384.0;mat3 surface_vectors=globe_mercator_surface_vectors(pos_normal_3,u_up_dir,u_zoom_transition);vec3 surface_extrusion=extrude.x*surface_vectors[0]+extrude.y*surface_vectors[1];vec3 globe_elevation=elevationVector(tilePos)*elevation(tilePos);vec3 globe_pos=a_pos_3+surface_extrusion+globe_elevation;vec3 mercator_elevation=u_up_dir*u_tile_up_scale*elevation(tilePos);vec3 merc_pos=mercator_tile_position(u_inv_rot_matrix,tilePos,u_tile_id,u_merc_center)+surface_extrusion+mercator_elevation;pos=mix_globe_mercator(globe_pos,merc_pos,u_zoom_transition);
#else
pos=vec3(tilePos+extrude,elevation(tilePos));
#endif
gl_Position=u_matrix*vec4(pos,1);
#ifdef FOG
v_fog_pos=fog_position(pos);
#endif
}`),heatmapTexture:fn(`uniform sampler2D u_image;uniform sampler2D u_color_ramp;uniform float u_opacity;in vec2 v_pos;void main() {float t=texture(u_image,v_pos).r;vec4 color=texture(u_color_ramp,vec2(t,0.5));glFragColor=color*u_opacity;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(0.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,"in vec2 a_pos;out vec2 v_pos;void main() {gl_Position=vec4(a_pos,0,1);v_pos=a_pos*0.5+0.5;}"),collisionBox:fn("in float v_placed;in float v_notUsed;void main() {vec4 red =vec4(1.0,0.0,0.0,1.0);vec4 blue=vec4(0.0,0.0,1.0,0.5);glFragColor =mix(red,blue,step(0.5,v_placed))*0.5;glFragColor*=mix(1.0,0.1,step(0.5,v_notUsed));}",`#include "_prelude_terrain.vertex.glsl"
in vec3 a_pos;in vec2 a_anchor_pos;in vec2 a_extrude;in vec2 a_placed;in vec2 a_shift;in vec2 a_elevation_from_sea;in float a_size_scale;in vec2 a_padding;in float a_auto_z_offset;uniform mat4 u_matrix;uniform vec2 u_extrude_scale;uniform float u_camera_to_center_distance;
#ifdef PROJECTION_GLOBE_VIEW
uniform vec3 u_tile_id;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform float u_zoom_transition;
#endif
out float v_placed;out float v_notUsed;void main() {float feature_elevation=a_elevation_from_sea.x+a_auto_z_offset;float terrain_elevation=(a_elevation_from_sea.y==1.0 ? 0.0 : elevation(a_anchor_pos));vec3 proj_pos=a_pos+elevationVector(a_anchor_pos)*(feature_elevation+terrain_elevation);
#ifdef PROJECTION_GLOBE_VIEW
#ifndef PROJECTED_POS_ON_VIEWPORT
vec3 globe_pos=proj_pos;vec3 mercator_pos=mercator_tile_position(u_inv_rot_matrix,a_anchor_pos,u_tile_id,u_merc_center);proj_pos=mix_globe_mercator(globe_pos,mercator_pos,u_zoom_transition);
#endif
#endif
vec4 projectedPoint=u_matrix*vec4(proj_pos,1);highp float camera_to_anchor_distance=projectedPoint.w;highp float collision_perspective_ratio=clamp(
0.5+0.5*(u_camera_to_center_distance/camera_to_anchor_distance),0.0,1.5);gl_Position=projectedPoint;gl_Position.xy+=(a_extrude*a_size_scale+a_shift+a_padding)*u_extrude_scale*gl_Position.w*collision_perspective_ratio;v_placed=a_placed.x;v_notUsed=a_placed.y;}`),collisionCircle:fn("in float v_radius;in vec2 v_extrude;in float v_perspective_ratio;in float v_collision;void main() {float alpha=0.5*min(v_perspective_ratio,1.0);float stroke_radius=0.9*max(v_perspective_ratio,1.0);float distance_to_center=length(v_extrude);float distance_to_edge=abs(distance_to_center-v_radius);float opacity_t=smoothstep(-stroke_radius,0.0,-distance_to_edge);vec4 color=mix(vec4(0.0,0.0,1.0,0.5),vec4(1.0,0.0,0.0,1.0),v_collision);glFragColor=color*alpha*opacity_t;}",`in vec2 a_pos_2f;in float a_radius;in vec2 a_flags;uniform mat4 u_matrix;uniform mat4 u_inv_matrix;uniform vec2 u_viewport_size;uniform float u_camera_to_center_distance;out float v_radius;out vec2 v_extrude;out float v_perspective_ratio;out float v_collision;vec3 toTilePosition(vec2 screenPos) {vec4 rayStart=u_inv_matrix*vec4(screenPos,-1.0,1.0);vec4 rayEnd  =u_inv_matrix*vec4(screenPos, 1.0,1.0);rayStart.xyz/=rayStart.w;rayEnd.xyz  /=rayEnd.w;highp float t=(0.0-rayStart.z)/(rayEnd.z-rayStart.z);return mix(rayStart.xyz,rayEnd.xyz,t);}void main() {vec2 quadCenterPos=a_pos_2f;float radius=a_radius;float collision=a_flags.x;float vertexIdx=a_flags.y;vec2 quadVertexOffset=vec2(
mix(-1.0,1.0,float(vertexIdx >=2.0)),mix(-1.0,1.0,float(vertexIdx >=1.0 && vertexIdx <=2.0)));vec2 quadVertexExtent=quadVertexOffset*radius;vec3 tilePos=toTilePosition(quadCenterPos);vec4 clipPos=u_matrix*vec4(tilePos,1.0);highp float camera_to_anchor_distance=clipPos.w;highp float collision_perspective_ratio=clamp(
0.5+0.5*(u_camera_to_center_distance/camera_to_anchor_distance),0.0,4.0);float padding_factor=1.2;v_radius=radius;v_extrude=quadVertexExtent*padding_factor;v_perspective_ratio=collision_perspective_ratio;v_collision=collision;gl_Position=vec4(clipPos.xyz/clipPos.w,1.0)+vec4(quadVertexExtent*padding_factor/u_viewport_size*2.0,0.0,0.0);}`),debug:fn("uniform highp vec4 u_color;uniform sampler2D u_overlay;in vec2 v_uv;void main() {vec4 overlay_color=texture(u_overlay,v_uv);glFragColor=mix(u_color,overlay_color,overlay_color.a);}",`#include "_prelude_terrain.vertex.glsl"
in vec2 a_pos;
#ifdef PROJECTION_GLOBE_VIEW
in vec3 a_pos_3;
#endif
out vec2 v_uv;uniform mat4 u_matrix;uniform float u_overlay_scale;void main() {float h=elevation(a_pos);v_uv=a_pos/8192.0;
#ifdef PROJECTION_GLOBE_VIEW
gl_Position=u_matrix*vec4(a_pos_3+elevationVector(a_pos)*h,1);
#else
gl_Position=u_matrix*vec4(a_pos*u_overlay_scale,h,1);
#endif
}`),elevatedStructuresDepth:fn(`void main() {
#ifndef DEPTH_TEXTURE
glFragColor=vec4(0.);
#endif
}`,"in vec2 a_pos;in float a_height;uniform mat4 u_matrix;uniform float u_depth_bias;void main() {gl_Position=u_matrix*vec4(a_pos,a_height,1);gl_Position.z=gl_Position.z+u_depth_bias;}"),elevatedStructuresDepthReconstruct:fn(`#ifdef DEPTH_RECONSTRUCTION
in float v_height;
#endif
void main() {
#ifdef DEPTH_RECONSTRUCTION
if (v_height >=0.0)
discard;
#endif
glFragColor=vec4(1.0,0.0,0.0,1.0);}`,`in vec2 a_pos;in float a_height;uniform mat4 u_matrix;uniform vec3 u_camera_pos;uniform highp float u_depth_bias;uniform lowp float u_height_scale;uniform lowp float u_reset_depth;
#ifdef DEPTH_RECONSTRUCTION
out float v_height;
#endif
void main() {vec3 vpos=vec3(a_pos,a_height*u_height_scale);
#ifdef DEPTH_RECONSTRUCTION
if (u_camera_pos.z > vpos.z) {vpos-=(u_camera_pos-vpos)*(vpos.z/(u_camera_pos.z-vpos.z));}v_height=a_height;
#endif
gl_Position=u_matrix*vec4(vpos,1);gl_Position.z=u_reset_depth==1.0 ? gl_Position.w : gl_Position.z+u_depth_bias;}`),elevatedStructures:fn(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
#include "_prelude_shadow.fragment.glsl"
in vec3 v_normal;in float v_height;
#ifdef RENDER_SHADOWS
in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in float v_depth;
#endif
vec3 linearTosRGB(vec3 color) {return pow(color,vec3(1./2.2));}vec3 sRGBToLinear(vec3 srgbIn) {return pow(srgbIn,vec3(2.2));}vec3 compute_view_dependent_emissive_color(float ndotl,float emissive_strength,vec3 color)
{color=sRGBToLinear(color);color=color*(ndotl+(1.0-min(ndotl*57.29,1.0))*emissive_strength);color=linearTosRGB(color.rgb);return color;}uniform float u_emissive_strength;
#pragma mapbox: define highp vec4 structure_color
void main() {
#pragma mapbox: initialize highp vec4 structure_color
vec3 color=structure_color.xyz;
#ifdef LIGHTING_3D_MODE
vec3 normal=normalize(v_normal);vec3 transformed_normal=vec3(-normal.xy,normal.z);float ndotl=calculate_NdotL(transformed_normal);float emissive_strength=u_emissive_strength;emissive_strength=0.0;vec3 emissive_color=compute_view_dependent_emissive_color(ndotl,emissive_strength,color.xyz);
#ifdef RENDER_SHADOWS
float shadowed_lighting_factor=shadowed_light_factor_normal(transformed_normal,v_pos_light_view_0,v_pos_light_view_1,v_depth);color.rgb=apply_lighting(color.rgb,transformed_normal,shadowed_lighting_factor);
#else
color=apply_lighting(color,transformed_normal);
#endif
color=mix(color,emissive_color,emissive_strength);if (v_height < 0.0) {float penetration=max(v_height+7.5,0.0);float occlusion=1.0-1.0/PI*acos(1.0-penetration/4.0);color=color*(1.0-pow(occlusion,2.0)*0.3);}
#endif
#ifdef FOG
color=fog_apply(color,v_fog_pos);
#endif
vec4 out_color=vec4(color,1.0);
#ifdef INDICATOR_CUTOUT
out_color=applyCutout(out_color,v_height);
#endif
#ifdef FEATURE_CUTOUT
out_color=apply_feature_cutout(out_color,gl_FragCoord);
#endif
glFragColor=out_color;HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_shadow.vertex.glsl"
in vec2 a_pos;in float a_height;in vec3 a_pos_normal_3;uniform mat4 u_matrix;out vec3 v_normal;out float v_height;
#ifdef RENDER_SHADOWS
uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out float v_depth;
#endif
#pragma mapbox: define highp vec4 structure_color
void main() {
#pragma mapbox: initialize highp vec4 structure_color
v_normal=a_pos_normal_3/16384.0;v_height=a_height;vec3 pos=vec3(a_pos,a_height);gl_Position=u_matrix*vec4(pos,1);
#ifdef RENDER_SHADOWS
vec3 shd_pos0=pos;vec3 shd_pos1=pos;
#ifdef NORMAL_OFFSET
vec3 offset=shadow_normal_offset(vec3(-v_normal.xy,v_normal.z));shd_pos0+=offset*shadow_normal_offset_multiplier0();shd_pos1+=offset*shadow_normal_offset_multiplier1();
#endif
v_pos_light_view_0=u_light_matrix_0*vec4(shd_pos0,1);v_pos_light_view_1=u_light_matrix_1*vec4(shd_pos1,1);v_depth=gl_Position.w;
#endif
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
}`),fill:fn(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
#include "_prelude_shadow.fragment.glsl"
#pragma mapbox: define highp vec4 color
#pragma mapbox: define lowp float opacity
uniform float u_emissive_strength;
#ifdef RENDER_SHADOWS
uniform vec3 u_ground_shadow_factor;in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in highp float v_depth;
#endif
#ifdef ELEVATED_ROADS
in highp float v_road_z_offset;
#endif
#ifdef INDICATOR_CUTOUT
in highp float v_z_offset;
#endif
void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize lowp float opacity
vec4 out_color=color;
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);
#ifdef RENDER_SHADOWS
float light=shadowed_light_factor(v_pos_light_view_0,v_pos_light_view_1,v_depth);out_color.rgb*=mix(u_ground_shadow_factor,vec3(1.0),light);
#endif
#endif
#ifdef FOG
out_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));
#endif
out_color*=opacity;
#ifdef INDICATOR_CUTOUT
if (v_z_offset >=0.0) {out_color=applyCutout(out_color,v_z_offset);}
#endif
#ifdef FEATURE_CUTOUT
out_color=apply_feature_cutout(out_color,gl_FragCoord);
#endif
glFragColor=out_color;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_shadow.vertex.glsl"
in vec2 a_pos;
#ifdef ELEVATED_ROADS
in float a_road_z_offset;out highp float v_road_z_offset;
#endif
#ifdef RENDER_SHADOWS
uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out highp float v_depth;
#endif
#ifdef INDICATOR_CUTOUT
out highp float v_z_offset;
#endif
uniform mat4 u_matrix;
#pragma mapbox: define highp vec4 color
#pragma mapbox: define lowp float opacity
#pragma mapbox: define highp float z_offset
void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize highp float z_offset
#ifdef ELEVATED_ROADS
z_offset+=a_road_z_offset;v_road_z_offset=z_offset;
#endif
float hidden=float(opacity==0.0);gl_Position=mix(u_matrix*vec4(a_pos,z_offset,1),AWAY,hidden);
#ifdef RENDER_SHADOWS
vec3 shd_pos0=vec3(a_pos,z_offset);vec3 shd_pos1=vec3(a_pos,z_offset);
#ifdef NORMAL_OFFSET
vec3 offset=shadow_normal_offset(vec3(0.0,0.0,1.0));shd_pos0+=offset*shadow_normal_offset_multiplier0();shd_pos1+=offset*shadow_normal_offset_multiplier1();
#endif
v_pos_light_view_0=u_light_matrix_0*vec4(shd_pos0,1);v_pos_light_view_1=u_light_matrix_1*vec4(shd_pos1,1);v_depth=gl_Position.w;
#endif
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
#ifdef INDICATOR_CUTOUT
v_z_offset=z_offset;
#endif
}`),fillOutline:fn(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
#include "_prelude_shadow.fragment.glsl"
in highp vec2 v_pos;uniform float u_emissive_strength;
#ifdef RENDER_SHADOWS
uniform vec3 u_ground_shadow_factor;in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in highp float v_depth;
#endif
#pragma mapbox: define highp vec4 outline_color
#pragma mapbox: define lowp float opacity
void main() {
#pragma mapbox: initialize highp vec4 outline_color
#pragma mapbox: initialize lowp float opacity
float dist=length(v_pos-gl_FragCoord.xy);float alpha=1.0-smoothstep(0.0,1.0,dist);vec4 out_color=outline_color;
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);
#ifdef RENDER_SHADOWS
float light=shadowed_light_factor(v_pos_light_view_0,v_pos_light_view_1,v_depth);out_color.rgb*=mix(u_ground_shadow_factor,vec3(1.0),light);
#endif
#endif
#ifdef FOG
out_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));
#endif
#ifdef FEATURE_CUTOUT
out_color=apply_feature_cutout(out_color,gl_FragCoord);
#endif
glFragColor=out_color*(alpha*opacity);
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_shadow.vertex.glsl"
in vec2 a_pos;
#ifdef ELEVATED_ROADS
in float a_road_z_offset;
#endif
#ifdef RENDER_SHADOWS
uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out highp float v_depth;
#endif
uniform mat4 u_matrix;uniform vec2 u_world;out highp vec2 v_pos;
#pragma mapbox: define highp vec4 outline_color
#pragma mapbox: define lowp float opacity
#pragma mapbox: define highp float z_offset
void main() {
#pragma mapbox: initialize highp vec4 outline_color
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize highp float z_offset
#ifdef ELEVATED_ROADS
z_offset+=a_road_z_offset;
#endif
float hidden=float(opacity==0.0);gl_Position=mix(u_matrix*vec4(a_pos,z_offset,1),AWAY,hidden);
#ifdef FLIP_Y
v_pos=(vec2(gl_Position.x,-gl_Position.y)/gl_Position.w+1.0)/2.0*u_world;
#else
v_pos=(gl_Position.xy/gl_Position.w+1.0)/2.0*u_world;
#endif
#ifdef RENDER_SHADOWS
vec3 shd_pos0=vec3(a_pos,z_offset);vec3 shd_pos1=vec3(a_pos,z_offset);
#ifdef NORMAL_OFFSET
vec3 offset=shadow_normal_offset(vec3(0.0,0.0,1.0));shd_pos0+=offset*shadow_normal_offset_multiplier0();shd_pos1+=offset*shadow_normal_offset_multiplier1();
#endif
v_pos_light_view_0=u_light_matrix_0*vec4(shd_pos0,1);v_pos_light_view_1=u_light_matrix_1*vec4(shd_pos1,1);v_depth=gl_Position.w;
#endif
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
}`),fillOutlinePattern:fn(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
#include "_prelude_shadow.fragment.glsl"
uniform vec2 u_texsize;uniform sampler2D u_image;
#ifdef FILL_PATTERN_TRANSITION
uniform float u_pattern_transition;
#endif
uniform float u_emissive_strength;
#ifdef RENDER_SHADOWS
uniform vec3 u_ground_shadow_factor;in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in highp float v_depth;
#endif
in highp vec2 v_pos;in highp vec2 v_pos_world;
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp vec4 pattern
#ifdef FILL_PATTERN_TRANSITION
#pragma mapbox: define mediump vec4 pattern_b
#endif
void main() {
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump vec4 pattern
#ifdef FILL_PATTERN_TRANSITION
#pragma mapbox: initialize mediump vec4 pattern_b
#endif
vec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;highp vec2 imagecoord=mod(v_pos,1.0);highp vec2 pos=mix(pattern_tl/u_texsize,pattern_br/u_texsize,imagecoord);highp vec2 lod_pos=mix(pattern_tl/u_texsize,pattern_br/u_texsize,v_pos);float dist=length(v_pos_world-gl_FragCoord.xy);float alpha=1.0-smoothstep(0.0,1.0,dist);vec4 out_color=textureLodCustom(u_image,pos,lod_pos);
#ifdef FILL_PATTERN_TRANSITION
vec2 pattern_b_tl=pattern_b.xy;vec2 pattern_b_br=pattern_b.zw;highp vec2 pos_b=mix(pattern_b_tl/u_texsize,pattern_b_br/u_texsize,imagecoord);vec4 color_b=textureLodCustom(u_image,pos_b,lod_pos);out_color=out_color*(1.0-u_pattern_transition)+color_b*u_pattern_transition;
#endif
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);
#ifdef RENDER_SHADOWS
float light=shadowed_light_factor(v_pos_light_view_0,v_pos_light_view_1,v_depth);out_color.rgb*=mix(u_ground_shadow_factor,vec3(1.0),light);
#endif
#endif
#ifdef FEATURE_CUTOUT
out_color=apply_feature_cutout(out_color,gl_FragCoord);
#endif
#ifdef FOG
out_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));
#endif
glFragColor=out_color*(alpha*opacity);
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_shadow.vertex.glsl"
uniform mat4 u_matrix;uniform vec2 u_world;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform float u_tile_units_to_pixels;in vec2 a_pos;
#ifdef ELEVATED_ROADS
in float a_road_z_offset;
#endif
#ifdef RENDER_SHADOWS
uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out highp float v_depth;
#endif
out highp vec2 v_pos;out highp vec2 v_pos_world;
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp vec4 pattern
#ifdef FILL_PATTERN_TRANSITION
#pragma mapbox: define mediump vec4 pattern_b
#endif
#pragma mapbox: define lowp float pixel_ratio
#pragma mapbox: define highp float z_offset
void main() {
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump vec4 pattern
#ifdef FILL_PATTERN_TRANSITION
#pragma mapbox: initialize mediump vec4 pattern_b
#endif
#pragma mapbox: initialize lowp float pixel_ratio
#pragma mapbox: initialize highp float z_offset
vec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;
#ifdef ELEVATED_ROADS
z_offset+=a_road_z_offset;
#endif
float hidden=float(opacity==0.0);gl_Position=mix(u_matrix*vec4(a_pos,z_offset,1),AWAY,hidden);vec2 display_size=(pattern_br-pattern_tl)/pixel_ratio;v_pos=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,display_size,u_tile_units_to_pixels,a_pos);
#ifdef FLIP_Y
v_pos_world=(vec2(gl_Position.x,-gl_Position.y)/gl_Position.w+1.0)/2.0*u_world;
#else
v_pos_world=(gl_Position.xy/gl_Position.w+1.0)/2.0*u_world;
#endif
#ifdef RENDER_SHADOWS
vec3 shd_pos0=vec3(a_pos,z_offset);vec3 shd_pos1=vec3(a_pos,z_offset);
#ifdef NORMAL_OFFSET
vec3 offset=shadow_normal_offset(vec3(0.0,0.0,1.0));shd_pos0+=offset*shadow_normal_offset_multiplier0();shd_pos1+=offset*shadow_normal_offset_multiplier1();
#endif
v_pos_light_view_0=u_light_matrix_0*vec4(shd_pos0,1);v_pos_light_view_1=u_light_matrix_1*vec4(shd_pos1,1);v_depth=gl_Position.w;
#endif
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
}`),fillPattern:fn(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
#include "_prelude_shadow.fragment.glsl"
uniform vec2 u_texsize;uniform sampler2D u_image;
#ifdef FILL_PATTERN_TRANSITION
uniform float u_pattern_transition;
#endif
in highp vec2 v_pos;uniform float u_emissive_strength;
#ifdef RENDER_SHADOWS
uniform vec3 u_ground_shadow_factor;in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in highp float v_depth;
#endif
#ifdef ELEVATED_ROADS
in highp float v_road_z_offset;
#endif
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp vec4 pattern
#ifdef FILL_PATTERN_TRANSITION
#pragma mapbox: define mediump vec4 pattern_b
#endif
void main() {
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump vec4 pattern
#ifdef FILL_PATTERN_TRANSITION
#pragma mapbox: initialize mediump vec4 pattern_b
#endif
vec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;highp vec2 imagecoord=mod(v_pos,1.0);highp vec2 pos=mix(pattern_tl/u_texsize,pattern_br/u_texsize,imagecoord);highp vec2 lod_pos=mix(pattern_tl/u_texsize,pattern_br/u_texsize,v_pos);vec4 out_color=textureLodCustom(u_image,pos,lod_pos);
#ifdef FILL_PATTERN_TRANSITION
vec2 pattern_b_tl=pattern_b.xy;vec2 pattern_b_br=pattern_b.zw;highp vec2 pos_b=mix(pattern_b_tl/u_texsize,pattern_b_br/u_texsize,imagecoord);vec4 color_b=textureLodCustom(u_image,pos_b,lod_pos);out_color=out_color*(1.0-u_pattern_transition)+color_b*u_pattern_transition;
#endif
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);
#ifdef RENDER_SHADOWS
float light=shadowed_light_factor(v_pos_light_view_0,v_pos_light_view_1,v_depth);
#ifdef ELEVATED_ROADS
out_color.rgb*=mix(v_road_z_offset !=0.0 ? u_ground_shadow_factor : vec3(1.0),vec3(1.0),light);
#else
out_color.rgb*=mix(u_ground_shadow_factor,vec3(1.0),light);
#endif
#endif
#endif
#ifdef FEATURE_CUTOUT
out_color=apply_feature_cutout(out_color,gl_FragCoord);
#endif
#ifdef FOG
out_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));
#endif
glFragColor=out_color*opacity;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_shadow.vertex.glsl"
uniform mat4 u_matrix;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform float u_tile_units_to_pixels;in vec2 a_pos;
#ifdef ELEVATED_ROADS
in float a_road_z_offset;out highp float v_road_z_offset;
#endif
#ifdef RENDER_SHADOWS
uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out highp float v_depth;
#endif
out highp vec2 v_pos;
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp vec4 pattern
#ifdef FILL_PATTERN_TRANSITION
#pragma mapbox: define mediump vec4 pattern_b
#endif
#pragma mapbox: define lowp float pixel_ratio
#pragma mapbox: define highp float z_offset
void main() {
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump vec4 pattern
#pragma mapbox: initialize lowp float pixel_ratio
#pragma mapbox: initialize highp float z_offset
#ifdef FILL_PATTERN_TRANSITION
#pragma mapbox: initialize mediump vec4 pattern_b
#endif
vec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;vec2 display_size=(pattern_br-pattern_tl)/pixel_ratio;
#ifdef ELEVATED_ROADS
z_offset+=a_road_z_offset;v_road_z_offset=z_offset;
#endif
float hidden=float(opacity==0.0);gl_Position=mix(u_matrix*vec4(a_pos,z_offset,1),AWAY,hidden);v_pos=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,display_size,u_tile_units_to_pixels,a_pos);
#ifdef RENDER_SHADOWS
vec3 shd_pos0=vec3(a_pos,z_offset);vec3 shd_pos1=vec3(a_pos,z_offset);
#ifdef NORMAL_OFFSET
vec3 offset=shadow_normal_offset(vec3(0.0,0.0,1.0));shd_pos0+=offset*shadow_normal_offset_multiplier0();shd_pos1+=offset*shadow_normal_offset_multiplier1();
#endif
v_pos_light_view_0=u_light_matrix_0*vec4(shd_pos0,1);v_pos_light_view_1=u_light_matrix_1*vec4(shd_pos1,1);v_depth=gl_Position.w;
#endif
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
}`),fillExtrusion:fn(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_shadow.fragment.glsl"
#include "_prelude_lighting.glsl"
in vec4 v_color;in vec4 v_flat;
#ifdef RENDER_SHADOWS
in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;
#endif
uniform lowp float u_opacity;
#ifdef FAUX_AO
uniform lowp vec2 u_ao;in vec2 v_ao;
#endif
#if defined(ZERO_ROOF_RADIUS) && !defined(LIGHTING_3D_MODE)
in vec4 v_roof_color;
#endif
#if defined(ZERO_ROOF_RADIUS) || defined(RENDER_SHADOWS) || defined(LIGHTING_3D_MODE)
in highp vec3 v_normal;
#endif
uniform vec3 u_flood_light_color;uniform highp float u_vertical_scale;uniform float u_flood_light_intensity;uniform vec3 u_ground_shadow_factor;
#if defined(LIGHTING_3D_MODE) && defined(FLOOD_LIGHT)
in float v_flood_radius;in float v_has_floodlight;
#endif
in float v_height;
#pragma mapbox: define highp float emissive_strength
void main() {
#pragma mapbox: initialize highp float emissive_strength
#if defined(ZERO_ROOF_RADIUS) || defined(RENDER_SHADOWS) || defined(LIGHTING_3D_MODE)
vec3 normal=normalize(v_normal);
#endif
float z;vec4 color=v_color;
#ifdef ZERO_ROOF_RADIUS
z=float(normal.z > 0.00001);
#ifdef LIGHTING_3D_MODE
normal=mix(normal,vec3(0.0,0.0,1.0),z);
#else
color=mix(v_color,v_roof_color,z);
#endif
#endif
float h=max(0.0,v_height);float ao_shade=1.0;
#ifdef FAUX_AO
float intensity=u_ao[0];float h_floors=h/(u_ao[1]*u_vertical_scale);float y_shade=1.0-0.9*intensity*min(v_ao.y,1.0);ao_shade=(1.0-0.08*intensity)*(y_shade+(1.0-y_shade)*(1.0-pow(1.0-min(h_floors/16.0,1.0),16.0)))+0.08*intensity*min(h_floors/160.0,1.0);float concave=v_ao.x*v_ao.x;
#ifdef ZERO_ROOF_RADIUS
concave*=(1.0-z);
#endif
float x_shade=mix(1.0,mix(0.6,0.75,min(h_floors/30.0,1.0)),intensity)+0.1*intensity*min(h,1.0);ao_shade*=mix(1.0,x_shade*x_shade*x_shade,concave);
#ifdef LIGHTING_3D_MODE
#ifdef FLOOD_LIGHT
color.rgb*=mix(ao_shade,1.0,v_has_floodlight);
#else
color.rgb*=ao_shade;
#endif
#else
color.rgb*=ao_shade;
#endif
#endif
#ifdef LIGHTING_3D_MODE
float flood_radiance=0.0;
#ifdef FLOOD_LIGHT
flood_radiance=(1.0-min(h/v_flood_radius,1.0))*u_flood_light_intensity*v_has_floodlight;
#endif
#ifdef RENDER_SHADOWS
#ifdef FLOOD_LIGHT
float ndotl_unclamped=dot(normal,u_shadow_direction);float ndotl=max(0.0,ndotl_unclamped);float occlusion=ndotl_unclamped < 0.0 ? 1.0 : shadow_occlusion(ndotl,v_pos_light_view_0,v_pos_light_view_1,1.0/gl_FragCoord.w);vec3 litColor=apply_lighting(color.rgb,normal,(1.0-u_shadow_intensity*occlusion)*ndotl);vec3 floodLitColor=compute_flood_lighting(u_flood_light_color*u_opacity,1.0-u_shadow_intensity,occlusion,u_ground_shadow_factor);color.rgb=mix(litColor,floodLitColor,flood_radiance);
#else
float shadowed_lighting_factor;
#ifdef RENDER_CUTOFF
shadowed_lighting_factor=shadowed_light_factor_normal_opacity(normal,v_pos_light_view_0,v_pos_light_view_1,1.0/gl_FragCoord.w,v_cutoff_opacity);if (v_cutoff_opacity==0.0) {discard;}
#else
shadowed_lighting_factor=shadowed_light_factor_normal(normal,v_pos_light_view_0,v_pos_light_view_1,1.0/gl_FragCoord.w);
#endif
color.rgb=apply_lighting(color.rgb,normal,shadowed_lighting_factor);
#endif
#else
color.rgb=apply_lighting(color.rgb,normal);
#ifdef FLOOD_LIGHT
color.rgb=mix(color.rgb,u_flood_light_color*u_opacity,flood_radiance);
#endif
#endif
color.rgb=mix(color.rgb,v_flat.rgb,emissive_strength);color*=u_opacity;
#endif
#ifdef FOG
color=fog_dither(fog_apply_premultiplied(color,v_fog_pos,h));
#endif
#ifdef INDICATOR_CUTOUT
color=applyCutout(color,h);
#endif
#ifdef FEATURE_CUTOUT
color=apply_feature_cutout(color,gl_FragCoord);
#endif
glFragColor=color;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_terrain.vertex.glsl"
#include "_prelude_shadow.vertex.glsl"
#include "_prelude_lighting.glsl"
uniform mat4 u_matrix;uniform vec3 u_lightcolor;uniform lowp vec3 u_lightpos;uniform lowp float u_lightintensity;uniform float u_vertical_gradient;uniform lowp float u_opacity;uniform float u_edge_radius;uniform float u_width_scale;in vec4 a_pos_normal_ed;in vec2 a_centroid_pos;
#ifdef RENDER_WALL_MODE
in vec3 a_join_normal_inside;
#endif
#ifdef PROJECTION_GLOBE_VIEW
in vec3 a_pos_3;in vec3 a_pos_normal_3;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_tile_id;uniform float u_zoom_transition;uniform vec3 u_up_dir;uniform float u_height_lift;
#endif
#ifdef TERRAIN
uniform int u_height_type;uniform int u_base_type;
#endif
uniform highp float u_vertical_scale;out vec4 v_color;out vec4 v_flat;
#ifdef RENDER_SHADOWS
uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;
#endif
#if defined(ZERO_ROOF_RADIUS) && !defined(LIGHTING_3D_MODE)
out vec4 v_roof_color;
#endif
#if defined(ZERO_ROOF_RADIUS) || defined(RENDER_SHADOWS) || defined(LIGHTING_3D_MODE)
out highp vec3 v_normal;
#endif
#ifdef FAUX_AO
uniform lowp vec2 u_ao;out vec2 v_ao;
#endif
#if defined(LIGHTING_3D_MODE) && defined(FLOOD_LIGHT)
out float v_flood_radius;out float v_has_floodlight;
#endif
out float v_height;vec3 linearTosRGB(vec3 color) {return pow(color,vec3(1./2.2));}vec3 sRGBToLinear(vec3 srgbIn) {return pow(srgbIn,vec3(2.2));}
#pragma mapbox: define highp float base
#pragma mapbox: define highp float height
#pragma mapbox: define highp vec4 color
#pragma mapbox: define highp float flood_light_wall_radius
#pragma mapbox: define highp float line_width
#pragma mapbox: define highp float emissive_strength
void main() {
#pragma mapbox: initialize highp float base
#pragma mapbox: initialize highp float height
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize highp float flood_light_wall_radius
#pragma mapbox: initialize highp float line_width
#pragma mapbox: initialize highp float emissive_strength
base*=u_vertical_scale;height*=u_vertical_scale;vec4 pos_nx=floor(a_pos_normal_ed*0.5);vec4 top_up_ny_start=a_pos_normal_ed-2.0*pos_nx;vec3 top_up_ny=top_up_ny_start.xyz;float x_normal=pos_nx.z/8192.0;vec3 normal=top_up_ny.y==1.0 ? vec3(0.0,0.0,1.0) : normalize(vec3(x_normal,(2.0*top_up_ny.z-1.0)*(1.0-abs(x_normal)),0.0));
#if defined(ZERO_ROOF_RADIUS) || defined(RENDER_SHADOWS) || defined(LIGHTING_3D_MODE)
v_normal=normal;
#endif
base=max(0.0,base);float attr_height=height;height=max(0.0,top_up_ny.y==0.0 && top_up_ny.x==1.0 ? height-u_edge_radius : height);float t=top_up_ny.x;vec2 centroid_pos=vec2(0.0);
#if defined(HAS_CENTROID) || defined(TERRAIN)
centroid_pos=a_centroid_pos;
#endif
float ele=0.0;float h=0.0;float c_ele=0.0;vec3 pos;
#ifdef TERRAIN
bool is_flat_height=centroid_pos.x !=0.0 && u_height_type==1;bool is_flat_base=centroid_pos.x !=0.0 && u_base_type==1;ele=elevation(pos_nx.xy);c_ele=is_flat_height || is_flat_base ? (centroid_pos.y==0.0 ? elevationFromUint16(centroid_pos.x) : flatElevation(centroid_pos)) : ele;float h_height=is_flat_height ? max(c_ele+height,ele+base+2.0) : ele+height;float h_base=is_flat_base ? max(c_ele+base,ele+base) : ele+(base==0.0 ?-5.0 : base);h=t > 0.0 ? max(h_base,h_height) : h_base;pos=vec3(pos_nx.xy,h);
#else
h=t > 0.0 ? height : base;pos=vec3(pos_nx.xy,h);
#endif
#ifdef PROJECTION_GLOBE_VIEW
float lift=float((t+base) > 0.0)*u_height_lift;h+=lift;vec3 globe_normal=normalize(mix(a_pos_normal_3/16384.0,u_up_dir,u_zoom_transition));vec3 globe_pos=a_pos_3+globe_normal*(u_tile_up_scale*h);vec3 merc_pos=mercator_tile_position(u_inv_rot_matrix,pos.xy,u_tile_id,u_merc_center)+u_up_dir*u_tile_up_scale*pos.z;pos=mix_globe_mercator(globe_pos,merc_pos,u_zoom_transition);
#endif
float cutoff=1.0;vec3 scaled_pos=pos;
#ifdef RENDER_CUTOFF
vec3 centroid_random=vec3(centroid_pos.xy,centroid_pos.x+centroid_pos.y+1.0);vec3 ground_pos=centroid_pos.x==0.0 ? pos.xyz : (centroid_random/8.0);vec4 ground=u_matrix*vec4(ground_pos.xy,ele,1.0);
#ifdef CLIP_ZERO_TO_ONE
cutoff=cutoff_opacity(u_cutoff_params,ground.z*2.0-ground.w);
#else
cutoff=cutoff_opacity(u_cutoff_params,ground.z);
#endif
if (centroid_pos.y !=0.0 && centroid_pos.x !=0.0) {vec3 g=floor(ground_pos);vec3 mod_=centroid_random-g*8.0;float seed=min(1.0,0.1*(min(3.5,max(mod_.x+mod_.y,0.2*attr_height))*0.35+mod_.z));if (cutoff < 0.8-seed) {cutoff=0.0;}}float cutoff_scale=cutoff;v_cutoff_opacity=cutoff;scaled_pos.z=mix(c_ele,h,cutoff_scale);
#endif
float hidden=float((centroid_pos.x==0.0 && centroid_pos.y==1.0) || (cutoff==0.0 && centroid_pos.x !=0.0) || (color.a==0.0));
#ifdef RENDER_WALL_MODE
vec2 wall_offset=u_width_scale*line_width*(a_join_normal_inside.xy/EXTENT);scaled_pos.xy+=(1.0-a_join_normal_inside.z)*wall_offset*0.5;scaled_pos.xy-=a_join_normal_inside.z*wall_offset*0.5;
#endif
gl_Position=mix(u_matrix*vec4(scaled_pos,1),AWAY,hidden);h=h-ele;v_height=h;
#ifdef RENDER_SHADOWS
vec3 shd_pos0=pos;vec3 shd_pos1=pos;
#ifdef NORMAL_OFFSET
vec3 offset=shadow_normal_offset(normal);shd_pos0+=offset*shadow_normal_offset_multiplier0();shd_pos1+=offset*shadow_normal_offset_multiplier1();
#endif
v_pos_light_view_0=u_light_matrix_0*vec4(shd_pos0,1);v_pos_light_view_1=u_light_matrix_1*vec4(shd_pos1,1);
#endif
float NdotL=0.0;float colorvalue=0.0;
#ifndef LIGHTING_3D_MODE
colorvalue=color.r*0.2126+color.g*0.7152+color.b*0.0722;vec4 ambientlight=vec4(0.03,0.03,0.03,1.0);color+=ambientlight;NdotL=clamp(dot(normal,u_lightpos),0.0,1.0);NdotL=mix((1.0-u_lightintensity),max((1.0-colorvalue+u_lightintensity),1.0),NdotL);if (normal.y !=0.0) {float r=0.84;r=mix(0.7,0.98,1.0-u_lightintensity);NdotL*=(
(1.0-u_vertical_gradient)+(u_vertical_gradient*clamp((t+base)*pow(height/150.0,0.5),r,1.0)));}
#endif
#ifdef FAUX_AO
float concave=pos_nx.w-floor(pos_nx.w*0.5)*2.0;float start=top_up_ny_start.w;float y_ground=1.0-clamp(t+base,0.0,1.0);float top_height=height;
#ifdef TERRAIN
top_height=mix(max(c_ele+height,ele+base+2.0),ele+height,float(centroid_pos.x==0.0))-ele;y_ground+=y_ground*5.0/max(3.0,top_height);
#endif
v_ao=vec2(mix(concave,-concave,start),y_ground);NdotL*=(1.0+0.05*(1.0-top_up_ny.y)*u_ao[0]);
#ifdef PROJECTION_GLOBE_VIEW
top_height+=u_height_lift;
#endif
gl_Position.z-=(0.0000006*(min(top_height,500.)+2.0*min(base,500.0)+60.0*concave+3.0*start))*gl_Position.w;
#endif
#ifdef LIGHTING_3D_MODE
#ifdef FLOOD_LIGHT
float is_wall=1.0-float(t > 0.0 && top_up_ny.y > 0.0);v_has_floodlight=float(flood_light_wall_radius > 0.0 && is_wall > 0.0);v_flood_radius=flood_light_wall_radius*u_vertical_scale;
#endif
v_color=vec4(color.rgb,1.0);float ndotl=calculate_NdotL(normal);v_flat.rgb=sRGBToLinear(color.rgb);v_flat.rgb=v_flat.rgb*(ndotl+(1.0-min(ndotl*57.29,1.0))*emissive_strength);v_flat=vec4(linearTosRGB(v_flat.rgb),1.0);
#else
v_color=vec4(0.0,0.0,0.0,1.0);v_color.rgb+=clamp(color.rgb*NdotL*u_lightcolor,mix(vec3(0.0),vec3(0.3),1.0-u_lightcolor),vec3(1.0));v_color*=u_opacity;
#endif
#if defined(ZERO_ROOF_RADIUS) && !defined(LIGHTING_3D_MODE)
float roofNdotL=clamp(u_lightpos.z,0.0,1.0);roofNdotL=mix((1.0-u_lightintensity),max((1.0-colorvalue+u_lightintensity),1.0),roofNdotL);v_roof_color=vec4(0.0,0.0,0.0,1.0);v_roof_color.rgb+=clamp(color.rgb*roofNdotL*u_lightcolor,mix(vec3(0.0),vec3(0.3),1.0-u_lightcolor),vec3(1.0));v_roof_color*=u_opacity;
#endif
#ifdef FOG
v_fog_pos=fog_position(pos);
#endif
}`),fillExtrusionDepth:fn(`in highp float v_depth;void main() {
#ifndef DEPTH_TEXTURE
glFragColor=pack_depth(v_depth);
#endif
}`,`#include "_prelude_terrain.vertex.glsl"
uniform mat4 u_matrix;uniform float u_edge_radius;uniform float u_width_scale;uniform float u_vertical_scale;
#ifdef TERRAIN
uniform int u_height_type;uniform int u_base_type;
#endif
in vec4 a_pos_normal_ed;in vec2 a_centroid_pos;
#ifdef RENDER_WALL_MODE
in vec3 a_join_normal_inside;
#endif
#pragma mapbox: define highp float base
#pragma mapbox: define highp float height
#pragma mapbox: define highp float line_width
#pragma mapbox: define highp vec4 color
out highp float v_depth;void main() {
#pragma mapbox: initialize highp float base
#pragma mapbox: initialize highp float height
#pragma mapbox: initialize highp float line_width
#pragma mapbox: initialize highp vec4 color
base*=u_vertical_scale;height*=u_vertical_scale;vec3 pos_nx=floor(a_pos_normal_ed.xyz*0.5);mediump vec3 top_up_ny=a_pos_normal_ed.xyz-2.0*pos_nx;base=max(0.0,base);height=max(0.0,top_up_ny.y==0.0 && top_up_ny.x==1.0 ? height-u_edge_radius : height);float t=top_up_ny.x;vec2 centroid_pos=vec2(0.0);
#if defined(HAS_CENTROID) || defined(TERRAIN)
centroid_pos=a_centroid_pos;
#endif
vec3 pos;
#ifdef TERRAIN
bool is_flat_height=centroid_pos.x !=0.0 && u_height_type==1;bool is_flat_base=centroid_pos.x !=0.0 && u_base_type==1;float ele=elevation(pos_nx.xy);float c_ele=is_flat_height || is_flat_base ? (centroid_pos.y==0.0 ? elevationFromUint16(centroid_pos.x) : flatElevation(centroid_pos)) : ele;float h_height=is_flat_height ? max(c_ele+height,ele+base+2.0) : ele+height;float h_base=is_flat_base ? max(c_ele+base,ele+base) : ele+(base==0.0 ?-5.0 : base);float h=t > 0.0 ? max(h_base,h_height) : h_base;pos=vec3(pos_nx.xy,h);
#else
pos=vec3(pos_nx.xy,t > 0.0 ? height : base);
#endif
#ifdef RENDER_WALL_MODE
vec2 wall_offset=u_width_scale*line_width*(a_join_normal_inside.xy/EXTENT);pos.xy+=(1.0-a_join_normal_inside.z)*wall_offset*0.5;pos.xy-=a_join_normal_inside.z*wall_offset*0.5;
#endif
float hidden=float((centroid_pos.x==0.0 && centroid_pos.y==1.0) || (color.a==0.0));gl_Position=mix(u_matrix*vec4(pos,1),AWAY,hidden);v_depth=gl_Position.z/gl_Position.w;}`),fillExtrusionPattern:fn(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
uniform vec2 u_texsize;uniform sampler2D u_image;
#ifdef FILL_EXTRUSION_PATTERN_TRANSITION
uniform float u_pattern_transition;
#endif
#ifdef FAUX_AO
uniform lowp vec2 u_ao;in vec3 v_ao;
#endif
#ifdef LIGHTING_3D_MODE
in vec3 v_normal;
#endif
in highp vec2 v_pos;in vec4 v_lighting;uniform lowp float u_opacity;
#pragma mapbox: define highp float base
#pragma mapbox: define highp float height
#pragma mapbox: define mediump vec4 pattern
#ifdef FILL_EXTRUSION_PATTERN_TRANSITION
#pragma mapbox: define mediump vec4 pattern_b
#endif
#pragma mapbox: define highp float pixel_ratio
void main() {
#pragma mapbox: initialize highp float base
#pragma mapbox: initialize highp float height
#pragma mapbox: initialize mediump vec4 pattern
#ifdef FILL_EXTRUSION_PATTERN_TRANSITION
#pragma mapbox: initialize mediump vec4 pattern_b
#endif
#pragma mapbox: initialize highp float pixel_ratio
vec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;highp vec2 imagecoord=mod(v_pos,1.0);highp vec2 pos=mix(pattern_tl/u_texsize,pattern_br/u_texsize,imagecoord);highp vec2 lod_pos=mix(pattern_tl/u_texsize,pattern_br/u_texsize,v_pos);vec4 out_color=textureLodCustom(u_image,pos,lod_pos);
#ifdef FILL_EXTRUSION_PATTERN_TRANSITION
vec2 pattern_b_tl=pattern_b.xy;vec2 pattern_b_br=pattern_b.zw;highp vec2 pos_b=mix(pattern_b_tl/u_texsize,pattern_b_br/u_texsize,imagecoord);vec4 color_b=textureLodCustom(u_image,pos_b,lod_pos);out_color=out_color*(1.0-u_pattern_transition)+color_b*u_pattern_transition;
#endif
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting(out_color,normalize(v_normal))*u_opacity;
#else
out_color=out_color*v_lighting;
#endif
#ifdef FAUX_AO
float intensity=u_ao[0];float h=max(0.0,v_ao.z);float h_floors=h/u_ao[1];float y_shade=1.0-0.9*intensity*min(v_ao.y,1.0);float shade=(1.0-0.08*intensity)*(y_shade+(1.0-y_shade)*(1.0-pow(1.0-min(h_floors/16.0,1.0),16.0)))+0.08*intensity*min(h_floors/160.0,1.0);float concave=v_ao.x*v_ao.x;float x_shade=mix(1.0,mix(0.6,0.75,min(h_floors/30.0,1.0)),intensity)+0.1*intensity*min(h,1.0);shade*=mix(1.0,x_shade*x_shade*x_shade,concave);out_color.rgb=out_color.rgb*shade;
#endif
#ifdef FOG
out_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));
#endif
#ifdef INDICATOR_CUTOUT
out_color=applyCutout(out_color,height);
#endif
glFragColor=out_color;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_terrain.vertex.glsl"
#include "_prelude_lighting.glsl"
uniform mat4 u_matrix;uniform vec2 u_pixel_coord_upper;uniform vec2 u_pixel_coord_lower;uniform float u_height_factor;uniform float u_tile_units_to_pixels;uniform float u_vertical_gradient;uniform lowp float u_opacity;uniform float u_width_scale;uniform vec3 u_lightcolor;uniform lowp vec3 u_lightpos;uniform lowp float u_lightintensity;in vec4 a_pos_normal_ed;in vec2 a_centroid_pos;
#ifdef RENDER_WALL_MODE
in vec3 a_join_normal_inside;
#endif
#ifdef PROJECTION_GLOBE_VIEW
in vec3 a_pos_3;in vec3 a_pos_normal_3;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_tile_id;uniform float u_zoom_transition;uniform vec3 u_up_dir;uniform float u_height_lift;
#endif
#ifdef TERRAIN
uniform int u_height_type;uniform int u_base_type;
#endif
out highp vec2 v_pos;out vec4 v_lighting;
#ifdef FAUX_AO
uniform lowp vec2 u_ao;out vec3 v_ao;
#endif
#ifdef LIGHTING_3D_MODE
out vec3 v_normal;
#endif
#pragma mapbox: define highp float base
#pragma mapbox: define highp float height
#pragma mapbox: define highp vec4 color
#pragma mapbox: define mediump vec4 pattern
#ifdef FILL_EXTRUSION_PATTERN_TRANSITION
#pragma mapbox: define mediump vec4 pattern_b
#endif
#pragma mapbox: define highp float pixel_ratio
#pragma mapbox: define highp float line_width
void main() {
#pragma mapbox: initialize highp float base
#pragma mapbox: initialize highp float height
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize mediump vec4 pattern
#ifdef FILL_EXTRUSION_PATTERN_TRANSITION
#pragma mapbox: initialize mediump vec4 pattern_b
#endif
#pragma mapbox: initialize highp float pixel_ratio
#pragma mapbox: initialize highp float line_width
vec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;vec4 pos_nx=floor(a_pos_normal_ed*0.5);mediump vec4 top_up_ny_start=a_pos_normal_ed-2.0*pos_nx;mediump vec3 top_up_ny=top_up_ny_start.xyz;float x_normal=pos_nx.z/8192.0;vec3 normal=top_up_ny.y==1.0 ? vec3(0.0,0.0,1.0) : normalize(vec3(x_normal,(2.0*top_up_ny.z-1.0)*(1.0-abs(x_normal)),0.0));float edgedistance=a_pos_normal_ed.w;vec2 display_size=(pattern_br-pattern_tl)/pixel_ratio;base=max(0.0,base);height=max(0.0,height);float t=top_up_ny.x;float z=t > 0.0 ? height : base;vec2 centroid_pos=vec2(0.0);
#if defined(HAS_CENTROID) || defined(TERRAIN)
centroid_pos=a_centroid_pos;
#endif
float ele=0.0;float h=z;vec3 p;float c_ele;
#ifdef TERRAIN
bool is_flat_height=centroid_pos.x !=0.0 && u_height_type==1;bool is_flat_base=centroid_pos.x !=0.0 && u_base_type==1;ele=elevation(pos_nx.xy);c_ele=is_flat_height || is_flat_base ? (centroid_pos.y==0.0 ? elevationFromUint16(centroid_pos.x) : flatElevation(centroid_pos)) : ele;float h_height=is_flat_height ? max(c_ele+height,ele+base+2.0) : ele+height;float h_base=is_flat_base ? max(c_ele+base,ele+base) : ele+(base==0.0 ?-5.0 : base);h=t > 0.0 ? max(h_base,h_height) : h_base;p=vec3(pos_nx.xy,h);
#else
p=vec3(pos_nx.xy,z);
#endif
#ifdef PROJECTION_GLOBE_VIEW
float lift=float((t+base) > 0.0)*u_height_lift;h+=lift;vec3 globe_normal=normalize(mix(a_pos_normal_3/16384.0,u_up_dir,u_zoom_transition));vec3 globe_pos=a_pos_3+globe_normal*(u_tile_up_scale*(p.z+lift));vec3 merc_pos=mercator_tile_position(u_inv_rot_matrix,p.xy,u_tile_id,u_merc_center)+u_up_dir*u_tile_up_scale*p.z;p=mix_globe_mercator(globe_pos,merc_pos,u_zoom_transition);
#endif
#ifdef RENDER_WALL_MODE
vec2 wall_offset=u_width_scale*line_width*(a_join_normal_inside.xy/EXTENT);p.xy+=(1.0-a_join_normal_inside.z)*wall_offset*0.5;p.xy-=a_join_normal_inside.z*wall_offset*0.5;
#endif
float hidden=float((centroid_pos.x==0.0 && centroid_pos.y==1.0) || (color.a==0.0));gl_Position=mix(u_matrix*vec4(p,1),AWAY,hidden);vec2 pos=normal.z==1.0
? pos_nx.xy
: vec2(edgedistance,z*u_height_factor);v_pos=get_pattern_pos(u_pixel_coord_upper,u_pixel_coord_lower,display_size,u_tile_units_to_pixels,pos);v_lighting=vec4(0.0,0.0,0.0,1.0);float NdotL=0.0;
#ifdef LIGHTING_3D_MODE
NdotL=calculate_NdotL(normal);
#else
NdotL=clamp(dot(normal,u_lightpos),0.0,1.0);NdotL=mix((1.0-u_lightintensity),max((0.5+u_lightintensity),1.0),NdotL);
#endif
if (normal.y !=0.0) {float r=0.84;
#ifndef LIGHTING_3D_MODE
r=mix(0.7,0.98,1.0-u_lightintensity);
#endif
NdotL*=(
(1.0-u_vertical_gradient)+(u_vertical_gradient*clamp((t+base)*pow(height/150.0,0.5),r,1.0)));}
#ifdef FAUX_AO
float concave=pos_nx.w-floor(pos_nx.w*0.5)*2.0;float start=top_up_ny_start.w;float y_ground=1.0-clamp(t+base,0.0,1.0);float top_height=height;
#ifdef TERRAIN
top_height=mix(max(c_ele+height,ele+base+2.0),ele+height,float(centroid_pos.x==0.0))-ele;y_ground+=y_ground*5.0/max(3.0,top_height);
#endif
v_ao=vec3(mix(concave,-concave,start),y_ground,h-ele);NdotL*=(1.0+0.05*(1.0-top_up_ny.y)*u_ao[0]);
#ifdef PROJECTION_GLOBE_VIEW
top_height+=u_height_lift;
#endif
gl_Position.z-=(0.0000006*(min(top_height,500.)+2.0*min(base,500.0)+60.0*concave+3.0*start))*gl_Position.w;
#endif
#ifdef LIGHTING_3D_MODE
v_normal=normal;
#else
v_lighting.rgb+=clamp(NdotL*u_lightcolor,mix(vec3(0.0),vec3(0.3),1.0-u_lightcolor),vec3(1.0));v_lighting*=u_opacity;
#endif
#ifdef FOG
v_fog_pos=fog_position(p);
#endif
}`),groundShadow:fn(`#include "_prelude_shadow.fragment.glsl"
precision highp float;uniform vec3 u_ground_shadow_factor;in vec4 v_pos_light_view_0;in vec4 v_pos_light_view_1;
#ifdef FOG
in float v_fog_opacity;
#endif
void main() {float light=shadowed_light_factor_plane_bias(v_pos_light_view_0,v_pos_light_view_1,1.0/gl_FragCoord.w);vec3 shadow=mix(u_ground_shadow_factor,vec3(1.0),light);
#ifdef RENDER_CUTOFF
shadow=mix(vec3(1.0),shadow,cutoff_opacity(u_cutoff_params,1.0/gl_FragCoord.w));
#endif
#ifdef FOG
shadow=mix(shadow,vec3(1.0),v_fog_opacity);
#endif
#ifdef INDICATOR_CUTOUT
shadow=mix(shadow,vec3(1.0),1.0-applyCutout(vec4(1.0),0.0).r);
#endif
glFragColor=vec4(shadow,1.0);}`,`#include "_prelude_fog.vertex.glsl"
uniform mat4 u_matrix;uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;in vec2 a_pos;out vec4 v_pos_light_view_0;out vec4 v_pos_light_view_1;
#ifdef FOG
out float v_fog_opacity;
#endif
void main() {gl_Position=u_matrix*vec4(a_pos,0.0,1.0);v_pos_light_view_0=u_light_matrix_0*vec4(a_pos,0.0,1.0);v_pos_light_view_1=u_light_matrix_1*vec4(a_pos,0.0,1.0);
#ifdef FOG
v_fog_pos=fog_position(a_pos);v_fog_opacity=fog(v_fog_pos);
#endif
}`),fillExtrusionGroundEffect:fn(`uniform highp float u_ao_pass;uniform highp float u_opacity;uniform highp float u_flood_light_intensity;uniform highp vec3 u_flood_light_color;uniform highp float u_attenuation;uniform sampler2D u_fb;uniform float u_fb_size;
#ifdef SDF_SUBPASS
in highp vec2 v_pos;in highp vec4 v_line_segment;in highp float v_flood_light_radius_tile;in highp vec2 v_ao;float line_df(highp vec2 a,highp vec2 b,highp vec2 p) {highp vec2 ba=b-a;highp vec2 pa=p-a;highp float r=clamp(dot(pa,ba)/dot(ba,ba),0.0,1.0);return length(pa-r*ba);}
#ifdef FOG
in highp float v_fog;
#endif
#endif
void main() {
#ifdef CLEAR_SUBPASS
vec4 color=vec4(1.0);
#ifdef CLEAR_FROM_TEXTURE
color=texture(u_fb,gl_FragCoord.xy/vec2(u_fb_size));
#endif
glFragColor=color;
#else
#ifdef SDF_SUBPASS
highp float d=line_df(v_line_segment.xy,v_line_segment.zw,v_pos);highp float effect_radius=mix(v_flood_light_radius_tile,v_ao.y,u_ao_pass);d/=effect_radius;d=min(d,1.0);d=1.0-pow(1.0-d,u_attenuation);highp float effect_intensity=mix(u_flood_light_intensity,v_ao.x,u_ao_pass);highp float fog=1.0;
#ifdef FOG
fog=v_fog;
#endif
#ifdef RENDER_CUTOFF
fog*=v_cutoff_opacity;
#endif
glFragColor=vec4(vec3(0.0),mix(1.0,d,effect_intensity*u_opacity*fog));
#else
vec4 color=mix(vec4(u_flood_light_color,1.0),vec4(vec3(0.0),1.0),u_ao_pass);
#ifdef OVERDRAW_INSPECTOR
color=vec4(1.0);
#endif
glFragColor=color;
#endif
HANDLE_WIREFRAME_DEBUG;
#endif
}`,`#include "_prelude_fog.vertex.glsl"
in highp vec4 a_pos_end;in highp float a_angular_offset_factor;in highp float a_hidden_by_landmark;
#ifdef SDF_SUBPASS
out highp vec2 v_pos;out highp vec4 v_line_segment;out highp float v_flood_light_radius_tile;out highp vec2 v_ao;
#ifdef FOG
out highp float v_fog;
#endif
#endif
uniform highp float u_flood_light_intensity;uniform highp mat4 u_matrix;uniform highp float u_ao_pass;uniform highp float u_meter_to_tile;uniform highp float u_edge_radius;uniform highp float u_dynamic_offset;uniform highp vec2 u_ao;
#pragma mapbox: define highp float flood_light_ground_radius
const float TANGENT_CUTOFF=4.0;const float NORM=32767.0;void main() {
#pragma mapbox: initialize highp float flood_light_ground_radius
vec2 p=a_pos_end.xy;vec2 q=floor(a_pos_end.zw*0.5);vec2 start_bottom=a_pos_end.zw-q*2.0;float fl_ground_radius=flood_light_ground_radius;fl_ground_radius=abs(flood_light_ground_radius);float direction=flood_light_ground_radius < 0.0 ?-1.0 : 1.0;float flood_radius_tile=fl_ground_radius*u_meter_to_tile;vec2 v=normalize(q-p);float ao_radius=u_ao.y/3.5;float effect_radius=mix(flood_radius_tile,ao_radius,u_ao_pass)+u_edge_radius;float angular_offset_factor=a_angular_offset_factor/NORM*TANGENT_CUTOFF;float angular_offset=direction*angular_offset_factor*effect_radius;float top=1.0-start_bottom.y;float side=(0.5-start_bottom.x)*2.0;vec2 extrusion_parallel=v*side*mix(u_dynamic_offset,angular_offset,top);vec2 perp=vec2(v.y,-v.x);vec2 extrusion_perp=direction*perp*effect_radius*top;vec3 pos=vec3(mix(q,p,start_bottom.x),0.0);pos.xy+=extrusion_parallel+extrusion_perp;
#ifdef SDF_SUBPASS
v_pos=pos.xy;v_line_segment=vec4(p,q)+perp.xyxy*u_edge_radius;v_flood_light_radius_tile=flood_radius_tile;v_ao=vec2(u_ao.x,ao_radius);
#ifdef FOG
v_fog_pos=fog_position(pos);v_fog=1.0-fog(v_fog_pos);
#endif
#endif
float hidden_by_landmark=0.0;
#ifdef HAS_CENTROID
hidden_by_landmark=a_hidden_by_landmark;
#endif
float isFloodlit=float(fl_ground_radius > 0.0 && u_flood_light_intensity > 0.0);float hidden=mix(1.0-isFloodlit,isFloodlit,u_ao_pass);hidden+=hidden_by_landmark;gl_Position=mix(u_matrix*vec4(pos,1.0),AWAY,float(hidden > 0.0));
#ifdef RENDER_CUTOFF
v_cutoff_opacity=cutoff_opacity(u_cutoff_params,gl_Position.z);
#endif
}`),hillshadePrepare:fn(`precision highp float;uniform sampler2D u_image;in vec2 v_pos;uniform vec2 u_dimension;uniform float u_zoom;float getElevation(vec2 coord) {return texture(u_image,coord).r/4.0;}void main() {vec2 epsilon=1.0/u_dimension;float a=getElevation(v_pos+vec2(-epsilon.x,-epsilon.y));float b=getElevation(v_pos+vec2(0,-epsilon.y));float c=getElevation(v_pos+vec2(epsilon.x,-epsilon.y));float d=getElevation(v_pos+vec2(-epsilon.x,0));float e=getElevation(v_pos+vec2(epsilon.x,0));float f=getElevation(v_pos+vec2(-epsilon.x,epsilon.y));float g=getElevation(v_pos+vec2(0,epsilon.y));float h=getElevation(v_pos+vec2(epsilon.x,epsilon.y));float exaggerationFactor=u_zoom < 2.0 ? 0.4 : u_zoom < 4.5 ? 0.35 : 0.3;float exaggeration=u_zoom < 15.0 ? (u_zoom-15.0)*exaggerationFactor : 0.0;vec2 deriv=vec2(
(c+e+e+h)-(a+d+d+f),(f+g+g+h)-(a+b+b+c)
)/pow(2.0,exaggeration+(19.2562-u_zoom));glFragColor=clamp(vec4(
deriv.x/2.0+0.5,deriv.y/2.0+0.5,1.0,1.0),0.0,1.0);}`,"uniform mat4 u_matrix;uniform vec2 u_dimension;in vec2 a_pos;in vec2 a_texture_pos;out vec2 v_pos;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);highp vec2 epsilon=1.0/u_dimension;float scale=(u_dimension.x-2.0)/u_dimension.x;v_pos=(a_texture_pos/8192.0)*scale+epsilon;}"),hillshade:fn(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
uniform sampler2D u_image;in vec2 v_pos;uniform vec2 u_latrange;uniform vec2 u_light;uniform vec4 u_shadow;uniform vec4 u_highlight;uniform vec4 u_accent;uniform float u_emissive_strength;void main() {vec4 pixel=texture(u_image,v_pos);vec2 deriv=((pixel.rg*2.0)-1.0);float scaleFactor=cos(radians((u_latrange[0]-u_latrange[1])*(1.0-v_pos.y)+u_latrange[1]));float slope=atan(1.25*length(deriv)/scaleFactor);float aspect=deriv.x !=0.0 ? atan(deriv.y,-deriv.x) : PI/2.0*(deriv.y > 0.0 ? 1.0 :-1.0);float intensity=u_light.x;float azimuth=u_light.y+PI;float base=1.875-intensity*1.75;float maxValue=0.5*PI;float scaledSlope=intensity !=0.5 ? ((pow(base,slope)-1.0)/(pow(base,maxValue)-1.0))*maxValue : slope;float accent=cos(scaledSlope);vec4 accent_color=(1.0-accent)*u_accent*clamp(intensity*2.0,0.0,1.0);float shade=abs(mod((aspect+azimuth)/PI+0.5,2.0)-1.0);vec4 shade_color=mix(u_shadow,u_highlight,shade)*sin(scaledSlope)*clamp(intensity*2.0,0.0,1.0);glFragColor=accent_color*(1.0-shade_color.a)+shade_color;
#ifdef LIGHTING_3D_MODE
glFragColor=apply_lighting_with_emission_ground(glFragColor,u_emissive_strength);
#endif
#ifdef FOG
glFragColor=fog_dither(fog_apply_premultiplied(glFragColor,v_fog_pos));
#endif
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
uniform mat4 u_matrix;in vec2 a_pos;in vec2 a_texture_pos;out vec2 v_pos;void main() {gl_Position=u_matrix*vec4(a_pos,0,1);v_pos=a_texture_pos/8192.0;
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
}`),line:fn(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
#include "_prelude_shadow.fragment.glsl"
uniform lowp float u_device_pixel_ratio;uniform highp float u_width_scale;uniform highp float u_floor_width_scale;uniform float u_alpha_discard_threshold;uniform highp vec2 u_trim_offset;uniform highp vec2 u_trim_fade_range;uniform lowp vec4 u_trim_color;in vec2 v_width2;in vec2 v_normal;in float v_gamma_scale;in highp vec3 v_uv;
#ifdef ELEVATED_ROADS
in highp float v_road_z_offset;
#endif
#ifdef RENDER_LINE_DASH
uniform sampler2D u_dash_image;in vec2 v_tex;
#endif
#ifdef RENDER_LINE_GRADIENT
uniform sampler2D u_gradient_image;
#endif
#ifdef INDICATOR_CUTOUT
in highp float v_z_offset;
#endif
#ifdef RENDER_SHADOWS
uniform vec3 u_ground_shadow_factor;in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in highp float v_depth;
#endif
float luminance(vec3 c) {return (c.r+c.r+c.b+c.g+c.g+c.g)*0.1667;}uniform float u_emissive_strength;
#pragma mapbox: define highp vec4 color
#pragma mapbox: define lowp float floorwidth
#pragma mapbox: define lowp vec4 dash
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp float border_width
#pragma mapbox: define lowp vec4 border_color
float linearstep(float edge0,float edge1,float x) {return  clamp((x-edge0)/(edge1-edge0),0.0,1.0);}void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize lowp float floorwidth
#pragma mapbox: initialize lowp vec4 dash
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize lowp float border_width
#pragma mapbox: initialize lowp vec4 border_color
float dist=length(v_normal)*v_width2.s;float blur2=(u_width_scale*blur+1.0/u_device_pixel_ratio)*v_gamma_scale;float alpha=clamp(min(dist-(v_width2.t-blur2),v_width2.s-dist)/blur2,0.0,1.0);
#ifdef RENDER_LINE_DASH
float sdfdist=texture(u_dash_image,v_tex).r;float sdfgamma=1.0/(2.0*u_device_pixel_ratio)/dash.z;float scaled_floorwidth=(floorwidth*u_floor_width_scale);alpha*=linearstep(0.5-sdfgamma/scaled_floorwidth,0.5+sdfgamma/scaled_floorwidth,sdfdist);
#endif
highp vec4 out_color;
#ifdef RENDER_LINE_GRADIENT
out_color=texture(u_gradient_image,v_uv.xy);
#else
out_color=color;
#endif
float trim_alpha=1.0;
#ifdef RENDER_LINE_TRIM_OFFSET
highp float trim_start=u_trim_offset[0];highp float trim_end=u_trim_offset[1];highp float line_progress=v_uv[2];if (trim_end > trim_start) {highp float start_transition=max(0.0,min(1.0,(line_progress-trim_start)/max(u_trim_fade_range[0],1.0e-9)));highp float end_transition=max(0.0,min(1.0,(trim_end-line_progress)/max(u_trim_fade_range[1],1.0e-9)));highp float transition_factor=min(start_transition,end_transition);out_color=mix(out_color,u_trim_color,transition_factor);trim_alpha=1.0-transition_factor;}
#endif
if (u_alpha_discard_threshold !=0.0) {if (alpha < u_alpha_discard_threshold) {discard;}}
#ifdef RENDER_LINE_BORDER
float edgeBlur=((border_width*u_width_scale)+1.0/u_device_pixel_ratio);float alpha2=clamp(min(dist-(v_width2.t-edgeBlur),v_width2.s-dist)/edgeBlur,0.0,1.0);if (alpha2 < 1.) {float smoothAlpha=smoothstep(0.6,1.0,alpha2);if (border_color.a==0.0) {float Y=(out_color.a > 0.01) ? luminance(out_color.rgb/out_color.a) : 1.;float adjustment=(Y > 0.) ? 0.5/Y : 0.45;if (out_color.a > 0.25 && Y < 0.25) {vec3 borderColor=(Y > 0.) ? out_color.rgb : vec3(1,1,1)*out_color.a;out_color.rgb=out_color.rgb+borderColor*(adjustment*(1.0-smoothAlpha));} else {out_color.rgb*=(0.6 +0.4*smoothAlpha);}} else {out_color=mix(border_color*trim_alpha,out_color,smoothAlpha);}}
#endif
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting_with_emission_ground(out_color,u_emissive_strength);
#ifdef RENDER_SHADOWS
float light=shadowed_light_factor(v_pos_light_view_0,v_pos_light_view_1,v_depth);
#ifdef ELEVATED_ROADS
out_color.rgb*=mix(v_road_z_offset !=0.0 ? u_ground_shadow_factor : vec3(1.0),vec3(1.0),light);
#else
out_color.rgb*=mix(u_ground_shadow_factor,vec3(1.0),light);
#endif
#endif
#endif
#ifdef FOG
out_color=fog_dither(fog_apply_premultiplied(out_color,v_fog_pos));
#endif
out_color*=(alpha*opacity);
#ifdef INDICATOR_CUTOUT
out_color=applyCutout(out_color,v_z_offset);
#endif
#ifdef FEATURE_CUTOUT
out_color=apply_feature_cutout(out_color,gl_FragCoord);
#endif
glFragColor=out_color;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_shadow.vertex.glsl"
#include "_prelude_terrain.vertex.glsl"
#define EXTRUDE_SCALE 0.015873016
in vec2 a_pos_normal;in vec4 a_data;
#if defined(ELEVATED) || defined(ELEVATED_ROADS) || defined(VARIABLE_LINE_WIDTH)
in vec3 a_z_offset_width;
#endif
#if defined(RENDER_LINE_GRADIENT) || defined(RENDER_LINE_TRIM_OFFSET)
in highp vec3 a_packed;
#endif
#ifdef RENDER_LINE_DASH
in float a_linesofar;
#endif
uniform mat4 u_matrix;uniform mat2 u_pixels_to_tile_units;uniform vec2 u_units_to_pixels;uniform lowp float u_device_pixel_ratio;uniform float u_width_scale;uniform highp float u_floor_width_scale;
#ifdef ELEVATED
uniform lowp float u_zbias_factor;uniform lowp float u_tile_to_meter;float sample_elevation(vec2 apos) {
#ifdef ELEVATION_REFERENCE_SEA
return 0.0;
#else
return elevation(apos);
#endif
}
#endif
out vec2 v_normal;out vec2 v_width2;out float v_gamma_scale;out highp vec3 v_uv;
#ifdef ELEVATED_ROADS
out highp float v_road_z_offset;
#endif
#ifdef RENDER_LINE_DASH
uniform vec2 u_texsize;uniform float u_tile_units_to_pixels;out vec2 v_tex;
#endif
#ifdef RENDER_LINE_GRADIENT
uniform float u_image_height;
#endif
#ifdef INDICATOR_CUTOUT
out highp float v_z_offset;
#endif
#ifdef RENDER_SHADOWS
uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out highp float v_depth;
#endif
#pragma mapbox: define highp vec4 color
#pragma mapbox: define lowp float floorwidth
#pragma mapbox: define lowp vec4 dash
#pragma mapbox: define lowp float blur
#pragma mapbox: define lowp float opacity
#pragma mapbox: define mediump float gapwidth
#pragma mapbox: define lowp float offset
#pragma mapbox: define mediump float width
#pragma mapbox: define lowp float border_width
#pragma mapbox: define lowp vec4 border_color
void main() {
#pragma mapbox: initialize highp vec4 color
#pragma mapbox: initialize lowp float floorwidth
#pragma mapbox: initialize lowp vec4 dash
#pragma mapbox: initialize lowp float blur
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize mediump float gapwidth
#pragma mapbox: initialize lowp float offset
#pragma mapbox: initialize mediump float width
#pragma mapbox: initialize lowp float border_width
#pragma mapbox: initialize lowp vec4 border_color
float a_z_offset;
#if defined(ELEVATED) || defined(ELEVATED_ROADS)
a_z_offset=a_z_offset_width.x;
#endif
float ANTIALIASING=1.0/u_device_pixel_ratio/2.0;vec2 a_extrude=a_data.xy-128.0;float a_direction=mod(a_data.z,4.0)-1.0;vec2 pos=floor(a_pos_normal*0.5);mediump vec2 normal=a_pos_normal-2.0*pos;normal.y=normal.y*2.0-1.0;v_normal=normal;gapwidth=gapwidth/2.0;float halfwidth;
#ifdef VARIABLE_LINE_WIDTH
float left=a_pos_normal.y-2.0*floor(a_pos_normal.y*0.5);halfwidth=(u_width_scale*(left==1.0 ? a_z_offset_width.y : a_z_offset_width.z))/2.0;
#else
halfwidth=(u_width_scale*width)/2.0;
#endif
offset=-1.0*offset*u_width_scale;float inset=gapwidth+(gapwidth > 0.0 ? ANTIALIASING : 0.0);float outset=gapwidth+halfwidth*(gapwidth > 0.0 ? 2.0 : 1.0)+(halfwidth==0.0 ? 0.0 : ANTIALIASING);mediump vec2 dist=outset*a_extrude*EXTRUDE_SCALE;mediump float u=0.5*a_direction;mediump float t=1.0-abs(u);mediump vec2 offset2=offset*a_extrude*EXTRUDE_SCALE*normal.y*mat2(t,-u,u,t);float hidden=float(opacity==0.0);vec2 extrude=dist*u_pixels_to_tile_units;vec4 projected_extrude=u_matrix*vec4(extrude,0.0,0.0);vec2 projected_extrude_xy=projected_extrude.xy;
#ifdef ELEVATED_ROADS
v_road_z_offset=a_z_offset;gl_Position=u_matrix*vec4(pos+offset2*u_pixels_to_tile_units,a_z_offset,1.0)+projected_extrude;
#else
#ifdef ELEVATED
vec2 offsetTile=offset2*u_pixels_to_tile_units;vec2 offset_pos=pos+offsetTile;float ele=0.0;
#ifdef CROSS_SLOPE_VERTICAL
float top=a_pos_normal.y-2.0*floor(a_pos_normal.y*0.5);float line_height=2.0*u_tile_to_meter*outset*top*u_pixels_to_tile_units[1][1]+a_z_offset;ele=sample_elevation(offset_pos)+line_height;projected_extrude=vec4(0);
#else
#ifdef CROSS_SLOPE_HORIZONTAL
float ele0=sample_elevation(offset_pos);float ele1=max(sample_elevation(offset_pos+extrude),sample_elevation(offset_pos+extrude/2.0));float ele2=max(sample_elevation(offset_pos-extrude),sample_elevation(offset_pos-extrude/2.0));float ele_max=max(ele0,max(ele1,ele2));ele=ele_max+a_z_offset;
#else
float ele0=sample_elevation(offset_pos);float ele1=max(sample_elevation(offset_pos+extrude),sample_elevation(offset_pos+extrude/2.0));float ele2=max(sample_elevation(offset_pos-extrude),sample_elevation(offset_pos-extrude/2.0));float ele_max=max(ele0,0.5*(ele1+ele2));ele=ele_max-ele0+ele1+a_z_offset;
#endif
#endif
gl_Position=u_matrix*vec4(offset_pos,ele,1.0)+projected_extrude;float z=clamp(gl_Position.z/gl_Position.w,0.5,1.0);float zbias=max(0.00005,(pow(z,0.8)-z)*u_zbias_factor*u_exaggeration);gl_Position.z-=(gl_Position.w*zbias);gl_Position=mix(gl_Position,AWAY,hidden);
#else
gl_Position=mix(u_matrix*vec4(pos+offset2*u_pixels_to_tile_units,0.0,1.0)+projected_extrude,AWAY,hidden);
#endif
#endif
#ifdef ELEVATED_ROADS
#ifdef RENDER_SHADOWS
vec3 shd_pos=vec3(pos+(offset2+dist)*u_pixels_to_tile_units,a_z_offset);vec3 shd_pos0=shd_pos;vec3 shd_pos1=shd_pos;
#ifdef NORMAL_OFFSET
vec3 shd_pos_offset=shadow_normal_offset(vec3(0.0,0.0,1.0));shd_pos0+=shd_pos_offset*shadow_normal_offset_multiplier0();shd_pos1+=shd_pos_offset*shadow_normal_offset_multiplier1();
#endif
v_pos_light_view_0=u_light_matrix_0*vec4(shd_pos0,1);v_pos_light_view_1=u_light_matrix_1*vec4(shd_pos1,1);v_depth=gl_Position.w;
#endif
#endif
#ifndef RENDER_TO_TEXTURE
float epsilon=0.0001;float extrude_length_without_perspective=max(length(dist),epsilon);float extrude_length_with_perspective=max(length(projected_extrude_xy/gl_Position.w*u_units_to_pixels),epsilon);v_gamma_scale=mix(extrude_length_without_perspective/extrude_length_with_perspective,1.0,step(0.01,blur));
#else
v_gamma_scale=1.0;
#endif
#if defined(RENDER_LINE_GRADIENT) || defined(RENDER_LINE_TRIM_OFFSET)
highp float a_uv_x=a_packed[0];float a_split_index=a_packed[1];highp float line_progress=a_packed[2];
#ifdef RENDER_LINE_GRADIENT
highp float texel_height=1.0/u_image_height;highp float half_texel_height=0.5*texel_height;v_uv=vec3(a_uv_x,a_split_index*texel_height-half_texel_height,line_progress);
#else
v_uv=vec3(a_uv_x,0.0,line_progress);
#endif
#endif
#ifdef RENDER_LINE_DASH
float scale=dash.z==0.0 ? 0.0 : u_tile_units_to_pixels/dash.z;float height=dash.y;v_tex=vec2(a_linesofar*scale/(floorwidth*u_floor_width_scale),(-normal.y*height+dash.x+0.5)/u_texsize.y);
#endif
v_width2=vec2(outset,inset);
#ifdef FOG
v_fog_pos=fog_position(pos);
#endif
#ifdef INDICATOR_CUTOUT
v_z_offset=a_z_offset;
#endif
}`),linePattern:fn(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
#include "_prelude_shadow.fragment.glsl"
uniform highp float u_device_pixel_ratio;uniform highp float u_width_scale;uniform highp float u_alpha_discard_threshold;uniform highp vec2 u_texsize;uniform highp float u_tile_units_to_pixels;uniform highp vec2 u_trim_offset;uniform highp vec2 u_trim_fade_range;uniform lowp vec4 u_trim_color;uniform sampler2D u_image;
#ifdef LINE_PATTERN_TRANSITION
uniform float u_pattern_transition;
#endif
in vec2 v_normal;in vec2 v_width2;in highp float v_linesofar;in float v_gamma_scale;in float v_width;
#ifdef RENDER_LINE_TRIM_OFFSET
in highp vec3 v_uv;
#endif
#ifdef ELEVATED_ROADS
in highp float v_road_z_offset;
#endif
#ifdef LINE_JOIN_NONE
in vec2 v_pattern_data;
#endif
#ifdef INDICATOR_CUTOUT
in highp float v_z_offset;
#endif
#ifdef RENDER_SHADOWS
uniform vec3 u_ground_shadow_factor;in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in highp float v_depth;
#endif
uniform float u_emissive_strength;
#pragma mapbox: define mediump vec4 pattern
#ifdef LINE_PATTERN_TRANSITION
#pragma mapbox: define mediump vec4 pattern_b
#endif
#pragma mapbox: define mediump float pixel_ratio
#pragma mapbox: define mediump float blur
#pragma mapbox: define mediump float opacity
void main() {
#pragma mapbox: initialize mediump vec4 pattern
#ifdef LINE_PATTERN_TRANSITION
#pragma mapbox: initialize mediump vec4 pattern_b
#endif
#pragma mapbox: initialize mediump float pixel_ratio
#pragma mapbox: initialize mediump float blur
#pragma mapbox: initialize mediump float opacity
vec2 pattern_tl=pattern.xy;vec2 pattern_br=pattern.zw;vec2 display_size=(pattern_br-pattern_tl)/pixel_ratio;highp float pattern_size=display_size.x/u_tile_units_to_pixels;float aspect=display_size.y/v_width;float dist=length(v_normal)*v_width2.s;float blur2=(u_width_scale*blur+1.0/u_device_pixel_ratio)*v_gamma_scale;float alpha=clamp(min(dist-(v_width2.t-blur2),v_width2.s-dist)/blur2,0.0,1.0);highp float pattern_x=v_linesofar/pattern_size*aspect;highp float x=mod(pattern_x,1.0);highp float y=0.5*v_normal.y+0.5;vec2 texel_size=1.0/u_texsize;highp vec2 pos=mix(pattern_tl*texel_size-texel_size,pattern_br*texel_size+texel_size,vec2(x,y));highp vec2 lod_pos=mix(pattern_tl*texel_size-texel_size,pattern_br*texel_size+texel_size,vec2(pattern_x,y));vec4 color=textureLodCustom(u_image,pos,lod_pos);
#ifdef LINE_PATTERN_TRANSITION
vec2 pattern_b_tl=pattern_b.xy;vec2 pattern_b_br=pattern_b.zw;highp vec2 pos_b=mix(pattern_b_tl*texel_size-texel_size,pattern_b_br*texel_size+texel_size,vec2(x,y));vec4 color_b=textureLodCustom(u_image,pos_b,lod_pos);color=color*(1.0-u_pattern_transition)+color_b*u_pattern_transition;
#endif
#ifdef RENDER_LINE_TRIM_OFFSET
highp float trim_start=u_trim_offset[0];highp float trim_end=u_trim_offset[1];highp float line_progress=v_uv[2];if (trim_end > trim_start) {highp float start_transition=max(0.0,min(1.0,(line_progress-trim_start)/max(u_trim_fade_range[0],1.0e-9)));highp float end_transition=max(0.0,min(1.0,(trim_end-line_progress)/max(u_trim_fade_range[1],1.0e-9)));highp float transition_factor=min(start_transition,end_transition);color=mix(color,color.a*u_trim_color,transition_factor);}
#endif
#ifdef LINE_JOIN_NONE
highp float pattern_len=pattern_size/aspect;highp float segment_phase=pattern_len-mod(v_linesofar-v_pattern_data.x+pattern_len,pattern_len);highp float visible_start=segment_phase-step(pattern_len*0.5,segment_phase)*pattern_len;highp float visible_end=floor((v_pattern_data.y-segment_phase)/pattern_len)*pattern_len+segment_phase;visible_end+=step(pattern_len*0.5,v_pattern_data.y-visible_end)*pattern_len;if (v_pattern_data.x < visible_start || v_pattern_data.x >=visible_end) {color=vec4(0.0);}
#endif
#ifdef LIGHTING_3D_MODE
color=apply_lighting_with_emission_ground(color,u_emissive_strength);
#ifdef RENDER_SHADOWS
float light=shadowed_light_factor(v_pos_light_view_0,v_pos_light_view_1,v_depth);
#ifdef ELEVATED_ROADS
color.rgb*=mix(v_road_z_offset !=0.0 ? u_ground_shadow_factor : vec3(1.0),vec3(1.0),light);
#else
color.rgb*=mix(u_ground_shadow_factor,vec3(1.0),light);
#endif
#endif
#endif
#ifdef FOG
color=fog_dither(fog_apply_premultiplied(color,v_fog_pos));
#endif
color*=(alpha*opacity);if (u_alpha_discard_threshold !=0.0) {if (color.a < u_alpha_discard_threshold) {discard;}}
#ifdef INDICATOR_CUTOUT
color=applyCutout(color,v_z_offset);
#endif
glFragColor=color;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_shadow.vertex.glsl"
#include "_prelude_terrain.vertex.glsl"
#define scale 0.015873016
in vec2 a_pos_normal;in vec4 a_data;
#if defined(ELEVATED) || defined(ELEVATED_ROADS)
in vec3 a_z_offset_width;
#endif
#ifdef RENDER_LINE_TRIM_OFFSET
in highp vec3 a_packed;
#endif
in highp float a_linesofar;
#ifdef LINE_JOIN_NONE
in highp vec3 a_pattern_data;out vec2 v_pattern_data;
#endif
#ifdef INDICATOR_CUTOUT
out highp float v_z_offset;
#endif
uniform mat4 u_matrix;uniform float u_tile_units_to_pixels;uniform vec2 u_units_to_pixels;uniform mat2 u_pixels_to_tile_units;uniform float u_device_pixel_ratio;uniform float u_width_scale;uniform float u_floor_width_scale;
#ifdef ELEVATED
uniform lowp float u_zbias_factor;uniform lowp float u_tile_to_meter;float sample_elevation(vec2 apos) {
#ifdef ELEVATION_REFERENCE_SEA
return 0.0;
#else
return elevation(apos);
#endif
}
#endif
out vec2 v_normal;out vec2 v_width2;out highp float v_linesofar;out float v_gamma_scale;out float v_width;
#ifdef RENDER_LINE_TRIM_OFFSET
out highp vec3 v_uv;
#endif
#ifdef ELEVATED_ROADS
out highp float v_road_z_offset;
#endif
#ifdef RENDER_SHADOWS
uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out highp float v_depth;
#endif
#pragma mapbox: define mediump float blur
#pragma mapbox: define mediump float opacity
#pragma mapbox: define mediump float offset
#pragma mapbox: define mediump float gapwidth
#pragma mapbox: define mediump float width
#pragma mapbox: define mediump float floorwidth
#pragma mapbox: define mediump vec4 pattern
#ifdef LINE_PATTERN_TRANSITION
#pragma mapbox: define mediump vec4 pattern_b
#endif
#pragma mapbox: define mediump float pixel_ratio
void main() {
#pragma mapbox: initialize mediump float blur
#pragma mapbox: initialize mediump float opacity
#pragma mapbox: initialize mediump float offset
#pragma mapbox: initialize mediump float gapwidth
#pragma mapbox: initialize mediump float width
#pragma mapbox: initialize mediump float floorwidth
#pragma mapbox: initialize mediump vec4 pattern
#ifdef LINE_PATTERN_TRANSITION
#pragma mapbox: initialize mediump vec4 pattern_b
#endif
#pragma mapbox: initialize mediump float pixel_ratio
float a_z_offset;
#if defined(ELEVATED) || defined(ELEVATED_ROADS)
a_z_offset=a_z_offset_width.x;
#endif
float ANTIALIASING=1.0/u_device_pixel_ratio/2.0;vec2 a_extrude=a_data.xy-128.0;float a_direction=mod(a_data.z,4.0)-1.0;vec2 pos=floor(a_pos_normal*0.5);vec2 normal=a_pos_normal-2.0*pos;normal.y=normal.y*2.0-1.0;v_normal=normal;gapwidth=gapwidth/2.0;float halfwidth=(u_width_scale*width)/2.0;offset=-1.0*offset*u_width_scale;float inset=gapwidth+(gapwidth > 0.0 ? ANTIALIASING : 0.0);float outset=gapwidth+halfwidth*(gapwidth > 0.0 ? 2.0 : 1.0)+(halfwidth==0.0 ? 0.0 : ANTIALIASING);vec2 dist=outset*a_extrude*scale;float u=0.5*a_direction;float t=1.0-abs(u);vec2 offset2=offset*a_extrude*scale*normal.y*mat2(t,-u,u,t);float hidden=float(opacity==0.0);vec2 extrude=dist*u_pixels_to_tile_units;vec4 projected_extrude=u_matrix*vec4(extrude,0.0,0.0);vec2 projected_extrude_xy=projected_extrude.xy;
#ifdef ELEVATED_ROADS
v_road_z_offset=a_z_offset;gl_Position=u_matrix*vec4(pos+offset2*u_pixels_to_tile_units,a_z_offset,1.0)+projected_extrude;
#else
#ifdef ELEVATED
vec2 offsetTile=offset2*u_pixels_to_tile_units;vec2 offset_pos=pos+offsetTile;float ele=0.0;
#ifdef CROSS_SLOPE_VERTICAL
float top=a_pos_normal.y-2.0*floor(a_pos_normal.y*0.5);float line_height=2.0*u_tile_to_meter*outset*top*u_pixels_to_tile_units[1][1]+a_z_offset;ele=sample_elevation(offset_pos)+line_height;projected_extrude=vec4(0);
#else
#ifdef CROSS_SLOPE_HORIZONTAL
float ele0=sample_elevation(offset_pos);float ele1=max(sample_elevation(offset_pos+extrude),sample_elevation(offset_pos+extrude/2.0));float ele2=max(sample_elevation(offset_pos-extrude),sample_elevation(offset_pos-extrude/2.0));float ele_max=max(ele0,max(ele1,ele2));ele=ele_max+a_z_offset;
#else
float ele0=sample_elevation(offset_pos);float ele1=max(sample_elevation(offset_pos+extrude),sample_elevation(offset_pos+extrude/2.0));float ele2=max(sample_elevation(offset_pos-extrude),sample_elevation(offset_pos-extrude/2.0));float ele_max=max(ele0,0.5*(ele1+ele2));ele=ele_max-ele0+ele1+a_z_offset;
#endif
#endif
gl_Position=u_matrix*vec4(offset_pos,ele,1.0)+projected_extrude;float z=clamp(gl_Position.z/gl_Position.w,0.5,1.0);float zbias=max(0.00005,(pow(z,0.8)-z)*u_zbias_factor*u_exaggeration);gl_Position.z-=(gl_Position.w*zbias);gl_Position=mix(gl_Position,AWAY,hidden);
#else
gl_Position=mix(u_matrix*vec4(pos+offset2*u_pixels_to_tile_units,0.0,1.0)+projected_extrude,AWAY,hidden);
#endif
#endif
#ifdef ELEVATED_ROADS
#ifdef RENDER_SHADOWS
vec3 shd_pos=vec3(pos+(offset2+dist)*u_pixels_to_tile_units,a_z_offset);vec3 shd_pos0=shd_pos;vec3 shd_pos1=shd_pos;
#ifdef NORMAL_OFFSET
vec3 shd_pos_offset=shadow_normal_offset(vec3(0.0,0.0,1.0));shd_pos0+=shd_pos_offset*shadow_normal_offset_multiplier0();shd_pos1+=shd_pos_offset*shadow_normal_offset_multiplier1();
#endif
v_pos_light_view_0=u_light_matrix_0*vec4(shd_pos0,1);v_pos_light_view_1=u_light_matrix_1*vec4(shd_pos1,1);v_depth=gl_Position.w;
#endif
#endif
#ifndef RENDER_TO_TEXTURE
float extrude_length_without_perspective=length(dist);float extrude_length_with_perspective=length(projected_extrude_xy/gl_Position.w*u_units_to_pixels);v_gamma_scale=mix(extrude_length_without_perspective/extrude_length_with_perspective,1.0,step(0.01,blur));
#else
v_gamma_scale=1.0;
#endif
#ifdef RENDER_LINE_TRIM_OFFSET
highp float a_uv_x=a_packed[0];highp float line_progress=a_packed[2];v_uv=vec3(a_uv_x,0.0,line_progress);
#endif
v_linesofar=a_linesofar;v_width2=vec2(outset,inset);v_width=(floorwidth*u_floor_width_scale);
#ifdef LINE_JOIN_NONE
v_width=(floorwidth*u_floor_width_scale)+ANTIALIASING;mediump float pixels_to_tile_units=1.0/u_tile_units_to_pixels;mediump float pixel_ratio_inverse=1.0/pixel_ratio;mediump float aspect=v_width/((pattern.w-pattern.y)*pixel_ratio_inverse);highp float subt_multiple=(pattern.z-pattern.x)*pixel_ratio_inverse*pixels_to_tile_units*aspect*32.0;highp float subt=floor(a_pattern_data.z/subt_multiple)*subt_multiple;float offset_sign=(fract(a_pattern_data.x)-0.5)*4.0;float line_progress_offset=offset_sign*v_width*0.5*pixels_to_tile_units;v_linesofar=(a_pattern_data.z-subt)+a_linesofar+line_progress_offset;v_pattern_data=vec2(a_pattern_data.x+line_progress_offset,a_pattern_data.y);
#endif
#ifdef FOG
v_fog_pos=fog_position(pos);
#endif
#ifdef INDICATOR_CUTOUT
v_z_offset=a_z_offset;
#endif
}`),raster:fn(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
#include "_prelude_raster_array.glsl"
uniform float u_fade_t;uniform float u_opacity;uniform highp float u_raster_elevation;uniform highp float u_zoom_transition;in vec2 v_pos0;in vec2 v_pos1;in float v_depth;
#ifdef PROJECTION_GLOBE_VIEW
in float v_split_fade;
#endif
uniform float u_brightness_low;uniform float u_brightness_high;uniform float u_saturation_factor;uniform float u_contrast_factor;uniform vec3 u_spin_weights;uniform float u_emissive_strength;
#ifndef RASTER_ARRAY
uniform highp sampler2D u_image0;uniform sampler2D u_image1;
#endif
#ifdef RASTER_COLOR
uniform sampler2D u_color_ramp;uniform highp vec4 u_colorization_mix;uniform highp float u_colorization_offset;uniform vec2 u_texture_res;
#endif
void main() {vec4 color0,color1,color;vec2 value;
#ifdef RASTER_COLOR
#ifdef RASTER_ARRAY
#ifdef RASTER_ARRAY_LINEAR
value=mix(
raTexture2D_image0_linear(v_pos0,u_texture_res,u_colorization_mix,u_colorization_offset),raTexture2D_image1_linear(v_pos1,u_texture_res,u_colorization_mix,u_colorization_offset),u_fade_t
);
#else
value=mix(
raTexture2D_image0_nearest(v_pos0,u_texture_res,u_colorization_mix,u_colorization_offset),raTexture2D_image1_nearest(v_pos1,u_texture_res,u_colorization_mix,u_colorization_offset),u_fade_t
);
#endif
if (value.y > 0.0) value.x/=value.y;
#else
color=mix(texture(u_image0,v_pos0),texture(u_image1,v_pos1),u_fade_t);value=vec2(u_colorization_offset+dot(color.rgb,u_colorization_mix.rgb),color.a);
#endif
color=texture(u_color_ramp,vec2(value.x,0.5));if (color.a > 0.0) color.rgb/=color.a;color.a*=value.y;
#else
color0=texture(u_image0,v_pos0);color1=texture(u_image1,v_pos1);if (color0.a > 0.0) color0.rgb/=color0.a;if (color1.a > 0.0) color1.rgb/=color1.a;color=mix(color0,color1,u_fade_t);
#endif
color.a*=u_opacity;
#ifdef GLOBE_POLES
color.a*=1.0-smoothstep(0.0,0.05,u_zoom_transition);
#endif
vec3 rgb=color.rgb;rgb=vec3(
dot(rgb,u_spin_weights.xyz),dot(rgb,u_spin_weights.zxy),dot(rgb,u_spin_weights.yzx));float average=(color.r+color.g+color.b)/3.0;rgb+=(average-rgb)*u_saturation_factor;rgb=(rgb-0.5)*u_contrast_factor+0.5;vec3 u_high_vec=vec3(u_brightness_low,u_brightness_low,u_brightness_low);vec3 u_low_vec=vec3(u_brightness_high,u_brightness_high,u_brightness_high);vec3 out_color=mix(u_high_vec,u_low_vec,rgb);
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting_with_emission_ground(vec4(out_color,1.0),u_emissive_strength).rgb;
#endif
#ifdef FOG
highp float fog_limit_high_meters=1000000.0;highp float fog_limit_low_meters=600000.0;float fog_limit=1.0-smoothstep(fog_limit_low_meters,fog_limit_high_meters,u_raster_elevation);out_color=fog_dither(fog_apply(out_color,v_fog_pos,fog_limit));
#endif
glFragColor=vec4(out_color*color.a,color.a);
#ifdef PROJECTION_GLOBE_VIEW
glFragColor*=mix(1.0,1.0-smoothstep(0.0,0.05,u_zoom_transition),smoothstep(0.8,0.9,v_split_fade));
#endif
#ifdef RENDER_CUTOFF
glFragColor=glFragColor*cutoff_opacity(u_cutoff_params,v_depth);
#endif
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
uniform mat4 u_matrix;uniform mat4 u_normalize_matrix;uniform mat4 u_globe_matrix;uniform mat4 u_merc_matrix;uniform mat3 u_grid_matrix;uniform vec2 u_tl_parent;uniform float u_scale_parent;uniform vec2 u_perspective_transform;uniform vec2 u_texture_offset;uniform float u_raster_elevation;uniform float u_zoom_transition;uniform vec2 u_merc_center;
#define GLOBE_UPSCALE GLOBE_RADIUS/6371008.8
#ifdef GLOBE_POLES
in vec3 a_globe_pos;in vec2 a_uv;
#else
in vec2 a_pos;in vec2 a_texture_pos;
#endif
out vec2 v_pos0;out vec2 v_pos1;out float v_depth;
#ifdef PROJECTION_GLOBE_VIEW
out float v_split_fade;
#endif
void main() {vec2 uv;
#ifdef GLOBE_POLES
vec3 globe_pos=a_globe_pos;globe_pos+=normalize(globe_pos)*u_raster_elevation*GLOBE_UPSCALE;gl_Position=u_matrix*u_globe_matrix*vec4(globe_pos   ,1.0);uv=a_uv;
#ifdef FOG
v_fog_pos=fog_position((u_normalize_matrix*vec4(a_globe_pos,1.0)).xyz);
#endif
#else
float w=1.0+dot(a_texture_pos,u_perspective_transform);uv=a_texture_pos/8192.0;
#ifdef PROJECTION_GLOBE_VIEW
vec3 decomposed_pos_and_skirt=decomposeToPosAndSkirt(a_pos);vec3 latLng=u_grid_matrix*vec3(decomposed_pos_and_skirt.xy,1.0);vec3 globe_pos=latLngToECEF(latLng.xy);globe_pos+=normalize(globe_pos)*u_raster_elevation*GLOBE_UPSCALE;vec4 globe_world_pos=u_globe_matrix*vec4(globe_pos,1.0);vec4 merc_world_pos=vec4(0.0);float mercatorY=mercatorYfromLat(latLng[0]);float mercatorX=mercatorXfromLng(latLng[1]);    
v_split_fade=0.0;if (u_zoom_transition > 0.0) {vec2 merc_pos=vec2(mercatorX,mercatorY);merc_world_pos=vec4(merc_pos,u_raster_elevation,1.0);merc_world_pos.xy-=u_merc_center;merc_world_pos.x=wrap(merc_world_pos.x,-0.5,0.5);merc_world_pos=u_merc_matrix*merc_world_pos;float opposite_merc_center=mod(u_merc_center.x+0.5,1.0);float dist_from_poles=(abs(mercatorY-0.5)*2.0);float range=0.1;v_split_fade=abs(opposite_merc_center-mercatorX);v_split_fade=clamp(1.0-v_split_fade,0.0,1.0);v_split_fade=max(smoothstep(1.0-range,1.0,dist_from_poles),max(smoothstep(1.0-range,1.0,v_split_fade),smoothstep(1.0-range,1.0,1.0-v_split_fade)));}float tiles=u_grid_matrix[0][2];if (tiles > 0.0) {float idx=u_grid_matrix[1][2];float idy=u_grid_matrix[2][2];float uvY=mercatorY*tiles-idy;float uvX=mercatorX*tiles-idx;uv=vec2(uvX,uvY);}vec4 interpolated_pos=vec4(mix(globe_world_pos.xyz,merc_world_pos.xyz,u_zoom_transition)*w,w);gl_Position=u_matrix*interpolated_pos;
#ifdef FOG
v_fog_pos=fog_position((u_normalize_matrix*vec4(globe_pos,1.0)).xyz);
#endif
#else
gl_Position=u_matrix*vec4(a_pos*w,u_raster_elevation*w,w);
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
#endif
#endif
v_pos0=uv;v_pos1=(v_pos0*u_scale_parent)+u_tl_parent;v_pos0=u_texture_offset.x+u_texture_offset.y*v_pos0;v_pos1=u_texture_offset.x+u_texture_offset.y*v_pos1;
#ifdef RENDER_CUTOFF
v_depth=gl_Position.z;
#endif
}`),rasterParticle:fn(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
uniform float u_fade_t;uniform float u_opacity;uniform highp float u_raster_elevation;in vec2 v_pos0;in vec2 v_pos1;uniform sampler2D u_image0;uniform sampler2D u_image1;void main() {vec4 color0,color1,color;color0=texture(u_image0,v_pos0);color1=texture(u_image1,v_pos1);if (color0.a > 0.0) color0.rgb/=color0.a;if (color1.a > 0.0) color1.rgb/=color1.a;color=mix(color0,color1,u_fade_t);color.a*=u_opacity;vec3 out_color=color.rgb;
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting_with_emission_ground(vec4(out_color,1.0),0.0).rgb;
#endif
#ifdef FOG
highp float fog_limit_high_meters=1000000.0;highp float fog_limit_low_meters=600000.0;float fog_limit=1.0-smoothstep(fog_limit_low_meters,fog_limit_high_meters,u_raster_elevation);out_color=fog_dither(fog_apply(out_color,v_fog_pos,fog_limit));
#endif
glFragColor=vec4(out_color*color.a,color.a);
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
uniform mat4 u_matrix;uniform mat4 u_normalize_matrix;uniform mat4 u_globe_matrix;uniform mat4 u_merc_matrix;uniform mat3 u_grid_matrix;uniform vec2 u_tl_parent;uniform float u_scale_parent;uniform float u_raster_elevation;uniform float u_zoom_transition;uniform vec2 u_merc_center;
#define GLOBE_UPSCALE GLOBE_RADIUS/6371008.8
in vec2 a_pos;in vec2 a_texture_pos;out vec2 v_pos0;out vec2 v_pos1;void main() {float w=1.0;vec2 uv;
#ifdef PROJECTION_GLOBE_VIEW
vec3 decomposed_pos_and_skirt=decomposeToPosAndSkirt(a_pos);vec3 latLng=u_grid_matrix*vec3(decomposed_pos_and_skirt.xy,1.0);float mercatorY=mercatorYfromLat(latLng[0]);float mercatorX=mercatorXfromLng(latLng[1]);float tiles=u_grid_matrix[0][2];float idx=u_grid_matrix[1][2];float idy=u_grid_matrix[2][2];float uvX=mercatorX*tiles-idx;float uvY=mercatorY*tiles-idy;uv=vec2(uvX,uvY);vec3 globe_pos=latLngToECEF(latLng.xy);globe_pos+=normalize(globe_pos)*u_raster_elevation*GLOBE_UPSCALE;vec4 globe_world_pos=u_globe_matrix*vec4(globe_pos,1.0);vec4 merc_world_pos=vec4(0.0);if (u_zoom_transition > 0.0) {vec2 merc_pos=vec2(mercatorX,mercatorY);merc_world_pos=vec4(merc_pos,u_raster_elevation,1.0);merc_world_pos.xy-=u_merc_center;merc_world_pos.x=wrap(merc_world_pos.x,-0.5,0.5);merc_world_pos=u_merc_matrix*merc_world_pos;}vec4 interpolated_pos=vec4(mix(globe_world_pos.xyz,merc_world_pos.xyz,u_zoom_transition)*w,w);gl_Position=u_matrix*interpolated_pos;
#ifdef FOG
v_fog_pos=fog_position((u_normalize_matrix*vec4(globe_pos,1.0)).xyz);
#endif
#else
uv=a_texture_pos/8192.0;gl_Position=u_matrix*vec4(a_pos*w,u_raster_elevation*w,w);
#ifdef FOG
v_fog_pos=fog_position(a_pos);
#endif
#endif
v_pos0=uv;v_pos1=(v_pos0*u_scale_parent)+u_tl_parent;}`),rasterParticleDraw:fn("uniform sampler2D u_color_ramp;in float v_particle_speed;void main() {glFragColor=texture(u_color_ramp,vec2(v_particle_speed,0.5));}",`#include "_prelude_raster_particle.glsl"
in float a_index;uniform sampler2D u_particle_texture;uniform float u_particle_texture_side_len;uniform vec2 u_tile_offset;out float v_particle_speed;void main() {ivec2 pixel_coord=ivec2(
mod(a_index,u_particle_texture_side_len),a_index/u_particle_texture_side_len);vec4 pixel=texelFetch(u_particle_texture,pixel_coord,0);vec2 pos=unpack_pos_from_rgba(pixel)+u_tile_offset;vec2 tex_coord=fract(pos);vec2 velocity=lookup_velocity(tex_coord);if (velocity==INVALID_VELOCITY) {gl_Position=AWAY;v_particle_speed=0.0;} else {gl_Position=vec4(2.0*pos-1.0,0,1);v_particle_speed=length(velocity);}gl_PointSize=1.0;}`),rasterParticleTexture:fn("uniform sampler2D u_texture;uniform float u_opacity;in vec2 v_tex_pos;void main() {vec4 color=texture(u_texture,v_tex_pos);glFragColor=vec4(floor(255.0*color*u_opacity)/255.0);}","in vec2 a_pos;out vec2 v_tex_pos;void main() {vec2 uv=0.5*a_pos+vec2(0.5);v_tex_pos=uv;gl_Position=vec4(a_pos,0.0,1.0);}"),rasterParticleUpdate:fn(`#include "_prelude_raster_particle.glsl"
uniform sampler2D u_particle_texture;uniform mediump float u_particle_texture_side_len;uniform mediump float u_speed_factor;uniform highp float u_reset_rate;uniform highp float u_rand_seed;in highp vec2 v_tex_coord;vec2 linearstep(vec2 edge0,vec2 edge1,vec2 x) {return  clamp((x-edge0)/(edge1-edge0),vec2(0),vec2(1));}const highp vec3 rand_constants=vec3(12.9898,78.233,4375.85453);highp float rand(const highp vec2 co) {highp float t=dot(rand_constants.xy,co);return fract(sin(t)*(rand_constants.z+t));}void main() {ivec2 pixel_coord=ivec2(v_tex_coord*u_particle_texture_side_len);highp vec4 pixel=texelFetch(u_particle_texture,pixel_coord,0);highp vec2 pos=unpack_pos_from_rgba(pixel);highp vec2 velocity=lookup_velocity(clamp(pos,0.0,1.0));highp vec2 dp=velocity==INVALID_VELOCITY ? vec2(0) : velocity*u_speed_factor;pos=pos+dp;highp vec2 seed=(pos+v_tex_coord)*u_rand_seed;highp vec2 random_pos=vec2(rand(seed+1.3),rand(seed+2.1));highp vec2 persist_rate=pow(
linearstep(vec2(-u_particle_pos_offset),vec2(0),pos)*linearstep(vec2(1.0+u_particle_pos_offset),vec2(1),pos),vec2(4)
);highp vec2 per_frame_persist=pow(persist_rate,abs(dp)/u_particle_pos_offset);highp float drop_rate=1.0-per_frame_persist.x*per_frame_persist.y;drop_rate=any(greaterThanEqual(abs(pos-0.5),vec2(0.5+u_particle_pos_offset))) ? 1.0 : drop_rate;highp float drop=step(1.0-drop_rate-u_reset_rate,rand(seed));highp vec2 next_pos=mix(pos,random_pos,drop);glFragColor=pack_pos_to_rgba(next_pos);}`,"in vec2 a_pos;out vec2 v_tex_coord;void main() {v_tex_coord=0.5*(a_pos+vec2(1.0));gl_Position=vec4(a_pos,0.0,1.0);}"),symbol:fn(`#include "_prelude_lighting.glsl"
#include "_prelude_shadow.fragment.glsl"
#define SDF_PX 8.0
#define SDF 1.0
#define ICON 0.0
uniform sampler2D u_texture;uniform sampler2D u_texture_icon;uniform highp float u_gamma_scale;uniform lowp float u_device_pixel_ratio;uniform bool u_is_text;uniform bool u_is_halo;uniform lowp float u_scale_factor;
#ifdef ICON_TRANSITION
uniform float u_icon_transition;
#endif
#ifdef COLOR_ADJUSTMENT
uniform mat4 u_color_adj_mat;
#endif
#ifdef INDICATOR_CUTOUT
in highp float v_z_offset;
#else
#ifdef RENDER_SHADOWS
in highp float v_z_offset;
#endif
#endif
in vec2 v_tex_a;
#ifdef ICON_TRANSITION
in vec2 v_tex_b;
#endif
in float v_draw_halo;in vec3 v_gamma_scale_size_fade_opacity;
#ifdef RENDER_TEXT_AND_SYMBOL
in float is_sdf;in vec2 v_tex_a_icon;
#endif
#ifdef RENDER_SHADOWS
uniform vec3 u_ground_shadow_factor;in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in highp float v_depth;
#endif
#pragma mapbox: define highp vec4 fill_color
#pragma mapbox: define highp vec4 halo_color
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp float halo_width
#pragma mapbox: define lowp float halo_blur
#pragma mapbox: define lowp float emissive_strength
void main() {
#pragma mapbox: initialize highp vec4 fill_color
#pragma mapbox: initialize highp vec4 halo_color
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize lowp float halo_width
#pragma mapbox: initialize lowp float halo_blur
#pragma mapbox: initialize lowp float emissive_strength
vec4 out_color;float fade_opacity=v_gamma_scale_size_fade_opacity[2];
#ifdef RENDER_TEXT_AND_SYMBOL
if (is_sdf==ICON) {vec2 tex_icon=v_tex_a_icon;lowp float alpha=opacity*fade_opacity;glFragColor=texture(u_texture_icon,tex_icon)*alpha;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
return;}
#endif
#ifdef RENDER_SDF
float EDGE_GAMMA=0.105/u_device_pixel_ratio;float gamma_scale=v_gamma_scale_size_fade_opacity.x;float size=v_gamma_scale_size_fade_opacity.y;float fontScale=u_is_text ? size/24.0 : size;out_color=fill_color;highp float gamma=EDGE_GAMMA/(fontScale*u_gamma_scale);lowp float buff=(256.0-64.0)/256.0;bool draw_halo=v_draw_halo > 0.0;if (draw_halo) {out_color=halo_color;gamma=(halo_blur*u_scale_factor*1.19/SDF_PX+EDGE_GAMMA)/(fontScale*u_gamma_scale);buff=(6.0-halo_width*u_scale_factor/fontScale)/SDF_PX;}lowp float dist=texture(u_texture,v_tex_a).r;highp float gamma_scaled=gamma*gamma_scale;highp float alpha=smoothstep(buff-gamma_scaled,buff+gamma_scaled,dist);out_color*=alpha;
#else
#ifdef ICON_TRANSITION
vec4 a=texture(u_texture,v_tex_a)*(1.0-u_icon_transition);vec4 b=texture(u_texture,v_tex_b)*u_icon_transition;out_color=(a+b);
#else
out_color=texture(u_texture,v_tex_a);
#endif
#ifdef COLOR_ADJUSTMENT
out_color=u_color_adj_mat*out_color;
#endif
#endif
out_color*=opacity*fade_opacity;
#ifdef LIGHTING_3D_MODE
out_color=apply_lighting_with_emission_ground(out_color,emissive_strength);
#ifdef RENDER_SHADOWS
float light=shadowed_light_factor(v_pos_light_view_0,v_pos_light_view_1,v_depth);
#ifdef TERRAIN
out_color.rgb*=mix(u_ground_shadow_factor,vec3(1.0),light);
#else
out_color.rgb*=mix(v_z_offset !=0.0 ? u_ground_shadow_factor : vec3(1.0),vec3(1.0),light);
#endif
#endif
#endif
#ifdef INDICATOR_CUTOUT
out_color=applyCutout(out_color,v_z_offset);
#endif
#ifdef FEATURE_CUTOUT
out_color=apply_feature_cutout(out_color,gl_FragCoord);
#endif
glFragColor=out_color;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_terrain.vertex.glsl"
#include "_prelude_shadow.vertex.glsl"
in vec4 a_pos_offset;in vec4 a_tex_size;in vec4 a_pixeloffset;in vec4 a_projected_pos;in float a_fade_opacity;
#ifdef Z_OFFSET
in float a_auto_z_offset;
#endif
#ifdef PROJECTION_GLOBE_VIEW
in vec3 a_globe_anchor;in vec3 a_globe_normal;
#endif
#ifdef ICON_TRANSITION
in vec2 a_texb;
#endif
#ifdef OCCLUSION_QUERIES
in float a_occlusion_query_opacity;
#endif
#ifdef ELEVATED_ROADS
in vec3 a_x_axis;in vec3 a_y_axis;uniform float u_normal_scale;
#endif
#ifdef INDICATOR_CUTOUT
out highp float v_z_offset;
#else
#ifdef RENDER_SHADOWS
out highp float v_z_offset;
#endif
#endif
uniform bool u_is_size_zoom_constant;uniform bool u_is_size_feature_constant;uniform highp float u_size_t;uniform highp float u_size;uniform mat4 u_matrix;uniform mat4 u_inv_matrix;uniform mat4 u_label_plane_matrix;uniform mat4 u_coord_matrix;uniform bool u_is_text;uniform bool u_elevation_from_sea;uniform bool u_pitch_with_map;uniform bool u_rotate_symbol;uniform highp float u_aspect_ratio;uniform highp float u_camera_to_center_distance;uniform float u_fade_change;uniform vec2 u_texsize;uniform vec3 u_up_vector;uniform vec2 u_texsize_icon;uniform bool u_is_halo;
#ifdef PROJECTION_GLOBE_VIEW
uniform vec3 u_tile_id;uniform mat4 u_inv_rot_matrix;uniform vec2 u_merc_center;uniform vec3 u_camera_forward;uniform float u_zoom_transition;uniform vec3 u_ecef_origin;uniform mat4 u_tile_matrix;
#endif
out vec2 v_tex_a;
#ifdef ICON_TRANSITION
out vec2 v_tex_b;
#endif
out float v_draw_halo;out vec3 v_gamma_scale_size_fade_opacity;
#ifdef RENDER_TEXT_AND_SYMBOL
out float is_sdf;out vec2 v_tex_a_icon;
#endif
#ifdef RENDER_SHADOWS
uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out highp float v_depth;
#endif
#pragma mapbox: define highp vec4 fill_color
#pragma mapbox: define highp vec4 halo_color
#pragma mapbox: define lowp float opacity
#pragma mapbox: define lowp float halo_width
#pragma mapbox: define lowp float halo_blur
#pragma mapbox: define lowp float emissive_strength
#pragma mapbox: define lowp float occlusion_opacity
#pragma mapbox: define lowp float z_offset
void main() {
#pragma mapbox: initialize highp vec4 fill_color
#pragma mapbox: initialize highp vec4 halo_color
#pragma mapbox: initialize lowp float opacity
#pragma mapbox: initialize lowp float halo_width
#pragma mapbox: initialize lowp float halo_blur
#pragma mapbox: initialize lowp float emissive_strength
#pragma mapbox: initialize lowp float occlusion_opacity
#pragma mapbox: initialize lowp float z_offset
vec2 a_pos=a_pos_offset.xy;vec2 a_offset=a_pos_offset.zw;vec2 a_tex=a_tex_size.xy;vec2 a_size=a_tex_size.zw;float a_size_min=floor(a_size[0]*0.5);vec2 a_pxoffset=a_pixeloffset.xy;vec2 a_min_font_scale=a_pixeloffset.zw/256.0;highp float segment_angle=-a_projected_pos[3];float size;if (!u_is_size_zoom_constant && !u_is_size_feature_constant) {size=mix(a_size_min,a_size[1],u_size_t)/128.0;} else if (u_is_size_zoom_constant && !u_is_size_feature_constant) {size=a_size_min/128.0;} else {size=u_size;}vec2 tile_anchor=a_pos;float e=u_elevation_from_sea ? z_offset : z_offset+elevation(tile_anchor);
#ifdef Z_OFFSET
e+=a_auto_z_offset;
#endif
vec3 h=elevationVector(tile_anchor)*e;float globe_occlusion_fade;vec3 world_pos;vec3 mercator_pos;vec3 world_pos_globe;
#ifdef PROJECTION_GLOBE_VIEW
mercator_pos=mercator_tile_position(u_inv_rot_matrix,tile_anchor,u_tile_id,u_merc_center);world_pos_globe=a_globe_anchor+h;world_pos=mix_globe_mercator(world_pos_globe,mercator_pos,u_zoom_transition);vec4 ecef_point=u_tile_matrix*vec4(world_pos,1.0);vec3 origin_to_point=ecef_point.xyz-u_ecef_origin;globe_occlusion_fade=dot(origin_to_point,u_camera_forward) >=0.0 ? 0.0 : 1.0;
#else
world_pos=vec3(tile_anchor,0)+h;globe_occlusion_fade=1.0;
#endif
vec4 projected_point=u_matrix*vec4(world_pos,1);highp float camera_to_anchor_distance=projected_point.w;highp float distance_ratio=u_pitch_with_map ?
camera_to_anchor_distance/u_camera_to_center_distance :
u_camera_to_center_distance/camera_to_anchor_distance;highp float perspective_ratio=clamp(
0.5+0.5*distance_ratio,0.0,1.5);size*=perspective_ratio;float font_scale=u_is_text ? size/24.0 : size;highp float symbol_rotation=0.0;if (u_rotate_symbol) {vec4 offsetprojected_point;vec2 a;
#ifdef PROJECTION_GLOBE_VIEW
vec3 displacement=vec3(a_globe_normal.z,0,-a_globe_normal.x);offsetprojected_point=u_matrix*vec4(a_globe_anchor+displacement,1);vec4 projected_point_globe=u_matrix*vec4(world_pos_globe,1);a=projected_point_globe.xy/projected_point_globe.w;
#else
offsetprojected_point=u_matrix*vec4(tile_anchor+vec2(1,0),0,1);a=projected_point.xy/projected_point.w;
#endif
vec2 b=offsetprojected_point.xy/offsetprojected_point.w;symbol_rotation=atan((b.y-a.y)/u_aspect_ratio,b.x-a.x);}vec4 projected_pos;
#ifdef PROJECTION_GLOBE_VIEW
#ifdef PROJECTED_POS_ON_VIEWPORT
projected_pos=u_label_plane_matrix*vec4(a_projected_pos.xyz+h,1.0);
#else
vec3 proj_pos=mix_globe_mercator(a_projected_pos.xyz,mercator_pos,u_zoom_transition)+h;projected_pos=u_label_plane_matrix*vec4(proj_pos,1.0);    
#endif
#else
projected_pos=u_label_plane_matrix*vec4(a_projected_pos.xy,h.z,1.0);
#endif
highp float angle_sin=sin(segment_angle+symbol_rotation);highp float angle_cos=cos(segment_angle+symbol_rotation);mat2 rotation_matrix=mat2(angle_cos,-1.0*angle_sin,angle_sin,angle_cos);float z=0.0;vec2 offset=rotation_matrix*(a_offset/32.0*max(a_min_font_scale,font_scale)+a_pxoffset/16.0);
#ifdef TERRAIN
#ifdef PITCH_WITH_MAP_TERRAIN
vec4 tile_pos=u_label_plane_matrix_inv*vec4(a_projected_pos.xy+offset,0.0,1.0);z=elevation(tile_pos.xy);
#endif
#endif
#ifdef Z_OFFSET
z+=u_pitch_with_map ? a_auto_z_offset+z_offset : 0.0;
#else
z+=u_pitch_with_map ? z_offset : 0.0;
#endif
float occlusion_fade=globe_occlusion_fade;vec2 fade_opacity=unpack_opacity(a_fade_opacity);float fade_change=fade_opacity[1] > 0.5 ? u_fade_change :-u_fade_change;float out_fade_opacity=max(0.0,min(occlusion_fade,fade_opacity[0]+fade_change));
#ifdef DEPTH_OCCLUSION
float depth_occlusion=occlusionFadeMultiSample(projected_point);float depth_occlusion_multplier=mix(occlusion_opacity,1.0,depth_occlusion);out_fade_opacity*=depth_occlusion_multplier;
#endif
#ifdef OCCLUSION_QUERIES
float occludedFadeMultiplier=mix(occlusion_opacity,1.0,a_occlusion_query_opacity);out_fade_opacity*=occludedFadeMultiplier;
#endif
float alpha=opacity*out_fade_opacity;float hidden=float(alpha==0.0 || projected_point.w <=0.0 || occlusion_fade==0.0);vec3 pos;
#ifdef PROJECTION_GLOBE_VIEW
vec3 xAxis=u_pitch_with_map ? normalize(cross(a_globe_normal,u_up_vector)) : vec3(1,0,0);vec3 yAxis=u_pitch_with_map ? normalize(cross(a_globe_normal,xAxis)) : vec3(0,1,0);pos=projected_pos.xyz/projected_pos.w+xAxis*offset.x+yAxis*offset.y;
#else
#ifdef ELEVATED_ROADS
vec3 xAxis=vec3(a_x_axis.xy,a_x_axis.z*u_normal_scale);vec3 yAxis=vec3(a_y_axis.xy,a_y_axis.z*u_normal_scale);pos=projected_pos.xyz/projected_pos.w+xAxis*offset.x+yAxis*offset.y;
#else
pos=vec3(projected_pos.xy/projected_pos.w+offset,z);
#endif
#endif
gl_Position=mix(u_coord_matrix*vec4(pos,1.0),AWAY,hidden);float gamma_scale=gl_Position.w;v_draw_halo=(u_is_halo && float(gl_InstanceID)==0.0) ? 1.0 : 0.0;v_gamma_scale_size_fade_opacity=vec3(gamma_scale,size,out_fade_opacity);v_tex_a=a_tex/u_texsize;
#ifdef RENDER_TEXT_AND_SYMBOL
is_sdf=a_size[0]-2.0*a_size_min;v_tex_a_icon=a_tex/u_texsize_icon;
#endif
#ifdef ICON_TRANSITION
v_tex_b=a_texb/u_texsize;
#endif
#ifdef RENDER_SHADOWS
vec4 shd_pos=u_inv_matrix*vec4(pos,1.0);vec3 shd_pos0=shd_pos.xyz;vec3 shd_pos1=shd_pos.xyz;
#ifdef NORMAL_OFFSET
vec3 shd_pos_offset=shadow_normal_offset(vec3(0.0,0.0,1.0));shd_pos0+=shd_pos_offset*shadow_normal_offset_multiplier0();shd_pos1+=shd_pos_offset*shadow_normal_offset_multiplier1();
#endif
v_pos_light_view_0=u_light_matrix_0*vec4(shd_pos0,1);v_pos_light_view_1=u_light_matrix_1*vec4(shd_pos1,1);v_depth=gl_Position.w;
#endif
#ifdef INDICATOR_CUTOUT
v_z_offset=e;
#else
#ifdef RENDER_SHADOWS
v_z_offset=e;
#endif
#endif
}`),terrainRaster:fn(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_shadow.fragment.glsl"
#include "_prelude_lighting.glsl"
uniform sampler2D u_image0;in vec2 v_pos0;
#ifdef FOG
in float v_fog_opacity;
#endif
#ifdef RENDER_SHADOWS
in vec4 v_pos_light_view_0;in vec4 v_pos_light_view_1;
#endif
uniform vec3 u_ground_shadow_factor;void main() {vec4 image_color=texture(u_image0,v_pos0);vec4 color;
#ifdef LIGHTING_3D_MODE
const vec3 normal=vec3(0.0,0.0,1.0);
#ifdef RENDER_SHADOWS
float cutoffOpacity=1.0;
#ifdef RENDER_CUTOFF
cutoffOpacity=cutoff_opacity(u_cutoff_params,1.0/gl_FragCoord.w);
#endif
#ifdef LIGHTING_3D_ALPHA_EMISSIVENESS
vec3 unlit_base=image_color.rgb*(1.0-image_color.a);vec3 emissive_base=image_color.rgb*image_color.a;float ndotl=u_shadow_direction.z;float occlusion=ndotl < 0.0 ? 1.0 : shadow_occlusion(v_pos_light_view_0,v_pos_light_view_1,1.0/gl_FragCoord.w,0.0);ndotl=max(0.0,ndotl);vec3 lit=apply_lighting(unlit_base,normal,mix(1.0,(1.0-(u_shadow_intensity*occlusion))*ndotl,cutoffOpacity));vec3 emissive=compute_emissive_draped(emissive_base,1.0-u_shadow_intensity,occlusion,u_ground_shadow_factor);color.rgb=lit+emissive;color.a=1.0;
#else
float lighting_factor=shadowed_light_factor_normal_unbiased(normal,v_pos_light_view_0,v_pos_light_view_1,1.0/gl_FragCoord.w);color=apply_lighting(image_color,normal,mix(1.0,lighting_factor,cutoffOpacity));
#endif
#else
float lighting_factor=u_lighting_directional_dir.z;color=apply_lighting(image_color,normal,lighting_factor);
#ifdef LIGHTING_3D_ALPHA_EMISSIVENESS
color.rgb=mix(color.rgb,image_color.rgb,image_color.a);color.a=1.0;
#endif
#endif
#else
color=image_color;
#endif
#ifdef FOG
#ifdef ZERO_EXAGGERATION
color=fog_dither(fog_apply_premultiplied(color,v_fog_pos));
#else
color=fog_dither(fog_apply_from_vert(color,v_fog_opacity));
#endif
#endif
glFragColor=color;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_terrain.vertex.glsl"
uniform mat4 u_matrix;uniform float u_skirt_height;in vec2 a_pos;out vec2 v_pos0;
#ifdef FOG
out float v_fog_opacity;
#endif
#ifdef RENDER_SHADOWS
uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out vec4 v_pos_light_view_0;out vec4 v_pos_light_view_1;
#endif
void main() {vec3 decomposedPosAndSkirt=decomposeToPosAndSkirt(a_pos);float skirt=decomposedPosAndSkirt.z;vec2 decodedPos=decomposedPosAndSkirt.xy;float elevation=elevation(decodedPos)-skirt*u_skirt_height;v_pos0=decodedPos/8192.0;gl_Position=u_matrix*vec4(decodedPos,elevation,1.0);
#ifdef FOG
#ifdef ZERO_EXAGGERATION
v_fog_pos=fog_position(decodedPos);
#else
v_fog_opacity=fog(fog_position(vec3(decodedPos,elevation)));
#endif
#endif
#ifdef RENDER_SHADOWS
vec3 pos=vec3(decodedPos,elevation);v_pos_light_view_0=u_light_matrix_0*vec4(pos,1.);v_pos_light_view_1=u_light_matrix_1*vec4(pos,1.);
#endif
}`),terrainDepth:fn("precision highp float;in float v_depth;void main() {glFragColor=pack_depth(v_depth);}",`#include "_prelude_terrain.vertex.glsl"
uniform mat4 u_matrix;in vec2 a_pos;out float v_depth;void main() {float elevation=elevation(a_pos);gl_Position=u_matrix*vec4(a_pos,elevation,1.0);v_depth=gl_Position.z/gl_Position.w;}`),skybox:fn(`#include "_prelude_fog.fragment.glsl"
in lowp vec3 v_uv;uniform lowp samplerCube u_cubemap;uniform lowp float u_opacity;uniform highp float u_temporal_offset;uniform highp vec3 u_sun_direction;float sun_disk(highp vec3 ray_direction,highp vec3 sun_direction) {highp float cos_angle=dot(normalize(ray_direction),sun_direction);const highp float cos_sun_angular_diameter=0.99996192306;const highp float smoothstep_delta=1e-5;return smoothstep(
cos_sun_angular_diameter-smoothstep_delta,cos_sun_angular_diameter+smoothstep_delta,cos_angle);}float map(float value,float start,float end,float new_start,float new_end) {return ((value-start)*(new_end-new_start))/(end-start)+new_start;}void main() {vec3 uv=v_uv;const float y_bias=0.015;uv.y+=y_bias;uv.y=pow(abs(uv.y),1.0/5.0);uv.y=map(uv.y,0.0,1.0,-1.0,1.0);vec3 sky_color=texture(u_cubemap,uv).rgb;
#ifdef FOG
sky_color=fog_apply_sky_gradient(v_uv.xzy,sky_color);
#endif
sky_color+=0.1*sun_disk(v_uv,u_sun_direction);glFragColor=vec4(sky_color*u_opacity,u_opacity);
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
}`,Sd),skyboxGradient:fn(`#include "_prelude_fog.fragment.glsl"
in highp vec3 v_uv;uniform lowp sampler2D u_color_ramp;uniform highp vec3 u_center_direction;uniform lowp float u_radius;uniform lowp float u_opacity;uniform highp float u_temporal_offset;void main() {float progress=acos(dot(normalize(v_uv),u_center_direction))/u_radius;vec4 color=texture(u_color_ramp,vec2(progress,0.5));
#ifdef FOG
color.rgb=fog_apply_sky_gradient(v_uv.xzy,color.rgb/color.a)*color.a;
#endif
color*=u_opacity;glFragColor=color;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
}`,Sd),skyboxCapture:fn(`
in highp vec3 v_position;uniform highp float u_sun_intensity;uniform highp float u_luminance;uniform lowp vec3 u_sun_direction;uniform highp vec4 u_color_tint_r;uniform highp vec4 u_color_tint_m;precision highp float;
#define BETA_R                  vec3(5.5e-6,13.0e-6,22.4e-6)
#define BETA_M                  vec3(21e-6,21e-6,21e-6)
#define MIE_G                   0.76
#define DENSITY_HEIGHT_SCALE_R  8000.0
#define DENSITY_HEIGHT_SCALE_M  1200.0
#define PLANET_RADIUS           6360e3
#define ATMOSPHERE_RADIUS       6420e3
#define SAMPLE_STEPS            10
#define DENSITY_STEPS           4
float ray_sphere_exit(vec3 orig,vec3 dir,float radius) {float a=dot(dir,dir);float b=2.0*dot(dir,orig);float c=dot(orig,orig)-radius*radius;float d=sqrt(b*b-4.0*a*c);return (-b+d)/(2.0*a);}vec3 extinction(vec2 density) {return exp(-vec3(BETA_R*u_color_tint_r.a*density.x+BETA_M*u_color_tint_m.a*density.y));}vec2 local_density(vec3 point) {float height=max(length(point)-PLANET_RADIUS,0.0);float exp_r=exp(-height/DENSITY_HEIGHT_SCALE_R);float exp_m=exp(-height/DENSITY_HEIGHT_SCALE_M);return vec2(exp_r,exp_m);}float phase_ray(float cos_angle) {return (3.0/(16.0*PI))*(1.0+cos_angle*cos_angle);}float phase_mie(float cos_angle) {return (3.0/(8.0*PI))*((1.0-MIE_G*MIE_G)*(1.0+cos_angle*cos_angle))/((2.0+MIE_G*MIE_G)*pow(1.0+MIE_G*MIE_G-2.0*MIE_G*cos_angle,1.5));}vec2 density_to_atmosphere(vec3 point,vec3 light_dir) {float ray_len=ray_sphere_exit(point,light_dir,ATMOSPHERE_RADIUS);float step_len=ray_len/float(DENSITY_STEPS);vec2 density_point_to_atmosphere=vec2(0.0);for (int i=0; i < DENSITY_STEPS;++i) {vec3 point_on_ray=point+light_dir*((float(i)+0.5)*step_len);density_point_to_atmosphere+=local_density(point_on_ray)*step_len;;}return density_point_to_atmosphere;}vec3 atmosphere(vec3 ray_dir,vec3 sun_direction,float sun_intensity) {vec2 density_orig_to_point=vec2(0.0);vec3 scatter_r=vec3(0.0);vec3 scatter_m=vec3(0.0);vec3 origin=vec3(0.0,PLANET_RADIUS,0.0);float ray_len=ray_sphere_exit(origin,ray_dir,ATMOSPHERE_RADIUS);float step_len=ray_len/float(SAMPLE_STEPS);for (int i=0; i < SAMPLE_STEPS;++i) {vec3 point_on_ray=origin+ray_dir*((float(i)+0.5)*step_len);vec2 density=local_density(point_on_ray)*step_len;density_orig_to_point+=density;vec2 density_point_to_atmosphere=density_to_atmosphere(point_on_ray,sun_direction);vec2 density_orig_to_atmosphere=density_orig_to_point+density_point_to_atmosphere;vec3 extinction=extinction(density_orig_to_atmosphere);scatter_r+=density.x*extinction;scatter_m+=density.y*extinction;}float cos_angle=dot(ray_dir,sun_direction);float phase_r=phase_ray(cos_angle);float phase_m=phase_mie(cos_angle);vec3 beta_r=BETA_R*u_color_tint_r.rgb*u_color_tint_r.a;vec3 beta_m=BETA_M*u_color_tint_m.rgb*u_color_tint_m.a;return (scatter_r*phase_r*beta_r+scatter_m*phase_m*beta_m)*sun_intensity;}const float A=0.15;const float B=0.50;const float C=0.10;const float D=0.20;const float E=0.02;const float F=0.30;vec3 uncharted2_tonemap(vec3 x) {return ((x*(A*x+C*B)+D*E)/(x*(A*x+B)+D*F))-E/F;}void main() {vec3 ray_direction=v_position;ray_direction.y=pow(ray_direction.y,5.0);const float y_bias=0.015;ray_direction.y+=y_bias;vec3 color=atmosphere(normalize(ray_direction),u_sun_direction,u_sun_intensity);float white_scale=1.0748724675633854;color=uncharted2_tonemap((log2(2.0/pow(u_luminance,4.0)))*color)*white_scale;glFragColor=vec4(color,1.0);}`,"in highp vec3 a_pos_3f;uniform mat3 u_matrix_3f;out highp vec3 v_position;float map(float value,float start,float end,float new_start,float new_end) {return ((value-start)*(new_end-new_start))/(end-start)+new_start;}void main() {vec4 pos=vec4(u_matrix_3f*a_pos_3f,1.0);v_position=pos.xyz;v_position.y*=-1.0;v_position.y=map(v_position.y,-1.0,1.0,0.0,1.0);gl_Position=vec4(a_pos_3f.xy,0.0,1.0);}"),globeRaster:fn(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_lighting.glsl"
uniform sampler2D u_image0;uniform float u_far_z_cutoff;in vec2 v_pos0;
#ifndef FOG
uniform highp vec3 u_frustum_tl;uniform highp vec3 u_frustum_tr;uniform highp vec3 u_frustum_br;uniform highp vec3 u_frustum_bl;uniform highp vec3 u_globe_pos;uniform highp float u_globe_radius;uniform vec2 u_viewport;
#endif
void main() {vec4 color;
#ifdef CUSTOM_ANTIALIASING
highp vec2 uv=gl_FragCoord.xy/u_viewport;
#ifdef FLIP_Y
uv.y=1.0-uv.y;
#endif
highp vec3 ray_dir=mix(
mix(u_frustum_tl,u_frustum_tr,uv.x),mix(u_frustum_bl,u_frustum_br,uv.x),1.0-uv.y);highp vec3 dir=normalize(ray_dir);highp vec3 closest_point=dot(u_globe_pos,dir)*dir;highp float norm_dist_from_center=1.0-length(closest_point-u_globe_pos)/u_globe_radius;const float antialias_pixel=2.0;highp float antialias_factor=antialias_pixel*fwidth(norm_dist_from_center);highp float antialias=smoothstep(0.0,antialias_factor,norm_dist_from_center);vec4 raster=texture(u_image0,v_pos0);
#ifdef LIGHTING_3D_MODE
#ifdef LIGHTING_3D_ALPHA_EMISSIVENESS
raster=apply_lighting_with_emission_ground(raster,raster.a);color=vec4(clamp(raster.rgb,vec3(0),vec3(1))*antialias,antialias);
#else
raster=apply_lighting_ground(raster);color=vec4(raster.rgb*antialias,raster.a*antialias);
#endif
#else
color=vec4(raster.rgb*antialias,raster.a*antialias);
#endif
#else
color=texture(u_image0,v_pos0);
#ifdef LIGHTING_3D_MODE
#ifdef LIGHTING_3D_ALPHA_EMISSIVENESS
color=apply_lighting_with_emission_ground(color,color.a);color.a=1.0;
#else
color=apply_lighting_ground(color);
#endif
#endif
#endif
#ifdef FOG
color=fog_dither(fog_apply_premultiplied(color,v_fog_pos));
#endif
color*=1.0-step(u_far_z_cutoff,1.0/gl_FragCoord.w);glFragColor=color;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_terrain.vertex.glsl"
uniform mat4 u_proj_matrix;uniform mat4 u_normalize_matrix;uniform mat4 u_globe_matrix;uniform mat4 u_merc_matrix;uniform float u_zoom_transition;uniform vec2 u_merc_center;uniform mat3 u_grid_matrix;uniform float u_skirt_height;
#ifdef GLOBE_POLES
in vec3 a_globe_pos;in vec2 a_uv;
#else
in vec2 a_pos;
#endif
out vec2 v_pos0;void main() {
#ifdef GLOBE_POLES
vec3 globe_pos=a_globe_pos;vec2 uv=a_uv;
#else
float tiles=u_grid_matrix[0][2];float idx=u_grid_matrix[1][2];float idy=u_grid_matrix[2][2];vec3 decomposed_pos_and_skirt=decomposeToPosAndSkirt(a_pos);vec3 latLng=u_grid_matrix*vec3(decomposed_pos_and_skirt.xy,1.0);float mercatorY=mercatorYfromLat(latLng[0]);float uvY=mercatorY*tiles-idy;float mercatorX=mercatorXfromLng(latLng[1]);float uvX=mercatorX*tiles-idx;vec3 globe_pos=latLngToECEF(latLng.xy);vec2 merc_pos=vec2(mercatorX,mercatorY);vec2 uv=vec2(uvX,uvY);
#endif
v_pos0=uv;vec2 tile_pos=uv*EXTENT;vec3 globe_derived_up_vector=normalize(globe_pos)*u_tile_up_scale;
#ifdef GLOBE_POLES
vec3 up_vector=globe_derived_up_vector;
#else
vec3 up_vector=elevationVector(tile_pos);
#endif
float height=elevation(tile_pos);globe_pos+=up_vector*height;
#ifndef GLOBE_POLES
globe_pos-=globe_derived_up_vector*u_skirt_height*decomposed_pos_and_skirt.z;
#endif
#ifdef GLOBE_POLES
vec4 interpolated_pos=u_globe_matrix*vec4(globe_pos,1.0);
#else
vec4 globe_world_pos=u_globe_matrix*vec4(globe_pos,1.0);vec4 merc_world_pos=vec4(0.0);if (u_zoom_transition > 0.0) {merc_world_pos=vec4(merc_pos,height-u_skirt_height*decomposed_pos_and_skirt.z,1.0);merc_world_pos.xy-=u_merc_center;merc_world_pos.x=wrap(merc_world_pos.x,-0.5,0.5);merc_world_pos=u_merc_matrix*merc_world_pos;}vec4 interpolated_pos=vec4(mix(globe_world_pos.xyz,merc_world_pos.xyz,u_zoom_transition),1.0);
#endif
gl_Position=u_proj_matrix*interpolated_pos;
#ifdef FOG
v_fog_pos=fog_position((u_normalize_matrix*vec4(globe_pos,1.0)).xyz);
#endif
}`),globeAtmosphere:fn(`#include "_prelude_fog.fragment.glsl"
uniform float u_transition;uniform highp float u_fadeout_range;uniform highp float u_temporal_offset;uniform vec4 u_color;uniform vec4 u_high_color;uniform vec4 u_space_color;uniform float u_horizon_angle;in highp vec3 v_ray_dir;in highp vec3 v_horizon_dir;void main() {highp vec3 dir=normalize(v_ray_dir);float globe_pos_dot_dir;
#ifdef PROJECTION_GLOBE_VIEW
globe_pos_dot_dir=dot(u_globe_pos,dir);highp vec3 closest_point_forward=abs(globe_pos_dot_dir)*dir;float norm_dist_from_center=length(closest_point_forward-u_globe_pos)/u_globe_radius;if (norm_dist_from_center < 0.98) {
#ifdef ALPHA_PASS
glFragColor=vec4(0,0,0,0);return;
#else
#ifdef NATIVE
glFragColor=vec4(1,1,1,1);
#else
glFragColor=vec4(0,0,0,1);
#endif
return;
#endif
}
#endif
highp vec3 horizon_dir=normalize(v_horizon_dir);float horizon_angle_mercator=dir.y < horizon_dir.y ?
0.0 : max(acos(clamp(dot(dir,horizon_dir),-1.0,1.0)),0.0);float horizon_angle;
#ifdef PROJECTION_GLOBE_VIEW
highp vec3 closest_point=globe_pos_dot_dir*dir;highp float closest_point_to_center=length(closest_point-u_globe_pos);highp float theta=asin(clamp(closest_point_to_center/length(u_globe_pos),-1.0,1.0));horizon_angle=globe_pos_dot_dir < 0.0 ?
PI-theta-u_horizon_angle : theta-u_horizon_angle;float angle_t=pow(u_transition,10.0);horizon_angle=mix(horizon_angle,horizon_angle_mercator,angle_t);
#else
horizon_angle=horizon_angle_mercator;
#endif
horizon_angle/=PI;float t=exp(-horizon_angle/u_fadeout_range);float alpha_0=u_color.a;float alpha_1=u_high_color.a;float alpha_2=u_space_color.a;vec3 color_stop_0=u_color.rgb;vec3 color_stop_1=u_high_color.rgb;vec3 color_stop_2=u_space_color.rgb;
#ifdef ALPHA_PASS
float a0=mix(alpha_2,1.0,alpha_1);float a1=mix(a0,1.0,alpha_0);float a2=mix(a0,a1,t);float a =mix(alpha_2,a2,t);glFragColor=vec4(1.0,1.0,1.0,a);
#else
vec3 c0=mix(color_stop_2,color_stop_1,alpha_1);vec3 c1=mix(c0,color_stop_0,alpha_0);vec3 c2=mix(c0,c1,t);vec3 c=c2;glFragColor=vec4(c*t,t);
#endif
}`,`in vec3 a_pos;in vec2 a_uv;uniform vec3 u_frustum_tl;uniform vec3 u_frustum_tr;uniform vec3 u_frustum_br;uniform vec3 u_frustum_bl;uniform float u_horizon;out highp vec3 v_ray_dir;out highp vec3 v_horizon_dir;void main() {v_ray_dir=mix(
mix(u_frustum_tl,u_frustum_tr,a_uv.x),mix(u_frustum_bl,u_frustum_br,a_uv.x),a_uv.y);v_horizon_dir=mix(
mix(u_frustum_tl,u_frustum_bl,u_horizon),mix(u_frustum_tr,u_frustum_br,u_horizon),a_uv.x);gl_Position=vec4(a_pos,1.0);}`),model:fn(`#include "_prelude_fog.fragment.glsl"
#include "_prelude_shadow.fragment.glsl"
#include "_prelude_lighting.glsl"
uniform float u_opacity;uniform vec3 u_lightcolor;uniform vec3 u_lightpos;uniform float u_lightintensity;uniform vec4 u_baseColorFactor;uniform vec4 u_emissiveFactor;uniform float u_metallicFactor;uniform float u_roughnessFactor;uniform float u_emissive_strength;in highp vec4 v_position_height;in lowp vec4 v_color_mix;
#ifdef RENDER_SHADOWS
in highp vec4 v_pos_light_view_0;in highp vec4 v_pos_light_view_1;in float v_depth_shadows;
#endif
#ifdef OCCLUSION_TEXTURE_TRANSFORM
uniform vec4 u_occlusionTextureTransform;
#endif
#pragma mapbox: define-attribute highp vec3 normal_3f
#pragma mapbox: define-attribute highp vec3 color_3f
#pragma mapbox: define-attribute highp vec4 color_4f
#pragma mapbox: define-attribute highp vec2 uv_2f
#pragma mapbox: initialize-attribute highp vec3 normal_3f
#pragma mapbox: initialize-attribute highp vec3 color_3f
#pragma mapbox: initialize-attribute highp vec4 color_4f
#pragma mapbox: initialize-attribute highp vec2 uv_2f
#ifdef HAS_ATTRIBUTE_a_pbr
in lowp vec4 v_roughness_metallic_emissive_alpha;in mediump vec4 v_height_based_emission_params;
#endif
#ifdef HAS_TEXTURE_u_baseColorTexture
uniform sampler2D u_baseColorTexture;uniform bool u_baseTextureIsAlpha;uniform bool u_alphaMask;uniform float u_alphaCutoff;
#endif
#ifdef HAS_TEXTURE_u_metallicRoughnessTexture
uniform sampler2D u_metallicRoughnessTexture;
#endif
#ifdef HAS_TEXTURE_u_occlusionTexture
uniform sampler2D u_occlusionTexture;uniform float u_aoIntensity;
#endif
#ifdef HAS_TEXTURE_u_normalTexture
uniform sampler2D u_normalTexture;
#endif
#ifdef HAS_TEXTURE_u_emissionTexture
uniform sampler2D u_emissionTexture;
#endif
#ifdef APPLY_LUT_ON_GPU
uniform highp sampler3D u_lutTexture;
#endif
#ifdef TERRAIN_FRAGMENT_OCCLUSION
in highp float v_depth;uniform highp sampler2D u_depthTexture;uniform highp vec2 u_inv_depth_size;uniform highp vec2 u_depth_range_unpack;
#ifdef DEPTH_D24
highp float unpack_depth(highp float depth) {return  depth*u_depth_range_unpack.x+u_depth_range_unpack.y;}
#else
highp float unpack_depth_rgba(highp vec4 rgba_depth)
{const highp vec4 bit_shift=vec4(1.0/(255.0*255.0*255.0),1.0/(255.0*255.0),1.0/255.0,1.0);return dot(rgba_depth,bit_shift)*2.0-1.0;}
#endif
bool isOccluded() {highp vec2 coord=gl_FragCoord.xy*u_inv_depth_size;
#ifdef DEPTH_D24
highp float depth=unpack_depth(texture(u_depthTexture,coord).r);
#else
highp float depth=unpack_depth_rgba(texture(u_depthTexture,coord));
#endif
return v_depth > depth+0.0005;}
#endif
#define saturate(_x) clamp(_x,0.,1.)
vec3 linearTosRGB(vec3 color) {return pow(color,vec3(1./2.2));}vec3 sRGBToLinear(vec3 srgbIn) {return pow(srgbIn,vec3(2.2));}float calculate_NdotL(vec3 normal,vec3 lightDir) {const float ext=0.70710678118;return (clamp(dot(normal,lightDir),-ext,1.0)+ext)/(1.0+ext);}vec3 getDiffuseShadedColor(vec3 albedo,vec3 normal,vec3 lightDir,vec3 lightColor)
{
#ifdef LIGHTING_3D_MODE
vec3 transformed_normal=vec3(-normal.xy,normal.z);float lighting_factor;
#ifdef RENDER_SHADOWS
lighting_factor=shadowed_light_factor_normal(transformed_normal,v_pos_light_view_0,v_pos_light_view_1,v_depth_shadows);
#else
lighting_factor=saturate(dot(transformed_normal,u_lighting_directional_dir));
#endif
return apply_lighting(albedo,transformed_normal,lighting_factor);
#else
vec3 n=normal;float colorvalue=((albedo.x*0.2126)+(albedo.y*0.7152))+(albedo.z*0.0722);vec3 c=vec3(0.03,0.03,0.03);float directional=clamp(dot(n,vec3(lightDir)),0.0,1.0);directional=mix(1.0-u_lightintensity,max((1.0-colorvalue)+u_lightintensity,1.0),directional);vec3 c3=c+clamp((albedo*directional)*lightColor,mix(vec3(0.0),vec3(0.3),vec3(1.0)-lightColor),vec3(1.0));return c3;
#endif
}vec4 getBaseColor() {vec4 albedo=u_baseColorFactor;
#ifdef HAS_ATTRIBUTE_a_color_3f
albedo*=vec4(color_3f,1.0);
#endif
#ifdef HAS_ATTRIBUTE_a_pbr
#else
#ifdef HAS_ATTRIBUTE_a_color_4f
albedo*=color_4f;
#endif
#endif
#if defined (HAS_TEXTURE_u_baseColorTexture) && defined (HAS_ATTRIBUTE_a_uv_2f)
vec4 texColor=texture(u_baseColorTexture,uv_2f);if(u_alphaMask) {if (texColor.w < u_alphaCutoff) {discard;}}
#ifdef UNPREMULT_TEXTURE_IN_SHADER
if(texColor.w > 0.0) {texColor.rgb/=texColor.w;}texColor.w=1.0;
#endif
if(u_baseTextureIsAlpha) {if (texColor.r < 0.5) {discard;}} else {texColor.rgb=sRGBToLinear(texColor.rgb);albedo*=texColor;}
#endif
vec4 color=vec4(mix(albedo.rgb,v_color_mix.rgb,v_color_mix.a),albedo.a);
#ifdef APPLY_LUT_ON_GPU
color=applyLUT(u_lutTexture,color);
#endif
return color;}highp mat3 cotangentFrame(highp vec3 N,highp vec3 p,highp vec2 uv ) {
#ifdef HAS_TEXTURE_u_normalTexture
highp vec3 dp1=vec3(dFdx(p.x),dFdx(p.y),dFdx(p.z));highp vec3 dp2=vec3(dFdy(p.x),dFdy(p.y),dFdy(p.z));highp vec2 duv1=vec2(dFdx(uv.x),dFdx(uv.y));highp vec2 duv2=vec2(dFdy(uv.x),dFdy(uv.y));highp vec3 dp2perp=cross( dp2,N );highp vec3 dp1perp=cross( N,dp1 );highp vec3 T=dp2perp*duv1.x+dp1perp*duv2.x;highp vec3 B=dp2perp*duv1.y+dp1perp*duv2.y;
#ifdef FLIP_Y
T=-T;B=-B;
#endif
highp float lengthT=dot(T,T);highp float lengthB=dot(B,B);highp float maxLength=max(lengthT,lengthB);highp float invmax=inversesqrt( maxLength );highp mat3 res=mat3( T*invmax,B*invmax,N );return res;
#else
return mat3(1.0);
#endif
}highp vec3 getNormal(){highp vec3 n;
#ifdef HAS_ATTRIBUTE_a_normal_3f
n=normalize(normal_3f);
#else
highp vec3 fdx=vec3(dFdx(v_position_height.x),dFdx(v_position_height.y),dFdx(v_position_height.z));highp vec3 fdy=vec3(dFdy(v_position_height.x),dFdy(v_position_height.y),dFdy(v_position_height.z));
#ifdef FLIP_Y
n=normalize(cross(fdx,fdy));
#else
n=normalize(cross(fdx,fdy))*-1.0;
#endif
#endif
#if defined(HAS_TEXTURE_u_normalTexture) && defined(HAS_ATTRIBUTE_a_uv_2f)
vec3 nMap=texture( u_normalTexture,uv_2f).xyz;nMap=normalize(2.0*nMap-vec3(1.0));highp vec3 v=normalize(-v_position_height.xyz);highp mat3 TBN=cotangentFrame(n,v,uv_2f);n=normalize(TBN*nMap);
#endif
return n;}struct Material {float perceptualRoughness;float alphaRoughness;float metallic;vec3 f90;vec4 baseColor;vec3 diffuseColor;vec3 specularColor;highp vec3 normal;};Material getPBRMaterial() {Material mat;mat.baseColor=getBaseColor();mat.perceptualRoughness=u_roughnessFactor;mat.metallic=u_metallicFactor;
#ifdef HAS_ATTRIBUTE_a_pbr
mat.perceptualRoughness=v_roughness_metallic_emissive_alpha.x;mat.metallic=v_roughness_metallic_emissive_alpha.y;mat.baseColor.w*=v_roughness_metallic_emissive_alpha.w;
#endif
#if defined(HAS_TEXTURE_u_metallicRoughnessTexture) && defined(HAS_ATTRIBUTE_a_uv_2f) 
vec4 mrSample=texture(u_metallicRoughnessTexture,uv_2f);mat.perceptualRoughness*=mrSample.g;mat.metallic*=mrSample.b;
#endif
const float c_minRoughness=0.04;mat.perceptualRoughness=clamp(mat.perceptualRoughness,c_minRoughness,1.0);mat.metallic=saturate(mat.metallic);mat.alphaRoughness=mat.perceptualRoughness*mat.perceptualRoughness;const vec3 f0=vec3(0.04);mat.diffuseColor=mat.baseColor.rgb*(vec3(1.0)-f0);mat.diffuseColor*=1.0-mat.metallic;mat.specularColor=mix(f0,mat.baseColor.rgb,mat.metallic);highp float reflectance=max(max(mat.specularColor.r,mat.specularColor.g),mat.specularColor.b);highp float reflectance90=saturate(reflectance*25.0);mat.f90=vec3(reflectance90);mat.normal=getNormal();return mat;}float V_GGX(float NdotL,float NdotV,float roughness)
{float a2=roughness*roughness;float GGXV=NdotL*sqrt(NdotV*NdotV*(1.0-a2)+a2);float GGXL=NdotV*sqrt(NdotL*NdotL*(1.0-a2)+a2);return 0.5/(GGXV+GGXL);}float V_GGXFast(float NdotL,float NdotV,float roughness) {float a=roughness;float GGXV=NdotL*(NdotV*(1.0-a)+a);float GGXL=NdotV*(NdotL*(1.0-a)+a);return 0.5/(GGXV+GGXL);}vec3 F_Schlick(vec3 specularColor,vec3 f90,float VdotH)
{return specularColor+(f90-specularColor)*pow(clamp(1.0-VdotH,0.0,1.0),5.0);}vec3 F_SchlickFast(vec3 specularColor,float VdotH)
{float x=1.0-VdotH;float x4=x*x*x*x;return specularColor+(1.0-specularColor)*x4*x;}float D_GGX(highp float NdotH,float alphaRoughness)
{highp float a4=alphaRoughness*alphaRoughness;highp float f=(NdotH*a4-NdotH)*NdotH+1.0;return a4/(PI*f*f);}vec3 diffuseBurley(Material mat,float LdotH,float NdotL,float NdotV)
{float f90=2.0*LdotH*LdotH*mat.alphaRoughness-0.5;return (mat.diffuseColor/PI)*(1.0+f90*pow((1.0-NdotL),5.0))*(1.0+f90*pow((1.0-NdotV),5.0));}vec3 diffuseLambertian(Material mat)
{
#ifdef LIGHTING_3D_MODE
return mat.diffuseColor;
#else
return mat.diffuseColor/PI;
#endif
}vec3 EnvBRDFApprox(vec3 specularColor,float roughness,highp float NdotV)
{vec4 c0=vec4(-1,-0.0275,-0.572,0.022);vec4 c1=vec4(1,0.0425,1.04,-0.04);highp vec4 r=roughness*c0+c1;highp float a004=min(r.x*r.x,exp2(-9.28*NdotV))*r.x+r.y;vec2 AB=vec2(-1.04,1.04)*a004+r.zw;return specularColor*AB.x+AB.y;}vec3 computeIndirectLightContribution(Material mat,float NdotV,vec3 normal)
{vec3 env_light=vec3(0.65,0.65,0.65);
#ifdef LIGHTING_3D_MODE
float ambient_factor=calculate_ambient_directional_factor(normal);env_light=u_lighting_ambient_color*ambient_factor;
#endif
vec3 envBRDF=EnvBRDFApprox(mat.specularColor,mat.perceptualRoughness,NdotV);vec3 indirectSpecular= envBRDF*env_light;vec3 indirectDiffuse=mat.diffuseColor*env_light;return indirectSpecular+indirectDiffuse;}vec3 computeLightContribution(Material mat,vec3 lightPosition,vec3 lightColor)
{highp vec3 n=mat.normal;highp vec3 v=normalize(-v_position_height.xyz);highp vec3 l=normalize(lightPosition);highp vec3 h=normalize(v+l);float NdotV=clamp(abs(dot(n,v)),0.001,1.0);float NdotL=saturate(dot(n,l));highp float NdotH=saturate(dot(n,h));float VdotH=saturate(dot(v,h));vec3 f=F_SchlickFast(mat.specularColor,VdotH);float g=V_GGXFast(NdotL,NdotV,mat.alphaRoughness);float d=D_GGX(NdotH,mat.alphaRoughness);vec3 diffuseTerm=(1.0-f)*diffuseLambertian(mat);vec3 specularTerm=f*g*d;vec3 transformed_normal=vec3(-n.xy,n.z);float lighting_factor;
#ifdef RENDER_SHADOWS
lighting_factor=shadowed_light_factor_normal(transformed_normal,v_pos_light_view_0,v_pos_light_view_1,v_depth_shadows);
#else
lighting_factor=NdotL;
#endif
vec3 directLightColor=(specularTerm+diffuseTerm)*lighting_factor*lightColor;vec3 indirectLightColor=computeIndirectLightContribution(mat,NdotV,transformed_normal);vec3 color=(saturate(directLightColor)+indirectLightColor);float intensityFactor=1.0;
#if !defined(LIGHTING_3D_MODE)
const vec3 luminosityFactor=vec3(0.2126,0.7152,0.0722);float luminance=dot(diffuseTerm,luminosityFactor);intensityFactor=mix((1.0-u_lightintensity),max((1.0-luminance+u_lightintensity),1.0),NdotL);
#endif
color*=intensityFactor;return color;}void main() {
#ifdef TERRAIN_FRAGMENT_OCCLUSION
if (isOccluded()) {discard;}
#endif
vec3 lightDir=u_lightpos;vec3 lightColor=u_lightcolor;
#ifdef LIGHTING_3D_MODE
lightDir=u_lighting_directional_dir;lightDir.xy=-lightDir.xy;lightColor=u_lighting_directional_color;
#endif
vec4 finalColor;
#ifdef DIFFUSE_SHADED
vec3 N=getNormal();vec3 baseColor=getBaseColor().rgb;vec3 diffuse=getDiffuseShadedColor(baseColor,N,lightDir,lightColor);
#ifdef HAS_TEXTURE_u_occlusionTexture
float ao=(texture(u_occlusionTexture,uv_2f).r-1.0)*u_aoIntensity+1.0;diffuse*=ao;
#endif
finalColor=vec4(mix(diffuse,baseColor,u_emissive_strength),1.0)*u_opacity;
#else
Material mat=getPBRMaterial();vec3 color=computeLightContribution(mat,lightDir,lightColor);float ao=1.0;
#if defined (HAS_TEXTURE_u_occlusionTexture) && defined(HAS_ATTRIBUTE_a_uv_2f)
#ifdef OCCLUSION_TEXTURE_TRANSFORM
vec2 uv=uv_2f.xy*u_occlusionTextureTransform.zw+u_occlusionTextureTransform.xy;
#else
vec2 uv=uv_2f;
#endif
ao=(texture(u_occlusionTexture,uv).x-1.0)*u_aoIntensity+1.0;color*=ao;
#endif
vec4 emissive=u_emissiveFactor;
#if defined(HAS_TEXTURE_u_emissionTexture) && defined(HAS_ATTRIBUTE_a_uv_2f)
emissive.rgb*=sRGBToLinear(texture(u_emissionTexture,uv_2f).rgb);
#endif
#ifdef APPLY_LUT_ON_GPU
float emissiveFactorLength=max(length(u_emissiveFactor.rgb),0.001);emissive.rgb=sRGBToLinear(applyLUT(u_lutTexture,linearTosRGB(emissive.rgb/emissiveFactorLength).rbg))*emissiveFactorLength;
#endif
color+=emissive.rgb;float opacity=mat.baseColor.w*u_opacity;
#ifdef HAS_ATTRIBUTE_a_pbr
float resEmission=v_roughness_metallic_emissive_alpha.z;resEmission*=v_height_based_emission_params.z+v_height_based_emission_params.w*pow(clamp(v_height_based_emission_params.x,0.0,1.0),v_height_based_emission_params.y);vec3 color_mix=v_color_mix.rgb;
#ifdef APPLY_LUT_ON_GPU
color_mix=applyLUT(u_lutTexture,color_mix);
#endif
color=mix(color,color_mix,min(1.0,resEmission));
#ifdef HAS_ATTRIBUTE_a_color_4f
float distance=length(vec2(1.3*max(0.0,abs(color_4f.x)-color_4f.z),color_4f.y));distance+= mix(0.5,0.0,clamp(resEmission-1.0,0.0,1.0));opacity*=v_roughness_metallic_emissive_alpha.w*saturate(1.0-distance*distance);
#endif
#endif
vec3 unlitColor=mat.baseColor.rgb*ao+emissive.rgb;color=mix(color,unlitColor,u_emissive_strength);color=linearTosRGB(color);color*=opacity;finalColor=vec4(color,opacity);
#endif
#ifdef FOG
finalColor=fog_dither(fog_apply_premultiplied(finalColor,v_fog_pos,v_position_height.w));
#endif
#ifdef RENDER_CUTOFF
finalColor*=v_cutoff_opacity;
#endif
#ifdef INDICATOR_CUTOUT
finalColor=applyCutout(finalColor,v_position_height.w);
#endif
#ifdef FEATURE_CUTOUT
finalColor=apply_feature_cutout(finalColor,gl_FragCoord);
#endif
glFragColor=finalColor;
#ifdef OVERDRAW_INSPECTOR
glFragColor=vec4(1.0);
#endif
HANDLE_WIREFRAME_DEBUG;}`,`#include "_prelude_fog.vertex.glsl"
#include "_prelude_shadow.vertex.glsl"
in vec3 a_pos_3f;
#pragma mapbox: define-attribute highp vec3 normal_3f
#pragma mapbox: define-attribute highp vec2 uv_2f
#pragma mapbox: define-attribute highp vec3 color_3f
#pragma mapbox: define-attribute highp vec4 color_4f
#pragma mapbox: define-attribute-vertex-shader-only highp vec4 pbr
#pragma mapbox: define-attribute-vertex-shader-only highp vec3 heightBasedEmissiveStrength
uniform mat4 u_matrix;uniform mat4 u_node_matrix;uniform mat4 u_lighting_matrix;uniform vec3 u_camera_pos;uniform vec4 u_color_mix;
#ifdef INSTANCED_ARRAYS
in vec4 a_normal_matrix0;in vec4 a_normal_matrix1;in vec4 a_normal_matrix2;in vec4 a_normal_matrix3;
#else
uniform highp mat4 u_normal_matrix;
#endif
#ifdef RENDER_SHADOWS
uniform mat4 u_light_matrix_0;uniform mat4 u_light_matrix_1;out highp vec4 v_pos_light_view_0;out highp vec4 v_pos_light_view_1;out float v_depth_shadows;
#endif
out vec4 v_position_height;out lowp vec4 v_color_mix;
#ifdef TERRAIN_FRAGMENT_OCCLUSION
out highp float v_depth;
#endif
#ifdef HAS_ATTRIBUTE_a_pbr
out lowp vec4 v_roughness_metallic_emissive_alpha;out mediump vec4 v_height_based_emission_params;
#endif
vec3 sRGBToLinear(vec3 srgbIn) {return pow(srgbIn,vec3(2.2));}void main() {
#pragma mapbox: initialize-attribute highp vec3 normal_3f
#pragma mapbox: initialize-attribute highp vec2 uv_2f
#pragma mapbox: initialize-attribute highp vec3 color_3f
#pragma mapbox: initialize-attribute highp vec4 color_4f
#pragma mapbox: initialize-attribute-custom highp vec4 pbr
#pragma mapbox: initialize-attribute-custom highp vec3 heightBasedEmissiveStrength
highp mat4 normal_matrix;
#ifdef INSTANCED_ARRAYS
normal_matrix=mat4(a_normal_matrix0,a_normal_matrix1,a_normal_matrix2,a_normal_matrix3);
#else
normal_matrix=u_normal_matrix;
#endif
vec3 local_pos;mat3 rs;
#ifdef MODEL_POSITION_ON_GPU
vec3 pos_color=normal_matrix[0].xyz;vec4 translate=normal_matrix[1];vec3 pos_a=floor(pos_color);vec3 rgb=1.05*(pos_color-pos_a);float hidden=float(pos_a.x > EXTENT);float color_mix=pos_a.z/100.0;v_color_mix=vec4(sRGBToLinear(rgb),color_mix);float meter_to_tile=normal_matrix[0].w;vec4 pos=vec4(pos_a.xy,translate.z,1.0);rs[0].x=normal_matrix[1].w;rs[0].yz=normal_matrix[2].xy;rs[1].xy=normal_matrix[2].zw;rs[1].z=normal_matrix[3].x;rs[2].xyz=normal_matrix[3].yzw;vec4 pos_node=u_lighting_matrix*vec4(a_pos_3f,1.0);vec3 rotated_pos_node=rs*pos_node.xyz;vec3 pos_model_tile=(rotated_pos_node+vec3(translate.xy,0.0))*vec3(meter_to_tile,meter_to_tile,1.0);pos.xyz+=pos_model_tile;local_pos=pos.xyz;gl_Position=mix(u_matrix*pos,AWAY,hidden);pos.z*=meter_to_tile;v_position_height.xyz=pos.xyz-u_camera_pos;
#else
local_pos=a_pos_3f;gl_Position=u_matrix*vec4(a_pos_3f,1);v_position_height.xyz=vec3(u_lighting_matrix*vec4(a_pos_3f,1));v_color_mix=vec4(sRGBToLinear(u_color_mix.rgb),u_color_mix.a);
#endif
v_position_height.w=a_pos_3f.z;
#ifdef HAS_ATTRIBUTE_a_pbr
vec4 albedo_c=decode_color(pbr.xy);vec2 e_r_m=unpack_float(pbr.z);vec2 r_m= unpack_float(e_r_m.y*16.0);r_m.r=r_m.r*16.0;v_color_mix=vec4(albedo_c.rgb,1.0);v_roughness_metallic_emissive_alpha=vec4(vec3(r_m,e_r_m.x)/255.0,albedo_c.a);v_roughness_metallic_emissive_alpha.z*=2.0;float heightBasedRelativeIntepolation=a_pos_3f.z*heightBasedEmissiveStrength.x+heightBasedEmissiveStrength.y;v_height_based_emission_params.x=heightBasedRelativeIntepolation;v_height_based_emission_params.y=heightBasedEmissiveStrength.z;vec2 emissionMultiplierValues=unpack_float(pbr.w)/256.0;v_height_based_emission_params.z=emissionMultiplierValues.x;v_height_based_emission_params.w=emissionMultiplierValues.y-emissionMultiplierValues.x;
#endif
#ifdef FOG
v_fog_pos=fog_position(local_pos);
#endif
#ifdef RENDER_CUTOFF
v_cutoff_opacity=cutoff_opacity(u_cutoff_params,gl_Position.z);
#endif
#ifdef TERRAIN_FRAGMENT_OCCLUSION
v_depth=gl_Position.z/gl_Position.w;
#endif
#ifdef HAS_ATTRIBUTE_a_normal_3f
#ifdef MODEL_POSITION_ON_GPU
float x_squared_scale=dot(rs[0],rs[0]);float y_squared_scale=dot(rs[1],rs[1]);float z_squared_scale=dot(rs[2],rs[2]);vec3 squared_scale=vec3(x_squared_scale,y_squared_scale,z_squared_scale);normal_3f=rs*((u_lighting_matrix*vec4(normal_3f,0.0)).xyz/squared_scale);normal_3f=normalize(normal_3f);
#else
normal_3f=vec3(normal_matrix*vec4(normal_3f,0));
#endif
#endif
#ifdef HAS_ATTRIBUTE_a_pbr
#ifdef HAS_ATTRIBUTE_a_color_4f
v_roughness_metallic_emissive_alpha.w=clamp(color_4f.a*v_roughness_metallic_emissive_alpha.w*(v_roughness_metallic_emissive_alpha.z-1.0),0.0,1.0);
#endif
#endif
#ifdef RENDER_SHADOWS
vec4 shadow_pos=u_node_matrix*vec4(local_pos,1.0);
#ifdef NORMAL_OFFSET
#ifdef HAS_ATTRIBUTE_a_normal_3f
#ifdef MODEL_POSITION_ON_GPU
vec3 offset=shadow_normal_offset(vec3(-normal_3f.xy,normal_3f.z));shadow_pos.xyz+=offset*shadow_normal_offset_multiplier0();
#else
vec3 offset=shadow_normal_offset_model(normal_3f);shadow_pos.xyz+=offset*shadow_normal_offset_multiplier0();
#endif
#endif
#endif
v_pos_light_view_0=u_light_matrix_0*shadow_pos;v_pos_light_view_1=u_light_matrix_1*shadow_pos;v_depth_shadows=gl_Position.w;
#endif
}`),modelDepth:fn(`in highp float v_depth;void main() {
#ifndef DEPTH_TEXTURE
glFragColor=pack_depth(v_depth);
#endif
}`,`in vec3 a_pos_3f;uniform mat4 u_matrix;out highp float v_depth;
#ifdef MODEL_POSITION_ON_GPU
#ifdef INSTANCED_ARRAYS
in vec4 a_normal_matrix0;in vec4 a_normal_matrix1;in vec4 a_normal_matrix2;in vec4 a_normal_matrix3;
#else
uniform highp mat4 u_instance;
#endif
uniform highp mat4 u_node_matrix;
#endif
void main() {
#ifdef MODEL_POSITION_ON_GPU
highp mat4 instance;
#ifdef INSTANCED_ARRAYS
instance=mat4(a_normal_matrix0,a_normal_matrix1,a_normal_matrix2,a_normal_matrix3);
#else
instance=u_instance;
#endif
vec3 pos_color=instance[0].xyz;vec4 translate=instance[1];vec3 pos_a=floor(pos_color);float hidden=float(pos_a.x > EXTENT);float meter_to_tile=instance[0].w;vec4 pos=vec4(pos_a.xy,translate.z,1.0);mat3 rs;rs[0].x=instance[1].w;rs[0].yz=instance[2].xy;rs[1].xy=instance[2].zw;rs[1].z=instance[3].x;rs[2].xyz=instance[3].yzw;vec4 pos_node=u_node_matrix*vec4(a_pos_3f,1.0);vec3 rotated_pos_node=rs*pos_node.xyz;vec3 pos_model_tile=(rotated_pos_node+vec3(translate.xy,0.0))*vec3(meter_to_tile,meter_to_tile,1.0);pos.xyz+=pos_model_tile;gl_Position=mix(u_matrix*pos,AWAY,hidden);
#else
gl_Position=u_matrix*vec4(a_pos_3f,1);
#endif
v_depth=gl_Position.z/gl_Position.w;}`),stars:fn(`in highp vec2 v_uv;in mediump float v_intensity;float shapeCircle(in vec2 uv)
{float beginFade=0.6;float lengthFromCenter=length(v_uv);return 1.0-clamp((lengthFromCenter-beginFade)/(1.0-beginFade),0.0,1.0);}void main() {float alpha=shapeCircle(v_uv);vec3 color=vec3(1.0,1.0,1.0);alpha*=v_intensity;glFragColor=vec4(color*alpha,alpha);HANDLE_WIREFRAME_DEBUG;}`,`
in vec3 a_pos_3f;in vec2 a_uv;in float a_size_scale;in float a_fade_opacity;uniform mat4 u_matrix;uniform vec3 u_up;uniform vec3 u_right;uniform float u_intensity_multiplier;out highp vec2 v_uv;out mediump float v_intensity;void main() {v_uv=a_uv;v_intensity=a_fade_opacity*u_intensity_multiplier;vec3 pos=a_pos_3f;pos+=a_uv.x*u_right*a_size_scale;pos+=a_uv.y*u_up*a_size_scale;gl_Position=u_matrix*vec4(pos,1.0);}`),snowParticle:fn("in highp vec2 uv;in highp float alphaMultiplier;uniform vec4 u_particleColor;uniform vec2 u_simpleShapeParameters;void main() {float t=clamp((length(uv)-u_simpleShapeParameters.x)/(1.0-u_simpleShapeParameters.x),0.0,1.0);float alpha=1.0-pow(t,pow(10.0,u_simpleShapeParameters.y));alpha*=alphaMultiplier;alpha*=u_particleColor.a;vec3 color=u_particleColor.rgb*alpha;glFragColor=vec4(color,alpha) ;HANDLE_WIREFRAME_DEBUG;}",`
in highp vec3 a_pos_3f;in highp vec2 a_uv;in highp vec4 a_snowParticleData;in highp vec4 a_snowParticleDataHorizontalOscillation;uniform mat4 u_modelview;uniform mat4 u_projection;uniform vec3 u_cam_pos;uniform vec2 u_screenSize;uniform float u_time;uniform float u_boxSize;uniform float u_velocityConeAperture; 
uniform float u_velocity;uniform vec3 u_direction;uniform float u_horizontalOscillationRadius; 
uniform float u_horizontalOscillationRate; 
uniform float u_billboardSize;uniform vec2 u_thinningCenterPos;uniform vec3 u_thinningShape;uniform float u_thinningAffectedRatio;uniform float u_thinningParticleOffset;out highp vec2 uv;out highp float alphaMultiplier;void main() {vec3 pos=a_pos_3f;float halfBoxSize=0.5*u_boxSize;pos.xyz*=halfBoxSize;pos+=u_cam_pos;float velocityConeApertureRad=radians(u_velocityConeAperture*0.5);float coneAnglePichRad=velocityConeApertureRad*a_snowParticleData.z;float coneAngleHeadingRad=a_snowParticleData.w*radians(360.0);vec3 localZ=normalize(u_direction);vec3 localX=normalize(cross(localZ,vec3(1,0,0)));vec3 localY=normalize(cross(localZ,localX));vec3 direction;direction.x=cos(coneAngleHeadingRad)*sin(coneAnglePichRad);direction.y=sin(coneAngleHeadingRad)*sin(coneAnglePichRad);direction.z=cos(coneAnglePichRad);direction=normalize(direction);vec3 simPosLocal=vec3(0,0,0);float velocityScale=(1.0+3.0*a_snowParticleData.y)*u_velocity;simPosLocal+=direction*velocityScale*u_time;float horizontalOscillationRadius=u_horizontalOscillationRadius*a_snowParticleDataHorizontalOscillation.x;float horizontalOscillationAngle=u_horizontalOscillationRate*u_time*(-1.0+2.0*a_snowParticleDataHorizontalOscillation.y);simPosLocal.xy+=horizontalOscillationRadius*vec2(cos(horizontalOscillationAngle),sin(horizontalOscillationAngle));vec3 simPos=localX*simPosLocal.x+
localY*simPosLocal.y+localZ*simPosLocal.z;pos+=simPos;pos=fract((pos+vec3(halfBoxSize))/vec3(u_boxSize))*u_boxSize-vec3(halfBoxSize);float clipZ=-u_cam_pos.z+pos.z;vec4 posView=u_modelview*vec4(pos,1.0);float size=u_billboardSize;alphaMultiplier=1.0;vec4 posScreen=u_projection*posView;posScreen/=posScreen.w;posScreen.xy=vec2(0.5)+posScreen.xy*0.5;posScreen.xy*=u_screenSize;vec2 thinningCenterPos=u_thinningCenterPos.xy;thinningCenterPos.y=u_screenSize.y-thinningCenterPos.y;float screenDist=length((thinningCenterPos-posScreen.xy)/(0.5*u_screenSize));screenDist+=a_snowParticleData.x*u_thinningParticleOffset;float scaleFactorMode=0.0;float thinningShapeDist=u_thinningShape.x+u_thinningShape.y;if (screenDist < thinningShapeDist) {float thinningFadeRatio=clamp((screenDist-u_thinningShape.x)/u_thinningShape.y,0.0,1.0);thinningFadeRatio=pow(thinningFadeRatio,u_thinningShape.z);if (a_snowParticleData.x < u_thinningAffectedRatio) {scaleFactorMode=1.0-thinningFadeRatio;alphaMultiplier=thinningFadeRatio;}}vec4 posScreen1=u_projection*vec4(posView.x-size,posView.yzw);posScreen1/=posScreen1.w;vec4 posScreen2=u_projection*vec4(posView.x+size,posView.yzw);posScreen2/=posScreen2.w;posScreen1.xy=vec2(0.5)+posScreen1.xy*0.5;posScreen1.xy*=u_screenSize;posScreen2.xy=vec2(0.5)+posScreen2.xy*0.5;posScreen2.xy*=u_screenSize;float screenLength=length(posScreen1.xy-posScreen2.xy);float screenEpsilon=3.0;float scaleFactor=1.0;if (screenLength < screenEpsilon) {scaleFactor=screenEpsilon/max(screenLength,0.01);scaleFactor=mix(scaleFactor,1.0,scaleFactorMode);}float screenEpsilon2=15.0;if (screenLength > screenEpsilon2) {scaleFactor=screenEpsilon2/max(screenLength,0.01);}size*=scaleFactor;vec2 right=size*vec2(1,0);vec2 up=size*vec2(0,1);posView.xy+=right*a_uv.x;posView.xy+=up*a_uv.y;uv=a_uv;gl_Position=u_projection*posView;}`),rainParticle:fn("in highp vec2 uv;in highp float particleRandomValue;uniform sampler2D u_texScreen;uniform float u_distortionStrength;uniform vec4 u_color;uniform vec2 u_thinningCenterPos;uniform vec3 u_thinningShape;uniform float u_thinningAffectedRatio;uniform float u_thinningParticleOffset;uniform float u_shapeDirectionalPower;uniform float u_mode;void main() {vec2 st=uv*0.5+vec2(0.5);vec2 uvm=uv;uvm.y=-1.0+2.0*pow(st.y,u_shapeDirectionalPower);float shape=clamp(1.0-length(uvm),0.0,1.0);float alpha=abs(shape)*u_color.a;vec2 screenSize=vec2(textureSize(u_texScreen,0));vec2 thinningCenterPos=u_thinningCenterPos.xy;thinningCenterPos.y=screenSize.y-thinningCenterPos.y;float screenDist=length((thinningCenterPos-gl_FragCoord.xy)/(0.5*screenSize));screenDist+=(0.5+0.5*particleRandomValue)*u_thinningParticleOffset;float thinningShapeDist=u_thinningShape.x+u_thinningShape.y;float thinningAlpha=1.0;if (screenDist < thinningShapeDist) {float thinningFadeRatio=clamp((screenDist-u_thinningShape.x)/u_thinningShape.y,0.0,1.0);thinningFadeRatio=pow(thinningFadeRatio,u_thinningShape.z);thinningAlpha*=thinningFadeRatio;}vec2 offsetXY=normalize(uvm)*abs(shape);vec2 stScreen=(gl_FragCoord.xy+offsetXY*u_distortionStrength*thinningAlpha)/screenSize;vec3 colorScreen=texture(u_texScreen,stScreen).rgb;alpha*=thinningAlpha;glFragColor=mix(vec4(colorScreen,1.0),vec4(u_color.rgb*alpha,alpha),u_mode);HANDLE_WIREFRAME_DEBUG;}",`
in highp vec3 a_pos_3f;in highp vec2 a_uv;in highp vec4 a_rainParticleData;uniform mat4 u_modelview;uniform mat4 u_projection;uniform vec3 u_cam_pos;uniform float u_time;uniform float u_boxSize;uniform float u_velocityConeAperture; 
uniform float u_velocity; 
uniform vec2 u_rainDropletSize;uniform vec3 u_rainDirection;out highp vec2 uv;out highp float particleRandomValue;void main() {vec3 pos=a_pos_3f;float halfBoxSize=0.5*u_boxSize;pos*=halfBoxSize; 
pos+=u_cam_pos;float velocityConeApertureRad=radians(u_velocityConeAperture*0.5);float coneAnglePichRad=velocityConeApertureRad*a_rainParticleData.z;float coneAngleHeadingRad=a_rainParticleData.w*radians(360.0);vec3 localZ=normalize(u_rainDirection);vec3 localX=normalize(cross(localZ,vec3(1,0,0)));vec3 localY=normalize(cross(localZ,localX));vec3 directionLocal;directionLocal.x=cos(coneAngleHeadingRad)*sin(coneAnglePichRad);directionLocal.y=sin(coneAngleHeadingRad)*sin(coneAnglePichRad);directionLocal.z=cos(coneAnglePichRad);directionLocal=normalize(directionLocal);vec3 directionWorld=localX*directionLocal.x+localY*directionLocal.y+localZ*directionLocal.z;float velocityScale=(1.0+3.0*a_rainParticleData.y)*u_velocity;vec3 simPosLocal=vec3(0,0,0);simPosLocal+=directionLocal*velocityScale*u_time;vec3 simPos=localX*simPosLocal.x+
localY*simPosLocal.y+localZ*simPosLocal.z;pos+=simPos;pos=fract((pos+vec3(halfBoxSize))/vec3(u_boxSize))*u_boxSize-vec3(halfBoxSize);vec4 posView=u_modelview*vec4(pos,1.0);vec3 directionView=normalize((u_modelview*vec4(directionWorld,0.0)).xyz);vec3 side=cross(directionView,normalize(posView.xyz));posView.xyz+=side*a_uv.x*u_rainDropletSize.x;posView.xyz+=directionView*a_uv.y*u_rainDropletSize.y;uv=a_uv;particleRandomValue=a_rainParticleData.x;gl_Position=u_projection*posView;}`),vignette:fn("uniform vec3 u_vignetteShape;uniform vec4 u_vignetteColor;in vec2 st;void main() {float screenDist=length(st);float alpha=clamp((screenDist-u_vignetteShape.x)/u_vignetteShape.y,0.0,1.0);alpha=pow(alpha,u_vignetteShape.z)*u_vignetteColor.a;vec3 color=u_vignetteColor.rgb;glFragColor=vec4(color*alpha,alpha) ;}","in vec2 a_pos_2f;out vec2 st;void main() {st=a_pos_2f;gl_Position=vec4(a_pos_2f,0,1);}"),occlusion:fn("uniform vec4 u_color;void main() {glFragColor=u_color;}",`#include "_prelude_terrain.vertex.glsl"
in highp vec2 a_offset_xy;uniform highp vec3 u_anchorPos;uniform mat4 u_matrix;uniform vec2 u_screenSizePx;uniform vec2 u_occluderSizePx;void main() {vec3 world_pos=u_anchorPos;
#ifdef TERRAIN
float e=elevation(world_pos.xy);world_pos.z+=e;
#endif
vec4 projected_point=u_matrix*vec4(world_pos,1.0);projected_point.xy+=projected_point.w*a_offset_xy*0.5*u_occluderSizePx/u_screenSizePx;gl_Position=projected_point;}`)};function Sa(l,t){const r=l.replace(/\s*\/\/[^\n]*\n/g,`
`).split(`
`);for(let c of r)if(c=c.trim(),c[0]==="#"&&c.includes("if")&&!c.includes("endif")){c=c.replace("#","").replace(/ifdef|ifndef|elif|if/g,"").replace(/!|defined|\(|\)|\|\||&&/g,"").replace(/\s+/g," ").trim();const p=c.split(" ");for(const _ of p)t.includes(_)||t.push(_)}}function fn(l,t){const r=/#include\s+"([^"]+)"/g,c=/#pragma mapbox: ([\w\-]+) ([\w]+) ([\w]+) ([\w]+)/g;let p=t.match(/(attribute(\S*)|(^\s*|;)in) (highp |mediump |lowp )?([\w]+) ([\w]+)/gm);p&&(p=p.map((M=>{const L=M.split(" ");return L[L.length-1]})),p=[...new Set(p)]);const _={},v=[],b=[];if(l=l.replace(r,((M,L)=>(b.push(L),""))),(t=t.replace(r,((M,L)=>(v.push(L),"")))).includes("flat out"))return void console.error('The usage of "flat" qualifier is disallowed, see: https://bugs.webkit.org/show_bug.cgi?id=268071');let I=[...Zu];Sa(l,I),Sa(t,I);for(const M of[...v,...b])kc[M]||console.error(`Undefined include: ${M}`),Ea[M]||(Ea[M]=[],Sa(kc[M],Ea[M])),I=[...I,...Ea[M]];return{fragmentSource:l=l.replace(c,((M,L,B,F,V)=>(_[V]=!0,L==="define"?`
#ifndef HAS_UNIFORM_u_${V}
in ${B} ${F} ${V};
#else
uniform ${B} ${F} u_${V};
#endif
`:L==="initialize"?`
#ifdef HAS_UNIFORM_u_${V}
    ${B} ${F} ${V} = u_${V};
#endif
`:L==="define-attribute"?`
#ifdef HAS_ATTRIBUTE_a_${V}
    in ${B} ${F} ${V};
#endif
`:L==="initialize-attribute"?"":void 0))),vertexSource:t=t.replace(c,((M,L,B,F,V)=>{const $=F==="float"?"vec2":F,H=V.match(/color/)?"color":$;return L==="define-attribute-vertex-shader-only"?`
#ifdef HAS_ATTRIBUTE_a_${V}
in ${B} ${F} a_${V};
#endif
`:_[V]?L==="define"?`
#ifndef HAS_UNIFORM_u_${V}
uniform lowp float u_${V}_t;
in ${B} ${$} a_${V};
out ${B} ${F} ${V};
#else
uniform ${B} ${F} u_${V};
#endif
`:L==="initialize"?H==="vec4"?`
#ifndef HAS_UNIFORM_u_${V}
    ${V} = a_${V};
#else
    ${B} ${F} ${V} = u_${V};
#endif
`:`
#ifndef HAS_UNIFORM_u_${V}
    ${V} = unpack_mix_${H}(a_${V}, u_${V}_t);
#else
    ${B} ${F} ${V} = u_${V};
#endif
`:L==="define-attribute"?`
#ifdef HAS_ATTRIBUTE_a_${V}
    in ${B} ${F} a_${V};
    out ${B} ${F} ${V};
#endif
`:L==="initialize-attribute"?`
#ifdef HAS_ATTRIBUTE_a_${V}
    ${V} = a_${V};
#endif
`:void 0:L==="define"?`
#ifndef HAS_UNIFORM_u_${V}
uniform lowp float u_${V}_t;
in ${B} ${$} a_${V};
#else
uniform ${B} ${F} u_${V};
#endif
`:L==="define-instanced"?H==="mat4"?`
#ifdef INSTANCED_ARRAYS
in vec4 a_${V}0;
in vec4 a_${V}1;
in vec4 a_${V}2;
in vec4 a_${V}3;
#else
uniform ${B} ${F} u_${V};
#endif
`:`
#ifdef INSTANCED_ARRAYS
in ${B} ${$} a_${V};
#else
uniform ${B} ${F} u_${V};
#endif
`:L==="initialize-attribute-custom"?`
#ifdef HAS_ATTRIBUTE_a_${V}
    ${B} ${F} ${V} = a_${V};
#endif
`:H==="vec4"?`
#ifndef HAS_UNIFORM_u_${V}
    ${B} ${F} ${V} = a_${V};
#else
    ${B} ${F} ${V} = u_${V};
#endif
`:`
#ifndef HAS_UNIFORM_u_${V}
    ${B} ${F} ${V} = unpack_mix_${H}(a_${V}, u_${V}_t);
#else
    ${B} ${F} ${V} = u_${V};
#endif
`})),staticAttributes:p,usedDefines:I,vertexIncludes:v,fragmentIncludes:b}}class bm{constructor(){this.boundProgram=null,this.boundLayoutVertexBuffer=null,this.boundPaintVertexBuffers=[],this.boundIndexBuffer=null,this.boundVertexOffset=null,this.boundDynamicVertexBuffers=[],this.vao=null}bind(t,r,c,p,_,v,b,I){this.context=t;let M=this.boundPaintVertexBuffers.length!==p.length;for(let B=0;!M&&B<p.length;B++)this.boundPaintVertexBuffers[B]!==p[B]&&(M=!0);let L=this.boundDynamicVertexBuffers.length!==b.length;for(let B=0;!L&&B<b.length;B++)this.boundDynamicVertexBuffers[B]!==b[B]&&(L=!0);if(!this.vao||this.boundProgram!==r||this.boundLayoutVertexBuffer!==c||M||L||this.boundIndexBuffer!==_||this.boundVertexOffset!==v)this.freshBind(r,c,p,_,v,b,I);else{t.bindVertexArrayOES.set(this.vao);for(const B of b)B&&(B.bind(),I&&B.instanceCount&&B.setVertexAttribDivisor(t.gl,r,I));_&&_.dynamicDraw&&_.bind()}}freshBind(t,r,c,p,_,v,b){const I=t.numAttributes,M=this.context,L=M.gl;this.vao&&this.destroy(),this.vao=M.gl.createVertexArray(),M.bindVertexArrayOES.set(this.vao),this.boundProgram=t,this.boundLayoutVertexBuffer=r,this.boundPaintVertexBuffers=c,this.boundIndexBuffer=p,this.boundVertexOffset=_,this.boundDynamicVertexBuffers=v,r.enableAttributes(L,t),r.bind(),r.setVertexAttribPointers(L,t,_);for(const B of c)B.enableAttributes(L,t),B.bind(),B.setVertexAttribPointers(L,t,_);for(const B of v)B&&(B.enableAttributes(L,t),B.bind(),B.setVertexAttribPointers(L,t,_),b&&B.instanceCount&&B.setVertexAttribDivisor(L,t,b));p&&p.bind(),M.currentNumAttributes=I}destroy(){this.vao&&(this.context.gl.deleteVertexArray(this.vao),this.vao=null)}}function fu(l,t){const r=Math.pow(2,t.canonical.z),c=t.canonical.y;return[new s.ac(0,c/r).toLngLat().lat,new s.ac(0,(c+1)/r).toLngLat().lat]}function Tm(l,t,r,c,p,_,v){const b=l.context,I=b.gl,M=r.hillshadeFBO;if(!M)return;l.prepareDrawTile();const L=l.isTileAffectedByFog(t),B=l.getOrCreateProgram("hillshade",{overrideFog:L});b.activeTexture.set(I.TEXTURE0),I.bindTexture(I.TEXTURE_2D,M.colorAttachment.get());const F=((X,Z,te,oe)=>{const le=te.paint.get("hillshade-shadow-color"),pe=te.paint.get("hillshade-shadow-color-use-theme").constantOr("default")==="none",ye=te.paint.get("hillshade-highlight-color"),we=te.paint.get("hillshade-highlight-color-use-theme").constantOr("default")==="none",me=te.paint.get("hillshade-accent-color"),_e=te.paint.get("hillshade-accent-color-use-theme").constantOr("default")==="none",ge=te.paint.get("hillshade-emissive-strength");let Be=s.al(te.paint.get("hillshade-illumination-direction"));if(te.paint.get("hillshade-illumination-anchor")==="viewport")Be-=X.transform.angle;else if(X.style&&X.style.enable3dLights()&&X.style.directionalLight){const nt=X.style.directionalLight.properties.get("direction"),He=s.d1(nt.x,nt.y,nt.z);Be=s.al(He[1])}const Ce=!X.options.moving;return{u_matrix:oe||X.transform.calculateProjMatrix(Z.tileID.toUnwrapped(),Ce),u_image:0,u_latrange:fu(0,Z.tileID),u_light:[te.paint.get("hillshade-exaggeration"),Be],u_shadow:le.toPremultipliedRenderColor(pe?null:te.lut),u_highlight:ye.toPremultipliedRenderColor(we?null:te.lut),u_emissive_strength:ge,u_accent:me.toPremultipliedRenderColor(_e?null:te.lut)}})(l,r,c,l.terrain?t.projMatrix:null);l.uploadCommonUniforms(b,B,t.toUnwrapped());const{tileBoundsBuffer:V,tileBoundsIndexBuffer:$,tileBoundsSegments:H}=l.getTileBoundsBuffers(r);B.draw(l,I.TRIANGLES,p,_,v,gi.disabled,F,c.id,V,$,H)}function Id(l,t,r){if(!t.needsDEMTextureUpload)return;const c=l.context,p=c.gl;c.pixelStoreUnpackPremultiplyAlpha.set(!1),t.demTexture=t.demTexture||l.getTileTexture(r.stride);const _=r.getPixels();t.demTexture?t.demTexture.update(_,{premultiply:!1}):t.demTexture=new s.T(c,_,p.R32F,{premultiply:!1}),t.needsDEMTextureUpload=!1}function zf(l,t,r){const c=l.context,p=c.gl;if(!t.dem)return;const _=t.dem;if(c.activeTexture.set(p.TEXTURE1),Id(l,t,_),!t.demTexture)return;t.demTexture.bind(p.NEAREST,p.CLAMP_TO_EDGE);const v=_.dim;c.activeTexture.set(p.TEXTURE0);let b=t.hillshadeFBO;if(!b){const F=new s.T(c,{width:v,height:v,data:null},p.RGBA8);F.bind(p.LINEAR,p.CLAMP_TO_EDGE),b=t.hillshadeFBO=c.createFramebuffer(v,v,!0,"renderbuffer"),b.colorAttachment.set(F.texture)}c.bindFramebuffer.set(b.framebuffer),c.viewport.set([0,0,v,v]);const{tileBoundsBuffer:I,tileBoundsIndexBuffer:M,tileBoundsSegments:L}=l.getMercatorTileBoundsBuffers(),B=[];l.linearFloatFilteringSupported()&&B.push("TERRAIN_DEM_FLOAT_FORMAT"),l.getOrCreateProgram("hillshadePrepare",{defines:B}).draw(l,p.TRIANGLES,Vt.disabled,_i.disabled,ui.unblended,gi.disabled,((F,V)=>{const $=V.stride,H=s.bz();return s.ca(H,0,s.aj,-s.aj,0,0,1),s.bo(H,H,[0,-s.aj,0]),{u_matrix:H,u_image:1,u_dimension:[$,$],u_zoom:F.overscaledZ}})(t.tileID,_),r.id,I,M,L),t.needsHillshadePrepare=!1}class rn{constructor(t){this.gl=t.gl,this.default=this.getDefault(),this.current=this.default,this.dirty=!1}get(){return this.current}set(t){}getDefault(){return this.default}setDefault(){this.set(this.default)}}class Ff extends rn{getDefault(){return s.am.transparent.toNonPremultipliedRenderColor(null)}set(t){const r=this.current;(t.r!==r.r||t.g!==r.g||t.b!==r.b||t.a!==r.a||this.dirty)&&(this.gl.clearColor(t.r,t.g,t.b,t.a),this.current=t,this.dirty=!1)}}class Ad extends rn{getDefault(){return 1}set(t){(t!==this.current||this.dirty)&&(this.gl.clearDepth(t),this.current=t,this.dirty=!1)}}class Oh extends rn{getDefault(){return 0}set(t){(t!==this.current||this.dirty)&&(this.gl.clearStencil(t),this.current=t,this.dirty=!1)}}class Ep extends rn{getDefault(){return[!0,!0,!0,!0]}set(t){const r=this.current;(t[0]!==r[0]||t[1]!==r[1]||t[2]!==r[2]||t[3]!==r[3]||this.dirty)&&(this.gl.colorMask(t[0],t[1],t[2],t[3]),this.current=t,this.dirty=!1)}}class Cd extends rn{getDefault(){return!0}set(t){(t!==this.current||this.dirty)&&(this.gl.depthMask(t),this.current=t,this.dirty=!1)}}class Bh extends rn{getDefault(){return 255}set(t){(t!==this.current||this.dirty)&&(this.gl.stencilMask(t),this.current=t,this.dirty=!1)}}class pu extends rn{getDefault(){return{func:this.gl.ALWAYS,ref:0,mask:255}}set(t){const r=this.current;(t.func!==r.func||t.ref!==r.ref||t.mask!==r.mask||this.dirty)&&(this.gl.stencilFunc(t.func,t.ref,t.mask),this.current=t,this.dirty=!1)}}class Xu extends rn{getDefault(){const t=this.gl;return[t.KEEP,t.KEEP,t.KEEP]}set(t){const r=this.current;(t[0]!==r[0]||t[1]!==r[1]||t[2]!==r[2]||this.dirty)&&(this.gl.stencilOp(t[0],t[1],t[2]),this.current=t,this.dirty=!1)}}class Of extends rn{getDefault(){return!1}set(t){if(t===this.current&&!this.dirty)return;const r=this.gl;t?r.enable(r.STENCIL_TEST):r.disable(r.STENCIL_TEST),this.current=t,this.dirty=!1}}class Bf extends rn{getDefault(){return[0,1]}set(t){const r=this.current;(t[0]!==r[0]||t[1]!==r[1]||this.dirty)&&(this.gl.depthRange(t[0],t[1]),this.current=t,this.dirty=!1)}}class Pd extends rn{getDefault(){return!1}set(t){if(t===this.current&&!this.dirty)return;const r=this.gl;t?r.enable(r.DEPTH_TEST):r.disable(r.DEPTH_TEST),this.current=t,this.dirty=!1}}class Rd extends rn{getDefault(){return this.gl.LESS}set(t){(t!==this.current||this.dirty)&&(this.gl.depthFunc(t),this.current=t,this.dirty=!1)}}class jl extends rn{getDefault(){return!1}set(t){if(t===this.current&&!this.dirty)return;const r=this.gl;t?r.enable(r.BLEND):r.disable(r.BLEND),this.current=t,this.dirty=!1}}class uc extends rn{getDefault(){const t=this.gl;return[t.ONE,t.ZERO,t.ONE,t.ZERO]}set(t){const r=this.current;(t[0]!==r[0]||t[1]!==r[1]||t[2]!==r[2]||t[3]!==r[3]||this.dirty)&&(this.gl.blendFuncSeparate(t[0],t[1],t[2],t[3]),this.current=t,this.dirty=!1)}}class Ku extends rn{getDefault(){return s.am.transparent.toNonPremultipliedRenderColor(null)}set(t){const r=this.current;(t.r!==r.r||t.g!==r.g||t.b!==r.b||t.a!==r.a||this.dirty)&&(this.gl.blendColor(t.r,t.g,t.b,t.a),this.current=t,this.dirty=!1)}}class Yu extends rn{getDefault(){return this.gl.FUNC_ADD}set(t){(t!==this.current||this.dirty)&&(this.gl.blendEquationSeparate(t,t),this.current=t,this.dirty=!1)}}class zc extends rn{getDefault(){return!1}set(t){if(t===this.current&&!this.dirty)return;const r=this.gl;t?r.enable(r.CULL_FACE):r.disable(r.CULL_FACE),this.current=t,this.dirty=!1}}class Md extends rn{getDefault(){return this.gl.BACK}set(t){(t!==this.current||this.dirty)&&(this.gl.cullFace(t),this.current=t,this.dirty=!1)}}class Nf extends rn{getDefault(){return this.gl.CCW}set(t){(t!==this.current||this.dirty)&&(this.gl.frontFace(t),this.current=t,this.dirty=!1)}}let Vf=class extends rn{getDefault(){return null}set(l){(l!==this.current||this.dirty)&&(this.gl.useProgram(l),this.current=l,this.dirty=!1)}};class Qu extends rn{getDefault(){return this.gl.TEXTURE0}set(t){(t!==this.current||this.dirty)&&(this.gl.activeTexture(t),this.current=t,this.dirty=!1)}}class Dd extends rn{getDefault(){const t=this.gl;return[0,0,t.drawingBufferWidth,t.drawingBufferHeight]}set(t){const r=this.current;(t[0]!==r[0]||t[1]!==r[1]||t[2]!==r[2]||t[3]!==r[3]||this.dirty)&&(this.gl.viewport(t[0],t[1],t[2],t[3]),this.current=t,this.dirty=!1)}}class Ju extends rn{getDefault(){return null}set(t){if(t===this.current&&!this.dirty)return;const r=this.gl;r.bindFramebuffer(r.FRAMEBUFFER,t),this.current=t,this.dirty=!1}}class Gl extends rn{getDefault(){return null}set(t){if(t===this.current&&!this.dirty)return;const r=this.gl;r.bindRenderbuffer(r.RENDERBUFFER,t),this.current=t,this.dirty=!1}}class Nh extends rn{getDefault(){return null}set(t){if(t===this.current&&!this.dirty)return;const r=this.gl;r.bindTexture(r.TEXTURE_2D,t),this.current=t,this.dirty=!1}}class Hl extends rn{getDefault(){return null}set(t){if(t===this.current&&!this.dirty)return;const r=this.gl;r.bindBuffer(r.ARRAY_BUFFER,t),this.current=t,this.dirty=!1}}class fl extends rn{getDefault(){return null}set(t){const r=this.gl;r.bindBuffer(r.ELEMENT_ARRAY_BUFFER,t),this.current=t,this.dirty=!1}}class eh extends rn{getDefault(){return null}set(t){this.gl&&(t!==this.current||this.dirty)&&(this.gl.bindVertexArray(t),this.current=t,this.dirty=!1)}}class ql extends rn{getDefault(){return 4}set(t){if(t===this.current&&!this.dirty)return;const r=this.gl;r.pixelStorei(r.UNPACK_ALIGNMENT,t),this.current=t,this.dirty=!1}}class Fc extends rn{getDefault(){return!1}set(t){if(t===this.current&&!this.dirty)return;const r=this.gl;r.pixelStorei(r.UNPACK_PREMULTIPLY_ALPHA_WEBGL,t),this.current=t,this.dirty=!1}}class Sp extends rn{getDefault(){return!1}set(t){if(t===this.current&&!this.dirty)return;const r=this.gl;r.pixelStorei(r.UNPACK_FLIP_Y_WEBGL,t),this.current=t,this.dirty=!1}}class Uf extends rn{constructor(t,r){super(t),this.context=t,this.parent=r}getDefault(){return null}}class mu extends Uf{setDirty(){this.dirty=!0}set(t){if(t===this.current&&!this.dirty)return;this.context.bindFramebuffer.set(this.parent);const r=this.gl;r.framebufferTexture2D(r.FRAMEBUFFER,r.COLOR_ATTACHMENT0,r.TEXTURE_2D,t,0),this.current=t,this.dirty=!1}}class th extends Uf{attachment(){return this.gl.DEPTH_ATTACHMENT}set(t){if(t===this.current&&!this.dirty)return;this.context.bindFramebuffer.set(this.parent);const r=this.gl;r.framebufferRenderbuffer(r.FRAMEBUFFER,this.attachment(),r.RENDERBUFFER,t),this.current=t,this.dirty=!1}}class Oc extends Uf{attachment(){return this.gl.DEPTH_ATTACHMENT}set(t){if(t===this.current&&!this.dirty)return;this.context.bindFramebuffer.set(this.parent);const r=this.gl;r.framebufferTexture2D(r.FRAMEBUFFER,this.attachment(),r.TEXTURE_2D,t,0),this.current=t,this.dirty=!1}}class ih extends th{attachment(){return this.gl.DEPTH_STENCIL_ATTACHMENT}}const Vh=(l,t,r)=>({u_matrix:l,u_image0:0,u_skirt_height:t,u_ground_shadow_factor:r}),hc=(l,t,r,c,p,_,v,b,I,M,L,B,F,V,$,H)=>({u_proj_matrix:Float32Array.from(l),u_globe_matrix:t,u_normalize_matrix:Float32Array.from(c),u_merc_matrix:r,u_zoom_transition:p,u_merc_center:_,u_image0:0,u_frustum_tl:v,u_frustum_tr:b,u_frustum_br:I,u_frustum_bl:M,u_globe_pos:L,u_globe_radius:B,u_viewport:F,u_grid_matrix:H?Float32Array.from(H):new Float32Array(9),u_skirt_height:V,u_far_z_cutoff:$});function $l(l,t){return l!=null&&t!=null&&!(!l.hasData()||!t.hasData())&&l.demTexture!=null&&t.demTexture!=null&&l.tileID.key!==t.tileID.key}const jr=new class{constructor(){this.operations={}}newMorphing(l,t,r,c,p){if(l in this.operations){const _=this.operations[l];_.to.tileID.key!==r.tileID.key&&(_.queued=r)}else this.operations[l]={startTime:c,phase:0,duration:p,from:t,to:r,queued:null}}getMorphValuesForProxy(l){if(!(l in this.operations))return null;const t=this.operations[l];return{from:t.from,to:t.to,phase:t.phase}}update(l){for(const t in this.operations){const r=this.operations[t];for(r.phase=(l-r.startTime)/r.duration;r.phase>=1||!this._validOp(r);)if(!this._nextOp(r,l)){delete this.operations[t];break}}}_nextOp(l,t){return!!l.queued&&(l.from=l.to,l.to=l.queued,l.queued=null,l.phase=0,l.startTime=t,!0)}_validOp(l){return l.from.hasData()&&l.to.hasData()}},os={0:null,1:"TERRAIN_VERTEX_MORPHING"};function Ia(l,t,r){if(t===0)return 0;const c=t<1&&r===514?.25/t:1;return 6*Math.pow(1.5,22-l)*Math.max(t,1)*c}function Us(l,t){const r=1<<l.z;return!t&&(l.x===0||l.x===r-1)||l.y===0||l.y===r-1}const vo=l=>({u_matrix:l});function Ls(l,t,r,c,p){if(p>0){const _=s.q.now(),v=(_-l.timeAdded)/p,b=t?(_-t.timeAdded)/p:-1,I=r.getSource(),M=c.coveringZoomLevel({tileSize:I.tileSize,roundZoom:I.roundZoom}),L=!t||Math.abs(t.tileID.overscaledZ-M)>Math.abs(l.tileID.overscaledZ-M),B=L&&l.refreshedUponExpiration?1:s.ay(L?v:1-b,0,1);return l.refreshedUponExpiration&&v>=1&&(l.refreshedUponExpiration=!1),t?{opacity:1,mix:1-B}:{opacity:B,mix:0}}return{opacity:1,mix:0}}class Bc extends ys{constructor(t){const r=Ll("mock-dem",{type:"raster-dem",maxzoom:t.transform.maxZoom},t.style.dispatcher,t.style);super("mock-dem",r,!1),r.setEventedParent(this),this._sourceLoaded=!0}_loadTile(t,r){t.state="loaded",r(null)}}class xo extends ys{constructor(t){const r=Ll("proxy",{type:"geojson",maxzoom:t.transform.maxZoom},t.style.dispatcher,t.style);super("proxy",r,!1),r.setEventedParent(this),this.map=this.getSource().map=t,this.used=this._sourceLoaded=!0,this.renderCache=[],this.renderCachePool=[],this.proxyCachedFBO={}}update(t,r,c){if(t.freezeTileCoverage)return;this.transform=t;const p=t.coveringTiles({tileSize:this._source.tileSize,minzoom:this._source.minzoom,maxzoom:this._source.maxzoom,roundZoom:this._source.roundZoom,reparseOverscaled:this._source.reparseOverscaled}).reduce(((_,v)=>{if(_[v.key]="",!this._tiles[v.key]){const b=new Ol(v,this._source.tileSize*v.overscaleFactor(),t.tileZoom,void 0,void 0,this._source.worldview);b.state="loaded",this._tiles[v.key]=b}return _}),{});for(const _ in this._tiles)_ in p||(this.freeFBO(_),this._tiles[_].unloadVectorData(),delete this._tiles[_])}freeFBO(t){const r=this.proxyCachedFBO[t];if(r!==void 0){const c=Object.values(r);this.renderCachePool.push(...c),delete this.proxyCachedFBO[t]}}deallocRenderCache(){this.renderCache.forEach((t=>t.fb.destroy())),this.renderCache=[],this.renderCachePool=[],this.proxyCachedFBO={}}}class Nc extends s.aM{constructor(t,r,c){super(t.overscaledZ,t.wrap,t.canonical.z,t.canonical.x,t.canonical.y),this.proxyTileKey=r,this.projMatrix=c}}class Uh extends s.dF{constructor(t,r){super(),this._debugParams={sortTilesHiZFirst:!0,disableRenderCache:!1},t.tp.registerParameter(this._debugParams,["Terrain"],"sortTilesHiZFirst",{},(()=>{this._style.map.triggerRepaint()})),t.tp.registerParameter(this._debugParams,["Terrain"],"disableRenderCache",{},(()=>{this._style.map.triggerRepaint()})),t.tp.registerButton(["Terrain"],"Invalidate Render Cache",(()=>{this.invalidateRenderCache=!0,this._style.map.triggerRepaint()})),this.painter=t,this.terrainTileForTile={},this.prevTerrainTileForTile={};const[c,p,_]=(function(I){const M=new s.ba,L=new s.a_,B=131;M.reserve(17161),L.reserve(33800);const F=s.aj/128,V=s.aj+F/2,$=V+F;for(let X=-F;X<$;X+=F)for(let Z=-F;Z<$;Z+=F){const te=Z<0||Z>V||X<0||X>V?24575:0,oe=s.ay(Math.round(Z),0,s.aj),le=s.ay(Math.round(X),0,s.aj);M.emplaceBack(oe+te,le)}const H=(X,Z)=>{const te=Z*B+X;L.emplaceBack(te+1,te,te+B),L.emplaceBack(te+B,te+B+1,te+1)};for(let X=1;X<129;X++)for(let Z=1;Z<129;Z++)H(Z,X);return[0,129].forEach((X=>{for(let Z=0;Z<130;Z++)H(Z,X),H(X,Z)})),[M,L,32768]})(),v=t.context;this.gridBuffer=v.createVertexBuffer(c,s.bc.members),this.gridIndexBuffer=v.createIndexBuffer(p),this.gridSegments=s.bd.simpleSegment(0,0,c.length,p.length),this.gridNoSkirtSegments=s.bd.simpleSegment(0,0,c.length,_),this.proxyCoords=[],this.proxiedCoords={},this._visibleDemTiles=[],this._drapedRenderBatches=[],this._sourceTilesOverlap={},this.proxySourceCache=new xo(r.map),this.orthoMatrix=s.bz(),s.ca(this.orthoMatrix,this.painter.transform.projection.name==="globe"?.015:0,s.aj,0,s.aj,0,1);const b=v.gl;this._overlapStencilMode=new _i({func:b.GEQUAL,mask:255},0,255,b.KEEP,b.KEEP,b.REPLACE),this._previousZoom=t.transform.zoom,this.pool=[],this._findCoveringTileCache={},this._tilesDirty={},this.style=r,this._useVertexMorphing=!0,this._exaggeration=1,this._mockSourceCache=new Bc(r.map),this._pendingGroundEffectLayers=[]}set style(t){t.on("data",this._onStyleDataEvent.bind(this)),this._style=t,this._style.map.on("moveend",(()=>{this._clearLineLayersFromRenderCache()}))}update(t,r,c){if(t&&t.terrain){this._style!==t&&(this.style=t,this._evaluationZoom=void 0);const p=t.terrain.properties,_=t.terrain.drapeRenderMode===0,v=t.terrain.isZoomDependent();this._previousUpdateTimestamp=this.enabled?this._updateTimestamp:void 0,this._updateTimestamp=s.q.now();const b=t.terrain&&t.terrain.scope,I=p.get("source"),M=_?this._mockSourceCache:t.getSourceCache(I,b);if(!M)return void s.w(`Couldn't find terrain source "${I}".`);if(this.sourceCache=M,this._attenuationRange=t.terrain.getAttenuationRange(),this._exaggeration=v?this.calculateExaggeration(r):p.get("exaggeration"),!r.projection.requiresDraping&&v&&this._exaggeration===0)return void this._disable();this.enabled=!0;const L=()=>{this.sourceCache.used&&s.w(`Raster DEM source '${this.sourceCache.id}' is used both for terrain and as layer source.
This leads to lower resolution of hillshade. For full hillshade resolution but higher memory consumption, define another raster DEM source.`);const B=this.getScaledDemTileSize();this.sourceCache.update(r,B,!0),this.resetTileLookupCache(this.sourceCache.id)};this.sourceCache.usedForTerrain||(this.resetTileLookupCache(this.sourceCache.id),this.sourceCache.usedForTerrain=!0,L(),this._initializing=!0),L(),r.updateElevation(!0,c),this.resetTileLookupCache(this.proxySourceCache.id),this.proxySourceCache.update(r),this._emptyDEMTextureDirty=!0,this._previousZoom=r.zoom}else this._disable()}calculateExaggeration(t){if(this._attenuationRange&&t.zoom>=Math.ceil(this._attenuationRange[1]))return this._style.terrain.getExaggeration(t.zoom);const r=this._previousCameraAltitude,c=t.getFreeCameraOptions().position.z/t.pixelsPerMeter*t.worldSize;this._previousCameraAltitude=c;const p=r!=null?c-r:Number.MAX_VALUE;if(Math.abs(p)<2)return this._exaggeration;const _=t.zoom,v=this._style.terrain;if(!this._previousUpdateTimestamp)return v.getExaggeration(_);let b=_-this._previousZoom;const I=this._previousUpdateTimestamp;let M=_;this._evaluationZoom!=null&&(M=this._evaluationZoom,Math.abs(_-M)>.5&&(b=.5*(_-M+b)),b*p<0&&(M+=b)),this._evaluationZoom=M;const L=v.getExaggeration(M),B=L===v.getExaggeration(Math.max(0,M-.1));if(B&&Math.abs(L-this._exaggeration)<.01)return L;let F=Math.min(.1,.00375*(this._updateTimestamp-I));return(B||L<.1||Math.abs(b)<1e-4)&&(F=Math.min(.2,4*F)),s.ai(this._exaggeration,L,F)}resetTileLookupCache(t){this._findCoveringTileCache[t]={}}attenuationRange(){return this._attenuationRange}getDemUpscale(){return this.proxySourceCache.getSource().tileSize/128}getScaledDemTileSize(){return this.sourceCache.getSource().tileSize/128*this.proxySourceCache.getSource().tileSize}_onStyleDataEvent(t){t.coord&&t.dataType==="source"?this._clearRenderCacheForTile(t.sourceCacheId,t.coord):t.dataType==="style"&&(this.invalidateRenderCache=!0,this._evaluationZoom=void 0,this._previousUpdateTimestamp=void 0,this._previousCameraAltitude=void 0)}_disable(){if(this.enabled&&(this.enabled=!1,this._emptyDEMTextureDirty=!0,this._sharedDepthStencil=void 0,this._evaluationZoom=void 0,this._previousUpdateTimestamp=void 0,this.proxySourceCache.deallocRenderCache(),this._style))for(const t in this._style._mergedSourceCaches)this._style._mergedSourceCaches[t].usedForTerrain=!1}destroy(){this._disable(),this._emptyDEMTexture&&this._emptyDEMTexture.destroy(),this.pool.forEach((t=>t.fb.destroy())),this.pool=[],this.framebufferCopyTexture&&this.framebufferCopyTexture.destroy()}_source(){return this.enabled?this.sourceCache:null}isUsingMockSource(){return this.sourceCache===this._mockSourceCache}exaggeration(){return this.enabled?this._exaggeration:0}get visibleDemTiles(){return this._visibleDemTiles}get drapeBufferSize(){const t=2*this.proxySourceCache.getSource().tileSize;return[t,t]}set useVertexMorphing(t){this._useVertexMorphing=t}updateTileBinding(t){if(!this.enabled)return;this.prevTerrainTileForTile=this.terrainTileForTile;const r=this.proxySourceCache,c=this.painter.transform;this._initializing&&(this._initializing=c._centerAltitude===0&&this.getAtPointOrZero(s.ac.fromLngLat(c.center),-1)===-1,this._emptyDEMTextureDirty=!this._initializing);const p=this.proxyCoords=r.getIds().map((I=>{const M=r.getTileByID(I).tileID;return M.projMatrix=c.calculateProjMatrix(M.toUnwrapped()),M}));(function(I,M){const L=M.transform.pointCoordinate(M.transform.getCameraPoint()),B=new s.P(L.x,L.y);I.sort(((F,V)=>{if(V.overscaledZ-F.overscaledZ)return V.overscaledZ-F.overscaledZ;const $=new s.P(F.canonical.x+(1<<F.canonical.z)*F.wrap,F.canonical.y),H=new s.P(V.canonical.x+(1<<V.canonical.z)*V.wrap,V.canonical.y),X=B.mult(1<<F.canonical.z);return X.x-=.5,X.y-=.5,X.distSqr($)-X.distSqr(H)}))})(p,this.painter);const _=this.proxyToSource||{};this.proxyToSource={},p.forEach((I=>{this.proxyToSource[I.key]={}})),this.terrainTileForTile={};const v=this._style._mergedSourceCaches;for(const I in v){const M=v[I];if(!M.used||(M!==this.sourceCache&&this.resetTileLookupCache(M.id),this._setupProxiedCoordsForOrtho(M,t[I],_),M.usedForTerrain))continue;const L=t[I];M.getSource().reparseOverscaled&&this._assignTerrainTiles(L)}this.proxiedCoords[r.id]=p.map((I=>new Nc(I,I.key,this.orthoMatrix))),this._assignTerrainTiles(p),this._prepareDEMTextures(),this._setupDrapedRenderBatches(),this._initFBOPool(),this._setupRenderCache(_),this.renderingToTexture=!1;const b={};this._visibleDemTiles=[];for(const I of this.proxyCoords){const M=this.terrainTileForTile[I.key];if(!M)continue;const L=M.tileID.key;L in b||(this._visibleDemTiles.push(M),b[L]=L)}}_assignTerrainTiles(t){this._initializing||t.forEach((r=>{if(this.terrainTileForTile[r.key])return;const c=this._findTileCoveringTileID(r,this.sourceCache);c&&(this.terrainTileForTile[r.key]=c)}))}_prepareDEMTextures(){const t=this.painter.context,r=t.gl;for(const c in this.terrainTileForTile){const p=this.terrainTileForTile[c],_=p.dem;!_||p.demTexture&&!p.needsDEMTextureUpload||(t.activeTexture.set(r.TEXTURE1),Id(this.painter,p,_))}}_prepareDemTileUniforms(t,r,c,p){if(!r||r.demTexture==null)return!1;const _=t.tileID.canonical,v=Math.pow(2,r.tileID.canonical.z-_.z),b=p||"";return c[`u_dem_tl${b}`]=[_.x*v%1,_.y*v%1],c[`u_dem_scale${b}`]=v,!0}get emptyDEMTexture(){return!this._emptyDEMTextureDirty&&this._emptyDEMTexture?this._emptyDEMTexture:this._updateEmptyDEMTexture()}_getLoadedAreaMinimum(){if(!this.enabled)return 0;let t=0;const r=this._visibleDemTiles.reduce(((c,p)=>{if(!p.dem)return c;const _=p.dem.tree.minimums[0];return _>0&&t++,c+_}),0);return t?r/t:0}_updateEmptyDEMTexture(){const t=this.painter.context,r=t.gl;t.activeTexture.set(r.TEXTURE2);const c=this._getLoadedAreaMinimum(),p=new s.dG({width:1,height:1},new Float32Array([c]));this._emptyDEMTextureDirty=!1;let _=this._emptyDEMTexture;return _?_.update(p,{premultiply:!1}):_=this._emptyDEMTexture=new s.T(t,p,r.R32F,{premultiply:!1}),_}setupElevationDraw(t,r,c){const p=this.painter.context,_=p.gl,v={u_dem:2,u_dem_prev:4,u_dem_tl:[0,0],u_dem_tl_prev:[0,0],u_dem_scale:0,u_dem_scale_prev:0,u_dem_size:0,u_dem_lerp:1,u_depth:3,u_depth_size_inv:[0,0],u_depth_range_unpack:[0,1],u_occluder_half_size:16,u_occlusion_depth_offset:-1e-4,u_exaggeration:0};v.u_exaggeration=this.exaggeration();let b=null,I=null,M=1;if(c&&c.morphing&&this._useVertexMorphing){const V=c.morphing.srcDemTile,$=c.morphing.dstDemTile;M=c.morphing.phase,V&&$&&(this._prepareDemTileUniforms(t,V,v,"_prev")&&(I=V),this._prepareDemTileUniforms(t,$,v)&&(b=$))}const L=V=>V&&V.demTexture&&this.painter.linearFloatFilteringSupported()?_.LINEAR:_.NEAREST;let B=null;var F;if(this.enabled?I&&b?(B=b.demTexture,p.activeTexture.set(_.TEXTURE4),I.demTexture.bind(L(I),_.CLAMP_TO_EDGE),v.u_dem_lerp=M):(b=this.terrainTileForTile[t.tileID.key],B=this._prepareDemTileUniforms(t,b,v)?b.demTexture:this.emptyDEMTexture):B=this.emptyDEMTexture,p.activeTexture.set(_.TEXTURE2),B&&(v.u_dem_size=(F=B).size[0]===1?1:F.size[0]-2,B.bind(L(b),_.CLAMP_TO_EDGE)),this.painter.setupDepthForOcclusion(c&&c.useDepthForOcclusion,r,v),c&&c.useMeterToDem&&b){const V=(1<<b.tileID.canonical.z)*s.cb(1,this.painter.transform.center.lat)*this.sourceCache.getSource().tileSize;v.u_meter_to_dem=V}if(c&&c.labelPlaneMatrixInv&&(v.u_label_plane_matrix_inv=c.labelPlaneMatrixInv),r.setTerrainUniformValues(p,v),this.painter.transform.projection.name==="globe"){const V=this.globeUniformValues(this.painter.transform,t.tileID.canonical,c&&c.useDenormalizedUpVectorScale);r.setGlobeUniformValues(p,V)}}globeUniformValues(t,r,c){const p=t.projection;return{u_tile_tl_up:p.upVector(r,0,0),u_tile_tr_up:p.upVector(r,s.aj,0),u_tile_br_up:p.upVector(r,s.aj,s.aj),u_tile_bl_up:p.upVector(r,0,s.aj),u_tile_up_scale:c?s.dH(1):p.upVectorScale(r,t.center.lat,t.worldSize).metersToTile}}renderToBackBuffer(t){const r=this.painter,c=this.painter.context;t.length!==0&&(c.bindFramebuffer.set(null),c.viewport.set([0,0,r.width,r.height]),r.gpuTimingDeferredRenderStart(),this.renderingToTexture=!1,(function(p,_,v,b,I){if(p.transform.projection.name==="globe")(function(M,L,B,F,V){const $=M.context,H=$.gl;let X,Z;const te=M.transform,oe=s.dy(M,$,te),le=(nt,He)=>{if(Z===He)return;const at=[os[He],"PROJECTION_GLOBE_VIEW"];oe&&at.push("CUSTOM_ANTIALIASING");const mt=M.isTileAffectedByFog(nt);X=M.getOrCreateProgram("globeRaster",{defines:at,overrideFog:mt}),Z=He},pe=M.colorModeForRenderPass(),ye=new Vt(H.LEQUAL,Vt.ReadWrite,M.depthRangeFor3D);jr.update(V);const we=s.dz(te),me=[s.aD(te.center.lng),s.aH(te.center.lat)],_e=M.globeSharedBuffers,ge=[te.width*s.q.devicePixelRatio,te.height*s.q.devicePixelRatio],Be=Float32Array.from(te.globeMatrix),Ce={useDenormalizedUpVectorScale:!0};{const nt=M.transform,He=Ia(nt.zoom,L.exaggeration(),L.sourceCache._source.tileSize);Z=-1;const at=H.TRIANGLES;for(const mt of F){const ze=B.getTile(mt),Te=_i.disabled,Ze=L.prevTerrainTileForTile[mt.key],Ue=L.terrainTileForTile[mt.key];$l(Ze,Ue)&&jr.newMorphing(mt.key,Ze,Ue,V,250),$.activeTexture.set(H.TEXTURE0),ze.texture&&ze.texture.bind(H.LINEAR,H.CLAMP_TO_EDGE);const dt=jr.getMorphValuesForProxy(mt.key),ft=dt?1:0;dt&&s.L(Ce,{morphing:{srcDemTile:dt.from,dstDemTile:dt.to,phase:s.dx(dt.phase)}});const xt=s.dA(mt.canonical),It=s.dB(xt.getCenter().lat),Qt=s.dC(mt.canonical,xt,It,nt.worldSize/nt._pixelsPerMercatorPixel),oi=s.bh(s.dD(mt.canonical)),qt=hc(nt.expandedFarZProjMatrix,Be,we,oi,s.ah(nt.zoom),me,nt.frustumCorners.TL,nt.frustumCorners.TR,nt.frustumCorners.BR,nt.frustumCorners.BL,nt.globeCenterInViewSpace,nt.globeRadius,ge,He,nt._farZ,Qt);if(le(mt,ft),X&&(L.setupElevationDraw(ze,X,Ce),M.uploadCommonUniforms($,X,mt.toUnwrapped()),_e)){const[si,Jt,Ci]=_e.getGridBuffers(It,He!==0);X.draw(M,at,ye,Te,pe,gi.backCCW,qt,"globe_raster",si,Jt,Ci)}}}if(_e&&(M.renderDefaultNorthPole||M.renderDefaultSouthPole)){const nt=["GLOBE_POLES","PROJECTION_GLOBE_VIEW"];oe&&nt.push("CUSTOM_ANTIALIASING"),X=M.getOrCreateProgram("globeRaster",{defines:nt});for(const He of F){const{x:at,y:mt,z:ze}=He.canonical,Te=mt===0,Ze=mt===(1<<ze)-1,[Ue,dt,ft,xt]=_e.getPoleBuffers(ze,!1);if(xt&&(Te||Ze)){const It=B.getTile(He);$.activeTexture.set(H.TEXTURE0),It.texture&&It.texture.bind(H.LINEAR,H.CLAMP_TO_EDGE);let Qt=s.dE(ze,at,te);const oi=s.bh(s.dD(He.canonical)),qt=(si,Jt)=>si.draw(M,H.TRIANGLES,ye,_i.disabled,pe,gi.disabled,hc(te.expandedFarZProjMatrix,Qt,Qt,oi,0,me,te.frustumCorners.TL,te.frustumCorners.TR,te.frustumCorners.BR,te.frustumCorners.BL,te.globeCenterInViewSpace,te.globeRadius,ge,0,te._farZ),"globe_pole_raster",Jt,ft,xt);L.setupElevationDraw(It,X,Ce),M.uploadCommonUniforms($,X,He.toUnwrapped()),Te&&M.renderDefaultNorthPole&&qt(X,Ue),Ze&&M.renderDefaultSouthPole&&(Qt=s.cP(s.bz(),Qt,[1,-1,1]),qt(X,dt))}}}})(p,_,v,b,I);else{const M=p.context,L=M.gl;let B,F;const V=p.shadowRenderer,$=ta(p,p.longestCutoffRange),H=pe=>{if(F===pe)return;const ye=[];ye.push(os[pe]),$.shouldRenderCutoff&&ye.push("RENDER_CUTOFF"),V&&(ye.push("RENDER_SHADOWS","DEPTH_TEXTURE"),V.useNormalOffset&&ye.push("NORMAL_OFFSET")),B=p.getOrCreateProgram("terrainRaster",{defines:ye}),F=pe},X=p.colorModeForRenderPass(),Z=new Vt(L.LEQUAL,Vt.ReadWrite,p.depthRangeFor3D);jr.update(I);const te=p.transform,oe=Ia(te.zoom,_.exaggeration(),_.sourceCache._source.tileSize);let le=[0,0,0];if(V){const pe=p.style.directionalLight,ye=p.style.ambientLight;pe&&ye&&(le=lc(p.style,pe,ye))}{F=-1;const pe=L.TRIANGLES,[ye,we]=[_.gridIndexBuffer,_.gridSegments];for(const me of b){const _e=v.getTile(me),ge=_i.disabled,Be=_.prevTerrainTileForTile[me.key],Ce=_.terrainTileForTile[me.key];$l(Be,Ce)&&jr.newMorphing(me.key,Be,Ce,I,250),M.activeTexture.set(L.TEXTURE0),_e.texture&&_e.texture.bind(L.LINEAR,L.CLAMP_TO_EDGE);const nt=jr.getMorphValuesForProxy(me.key),He=nt?1:0;let at;nt&&(at={morphing:{srcDemTile:nt.from,dstDemTile:nt.to,phase:s.dx(nt.phase)}});const mt=Vh(me.projMatrix,Us(me.canonical,te.renderWorldCopies)?oe/10:oe,le);if(H(He),!B)continue;_.setupElevationDraw(_e,B,at);const ze=me.toUnwrapped();V&&V.setupShadows(ze,B),p.uploadCommonUniforms(M,B,ze,null,$),B.draw(p,pe,Z,ge,X,gi.backCCW,mt,"terrain_raster",_.gridBuffer,ye,we)}}}})(r,this,this.proxySourceCache,t,this._updateTimestamp),this.renderingToTexture=!0,r.gpuTimingDeferredRenderEnd(),t.splice(0,t.length))}renderBatch(t){if(this._drapedRenderBatches.length===0)return t+1;this.renderingToTexture=!0;const r=this.painter,c=this.painter.context,p=this.proxySourceCache,_=this.proxiedCoords[p.id],v=this._drapedRenderBatches.shift(),b=r.style.order,I=[];let M=0;for(const L of _){const B=p.getTileByID(L.proxyTileKey),F=p.proxyCachedFBO[L.key]?p.proxyCachedFBO[L.key][t]:void 0,V=F!==void 0?p.renderCache[F]:this.pool[M++],$=F!==void 0;if(B.texture=V.tex,$&&!V.dirty){I.push(B.tileID);continue}let H;c.bindFramebuffer.set(V.fb.framebuffer),this.renderedToTile=!1,V.dirty&&(c.clear({color:s.am.transparent,stencil:0}),V.dirty=!1);for(let X=v.start;X<=v.end;++X){const Z=r.style._mergedLayers[b[X]];if(Z.isHidden(r.transform.zoom))continue;const te=r.style.getLayerSourceCache(Z),oe=te?this.proxyToSource[L.key][te.id]:[L];if(!oe)continue;const le=oe;c.viewport.set([0,0,V.fb.width,V.fb.height]),H!==(te?te.id:null)&&(this._setupStencil(V,oe,Z,te),H=te?te.id:null),r.renderLayer(r,te,Z,le)}if(this._drapedRenderBatches.length===0)for(const X of this._pendingGroundEffectLayers){const Z=r.style._mergedLayers[b[X]];if(Z.isHidden(r.transform.zoom))continue;const te=r.style.getLayerSourceCache(Z),oe=te?this.proxyToSource[L.key][te.id]:[L];if(!oe)continue;const le=oe;c.viewport.set([0,0,V.fb.width,V.fb.height]),H!==(te?te.id:null)&&(this._setupStencil(V,oe,Z,te),H=te?te.id:null),r.renderLayer(r,te,Z,le)}this.renderedToTile?(V.dirty=!0,I.push(B.tileID)):$||--M,M===5&&(M=0,this.renderToBackBuffer(I))}return this.renderToBackBuffer(I),this.renderingToTexture=!1,c.bindFramebuffer.set(null),c.viewport.set([0,0,r.width,r.height]),v.end+1}postRender(){}isLayerOrderingCorrect(t){const r=t.order.length;let c=-1,p=r;for(let _=0;_<r;++_)this._style.isLayerDraped(t._mergedLayers[t.order[_]])?c=Math.max(c,_):p=Math.min(p,_);return p>c}getMinElevationBelowMSL(){let t=0;return this._visibleDemTiles.filter((r=>r.dem)).forEach((r=>{t=Math.min(t,r.dem.tree.minimums[0])})),t===0?t:(t-30)*this._exaggeration}raycast(t,r,c){if(!this._visibleDemTiles)return null;const p=this._visibleDemTiles.filter((_=>_.dem)).map((_=>{const v=_.tileID,b=1<<v.overscaledZ,{x:I,y:M}=v.canonical,L=I/b,B=(I+1)/b,F=M/b,V=(M+1)/b;return{minx:L,miny:F,maxx:B,maxy:V,t:_.dem.tree.raycastRoot(L,F,B,V,t,r,c),tile:_}}));p.sort(((_,v)=>(_.t!==null?_.t:Number.MAX_VALUE)-(v.t!==null?v.t:Number.MAX_VALUE)));for(const _ of p){if(_.t==null)return null;const v=_.tile.dem.tree.raycast(_.minx,_.miny,_.maxx,_.maxy,t,r,c);if(v!=null)return v}return null}_createFBO(){const t=this.painter.context,r=t.gl,c=this.drapeBufferSize;t.activeTexture.set(r.TEXTURE0);const p=new s.T(t,{width:c[0],height:c[1],data:null},r.RGBA8);p.bind(r.LINEAR,r.CLAMP_TO_EDGE);const _=t.createFramebuffer(c[0],c[1],!0,null);return _.colorAttachment.set(p.texture),_.depthAttachment=new ih(t,_.framebuffer),this._sharedDepthStencil===void 0?(this._sharedDepthStencil=t.createRenderbuffer(t.gl.DEPTH_STENCIL,c[0],c[1]),this._stencilRef=0,_.depthAttachment.set(this._sharedDepthStencil),t.clear({stencil:0})):_.depthAttachment.set(this._sharedDepthStencil),t.extTextureFilterAnisotropic&&r.texParameterf(r.TEXTURE_2D,t.extTextureFilterAnisotropic.TEXTURE_MAX_ANISOTROPY_EXT,t.extTextureFilterAnisotropicMax),{fb:_,tex:p,dirty:!1}}_initFBOPool(){for(;this.pool.length<Math.min(5,this.proxyCoords.length);)this.pool.push(this._createFBO())}_shouldDisableRenderCache(){if(this._debugParams.disableRenderCache||this._style.hasLightTransitions())return!0;for(const t in this._style._mergedSourceCaches)if(this._style._mergedSourceCaches[t].hasTransition())return!0;return this._style.order.some((t=>{const r=this._style._mergedLayers[t],c=r.isHidden(this.painter.transform.zoom);return r.type==="hillshade"||r.type==="custom"?!c&&r.shouldRedrape():!c&&r.hasTransition()}))}_clearLineLayersFromRenderCache(){let t=!1;for(const c of this._style.getSources())if(c instanceof Ks){t=!0;break}if(!t)return;const r={};for(let c=0;c<this._style.order.length;++c){const p=this._style._mergedLayers[this._style.order[c]],_=this._style.getLayerSourceCache(p);if(_&&!r[_.id]&&!p.isHidden(this.painter.transform.zoom)&&p.type==="line"&&p.widthExpression()instanceof s.ab){r[_.id]=!0;for(const v of this.proxyCoords){const b=this.proxyToSource[v.key][_.id];if(b)for(const I of b)this._clearRenderCacheForTile(_.id,I)}}}}_clearRasterLayersFromRenderCache(){let t=!1;for(const c in this._style._mergedSourceCaches)if(this._style._mergedSourceCaches[c]._source instanceof ws){t=!0;break}if(!t)return;const r={};for(let c=0;c<this._style.order.length;++c){const p=this._style._mergedLayers[this._style.order[c]],_=this._style.getLayerSourceCache(p);if(!_||r[_.id]||p.isHidden(this.painter.transform.zoom)||p.type!=="raster")continue;const v=p.paint.get("raster-fade-duration");for(const b of this.proxyCoords){const I=this.proxyToSource[b.key][_.id];if(I)for(const M of I){const L=Ls(_.getTile(M),_.findLoadedParent(M,0),_,this.painter.transform,v);(L.opacity!==1||L.mix!==0)&&this._clearRenderCacheForTile(_.id,M)}}}}_setupDrapedRenderBatches(){this._style.updateDrapeFirstLayers();const t=this._style.order,r=t.length;if(r===0)return;const c=[];this._pendingGroundEffectLayers=[];let p,_=0,v=this._style._mergedLayers[t[_]];for(;!this._style.isLayerDraped(v)&&v.isHidden(this.painter.transform.zoom)&&++_<r;)v=this._style._mergedLayers[t[_]];for(;_<r;++_){const b=this._style._mergedLayers[t[_]];b.isHidden(this.painter.transform.zoom)||(this._style.isLayerDraped(b)?p===void 0&&(p=_):(b.type==="fill-extrusion"&&this._pendingGroundEffectLayers.push(_),p!==void 0&&(c.push({start:p,end:_-1}),p=void 0)))}if(p!==void 0&&c.push({start:p,end:_-1}),c.length!==0){const b=c[c.length-1];this._pendingGroundEffectLayers.every((I=>I>b.end))||s.w("fill-extrusion with flood lighting and/or ground ambient occlusion should be moved to be on top of all draped layers.")}this._drapedRenderBatches=c}_setupRenderCache(t){const r=this.proxySourceCache;if(this._shouldDisableRenderCache()||this.invalidateRenderCache){if(this.invalidateRenderCache=!1,r.renderCache.length>r.renderCachePool.length){const v=Object.values(r.proxyCachedFBO);r.proxyCachedFBO={};for(let b=0;b<v.length;++b){const I=Object.values(v[b]);r.renderCachePool.push(...I)}}return}this._clearRasterLayersFromRenderCache();const c=this.proxyCoords,p=this._tilesDirty;for(let v=c.length-1;v>=0;v--){const b=c[v];if(r.getTileByID(b.key),r.proxyCachedFBO[b.key]!==void 0){const I=t[b.key],M=this.proxyToSource[b.key];let L=0;for(const B in M){const F=M[B],V=I[B];if(!V||V.length!==F.length||F.some((($,H)=>$!==V[H]||p[B]&&p[B].hasOwnProperty($.key)))){L=-1;break}++L}for(const B in r.proxyCachedFBO[b.key])r.renderCache[r.proxyCachedFBO[b.key][B]].dirty=L<0||L!==Object.values(I).length}}const _=[...this._drapedRenderBatches];_.sort(((v,b)=>b.end-b.start-(v.end-v.start)));for(const v of _)for(const b of c){if(r.proxyCachedFBO[b.key])continue;let I=r.renderCachePool.pop();I===void 0&&r.renderCache.length<50&&(I=r.renderCache.length,r.renderCache.push(this._createFBO())),I!==void 0&&(r.proxyCachedFBO[b.key]={},r.proxyCachedFBO[b.key][v.start]=I,r.renderCache[I].dirty=!0)}this._tilesDirty={}}_setupStencil(t,r,c,p){if(!p||!this._sourceTilesOverlap[p.id])return void(this._overlapStencilType&&(this._overlapStencilType=!1));const _=this.painter.context,v=_.gl;if(r.length<=1)return void(this._overlapStencilType=!1);let b;if(c.isTileClipped())b=r.length,this._overlapStencilMode.test={func:v.EQUAL,mask:255},this._overlapStencilType="Clip";else{if(!(r[0].overscaledZ>r[r.length-1].overscaledZ))return void(this._overlapStencilType=!1);b=1,this._overlapStencilMode.test={func:v.GREATER,mask:255},this._overlapStencilType="Mask"}this._stencilRef+b>255&&(_.clear({stencil:0}),this._stencilRef=0),this._stencilRef+=b,this._overlapStencilMode.ref=this._stencilRef,c.isTileClipped()&&this._renderTileClippingMasks(r,this._overlapStencilMode.ref)}clipOrMaskOverlapStencilType(){return this._overlapStencilType==="Clip"||this._overlapStencilType==="Mask"}stencilModeForRTTOverlap(t){return this.renderingToTexture&&this._overlapStencilType?(this._overlapStencilType==="Clip"&&(this._overlapStencilMode.ref=this.painter._tileClippingMaskIDs[t.key]),this._overlapStencilMode):_i.disabled}_renderTileClippingMasks(t,r){const c=this.painter,p=this.painter.context,_=p.gl;c._tileClippingMaskIDs={},p.setColorMode(ui.disabled),p.setDepthMode(Vt.disabled);const v=c.getOrCreateProgram("clippingMask");for(const b of t){const I=c._tileClippingMaskIDs[b.key]=--r;v.draw(c,_.TRIANGLES,Vt.disabled,new _i({func:_.ALWAYS,mask:0},I,255,_.KEEP,_.KEEP,_.REPLACE),ui.disabled,gi.disabled,vo(b.projMatrix),"$clipping",c.tileExtentBuffer,c.quadTriangleIndexBuffer,c.tileExtentSegments)}}pointCoordinate(t){const r=this.painter.transform;if(t.x<0||t.x>r.width||t.y<0||t.y>r.height)return null;const c=[t.x,t.y,1,1];s.aA(c,c,r.pixelMatrixInverse),s.cH(c,c,1/c[3]),c[0]/=r.worldSize,c[1]/=r.worldSize;const p=r._camera.position,_=s.cb(1,r.center.lat),v=[p[0],p[1],p[2]/_,0],b=s.d7([],c.slice(0,3),v);s.au(b,b);const I=this.raycast(v,b,this._exaggeration);return I!==null&&I?(s.bE(v,v,b,I),v[3]=v[2],v[2]*=_,v):null}_setupProxiedCoordsForOrtho(t,r,c){if(t.getSource()instanceof s.aP)return this._setupProxiedCoordsForImageSource(t,r,c);this._findCoveringTileCache[t.id]=this._findCoveringTileCache[t.id]||{};const p=this.proxiedCoords[t.id]=[],_=this.proxyCoords;for(let I=0;I<_.length;I++){const M=_[I],L=this._findTileCoveringTileID(M,t);if(L){const B=this._createProxiedId(M,L,c[M.key]&&c[M.key][t.id]);p.push(B),this.proxyToSource[M.key][t.id]=[B]}}let v=!1;const b=new Set;for(let I=0;I<r.length;I++){const M=t.getTile(r[I]);if(!M||!M.hasData())continue;const L=this._findTileCoveringTileID(M.tileID,this.proxySourceCache);if(L&&L.tileID.canonical.z!==M.tileID.canonical.z){const B=this.proxyToSource[L.tileID.key][t.id],F=this._createProxiedId(L.tileID,M,c[L.tileID.key]&&c[L.tileID.key][t.id]);B?B.splice(B.length-1,0,F):this.proxyToSource[L.tileID.key][t.id]=[F];const V=this.proxyToSource[L.tileID.key][t.id];b.has(V)||b.add(V),p.push(F),v=!0}}if(this._sourceTilesOverlap[t.id]=v,v&&this._debugParams.sortTilesHiZFirst)for(const I of b)I.sort(((M,L)=>L.overscaledZ-M.overscaledZ))}_setupProxiedCoordsForImageSource(t,r,c){if(!t.getSource().loaded())return;const p=this.proxiedCoords[t.id]=[],_=this.proxyCoords,v=t.getSource(),b=v.tileID;if(!b)return;const I=new s.P(b.x,b.y)._div(1<<b.z),M=v.coordinates.map(s.ac.fromLngLat).reduce(((B,F)=>(B.min.x=Math.min(B.min.x,F.x-I.x),B.min.y=Math.min(B.min.y,F.y-I.y),B.max.x=Math.max(B.max.x,F.x-I.x),B.max.y=Math.max(B.max.y,F.y-I.y),B)),{min:new s.P(Number.MAX_VALUE,Number.MAX_VALUE),max:new s.P(-Number.MAX_VALUE,-Number.MAX_VALUE)}),L=(B,F)=>{const V=B.wrap+B.canonical.x/(1<<B.canonical.z),$=B.canonical.y/(1<<B.canonical.z),H=s.aj/(1<<B.canonical.z),X=F.wrap+F.canonical.x/(1<<F.canonical.z),Z=F.canonical.y/(1<<F.canonical.z);return V+H<X+M.min.x||V>X+M.max.x||$+H<Z+M.min.y||$>Z+M.max.y};for(let B=0;B<_.length;B++){const F=_[B];for(let V=0;V<r.length;V++){const $=t.getTile(r[V]);if(!$||!$.hasData()||L(F,$.tileID))continue;const H=this._createProxiedId(F,$,c[F.key]&&c[F.key][t.id]),X=this.proxyToSource[F.key][t.id];X?X.push(H):this.proxyToSource[F.key][t.id]=[H],p.push(H)}}}_createProxiedId(t,r,c){let p=this.orthoMatrix;if(c){const _=c.find((v=>v.key===r.tileID.key));if(_)return _}if(r.tileID.key!==t.key){const _=t.canonical.z-r.tileID.canonical.z;let v,b,I;p=s.bz();const M=r.tileID.wrap-t.wrap<<t.overscaledZ;_>0?(v=s.aj>>_,b=v*((r.tileID.canonical.x<<_)-t.canonical.x+M),I=v*((r.tileID.canonical.y<<_)-t.canonical.y)):(v=s.aj<<-_,b=s.aj*(r.tileID.canonical.x-(t.canonical.x+M<<-_)),I=s.aj*(r.tileID.canonical.y-(t.canonical.y<<-_))),s.ca(p,0,v,0,v,0,1),s.bo(p,p,[b,I,0])}return new Nc(r.tileID,t.key,p)}_findTileCoveringTileID(t,r){let c=r.getTile(t);if(c&&c.hasData())return c;const p=this._findCoveringTileCache[r.id],_=p[t.key];if(c=_?r.getTileByID(_):null,c&&c.hasData()||_===null)return c;let v=c?c.tileID:t,b=v.overscaledZ;const I=r.getSource().minzoom,M=[];if(!_){const B=r.getSource().maxzoom;if(t.canonical.z>=B){const F=t.canonical.z-B;r.getSource().reparseOverscaled?(b=Math.max(t.canonical.z+2,r.transform.tileZoom),v=new s.aM(b,t.wrap,B,t.canonical.x>>F,t.canonical.y>>F)):F!==0&&(b=B,v=new s.aM(b,t.wrap,B,t.canonical.x>>F,t.canonical.y>>F))}v.key!==t.key&&(M.push(v.key),c=r.getTile(v))}const L=B=>{M.forEach((F=>{p[F]=B})),M.length=0};for(b-=1;b>=I&&(!c||!c.hasData());b--){c&&L(c.tileID.key);const B=v.calculateScaledKey(b);if(c=r.getTileByID(B),c&&c.hasData())break;const F=p[B];if(F===null)break;F===void 0?M.push(B):c=r.getTileByID(F)}return L(c?c.tileID.key:null),c&&c.hasData()?c:null}findDEMTileFor(t){return this.enabled?this._findTileCoveringTileID(t,this.sourceCache):null}prepareDrawTile(){this.renderedToTile=!0}_clearRenderCacheForTile(t,r){let c=this._tilesDirty[t];c||(c=this._tilesDirty[t]={}),c[r.key]=!0}}function Ld(l,t,r){const c=(function(b,I,M){const L=s.bG(I,b),B=s.bG(M,[.2126,.7152,.0722]),F=($,H,X)=>(1-X)*$+X*H,V=F(1-.3*Math.min(B,1),1,Math.min(L+1,1));return F(.92,1,Math.asin(s.ay(I[2],-1,1))/Math.PI+.5)*V})(l,[0,0,1],t),p=[0,0,0];s.c1(p,r.slice(0,3),c);const _=[0,0,0];s.c1(_,t.slice(0,3),l[2]);const v=[0,0,0];return s.d5(v,p,_),s.d8(v)}const nh=["fill","fillOutline","fillPattern","line","linePattern","background","backgroundPattern","hillshade","raster"],jh=["stars","rainParticle","snowParticle","fillExtrusion","fillExtrusionGroundEffect","elevatedStructures","model","symbol"];class Za{static cacheKey(t,r,c,p){let _=`${r}${p?p.cacheKey:""}`;for(const v of c)t.usedDefines.includes(v)&&(_+=`/${v}`);return _}constructor(t,r,c,p,_,v){const b=t.gl;this.program=b.createProgram(),this.configuration=p,this.name=r,this.fixedDefines=[...v];const I=p?p.getBinderAttributes():[],M=(c.staticAttributes||[]).concat(I);let L=p?p.defines():[];L=L.concat(v.map((X=>`#define ${X}`)));const B=`#version 300 es
`;let F=B+L.concat("precision mediump float;",qo,Fh.fragmentSource).join(`
`);for(const X of c.fragmentIncludes)F+=`
${kc[X]}`;F+=`
${c.fragmentSource}`;let V=B+L.concat("precision highp float;",qo,Fh.vertexSource).join(`
`);for(const X of c.vertexIncludes)V+=`
${kc[X]}`;this.forceManualRenderingForInstanceIDShaders=t.forceManualRenderingForInstanceIDShaders&&c.vertexSource.indexOf("gl_InstanceID")!==-1,this.forceManualRenderingForInstanceIDShaders&&(V+=`
uniform int u_instanceID;
`),V+=`
${c.vertexSource}`,this.forceManualRenderingForInstanceIDShaders&&(V=V.replaceAll("gl_InstanceID","u_instanceID"));const $=b.createShader(b.FRAGMENT_SHADER);if(b.isContextLost())return void(this.failedToCreate=!0);b.shaderSource($,F),b.compileShader($),b.attachShader(this.program,$);const H=b.createShader(b.VERTEX_SHADER);if(b.isContextLost())this.failedToCreate=!0;else{b.shaderSource(H,V),b.compileShader(H),b.attachShader(this.program,H),this.attributes={},this.numAttributes=M.length;for(let X=0;X<this.numAttributes;X++)if(M[X]){const Z=M[X].startsWith("a_")?M[X]:`a_${M[X]}`;b.bindAttribLocation(this.program,X,Z),this.attributes[Z]=X}b.linkProgram(this.program),b.deleteShader(H),b.deleteShader($),this.fixedUniforms=_(t),this.binderUniforms=p?p.getUniforms(t):[],this.forceManualRenderingForInstanceIDShaders&&(this.instancingUniforms=(X=>({u_instanceID:new s.cd(X)}))(t)),(v.includes("TERRAIN")||r.indexOf("symbol")!==-1||r.indexOf("circle")!==-1)&&(this.terrainUniforms=(X=>({u_dem:new s.cd(X),u_dem_prev:new s.cd(X),u_dem_tl:new s.cg(X),u_dem_scale:new s.cf(X),u_dem_tl_prev:new s.cg(X),u_dem_scale_prev:new s.cf(X),u_dem_size:new s.cf(X),u_dem_lerp:new s.cf(X),u_exaggeration:new s.cf(X),u_depth:new s.cd(X),u_depth_size_inv:new s.cg(X),u_depth_range_unpack:new s.cg(X),u_occluder_half_size:new s.cf(X),u_occlusion_depth_offset:new s.cf(X),u_meter_to_dem:new s.cf(X),u_label_plane_matrix_inv:new s.ch(X)}))(t)),v.includes("GLOBE")&&(this.globeUniforms=(X=>({u_tile_tl_up:new s.ce(X),u_tile_tr_up:new s.ce(X),u_tile_br_up:new s.ce(X),u_tile_bl_up:new s.ce(X),u_tile_up_scale:new s.cf(X)}))(t)),v.includes("FOG")&&(this.fogUniforms=(X=>({u_fog_matrix:new s.ch(X),u_fog_range:new s.cg(X),u_fog_color:new s.d0(X),u_fog_horizon_blend:new s.cf(X),u_fog_vertical_limit:new s.cg(X),u_fog_temporal_offset:new s.cf(X),u_frustum_tl:new s.ce(X),u_frustum_tr:new s.ce(X),u_frustum_br:new s.ce(X),u_frustum_bl:new s.ce(X),u_globe_pos:new s.ce(X),u_globe_radius:new s.cf(X),u_globe_transition:new s.cf(X),u_is_globe:new s.cd(X),u_viewport:new s.cg(X)}))(t)),v.includes("RENDER_CUTOFF")&&(this.cutoffUniforms=(X=>({u_cutoff_params:new s.d0(X)}))(t)),v.includes("LIGHTING_3D_MODE")&&(this.lightsUniforms=(X=>({u_lighting_ambient_color:new s.ce(X),u_lighting_directional_dir:new s.ce(X),u_lighting_directional_color:new s.ce(X),u_ground_radiance:new s.ce(X)}))(t)),v.includes("RENDER_SHADOWS")&&(this.shadowUniforms=(X=>({u_light_matrix_0:new s.ch(X),u_light_matrix_1:new s.ch(X),u_fade_range:new s.cg(X),u_shadow_normal_offset:new s.ce(X),u_shadow_intensity:new s.cf(X),u_shadow_texel_size:new s.cf(X),u_shadow_map_resolution:new s.cf(X),u_shadow_direction:new s.ce(X),u_shadow_bias:new s.ce(X),u_shadowmap_0:new s.cd(X),u_shadowmap_1:new s.cd(X)}))(t))}}setTerrainUniformValues(t,r){if(!this.terrainUniforms)return;const c=this.terrainUniforms;if(!this.failedToCreate){t.program.set(this.program);for(const p in r)c[p]&&c[p].set(this.program,p,r[p])}}setGlobeUniformValues(t,r){if(!this.globeUniforms)return;const c=this.globeUniforms;if(!this.failedToCreate){t.program.set(this.program);for(const p in r)c[p]&&c[p].set(this.program,p,r[p])}}setFogUniformValues(t,r){if(!this.fogUniforms)return;const c=this.fogUniforms;if(!this.failedToCreate){t.program.set(this.program);for(const p in r)c[p].set(this.program,p,r[p])}}setCutoffUniformValues(t,r){if(!this.cutoffUniforms)return;const c=this.cutoffUniforms;if(!this.failedToCreate){t.program.set(this.program);for(const p in r)c[p].set(this.program,p,r[p])}}setLightsUniformValues(t,r){if(!this.lightsUniforms)return;const c=this.lightsUniforms;if(!this.failedToCreate){t.program.set(this.program);for(const p in r)c[p].set(this.program,p,r[p])}}setShadowUniformValues(t,r){if(this.failedToCreate||!this.shadowUniforms)return;const c=this.shadowUniforms;t.program.set(this.program);for(const p in r)c[p].set(this.program,p,r[p])}_drawDebugWireframe(t,r,c,p,_,v,b,I,M,L){const B=t.options.wireframe;if(B.terrain===!1&&B.layers2D===!1&&B.layers3D===!1)return;const F=t.context;if(!(!(!B.terrain||this.name!=="terrainRaster"&&this.name!=="globeRaster")||!(!B.layers2D||t._terrain&&t._terrain.renderingToTexture||!nh.includes(this.name))||!(!B.layers3D||!jh.includes(this.name))))return;const V=F.gl,$=t.wireframeDebugCache.getLinesFromTrianglesBuffer(t.frameCounter,_,F);if(!$)return;const H=[...this.fixedDefines];H.push("DEBUG_WIREFRAME");const X=t.getOrCreateProgram(this.name,{config:this.configuration,defines:H});F.program.set(X.program);const Z=(le,pe,ye)=>{if(pe[le]&&ye[le])for(const we in pe[le])ye[le][we]&&ye[le][we].set(ye.program,we,pe[le][we].current)};M&&M.setUniforms(X.program,F,X.binderUniforms,b,{zoom:I}),Z("fixedUniforms",this,X),Z("terrainUniforms",this,X),Z("globeUniforms",this,X),Z("fogUniforms",this,X),Z("lightsUniforms",this,X),Z("shadowUniforms",this,X),$.bind(),F.setColorMode(new ui([V.ONE,V.ONE_MINUS_SRC_ALPHA,V.ZERO,V.ONE],s.am.transparent,[!0,!0,!0,!1])),F.setDepthMode(new Vt(r.func===V.LESS?V.LEQUAL:r.func,Vt.ReadOnly,r.range)),F.setStencilMode(_i.disabled);const te=3*v.primitiveLength*2,oe=3*v.primitiveOffset*2*2;if(this.forceManualRenderingForInstanceIDShaders){const le=L||1;for(let pe=0;pe<le;++pe)X.instancingUniforms.u_instanceID.set(this.program,"u_instanceID",pe),V.drawElements(V.LINES,te,V.UNSIGNED_SHORT,oe)}else L&&L>1?V.drawElementsInstanced(V.LINES,te,V.UNSIGNED_SHORT,oe,L):V.drawElements(V.LINES,te,V.UNSIGNED_SHORT,oe);_.bind(),F.program.set(this.program),F.setDepthMode(r),F.setStencilMode(c),F.setColorMode(p)}checkUniforms(t,r,c){if(this.fixedDefines.includes(r)){for(const p of Object.keys(c))if(!c[p].initialized)throw new Error(`Program '${this.name}', from draw '${t}': uniform ${p} not set but required by ${r} being defined`)}}draw(t,r,c,p,_,v,b,I,M,L,B,F,V,$,H,X){const Z=t.context,te=Z.gl;if(this.failedToCreate)return;Z.program.set(this.program),Z.setDepthMode(c),Z.setStencilMode(p),Z.setColorMode(_),Z.setCullFace(v);for(const pe of Object.keys(this.fixedUniforms))this.fixedUniforms[pe].set(this.program,pe,b[pe]);$&&$.setUniforms(this.program,Z,this.binderUniforms,F,{zoom:V});const oe={[te.POINTS]:1,[te.LINES]:2,[te.TRIANGLES]:3,[te.LINE_STRIP]:1}[r];this.checkUniforms(I,"RENDER_SHADOWS",this.shadowUniforms);const le=X&&X>0?1:void 0;for(const pe of B.get()){const ye=pe.vaos||(pe.vaos={});if((ye[I]||(ye[I]=new bm)).bind(Z,this,M,$?$.getPaintVertexBuffers():[],L,pe.vertexOffset,H||[],le),this.forceManualRenderingForInstanceIDShaders){const we=X||1;for(let me=0;me<we;++me)this.instancingUniforms.u_instanceID.set(this.program,"u_instanceID",me),L?te.drawElements(r,pe.primitiveLength*oe,te.UNSIGNED_SHORT,pe.primitiveOffset*oe*2):te.drawArrays(r,pe.vertexOffset,pe.vertexLength)}else X&&X>1?te.drawElementsInstanced(r,pe.primitiveLength*oe,te.UNSIGNED_SHORT,pe.primitiveOffset*oe*2,X):L?te.drawElements(r,pe.primitiveLength*oe,te.UNSIGNED_SHORT,pe.primitiveOffset*oe*2):te.drawArrays(r,pe.vertexOffset,pe.vertexLength);r===te.TRIANGLES&&L&&this._drawDebugWireframe(t,c,p,_,L,pe,F,V,$,X)}}}function _u(l,t,r=0){const c=Math.pow(2,t.tileID.overscaledZ),p=t.tileSize*Math.pow(2,l.transform.tileZoom)/c,_=p*(t.tileID.canonical.x+t.tileID.wrap*c),v=p*t.tileID.canonical.y;return{u_image:0,u_texsize:t.imageAtlasTexture?t.imageAtlasTexture.size:[0,0],u_tile_units_to_pixels:1/s.aw(t,1,l.transform.tileZoom),u_pixel_coord_upper:[_>>16,v>>16],u_pixel_coord_lower:[65535&_,65535&v],u_pattern_transition:r}}const dc={terrain:0,flat:1},kd=s.bz(),jf=(l,t,r,c,p,_,v,b,I,M,L,B,F,V,$,H,X,Z)=>{const te=t.style.light,oe=te.properties.get("position"),le=[oe.x,oe.y,oe.z],pe=s.dJ();te.properties.get("anchor")==="viewport"&&(s.dK(pe,-t.transform.angle),s.dL(le,le,pe));const ye=te.properties.get("color").toPremultipliedRenderColor(null),we=t.transform,me={u_matrix:l,u_lightpos:le,u_lightintensity:te.properties.get("intensity"),u_lightcolor:[ye.r,ye.g,ye.b],u_vertical_gradient:+r,u_opacity:c,u_tile_id:[0,0,0],u_zoom_transition:0,u_inv_rot_matrix:kd,u_merc_center:[0,0],u_up_dir:[0,0,0],u_height_lift:0,u_height_type:dc[M],u_base_type:dc[L],u_ao:p,u_edge_radius:_,u_width_scale:v,u_flood_light_color:$,u_vertical_scale:H,u_flood_light_intensity:X,u_ground_shadow_factor:Z};return we.projection.name==="globe"&&(me.u_tile_id=[b.canonical.x,b.canonical.y,1<<b.canonical.z],me.u_zoom_transition=B,me.u_inv_rot_matrix=V,me.u_merc_center=F,me.u_up_dir=we.projection.upVector(new s.cA(0,0,0),F[0]*s.aj,F[1]*s.aj),me.u_height_lift=I),me},fc=(l,t,r,c,p,_)=>({u_matrix:l,u_edge_radius:t,u_width_scale:r,u_vertical_scale:c,u_height_type:dc[p],u_base_type:dc[_]}),pl=(l,t,r,c,p,_,v,b,I,M,L,B,F,V,$,H,X,Z)=>{const te=jf(l,t,r,c,p,_,v,b,M,L,B,F,V,$,H,X,1,[0,0,0]),oe={u_height_factor:-Math.pow(2,b.overscaledZ)/I.tileSize/8};return s.h(te,_u(t,I,Z),oe)},gu=(l,t,r)=>({u_matrix:l,u_emissive_strength:t,u_ground_shadow_factor:r}),Gh=(l,t,r,c,p,_=0)=>s.h(gu(l,t,p),_u(r,c,_)),zd=(l,t,r,c)=>({u_matrix:l,u_world:r,u_emissive_strength:t,u_ground_shadow_factor:c}),Xa=(l,t,r,c,p,_,v=0)=>s.h(Gh(l,t,r,c,_,v),{u_world:p}),Ka=(l,t)=>({u_matrix:l,u_ground_shadow_factor:t}),Wl=(l,t,r,c,p)=>({u_matrix:l,u_camera_pos:[t[0],t[1],t[2]],u_depth_bias:r,u_height_scale:c,u_reset_depth:p}),ml=(l,t)=>({u_matrix:l,u_normal_matrix:t,u_opacity:1}),_l=l=>({u_matrix:l}),Vc=l=>({u_matrix:l}),yu=(l,t,r,c,p,_,v,b)=>{const I=s.aj/_.tileSize;return{u_matrix:l,u_inv_rot_matrix:t,u_camera_to_center_distance:r.getCameraToCenterDistance(b),u_extrude_scale:[r.pixelsToGLUnits[0]/I,r.pixelsToGLUnits[1]/I],u_zoom_transition:c,u_tile_id:v,u_merc_center:p}},Hh=(l,t,r=1)=>({u_matrix:l,u_color:t,u_overlay:0,u_overlay_scale:r}),Fd=s.bz(),ia=(l,t,r,c,p,_,v)=>{const b=l.transform,I=b.projection.name==="globe",M=I?s.dM(b.zoom,t.canonical)*b._pixelsPerMercatorPixel:s.aw(r,1,_),L={u_matrix:t.projMatrix,u_extrude_scale:M,u_intensity:v,u_inv_rot_matrix:Fd,u_merc_center:[0,0],u_tile_id:[0,0,0],u_zoom_transition:0,u_up_dir:[0,0,0]};if(I){L.u_inv_rot_matrix=c,L.u_merc_center=p,L.u_tile_id=[t.canonical.x,t.canonical.y,1<<t.canonical.z],L.u_zoom_transition=s.ah(b.zoom);const B=p[0]*s.aj,F=p[1]*s.aj;L.u_up_dir=b.projection.upVector(new s.cA(0,0,0),B,F)}return L};function Po(l,[t,r,c,p],[_,v]){if(_===v)return[0,0,0,0];const b=255*(l-1)/(l*(v-_));return[t*b,r*b,c*b,p*b]}function Gr(l,t,[r,c]){return r===c?0:.5/l+(t-r)*(l-1)/(l*(c-r))}const Aa=(l,t,r,c,p,_,v,b,I,M,L,B,F,V,$,H,X,Z,te,oe,le)=>({u_matrix:l,u_normalize_matrix:t,u_globe_matrix:r,u_merc_matrix:c,u_grid_matrix:p,u_tl_parent:_,u_scale_parent:M,u_fade_t:L.mix,u_opacity:L.opacity*B.paint.get("raster-opacity"),u_image0:0,u_image1:1,u_brightness_low:B.paint.get("raster-brightness-min"),u_brightness_high:B.paint.get("raster-brightness-max"),u_saturation_factor:s.dO(B.paint.get("raster-saturation")),u_contrast_factor:s.dN(B.paint.get("raster-contrast")),u_spin_weights:pc(B.paint.get("raster-hue-rotate")),u_perspective_transform:F,u_raster_elevation:V,u_zoom_transition:v,u_merc_center:b,u_cutoff_params:I,u_colorization_mix:Po(s.dP,H,Z),u_colorization_offset:Gr(s.dP,X,Z),u_color_ramp:$,u_texture_offset:[oe/(te+2*oe),te/(te+2*oe)],u_texture_res:[te+2*oe,te+2*oe],u_emissive_strength:le});function pc(l){l*=Math.PI/180;const t=Math.sin(l),r=Math.cos(l);return[(2*r+1)/3,(-Math.sqrt(3)*t-r+1)/3,(Math.sqrt(3)*t-r+1)/3]}const mc=.05,rh=(l,t,r,c,p,_,v,b,I,M,L,B)=>({u_matrix:l,u_normalize_matrix:t,u_globe_matrix:r,u_merc_matrix:c,u_grid_matrix:p,u_tl_parent:_,u_scale_parent:M,u_fade_t:L.mix,u_opacity:L.opacity,u_image0:0,u_image1:1,u_raster_elevation:B,u_zoom_transition:v,u_merc_center:b,u_cutoff_params:I}),Od=(l,t,r,c,p,_,v,b,I,M)=>({u_particle_texture:l,u_particle_texture_side_len:t,u_tile_offset:r,u_velocity:c,u_color_ramp:_,u_velocity_res:p,u_max_speed:v,u_uv_offset:b,u_data_scale:[255*I[0],255*I[1]],u_data_offset:M,u_particle_pos_scale:1.1,u_particle_pos_offset:[mc,mc]}),Gf=(l,t,r,c,p,_,v,b,I,M)=>({u_particle_texture:l,u_particle_texture_side_len:t,u_velocity:r,u_velocity_res:c,u_max_speed:p,u_speed_factor:_,u_reset_rate:v,u_rand_seed:Math.random(),u_uv_offset:b,u_data_scale:[255*I[0],255*I[1]],u_data_offset:M,u_particle_pos_scale:1.1,u_particle_pos_offset:[mc,mc]}),vu=s.bz(),qh=(l,t,r,c,p,_,v,b,I,M,L,B,F,V,$,H,X,Z,te,oe,le,pe,ye,we)=>{const me=p.transform,_e={u_is_size_zoom_constant:+(l==="constant"||l==="source"),u_is_size_feature_constant:+(l==="constant"||l==="camera"),u_size_t:t?t.uSizeT:0,u_size:t?t.uSize:0,u_camera_to_center_distance:me.getCameraToCenterDistance(te),u_rotate_symbol:+r,u_aspect_ratio:me.width/me.height,u_fade_change:p.options.fadeDuration?p.symbolFadeChange:1,u_matrix:_,u_label_plane_matrix:v,u_coord_matrix:b,u_is_text:+M,u_elevation_from_sea:I?1:0,u_pitch_with_map:+c,u_texsize:L,u_texsize_icon:B,u_texture:0,u_texture_icon:1,u_tile_id:[0,0,0],u_zoom_transition:0,u_inv_rot_matrix:vu,u_merc_center:[0,0],u_camera_forward:[0,0,0],u_ecef_origin:[0,0,0],u_tile_matrix:vu,u_up_vector:[0,-1,0],u_color_adj_mat:pe,u_icon_transition:ye||0,u_gamma_scale:c?p.transform.getCameraToCenterDistance(te)*Math.cos(p.terrain?0:p.transform._pitch):1,u_device_pixel_ratio:s.q.devicePixelRatio,u_is_halo:1,u_scale_factor:we||1,u_ground_shadow_factor:oe,u_inv_matrix:s.bi(s.bz(),v),u_normal_scale:le};return te.name==="globe"&&(_e.u_tile_id=[V.canonical.x,V.canonical.y,1<<V.canonical.z],_e.u_zoom_transition=$,_e.u_inv_rot_matrix=X,_e.u_merc_center=H,_e.u_camera_forward=me._camera.forward(),_e.u_ecef_origin=s.dQ(me.globeMatrix,V.toUnwrapped()),_e.u_tile_matrix=Float32Array.from(me.globeMatrix),_e.u_up_vector=Z),_e},xu=(l,t,r,c)=>({u_matrix:l,u_emissive_strength:t,u_opacity:r,u_color:c}),$h=(l,t,r,c,p,_,v,b,I)=>s.h((function(M,L,B,F,V,$){const{width:H,height:X}=F.imageManager.getPixelSize(L),Z=Math.pow(2,$.tileID.overscaledZ),te=$.tileSize*Math.pow(2,F.transform.tileZoom)/Z,oe=te*($.tileID.canonical.x+$.tileID.wrap*Z),le=te*$.tileID.canonical.y;return{u_image:0,u_pattern_tl:B.tl,u_pattern_br:B.br,u_texsize:[H,X],u_pattern_size:B.displaySize,u_pattern_units_to_pixels:V?[F.transform.width,-1*F.transform.height]:[1/s.aw($,1,F.transform.tileZoom),1/s.aw($,1,F.transform.tileZoom)],u_pixel_coord_upper:[oe>>16,le>>16],u_pixel_coord_lower:[65535&oe,65535&le]}})(0,_,v,c,b,I),{u_matrix:l,u_emissive_strength:t,u_opacity:r}),wu=new Float32Array(s.bx([])),bu=(l,t,r,c,p,_,v,b,I,M,L,B,F,V=[0,0,0],$)=>{const H=p.style.light,X=H.properties.get("position"),Z=[-X.x,-X.y,X.z],te=s.dJ();H.properties.get("anchor")==="viewport"&&(s.dK(te,-p.transform.angle),s.dL(Z,Z,te));const oe=L.alphaMode==="MASK",le=H.properties.get("color").toNonPremultipliedRenderColor(null),pe=F.paint.get("model-ambient-occlusion-intensity"),ye=F.paint.get("model-color").constantOr(s.am.white).toNonPremultipliedRenderColor(null);return ye.a=F.paint.get("model-color-mix-intensity").constantOr(0),{u_matrix:l,u_lighting_matrix:t,u_normal_matrix:r,u_node_matrix:c||wu,u_lightpos:Z,u_lightintensity:H.properties.get("intensity"),u_lightcolor:[le.r,le.g,le.b],u_camera_pos:V,u_opacity:_,u_baseTextureIsAlpha:0,u_alphaMask:+oe,u_alphaCutoff:L.alphaCutoff,u_baseColorFactor:v.toNonPremultipliedRenderColor(null).toArray01(),u_emissiveFactor:b.toNonPremultipliedRenderColor(null).toArray01(),u_metallicFactor:I,u_roughnessFactor:M,u_baseColorTexture:Co.BaseColor,u_metallicRoughnessTexture:Co.MetallicRoughness,u_normalTexture:Co.Normal,u_occlusionTexture:Co.Occlusion,u_emissionTexture:Co.Emission,u_lutTexture:Co.LUT,u_color_mix:ye.toArray01(),u_aoIntensity:pe,u_emissive_strength:B,u_occlusionTextureTransform:$||[0,0,0,0]}},Wh=(l,t=wu,r=wu)=>({u_matrix:l,u_instance:t,u_node_matrix:r}),Hf={fillExtrusion:l=>({u_matrix:new s.ch(l),u_lightpos:new s.ce(l),u_lightintensity:new s.cf(l),u_lightcolor:new s.ce(l),u_vertical_gradient:new s.cf(l),u_opacity:new s.cf(l),u_edge_radius:new s.cf(l),u_width_scale:new s.cf(l),u_ao:new s.cg(l),u_height_type:new s.cd(l),u_base_type:new s.cd(l),u_tile_id:new s.ce(l),u_zoom_transition:new s.cf(l),u_inv_rot_matrix:new s.ch(l),u_merc_center:new s.cg(l),u_up_dir:new s.ce(l),u_height_lift:new s.cf(l),u_flood_light_color:new s.ce(l),u_vertical_scale:new s.cf(l),u_flood_light_intensity:new s.cf(l),u_ground_shadow_factor:new s.ce(l)}),fillExtrusionDepth:l=>({u_matrix:new s.ch(l),u_edge_radius:new s.cf(l),u_width_scale:new s.cf(l),u_vertical_scale:new s.cf(l),u_height_type:new s.cd(l),u_base_type:new s.cd(l)}),fillExtrusionPattern:l=>({u_matrix:new s.ch(l),u_lightpos:new s.ce(l),u_lightintensity:new s.cf(l),u_lightcolor:new s.ce(l),u_vertical_gradient:new s.cf(l),u_height_factor:new s.cf(l),u_edge_radius:new s.cf(l),u_width_scale:new s.cf(l),u_ao:new s.cg(l),u_height_type:new s.cd(l),u_base_type:new s.cd(l),u_tile_id:new s.ce(l),u_zoom_transition:new s.cf(l),u_inv_rot_matrix:new s.ch(l),u_merc_center:new s.cg(l),u_up_dir:new s.ce(l),u_height_lift:new s.cf(l),u_image:new s.cd(l),u_texsize:new s.cg(l),u_pixel_coord_upper:new s.cg(l),u_pixel_coord_lower:new s.cg(l),u_tile_units_to_pixels:new s.cf(l),u_opacity:new s.cf(l),u_pattern_transition:new s.cf(l)}),fillExtrusionGroundEffect:l=>({u_matrix:new s.ch(l),u_opacity:new s.cf(l),u_ao_pass:new s.cf(l),u_meter_to_tile:new s.cf(l),u_ao:new s.cg(l),u_flood_light_intensity:new s.cf(l),u_flood_light_color:new s.ce(l),u_attenuation:new s.cf(l),u_edge_radius:new s.cf(l),u_fb:new s.cd(l),u_fb_size:new s.cf(l),u_dynamic_offset:new s.cf(l)}),fill:l=>({u_matrix:new s.ch(l),u_emissive_strength:new s.cf(l),u_ground_shadow_factor:new s.ce(l)}),fillPattern:l=>({u_matrix:new s.ch(l),u_emissive_strength:new s.cf(l),u_image:new s.cd(l),u_texsize:new s.cg(l),u_pixel_coord_upper:new s.cg(l),u_pixel_coord_lower:new s.cg(l),u_tile_units_to_pixels:new s.cf(l),u_ground_shadow_factor:new s.ce(l),u_pattern_transition:new s.cf(l)}),fillOutline:l=>({u_matrix:new s.ch(l),u_emissive_strength:new s.cf(l),u_world:new s.cg(l),u_ground_shadow_factor:new s.ce(l)}),fillOutlinePattern:l=>({u_matrix:new s.ch(l),u_emissive_strength:new s.cf(l),u_world:new s.cg(l),u_image:new s.cd(l),u_texsize:new s.cg(l),u_pixel_coord_upper:new s.cg(l),u_pixel_coord_lower:new s.cg(l),u_tile_units_to_pixels:new s.cf(l),u_ground_shadow_factor:new s.ce(l),u_pattern_transition:new s.cf(l)}),building:l=>({u_matrix:new s.ch(l),u_normal_matrix:new s.ch(l),u_opacity:new s.cf(l)}),buildingBloom:l=>({u_matrix:new s.ch(l)}),buildingDepth:l=>({u_matrix:new s.ch(l)}),elevatedStructuresDepth:l=>({u_matrix:new s.ch(l),u_depth_bias:new s.cf(l)}),elevatedStructures:l=>({u_matrix:new s.ch(l),u_ground_shadow_factor:new s.ce(l)}),elevatedStructuresDepthReconstruct:l=>({u_matrix:new s.ch(l),u_camera_pos:new s.ce(l),u_depth_bias:new s.cf(l),u_height_scale:new s.cf(l),u_reset_depth:new s.cf(l)}),circle:s.dT,collisionBox:l=>({u_matrix:new s.ch(l),u_inv_rot_matrix:new s.ch(l),u_camera_to_center_distance:new s.cf(l),u_extrude_scale:new s.cg(l),u_zoom_transition:new s.cf(l),u_merc_center:new s.cg(l),u_tile_id:new s.ce(l)}),collisionCircle:l=>({u_matrix:new s.ch(l),u_inv_matrix:new s.ch(l),u_camera_to_center_distance:new s.cf(l),u_viewport_size:new s.cg(l)}),debug:l=>({u_color:new s.dv(l),u_matrix:new s.ch(l),u_overlay:new s.cd(l),u_overlay_scale:new s.cf(l)}),clippingMask:l=>({u_matrix:new s.ch(l)}),heatmap:l=>({u_extrude_scale:new s.cf(l),u_intensity:new s.cf(l),u_matrix:new s.ch(l),u_inv_rot_matrix:new s.ch(l),u_merc_center:new s.cg(l),u_tile_id:new s.ce(l),u_zoom_transition:new s.cf(l),u_up_dir:new s.ce(l)}),heatmapTexture:l=>({u_image:new s.cd(l),u_color_ramp:new s.cd(l),u_opacity:new s.cf(l)}),hillshade:l=>({u_matrix:new s.ch(l),u_image:new s.cd(l),u_latrange:new s.cg(l),u_light:new s.cg(l),u_shadow:new s.dv(l),u_highlight:new s.dv(l),u_emissive_strength:new s.cf(l),u_accent:new s.dv(l)}),hillshadePrepare:l=>({u_matrix:new s.ch(l),u_image:new s.cd(l),u_dimension:new s.cg(l),u_zoom:new s.cf(l)}),line:s.dS,linePattern:s.dR,raster:l=>({u_matrix:new s.ch(l),u_normalize_matrix:new s.ch(l),u_globe_matrix:new s.ch(l),u_merc_matrix:new s.ch(l),u_grid_matrix:new s.dw(l),u_tl_parent:new s.cg(l),u_scale_parent:new s.cf(l),u_fade_t:new s.cf(l),u_opacity:new s.cf(l),u_image0:new s.cd(l),u_image1:new s.cd(l),u_brightness_low:new s.cf(l),u_brightness_high:new s.cf(l),u_saturation_factor:new s.cf(l),u_contrast_factor:new s.cf(l),u_spin_weights:new s.ce(l),u_perspective_transform:new s.cg(l),u_raster_elevation:new s.cf(l),u_zoom_transition:new s.cf(l),u_merc_center:new s.cg(l),u_cutoff_params:new s.d0(l),u_colorization_mix:new s.d0(l),u_colorization_offset:new s.cf(l),u_color_ramp:new s.cd(l),u_texture_offset:new s.cg(l),u_texture_res:new s.cg(l),u_emissive_strength:new s.cf(l)}),rasterParticle:l=>({u_matrix:new s.ch(l),u_normalize_matrix:new s.ch(l),u_globe_matrix:new s.ch(l),u_merc_matrix:new s.ch(l),u_grid_matrix:new s.dw(l),u_tl_parent:new s.cg(l),u_scale_parent:new s.cf(l),u_fade_t:new s.cf(l),u_opacity:new s.cf(l),u_image0:new s.cd(l),u_image1:new s.cd(l),u_raster_elevation:new s.cf(l),u_zoom_transition:new s.cf(l),u_merc_center:new s.cg(l),u_cutoff_params:new s.d0(l)}),rasterParticleTexture:l=>({u_texture:new s.cd(l),u_opacity:new s.cf(l)}),rasterParticleDraw:l=>({u_particle_texture:new s.cd(l),u_particle_texture_side_len:new s.cf(l),u_tile_offset:new s.cg(l),u_velocity:new s.cd(l),u_color_ramp:new s.cd(l),u_velocity_res:new s.cg(l),u_max_speed:new s.cf(l),u_uv_offset:new s.cg(l),u_data_scale:new s.cg(l),u_data_offset:new s.cf(l),u_particle_pos_scale:new s.cf(l),u_particle_pos_offset:new s.cg(l)}),rasterParticleUpdate:l=>({u_particle_texture:new s.cd(l),u_particle_texture_side_len:new s.cf(l),u_velocity:new s.cd(l),u_velocity_res:new s.cg(l),u_max_speed:new s.cf(l),u_speed_factor:new s.cf(l),u_reset_rate:new s.cf(l),u_rand_seed:new s.cf(l),u_uv_offset:new s.cg(l),u_data_scale:new s.cg(l),u_data_offset:new s.cf(l),u_particle_pos_scale:new s.cf(l),u_particle_pos_offset:new s.cg(l)}),symbol:l=>({u_is_size_zoom_constant:new s.cd(l),u_is_size_feature_constant:new s.cd(l),u_size_t:new s.cf(l),u_size:new s.cf(l),u_camera_to_center_distance:new s.cf(l),u_rotate_symbol:new s.cd(l),u_aspect_ratio:new s.cf(l),u_fade_change:new s.cf(l),u_matrix:new s.ch(l),u_label_plane_matrix:new s.ch(l),u_coord_matrix:new s.ch(l),u_is_text:new s.cd(l),u_elevation_from_sea:new s.cd(l),u_pitch_with_map:new s.cd(l),u_texsize:new s.cg(l),u_texsize_icon:new s.cg(l),u_texture:new s.cd(l),u_texture_icon:new s.cd(l),u_gamma_scale:new s.cf(l),u_device_pixel_ratio:new s.cf(l),u_tile_id:new s.ce(l),u_zoom_transition:new s.cf(l),u_inv_rot_matrix:new s.ch(l),u_merc_center:new s.cg(l),u_camera_forward:new s.ce(l),u_tile_matrix:new s.ch(l),u_up_vector:new s.ce(l),u_ecef_origin:new s.ce(l),u_is_halo:new s.cd(l),u_icon_transition:new s.cf(l),u_color_adj_mat:new s.ch(l),u_scale_factor:new s.cf(l),u_ground_shadow_factor:new s.ce(l),u_inv_matrix:new s.ch(l),u_normal_scale:new s.cf(l)}),background:l=>({u_matrix:new s.ch(l),u_emissive_strength:new s.cf(l),u_opacity:new s.cf(l),u_color:new s.dv(l)}),backgroundPattern:l=>({u_matrix:new s.ch(l),u_emissive_strength:new s.cf(l),u_opacity:new s.cf(l),u_image:new s.cd(l),u_pattern_tl:new s.cg(l),u_pattern_br:new s.cg(l),u_texsize:new s.cg(l),u_pattern_size:new s.cg(l),u_pixel_coord_upper:new s.cg(l),u_pixel_coord_lower:new s.cg(l),u_pattern_units_to_pixels:new s.cg(l)}),terrainRaster:l=>({u_matrix:new s.ch(l),u_image0:new s.cd(l),u_skirt_height:new s.cf(l),u_ground_shadow_factor:new s.ce(l)}),skybox:l=>({u_matrix:new s.ch(l),u_sun_direction:new s.ce(l),u_cubemap:new s.cd(l),u_opacity:new s.cf(l),u_temporal_offset:new s.cf(l)}),skyboxGradient:l=>({u_matrix:new s.ch(l),u_color_ramp:new s.cd(l),u_center_direction:new s.ce(l),u_radius:new s.cf(l),u_opacity:new s.cf(l),u_temporal_offset:new s.cf(l)}),skyboxCapture:l=>({u_matrix_3f:new s.dw(l),u_sun_direction:new s.ce(l),u_sun_intensity:new s.cf(l),u_color_tint_r:new s.d0(l),u_color_tint_m:new s.d0(l),u_luminance:new s.cf(l)}),globeRaster:l=>({u_proj_matrix:new s.ch(l),u_globe_matrix:new s.ch(l),u_normalize_matrix:new s.ch(l),u_merc_matrix:new s.ch(l),u_zoom_transition:new s.cf(l),u_merc_center:new s.cg(l),u_image0:new s.cd(l),u_grid_matrix:new s.dw(l),u_skirt_height:new s.cf(l),u_far_z_cutoff:new s.cf(l),u_frustum_tl:new s.ce(l),u_frustum_tr:new s.ce(l),u_frustum_br:new s.ce(l),u_frustum_bl:new s.ce(l),u_globe_pos:new s.ce(l),u_globe_radius:new s.cf(l),u_viewport:new s.cg(l)}),globeAtmosphere:l=>({u_frustum_tl:new s.ce(l),u_frustum_tr:new s.ce(l),u_frustum_br:new s.ce(l),u_frustum_bl:new s.ce(l),u_horizon:new s.cf(l),u_transition:new s.cf(l),u_fadeout_range:new s.cf(l),u_color:new s.d0(l),u_high_color:new s.d0(l),u_space_color:new s.d0(l),u_temporal_offset:new s.cf(l),u_horizon_angle:new s.cf(l)}),model:l=>({u_matrix:new s.ch(l),u_lighting_matrix:new s.ch(l),u_normal_matrix:new s.ch(l),u_node_matrix:new s.ch(l),u_lightpos:new s.ce(l),u_lightintensity:new s.cf(l),u_lightcolor:new s.ce(l),u_camera_pos:new s.ce(l),u_opacity:new s.cf(l),u_baseColorFactor:new s.d0(l),u_emissiveFactor:new s.d0(l),u_metallicFactor:new s.cf(l),u_roughnessFactor:new s.cf(l),u_baseTextureIsAlpha:new s.cd(l),u_alphaMask:new s.cd(l),u_alphaCutoff:new s.cf(l),u_baseColorTexture:new s.cd(l),u_metallicRoughnessTexture:new s.cd(l),u_normalTexture:new s.cd(l),u_occlusionTexture:new s.cd(l),u_emissionTexture:new s.cd(l),u_lutTexture:new s.cd(l),u_color_mix:new s.d0(l),u_aoIntensity:new s.cf(l),u_emissive_strength:new s.cf(l),u_occlusionTextureTransform:new s.d0(l)}),modelDepth:l=>({u_matrix:new s.ch(l),u_instance:new s.ch(l),u_node_matrix:new s.ch(l)}),groundShadow:l=>({u_matrix:new s.ch(l),u_ground_shadow_factor:new s.ce(l)}),stars:l=>({u_matrix:new s.ch(l),u_up:new s.ce(l),u_right:new s.ce(l),u_intensity_multiplier:new s.cf(l)}),snowParticle:l=>({u_modelview:new s.ch(l),u_projection:new s.ch(l),u_time:new s.cf(l),u_cam_pos:new s.ce(l),u_velocityConeAperture:new s.cf(l),u_velocity:new s.cf(l),u_horizontalOscillationRadius:new s.cf(l),u_horizontalOscillationRate:new s.cf(l),u_boxSize:new s.cf(l),u_billboardSize:new s.cf(l),u_simpleShapeParameters:new s.cg(l),u_screenSize:new s.cg(l),u_thinningCenterPos:new s.cg(l),u_thinningShape:new s.ce(l),u_thinningAffectedRatio:new s.cf(l),u_thinningParticleOffset:new s.cf(l),u_particleColor:new s.d0(l),u_direction:new s.ce(l)}),rainParticle:l=>({u_modelview:new s.ch(l),u_projection:new s.ch(l),u_time:new s.cf(l),u_cam_pos:new s.ce(l),u_texScreen:new s.cd(l),u_velocityConeAperture:new s.cf(l),u_velocity:new s.cf(l),u_boxSize:new s.cf(l),u_rainDropletSize:new s.cg(l),u_distortionStrength:new s.cf(l),u_rainDirection:new s.ce(l),u_color:new s.d0(l),u_screenSize:new s.cg(l),u_thinningCenterPos:new s.cg(l),u_thinningShape:new s.ce(l),u_thinningAffectedRatio:new s.cf(l),u_thinningParticleOffset:new s.cf(l),u_shapeDirectionalPower:new s.cf(l),u_shapeNormalPower:new s.cf(l),u_mode:new s.cf(l)}),vignette:l=>({u_vignetteShape:new s.ce(l),u_vignetteColor:new s.d0(l)}),occlusion:l=>({u_matrix:new s.ch(l),u_anchorPos:new s.ce(l),u_screenSizePx:new s.cg(l),u_occluderSizePx:new s.cg(l),u_color:new s.d0(l)})};class _c{constructor(t,r,c,p){this.id=_c.uniqueIdxCounter,_c.uniqueIdxCounter++,this.context=t;const _=t.gl;this.buffer=_.createBuffer(),this.dynamicDraw=!!c,this.context.unbindVAO(),t.bindElementBuffer.set(this.buffer),_.bufferData(_.ELEMENT_ARRAY_BUFFER,r.arrayBuffer,this.dynamicDraw?_.DYNAMIC_DRAW:_.STATIC_DRAW),this.dynamicDraw||p||r.destroy()}bind(){this.context.bindElementBuffer.set(this.buffer)}updateData(t){this.id=_c.uniqueIdxCounter,_c.uniqueIdxCounter++;const r=this.context.gl;this.context.unbindVAO(),this.bind(),r.bufferSubData(r.ELEMENT_ARRAY_BUFFER,0,t.arrayBuffer)}destroy(){this.buffer&&(this.context.gl.deleteBuffer(this.buffer),delete this.buffer)}}_c.uniqueIdxCounter=0;const Uc={Int8:"BYTE",Uint8:"UNSIGNED_BYTE",Int16:"SHORT",Uint16:"UNSIGNED_SHORT",Int32:"INT",Uint32:"UNSIGNED_INT",Float32:"FLOAT"};class Bd{constructor(t,r,c,p,_,v){this.length=r.length,this.attributes=c,this.itemSize=r.bytesPerElement,this.dynamicDraw=p,this.instanceCount=v,this.context=t;const b=t.gl;this.buffer=b.createBuffer(),t.bindVertexBuffer.set(this.buffer),b.bufferData(b.ARRAY_BUFFER,r.arrayBuffer,this.dynamicDraw?b.DYNAMIC_DRAW:b.STATIC_DRAW),this.dynamicDraw||_||r.destroy()}bind(){this.context.bindVertexBuffer.set(this.buffer)}updateData(t){const r=this.context.gl;this.bind(),r.bufferSubData(r.ARRAY_BUFFER,0,t.arrayBuffer)}enableAttributes(t,r){for(let c=0;c<this.attributes.length;c++){const p=r.attributes[this.attributes[c].name];p!==void 0&&t.enableVertexAttribArray(p)}}setVertexAttribPointers(t,r,c){for(let p=0;p<this.attributes.length;p++){const _=this.attributes[p],v=r.attributes[_.name];v!==void 0&&t.vertexAttribPointer(v,_.components,t[Uc[_.type]],!1,this.itemSize,_.offset+this.itemSize*(c||0))}}setVertexAttribDivisor(t,r,c){for(let p=0;p<this.attributes.length;p++){const _=r.attributes[this.attributes[p].name];_!==void 0&&this.instanceCount&&this.instanceCount>0&&t.vertexAttribDivisor(_,c)}}destroy(){this.buffer&&(this.context.gl.deleteBuffer(this.buffer),delete this.buffer)}}class Zl{constructor(t,r,c,p,_){this.context=t,this.width=r,this.height=c;const v=this.framebuffer=t.gl.createFramebuffer();p&&(this.colorAttachment=new mu(t,v)),_&&(this.depthAttachmentType=_,this.depthAttachment=_==="renderbuffer"?new th(t,v):new Oc(t,v))}destroy(){const t=this.context.gl;if(this.colorAttachment){const r=this.colorAttachment.get();r&&t.deleteTexture(r)}if(this.depthAttachment&&this.depthAttachmentType)if(this.depthAttachmentType==="renderbuffer"){const r=this.depthAttachment.get();r&&t.deleteRenderbuffer(r)}else{const r=this.depthAttachment.get();r&&t.deleteTexture(r)}t.deleteFramebuffer(this.framebuffer)}}class Tu{constructor(t,r){this.gl=t,this.clearColor=new Ff(this),this.clearDepth=new Ad(this),this.clearStencil=new Oh(this),this.colorMask=new Ep(this),this.depthMask=new Cd(this),this.stencilMask=new Bh(this),this.stencilFunc=new pu(this),this.stencilOp=new Xu(this),this.stencilTest=new Of(this),this.depthRange=new Bf(this),this.depthTest=new Pd(this),this.depthFunc=new Rd(this),this.blend=new jl(this),this.blendFunc=new uc(this),this.blendColor=new Ku(this),this.blendEquation=new Yu(this),this.cullFace=new zc(this),this.cullFaceSide=new Md(this),this.frontFace=new Nf(this),this.program=new Vf(this),this.activeTexture=new Qu(this),this.viewport=new Dd(this),this.bindFramebuffer=new Ju(this),this.bindRenderbuffer=new Gl(this),this.bindTexture=new Nh(this),this.bindVertexBuffer=new Hl(this),this.bindElementBuffer=new fl(this),this.bindVertexArrayOES=new eh(this),this.pixelStoreUnpack=new ql(this),this.pixelStoreUnpackPremultiplyAlpha=new Fc(this),this.pixelStoreUnpackFlipY=new Sp(this),this.options=r?Object.assign({},r):{},this.options.extTextureFilterAnisotropicForceOff||(this.extTextureFilterAnisotropic=t.getExtension("EXT_texture_filter_anisotropic")||t.getExtension("MOZ_EXT_texture_filter_anisotropic")||t.getExtension("WEBKIT_EXT_texture_filter_anisotropic"),this.extTextureFilterAnisotropic&&(this.extTextureFilterAnisotropicMax=t.getParameter(this.extTextureFilterAnisotropic.MAX_TEXTURE_MAX_ANISOTROPY_EXT))),this.extDebugRendererInfo=t.getExtension("WEBGL_debug_renderer_info"),this.extDebugRendererInfo&&(this.renderer=t.getParameter(this.extDebugRendererInfo.UNMASKED_RENDERER_WEBGL),this.vendor=t.getParameter(this.extDebugRendererInfo.UNMASKED_VENDOR_WEBGL)),this.forceManualRenderingForInstanceIDShaders=r&&!!r.forceManualRenderingForInstanceIDShaders||this.renderer&&this.renderer.indexOf("PowerVR")!==-1,this.options.extTextureFloatLinearForceOff||(this.extTextureFloatLinear=t.getExtension("OES_texture_float_linear")),this.extRenderToTextureHalfFloat=t.getExtension("EXT_color_buffer_half_float"),this.extTimerQuery=t.getExtension("EXT_disjoint_timer_query_webgl2"),this.maxTextureSize=t.getParameter(t.MAX_TEXTURE_SIZE),this.maxPointSize=t.getParameter(t.ALIASED_POINT_SIZE_RANGE)[1]}setDefault(){this.unbindVAO(),this.clearColor.setDefault(),this.clearDepth.setDefault(),this.clearStencil.setDefault(),this.colorMask.setDefault(),this.depthMask.setDefault(),this.stencilMask.setDefault(),this.stencilFunc.setDefault(),this.stencilOp.setDefault(),this.stencilTest.setDefault(),this.depthRange.setDefault(),this.depthTest.setDefault(),this.depthFunc.setDefault(),this.blend.setDefault(),this.blendFunc.setDefault(),this.blendColor.setDefault(),this.blendEquation.setDefault(),this.cullFace.setDefault(),this.cullFaceSide.setDefault(),this.frontFace.setDefault(),this.program.setDefault(),this.activeTexture.setDefault(),this.bindFramebuffer.setDefault(),this.pixelStoreUnpack.setDefault(),this.pixelStoreUnpackPremultiplyAlpha.setDefault(),this.pixelStoreUnpackFlipY.setDefault()}setDirty(){this.clearColor.dirty=!0,this.clearDepth.dirty=!0,this.clearStencil.dirty=!0,this.colorMask.dirty=!0,this.depthMask.dirty=!0,this.stencilMask.dirty=!0,this.stencilFunc.dirty=!0,this.stencilOp.dirty=!0,this.stencilTest.dirty=!0,this.depthRange.dirty=!0,this.depthTest.dirty=!0,this.depthFunc.dirty=!0,this.blend.dirty=!0,this.blendFunc.dirty=!0,this.blendColor.dirty=!0,this.blendEquation.dirty=!0,this.cullFace.dirty=!0,this.cullFaceSide.dirty=!0,this.frontFace.dirty=!0,this.program.dirty=!0,this.activeTexture.dirty=!0,this.viewport.dirty=!0,this.bindFramebuffer.dirty=!0,this.bindRenderbuffer.dirty=!0,this.bindTexture.dirty=!0,this.bindVertexBuffer.dirty=!0,this.bindElementBuffer.dirty=!0,this.bindVertexArrayOES.dirty=!0,this.pixelStoreUnpack.dirty=!0,this.pixelStoreUnpackPremultiplyAlpha.dirty=!0,this.pixelStoreUnpackFlipY.dirty=!0}createIndexBuffer(t,r,c){return new _c(this,t,r,c)}createVertexBuffer(t,r,c,p,_){return new Bd(this,t,r,c,p,_)}createRenderbuffer(t,r,c){const p=this.gl,_=p.createRenderbuffer();return this.bindRenderbuffer.set(_),p.renderbufferStorage(p.RENDERBUFFER,t,r,c),this.bindRenderbuffer.set(null),_}createFramebuffer(t,r,c,p){return new Zl(this,t,r,c,p)}clear({color:t,depth:r,stencil:c,colorMask:p}){const _=this.gl;let v=0;t&&(v|=_.COLOR_BUFFER_BIT,this.clearColor.set(t.toNonPremultipliedRenderColor(null)),this.colorMask.set(p||[!0,!0,!0,!0])),r!==void 0&&(v|=_.DEPTH_BUFFER_BIT,this.depthRange.set([0,1]),this.clearDepth.set(r),this.depthMask.set(!0)),c!==void 0&&(v|=_.STENCIL_BUFFER_BIT,this.clearStencil.set(c),this.stencilMask.set(255)),_.clear(v)}setCullFace(t){t.enable===!1?this.cullFace.set(!1):(this.cullFace.set(!0),this.cullFaceSide.set(t.mode),this.frontFace.set(t.frontFace))}setDepthMode(t){t.func!==this.gl.ALWAYS||t.mask?(this.depthTest.set(!0),this.depthFunc.set(t.func),this.depthMask.set(t.mask),this.depthRange.set(t.range)):this.depthTest.set(!1)}setStencilMode(t){t.test.func!==this.gl.ALWAYS||t.mask?(this.stencilTest.set(!0),this.stencilMask.set(t.mask),this.stencilOp.set([t.fail,t.depthFail,t.pass]),this.stencilFunc.set({func:t.test.func,ref:t.ref,mask:t.test.mask})):this.stencilTest.set(!1)}setColorMode(t){s.bv(t.blendFunction,ui.Replace)?this.blend.set(!1):(this.blend.set(!0),this.blendFunc.set(t.blendFunction),this.blendColor.set(t.blendColor),t.blendEquation?this.blendEquation.set(t.blendEquation):this.blendEquation.setDefault()),this.colorMask.set(t.mask)}unbindVAO(){this.bindVertexArrayOES.set(null)}}let Ca;function Zh(l,t,r,c,p,_,v){const b=l.context,I=b.gl,M=l.transform,L=[s.aD(M.center.lng),s.aH(M.center.lat)],B=r.layout.get("symbol-placement"),F=r.layout.get("text-variable-anchor"),V=r.layout.get("icon-rotation-alignment")==="map",$=r.layout.get("text-rotation-alignment")==="map",H=B!=="point",X=[];let Z=0,te=0;for(let _e=0;_e<c.length;_e++){const ge=c[_e],Be=t.getTile(ge),Ce=Be.getBucket(r);if(!Ce)continue;const nt=Ce.getProjection().createInversionMatrix(M,ge.canonical),He=[],at=Ua(ge,Ce,M),mt=!v&&V&&H,ze=v&&$&&H,Te=F&&Ce.hasTextData(),Ze=Ce.hasIconTextFit()&&Te&&Ce.hasIconData(),Ue=mt||ze||v&&Te||Ze,dt=Ce.projection.name==="globe",ft=dt?s.ah(M.zoom):0;dt&&(He.push("PROJECTION_GLOBE_VIEW"),Ue&&He.push("PROJECTED_POS_ON_VIEWPORT"));const xt=l.getOrCreateProgram("collisionBox",{defines:He});let It=at;p[0]===0&&p[1]===0||(It=l.translatePosMatrix(at,Be,p,_));const Qt=v?Ce.textCollisionBox:Ce.iconCollisionBox,oi=Ce.collisionCircleArray;if(oi.length>0){const si=s.bz(),Jt=It;s.cM(si,Ce.placementInvProjMatrix,M.glCoordMatrix),s.cM(si,si,Ce.placementViewportMatrix),X.push({circleArray:oi,circleOffset:te,transform:Jt,invTransform:si,projection:Ce.getProjection()}),Z+=oi.length/4,te=Z}if(!Qt)continue;l.terrain&&l.terrain.setupElevationDraw(Be,xt);const qt=dt?[ge.canonical.x,ge.canonical.y,1<<ge.canonical.z]:[0,0,0];xt.draw(l,I.LINES,Vt.disabled,_i.disabled,l.colorModeForRenderPass(),gi.disabled,yu(It,nt,M,ft,L,Be,qt,Ce.getProjection()),r.id,Qt.layoutVertexBuffer,Qt.indexBuffer,Qt.segments,null,M.zoom,null,[Qt.collisionVertexBuffer,Qt.collisionVertexBufferExt])}if(!v||!X.length)return;const oe=l.getOrCreateProgram("collisionCircle"),le=new s.dU;le.resize(4*Z),le._trim();let pe=0;for(const _e of X)for(let ge=0;ge<_e.circleArray.length/4;ge++){const Be=4*ge,Ce=_e.circleArray[Be+0],nt=_e.circleArray[Be+1],He=_e.circleArray[Be+2],at=_e.circleArray[Be+3];le.emplace(pe++,Ce,nt,He,at,0),le.emplace(pe++,Ce,nt,He,at,1),le.emplace(pe++,Ce,nt,He,at,2),le.emplace(pe++,Ce,nt,He,at,3)}(!Ca||Ca.length<2*Z)&&(Ca=(function(_e){const ge=2*_e,Be=new s.a_;Be.resize(ge),Be._trim();for(let Ce=0;Ce<ge;Ce++){const nt=6*Ce;Be.uint16[nt+0]=4*Ce+0,Be.uint16[nt+1]=4*Ce+1,Be.uint16[nt+2]=4*Ce+2,Be.uint16[nt+3]=4*Ce+2,Be.uint16[nt+4]=4*Ce+3,Be.uint16[nt+5]=4*Ce+0}return Be})(Z));const ye=b.createIndexBuffer(Ca,!0),we=b.createVertexBuffer(le,s.dV.members,!0);for(const _e of X){const ge={u_matrix:_e.transform,u_inv_matrix:_e.invTransform,u_camera_to_center_distance:(me=M).getCameraToCenterDistance(_e.projection),u_viewport_size:[me.width,me.height]};oe.draw(l,I.TRIANGLES,Vt.disabled,_i.disabled,l.colorModeForRenderPass(),gi.disabled,ge,r.id,we,ye,s.bd.simpleSegment(0,2*_e.circleOffset,_e.circleArray.length,_e.circleArray.length/2),null,M.zoom)}var me;we.destroy(),ye.destroy()}const gc=s.bz();function Eu(l){const t=l._camera.getWorldToCamera(l.worldSize,1),r=s.az([],t,l.globeMatrix);s.bi(r,r);const c=[0,0,0],p=[0,1,0,0];return s.aA(p,p,r),c[0]=p[0],c[1]=p[1],c[2]=p[2],s.au(c,c),c}function Xh({width:l,height:t,anchor:r,textOffset:c,textScale:p},_){const{horizontalAlign:v,verticalAlign:b}=s.bZ(r),I=-(v-.5)*l,M=-(b-.5)*t,L=s.b_(r,c);return new s.P((I/p+L[0])*_,(M/p+L[1])*_)}function Su(l,t,r,c,p,_,v,b,I,M){const L=l.text.placedSymbolArray,B=l.text.dynamicLayoutVertexArray,F=l.icon.dynamicLayoutVertexArray,V={},$=l.getProjection(),H=ja(v,$,p),X=p.elevation,Z=$.upVectorScale(v.canonical,p.center.lat,p.worldSize).metersToTile;B.clear();for(let te=0;te<L.length;te++){const oe=L.get(te),{tileAnchorX:le,tileAnchorY:pe,numGlyphs:ye}=oe,we=oe.hidden||!oe.crossTileID||l.allowVerticalPlacement&&!oe.placedOrientation?null:c[oe.crossTileID];if(we){let me=0,_e=0,ge=0;if(X){const Ze=X?X.getAtTileOffset(v,le,pe):0,[Ue,dt,ft]=$.upVector(v.canonical,le,pe);me=Ze*Ue*Z,_e=Ze*dt*Z,ge=Ze*ft*Z}let[Be,Ce,nt,He]=ds(oe.projectedAnchorX+me,oe.projectedAnchorY+_e,oe.projectedAnchorZ+ge,r?H:_);const at=Cc(p.getCameraToCenterDistance($),He);let mt=s.bJ(l.textSizeData,I,oe)*at/s.bU;r&&(mt*=l.tilePixelRatio/b);const ze=Xh(we,mt);r?({x:Be,y:Ce,z:nt}=$.projectTilePoint(le+ze.x,pe+ze.y,v.canonical),[Be,Ce,nt]=ds(Be+me,Ce+_e,nt+ge,_)):(t&&ze._rotate(-p.angle),Be+=ze.x,Ce+=ze.y,nt=0);const Te=l.allowVerticalPlacement&&oe.placedOrientation===s.bI.vertical?Math.PI/2:0;for(let Ze=0;Ze<ye;Ze++)s.bL(B,Be,Ce,nt,Te);M&&oe.associatedIconIndex>=0&&(V[oe.associatedIconIndex]={x:Be,y:Ce,z:nt,angle:Te})}else Go(ye,B)}if(M){F.clear();const te=l.icon.placedSymbolArray;for(let oe=0;oe<te.length;oe++){const le=te.get(oe),{numGlyphs:pe}=le,ye=V[oe];if(le.hidden||!ye)Go(pe,F);else{const{x:we,y:me,z:_e,angle:ge}=ye;for(let Be=0;Be<pe;Be++)s.bL(F,we,me,_e,ge)}}l.icon.dynamicLayoutVertexBuffer.updateData(F)}l.text.dynamicLayoutVertexBuffer.updateData(B)}function na(l,t,r,c,p,_,v={}){const b=r.paint.get("icon-translate"),I=r.paint.get("text-translate"),M=r.paint.get("icon-translate-anchor"),L=r.paint.get("text-translate-anchor"),B=r.layout.get("icon-rotation-alignment"),F=r.layout.get("text-rotation-alignment"),V=r.layout.get("icon-pitch-alignment"),$=r.layout.get("text-pitch-alignment"),H=r.layout.get("icon-keep-upright"),X=r.layout.get("text-keep-upright"),Z=r.paint.get("icon-color-saturation"),te=r.paint.get("icon-color-contrast"),oe=r.paint.get("icon-color-brightness-min"),le=r.paint.get("icon-color-brightness-max"),pe=r.layout.get("symbol-elevation-reference")==="sea",ye=l.context,we=ye.gl,me=l.transform,_e=B==="map",ge=F==="map",Be=V==="map",Ce=$==="map",nt=r.layout.get("symbol-sort-key").constantOr(1)!==void 0;let He=!1;const at=l.depthModeForSublayer(0,Vt.ReadOnly),mt=new Vt(l.context.gl.LEQUAL,Vt.ReadOnly,l.depthRangeFor3D),ze=[s.aD(me.center.lng),s.aH(me.center.lat)],Te=r.layout.get("text-variable-anchor"),Ze=me.projection.name==="globe",Ue=[],dt=[0,-1,0];for(const ft of c){const xt=t.getTile(ft),It=xt.getBucket(r);if(!It||It.projection.name==="mercator"&&Ze||It.fullyClipped)continue;const Qt=It.projection.name==="globe",oi=Qt?s.ah(me.zoom):0,qt=ja(ft,It.getProjection(),me),si=me.calculatePixelsToTileUnitsMatrix(xt),Jt=Te&&It.hasTextData(),Ci=It.hasIconTextFit()&&Jt&&It.hasIconData(),Fi=It.getProjection().createInversionMatrix(me,ft.canonical),Hi=(1<<xt.tileID.canonical.z)*s.aj/l.transform.worldSize,gn=Qn=>{let Ln=[0,0,0];if(Qn){const zr=l.style.directionalLight,Tn=l.style.ambientLight;zr&&Tn&&(Ln=lc(l.style,zr,Tn))}return Ln},ki=Qn=>{me.depthOcclusionForSymbolsAndCircles&&(r.hasInitialOcclusionOpacityProperties||l.terrain)&&(Qn.push("DEPTH_D24"),Qn.push("DEPTH_OCCLUSION"))},En=()=>{const Qn=_e&&r.layout.get("symbol-placement")!=="point",Ln=[];ki(Ln);const zr=Qn||Ci,Tn=It.elevationType==="road",Nn=l.shadowRenderer,tr=Tn&&Be&&!!Nn&&Nn.enabled,ls=gn(tr),pr=Tn&&Be&&!l.terrain?mt:at,ts=r.paint.get("icon-image-cross-fade");l.terrainRenderModeElevated()&&Be&&Ln.push("PITCH_WITH_MAP_TERRAIN"),Qt&&(Ln.push("PROJECTION_GLOBE_VIEW"),zr&&Ln.push("PROJECTED_POS_ON_VIEWPORT")),ts>0&&It.hasAnySecondaryIcon&&Ln.push("ICON_TRANSITION"),!It.icon.zOffsetVertexBuffer||Tn&&l.terrain||Ln.push("Z_OFFSET"),Z===0&&te===0&&oe===0&&le===1||Ln.push("COLOR_ADJUSTMENT"),It.sdfIcons&&Ln.push("RENDER_SDF"),tr&&Ln.push("RENDER_SHADOWS","DEPTH_TEXTURE","NORMAL_OFFSET"),Tn&&Be&&!l.terrain&&It.icon.orientationVertexBuffer&&Ln.push("ELEVATED_ROADS");const Hs=It.icon.programConfigurations.get(r.id),po=l.getOrCreateProgram("symbol",{config:Hs,defines:Ln}),no=xt.imageAtlasTexture?xt.imageAtlasTexture.size:[0,0],qs=It.iconSizeData,Fs=s.bH(qs,me.zoom),Wo=Be||!me.isOrthographic,aa=cl(qt,xt.tileID.canonical,Be,_e,me,It.getProjection(),si),mo=ba(qt,xt.tileID.canonical,Be,_e,me,It.getProjection(),si),Hr=l.translatePosMatrix(mo,xt,b,M,!0),qr=l.translatePosMatrix(qt,xt,b,M),lr=zr?gc:aa,ms=_e&&!Be&&!Qn;let Is=dt;!Ze&&!me.mercatorFromTransition||_e||(Is=Eu(me));const Or=Qt?Is:dt,la=r.getColorAdjustmentMatrix(Z,te,oe,le),Tc=qh(qs.kind,Fs,ms,Be,l,qr,lr,Hr,pe,!1,no,[0,0],0,ft,oi,ze,Fi,Or,It.getProjection(),ls,Hi,la,ts,null),Kc=xt.imageAtlasTexture?xt.imageAtlasTexture:null,Fu=r.layout.get("icon-size").constantOr(0)!==1||It.iconsNeedLinear,Yc=It.sdfIcons||l.options.rotating||l.options.zooming||Fu||Wo?we.LINEAR:we.NEAREST,Lo=It.sdfIcons&&r.paint.get("icon-halo-width").constantOr(1)!==0,el=l.terrain&&Be&&Qn?s.bi(s.bz(),aa):gc;if(Qn&&It.icon){const cs=me.elevation,ca=cs?cs.getAtTileOffsetFunc(ft,me.center.lat,me.worldSize,It.getProjection()):null,Ou=ul(qt,xt.tileID.canonical,Be,_e,me,It.getProjection(),si);hl(It,qt,l,!1,Ou,mo,Be,H,ca,ft)}return{program:po,buffers:It.icon,uniformValues:Tc,atlasTexture:Kc,atlasTextureIcon:null,atlasInterpolation:Yc,atlasInterpolationIcon:null,isSDF:It.sdfIcons,hasHalo:Lo,depthMode:pr,tile:xt,renderWithShadows:tr,labelPlaneMatrixInv:el}},Dn=()=>{const Qn=ge&&r.layout.get("symbol-placement")!=="point",Ln=[],zr=Qn||Te||Ci,Tn=It.elevationType==="road",Nn=l.shadowRenderer,tr=Tn&&Ce&&!!Nn&&Nn.enabled,ls=gn(tr),pr=Tn&&Ce&&!l.terrain?mt:at;l.terrainRenderModeElevated()&&Ce&&Ln.push("PITCH_WITH_MAP_TERRAIN"),Qt&&(Ln.push("PROJECTION_GLOBE_VIEW"),zr&&Ln.push("PROJECTED_POS_ON_VIEWPORT")),!It.text.zOffsetVertexBuffer||Tn&&l.terrain||Ln.push("Z_OFFSET"),It.iconsInText&&Ln.push("RENDER_TEXT_AND_SYMBOL"),Ln.push("RENDER_SDF"),tr&&Ln.push("RENDER_SHADOWS","DEPTH_TEXTURE","NORMAL_OFFSET"),Tn&&Ce&&!l.terrain&&It.text.orientationVertexBuffer&&Ln.push("ELEVATED_ROADS"),ki(Ln);const ts=It.text.programConfigurations.get(r.id),Hs=l.getOrCreateProgram("symbol",{config:ts,defines:Ln});let po,no=[0,0],qs=null;const Fs=It.textSizeData;It.iconsInText&&(no=xt.imageAtlasTexture?xt.imageAtlasTexture.size:[0,0],qs=xt.imageAtlasTexture?xt.imageAtlasTexture:null,po=Ce||!me.isOrthographic||l.options.rotating||l.options.zooming||Fs.kind==="composite"||Fs.kind==="camera"?we.LINEAR:we.NEAREST);const Wo=xt.glyphAtlasTexture?xt.glyphAtlasTexture.size:[0,0],aa=r.layout.get("text-size-scale-range"),mo=s.ay(l.scaleFactor,aa[0],aa[1]),Hr=s.bH(Fs,me.zoom,mo),qr=cl(qt,xt.tileID.canonical,Ce,ge,me,It.getProjection(),si),lr=ba(qt,xt.tileID.canonical,Ce,ge,me,It.getProjection(),si),ms=l.translatePosMatrix(lr,xt,I,L,!0),Is=l.translatePosMatrix(qt,xt,I,L),Or=zr?gc:qr,la=ge&&!Ce&&!Qn;let Tc=dt;!Ze&&!me.mercatorFromTransition||ge||(Tc=Eu(me));const Kc=qh(Fs.kind,Hr,la,Ce,l,Is,Or,ms,pe,!0,Wo,no,0,ft,oi,ze,Fi,Qt?Tc:dt,It.getProjection(),ls,Hi,null,null,mo),Fu=xt.glyphAtlasTexture?xt.glyphAtlasTexture:null,Yc=we.LINEAR,Lo=r.paint.get("text-halo-width").constantOr(1)!==0,el=l.terrain&&Ce&&Qn?s.bi(s.bz(),qr):gc;if(Qn&&It.text){const cs=me.elevation,ca=cs?cs.getAtTileOffsetFunc(ft,me.center.lat,me.worldSize,It.getProjection()):null,Ou=ul(qt,xt.tileID.canonical,Ce,ge,me,It.getProjection(),si);hl(It,qt,l,!0,Ou,lr,Ce,X,ca,ft)}return{program:Hs,buffers:It.text,uniformValues:Kc,atlasTexture:Fu,atlasTextureIcon:qs,atlasInterpolation:Yc,atlasInterpolationIcon:po,isSDF:!0,hasHalo:Lo,depthMode:pr,tile:xt,renderWithShadows:tr,labelPlaneMatrixInv:el}},sr=It.icon.segments.get().length,Ni=It.text.segments.get().length,Sn=sr&&!v.onlyText?En():null,pn=Ni&&!v.onlyIcons?Dn():null,Bn=r.paint.get("icon-opacity").constantOr(1),Si=r.paint.get("text-opacity").constantOr(1);if(nt&&It.canOverlap){He=!0;const Qn=Bn&&!v.onlyText?It.icon.segments.get():[],Ln=Si&&!v.onlyIcons?It.text.segments.get():[];for(const zr of Qn)Ue.push({segments:new s.bd([zr]),sortKey:zr.sortKey,state:Sn});for(const zr of Ln)Ue.push({segments:new s.bd([zr]),sortKey:zr.sortKey,state:pn})}else v.onlyText||Ue.push({segments:Bn?It.icon.segments:new s.bd([]),sortKey:0,state:Sn}),v.onlyIcons||Ue.push({segments:Si?It.text.segments:new s.bd([]),sortKey:0,state:pn})}He&&Ue.sort(((ft,xt)=>ft.sortKey-xt.sortKey));for(const ft of Ue){const xt=ft.state;if(xt)if(l.terrain?l.terrain.setupElevationDraw(xt.tile,xt.program,{useDepthForOcclusion:me.depthOcclusionForSymbolsAndCircles,labelPlaneMatrixInv:xt.labelPlaneMatrixInv}):l.setupDepthForOcclusion(me.depthOcclusionForSymbolsAndCircles,xt.program),ye.activeTexture.set(we.TEXTURE0),xt.atlasTexture&&xt.atlasTexture.bind(xt.atlasInterpolation,we.CLAMP_TO_EDGE,!0),xt.atlasTextureIcon&&(ye.activeTexture.set(we.TEXTURE1),xt.atlasTextureIcon&&xt.atlasTextureIcon.bind(xt.atlasInterpolationIcon,we.CLAMP_TO_EDGE,!0)),xt.renderWithShadows&&l.shadowRenderer.setupShadows(xt.tile.tileID.toUnwrapped(),xt.program,"vector-tile"),l.uploadCommonLightUniforms(l.context,xt.program),xt.hasHalo){const It=xt.uniformValues;It.u_is_halo=1,ra(xt.buffers,ft.segments,r,l,xt.program,xt.depthMode,p,_,It,2),It.u_is_halo=0}else{if(xt.isSDF){const It=xt.uniformValues;xt.hasHalo&&(It.u_is_halo=1,ra(xt.buffers,ft.segments,r,l,xt.program,xt.depthMode,p,_,It,1)),It.u_is_halo=0}ra(xt.buffers,ft.segments,r,l,xt.program,xt.depthMode,p,_,xt.uniformValues,1)}}}function ra(l,t,r,c,p,_,v,b,I,M){const L=[l.dynamicLayoutVertexBuffer,l.opacityVertexBuffer,l.iconTransitioningVertexBuffer,l.globeExtVertexBuffer,l.zOffsetVertexBuffer,l.orientationVertexBuffer];p.draw(c,c.context.gl.TRIANGLES,_,v,b,gi.disabled,I,r.id,l.layoutVertexBuffer,l.indexBuffer,t,r.paint,c.transform.zoom,l.programConfigurations.get(r.id),L,M)}function Iu(l,t){const r=1<<l.canonical.z,c=(t.x*r-l.canonical.x-l.wrap*r)*s.aj,p=(t.y*r-l.canonical.y)*s.aj,_=s.e2(t.z,t.y);return s.d2(c,p,_)}function Kt(l,t,r,c,p){if(!r.layout||r.layout.get("fill-elevation-reference")==="none")return;const _=l.context.gl,v=new Vt(l.context.gl.LEQUAL,Vt.ReadWrite,l.depthRangeFor3D),b=new Vt(l.context.gl.GREATER,Vt.ReadWrite,l.depthRangeFor3D),I=(function(V){const $=s.cU(V.pitch);let H=.01;return V.isOrthographic&&(H=s.ai(1e-4,H,s.cZ($>=Ms?1:$/Ms))),2*H})(l.transform),M=l.transform.getFreeCameraOptions().position,L="elevatedStructuresDepthReconstruct",B=l.getOrCreateProgram(L,{defines:["DEPTH_RECONSTRUCTION"]}),F=l.getOrCreateProgram(L);for(const V of c){const $=t.getTile(V),H=$.getBucket(r);if(!H)continue;const X=H.elevatedStructures;if(!X)continue;const Z=H.elevationBufferData.heightRange,te=Iu(V.toUnwrapped(),M),oe=l.translatePosMatrix(V.projMatrix,$,r.paint.get("fill-translate"),r.paint.get("fill-translate-anchor"));let le,pe,ye,we;if(p==="initialize"){if(!Z||Z.min>=1||X.depthSegments.segments[0].primitiveLength===0)continue;le=Wl(oe,te,I,1,0),pe=v,ye=X.depthSegments,we=B}else if(p==="reset"){if(!Z||Z.min>=0||X.maskSegments.segments[0].primitiveLength===0)continue;le=Wl(oe,te,0,0,1),pe=b,ye=X.maskSegments,we=B}else if(p==="geometry"){if(X.depthSegments.segments[0].primitiveLength===0)continue;le=Wl(oe,te,I,1,0),pe=v,ye=X.depthSegments,we=F}we.draw(l,_.TRIANGLES,pe,_i.disabled,ui.disabled,gi.disabled,le,r.id,X.vertexBuffer,X.indexBuffer,ye,r.paint,l.transform.zoom)}}function Ya(l,t,r){const{painter:c,sourceCache:p,layer:_,coords:v,colorMode:b,elevationType:I,terrainEnabled:M,pass:L}=l,B=c.context.gl,F=_.paint.get("fill-pattern"),V=_.paint.get("fill-pattern-cross-fade"),$=F.constantOr(null);let H=I;I!=="road"||t&&!M||(H="none");const X=H==="road",Z=l.painter.shadowRenderer,te=X&&!!Z&&Z.enabled,oe=new Vt(c.context.gl.LEQUAL,Vt.ReadOnly,c.depthRangeFor3D);let le=[0,0,0];if(te){const we=c.style.directionalLight,me=c.style.ambientLight;we&&me&&(le=lc(c.style,we,me))}const pe=F&&F.constantOr(1),ye=(we,me)=>{let _e,ge,Be,Ce,nt;me?(_e=pe&&!_.getPaintProperty("fill-outline-color")?"fillOutlinePattern":"fillOutline",Be=B.LINES):(_e=pe?"fillPattern":"fill",Be=B.TRIANGLES);for(const He of v){const at=p.getTile(He);if(pe&&!at.patternsLoaded())continue;const mt=at.getBucket(_);if(!mt)continue;const ze=t?mt.elevationBufferData:mt.bufferData;if(ze.isEmpty())continue;c.prepareDrawTile();const Te=ze.programConfigurations.get(_.id),Ze=c.isTileAffectedByFog(He),Ue=[],dt=[];X&&(Ue.push("ELEVATED_ROADS"),dt.push(ze.elevatedLayoutVertexBuffer)),te&&Ue.push("RENDER_SHADOWS","DEPTH_TEXTURE","NORMAL_OFFSET"),pe&&(c.context.activeTexture.set(B.TEXTURE0),at.imageAtlasTexture&&at.imageAtlasTexture.bind(B.LINEAR,B.CLAMP_TO_EDGE),Te.updatePaintBuffers());let ft=!1;if($&&at.imageAtlas){const qt=at.imageAtlas,si=s.dZ.from($),Jt=si.getPrimary().scaleSelf(s.q.devicePixelRatio).toString(),Ci=si.getSecondary(),Fi=qt.patternPositions.get(Jt),Hi=Ci?qt.patternPositions.get(Ci.scaleSelf(s.q.devicePixelRatio).toString()):null;ft=!!Fi&&!!Hi,Fi&&Te.setConstantPatternPositions(Fi,Hi)}V>0&&(ft||Te.getPatternTransitionVertexBuffer("fill-pattern"))&&Ue.push("FILL_PATTERN_TRANSITION");const xt=c.getOrCreateProgram(_e,{config:Te,overrideFog:Ze,defines:Ue}),It=c.translatePosMatrix(He.projMatrix,at,_.paint.get("fill-translate"),_.paint.get("fill-translate-anchor"));te&&Z.setupShadows(at.tileID.toUnwrapped(),xt,"vector-tile");const Qt=_.paint.get("fill-emissive-strength");if(me){Ce=ze.lineIndexBuffer,nt=ze.lineSegments;const qt=c.terrain&&c.terrain.renderingToTexture?c.terrain.drapeBufferSize:[B.drawingBufferWidth,B.drawingBufferHeight];ge=_e==="fillOutlinePattern"&&pe?Xa(It,Qt,c,at,qt,le,V):zd(It,Qt,qt,le)}else Ce=ze.indexBuffer,nt=ze.triangleSegments,ge=pe?Gh(It,Qt,c,at,le,V):gu(It,Qt,le);c.uploadCommonUniforms(c.context,xt,He.toUnwrapped());let oi=we;(I==="road"&&!M||I==="offset")&&(oi=oe),xt.draw(c,Be,oi,r||c.stencilModeForClipping(He),b,gi.disabled,ge,_.id,ze.layoutVertexBuffer,Ce,nt,_.paint,c.transform.zoom,Te,dt)}};c.renderPass===L&&ye(c.depthModeForSublayer(1,c.renderPass==="opaque"?Vt.ReadWrite:Vt.ReadOnly),!1),H==="none"&&c.renderPass==="translucent"&&_.paint.get("fill-antialias")&&ye(c.depthModeForSublayer(_.getPaintProperty("fill-outline-color")?2:0,Vt.ReadOnly),!0)}function Qa(l,t,r,c,p,_,v,b){r.resetLayerRenderingStats(l);const I=l.context,M=I.gl,L=l.transform,B=r.paint.get("fill-extrusion-pattern"),F=r.paint.get("fill-extrusion-pattern-cross-fade"),V=B.constantOr(null),$=B.constantOr(1),H=r.paint.get("fill-extrusion-opacity"),X=l.style.enable3dLights(),Z=r.paint.get(X&&!$?"fill-extrusion-ambient-occlusion-wall-radius":"fill-extrusion-ambient-occlusion-radius"),te=[r.paint.get("fill-extrusion-ambient-occlusion-intensity"),Z],oe=r.layout.get("fill-extrusion-edge-radius"),le=oe>0&&!r.paint.get("fill-extrusion-rounded-roof"),pe=le?0:oe,ye=L.projection.name==="globe"?s.e5():0,we=L.projection.name==="globe",me=we?s.ah(L.zoom):0,_e=[s.aD(L.center.lng),s.aH(L.center.lat)],ge=r.paint.get("fill-extrusion-flood-light-color-use-theme").constantOr("default")==="none",Be=r.paint.get("fill-extrusion-flood-light-color").toNonPremultipliedRenderColor(ge?null:r.lut).toArray01().slice(0,3),Ce=r.paint.get("fill-extrusion-flood-light-intensity"),nt=r.paint.get("fill-extrusion-vertical-scale"),He=r.paint.get("fill-extrusion-line-width").constantOr(1)!==0,at=r.paint.get("fill-extrusion-height-alignment"),mt=r.paint.get("fill-extrusion-base-alignment"),ze=ta(l,r.paint.get("fill-extrusion-cutoff-fade-range")),Te=[];let Ze;we&&Te.push("PROJECTION_GLOBE_VIEW"),te[0]>0&&Te.push("FAUX_AO"),le&&Te.push("ZERO_ROOF_RADIUS"),b&&Te.push("HAS_CENTROID"),Ce>0&&Te.push("FLOOD_LIGHT"),ze.shouldRenderCutoff&&Te.push("RENDER_CUTOFF"),He&&Te.push("RENDER_WALL_MODE");const Ue=l.renderPass==="shadow",dt=l.shadowRenderer,ft=Ue&&!!dt,xt=Ue?gi.disabled:gi.backCCW;l.shadowRenderer&&(l.shadowRenderer.useNormalOffset=!0);let It=[0,0,0];if(dt){const qt=l.style.directionalLight,si=l.style.ambientLight;qt&&si&&(It=lc(l.style,qt,si)),Ue||(Te.push("RENDER_SHADOWS","DEPTH_TEXTURE"),dt.useNormalOffset&&Te.push("NORMAL_OFFSET")),Ze=Te.concat(["SHADOWS_SINGLE_CASCADE"])}const Qt=ft?"fillExtrusionDepth":$?"fillExtrusionPattern":"fillExtrusion",oi=r.getLayerRenderingStats();for(const qt of c){const si=t.getTile(qt),Jt=si.getBucket(r);if(!Jt||Jt.projection.name!==L.projection.name)continue;let Ci=!1;dt&&(Ci=dt.getMaxCascadeForTile(qt.toUnwrapped())===0);const Fi=l.isTileAffectedByFog(qt),Hi=Jt.programConfigurations.get(r.id);let gn=!1;if(V&&si.imageAtlas){const pn=si.imageAtlas,Bn=s.dZ.from(V),Si=Bn.getPrimary().scaleSelf(s.q.devicePixelRatio).toString(),Qn=Bn.getSecondary(),Ln=pn.patternPositions.get(Si),zr=Qn?pn.patternPositions.get(Qn.scaleSelf(s.q.devicePixelRatio).toString()):null;gn=!!Ln&&!!zr,Ln&&Hi.setConstantPatternPositions(Ln,zr)}F>0&&(gn||Hi.getPatternTransitionVertexBuffer("fill-extrusion-pattern"))&&Te.push("FILL_EXTRUSION_PATTERN_TRANSITION");const ki=l.getOrCreateProgram(Qt,{config:Hi,defines:Ci?Ze:Te,overrideFog:Fi});if(l.terrain&&l.terrain.setupElevationDraw(si,ki,{useMeterToDem:!0}),!Jt.centroidVertexBuffer){const pn=ki.attributes.a_centroid_pos;pn!==void 0&&M.vertexAttrib2f(pn,0,0)}!Ue&&dt&&dt.setupShadows(si.tileID.toUnwrapped(),ki,"vector-tile"),$&&(l.context.activeTexture.set(M.TEXTURE0),si.imageAtlasTexture&&si.imageAtlasTexture.bind(M.LINEAR,M.CLAMP_TO_EDGE),Hi.updatePaintBuffers());const En=r.paint.get("fill-extrusion-vertical-gradient"),Dn=1/Jt.tileToMeter;let sr;if(Ue&&dt){if(Au(si.tileID,Jt.maxHeight,l))continue;const pn=dt.calculateShadowPassMatrixFromTile(si.tileID.toUnwrapped());sr=fc(pn,pe,Dn,nt,at,mt)}else{const pn=l.translatePosMatrix(qt.expandedProjMatrix,si,r.paint.get("fill-extrusion-translate"),r.paint.get("fill-extrusion-translate-anchor")),Bn=L.projection.createInversionMatrix(L,qt.canonical);sr=$?pl(pn,l,En,H,te,pe,Dn,qt,si,ye,at,mt,me,_e,Bn,Be,nt,F):jf(pn,l,En,H,te,pe,Dn,qt,ye,at,mt,me,_e,Bn,Be,nt,Ce,It)}l.uploadCommonUniforms(I,ki,qt.toUnwrapped(),null,ze);let Ni=Jt.segments;if(L.projection.name==="mercator"&&!Ue&&(Ni=Jt.getVisibleSegments(si.tileID,l.terrain,l.transform.getFrustum(0)),!Ni.get().length))continue;if(oi)if(Ue)for(const pn of Ni.get())oi.numRenderedVerticesInShadowPass+=pn.primitiveLength;else for(const pn of Ni.get())oi.numRenderedVerticesInTransparentPass+=pn.primitiveLength;const Sn=[];(l.terrain||b)&&Sn.push(Jt.centroidVertexBuffer),we&&Sn.push(Jt.layoutVertexExtBuffer),He&&Sn.push(Jt.wallVertexBuffer),ki.draw(l,I.gl.TRIANGLES,p,_,v,xt,sr,r.id,Jt.layoutVertexBuffer,Jt.indexBuffer,Ni,r.paint,l.transform.zoom,Hi,Sn)}l.shadowRenderer&&(l.shadowRenderer.useNormalOffset=!1)}class gl{constructor(){this.translate=[0,0],this.translateAnchor="map",this.edgeRadius=0,this.cutoffFadeRange=0}}function Ro(l,t,r,c,p,_,v,b,I,M,L,B,F,V,$,H,X,Z,te,oe){const le=t.context,pe=le.gl,ye=t.transform,we=t.transform.zoom,me=[],_e=l.translate,ge=l.translateAnchor,Be=l.edgeRadius,Ce=ta(t,l.cutoffFadeRange);L==="clear"?(me.push("CLEAR_SUBPASS"),oe&&(me.push("CLEAR_FROM_TEXTURE"),le.activeTexture.set(pe.TEXTURE0),oe.bind(pe.LINEAR,pe.CLAMP_TO_EDGE))):L==="sdf"&&me.push("SDF_SUBPASS"),Z&&me.push("HAS_CENTROID"),Ce.shouldRenderCutoff&&me.push("RENDER_CUTOFF");const nt=(He,at,mt,ze,Te)=>{const Ze=at.programConfigurations.get(c.id),Ue=t.isTileAffectedByFog(He),dt=t.getOrCreateProgram("fillExtrusionGroundEffect",{config:Ze,defines:me,overrideFog:Ue}),ft=((It,Qt,oi,qt,si,Jt,Ci,Fi,Hi,gn,ki)=>({u_matrix:Qt,u_opacity:oi,u_ao_pass:qt?1:0,u_meter_to_tile:si,u_ao:Jt,u_flood_light_intensity:Ci,u_flood_light_color:Fi,u_attenuation:Hi,u_edge_radius:gn,u_fb:0,u_fb_size:ki,u_dynamic_offset:1}))(0,ze,B,M,Te,[F,V*Te],$,H,X,we>=17?0:Be*Te,oe?oe.size[0]:0),xt=[];Z&&xt.push(at.hiddenByLandmarkVertexBuffer),t.uploadCommonUniforms(le,dt,He.toUnwrapped(),null,Ce),dt.draw(t,le.gl.TRIANGLES,_,v,b,I,ft,c.id,at.vertexBuffer,at.indexBuffer,mt,c.paint,we,Ze,xt)};for(const He of p){const at=r.getTile(He),mt=at.getBucket(c);if(!mt||mt.projection.name!==ye.projection.name||!mt.groundEffect||mt.groundEffect&&!mt.groundEffect.hasData())continue;const ze=mt.groundEffect,Te=1/mt.tileToMeter;{const Ze=t.translatePosMatrix(He.projMatrix,at,_e,ge),Ue=ze.getDefaultSegment();nt(He,ze,Ue,Ze,Te)}if(te)for(let Ze=0;Ze<4;Ze++){const Ue=s.e3[Ze](He),dt=r.getTile(Ue);if(!dt)continue;const ft=dt.getBucket(c);if(!ft||ft.projection.name!==ye.projection.name||!ft.groundEffect||ft.groundEffect&&!ft.groundEffect.hasData())continue;const xt=ft.groundEffect;let It,Qt;Ze===0?(It=[-s.aj,0,0],Qt=1):Ze===1?(It=[s.aj,0,0],Qt=0):Ze===2?(It=[0,-s.aj,0],Qt=3):(It=[0,s.aj,0],Qt=2);const oi=xt.regionSegments[Qt];if(!oi)continue;const qt=new Float32Array(16);s.bo(qt,He.projMatrix,It),nt(He,xt,oi,t.translatePosMatrix(qt,at,_e,ge),Te)}}}function fi(l,t,r,c,p,_,v){c.centroidVertexArray.length===0&&c.createCentroidsBuffer();const b=_?_.findDEMTileFor(r):null;if(!(b&&b.dem||v))return;_&&b&&b.dem&&c.selfDEMTileTimestamp!==b.dem._timestamp&&(c.borderDoneWithNeighborZ=[-1,-1,-1,-1],c.selfDEMTileTimestamp=b.dem._timestamp);const I=Z=>new s.P(Math.ceil((Z+s.e7)*s.e8),0),M=Z=>{const te=t.getSource().minzoom,oe=pe=>{const ye=t.getTileByID(pe);if(ye&&ye.hasData())return ye.getBucket(p)},le=[0,-1,1];for(const pe of le){if(Z.overscaledZ+pe<te)continue;const ye=oe(Z.calculateScaledKey(Z.overscaledZ+pe));if(ye)return ye}},L=[0,0,0],B=(Z,te)=>(L[0]=Math.min(Z.min.y,te.min.y),L[1]=Math.max(Z.max.y,te.max.y),L[2]=s.aj-te.min.x>Z.max.x?te.min.x-s.aj:Z.max.x,L),F=(Z,te)=>(L[0]=Math.min(Z.min.x,te.min.x),L[1]=Math.max(Z.max.x,te.max.x),L[2]=s.aj-te.min.y>Z.max.y?te.min.y-s.aj:Z.max.y,L),V=[(Z,te)=>B(Z,te),(Z,te)=>B(te,Z),(Z,te)=>F(Z,te),(Z,te)=>F(te,Z)],$=(Z,te,oe,le,pe,ye,we)=>{if(!_)return 0;const me=[[ye?oe:Z,ye?Z:oe,0],[ye?oe:te,ye?te:oe,0]],_e=we<0?s.aj+we:we,ge=[ye?_e:(Z+te)/2,ye?(Z+te)/2:_e,0];return oe===0&&we<0||oe!==0&&we>0?_.getForTilePoints(pe,[ge],!0,le):me.push(ge),_.getForTilePoints(r,me,!0,b),Math.max(me[0][2],me[1][2],ge[2])/_.exaggeration()};for(let Z=0;Z<4;Z++){const te=c.borderFeatureIndices[Z];if(te.length===0)continue;const oe=s.e3[Z](r),le=M(oe);if(!(le&&le instanceof s.e4))continue;const pe=_?_.findDEMTileFor(oe):null;if(!(pe&&pe.dem||v)||(_&&pe&&pe.dem&&c.borderDEMTileTimestamp[Z]!==pe.dem._timestamp&&(c.borderDoneWithNeighborZ[Z]=-1,c.borderDEMTileTimestamp[Z]=pe.dem._timestamp),c.borderDoneWithNeighborZ[Z]===le.canonical.z))continue;le.centroidVertexArray.length===0&&le.createCentroidsBuffer();const ye=(Z<2?1:5)-Z,we=le.borderDoneWithNeighborZ[ye]!==c.canonical.z,me=le.borderFeatureIndices[ye];let _e=0;if(c.canonical.z!==le.canonical.z){for(const ge of te)c.showCentroid(c.featuresOnBorder[ge]);if(we)for(const ge of me)le.showCentroid(le.featuresOnBorder[ge]);c.borderDoneWithNeighborZ[Z]=le.canonical.z,le.borderDoneWithNeighborZ[ye]=c.canonical.z}for(const ge of te){const Be=c.featuresOnBorder[ge],Ce=c.centroidData[Be.centroidDataIndex],nt=Be.borders[Z];let He;for(;_e<me.length;){He=le.featuresOnBorder[me[_e]];const at=He.borders[ye];if(at[1]>nt[0]+3||at[0]>nt[0]-3)break;le.showCentroid(He),_e++}if(He&&_e<me.length){const at=_e;let mt=0;for(;!(He.borders[ye][0]>nt[1]-3)&&(mt++,++_e!==me.length);)He=le.featuresOnBorder[me[_e]];He=le.featuresOnBorder[me[at]];let ze=!1;if(mt>=1){const Ue=He.borders[ye];Math.abs(nt[0]-Ue[0])<3&&Math.abs(nt[1]-Ue[1])<3&&(mt=1,ze=!0,_e=at+1)}else if(mt===0){c.showCentroid(Be);continue}const Te=le.centroidData[He.centroidDataIndex];v&&ze&&(((H=Ce).flags|(X=Te).flags)&s.e6?(H.flags|=s.e6,X.flags|=s.e6):(H.flags&=~s.e6,X.flags&=~s.e6));const Ze=Be.intersectsCount()>1||He.intersectsCount()>1;if(mt>1)_e=at,Ce.centroidXY=Te.centroidXY=new s.P(0,0);else if(pe&&pe.dem&&!Ze){const Ue=V[Z](Ce,Te),dt=Z%2?s.aj-1:0,ft=$(Ue[0],Math.min(s.aj-1,Ue[1]),dt,pe,oe,Z<2,Ue[2]);Ce.centroidXY=Te.centroidXY=I(ft)}else Ze?Ce.centroidXY=Te.centroidXY=new s.P(0,0):(Ce.centroidXY=c.encodeBorderCentroid(Be),Te.centroidXY=le.encodeBorderCentroid(He));c.writeCentroidToBuffer(Ce),le.writeCentroidToBuffer(Te)}else c.showCentroid(Be)}c.borderDoneWithNeighborZ[Z]=le.canonical.z,le.borderDoneWithNeighborZ[ye]=c.canonical.z}var H,X;(c.needsCentroidUpdate||!c.centroidVertexBuffer&&c.centroidVertexArray.length!==0)&&c.uploadCentroid(l)}const Xl=[1,0,0],Nd=[0,1,0],Ip=[0,0,1];function Au(l,t,r){const c=r.transform,p=r.shadowRenderer;if(!p)return!0;const _=l.toUnwrapped(),v=c.tileSize*p._cascades[r.currentShadowCascade].scale;let b=t;if(c.elevation){const H=c.elevation.getMinMaxForTile(l);H&&(b+=H.max)}const I=[...p.shadowDirection];I[2]=-I[2];const M=p.computeSimplifiedTileShadowVolume(_,b,v,I);if(!M)return!1;const L=[Xl,Nd,Ip,I,[I[0],0,I[2]],[0,I[1],I[2]]],B=c.projection.name==="globe",F=c.scaleZoom(v),V=s.cy.fromInvProjectionMatrix(c.invProjMatrix,c.worldSize,F,!B),$=p.getCurrentCascadeFrustum();return V.intersectsPrecise(M.vertices,M.planes,L)===0||$.intersectsPrecise(M.vertices,M.planes,L)===0}function Kh(l){const{painter:t,source:r,layer:c,coords:p}=l,_=l.defines,v=t.context,b=t.renderPass==="shadow",I=t.renderPass==="light-beam",M=t.shadowRenderer;let L;M&&(L=_.concat(["SHADOWS_SINGLE_CASCADE"]));const B=s.e9(t.transform.center.lat,t.transform.zoom);for(const F of p){const V=r.getTile(F),$=V.getBucket(c);if(!$)continue;let H=!1;M&&(H=M.getMaxCascadeForTile(F.toUnwrapped())===0);const X=$.programConfigurations.get(c.id);let Z,te,oe=t.translatePosMatrix(F.expandedProjMatrix,V,[0,0],"map");if(oe=s.cP(s.bz(),oe,[1,1,l.verticalScale]),b&&M){if(Au(V.tileID,$.maxHeight*B,t))continue;let le=M.calculateShadowPassMatrixFromTile(V.tileID.toUnwrapped());le=s.cP(s.bz(),le,[1,1,l.verticalScale]),te=Vc(le),Z=t.getOrCreateProgram("buildingDepth",{config:X,defines:H?L:_,overrideFog:!1})}else if(I)Z=t.getOrCreateProgram("buildingBloom",{config:X,defines:H?L:_,overrideFog:!1}),te=_l(oe);else{const le=t.transform.calculatePosMatrix(F.toUnwrapped(),t.transform.worldSize);s.cP(le,le,[1,1,l.verticalScale]);const pe=s.bz();s.cP(pe,le,[1,-1,1/B]),s.bi(pe,pe),s.ea(pe,pe),te=ml(oe,pe),Z=t.getOrCreateProgram("building",{config:X,defines:H?L:_,overrideFog:!1}),M&&M.setupShadowsFromMatrix(le,Z,!0)}if(t.uploadCommonUniforms(v,Z,F.toUnwrapped(),null,null),I){const le=$.bloomGeometry;Z.draw(t,v.gl.TRIANGLES,l.depthMode,_i.disabled,l.blendMode,gi.disabled,te,c.id,le.layoutVertexBuffer,le.indexBuffer,le.segmentsBucket,c.paint,t.transform.zoom,X,[le.layoutAttenuationBuffer,le.layoutColorBuffer])}else Z.draw(t,v.gl.TRIANGLES,l.depthMode,_i.disabled,l.blendMode,b?gi.disabled:gi.backCW,te,c.id,$.layoutVertexBuffer,$.indexBuffer,$.segments,c.paint,t.transform.zoom,X,[$.layoutNormalBuffer,$.layoutColorBuffer])}}function sh(l){return[l[0]*s.eb,l[1]*s.eb,l[2]*s.eb,0]}function Pa(l,t,r,c,p,_,v,b,I){const M=c.getSource(),L=r.globeSharedBuffers;if(!L)return;let B,F,V;if(t&&(B=c.getTile(t)),M instanceof s.aP?(F=M.texture,V=s.dE(0,0,r.transform)):B&&t&&(F=B.texture,V=s.dE(t.canonical.z,t.canonical.x,r.transform)),!F||!V)return;l||(V=s.cP(s.bz(),V,[1,-1,1]));const $=r.context,H=$.gl,X=p.paint.get("raster-resampling")==="nearest"?H.NEAREST:H.LINEAR,Z=r.colorModeForDrapableLayerRenderPass(_),te=v.defines;te.push("GLOBE_POLES");const oe=new Vt(H.LEQUAL,Vt.ReadWrite,r.depthRangeFor3D),le=Float32Array.from(r.transform.expandedFarZProjMatrix),pe=Float32Array.from(s.bh(s.dD(new s.cA(0,0,0))));r.terrain&&r.terrain.prepareDrawTile(),$.activeTexture.set(H.TEXTURE0),F.bind(X,H.CLAMP_TO_EDGE),$.activeTexture.set(H.TEXTURE1),F.bind(X,H.CLAMP_TO_EDGE),"useMipmap"in F&&$.extTextureFilterAnisotropic&&r.transform.pitch>20&&H.texParameterf(H.TEXTURE_2D,$.extTextureFilterAnisotropic.TEXTURE_MAX_ANISOTROPY_EXT,$.extTextureFilterAnisotropicMax);const[ye,we,me,_e]=t?L.getPoleBuffers(t.canonical.z,!1):L.getPoleBuffers(0,!0),ge=p.paint.get("raster-elevation");let Be;l?(Be=ye,r.renderDefaultNorthPole=ge!==0):(Be=we,r.renderDefaultSouthPole=ge!==0);const Ce=sh(v.mix),nt=((at,mt,ze,Te,Ze,Ue,dt,ft,xt,It,Qt,oi,qt)=>Aa(at,mt,ze,new Float32Array(16),new Float32Array(9),[0,0],Te,[0,0],[0,0,0,0],1,{opacity:1,mix:0},Ue,[0,0],ft,2,It,Qt,oi,1,0,qt))(le,pe,V,s.ah(r.transform.zoom),0,p,0,ge,0,Ce,v.offset,v.range,_),He=r.getOrCreateProgram("raster",{defines:te});r.uploadCommonUniforms($,He,null),He.draw(r,H.TRIANGLES,oe,I,Z,b,nt,p.id,Be,me,_e)}function Yh(l){const t=l._nearZ,r=l.projection.farthestPixelDistance(l),c=r-t,p=.2*l.height,_=t+p;return[t,r,(_-p-t)/c,(_-t)/c]}function Qh(l,t,r,c){if(l)return t instanceof ol&&l instanceof ec?t.getTextureDescriptor(l,r,!0):{texture:l.texture,mix:sh(c.mix),offset:c.offset,buffer:0,tileSize:1}}var js=s.ec([{name:"a_index",type:"Int16",components:1}]);class Jh{constructor(t,r,c,p){const _={width:c[0],height:c[1],data:null},v=t.gl;this.targetColorTexture=new s.T(t,_,v.RGBA8,{useMipmap:!1}),this.backgroundColorTexture=new s.T(t,_,v.RGBA8,{useMipmap:!1}),this.context=t,this.updateParticleTexture(r,p),this.lastInvalidatedAt=0}updateParticleTexture(t,r){if(this.particleTextureDimension===r.width)return;(this.particleTexture0||this.particleTexture1||this.particleIndexBuffer||this.particleSegment)&&(this.particleTexture0.destroy(),this.particleTexture1.destroy(),this.particleIndexBuffer.destroy(),this.particleSegment.destroy());const c=this.context.gl,p=r.width*r.height;this.particleTexture0=new s.T(this.context,r,c.RGBA8,{premultiply:!1,useMipmap:!1}),this.particleTexture1=new s.T(this.context,r,c.RGBA8,{premultiply:!1,useMipmap:!1});const _=new s.ed;_.reserve(p);for(let v=0;v<p;v++)_.emplaceBack(v);this.particleIndexBuffer=this.context.createVertexBuffer(_,js.members,!0),this.particleSegment=s.bd.simpleSegment(0,0,this.particleIndexBuffer.length,0),this.particleTextureDimension=r.width}update(t){return!(this.lastInvalidatedAt<t&&(this.lastInvalidatedAt=s.q.now(),1))}destroy(){this.targetColorTexture.destroy(),this.backgroundColorTexture.destroy(),this.particleIndexBuffer.destroy(),this.particleTexture0.destroy(),this.particleTexture1.destroy(),this.particleSegment.destroy()}}function ks(l,t,r){if(!l)return null;const c=t.getTextureDescriptor(l,r,!0);if(!c)return null;let{texture:p,mix:_,offset:v,tileSize:b,buffer:I,format:M}=c;if(!p||!M)return null;let L=!1;return M==="uint32"&&(L=!0,_[3]=0,_=Po(s.ee,_,[0,r.paint.get("raster-particle-max-speed")]),v=Gr(s.ee,v,[0,r.paint.get("raster-particle-max-speed")])),{texture:p,textureOffset:[I/(b+2*I),b/(b+2*I)],tileSize:b,scalarData:L,scale:_,offset:v,defines:["RASTER_ARRAY",{uint8:"DATA_FORMAT_UINT8",uint16:"DATA_FORMAT_UINT16",uint32:"DATA_FORMAT_UINT32"}[M]]}}function yc(l){const t=l._nearZ,r=l.projection.farthestPixelDistance(l),c=r-t,p=.2*l.height,_=t+p;return[t,r,(_-p-t)/c,(_-t)/c]}const Vd=new s.am(1,0,0,1),ps=new s.am(0,1,0,1),oh=new s.am(0,0,1,1),ed=new s.am(1,0,1,1),Ud=new s.am(0,1,1,1);function Ra(l,t,r,c,p,_){for(let v=0;v<r.length;v++)if(p){const M=new s.am(c.r*.8,c.g*.8,c.b*.8,1);Wn(l,t,r[v],c,-1,-1,_),Wn(l,t,r[v],c,-1,1,_),Wn(l,t,r[v],c,1,1,_),Wn(l,t,r[v],c,1,-1,_),Wn(l,t,r[v],M,0,0,_)}else Wn(l,t,r[v],c,0,0,_)}function Wn(l,t,r,c,p,_,v){const b=l.context,I=l.transform,M=b.gl,L=I.projection.name==="globe",B=L?["PROJECTION_GLOBE_VIEW"]:[];let F=s.bw(r.projMatrix);if(L&&s.ah(I.zoom)>0){const Ce=s.bg(r.canonical,I),nt=s.ef(Ce);F=s.az(new Float32Array(16),I.globeMatrix,nt),s.az(F,I.projMatrix,F)}const V=s.bz();V[12]+=2*p/(s.q.devicePixelRatio*I.width),V[13]+=2*_/(s.q.devicePixelRatio*I.height),s.az(F,V,F);const $=l.getOrCreateProgram("debug",{defines:B}),H=t.getTileByID(r.key);l.terrain&&l.terrain.setupElevationDraw(H,$);const X=Vt.disabled,Z=_i.disabled,te=l.colorModeForRenderPass(),oe="$debug";b.activeTexture.set(M.TEXTURE0),l.emptyTexture.bind(M.LINEAR,M.CLAMP_TO_EDGE),L?H._makeGlobeTileDebugBuffers(l.context,I):H._makeDebugTileBoundsBuffers(l.context,I.projection);const le=H._tileDebugBuffer||l.debugBuffer,pe=H._tileDebugIndexBuffer||l.debugIndexBuffer,ye=H._tileDebugSegments||l.debugSegments;if($.draw(l,M.LINE_STRIP,X,Z,te,gi.disabled,Hh(F,c.toPremultipliedRenderColor(null)),oe,le,pe,ye,null,null,null,[H._globeTileDebugBorderBuffer]),v){const Ce=H.latestRawTileData,nt=Math.floor((Ce&&Ce.byteLength||0)/1024);let He=r.canonical.toString();r.overscaledZ!==r.canonical.z&&(He+=` => ${r.overscaledZ}`),He+=` ${H.state}`,He+=` ${nt}kb`,(function(at,mt){at.initDebugOverlayCanvas();const ze=at.debugOverlayCanvas,Te=at.context.gl,Ze=at.debugOverlayCanvas.getContext("2d");Ze.clearRect(0,0,ze.width,ze.height),Ze.shadowColor="white",Ze.shadowBlur=2,Ze.lineWidth=1.5,Ze.strokeStyle="white",Ze.textBaseline="top",Ze.font="bold 36px Open Sans, sans-serif",Ze.fillText(mt,5,5),Ze.strokeText(mt,5,5),at.debugOverlayTexture.update(ze),at.debugOverlayTexture.bind(Te.LINEAR,Te.CLAMP_TO_EDGE)})(l,He)}const we=t.getTile(r).tileSize,me=512/Math.min(we,512)*(r.overscaledZ/I.zoom)*.5,_e=H._tileDebugTextBuffer||l.debugBuffer,ge=H._tileDebugTextIndexBuffer||l.quadTriangleIndexBuffer,Be=H._tileDebugTextSegments||l.debugSegments;$.draw(l,M.TRIANGLES,X,Z,ui.alphaBlended,gi.disabled,Hh(F,s.am.transparent.toPremultipliedRenderColor(null),me),oe,_e,ge,Be,null,null,null,[H._globeTileDebugTextBuffer])}function yl(l,t,r,c){Ts(l,0,t+r/2,l.transform.width,r,c)}function hs(l,t,r,c){Ts(l,t-r/2,0,r,l.transform.height,c)}function Ts(l,t,r,c,p,_){const v=l.context,b=v.gl;b.enable(b.SCISSOR_TEST),b.scissor(t*s.q.devicePixelRatio,r*s.q.devicePixelRatio,c*s.q.devicePixelRatio,p*s.q.devicePixelRatio),v.clear({color:_}),b.disable(b.SCISSOR_TEST)}const to=s.ec([{name:"a_pos_3f",components:3,type:"Float32"}]),{members:td}=to;function Ja(l,t,r,c){l.emplaceBack(t,r,c)}class vl{constructor(t){this.vertexArray=new s.eg,this.indices=new s.a_,Ja(this.vertexArray,-1,-1,1),Ja(this.vertexArray,1,-1,1),Ja(this.vertexArray,-1,1,1),Ja(this.vertexArray,1,1,1),Ja(this.vertexArray,-1,-1,-1),Ja(this.vertexArray,1,-1,-1),Ja(this.vertexArray,-1,1,-1),Ja(this.vertexArray,1,1,-1),this.indices.emplaceBack(5,1,3),this.indices.emplaceBack(3,7,5),this.indices.emplaceBack(6,2,0),this.indices.emplaceBack(0,4,6),this.indices.emplaceBack(2,6,7),this.indices.emplaceBack(7,3,2),this.indices.emplaceBack(5,4,0),this.indices.emplaceBack(0,1,5),this.indices.emplaceBack(0,2,3),this.indices.emplaceBack(3,1,0),this.indices.emplaceBack(7,6,4),this.indices.emplaceBack(4,5,7),this.vertexBuffer=t.createVertexBuffer(this.vertexArray,td),this.indexBuffer=t.createIndexBuffer(this.indices),this.segment=s.bd.simpleSegment(0,0,36,12)}}function xl(l,t,r,c,p,_){const v=l.context.gl,b=t.paint.get("sky-atmosphere-color"),I=t.paint.get("sky-atmosphere-halo-color"),M=t.paint.get("sky-atmosphere-sun-intensity"),L=((B,F,V,$,H)=>({u_matrix_3f:B,u_sun_direction:F,u_sun_intensity:V,u_color_tint_r:[$.r,$.g,$.b,$.a],u_color_tint_m:[H.r,H.g,H.b,H.a],u_luminance:5e-5}))(s.ei(s.dJ(),c),p,M,b.toPremultipliedRenderColor(null),I.toPremultipliedRenderColor(null));v.framebufferTexture2D(v.FRAMEBUFFER,v.COLOR_ATTACHMENT0,v.TEXTURE_CUBE_MAP_POSITIVE_X+_,t.skyboxTexture,0),r.draw(l,v.TRIANGLES,Vt.disabled,_i.disabled,ui.unblended,gi.frontCW,L,"skyboxCapture",t.skyboxGeometry.vertexBuffer,t.skyboxGeometry.indexBuffer,t.skyboxGeometry.segment)}const _t=s.ec([{type:"Float32",name:"a_pos",components:3},{type:"Float32",name:"a_uv",components:2}]);class Wt{constructor(t){const r=new s.ej;r.emplaceBack(-1,1,1,0,0),r.emplaceBack(1,1,1,1,0),r.emplaceBack(1,-1,1,1,1),r.emplaceBack(-1,-1,1,0,1);const c=new s.a_;c.emplaceBack(0,1,2),c.emplaceBack(2,3,0),this.vertexBuffer=t.createVertexBuffer(r,_t.members),this.indexBuffer=t.createIndexBuffer(c),this.segments=s.bd.simpleSegment(0,0,4,2)}destroy(){this.vertexBuffer.destroy(),this.indexBuffer.destroy(),this.segments.destroy()}}const jc=s.ec([{type:"Float32",name:"a_pos_3f",components:3},{type:"Float32",name:"a_uv",components:2},{type:"Float32",name:"a_size_scale",components:1},{type:"Float32",name:"a_fade_opacity",components:1}]);class Fr{constructor(){this.starsCount=16e3,this.sizeMultiplier=.15,this.sizeRange=100,this.intensityRange=200}}class Le{constructor(t){this.colorModeAlphaBlendedWriteRGB=new ui([1,fs,1,fs],s.am.transparent,[!0,!0,!0,!1]),this.colorModeWriteAlpha=new ui([1,0,1,0],s.am.transparent,[!1,!1,!1,!0]),this.params=new Fr,this.updateNeeded=!0,t.tp.registerParameter(this.params,["Stars"],"starsCount",{min:100,max:16e3,step:1},(()=>{this.updateNeeded=!0})),t.tp.registerParameter(this.params,["Stars"],"sizeMultiplier",{min:.01,max:2,step:.01}),t.tp.registerParameter(this.params,["Stars"],"sizeRange",{min:0,max:200,step:1},(()=>{this.updateNeeded=!0})),t.tp.registerParameter(this.params,["Stars"],"intensityRange",{min:0,max:200,step:1},(()=>{this.updateNeeded=!0}))}update(t){const r=t.context;if(!this.atmosphereBuffer||this.updateNeeded){this.updateNeeded=!1,this.atmosphereBuffer=new Wt(r);const c=this.params.sizeRange,p=this.params.intensityRange,_=(function(L){const B=s.el(30),F=[];for(let V=0;V<L;++V){const $=2*Math.PI*B(),H=Math.acos(1-2*B())-.5*Math.PI;F.push(s.d2(Math.cos(H)*Math.cos($),Math.cos(H)*Math.sin($),Math.sin(H)))}return F})(this.params.starsCount),v=s.el(300),b=new s.ek,I=new s.a_;let M=0;for(let L=0;L<_.length;++L){const B=s.c1([],_[L],200),F=Math.max(0,1+.01*c*(1*v()-.5)),V=Math.max(0,1+.01*p*(1*v()-.5));b.emplaceBack(B[0],B[1],B[2],-1,-1,F,V),b.emplaceBack(B[0],B[1],B[2],1,-1,F,V),b.emplaceBack(B[0],B[1],B[2],1,1,F,V),b.emplaceBack(B[0],B[1],B[2],-1,1,F,V),I.emplaceBack(M+0,M+1,M+2),I.emplaceBack(M+0,M+2,M+3),M+=4}this.starsVx=r.createVertexBuffer(b,jc.members),this.starsIdx=r.createIndexBuffer(I),this.starsSegments=s.bd.simpleSegment(0,0,b.length,I.length)}}destroy(){this.atmosphereBuffer&&this.atmosphereBuffer.destroy(),this.starsVx&&this.starsVx.destroy(),this.starsIdx&&this.starsIdx.destroy()}drawAtmosphereGlow(t,r){const c=t.context,p=c.gl,_=t.transform,v=new Vt(p.LEQUAL,Vt.ReadOnly,[0,1]),b=s.ah(_.zoom),I=t.style.getLut(r.scope),M=r.properties.get("color-use-theme")==="none",L=r.properties.get("color").toNonPremultipliedRenderColor(M?null:I).toArray01(),B=r.properties.get("high-color-use-theme")==="none",F=r.properties.get("high-color").toNonPremultipliedRenderColor(B?null:I).toArray01(),V=r.properties.get("space-color-use-theme")==="none",$=r.properties.get("space-color").toNonPremultipliedRenderColor(V?null:I).toArray01(),H=5e-4,X=s.em(r.properties.get("horizon-blend"),0,1,H,.25),Z=s.dy(t,c,_)&&X===H?_.worldSize/(2*Math.PI*1.025)-1:_.globeRadius,te=t.frameCounter/1e3%1,oe=s.ae(_.globeCenterInViewSpace),le=Math.sqrt(Math.pow(oe,2)-Math.pow(Z,2)),pe=Math.acos(le/oe),ye=we=>{const me=_.projection.name==="globe"?["PROJECTION_GLOBE_VIEW","FOG"]:["FOG"];we&&me.push("ALPHA_PASS");const _e=t.getOrCreateProgram("globeAtmosphere",{defines:me}),ge=((Ce,nt,He,at,mt,ze,Te,Ze,Ue,dt,ft,xt)=>({u_frustum_tl:Ce,u_frustum_tr:nt,u_frustum_br:He,u_frustum_bl:at,u_horizon:mt,u_transition:ze,u_fadeout_range:Te,u_color:Ze,u_high_color:Ue,u_space_color:dt,u_temporal_offset:ft,u_horizon_angle:xt}))(_.frustumCorners.TL,_.frustumCorners.TR,_.frustumCorners.BR,_.frustumCorners.BL,_.frustumCorners.horizon,b,X,L,F,$,te,pe);t.uploadCommonUniforms(c,_e);const Be=this.atmosphereBuffer;Be&&_e.draw(t,p.TRIANGLES,v,_i.disabled,we?this.colorModeWriteAlpha:this.colorModeAlphaBlendedWriteRGB,gi.backCW,ge,we?"atmosphere_glow_alpha":"atmosphere_glow",Be.vertexBuffer,Be.indexBuffer,Be.segments)};ye(!1),ye(!0)}drawStars(t,r){const c=s.ay(r.properties.get("star-intensity"),0,1);if(c===0)return;const p=t.context,_=p.gl,v=t.transform,b=t.getOrCreateProgram("stars"),I=s.c3([]);s.c5(I,I,-v._pitch),s.c4(I,I,-v.angle),s.c5(I,I,s.al(v._center.lat)),s.en(I,I,-s.al(v._center.lng));const M=s.c8(new Float32Array(16),I),L=s.az([],v.starsProjMatrix,M),B=s.ei([],M),F=s.eo([],B),V=[0,1,0];s.dL(V,V,F),s.c1(V,V,this.params.sizeMultiplier);const $=[1,0,0];s.dL($,$,F),s.c1($,$,this.params.sizeMultiplier);const H=(X=V,Z=$,te=c,{u_matrix:Float32Array.from(L),u_up:X,u_right:Z,u_intensity_multiplier:te});var X,Z,te;t.uploadCommonUniforms(p,b),this.starsVx&&this.starsIdx&&b.draw(t,_.TRIANGLES,Vt.disabled,_i.disabled,this.colorModeAlphaBlendedWriteRGB,gi.disabled,H,"atmosphere_stars",this.starsVx,this.starsIdx,this.starsSegments)}}class Ma{constructor(){this.visibleTiles=[]}updateBorders(t,r){const c=[],p=[],_=t._getRenderableCoordinates(!1,!0);for(const I of _){const M=t.getTile(I);if(!M.hasData())continue;const L=M.getBucket(r);L&&(L.isEmpty()||(c.push(I.key),p.push({bucket:L,tileID:I.canonical})))}let v=c.length!==this.visibleTiles.length;if(!v){c.sort();for(let I=0;I<c.length;I++)if(c[I]!==this.visibleTiles[I]){v=!0;break}}if(!v)return;const b=new Set;this.visibleTiles=c,p.sort(((I,M)=>I.tileID.z-M.tileID.z||I.tileID.x-M.tileID.x||I.tileID.y-M.tileID.y));for(const I of p){const M=new Array,L=new Array,B=I.bucket;for(const F of B.featuresOnBorder)b.has(F.featureId)?L.push(F.footprintIndex):(b.add(F.featureId),M.push(F.footprintIndex));B.updateFootprintHiddenFlags(M,s.ep,!1),B.updateFootprintHiddenFlags(L,s.ep,!0)}}}function vc(l,t){const r=[...l],c=t.cameraWorldSizeForFog/t.worldSize,p=s.bx([]);return s.cP(p,p,[c,c,1]),s.az(r,p,r),s.az(r,t.worldToFogMatrix,r),r}function Cu(l,t,r,c,p){const _=r.material,v=c.context,{baseColorTexture:b,metallicRoughnessTexture:I}=_.pbrMetallicRoughness,{normalTexture:M,occlusionTexture:L,emissionTexture:B}=_;function F($,H,X){if($&&(l.push(H),v.activeTexture.set(v.gl.TEXTURE0+X),$.gfxTexture)){const{minFilter:Z,magFilter:te,wrapS:oe,wrapT:le}=$.sampler;$.gfxTexture.bindExtraParam(Z,te,oe,le)}}F(b,"HAS_TEXTURE_u_baseColorTexture",Co.BaseColor),F(I,"HAS_TEXTURE_u_metallicRoughnessTexture",Co.MetallicRoughness),F(M,"HAS_TEXTURE_u_normalTexture",Co.Normal),F(L,"HAS_TEXTURE_u_occlusionTexture",Co.Occlusion),F(B,"HAS_TEXTURE_u_emissionTexture",Co.Emission),p&&(p.texture||(p.texture=new s.et(c.context,p.image,[p.image.height,p.image.height,p.image.height],v.gl.RGBA8)),v.activeTexture.set(v.gl.TEXTURE0+Co.LUT),p.texture&&p.texture.bind(v.gl.LINEAR,v.gl.CLAMP_TO_EDGE),l.push("APPLY_LUT_ON_GPU")),r.texcoordBuffer&&(l.push("HAS_ATTRIBUTE_a_uv_2f"),t.push(r.texcoordBuffer)),r.colorBuffer&&(l.push(r.colorBuffer.itemSize===12?"HAS_ATTRIBUTE_a_color_3f":"HAS_ATTRIBUTE_a_color_4f"),t.push(r.colorBuffer)),r.normalBuffer&&(l.push("HAS_ATTRIBUTE_a_normal_3f"),t.push(r.normalBuffer)),r.pbrBuffer&&(l.push("HAS_ATTRIBUTE_a_pbr"),l.push("HAS_ATTRIBUTE_a_heightBasedEmissiveStrength"),t.push(r.pbrBuffer)),_.alphaMode!=="OPAQUE"&&_.alphaMode!=="MASK"||l.push("UNPREMULT_TEXTURE_IN_SHADER"),_.defined||l.push("DIFFUSE_SHADED");const V=c.shadowRenderer;V&&(l.push("RENDER_SHADOWS","DEPTH_TEXTURE"),V.useNormalOffset&&l.push("NORMAL_OFFSET"))}function Gc(l,t,r,c,p,_){const v=r.paint.get("model-opacity").constantOr(1),b=t.context,I=new Vt(t.context.gl.LEQUAL,Vt.ReadWrite,t.depthRangeFor3D),M=t.transform,L=l.mesh,B=L.material,F=B.pbrMetallicRoughness,V=t.style.fog;let $;$=t.transform.projection.zAxisUnit==="pixels"?[...l.nodeModelMatrix]:s.az([],c.zScaleMatrix,l.nodeModelMatrix),s.az($,c.negCameraPosMatrix,$);const H=s.bi([],$);s.ea(H,H);const X=r.paint.get("model-color-use-theme").constantOr("default")==="none",Z=r.paint.get("model-emissive-strength").constantOr(0),te=bu(new Float32Array(l.worldViewProjection),new Float32Array($),new Float32Array(H),null,t,v,F.baseColorFactor,B.emissiveFactor,F.metallicFactor,F.roughnessFactor,B,Z,r),oe={defines:[]},le=[],pe=t.shadowRenderer;pe&&(pe.useNormalOffset=!1),Cu(oe.defines,le,L,t,X?null:r.lut);let ye=null;if(V){const _e=vc(l.nodeModelMatrix,t.transform);if(ye=new Float32Array(_e),M.projection.name!=="globe"){const ge=L.aabb.min,Be=L.aabb.max,[Ce,nt]=V.getOpacityForBounds(_e,ge[0],ge[1],Be[0],Be[1]);oe.overrideFog=Ce>=lt||nt>=lt}}const we=ta(t,r.paint.get("model-cutoff-fade-range"));we.shouldRenderCutoff&&oe.defines.push("RENDER_CUTOFF");const me=t.getOrCreateProgram("model",oe);t.uploadCommonUniforms(b,me,null,ye,we),t.renderPass!=="shadow"&&pe&&pe.setupShadowsFromMatrix(l.nodeModelMatrix,me),me.draw(t,b.gl.TRIANGLES,I,p,_,L.material.doubleSided?gi.disabled:gi.backCCW,te,r.id,L.vertexBuffer,L.indexBuffer,L.segments,r.paint,t.transform.zoom,void 0,le)}function jd(l,t,r,c,p,_,v){let b;b=l.projection.name==="globe"?s.er(r,l):[...r],s.az(b,b,t.matrix);const I=s.az([],c,b);if(t.meshes)for(const M of t.meshes){if(M.material.alphaMode!=="BLEND"){v.push({mesh:M,depth:0,modelIndex:p,worldViewProjection:I,nodeModelMatrix:b});continue}const L=s.ad([],M.centroid,I);!l.isOrthographic&&L[2]<=0||_.push({mesh:M,depth:L[2],modelIndex:p,worldViewProjection:I,nodeModelMatrix:b})}if(t.children)for(const M of t.children)jd(l,M,r,c,p,_,v)}function id(l,t,r,c){const p=r.shadowRenderer;if(!p)return;const _=p.getShadowPassDepthMode(),v=p.getShadowPassColorMode(),b=p.calculateShadowPassMatrixFromMatrix(t),I=Wh(b);r.getOrCreateProgram("modelDepth",{defines:r._shadowMapDebug?[]:["DEPTH_TEXTURE"]}).draw(r,r.context.gl.TRIANGLES,_,_i.disabled,v,gi.backCCW,I,c.id,l.vertexBuffer,l.indexBuffer,l.segments,c.paint,r.transform.zoom,void 0,void 0)}function Pu(l,t,r){const c=t.updateZoomBasedPaintProperties(),p=(function(_,v,b){let I,M,L,B=_.terrain?_.terrain.exaggeration():0;if(_.terrain&&B>0){const F=_.terrain,V=F.findDEMTileFor(b);V&&V.dem?I=s.eu.create(F,b,V):B=0}if(B===0&&(v.terrainElevationMin=0,v.terrainElevationMax=0),B===v.validForExaggeration&&(B===0||I&&I._demTile&&I._demTile.tileID===v.validForDEMTile.id&&I._dem._timestamp===v.validForDEMTile.timestamp))return!1;for(const F in v.instancesPerModel){const V=v.instancesPerModel[F];for(let $=0;$<V.instancedDataArray.length;++$){const H=(I?B*I.getElevationAt(0|V.instancedDataArray.float32[16*$],0|V.instancedDataArray.float32[16*$+1],!0,!0):0)+V.instancesEvaluatedElevation[$];V.instancedDataArray.float32[16*$+6]=H,M=M?Math.min(v.terrainElevationMin,H):H,L=L?Math.max(v.terrainElevationMax,H):H}}return v.terrainElevationMin=M||0,v.terrainElevationMax=L||0,v.validForExaggeration=B,v.validForDEMTile=I&&I._demTile?{id:I._demTile.tileID,timestamp:I._dem._timestamp}:{id:void 0,timestamp:0},!0})(l,t,r);(c||p)&&(t.uploaded=!1,t.upload(l.context))}const wl={shadowUniformsInitialized:!1,useSingleShadowCascade:!1,tileMatrix:new Float64Array(16),shadowTileMatrix:new Float32Array(16),aabb:new s.d6([0,0,0],[s.aj,s.aj,0])};function Ap(l,t){const r=1<<l.canonical.z,c=t.getFreeCameraOptions().position,p=t.elevation,_=l.canonical.x/r,v=(l.canonical.x+1)/r,b=l.canonical.y/r,I=(l.canonical.y+1)/r;let M=t._centerAltitude;if(p){const V=p.getMinMaxForTile(l);V&&V.max>M&&(M=V.max)}const L=s.ay(c.x,_,v)-c.x,B=s.ay(c.y,b,I)-c.y,F=s.cb(M,t.center.lat)-c.z;return t._zoomFromMercatorZ(Math.sqrt(L*L+B*B+F*F))}function Gd(l,t,r,c,p,_,v){const b=l.context,I=l.renderPass==="shadow",M=l.shadowRenderer,L=I&&M?M.getShadowPassDepthMode():new Vt(b.gl.LEQUAL,Vt.ReadWrite,l.depthRangeFor3D),B=l.isTileAffectedByFog(_);if(r.meshes)for(const F of r.meshes){const V=["MODEL_POSITION_ON_GPU"],$=[];let H,X,Z;c.instancedDataArray.length>20&&V.push("INSTANCED_ARRAYS");const te=ta(l,t.paint.get("model-cutoff-fade-range"));if(te.shouldRenderCutoff&&V.push("RENDER_CUTOFF"),I&&M)H=l.getOrCreateProgram("modelDepth",{defines:V}),X=Wh(v.shadowTileMatrix,v.shadowTileMatrix,Float32Array.from(r.matrix)),Z=M.getShadowPassColorMode();else{Cu(V,$,F,l,t.paint.get("model-color-use-theme").constantOr("default")==="none"?null:t.lut),H=l.getOrCreateProgram("model",{defines:V,overrideFog:B});const le=F.material,pe=le.pbrMetallicRoughness,ye=t.paint.get("model-opacity").constantOr(1),we=t.paint.get("model-emissive-strength").constantOr(0);X=bu(_.expandedProjMatrix,Float32Array.from(r.matrix),new Float32Array(16),null,l,ye,pe.baseColorFactor,le.emissiveFactor,pe.metallicFactor,pe.roughnessFactor,le,we,t,p),M&&(v.shadowUniformsInitialized?H.setShadowUniformValues(b,M.getShadowUniformValues()):(M.setupShadows(_.toUnwrapped(),H,"model-tile"),v.shadowUniformsInitialized=!0)),Z=te.shouldRenderCutoff||ye<1||le.alphaMode!=="OPAQUE"?ui.alphaBlended:ui.unblended}l.uploadCommonUniforms(b,H,_.toUnwrapped(),null,te);const oe=F.material.doubleSided?gi.disabled:gi.backCCW;if(c.instancedDataArray.length>20)$.push(c.instancedDataBuffer),H.draw(l,b.gl.TRIANGLES,L,_i.disabled,Z,oe,X,t.id,F.vertexBuffer,F.indexBuffer,F.segments,t.paint,l.transform.zoom,void 0,$,c.instancedDataArray.length);else{const le=I?"u_instance":"u_normal_matrix";for(let pe=0;pe<c.instancedDataArray.length;++pe)X[le]=new Float32Array(c.instancedDataArray.arrayBuffer,64*pe,16),H.draw(l,b.gl.TRIANGLES,L,_i.disabled,Z,oe,X,t.id,F.vertexBuffer,F.indexBuffer,F.segments,t.paint,l.transform.zoom,void 0,$)}}if(r.children)for(const F of r.children)Gd(l,t,F,c,p,_,v)}const nd=[1,-1,1];function Hd(l,t,r,c){if(!r.modelManager)return!0;const p=r.modelManager;if(!r.shadowRenderer)return!0;const _=r.shadowRenderer,v=t.aabb;let b=!0,I=l.maxHeight;if(I===0){let L=0;for(const B in l.instancesPerModel){const F=p.getModel(B,c);F?L=Math.max(L,Math.max(Math.max(F.aabb.max[0],F.aabb.max[1]),F.aabb.max[2])):b=!1}I=l.maxScale*L*1.41+l.maxVerticalOffset,b&&(l.maxHeight=I)}v.max[2]=I,v.min[2]+=l.terrainElevationMin,v.max[2]+=l.terrainElevationMax,s.ad(v.min,v.min,t.tileMatrix),s.ad(v.max,v.max,t.tileMatrix);const M=v.intersects(_.getCurrentCascadeFrustum());return r.currentShadowCascade===0&&(l.isInsideFirstShadowMapFrustum=M===2),M===0}function ah(l,t){const r=l.uniformValues.u_cutoff_params[0],c=l.uniformValues.u_cutoff_params[1],p=l.uniformValues.u_cutoff_params[2],_=l.uniformValues.u_cutoff_params[3];return c===r||_===p?1:s.ay(((t-r)/(c-r)-p)/(_-p),0,1)}function qf(l,t,r,c){if(t.pitch<20)return 1;const p=t.getWorldToCameraMatrix();s.az(p,p,l);const _=s.bR(r.min[0],r.min[1],r.min[2],1);let v=s.aA(s.ev(),_,p),b=v,I=v;_[1]=r.max[1],v=s.aA(s.ev(),_,p),b=v[1]<b[1]?v:b,I=v[1]>I[1]?v:I,_[0]=r.max[0],v=s.aA(s.ev(),_,p),b=v[1]<b[1]?v:b,I=v[1]>I[1]?v:I,_[1]=r.min[1],v=s.aA(s.ev(),_,p),b=v[1]<b[1]?v:b,I=v[1]>I[1]?v:I;const M=s.ay(c[0],0,1),L=100*t.pixelsPerMeter*s.ay(c[1],0,1),B=s.ay(c[2],0,1),F=s.ew(s.ev(),b,I,M),V=Math.tan(.5*t.fovX),$=-F[2]*V;if(L===0)return F[1]<-Math.abs($)?B:1;const H=(-Math.abs($)-F[1])/L,X=(te,oe,le)=>(1-le)*te+le*oe,Z=s.ay(X(1,B,H),B,1);return X(1,Z,s.ay((t.pitch-20)/20,0,1))}class Ru{}class Hc{constructor(){this._storage=new Map}getLinesFromTrianglesBuffer(t,r,c){{const B=this._storage.get(r.id);if(B)return B.lastUsedFrameIdx=t,B.buf}const p=c.gl,_=p.getBufferParameter(p.ELEMENT_ARRAY_BUFFER,p.BUFFER_SIZE),v=new ArrayBuffer(_),b=new Int16Array(v);p.getBufferSubData(p.ELEMENT_ARRAY_BUFFER,0,new Int16Array(v));const I=new s.ey;for(let B=0;B<_/2;B+=3){const F=b[B],V=b[B+1],$=b[B+2];I.emplaceBack(F,V),I.emplaceBack(V,$),I.emplaceBack($,F)}const M=c.bindVertexArrayOES.current,L=new Ru;return L.buf=new _c(c,I),L.lastUsedFrameIdx=t,this._storage.set(r.id,L),c.bindVertexArrayOES.set(M),L.buf}update(t){for(const[r,c]of this._storage)t-c.lastUsedFrameIdx>30&&(c.buf.destroy(),this._storage.delete(r))}destroy(){for(const[t,r]of this._storage)r.buf.destroy(),this._storage.delete(t)}}class Mu{constructor(t){this.occluderSize=30,this.depthOffset=-1e-4,t.registerParameter(this,["Occlusion"],"occluderSize",{min:1,max:100,step:1}),t.registerParameter(this,["Occlusion"],"depthOffset",{min:-.05,max:0,step:1e-5})}}const qd=s.ec([{type:"Float32",name:"a_pos_3f",components:3},{type:"Float32",name:"a_uv",components:2},{type:"Float32",name:"a_rainParticleData",components:4}]);class Cp{registerParameter(){}registerButton(){}registerBinding(){}refreshUI(){}}class ho{constructor(t,r){this.revealStart=11,this.revealRange=2,t.registerParameter(this,[...r,"Reveal"],"revealStart",{min:0,max:17,step:.05}),t.registerParameter(this,[...r,"Reveal"],"revealRange",{min:.1,max:5.1,step:.05})}}const Pp=s.ec([{type:"Float32",name:"a_pos_2f",components:2}]);class lh{destroy(){this.vignetteVx&&this.vignetteVx.destroy(),this.vignetteIdx&&this.vignetteIdx.destroy()}draw(t,r){const c=t.getOrCreateProgram("vignette");if(!this.vignetteVx||!this.vignetteIdx){const v=new s.ez,b=new s.a_;v.emplaceBack(-1,-1),v.emplaceBack(1,-1),v.emplaceBack(1,1),v.emplaceBack(-1,1),b.emplaceBack(0,1,2),b.emplaceBack(0,2,3),this.vignetteVx=t.context.createVertexBuffer(v,Pp.members),this.vignetteIdx=t.context.createIndexBuffer(b)}const p=s.bd.simpleSegment(0,0,4,6);if(this.vignetteVx&&this.vignetteIdx){t.uploadCommonUniforms(t.context,c);const v={u_vignetteShape:(_={vignetteShape:[r.start,r.range,Math.pow(10,r.fadePower)],vignetteColor:[r.color.r,r.color.g,r.color.b,r.color.a*r.strength]}).vignetteShape,u_vignetteColor:_.vignetteColor};c.draw(t,t.context.gl.TRIANGLES,Vt.disabled,_i.disabled,ui.alphaBlended,gi.disabled,v,"vignette",this.vignetteVx,this.vignetteIdx,p)}var _}}class _r{constructor(){this._accumulatedOffsetX=0,this._accumulatedOffsetY=0,this._accumulatedElevation=0}update(t,r){const c=t.getFreeCameraOptions().position,p=c.toAltitude(),_=c.toLngLat(),v=s.al(_.lng),b=s.al(_.lat),I=t.pixelsPerMeter/r,M=v*s.eB,L=s.eB*Math.log(Math.tan(Math.PI/4+b/2));if(this._offsetXPrev===void 0)this._offsetXPrev=0,this._offsetYPrev=0,this._elevationPrev=0,this._accumulatedOffsetX=0,this._accumulatedOffsetY=0,this._accumulatedElevation=0;else{const B=-this._offsetYPrev+L,F=-this._elevationPrev+p;this._accumulatedOffsetX+=(-this._offsetXPrev+M)*I,this._accumulatedOffsetY+=B*I,this._accumulatedElevation+=F*I,this._offsetXPrev=M,this._offsetYPrev=L,this._elevationPrev=p}}getPosition(){return[this._accumulatedOffsetX,this._accumulatedOffsetY,this._accumulatedElevation]}}function hn(l,t){return[-(l[0]-Math.floor(l[0]/t)*t),-(l[1]-Math.floor(l[1]/t)*t),-(l[2]-Math.floor(l[2]/t)*t)]}function $d(l){const t=s.el(1323123451230),r=[];for(let c=0;c<l;++c){const p=2*t()-1,_=2*t()-1,v=2*t()-1;r.push(s.d2(p,_,v))}return r}function Mo(l,t,r,c,p){const _=s.ay((p-r)/(c-r),0,1);return(1-_)*l+_*t}class ch{constructor(t){this._movement=new _r,this._accumulatedTimeFromStart=0,this._prevTime=Date.now()/1e3,this._vignette=new lh,this._ppmScaleFactor=t}destroy(){this.particlesVx&&this.particlesVx.destroy(),this.particlesIdx&&this.particlesIdx.destroy(),this._vignette&&this._vignette.destroy()}updateOnRender(t,r){const c=t.transform;this._movement.update(c,this._ppmScaleFactor);const p=c.starsProjMatrix,_=s.c3([]);s.c5(_,_,s.al(90)-c._pitch),s.c4(_,_,-c.angle);const v=s.c8(new Float32Array(16),_),b=s.eA(1,0,0,0,0,0,1,0,0,-1,0,0,0,0,0,1),I=s.ea([],b),M=s.az([],I,v),L=Date.now()/1e3;return this._accumulatedTimeFromStart+=(L-this._prevTime)*r,this._prevTime=L,{projectionMatrix:p,modelviewMatrix:M}}}class Du extends ch{constructor(t){super(4.25),this._params={overrideStyleParameters:!1,intensity:.5,timeFactor:1,velocityConeAperture:0,velocity:300,boxSize:2500,dropletSizeX:1,dropletSizeYScale:10,distortionStrength:70,screenThinning:{intensity:.57,start:.46,range:1.17,fadePower:.17,affectedRatio:1,particleOffset:-.2},color:{r:.66,g:.68,b:.74,a:.7},direction:{x:-50,y:-35},shapeDirPower:2,shapeNormalPower:1},this._revealParams=new ho(t.tp,["Precipitation","Rain"]),this._vignetteParams={strength:1,start:.7,range:1,fadePower:.4,color:{r:.27,g:.27,b:.27,a:1}},this.particlesCount=16e3}update(t){const r=t.context;if(!this.particlesVx){const c=$d(this.particlesCount),p=new s.eC,_=new s.a_;let v=0;const b=s.el(1323123451230);for(let I=0;I<c.length;++I){const M=c[I],L=[2*b()-1,b(),b(),b()];p.emplaceBack(M[0],M[1],M[2],-1,-1,...L),p.emplaceBack(M[0],M[1],M[2],1,-1,...L),p.emplaceBack(M[0],M[1],M[2],1,1,...L),p.emplaceBack(M[0],M[1],M[2],-1,1,...L),_.emplaceBack(v+0,v+1,v+2),_.emplaceBack(v+0,v+2,v+3),v+=4}this.particlesVx=r.createVertexBuffer(p,qd.members),this.particlesIdx=r.createIndexBuffer(_)}}draw(t){if(!this._params.overrideStyleParameters&&!t.style.rain)return;const r=this._params.overrideStyleParameters?this._revealParams:{revealStart:0,revealRange:.01},c=t.transform.zoom;if(r.revealStart>c)return;const p=Mo(0,1,r.revealStart,r.revealStart+r.revealRange,c);if(!this.particlesVx||!this.particlesIdx)return;const _=structuredClone(this._params);let v=[-_.direction.x,_.direction.y,-100];s.au(v,v);const b=structuredClone(this._vignetteParams);b.strength*=p,_.overrideStyleParameters||(_.intensity=t.style.rain.state.density,_.timeFactor=t.style.rain.state.intensity,_.color=structuredClone(t.style.rain.state.color),v=structuredClone(t.style.rain.state.direction),_.screenThinning.intensity=t.style.rain.state.centerThinning,_.dropletSizeX=t.style.rain.state.dropletSize[0],_.dropletSizeYScale=t.style.rain.state.dropletSize[1]/t.style.rain.state.dropletSize[0],_.distortionStrength=100*t.style.rain.state.distortionStrength,b.strength=1,b.color=structuredClone(t.style.rain.state.vignetteColor));const I=this.updateOnRender(t,_.timeFactor),M=t.context,L=M.gl,B=t.transform;this.screenTexture&&this.screenTexture.size[0]===t.width&&this.screenTexture.size[1]===t.height||(this.screenTexture=new s.T(M,{width:t.width,height:t.height,data:null},L.RGBA8)),_.distortionStrength>0&&(M.activeTexture.set(L.TEXTURE0),this.screenTexture.bind(L.LINEAR,L.CLAMP_TO_EDGE),L.copyTexSubImage2D(L.TEXTURE_2D,0,0,0,0,0,t.width,t.height));const F=t.getOrCreateProgram("rainParticle");t.uploadCommonUniforms(M,F),M.activeTexture.set(L.TEXTURE0),this.screenTexture.bind(L.LINEAR,L.CLAMP_TO_EDGE);const V=[_.color.r,_.color.g,_.color.b,_.color.a],$=(H,X)=>{const Z=hn(this._movement.getPosition(),H),te=_.dropletSizeX,oe=_.dropletSizeX*_.dropletSizeYScale,le=t.width/2,pe=t.height/2,ye=Mo(0,_.screenThinning.start,0,1,_.screenThinning.intensity),we=Mo(.001,_.screenThinning.range,0,1,_.screenThinning.intensity),me=Mo(0,_.screenThinning.particleOffset,0,1,_.screenThinning.intensity),_e=(ge={modelview:I.modelviewMatrix,projection:I.projectionMatrix,time:this._accumulatedTimeFromStart,camPos:Z,velocityConeAperture:_.velocityConeAperture,velocity:_.velocity,boxSize:H,rainDropletSize:[te,oe],distortionStrength:_.distortionStrength,rainDirection:v,color:V,screenSize:[B.width,B.height],thinningCenterPos:[le,pe],thinningShape:[ye,we,Math.pow(10,_.screenThinning.fadePower)],thinningAffectedRatio:_.screenThinning.affectedRatio,thinningParticleOffset:me,shapeDirectionalPower:_.shapeDirPower,shapeNormalPower:_.shapeNormalPower,mode:X?0:1},{u_modelview:Float32Array.from(ge.modelview),u_projection:Float32Array.from(ge.projection),u_time:ge.time,u_cam_pos:ge.camPos,u_texScreen:0,u_velocityConeAperture:ge.velocityConeAperture,u_velocity:ge.velocity,u_boxSize:ge.boxSize,u_rainDropletSize:ge.rainDropletSize,u_distortionStrength:ge.distortionStrength,u_rainDirection:ge.rainDirection,u_color:ge.color,u_screenSize:ge.screenSize,u_thinningCenterPos:ge.thinningCenterPos,u_thinningShape:ge.thinningShape,u_thinningAffectedRatio:ge.thinningAffectedRatio,u_thinningParticleOffset:ge.thinningParticleOffset,u_shapeDirectionalPower:ge.shapeDirectionalPower,u_shapeNormalPower:ge.shapeNormalPower,u_mode:ge.mode});var ge;const Be=Math.round(_.intensity*this.particlesCount),Ce=s.bd.simpleSegment(0,0,4*Be,2*Be);F.draw(t,L.TRIANGLES,Vt.disabled,_i.disabled,ui.alphaBlended,gi.disabled,_e,"rain_particles",this.particlesVx,this.particlesIdx,Ce)};_.distortionStrength>0&&$(_.boxSize,!0),$(_.boxSize,!1),this._vignette.draw(t,b)}}const Lu=s.ec([{type:"Float32",name:"a_pos_3f",components:3},{type:"Float32",name:"a_uv",components:2},{type:"Float32",name:"a_snowParticleData",components:4},{type:"Float32",name:"a_snowParticleDataHorizontalOscillation",components:2}]);class $f extends ch{constructor(t){super(2.25),this._params={overrideStyleParameters:!1,intensity:.85,timeFactor:.75,velocityConeAperture:70,velocity:40,horizontalOscillationRadius:4,horizontalOscillationRate:1.5,boxSize:2e3,billboardSize:2,shapeFadeStart:.27,shapeFadePower:.21,screenThinning:{intensity:.4,start:.15,range:1.4,fadePower:.24,affectedRatio:1,particleOffset:-.2},color:{r:1,g:1,b:1,a:1},direction:{x:-50,y:-35}},this._revealParams=new ho(t.tp,["Precipitation","Snow"]),this._vignetteParams={strength:.3,start:.78,range:.46,fadePower:.2,color:{r:1,g:1,b:1,a:1}},this.particlesCount=16e3}update(t){const r=t.context;if(!this.particlesVx){const c=$d(this.particlesCount),p=new s.eD,_=new s.a_;let v=0;const b=s.el(1323123451230);for(let I=0;I<c.length;++I){const M=c[I],L=b(),B=b(),F=b(),V=[I/c.length,L,B,F],$=[b(),b()];p.emplaceBack(M[0],M[1],M[2],-1,-1,...V,...$),p.emplaceBack(M[0],M[1],M[2],1,-1,...V,...$),p.emplaceBack(M[0],M[1],M[2],1,1,...V,...$),p.emplaceBack(M[0],M[1],M[2],-1,1,...V,...$),_.emplaceBack(v+0,v+1,v+2),_.emplaceBack(v+0,v+2,v+3),v+=4}this.particlesVx=r.createVertexBuffer(p,Lu.members),this.particlesIdx=r.createIndexBuffer(_)}}draw(t){if(!this._params.overrideStyleParameters&&!t.style.snow)return;const r=structuredClone(this._params);let c=[-r.direction.x,r.direction.y,-100];s.au(c,c);const p=structuredClone(this._vignetteParams),_=r.overrideStyleParameters?this._revealParams:{revealStart:0,revealRange:.01},v=t.transform.zoom;if(_.revealStart>v)return;const b=Mo(0,1,_.revealStart,_.revealStart+_.revealRange,v);p.strength*=b,r.overrideStyleParameters||(r.intensity=t.style.snow.state.density,r.timeFactor=t.style.snow.state.intensity,r.color=structuredClone(t.style.snow.state.color),c=structuredClone(t.style.snow.state.direction),r.screenThinning.intensity=t.style.snow.state.centerThinning,r.billboardSize=2.79*t.style.snow.state.flakeSize,p.strength=1,p.color=structuredClone(t.style.snow.state.vignetteColor));const I=this.updateOnRender(t,r.timeFactor);if(!this.particlesVx||!this.particlesIdx)return;const M=t.context,L=M.gl,B=t.transform,F=t.getOrCreateProgram("snowParticle");t.uploadCommonUniforms(M,F),((V,$,H)=>{const X=hn(this._movement.getPosition(),V),Z=B.width/2,te=B.height/2,oe=Mo(0,H.screenThinning.start,0,1,H.screenThinning.intensity),le=Mo(.001,H.screenThinning.range,0,1,H.screenThinning.intensity),pe=Mo(0,H.screenThinning.particleOffset,0,1,H.screenThinning.intensity),ye=(we={modelview:I.modelviewMatrix,projection:I.projectionMatrix,time:this._accumulatedTimeFromStart,camPos:X,velocityConeAperture:H.velocityConeAperture,velocity:H.velocity,horizontalOscillationRadius:H.horizontalOscillationRadius,horizontalOscillationRate:H.horizontalOscillationRate,boxSize:V,billboardSize:1*H.billboardSize,simpleShapeParameters:[H.shapeFadeStart,H.shapeFadePower],screenSize:[B.width,B.height],thinningCenterPos:[Z,te],thinningShape:[oe,le,Math.pow(10,H.screenThinning.fadePower)],thinningAffectedRatio:H.screenThinning.affectedRatio,thinningParticleOffset:pe,color:[H.color.r,H.color.g,H.color.b,H.color.a],direction:c},{u_modelview:Float32Array.from(we.modelview),u_projection:Float32Array.from(we.projection),u_time:we.time,u_cam_pos:we.camPos,u_velocityConeAperture:we.velocityConeAperture,u_velocity:we.velocity,u_horizontalOscillationRadius:we.horizontalOscillationRadius,u_horizontalOscillationRate:we.horizontalOscillationRate,u_boxSize:we.boxSize,u_billboardSize:we.billboardSize,u_simpleShapeParameters:we.simpleShapeParameters,u_screenSize:we.screenSize,u_thinningCenterPos:we.thinningCenterPos,u_thinningShape:we.thinningShape,u_thinningAffectedRatio:we.thinningAffectedRatio,u_thinningParticleOffset:we.thinningParticleOffset,u_particleColor:we.color,u_direction:we.direction});var we;const me=Math.round(H.intensity*this.particlesCount),_e=s.bd.simpleSegment(0,0,4*me,2*me);this.particlesVx&&this.particlesIdx&&F.draw(t,L.TRIANGLES,Vt.disabled,_i.disabled,ui.alphaBlended,gi.disabled,ye,"snow_particles",this.particlesVx,this.particlesIdx,_e)})(r.boxSize,0,r),this._vignette.draw(t,p)}}const Wd={symbol:function(l,t,r,c,p){if(l.renderPass!=="translucent")return;const _=_i.disabled,v=l.colorModeForRenderPass(),b=r.layout.get("text-variable-anchor"),I=r.layout.get("text-size-scale-range"),M=s.ay(l.scaleFactor,I[0],I[1]);b&&(function(F,V,$,H,X,Z,te,oe){const le=V.transform,pe=X==="map",ye=Z==="map";for(const we of F){const me=H.getTile(we),_e=me.getBucket($);if(!_e||!_e.text||!_e.text.segments.get().length)continue;const ge=s.bH(_e.textSizeData,le.zoom,oe),Be=ja(we,_e.getProjection(),le),Ce=le.calculatePixelsToTileUnitsMatrix(me),nt=cl(Be,me.tileID.canonical,ye,pe,le,_e.getProjection(),Ce),He=_e.hasIconTextFit()&&_e.hasIconData();ge&&Su(_e,pe,ye,te,le,nt,we,Math.pow(2,le.zoom-me.tileID.overscaledZ),ge,He)}})(c,l,r,t,r.layout.get("text-rotation-alignment"),r.layout.get("text-pitch-alignment"),p,M);const L=r.paint.get("icon-opacity").constantOr(1)!==0,B=r.paint.get("text-opacity").constantOr(1)!==0;r.layout.get("symbol-sort-key").constantOr(1)!==void 0&&(L||B)?na(l,t,r,c,_,v):(L&&na(l,t,r,c,_,v,{onlyIcons:!0}),B&&na(l,t,r,c,_,v,{onlyText:!0})),t.map.showCollisionBoxes&&(Zh(l,t,r,c,r.paint.get("text-translate"),r.paint.get("text-translate-anchor"),!0),Zh(l,t,r,c,r.paint.get("icon-translate"),r.paint.get("icon-translate-anchor"),!1))},circle:function(l,t,r,c){if(l.renderPass!=="translucent")return;const p=r.paint.get("circle-opacity"),_=r.paint.get("circle-stroke-width"),v=r.paint.get("circle-stroke-opacity"),b=r.layout.get("circle-sort-key").constantOr(1)!==void 0,I=r.paint.get("circle-emissive-strength");if(p.constantOr(1)===0&&(_.constantOr(1)===0||v.constantOr(1)===0))return;const M=l.context,L=M.gl,B=l.transform,F=!(!l.terrain||!l.terrain.enabled),V=r.layout.get("circle-elevation-reference"),$=l.depthModeForSublayer(0,Vt.ReadOnly),H=new Vt(l.context.gl.LEQUAL,Vt.ReadOnly,l.depthRangeFor3D),X=V==="none"||F?$:H,Z=_i.disabled,te=l.colorModeForDrapableLayerRenderPass(I),oe=B.projection.name==="globe",le=[s.aD(B.center.lng),s.aH(B.center.lat)],pe=[];for(let we=0;we<c.length;we++){const me=c[we],_e=t.getTile(me),ge=_e.getBucket(r);if(!ge||ge.projection.name!==B.projection.name)continue;const Be=ge.programConfigurations.get(r.id),Ce=ge.layoutVertexBuffer,nt=ge.globeExtVertexBuffer,He=ge.indexBuffer,at=s.dW(r),mt=[nt],ze=l.isTileAffectedByFog(me);oe&&at.push("PROJECTION_GLOBE_VIEW"),at.push("DEPTH_D24"),l.terrain&&B.depthOcclusionForSymbolsAndCircles&&at.push("DEPTH_OCCLUSION"),ge.hasElevation&&!l.terrain&&(at.push("ELEVATED_ROADS"),mt.push(ge.elevatedLayoutVertexBuffer));const Te=l.getOrCreateProgram("circle",{config:Be,defines:at,overrideFog:ze}),Ze=B.projection.createInversionMatrix(B,me.canonical),Ue={programConfiguration:Be,program:Te,layoutVertexBuffer:Ce,dynamicBuffers:mt,indexBuffer:He,uniformValues:s.dX(l,me,_e,Ze,le,r),tile:_e};if(b){const dt=ge.segments.get();for(const ft of dt)pe.push({segments:new s.bd([ft]),sortKey:ft.sortKey,state:Ue})}else pe.push({segments:ge.segments,sortKey:0,state:Ue})}b&&pe.sort(((we,me)=>we.sortKey-me.sortKey));const ye={useDepthForOcclusion:B.depthOcclusionForSymbolsAndCircles};for(const we of pe){const{programConfiguration:me,program:_e,layoutVertexBuffer:ge,dynamicBuffers:Be,indexBuffer:Ce,uniformValues:nt,tile:He}=we.state,at=we.segments;l.terrain&&l.terrain.setupElevationDraw(He,_e,ye),l.uploadCommonUniforms(M,_e,He.tileID.toUnwrapped()),_e.draw(l,L.TRIANGLES,X,Z,te,gi.disabled,nt,r.id,ge,Ce,at,r.paint,B.zoom,me,Be)}},heatmap:function(l,t,r,c){if(r.paint.get("heatmap-opacity")!==0)if(l.renderPass==="offscreen"){const p=l.context,_=p.gl,v=_i.disabled,b=new ui([_.ONE,_.ONE,_.ONE,_.ONE],s.am.transparent,[!0,!0,!0,!0]);(function(V,$,H,X){const Z=V.gl,te=$.width*X,oe=$.height*X;V.activeTexture.set(Z.TEXTURE1),V.viewport.set([0,0,te,oe]);let le=H.heatmapFbo;if(!le||le&&(le.width!==te||le.height!==oe)){le&&le.destroy();const pe=Z.createTexture();Z.bindTexture(Z.TEXTURE_2D,pe),Z.texParameteri(Z.TEXTURE_2D,Z.TEXTURE_WRAP_S,Z.CLAMP_TO_EDGE),Z.texParameteri(Z.TEXTURE_2D,Z.TEXTURE_WRAP_T,Z.CLAMP_TO_EDGE),Z.texParameteri(Z.TEXTURE_2D,Z.TEXTURE_MIN_FILTER,Z.LINEAR),Z.texParameteri(Z.TEXTURE_2D,Z.TEXTURE_MAG_FILTER,Z.LINEAR),le=H.heatmapFbo=V.createFramebuffer(te,oe,!0,null),(function(ye,we,me,_e,ge,Be){const Ce=ye.gl;Ce.texImage2D(Ce.TEXTURE_2D,0,ye.extRenderToTextureHalfFloat?Ce.RGBA16F:Ce.RGBA,ge,Be,0,Ce.RGBA,ye.extRenderToTextureHalfFloat?Ce.HALF_FLOAT:Ce.UNSIGNED_BYTE,null),_e.colorAttachment.set(me)})(V,0,pe,le,te,oe)}else Z.bindTexture(Z.TEXTURE_2D,le.colorAttachment.get()),V.bindFramebuffer.set(le.framebuffer)})(p,l,r,l.transform.projection.name==="globe"?.5:.25),p.clear({color:s.am.transparent});const I=l.transform,M=I.projection.name==="globe",L=M?["PROJECTION_GLOBE_VIEW"]:[],B=M?gi.frontCCW:gi.disabled,F=[s.aD(I.center.lng),s.aH(I.center.lat)];for(let V=0;V<c.length;V++){const $=c[V];if(t.hasRenderableParent($))continue;const H=t.getTile($),X=H.getBucket(r);if(!X||X.projection.name!==I.projection.name)continue;const Z=l.isTileAffectedByFog($),te=X.programConfigurations.get(r.id),oe=l.getOrCreateProgram("heatmap",{config:te,defines:L,overrideFog:Z}),{zoom:le}=l.transform;l.terrain&&l.terrain.setupElevationDraw(H,oe),l.uploadCommonUniforms(p,oe,$.toUnwrapped());const pe=I.projection.createInversionMatrix(I,$.canonical);oe.draw(l,_.TRIANGLES,Vt.disabled,v,b,B,ia(l,$,H,pe,F,le,r.paint.get("heatmap-intensity")),r.id,X.layoutVertexBuffer,X.indexBuffer,X.segments,r.paint,l.transform.zoom,te,M?[X.globeExtVertexBuffer]:null)}p.viewport.set([0,0,l.width,l.height])}else l.renderPass==="translucent"&&(l.context.setColorMode(l.colorModeForRenderPass()),(function(p,_){const v=p.context,b=v.gl,I=_.heatmapFbo;if(!I)return;v.activeTexture.set(b.TEXTURE0),b.bindTexture(b.TEXTURE_2D,I.colorAttachment.get()),v.activeTexture.set(b.TEXTURE1);let M=_.colorRampTexture;M||(M=_.colorRampTexture=new s.T(v,_.colorRamp,b.RGBA8)),M.bind(b.LINEAR,b.CLAMP_TO_EDGE),p.getOrCreateProgram("heatmapTexture").draw(p,b.TRIANGLES,Vt.disabled,_i.disabled,p.colorModeForRenderPass(),gi.disabled,((L,B,F,V)=>({u_image:0,u_color_ramp:1,u_opacity:B.paint.get("heatmap-opacity")}))(0,_),_.id,p.viewportBuffer,p.quadTriangleIndexBuffer,p.viewportSegments,_.paint,p.transform.zoom)})(l,r))},line:function(l,t,r,c){if(l.renderPass!=="translucent")return;const p=r.paint.get("line-opacity"),_=r.paint.get("line-width");if(p.constantOr(1)===0||_.constantOr(1)===0)return;const v=r.paint.get("line-emissive-strength"),b=r.paint.get("line-occlusion-opacity"),I=r.layout.get("line-elevation-reference"),M=r.layout.get("line-width-unit")==="meters",L=I==="sea",B=!(!l.terrain||!l.terrain.enabled),F=l.context,V=F.gl;if(r.hasElevatedBuckets&&l.transform.projection.name==="globe")return;const $=r.layout.get("line-cross-slope"),H=$!==void 0,X=$<1,Z=l.colorModeForDrapableLayerRenderPass(v),te=l.terrain&&l.terrain.renderingToTexture,oe=te?1:s.q.devicePixelRatio,le=r.paint.get("line-dasharray"),pe=le.constantOr(1),ye=r.layout.get("line-cap"),we=le.constantOr(null),me=ye.constantOr(null),_e=r.paint.get("line-pattern"),ge=_e.constantOr(1),Be=r.paint.get("line-pattern-cross-fade"),Ce=_e.constantOr(null),nt=r.paint.get("line-opacity").constantOr(1);let He=!ge&&nt!==1||l.depthOcclusion&&b>0&&b<1;const at=r.paint.get("line-gradient"),mt=ge?"linePattern":"line",ze=s.dY(r);let Te;if(te&&l.terrain&&l.terrain.clipOrMaskOverlapStencilType()&&(He=!1),b!==0&&l.depthOcclusion){const ft=r.paint._values["line-opacity"];ft&&ft.value&&ft.value.kind==="constant"?Te=ft.value:s.w(`Occlusion opacity for layer ${r.id} is supported only when line-opacity isn't data-driven.`)}_.value.kind!=="constant"&&_.value.isLineProgressConstant===!1&&ze.push("VARIABLE_LINE_WIDTH");const Ze=(ft,xt,It,Qt,oi,qt)=>{for(const si of ft){const Jt=t.getTile(si);if(ge&&!Jt.patternsLoaded())continue;const Ci=Jt.getBucket(r);if(!Ci||Ci.elevationType!=="none"&&!oi||Ci.elevationType==="none"&&oi)continue;l.prepareDrawTile();const Fi=[...xt],Hi=l.shadowRenderer,gn=Ci.elevationType==="road"&&!!Hi&&Hi.enabled;let ki=[0,0,0];if(gn){const Tn=l.style.directionalLight,Nn=l.style.ambientLight;Tn&&Nn&&(ki=lc(l.style,Tn,Nn)),Fi.push("RENDER_SHADOWS","DEPTH_TEXTURE","NORMAL_OFFSET")}const En=Ci.programConfigurations.get(r.id);let Dn=!1;if(Ce&&Jt.imageAtlas){const Tn=s.dZ.from(Ce),Nn=Tn.getPrimary().scaleSelf(oe).toString(),tr=Jt.imageAtlas.patternPositions.get(Nn),ls=Tn.getSecondary(),pr=ls?Jt.imageAtlas.patternPositions.get(ls.scaleSelf(oe).toString()):null;Dn=!!tr&&!!pr,tr&&En.setConstantPatternPositions(tr,pr)}Be>0&&(Dn||En.getPatternTransitionVertexBuffer("line-pattern"))&&Fi.push("LINE_PATTERN_TRANSITION");const sr=l.isTileAffectedByFog(si),Ni=l.getOrCreateProgram(mt,{config:En,defines:Fi,overrideFog:sr});if(!ge&&we&&me&&Jt.lineAtlas){const Tn=Jt.lineAtlas.getDash(we,me);Tn&&En.setConstantPatternPositions(Tn)}gn&&Hi.setupShadows(Jt.tileID.toUnwrapped(),Ni,"vector-tile");let[Sn,pn]=r.paint.get("line-trim-offset");(me==="round"||me==="square")&&Sn!==pn&&(Sn===0&&(Sn-=1),pn===1&&(pn+=1));const Bn=te?si.projMatrix:null,Si=M?1/Ci.tileToMeter/s.aw(Jt,1,l.transform.zoom):1,Qn=M?1/Ci.tileToMeter/s.aw(Jt,1,Math.floor(l.transform.zoom)):1,Ln=ge?s.d_(l,Jt,r,Bn,oe,Si,Qn,[Sn,pn],ki,Be):s.d$(l,Jt,r,Bn,Ci.lineClipsArray.length,oe,Si,Qn,[Sn,pn],ki);if(at){const Tn=Ci.gradients[r.id];let Nn=Tn.texture;if(r.gradientVersion!==Tn.version){let tr=256;if(r.stepInterpolant){const ls=t.getSource().maxzoom,pr=si.canonical.z===ls?Math.ceil(1<<l.transform.maxZoom-si.canonical.z):1;tr=s.ay(s.e0(Ci.maxLineLength/s.aj*1024*pr),256,F.maxTextureSize)}Tn.gradient=s.e1({expression:r.gradientExpression(),evaluationKey:"lineProgress",resolution:tr,image:Tn.gradient||void 0,clips:Ci.lineClipsArray}),Tn.texture?Tn.texture.update(Tn.gradient):Tn.texture=new s.T(F,Tn.gradient,V.RGBA8),Tn.version=r.gradientVersion,Nn=Tn.texture}F.activeTexture.set(V.TEXTURE1),Nn.bind(r.stepInterpolant?V.NEAREST:V.LINEAR,V.CLAMP_TO_EDGE)}pe&&(F.activeTexture.set(V.TEXTURE0),Jt.lineAtlasTexture&&Jt.lineAtlasTexture.bind(V.LINEAR,V.REPEAT),En.updatePaintBuffers()),ge&&(F.activeTexture.set(V.TEXTURE0),Jt.imageAtlasTexture&&Jt.imageAtlasTexture.bind(V.LINEAR,V.CLAMP_TO_EDGE),En.updatePaintBuffers()),oi&&!L&&l.terrain.setupElevationDraw(Jt,Ni),l.uploadCommonUniforms(F,Ni,si.toUnwrapped());const zr=Tn=>{Te!=null&&(Te.value=nt*b),Ni.draw(l,V.TRIANGLES,It,Tn,Z,gi.disabled,Ln,r.id,Ci.layoutVertexBuffer,Ci.indexBuffer,Ci.segments,r.paint,l.transform.zoom,En,[Ci.layoutVertexBuffer2,Ci.patternVertexBuffer,Ci.zOffsetVertexBuffer]),Te!=null&&(Te.value=nt)};if(He&&!oi){const Tn=l.stencilModeForClipping(si).ref;Tn===0&&te&&F.clear({stencil:0});const Nn={func:V.EQUAL,mask:255};Ln.u_alpha_discard_threshold=.8,zr(new _i(Nn,Tn,255,V.KEEP,V.KEEP,V.INVERT)),Ln.u_alpha_discard_threshold=0,zr(new _i(Nn,Tn,255,V.KEEP,V.KEEP,V.KEEP))}else Ln.u_alpha_discard_threshold=He&&oi&&qt?.8:0,zr(oi?Qt:l.stencilModeForClipping(si))}};let Ue=l.depthModeForSublayer(0,Vt.ReadOnly);const dt=new Vt(l.depthOcclusion?V.GREATER:V.LEQUAL,Vt.ReadOnly,l.depthRangeFor3D);if(r.hasNonElevatedBuckets){const ft=!te&&l.terrain;b!==0&&ft?s.w(`Occlusion opacity for layer ${r.id} is supported on terrain only if the layer has line-z-offset enabled.`):ft?s.w(`Cannot render non-elevated lines in immediate mode when terrain is enabled. Layer: ${r.id}.`):Ze(c,ze,Ue,_i.disabled,!1,!0)}if(r.hasElevatedBuckets){I==="hd-road-markup"?B||(Ue=dt,ze.push("ELEVATED_ROADS")):(ze.push("ELEVATED"),Ue=dt,H&&ze.push(X?"CROSS_SLOPE_HORIZONTAL":"CROSS_SLOPE_VERTICAL"),L&&ze.push("ELEVATION_REFERENCE_SEA"));const ft=He?l.stencilModeFor3D():_i.disabled;l.forceTerrainMode=!0,Ze(c,ze,Ue,ft,!0,!0),He&&Ze(c,ze,Ue,ft,!0,!1),l.forceTerrainMode=!1}He&&(l.resetStencilClippingMasks(),te&&F.clear({stencil:0})),b===0||l.depthOcclusion||te||l.layersWithOcclusionOpacity.push(l.currentLayer)},fill:function(l,t,r,c){const p=r.paint.get("fill-color"),_=r.paint.get("fill-opacity");if(_.constantOr(1)===0)return;const v=r.paint.get("fill-emissive-strength"),b=l.colorModeForDrapableLayerRenderPass(v),I=r.paint.get("fill-pattern"),M=l.opaquePassEnabledForLayer()&&!I.constantOr(1)&&p.constantOr(s.am.transparent).a===1&&_.constantOr(0)===1?"opaque":"translucent";let L="none";r.layout.get("fill-elevation-reference")!=="none"?L="road":r.paint.get("fill-z-offset").constantOr(1)!==0&&(L="offset");const B=!(!l.terrain||!l.terrain.enabled),F={painter:l,sourceCache:t,layer:r,coords:c,colorMode:b,elevationType:L,terrainEnabled:B,pass:M};if(l.renderPass!=="shadow")if(L!=="offset"){if(Ya(F,!1),L==="road"){const V=!B&&l.renderPass==="translucent";V&&Kt(l,t,r,c,"geometry"),Ya(F,!0,_i.disabled),V&&(function($){const{painter:H,sourceCache:X,layer:Z,coords:te,colorMode:oe}=$,le=H.context.gl,pe=$.painter.shadowRenderer,ye=!!pe&&pe.enabled,we=new Vt(H.context.gl.LEQUAL,Vt.ReadOnly,H.depthRangeFor3D);let me=[0,0,0];if(ye){const ge=H.style.directionalLight,Be=H.style.ambientLight;ge&&Be&&(me=lc(H.style,ge,Be))}const _e=ge=>{for(const Be of te){const Ce=X.getTile(Be),nt=Ce.getBucket(Z);if(!nt)continue;const He=nt.elevatedStructures;if(!He)continue;let at,mt;if(ge?(at=He.renderableBridgeSegments,mt=He.bridgeProgramConfigurations.get(Z.id)):(at=He.renderableTunnelSegments,mt=He.tunnelProgramConfigurations.get(Z.id)),!at||at.segments[0].primitiveLength===0)continue;mt.updatePaintBuffers(),H.prepareDrawTile();const ze=H.isTileAffectedByFog(Be),Te=[];ye&&Te.push("RENDER_SHADOWS","DEPTH_TEXTURE","NORMAL_OFFSET");const Ze=H.getOrCreateProgram("elevatedStructures",{config:mt,overrideFog:ze,defines:Te}),Ue=H.translatePosMatrix(Be.projMatrix,Ce,Z.paint.get("fill-translate"),Z.paint.get("fill-translate-anchor"));ye&&pe.setupShadows(Ce.tileID.toUnwrapped(),Ze,"vector-tile");const dt=Ka(Ue,me);H.uploadCommonUniforms(H.context,Ze,Be.toUnwrapped()),Ze.draw(H,le.TRIANGLES,we,_i.disabled,oe,gi.backCCW,dt,Z.id,He.vertexBuffer,He.indexBuffer,at,Z.paint,H.transform.zoom,mt,[He.vertexBufferNormal])}};_e(!0),_e(!1)})(F)}}else Ya(F,!1,l.stencilModeFor3D());else l.shadowRenderer&&L==="road"&&!B&&(function(V){const{painter:$,sourceCache:H,layer:X,coords:Z}=V,te=$.context.gl,oe=V.painter.shadowRenderer;for(const le of Z){const pe=H.getTile(le),ye=pe.getBucket(X);if(!ye)continue;const we=ye.elevatedStructures;if(!we||!we.shadowCasterSegments||we.shadowCasterSegments.segments[0].primitiveLength===0)continue;$.prepareDrawTile();const me=ye.bufferData.programConfigurations.get(X.id),_e=$.isTileAffectedByFog(le),ge=$.getOrCreateProgram("elevatedStructuresDepth",{config:me,overrideFog:_e}),Be=oe.calculateShadowPassMatrixFromTile(pe.tileID.toUnwrapped());$.uploadCommonUniforms($.context,ge,le.toUnwrapped());const Ce={u_matrix:Be,u_depth_bias:0};ge.draw($,te.TRIANGLES,oe.getShadowPassDepthMode(),_i.disabled,oe.getShadowPassColorMode(),gi.disabled,Ce,X.id,we.vertexBuffer,we.indexBuffer,we.shadowCasterSegments,X.paint,$.transform.zoom,me)}})(F)},"fill-extrusion":function(l,t,r,c){const p=r.paint.get("fill-extrusion-opacity"),_=l.context,v=_.gl,b=l.terrain,I=b&&b.renderingToTexture;if(p===0)return;const M=l.conflationActive&&l.style.isLayerClipped(r,t.getSource()),L=l.style.order.indexOf(r.fqid);if(M&&(function(B,F,V,$,H){for(const X of $){const Z=F.getTile(X).getBucket(V);Z&&(Z.updateReplacement(X,B.replacementSource,H),Z.uploadCentroid(B.context))}})(l,t,r,c,L),b||M)for(const B of c){const F=t.getTile(B).getBucket(r);F&&fi(l.context,t,B,F,r,b,M)}if(l.renderPass==="shadow"&&l.shadowRenderer){const B=l.shadowRenderer;if(b&&p<.65&&r._transitionablePaint._values["fill-extrusion-opacity"].value.expression instanceof s.ab)return;const F=B.getShadowPassDepthMode(),V=B.getShadowPassColorMode();Qa(l,t,r,c,F,_i.disabled,V,M)}else if(l.renderPass==="translucent"){const B=!r.paint.get("fill-extrusion-pattern").constantOr(1),F=r.paint.get("fill-extrusion-color").constantOr(s.am.white);if(!I&&F.a!==0){const V=new Vt(l.context.gl.LEQUAL,Vt.ReadWrite,l.depthRangeFor3D);p===1&&B?Qa(l,t,r,c,V,_i.disabled,ui.unblended,M):(Qa(l,t,r,c,V,_i.disabled,ui.disabled,M),Qa(l,t,r,c,V,l.stencilModeFor3D(),l.colorModeForRenderPass(),M),l.resetStencilClippingMasks())}if(l.style.enable3dLights()&&B&&(!b&&l.transform.projection.name!=="globe"||I)){const V=r.paint.get("fill-extrusion-opacity"),$=r.paint.get("fill-extrusion-ambient-occlusion-intensity"),H=r.paint.get("fill-extrusion-ambient-occlusion-ground-radius"),X=r.paint.get("fill-extrusion-flood-light-intensity"),Z=r.paint.get("fill-extrusion-flood-light-color-use-theme").constantOr("default")==="none",te=r.paint.get("fill-extrusion-flood-light-color").toNonPremultipliedRenderColor(Z?null:r.lut).toArray01().slice(0,3),oe=$>0&&H>0,le=X>0,pe=(me,_e,ge)=>(1-ge)*me+ge*_e,ye=new gl;ye.translate=r.paint.get("fill-extrusion-translate"),ye.translateAnchor=r.paint.get("fill-extrusion-translate-anchor"),ye.edgeRadius=r.layout.get("fill-extrusion-edge-radius"),ye.cutoffFadeRange=r.paint.get("fill-extrusion-cutoff-fade-range");const we=me=>{const _e=l.depthModeForSublayer(1,Vt.ReadOnly,v.LEQUAL,!0),ge=r.paint.get(me?"fill-extrusion-ambient-occlusion-ground-attenuation":"fill-extrusion-flood-light-ground-attenuation"),Be=pe(.1,3,ge),Ce=l._showOverdrawInspector;if(!Ce){const nt=new _i({func:v.ALWAYS,mask:255},255,255,v.KEEP,v.KEEP,v.REPLACE),He=new ui([v.ONE,v.ONE,v.ONE,v.ONE],s.am.transparent,[!1,!1,!1,!0],v.MIN);Ro(ye,l,t,r,c,_e,nt,He,gi.disabled,me,"sdf",V,$,H,X,te,Be,M,!1)}{const nt=Ce?_i.disabled:new _i({func:v.EQUAL,mask:255},255,255,v.KEEP,v.DECR,v.DECR),He=Ce?l.colorModeForRenderPass():new ui([v.ONE_MINUS_DST_ALPHA,v.DST_ALPHA,v.ONE,v.ONE],s.am.transparent,[!0,!0,!0,!0]);Ro(ye,l,t,r,c,_e,nt,He,gi.disabled,me,"color",V,$,H,X,te,Be,M,!1)}};if(I){const me=(_e,ge,Be)=>{const Ce=l.depthModeForSublayer(1,Vt.ReadOnly,v.LEQUAL,!1),nt=r.paint.get(_e?"fill-extrusion-ambient-occlusion-ground-attenuation":"fill-extrusion-flood-light-ground-attenuation"),He=pe(.1,3,nt);{const at=new ui([v.ONE,v.ONE,v.ONE,v.ONE],s.am.transparent,[!1,!1,!1,!0]);Ro(ye,l,t,r,c,Ce,_i.disabled,at,gi.disabled,_e,"clear",V,$,H,X,te,He,M,ge)}{const at=new _i({func:v.ALWAYS,mask:255},255,255,v.KEEP,v.KEEP,v.REPLACE),mt=new ui([v.ONE,v.ONE,v.ONE,v.ONE],s.am.transparent,[!1,!1,!1,!0],v.MIN);Ro(ye,l,t,r,c,Ce,at,mt,gi.disabled,_e,"sdf",V,$,H,X,te,He,M,ge)}{const at=_e?v.ZERO:v.ONE_MINUS_DST_ALPHA,mt=new _i({func:v.EQUAL,mask:255},255,255,v.KEEP,v.DECR,v.DECR),ze=new ui([at,v.DST_ALPHA,v.ONE_MINUS_DST_ALPHA,v.ZERO],s.am.transparent,[!0,!0,!0,!0]);Ro(ye,l,t,r,c,Ce,mt,ze,gi.disabled,_e,"color",V,$,H,X,te,He,M,ge)}{const at=new ui([v.ONE,v.ONE,v.ONE,_e?v.ZERO:v.ONE],s.am.transparent,[!1,!1,!1,!0],_e?v.FUNC_ADD:v.MAX);Ro(ye,l,t,r,c,Ce,_i.disabled,at,gi.disabled,_e,"clear",V,$,H,X,te,He,M,ge,Be)}};if(oe||le){let _e;if(l.prepareDrawTile(),b){const ge=b.drapeBufferSize[0],Be=b.drapeBufferSize[1];_e=b.framebufferCopyTexture,_e&&(!_e||_e.size[0]===ge&&_e.size[1]===Be)||(_e&&_e.destroy(),_e=b.framebufferCopyTexture=new s.T(_,new s.r({width:ge,height:Be}),v.RGBA8)),_e.bind(v.LINEAR,v.CLAMP_TO_EDGE),v.copyTexSubImage2D(v.TEXTURE_2D,0,0,0,0,0,ge,Be)}oe&&me(!0,!1,_e),le&&me(!1,!0,_e)}}else oe&&we(!0),le&&we(!1),(oe||le)&&l.resetStencilClippingMasks()}}},building:function(l,t,r,c){l.currentLayer<l.firstLightBeamLayer&&(l.firstLightBeamLayer=l.currentLayer);const p=r.paint.get("building-ambient-occlusion-ground-intensity"),_=r.paint.get("building-ambient-occlusion-ground-radius"),v=r.paint.get("building-ambient-occlusion-ground-attenuation");let b=p>0&&_>0,I=!0;const M=r.paint.get("building-vertical-scale");M<1&&(I=!1);const L=l.conflationActive&&l.style.isLayerClipped(r,t.getSource()),B=l.style.order.indexOf(r.fqid);if((function(F,V,$,H,X,Z){for(const te of Z){const oe=V.getTile(te).getBucket($);oe&&(X&&oe.updateReplacement(te,F.replacementSource,H),oe.uploadUpdatedIndexBuffer(F.context))}})(l,t,r,B,L,c),(function(F,V,$,H){for(const X of H){const Z=V.getTile(X).getBucket($);Z&&Z.needsEvaluation(F,$)&&(Z.evaluate($),Z.uploadUpdatedColorBuffer(F.context))}})(l,t,r,c),r.resetLayerRenderingStats(l),l.shadowRenderer&&(l.shadowRenderer.useNormalOffset=!0),l.renderPass==="shadow"&&l.shadowRenderer){const F=l.shadowRenderer,V=[],$=F.getShadowPassDepthMode();Kh({painter:l,source:t,layer:r,coords:c,defines:V,blendMode:F.getShadowPassColorMode(),depthMode:$,verticalScale:M})}else if(l.renderPass==="translucent"){b&&(function(H,X,Z,te,oe,le,pe,ye,we,me,_e,ge,Be){const Ce=H.context.gl,nt=H.depthModeForSublayer(1,Vt.ReadOnly,Ce.LEQUAL,!0),He=.1*(1-(at=_e))+3*at;var at;const mt=H._showOverdrawInspector,ze=ge,Te=new gl;mt||Ro(Te,H,X,Z,te,nt,new _i({func:Ce.ALWAYS,mask:255},255,255,Ce.KEEP,Ce.KEEP,Ce.REPLACE),new ui([Ce.ONE,Ce.ONE,Ce.ONE,Ce.ONE],s.am.transparent,[!1,!1,!1,!0],Ce.MIN),gi.disabled,oe,"sdf",1,pe,ye,0,me,He,ze,!1);{const Ze=mt?_i.disabled:new _i({func:Ce.EQUAL,mask:255},255,255,Ce.KEEP,Ce.DECR,Ce.DECR),Ue=mt?H.colorModeForRenderPass():new ui([Ce.ONE_MINUS_DST_ALPHA,Ce.DST_ALPHA,Ce.ONE,Ce.ONE],s.am.transparent,[!0,!0,!0,!0]);Ro(Te,H,X,Z,te,nt,Ze,Ue,gi.disabled,oe,"color",1,pe,ye,0,me,He,ze,!1)}})(l,t,r,c,!0,0,p,_,0,[0,0,0],v,L);let F=["HAS_ATTRIBUTE_a_part_color_emissive","LIGHTING_3D_MODE"];I&&(F=F.concat("RENDER_SHADOWS","DEPTH_TEXTURE")),l.shadowRenderer.useNormalOffset&&(F=F.concat("NORMAL_OFFSET"));const V=new Vt(l.context.gl.LEQUAL,Vt.ReadWrite,l.depthRangeFor3D),$=l.colorModeForRenderPass();Kh({painter:l,source:t,layer:r,coords:c,defines:F,blendMode:$,depthMode:V,verticalScale:M})}else if(l.renderPass==="light-beam"){const F=["HAS_ATTRIBUTE_a_part_color_emissive","HAS_ATTRIBUTE_a_bloom_attenuation"],V=new Vt(l.context.gl.LEQUAL,Vt.ReadOnly,l.depthRangeFor3D);Kh({painter:l,source:t,layer:r,coords:c,defines:F,blendMode:ui.alphaBlended,depthMode:V,verticalScale:M})}l.shadowRenderer&&(l.shadowRenderer.useNormalOffset=!1),l.resetStencilClippingMasks()},hillshade:function(l,t,r,c){if(l.renderPass!=="offscreen"&&l.renderPass!=="translucent"||l.style.disableElevatedTerrain)return;const p=l.context,_=l.terrain&&l.terrain.renderingToTexture,[v,b]=l.renderPass!=="translucent"||_?[{},c]:l.stencilConfigForOverlap(c);for(const I of b){const M=t.getTile(I);if(M.needsHillshadePrepare&&l.renderPass==="offscreen")zf(l,M,r);else if(l.renderPass==="translucent"){const L=l.depthModeForSublayer(0,Vt.ReadOnly),B=r.paint.get("hillshade-emissive-strength"),F=l.colorModeForDrapableLayerRenderPass(B),V=_&&l.terrain?l.terrain.stencilModeForRTTOverlap(I):v[I.overscaledZ];Tm(l,I,M,r,L,V,F)}}p.viewport.set([0,0,l.width,l.height]),l.resetStencilClippingMasks()},raster:function(l,t,r,c,p,_){if(l.renderPass!=="translucent"||r.paint.get("raster-opacity")===0)return;const v=l.transform.projection.name==="globe",b=r.paint.get("raster-elevation")!==0,I=b&&v;if(l.renderElevatedRasterBackface&&!I)return;const M=l.context,L=M.gl,B=t.getSource(),F=(function(ye,we,me,_e){const ge=we.paint.get("raster-color"),Be=ye.type==="raster-array",Ce=[],nt=we.paint.get("raster-resampling"),He=we.paint.get("raster-color-mix");let at=we.paint.get("raster-color-range");const mt=[He[0],He[1],He[2],0],ze=He[3];let Te=nt==="nearest"?_e.NEAREST:_e.LINEAR;if(Be&&(Ce.push("RASTER_ARRAY"),ge||Ce.push("RASTER_COLOR"),nt==="linear"&&Ce.push("RASTER_ARRAY_LINEAR"),Te=_e.NEAREST,!at&&ye.rasterLayers)){const Ze=ye.rasterLayers.find((({id:Ue})=>Ue===we.sourceLayer));Ze&&Ze.fields&&Ze.fields.range&&(at=Ze.fields.range)}if(at=at||[0,1],ge){Ce.push("RASTER_COLOR"),me.activeTexture.set(_e.TEXTURE2),we.updateColorRamp(at);let Ze=we.colorRampTexture;Ze||(Ze=we.colorRampTexture=new s.T(me,we.colorRamp,_e.RGBA8)),Ze.bind(_e.LINEAR,_e.CLAMP_TO_EDGE)}return{mix:mt,range:at,offset:ze,defines:Ce,resampling:Te}})(B,r,M,L);if(B instanceof s.aP&&!c.length&&!v)return;const V=r.paint.get("raster-emissive-strength"),$=l.colorModeForDrapableLayerRenderPass(V),H=l.terrain&&l.terrain.renderingToTexture,X=!l.options.moving,Z=r.paint.get("raster-resampling")==="nearest"?L.NEAREST:L.LINEAR;if(B instanceof s.aP&&!c.length&&(B.onNorthPole||B.onSouthPole)){const ye=b?l.stencilModeFor3D():_i.disabled;return void Pa(!!B.onNorthPole,null,l,t,r,V,F,gi.disabled,ye)}if(!c.length)return;const[te,oe]=B instanceof s.aP||H?[{},c]:l.stencilConfigForOverlap(c),le=oe[oe.length-1].overscaledZ;I&&F.defines.push("PROJECTION_GLOBE_VIEW"),b&&F.defines.push("RENDER_CUTOFF");const pe=(ye,we,me)=>{for(const _e of ye){const ge=_e.toUnwrapped(),Be=t.getTile(_e);if(H&&(!Be||!Be.hasData()))continue;M.activeTexture.set(L.TEXTURE0);const Ce=Qh(Be,B,r,F);if(!Ce||!Ce.texture)continue;const{texture:nt,mix:He,offset:at,tileSize:mt,buffer:ze}=Ce;let Te,Ze;H?(Te=Vt.disabled,Ze=_e.projMatrix):b?(Te=new Vt(L.LEQUAL,Vt.ReadWrite,l.depthRangeFor3D),Ze=v?Float32Array.from(l.transform.expandedFarZProjMatrix):l.transform.calculateProjMatrix(ge,X)):(Te=l.depthModeForSublayer(_e.overscaledZ-le,r.paint.get("raster-opacity")===1?Vt.ReadWrite:Vt.ReadOnly,L.LESS),Ze=l.transform.calculateProjMatrix(ge,X));const Ue=l.terrain&&H?l.terrain.stencilModeForRTTOverlap(_e):te[_e.overscaledZ],dt=_?0:r.paint.get("raster-fade-duration");Be.registerFadeDuration(dt);const ft=t.findLoadedParent(_e,0),xt=Ls(Be,ft,t,l.transform,dt);let It,Qt;l.terrain&&l.terrain.prepareDrawTile(),M.activeTexture.set(L.TEXTURE0),nt.bind(Z,L.CLAMP_TO_EDGE),M.activeTexture.set(L.TEXTURE1),ft?(ft.texture&&ft.texture.bind(Z,L.CLAMP_TO_EDGE),It=Math.pow(2,ft.tileID.overscaledZ-Be.tileID.overscaledZ),Qt=[Be.tileID.canonical.x*It%1,Be.tileID.canonical.y*It%1]):nt.bind(Z,L.CLAMP_TO_EDGE),"useMipmap"in nt&&M.extTextureFilterAnisotropic&&l.transform.pitch>20&&L.texParameterf(L.TEXTURE_2D,M.extTextureFilterAnisotropic.TEXTURE_MAX_ANISOTROPY_EXT,M.extTextureFilterAnisotropicMax);const oi=l.transform;let qt;const si=b?Yh(oi):[0,0,0,0];let Jt,Ci,Fi,Hi,gn,ki=0;if(I&&B instanceof s.aP&&B.coordinates.length>3)Jt=Float32Array.from(s.bh(s.dD(new s.cA(0,0,0)))),Ci=Float32Array.from(oi.globeMatrix),Fi=Float32Array.from(s.dz(oi)),Hi=[s.aD(oi.center.lng),s.aH(oi.center.lat)],qt=B.elevatedGlobePerspectiveTransform,gn=B.elevatedGlobeGridMatrix||new Float32Array(9);else if(I){const Ni=s.dA(_e.canonical);ki=s.dB(Ni.getCenter().lat),Jt=Float32Array.from(s.bh(s.dD(_e.canonical))),Ci=Float32Array.from(oi.globeMatrix),Fi=Float32Array.from(s.dz(oi)),Hi=[s.aD(oi.center.lng),s.aH(oi.center.lat)],qt=[0,0],gn=Float32Array.from(s.dC(_e.canonical,Ni,ki,oi.worldSize/oi._pixelsPerMercatorPixel))}else qt=B instanceof s.aP?B.perspectiveTransform:[0,0],Jt=new Float32Array(16),Ci=new Float32Array(9),Fi=new Float32Array(16),Hi=[0,0],gn=new Float32Array(9);const En=Aa(Ze,Jt,Ci,Fi,gn,Qt||[0,0],s.ah(l.transform.zoom),Hi,si,It||1,xt,r,qt,b?r.paint.get("raster-elevation"):0,2,He,at,F.range,mt,ze,V),Dn=l.isTileAffectedByFog(_e),sr=l.getOrCreateProgram("raster",{defines:F.defines,overrideFog:Dn});if(l.uploadCommonUniforms(M,sr,ge),B instanceof s.aP){const Ni=B.elevatedGlobeVertexBuffer,Sn=B.elevatedGlobeIndexBuffer;if(H||!v)B.boundsBuffer&&B.boundsSegments&&sr.draw(l,L.TRIANGLES,Te,_i.disabled,$,gi.disabled,En,r.id,B.boundsBuffer,l.quadTriangleIndexBuffer,B.boundsSegments);else if(Ni&&Sn){const pn=oi.zoom<=s.cX?B.elevatedGlobeSegments:B.getSegmentsForLongitude(oi.center.lng);pn&&sr.draw(l,L.TRIANGLES,Te,_i.disabled,$,we,En,r.id,Ni,Sn,pn)}}else if(I){Te=new Vt(L.LEQUAL,Vt.ReadOnly,l.depthRangeFor3D);const Ni=l.globeSharedBuffers;if(Ni){const[Sn,pn,Bn]=Ni.getGridBuffers(ki,!1);sr.draw(l,L.TRIANGLES,Te,me||Ue,l.colorModeForRenderPass(),we,En,r.id,Sn,pn,Bn)}}else{const{tileBoundsBuffer:Ni,tileBoundsIndexBuffer:Sn,tileBoundsSegments:pn}=l.getTileBoundsBuffers(Be);sr.draw(l,L.TRIANGLES,Te,Ue,$,gi.disabled,En,r.id,Ni,Sn,pn)}}if(!(B instanceof s.aP)&&I)for(const _e of ye){const ge=_e.canonical.y===(1<<_e.canonical.z)-1;_e.canonical.y===0&&Pa(!0,_e,l,t,r,V,F,we,me||_i.disabled),ge&&Pa(!1,_e,l,t,r,V,F,we===gi.frontCW?gi.backCW:gi.frontCW,me||_i.disabled)}};I?pe(oe,l.renderElevatedRasterBackface?gi.backCW:gi.frontCW,l.stencilModeFor3D()):pe(oe,gi.disabled,void 0),l.resetStencilClippingMasks()},"raster-particle":function(l,t,r,c,p,_){l.renderPass==="offscreen"&&(function(v,b,I,M){if(!M.length)return;const L=v.context,B=L.gl,F=b.getSource();if(!(F instanceof ol))return;const V=Math.ceil(Math.sqrt(I.paint.get("raster-particle-count")));let $=I.particlePositionRGBAImage;if(!$||$.width!==V){const oe=(function(le){const pe=le*le,ye=new Uint8Array(4*pe),we=function(_e){return _e|=0,_e=Math.imul(2747636419^_e,2654435769),_e=Math.imul(_e^_e>>>16,2654435769),((_e=Math.imul(_e^_e>>>16,2654435769))>>>0)/4294967296},me=1/1.1;for(let _e=0;_e<pe;_e++){const ge=me*(we(2*_e+0)+mc),Be=me*(we(2*_e+1)+mc),Ce=255*ge%1,nt=255*Be%1,He=Ce,at=Be-nt/255,mt=nt;ye[4*_e+0]=255*(ge-Ce/255),ye[4*_e+1]=255*He,ye[4*_e+2]=255*at,ye[4*_e+3]=255*mt}return ye})(V);$=I.particlePositionRGBAImage=new s.r({width:V,height:V},oe)}let H=I.particleFramebuffer;H?H.width!==V&&(H.destroy(),H=I.particleFramebuffer=L.createFramebuffer(V,V,!0,null)):H=I.particleFramebuffer=L.createFramebuffer(V,V,!0,null);const X=[];for(const oe of M){const le=b.getTile(oe);if(!(le instanceof ec))continue;const pe=ks(le,F,I);if(!pe)continue;const ye=[le.tileSize,le.tileSize];let we=I.tileFramebuffer;we||(we=I.tileFramebuffer=L.createFramebuffer(ye[0],ye[1],!0,null));let me=le.rasterParticleState;me||(me=le.rasterParticleState=new Jh(L,oe,ye,$));const _e=me.update(I.lastInvalidatedAt);me.particleTextureDimension!==V&&me.updateParticleTexture(oe,$);const ge=me.targetColorTexture;me.targetColorTexture=me.backgroundColorTexture,me.backgroundColorTexture=ge;const Be=me.particleTexture0;me.particleTexture0=me.particleTexture1,me.particleTexture1=Be,X.push([oe,pe,me,_e])}if(X.length===0)return;const Z=s.q.now(),te=I.previousDrawTimestamp?.001*(Z-I.previousDrawTimestamp):.0167;if(I.previousDrawTimestamp=Z,I.hasColorMap()){L.activeTexture.set(B.TEXTURE0+2);let oe=I.colorRampTexture;oe||(oe=I.colorRampTexture=new s.T(L,I.colorRamp,B.RGBA8)),oe.bind(B.LINEAR,B.CLAMP_TO_EDGE)}L.bindFramebuffer.set(I.tileFramebuffer.framebuffer),(function(oe,le,pe){const ye=oe.context,we=ye.gl,me=le.tileFramebuffer;ye.activeTexture.set(we.TEXTURE0);const _e={u_texture:0,u_opacity:1.05*(Be=le.paint.get("raster-particle-fade-opacity-factor"))/(Be+.05)},ge=oe.getOrCreateProgram("rasterParticleTexture",{defines:[],overrideFog:!1});var Be;for(const Ce of pe){const[,,nt,He]=Ce;me.colorAttachment.set(nt.targetColorTexture.texture),ye.viewport.set([0,0,me.width,me.height]),ye.clear({color:s.am.transparent}),He&&(nt.backgroundColorTexture.bind(we.NEAREST,we.CLAMP_TO_EDGE),ge.draw(oe,we.TRIANGLES,Vt.disabled,_i.disabled,ui.alphaBlended,gi.disabled,_e,le.id,oe.viewportBuffer,oe.quadTriangleIndexBuffer,oe.viewportSegments))}})(v,I,X),(function(oe,le,pe,ye){const we=oe.context,me=we.gl,_e=pe.tileFramebuffer,ge=oe.transform.projection.name==="globe",Be=pe.paint.get("raster-particle-max-speed");for(const Ce of ye){const[nt,He,at]=Ce;we.activeTexture.set(me.TEXTURE0+0),He.texture.bind(me.LINEAR,me.CLAMP_TO_EDGE),_e.colorAttachment.set(at.targetColorTexture.texture);const mt=oe.getOrCreateProgram("rasterParticleDraw",{defines:He.defines,overrideFog:!1});we.activeTexture.set(me.TEXTURE0+1);const ze=He.scalarData?[]:[0,1,2,3].map((Ue=>s.e3[Ue](nt)));ze.push(nt);const Te=nt.canonical.x,Ze=nt.canonical.y;for(const Ue of ze){const dt=le.getTile(ge?Ue.wrapped():Ue);if(!dt)continue;const ft=dt.rasterParticleState;if(!ft)continue;const xt=Ue.canonical.x+(1<<Ue.canonical.z)*(Ue.wrap-nt.wrap),It=Ue.canonical.y;ft.particleTexture0.bind(me.NEAREST,me.CLAMP_TO_EDGE);const Qt=Od(1,ft.particleTexture0.size[0],[xt-Te,It-Ze],0,He.texture.size,2,Be,He.textureOffset,He.scale,He.offset);mt.draw(oe,me.POINTS,Vt.disabled,_i.disabled,ui.alphaBlended,gi.disabled,Qt,pe.id,ft.particleIndexBuffer,void 0,ft.particleSegment)}}})(v,b,I,X),L.bindFramebuffer.set(I.particleFramebuffer.framebuffer),(function(oe,le,pe,ye){const we=oe.context,me=we.gl,_e=le.paint.get("raster-particle-max-speed"),ge=ye*le.paint.get("raster-particle-speed-factor")*.15,Be=(function(nt){return Math.pow(nt,6)})(.01+1*le.paint.get("raster-particle-reset-rate-factor")),Ce=le.particleFramebuffer;we.viewport.set([0,0,Ce.width,Ce.height]);for(const nt of pe){const[,He,at]=nt;we.activeTexture.set(me.TEXTURE0+0),He.texture.bind(me.LINEAR,me.CLAMP_TO_EDGE),we.activeTexture.set(me.TEXTURE0+1);const mt=at.particleTexture0;mt.bind(me.NEAREST,me.CLAMP_TO_EDGE);const ze=Gf(1,mt.size[0],0,He.texture.size,_e,ge,Be,He.textureOffset,He.scale,He.offset);Ce.colorAttachment.set(at.particleTexture1.texture),we.clear({color:s.am.transparent}),oe.getOrCreateProgram("rasterParticleUpdate",{defines:He.defines}).draw(oe,me.TRIANGLES,Vt.disabled,_i.disabled,ui.unblended,gi.disabled,ze,le.id,oe.viewportBuffer,oe.quadTriangleIndexBuffer,oe.viewportSegments)}})(v,I,X,te)})(l,t,r,c),l.renderPass==="translucent"&&((function(v,b,I,M,L){const B=v.context,F=B.gl,V=b.getSource().tileSize,$=5*(1-s.af(s.cI,s.cI+1,v.transform.zoom))*V+I.paint.get("raster-particle-elevation"),H=!v.options.moving,X=v.transform.projection.name==="globe";if(!M.length)return;const[Z,te]=v.stencilConfigForOverlap(M),oe=[];X&&oe.push("PROJECTION_GLOBE_VIEW");const le=v.stencilModeFor3D();for(const pe of te){const ye=pe.toUnwrapped(),we=b.getTile(pe);if(!we.rasterParticleState)continue;const me=we.rasterParticleState,_e=100;we.registerFadeDuration(_e);const ge=b.findLoadedParent(pe,0),Be=Ls(we,ge,b,v.transform,_e);let Ce,nt;v.terrain&&v.terrain.prepareDrawTile(),B.activeTexture.set(F.TEXTURE0),me.targetColorTexture.bind(F.LINEAR,F.CLAMP_TO_EDGE),B.activeTexture.set(F.TEXTURE1),ge&&ge.rasterParticleState?(ge.rasterParticleState.targetColorTexture.bind(F.LINEAR,F.CLAMP_TO_EDGE),Ce=Math.pow(2,ge.tileID.overscaledZ-we.tileID.overscaledZ),nt=[we.tileID.canonical.x*Ce%1,we.tileID.canonical.y*Ce%1]):me.targetColorTexture.bind(F.LINEAR,F.CLAMP_TO_EDGE);const He=X?Float32Array.from(v.transform.expandedFarZProjMatrix):v.transform.calculateProjMatrix(ye,H),at=v.transform,mt=yc(at),ze=s.dA(pe.canonical),Te=s.dB(ze.getCenter().lat);let Ze,Ue,dt,ft,xt;X?(Ze=Float32Array.from(s.bh(s.dD(pe.canonical))),Ue=Float32Array.from(at.globeMatrix),dt=Float32Array.from(s.dz(at)),ft=[s.aD(at.center.lng),s.aH(at.center.lat)],xt=Float32Array.from(s.dC(pe.canonical,ze,Te,at.worldSize/at._pixelsPerMercatorPixel))):(Ze=new Float32Array(16),Ue=new Float32Array(9),dt=new Float32Array(16),ft=[0,0],xt=new Float32Array(9));const It=rh(He,Ze,Ue,dt,xt,nt||[0,0],s.ah(v.transform.zoom),ft,mt,Ce||1,Be,$),Qt=v.isTileAffectedByFog(pe),oi=v.getOrCreateProgram("rasterParticle",{defines:oe,overrideFog:Qt});if(v.uploadCommonUniforms(B,oi,ye),X){const qt=new Vt(F.LEQUAL,Vt.ReadOnly,v.depthRangeFor3D),si=0,Jt=v.globeSharedBuffers;if(Jt){const[Ci,Fi,Hi]=Jt.getGridBuffers(Te,si!==0);oi.draw(v,F.TRIANGLES,qt,le,ui.alphaBlended,v.renderElevatedRasterBackface?gi.frontCCW:gi.backCCW,It,I.id,Ci,Fi,Hi)}}else{const qt=v.depthModeForSublayer(0,Vt.ReadOnly),si=Z[pe.overscaledZ],{tileBoundsBuffer:Jt,tileBoundsIndexBuffer:Ci,tileBoundsSegments:Fi}=v.getTileBoundsBuffers(we);oi.draw(v,F.TRIANGLES,qt,si,ui.alphaBlended,gi.disabled,It,I.id,Jt,Ci,Fi)}}v.resetStencilClippingMasks()})(l,t,r,c),l.style.map.triggerRepaint())},background:function(l,t,r,c){const p=r.paint.get("background-color"),_=r.paint.get("background-color-use-theme").constantOr("default")==="none",v=r.paint.get("background-opacity"),b=r.paint.get("background-emissive-strength"),I=r.paint.get("background-pitch-alignment")==="viewport";if(v===0)return;const M=l.context,L=M.gl,B=l.transform,F=B.tileSize,V=r.paint.get("background-pattern");let $;if(V!==void 0&&(V===null||($=l.imageManager.getPattern(s.I.from(V.toString()),r.scope,l.style.getLut(r.scope)),!$)))return;const H=!V&&p.a===1&&v===1&&l.opaquePassEnabledForLayer()?"opaque":"translucent";if(l.renderPass!==H)return;const X=_i.disabled,Z=l.depthModeForSublayer(0,H==="opaque"?Vt.ReadWrite:Vt.ReadOnly),te=l.colorModeForDrapableLayerRenderPass(b),oe=V?"backgroundPattern":"background";let le,pe=c;if(pe||(le=l.getBackgroundTiles(),pe=Object.values(le).map((ye=>ye.tileID))),V&&(M.activeTexture.set(L.TEXTURE0),l.imageManager.bind(l.context,r.scope)),I){const ye=l.getOrCreateProgram(oe,{overrideFog:!1,overrideRtt:!0}),we=new Float32Array(s.bx([])),me=new s.aM(0,0,0,0,0),_e=V?$h(we,b,v,l,0,r.scope,$,I,{tileID:me,tileSize:F}):xu(we,b,v,p.toPremultipliedRenderColor(_?null:r.lut));ye.draw(l,L.TRIANGLES,Z,X,te,gi.disabled,_e,r.id,l.viewportBuffer,l.quadTriangleIndexBuffer,l.viewportSegments)}else for(const ye of pe){const we=l.isTileAffectedByFog(ye),me=l.getOrCreateProgram(oe,{overrideFog:we}),_e=ye.toUnwrapped(),ge=c?ye.projMatrix:l.transform.calculateProjMatrix(_e);l.prepareDrawTile();const Be=t?t.getTile(ye):le?le[ye.key]:new Ol(ye,F,B.zoom,l),Ce=V?$h(ge,b,v,l,0,r.scope,$,I,{tileID:ye,tileSize:F}):xu(ge,b,v,p.toPremultipliedRenderColor(_?null:r.lut));l.uploadCommonUniforms(M,me,_e);const{tileBoundsBuffer:nt,tileBoundsIndexBuffer:He,tileBoundsSegments:at}=l.getTileBoundsBuffers(Be);me.draw(l,L.TRIANGLES,Z,X,te,gi.disabled,Ce,r.id,nt,He,at)}},sky:function(l,t,r){const c=l._atmosphere?s.ah(l.transform.zoom):1,p=r.paint.get("sky-opacity")*c;if(p===0)return;const _=l.context,v=r.paint.get("sky-type"),b=new Vt(_.gl.LEQUAL,Vt.ReadOnly,[0,1]),I=l.frameCounter/1e3%1;v==="atmosphere"?l.renderPass==="offscreen"?r.needsSkyboxCapture(l)&&((function(M,L,B,F){const V=M.context,$=V.gl;let H=L.skyboxFbo;if(!H){H=L.skyboxFbo=V.createFramebuffer(32,32,!0,null),L.skyboxGeometry=new vl(V),L.skyboxTexture=V.gl.createTexture(),$.bindTexture($.TEXTURE_CUBE_MAP,L.skyboxTexture),$.texParameteri($.TEXTURE_CUBE_MAP,$.TEXTURE_WRAP_S,$.CLAMP_TO_EDGE),$.texParameteri($.TEXTURE_CUBE_MAP,$.TEXTURE_WRAP_T,$.CLAMP_TO_EDGE),$.texParameteri($.TEXTURE_CUBE_MAP,$.TEXTURE_MIN_FILTER,$.LINEAR),$.texParameteri($.TEXTURE_CUBE_MAP,$.TEXTURE_MAG_FILTER,$.LINEAR);for(let oe=0;oe<6;++oe)$.texImage2D($.TEXTURE_CUBE_MAP_POSITIVE_X+oe,0,$.RGBA,32,32,0,$.RGBA,$.UNSIGNED_BYTE,null)}V.bindFramebuffer.set(H.framebuffer),V.viewport.set([0,0,32,32]);const X=L.getCenter(M,!0),Z=M.getOrCreateProgram("skyboxCapture"),te=new Float64Array(16);s.bx(te),s.eh(te,te,.5*-Math.PI),xl(M,L,Z,te,X,0),s.bx(te),s.eh(te,te,.5*Math.PI),xl(M,L,Z,te,X,1),s.bx(te),s.cR(te,te,.5*-Math.PI),xl(M,L,Z,te,X,2),s.bx(te),s.cR(te,te,.5*Math.PI),xl(M,L,Z,te,X,3),s.bx(te),xl(M,L,Z,te,X,4),s.bx(te),s.eh(te,te,Math.PI),xl(M,L,Z,te,X,5),V.viewport.set([0,0,M.width,M.height])})(l,r),r.markSkyboxValid(l)):l.renderPass==="sky"&&(function(M,L,B,F,V){const $=M.context,H=$.gl,X=M.transform,Z=M.getOrCreateProgram("skybox");$.activeTexture.set(H.TEXTURE0),H.bindTexture(H.TEXTURE_CUBE_MAP,L.skyboxTexture);const te=((oe,le,pe,ye,we)=>({u_matrix:oe,u_sun_direction:le,u_cubemap:0,u_opacity:ye,u_temporal_offset:we}))(X.skyboxMatrix,L.getCenter(M,!1),0,F,V);M.uploadCommonUniforms($,Z),Z.draw(M,H.TRIANGLES,B,_i.disabled,M.colorModeForRenderPass(),gi.backCW,te,"skybox",L.skyboxGeometry.vertexBuffer,L.skyboxGeometry.indexBuffer,L.skyboxGeometry.segment)})(l,r,b,p,I):v==="gradient"&&l.renderPass==="sky"&&(function(M,L,B,F,V){const $=M.context,H=$.gl,X=M.transform,Z=M.getOrCreateProgram("skyboxGradient");L.skyboxGeometry||(L.skyboxGeometry=new vl($)),$.activeTexture.set(H.TEXTURE0);let te=L.colorRampTexture;te||(te=L.colorRampTexture=new s.T($,L.colorRamp,H.RGBA8)),te.bind(H.LINEAR,H.CLAMP_TO_EDGE);const oe=((le,pe,ye,we,me)=>({u_matrix:le,u_color_ramp:0,u_center_direction:pe,u_radius:s.al(ye),u_opacity:we,u_temporal_offset:me}))(X.skyboxMatrix,L.getCenter(M,!1),L.paint.get("sky-gradient-radius"),F,V);M.uploadCommonUniforms($,Z),Z.draw(M,H.TRIANGLES,B,_i.disabled,M.colorModeForRenderPass(),gi.backCW,oe,"skyboxGradient",L.skyboxGeometry.vertexBuffer,L.skyboxGeometry.indexBuffer,L.skyboxGeometry.segment)})(l,r,b,p,I)},custom:function(l,t,r,c){const p=l.context,_=r.implementation;if(!l.transform.projection.unsupportedLayers||!l.transform.projection.unsupportedLayers.includes("custom")||l.terrain&&(l.terrain.renderingToTexture||l.renderPass==="offscreen")&&r.isDraped(t)){if(l.renderPass==="offscreen"){const v=_.prerender;if(v){if(l.setCustomLayerDefaults(),p.setColorMode(l.colorModeForRenderPass()),l.transform.projection.name==="globe"){const b=l.transform.pointMerc;v.call(_,p.gl,l.transform.customLayerMatrix(),l.transform.getProjection(),l.transform.globeToMercatorMatrix(),s.ah(l.transform.zoom),[b.x,b.y],l.transform.pixelsPerMeterRatio)}else v.call(_,p.gl,l.transform.customLayerMatrix());p.setDirty(),l.setBaseState()}}else if(l.renderPass==="translucent"){if(l.terrain&&l.terrain.renderingToTexture){const b=_.renderToTile;if(b){const I=c[0].canonical,M={x:I.x+c[0].wrap*(_.wrapTileId?0:1<<I.z),y:I.y,z:I.z};p.setDepthMode(Vt.disabled),p.setStencilMode(_i.disabled),p.setColorMode(l.colorModeForRenderPass()),l.setCustomLayerDefaults(),b.call(_,p.gl,M),p.setDirty(),l.setBaseState()}return}l.setCustomLayerDefaults(),p.setColorMode(l.colorModeForRenderPass()),p.setStencilMode(_i.disabled);const v=_.renderingMode==="3d"?new Vt(l.context.gl.LEQUAL,Vt.ReadWrite,l.depthRangeFor3D):l.depthModeForSublayer(0,Vt.ReadOnly);if(p.setDepthMode(v),l.transform.projection.name==="globe"){const b=l.transform.pointMerc;_.render(p.gl,l.transform.customLayerMatrix(),l.transform.getProjection(),l.transform.globeToMercatorMatrix(),s.ah(l.transform.zoom),[b.x,b.y],l.transform.pixelsPerMeterRatio)}else _.render(p.gl,l.transform.customLayerMatrix());p.setDirty(),l.setBaseState(),p.bindFramebuffer.set(null)}}else s.w("Custom layers are not yet supported with this projection. Use mercator or globe to enable usage of custom layers.")},model:function(l,t,r,c){if(l.renderPass==="opaque")return;const p=r.paint.get("model-opacity").constantOr(1);if(p===0)return;const _=r.paint.get("model-cast-shadows");if(l.renderPass==="shadow"&&(!_||l.terrain&&p<.65&&r._transitionablePaint._values["model-opacity"].value.expression instanceof s.ab))return;const v=l.shadowRenderer,b=r.paint.get("model-receive-shadows");v&&(v.useNormalOffset=!0,b||(v.enabled=!1));const I=()=>{v&&(v.useNormalOffset=!0,b||(v.enabled=!0))},M=t.getSource();if(l.renderPass==="light-beam"&&M.type!=="batched-model")return;if(M.type==="vector"||M.type==="geojson")return(function(Z,te,oe,le,pe){const ye=Z.transform;if(ye.projection.name!=="mercator")return void s.w(`Drawing 3D models for ${ye.projection.name} projection is not yet implemented`);const we=ye.getFreeCameraOptions().position;if(!Z.modelManager)return;const me=Z.modelManager;oe.modelManager=me;const _e=Z.shadowRenderer;if(!oe._unevaluatedLayout._values.hasOwnProperty("model-id"))return;const ge=oe._unevaluatedLayout._values["model-id"],Be=Object.assign({},oe.layout.get("model-id").parameters),Ce=Z.style.order.indexOf(oe.fqid);for(const nt of le){const He=te.getTile(nt).getBucket(oe);if(!He||He.projection.name!==ye.projection.name)continue;const at=He.getModelUris();at&&!He.modelsRequested&&(me.addModelsFromBucket(at,pe),He.modelsRequested=!0);const mt=Ap(nt,ye);Be.zoom=mt;const ze=ge.possiblyEvaluate(Be);if(Pu(Z,He,nt),wl.shadowUniformsInitialized=!1,wl.useSingleShadowCascade=!!_e&&_e.getMaxCascadeForTile(nt.toUnwrapped())===0,Z.renderPass==="shadow"&&_e){if(Z.currentShadowCascade===1&&He.isInsideFirstShadowMapFrustum)continue;const Ue=ye.calculatePosMatrix(nt.toUnwrapped(),ye.worldSize);if(wl.tileMatrix.set(Ue),wl.shadowTileMatrix=Float32Array.from(_e.calculateShadowPassMatrixFromMatrix(Ue)),wl.aabb.min.fill(0),wl.aabb.max[0]=wl.aabb.max[1]=s.aj,wl.aabb.max[2]=0,Hd(He,wl,Z,oe.scope))continue}const Te=1<<nt.canonical.z,Ze=[((we.x-nt.wrap)*Te-nt.canonical.x)*s.aj,(we.y*Te-nt.canonical.y)*s.aj,we.z*Te*s.aj];Z.conflationActive&&Object.keys(He.instancesPerModel).length>0&&Z.style.isLayerClipped(oe,te.getSource())&&He.updateReplacement(nt,Z.replacementSource,Ce,pe)&&(He.uploaded=!1,He.upload(Z.context));for(let Ue in He.instancesPerModel){const dt=He.instancesPerModel[Ue];dt.features.length>0&&(Ue=ze.evaluate(dt.features[0].feature,{}));const ft=me.getModel(Ue,pe);if(ft||me.hasURLBeenRequested(Ue)||He.modelUris.includes(Ue)||(He.modelUris.push(Ue),He.modelsRequested=!1),ft&&ft.uploaded)for(const xt of ft.nodes)Gd(Z,oe,xt,dt,Ze,nt,wl)}}})(l,t,r,c,M.type==="vector"?r.scope:""),void I();if(!M.loaded())return;if(M.type==="batched-model")return(function(Z,te,oe,le){oe.resetLayerRenderingStats(Z);const pe=Z.context,ye=Z.transform,we=Z.style.fog,me=Z.shadowRenderer;if(ye.projection.name!=="mercator")return void s.w(`Drawing 3D landmark models for ${ye.projection.name} projection is not yet implemented`);const _e=Z.transform.getFreeCameraOptions().position,ge=s.c1([],[_e.x,_e.y,_e.z],Z.transform.worldSize),Be=s.eq([],ge),Ce=s.bx([]),nt=s.e9(ye.center.lat,ye.zoom),He=s.bn([],[1,1,1/nt]);s.bo(Ce,Ce,Be);const at=oe.paint.get("model-opacity").constantOr(1),mt=new Vt(pe.gl.LEQUAL,Vt.ReadWrite,Z.depthRangeFor3D),ze=new Vt(pe.gl.LEQUAL,Vt.ReadOnly,Z.depthRangeFor3D),Te=new s.d6([1/0,1/0,1/0],[-1/0,-1/0,-1/0]),Ze=Z.renderPass==="shadow",Ue=Ze&&me?me.getCurrentCascadeFrustum():ye.getFrustum(ye.scaleZoom(ye.worldSize)),dt=oe.paint.get("model-front-cutoff"),ft=dt[2]<1,xt=ta(Z,oe.paint.get("model-cutoff-fade-range")),It=oe.getLayerRenderingStats();(function(Qt,oi,qt,si){const Jt=Qt.terrain?Qt.terrain.exaggeration():0,Ci=Qt.transform.zoom;for(const Fi of si){const Hi=oi.getTile(Fi).getBucket(qt);Hi&&(Hi.setFilter(qt.filter),Qt.conflationActive&&Hi.updateReplacement(Fi,Qt.replacementSource),Hi.evaluateTransform(Qt,qt),Qt.terrain&&Jt>0&&Hi.elevationUpdate(Qt.terrain,Jt,Fi,qt.source),Hi.needsReEvaluation(Qt,Ci,qt)&&Hi.evaluate(qt))}})(Z,te,oe,le),(function(){let Qt,oi,qt;ft?(Qt=le.length-1,oi=-1,qt=-1):(Qt=0,oi=le.length,qt=1);const si=new Float64Array(16),Jt=s.cx(),Ci=new s.P(0,0);for(let Fi=Qt;Fi!==oi;Fi+=qt){const Hi=le[Fi],gn=te.getTile(Hi).getBucket(oe);if(!gn||!gn.uploaded)continue;let ki=!1;me&&(ki=me.getMaxCascadeForTile(Hi.toUnwrapped())===0);const En=ye.calculatePosMatrix(Hi.toUnwrapped(),ye.worldSize),Dn=gn.modelTraits;!Ze&&ft&&(s.bi(si,En),s.ad(Jt,ge,si),Ci.x=Jt[0],Ci.y=Jt[1]);const sr=[];gn.setFilter(oe.filter);for(const Ni of gn.getNodesInfo()){if(Ni.hiddenByReplacement||!Ni.node.meshes)continue;const Sn=Ni.node;let pn=0;Z.terrain&&Sn.elevation&&(pn=Sn.elevation*Z.terrain.exaggeration());const Bn=(()=>{const Hs=Ni.aabb;return Te.min=[...Hs.min],Te.max=[...Hs.max],Te.min[2]+=pn,Te.max[2]+=pn,s.ad(Te.min,Te.min,En),s.ad(Te.max,Te.max,En),Te})(),Si=Ni.evaluatedScale;if(Si[0]<=1&&Si[1]<=1&&Si[2]<=1&&Bn.intersects(Ue)===0)continue;if(!Ze&&ft){const Hs=.16666666666666666;Ni.cameraCollisionOpacity=ge[0]>Bn.min[0]&&ge[0]<Bn.max[0]&&ge[1]>Bn.min[1]&&ge[1]<Bn.max[1]&&ge[2]*nt<Bn.max[2]&&Sn.footprint&&s.bY(Ci,Sn.footprint)?Math.max(Ni.cameraCollisionOpacity-Hs,0):Math.min(1,Ni.cameraCollisionOpacity+Hs)}const Qn=[...En],Ln=1/s.d4(Hi.canonical),zr=Sn.anchor?Sn.anchor[0]:0,Tn=Sn.anchor?Sn.anchor[1]:0;s.bo(Qn,Qn,[zr*(Si[0]-1)+Ni.evaluatedTranslation[0]*Ln,Tn*(Si[1]-1)+Ni.evaluatedTranslation[1]*Ln,pn+Ni.evaluatedTranslation[2]]),s.cn(Si,s.es)||s.cP(Qn,Qn,Si);const Nn=s.az([],Qn,Sn.matrix),tr=s.az([],ye.expandedFarZProjMatrix,Nn),ls=s.az([],ye.expandedFarZProjMatrix,Qn),pr=s.aA([],[zr,Tn,pn,1],tr)[2];Sn.hidden=!1;let ts=at;Ze||(ft&&(ts*=Ni.cameraCollisionOpacity,ts*=qf(Qn,ye,Ni.aabb,dt)),ts*=ah(xt,pr)),ts!==0?sr.push({nodeInfo:Ni,depth:pr,opacity:ts,wvpForNode:tr,wvpForTile:ls,nodeModelMatrix:Nn,tileModelMatrix:Qn}):Sn.hidden=!0}Ze||sr.sort(((Ni,Sn)=>!ft||Ni.opacity===1&&Sn.opacity===1?Ni.depth<Sn.depth?-1:1:Ni.opacity===1?-1:Sn.opacity===1?1:Ni.depth>Sn.depth?-1:1));for(const Ni of sr){const Sn=Ni.nodeInfo,pn=Sn.node;let Bn=s.az([],He,Ni.tileModelMatrix);s.az(Bn,Ce,Bn);const Si=s.bi([],Bn);s.ea(Si,Si),s.cP(Si,Si,nd),Bn=s.az(Bn,Bn,pn.matrix);const Qn=Z.renderPass==="light-beam",Ln=oe.paint.get("model-color-use-theme").constantOr("default")==="none",zr=Dn&s.ex.HasMapboxMeshFeatures,Tn=zr?0:Sn.evaluatedRMEA[0][2];for(let Nn=0;Nn<pn.meshes.length;++Nn){const tr=pn.meshes[Nn],ls=Nn===pn.lightMeshIndex;let pr=Ni.wvpForNode;if(ls){if(!Qn&&!Z.terrain&&Z.shadowRenderer){Z.currentLayer<Z.firstLightBeamLayer&&(Z.firstLightBeamLayer=Z.currentLayer);continue}pr=Ni.wvpForTile}else if(Qn)continue;const ts={defines:[]},Hs=[];if(!Ze&&me&&(me.useNormalOffset=!!tr.normalBuffer),Cu(ts.defines,Hs,tr,Z,Ln?null:oe.lut),zr||ts.defines.push("DIFFUSE_SHADED"),ki&&ts.defines.push("SHADOWS_SINGLE_CASCADE"),It&&(Ze?It.numRenderedVerticesInShadowPass+=tr.vertexArray.length:It.numRenderedVerticesInTransparentPass+=tr.vertexArray.length),Ze){id(tr,Ni.nodeModelMatrix,Z,oe);continue}let po=null;if(we){const mo=vc(Ni.nodeModelMatrix,Z.transform);if(po=new Float32Array(mo),ye.projection.name!=="globe"){const Hr=tr.aabb.min,qr=tr.aabb.max,[lr,ms]=we.getOpacityForBounds(mo,Hr[0],Hr[1],qr[0],qr[1]);ts.overrideFog=lr>=lt||ms>=lt}}const no=tr.material;let qs;no.occlusionTexture&&no.occlusionTexture.offsetScale&&(qs=no.occlusionTexture.offsetScale,ts.defines.push("OCCLUSION_TEXTURE_TRANSFORM"));const Fs=Z.getOrCreateProgram("model",ts);!Ze&&me&&me.setupShadowsFromMatrix(Ni.tileModelMatrix,Fs,me.useNormalOffset),Z.uploadCommonUniforms(pe,Fs,null,po);const Wo=no.pbrMetallicRoughness;Wo.metallicFactor=.9,Wo.roughnessFactor=.5;const aa=bu(new Float32Array(pr),new Float32Array(Bn),new Float32Array(Si),new Float32Array(pn.matrix),Z,Ni.opacity,Wo.baseColorFactor,no.emissiveFactor,Wo.metallicFactor,Wo.roughnessFactor,no,Tn,oe,[0,0,0],qs);!ls&&(Sn.hasTranslucentParts||Ni.opacity<1)&&Fs.draw(Z,pe.gl.TRIANGLES,mt,_i.disabled,ui.disabled,gi.backCCW,aa,oe.id,tr.vertexBuffer,tr.indexBuffer,tr.segments,oe.paint,Z.transform.zoom,void 0,Hs),Fs.draw(Z,pe.gl.TRIANGLES,ls?ze:mt,_i.disabled,ls||Ni.opacity<1||Sn.hasTranslucentParts?ui.alphaBlended:ui.unblended,gi.backCCW,aa,oe.id,tr.vertexBuffer,tr.indexBuffer,tr.segments,oe.paint,Z.transform.zoom,void 0,Hs)}}}})()})(l,t,r,c),void I();if(M.type!=="model")return;const L=M.getModels(),B=[],F=l.transform.getFreeCameraOptions().position,V=s.c1([],[F.x,F.y,F.z],l.transform.worldSize);s.eq(V,V);const $=[],H=[];let X=0;for(const Z of L){const te=r.paint.get("model-rotation").constantOr(null),oe=r.paint.get("model-scale").constantOr(null),le=r.paint.get("model-translation").constantOr(null);Z.computeModelMatrix(l,te,oe,le,!0,!0,!1);const pe=s.bx([]),ye=s.e9(Z.position.lat,l.transform.zoom),we=s.bn([],[1,1,1/ye]);s.bo(pe,pe,V),B.push({zScaleMatrix:we,negCameraPosMatrix:pe});for(const me of Z.nodes)jd(l.transform,me,Z.matrix,l.transform.expandedFarZProjMatrix,X,$,H);X++}if($.sort(((Z,te)=>te.depth-Z.depth)),l.renderPass!=="shadow"){if(p===1)for(const Z of H)Gc(Z,l,r,B[Z.modelIndex],_i.disabled,l.colorModeForRenderPass());else{for(const Z of H)Gc(Z,l,r,B[Z.modelIndex],_i.disabled,ui.disabled);for(const Z of H)Gc(Z,l,r,B[Z.modelIndex],l.stencilModeFor3D(),l.colorModeForRenderPass());l.resetStencilClippingMasks()}for(const Z of $)Gc(Z,l,r,B[Z.modelIndex],_i.disabled,l.colorModeForRenderPass());I()}else{for(const Z of H)id(Z.mesh,Z.nodeModelMatrix,l,r);for(const Z of $)id(Z.mesh,Z.nodeModelMatrix,l,r);I()}}},rd={line:function(l,t,r){if(l.hasElevatedBuckets=!1,l.hasNonElevatedBuckets=!1,l._unevaluatedLayout.getValue("line-elevation-reference")!==void 0||l._unevaluatedLayout.getValue("line-z-offset")!==void 0){if(t){const c=t.getVisibleCoordinates();for(const p of c){const _=t.getTile(p).getBucket(l);if(_&&(_.elevationType!=="none"?l.hasElevatedBuckets=!0:l.hasNonElevatedBuckets=!0,l.hasElevatedBuckets&&l.hasNonElevatedBuckets))break}}}else l.hasNonElevatedBuckets=!0},model:function(l,t,r){const c=t.getSource();if(!c.loaded())return;if(c.type==="vector"||c.type==="geojson")return void(r.modelManager&&r.modelManager.upload(r,c.type==="vector"?l.scope:""));if(c.type==="batched-model"||c.type!=="model")return;const p=c.getModels();for(const _ of p)_.upload(r.context)},raster:function(l,t,r){const c=t.getSource();if(!(c instanceof ol&&c.loaded()))return;const p=l.sourceLayer||c.rasterLayerIds&&c.rasterLayerIds[0];if(!p)return;const _=l.paint.get("raster-array-band")||c.getInitialBand(p);if(_==null)return;const v=t.getIds().map((b=>t.getTileByID(b)));for(const b of v)b.updateNeeded(l.id,_)&&c.prepareTile(b,p,l.id,_)},"raster-particle":function(l,t,r){const c=t.getSource();if(!(c instanceof ol&&c.loaded()))return;const p=l.sourceLayer||c.rasterLayerIds&&c.rasterLayerIds[0];if(!p)return;const _=l.paint.get("raster-particle-array-band")||c.getInitialBand(p);if(_==null)return;const v=t.getIds().map((b=>t.getTileByID(b)));for(const b of v)b.updateNeeded(l.id,_)&&c.prepareTile(b,p,l.id,_)}},sd={fill:Kt},Do={fill:function(l,t,r,c){if(!r.layout||r.layout.get("fill-elevation-reference")==="none")return;const p=l.context.gl,_=new Vt(p.LEQUAL,Vt.ReadOnly,l.depthRangeFor3D),v=new _i({func:p.ALWAYS,mask:255},255,255,p.KEEP,p.KEEP,p.REPLACE),b=l.transform.getFreeCameraOptions().position,I=l.getOrCreateProgram("elevatedStructuresDepthReconstruct");for(const M of c){const L=t.getTile(M),B=L.getBucket(r);if(!B)continue;const F=B.elevatedStructures;if(!F||F.depthSegments.segments[0].primitiveLength===0)continue;const V=Iu(M.toUnwrapped(),b),$=l.translatePosMatrix(M.projMatrix,L,r.paint.get("fill-translate"),r.paint.get("fill-translate-anchor")),H=Wl($,V,0,1,0);I.draw(l,p.TRIANGLES,_,v,ui.disabled,gi.disabled,H,r.id,F.vertexBuffer,F.indexBuffer,F.depthSegments,r.paint,l.transform.zoom)}}};class qc{constructor(t,r,c,p,_,v){this.context=new Tu(t,r),this.transform=c,this._tileTextures={},this.frameCopies=[],this.loadTimeStamps=[],this.tp=_,this._timeStamp=s.q.now(),this._averageFPS=0,this._fpsHistory=[],this._dt=0,this._debugParams={forceEnablePrecipitation:!1,showTerrainProxyTiles:!1,fpsWindow:30,continousRedraw:!1,enabledLayers:{}};const b=["fill","line","symbol","circle","heatmap","fill-extrusion","building","raster","raster-particle","hillshade","model","background","sky"];for(const M of b)this._debugParams.enabledLayers[M]=!0;_.registerParameter(this._debugParams,["Terrain"],"showTerrainProxyTiles",{},(()=>{this.style.map.triggerRepaint()})),_.registerParameter(this._debugParams,["Precipitation"],"forceEnablePrecipitation"),_.registerParameter(this._debugParams,["FPS"],"fpsWindow",{min:1,max:100,step:1}),_.registerBinding(this._debugParams,["FPS"],"continousRedraw",{readonly:!0,label:"continuous redraw"}),_.registerBinding(this,["FPS"],"_averageFPS",{readonly:!0,label:"value"}),_.registerBinding(this,["FPS"],"_averageFPS",{readonly:!0,label:"graph",view:"graph",min:0,max:200});for(const M of b)_.registerParameter(this._debugParams.enabledLayers,["Debug","Layers"],M);this.occlusionParams=new Mu(_),this.setup(),this.numSublayers=ys.maxUnderzooming+ys.maxOverzooming+1,this.depthEpsilon=1/Math.pow(2,16),this.deferredRenderGpuTimeQueries=[],this.gpuTimers={},this.frameCounter=0,this._backgroundTiles={},this.conflationActive=!1,this.replacementSource=new s.eE,this.longestCutoffRange=0,this.minCutoffZoom=0,this._fogVisible=!1,this._cachedTileFogOpacities={},this._shadowRenderer=new vm(this),this._wireframeDebugCache=new Hc,this.renderDefaultNorthPole=!0,this.renderDefaultSouthPole=!0,this.layersWithOcclusionOpacity=[];const I=new s.r({width:1,height:1},Uint8Array.of(0,0,0,0));this.emptyDepthTexture=new s.T(this.context,I,t.RGBA8),this._clippingActiveLastFrame=!1,this.scaleFactor=p,this.worldview=v}updateTerrain(t,r){const c=!!t&&!!t.terrain&&this.transform.projection.supportsTerrain;if(!(c||this._terrain&&this._terrain.enabled))return;this._terrain||(this._terrain=new Uh(this,t));const p=this._terrain;this.transform.elevation=c?p:null,p.update(t,this.transform,r),this.transform.elevation&&!p.enabled&&(this.transform.elevation=null)}_updateFog(t){const r=t.fog;if(!r||this.transform.projection.name==="globe"||r.getOpacity(this.transform.pitch)<1||r.properties.get("horizon-blend")<.03)return void(this.transform.fogCullDistSq=null);const[c,p]=r.getFovAdjustedRange(this.transform._fov);if(c>p)return void(this.transform.fogCullDistSq=null);const _=c+.78*(p-c);this.transform.fogCullDistSq=_*_}get terrain(){return this.transform._terrainEnabled()&&this._terrain&&this._terrain.enabled||this._forceTerrainMode?this._terrain:null}get forceTerrainMode(){return this._forceTerrainMode}set forceTerrainMode(t){t&&!this._terrain&&(this._terrain=new Uh(this,this.style)),this._forceTerrainMode=t}get shadowRenderer(){return this._shadowRenderer&&this._shadowRenderer.enabled?this._shadowRenderer:null}get wireframeDebugCache(){return this._wireframeDebugCache}resize(t,r){if(this.width=t*s.q.devicePixelRatio,this.height=r*s.q.devicePixelRatio,this.context.viewport.set([0,0,this.width,this.height]),this.style)for(const c of this.style.order)this.style._mergedLayers[c].resize()}setup(){const t=this.context,r=new s.ba;r.emplaceBack(0,0),r.emplaceBack(s.aj,0),r.emplaceBack(0,s.aj),r.emplaceBack(s.aj,s.aj),this.tileExtentBuffer=t.createVertexBuffer(r,s.bc.members),this.tileExtentSegments=s.bd.simpleSegment(0,0,4,2);const c=new s.ba;c.emplaceBack(0,0),c.emplaceBack(s.aj,0),c.emplaceBack(0,s.aj),c.emplaceBack(s.aj,s.aj),this.debugBuffer=t.createVertexBuffer(c,s.bc.members),this.debugSegments=s.bd.simpleSegment(0,0,4,5);const p=new s.ba;p.emplaceBack(-1,-1),p.emplaceBack(1,-1),p.emplaceBack(-1,1),p.emplaceBack(1,1),this.viewportBuffer=t.createVertexBuffer(p,s.bc.members),this.viewportSegments=s.bd.simpleSegment(0,0,4,2);const _=new s.aZ;_.emplaceBack(0,0,0,0),_.emplaceBack(s.aj,0,s.aj,0),_.emplaceBack(0,s.aj,0,s.aj),_.emplaceBack(s.aj,s.aj,s.aj,s.aj),this.mercatorBoundsBuffer=t.createVertexBuffer(_,s.bf.members),this.mercatorBoundsSegments=s.bd.simpleSegment(0,0,4,2);const v=new s.a_;v.emplaceBack(0,1,2),v.emplaceBack(2,1,3),this.quadTriangleIndexBuffer=t.createIndexBuffer(v);const b=new s.bb;for(const M of[0,1,3,2,0])b.emplaceBack(M);this.debugIndexBuffer=t.createIndexBuffer(b),this.emptyTexture=new s.T(t,new s.r({width:1,height:1},Uint8Array.of(0,0,0,0)),t.gl.RGBA8),this.identityMat=s.bz();const I=this.context.gl;this.stencilClearMode=new _i({func:I.ALWAYS,mask:0},0,255,I.ZERO,I.ZERO,I.ZERO),this.loadTimeStamps.push(performance.now())}getMercatorTileBoundsBuffers(){return{tileBoundsBuffer:this.mercatorBoundsBuffer,tileBoundsIndexBuffer:this.quadTriangleIndexBuffer,tileBoundsSegments:this.mercatorBoundsSegments}}getTileBoundsBuffers(t){return t._makeTileBoundsBuffers(this.context,this.transform.projection),t._tileBoundsBuffer?{tileBoundsBuffer:t._tileBoundsBuffer,tileBoundsIndexBuffer:t._tileBoundsIndexBuffer,tileBoundsSegments:t._tileBoundsSegments}:this.getMercatorTileBoundsBuffers()}clearStencil(){const t=this.context.gl;this.nextStencilID=1,this.currentStencilSource=void 0,this._tileClippingMaskIDs={},this.getOrCreateProgram("clippingMask").draw(this,t.TRIANGLES,Vt.disabled,this.stencilClearMode,ui.disabled,gi.disabled,vo(this.identityMat),"$clipping",this.viewportBuffer,this.quadTriangleIndexBuffer,this.viewportSegments)}resetStencilClippingMasks(){this.terrain||(this.currentStencilSource=void 0,this._tileClippingMaskIDs={})}_renderTileClippingMasks(t,r,c){if(!r||this.currentStencilSource===r.id||!t.isTileClipped()||!c||c.length===0)return;if(this._tileClippingMaskIDs&&!this.terrain){let b=!1;for(const I of c)if(this._tileClippingMaskIDs[I.key]===void 0){b=!0;break}if(!b)return}this.currentStencilSource=r.id;const p=this.context,_=p.gl;this.nextStencilID+c.length>256&&this.clearStencil(),p.setColorMode(ui.disabled),p.setDepthMode(Vt.disabled);const v=this.getOrCreateProgram("clippingMask");this._tileClippingMaskIDs={};for(const b of c){const I=r.getTile(b),M=this._tileClippingMaskIDs[b.key]=this.nextStencilID++,{tileBoundsBuffer:L,tileBoundsIndexBuffer:B,tileBoundsSegments:F}=this.getTileBoundsBuffers(I);v.draw(this,_.TRIANGLES,Vt.disabled,new _i({func:_.ALWAYS,mask:0},M,255,_.KEEP,_.KEEP,_.REPLACE),ui.disabled,gi.disabled,vo(b.projMatrix),"$clipping",L,B,F)}}stencilModeFor3D(){this.currentStencilSource=void 0,this.nextStencilID+1>256&&this.clearStencil();const t=this.nextStencilID++,r=this.context.gl;return new _i({func:r.NOTEQUAL,mask:255},t,255,r.KEEP,r.KEEP,r.REPLACE)}stencilModeForClipping(t){if(this.terrain)return this.terrain.stencilModeForRTTOverlap(t);const r=this.context.gl;return new _i({func:r.EQUAL,mask:255},this._tileClippingMaskIDs[t.key],0,r.KEEP,r.KEEP,r.REPLACE)}stencilConfigForOverlap(t){const r=this.context.gl,c=t.sort(((v,b)=>b.overscaledZ-v.overscaledZ)),p=c[c.length-1].overscaledZ,_=c[0].overscaledZ-p+1;if(_>1){this.currentStencilSource=void 0,this.nextStencilID+_>256&&this.clearStencil();const v={};for(let b=0;b<_;b++)v[b+p]=new _i({func:r.GEQUAL,mask:255},b+this.nextStencilID,255,r.KEEP,r.KEEP,r.REPLACE);return this.nextStencilID+=_,[v,c]}return[{[p]:_i.disabled},c]}colorModeForRenderPass(){const t=this.context.gl;return this._showOverdrawInspector?new ui([t.CONSTANT_COLOR,t.ONE,t.CONSTANT_COLOR,t.ONE],new s.am(.125,.125,.125,0),[!0,!0,!0,!0]):this.renderPass==="opaque"?ui.unblended:ui.alphaBlended}colorModeForDrapableLayerRenderPass(t){const r=this.context.gl;return this.style&&this.style.enable3dLights()&&this.terrain&&this.terrain.renderingToTexture&&this.renderPass==="translucent"?new ui([r.ONE,r.ONE_MINUS_SRC_ALPHA,r.CONSTANT_ALPHA,r.ONE_MINUS_SRC_ALPHA],new s.am(0,0,0,t===void 0?0:t),[!0,!0,!0,!0]):this.colorModeForRenderPass()}depthModeForSublayer(t,r,c,p=!1){if(this.depthOcclusion)return new Vt(this.context.gl.GREATER,Vt.ReadOnly,this.depthRangeFor3D);if(!this.opaquePassEnabledForLayer()&&!p)return Vt.disabled;const _=1-((1+this.currentLayer)*this.numSublayers+t)*this.depthEpsilon;return new Vt(c||this.context.gl.LEQUAL,r,[_,_])}opaquePassEnabledForLayer(){return this.currentLayer<this.opaquePassCutoff}blitDepth(){const t=this.context.gl,r=Math.ceil(this.width),c=Math.ceil(this.height),p=this.context.bindFramebuffer.get(),_=t.getParameter(t.TEXTURE_BINDING_2D);this.depthFBO&&this.depthFBO.width===r&&this.depthFBO.height===c||(this.depthFBO&&(this.depthFBO.destroy(),this.depthFBO=void 0,this.depthTexture=void 0),r!==0&&c!==0&&(this.depthFBO=new Zl(this.context,r,c,!1,"texture"),this.depthTexture=new s.T(this.context,{width:r,height:c,data:null},t.DEPTH24_STENCIL8),this.depthFBO.depthAttachment.set(this.depthTexture.texture))),this.context.bindFramebuffer.set(p),t.bindTexture(t.TEXTURE_2D,_),this.depthFBO&&(t.bindFramebuffer(t.READ_FRAMEBUFFER,null),t.bindFramebuffer(t.DRAW_FRAMEBUFFER,this.depthFBO.framebuffer),t.blitFramebuffer(0,0,r,c,0,0,r,c,t.DEPTH_BUFFER_BIT,t.NEAREST),t.bindFramebuffer(t.FRAMEBUFFER,this.context.bindFramebuffer.current))}updateAverageFPS(){this._fpsHistory.push(this._dt===0?0:1e3/this._dt),this._fpsHistory.length>this._debugParams.fpsWindow&&this._fpsHistory.splice(0,this._fpsHistory.length-this._debugParams.fpsWindow),this._averageFPS=Math.round(this._fpsHistory.reduce(((t,r)=>t+r/this._fpsHistory.length),0))}render(t,r){const c=s.q.now();this._dt=c-this._timeStamp,this._timeStamp=c,this._wireframeDebugCache.update(this.frameCounter),this._debugParams.continousRedraw=t.map.repaint,this.style=t,this.options=r;const p=this.style._mergedLayers,_=!(!this.terrain||!this.terrain.enabled),v=()=>this.style._getOrder(_).filter((ze=>{const Te=p[ze];return!(Te.type in this._debugParams.enabledLayers)||this._debugParams.enabledLayers[Te.type]}));let b=v(),I=!1,M=!1,L=null;for(const ze of b){const Te=p[ze];Te.type==="circle"?I=!0:Te.type==="building"?L=Te:Te.type==="symbol"&&(Te.hasInitialOcclusionOpacityProperties?M=!0:I=!0)}let B=b.map((ze=>p[ze]));const F=this.style._mergedSourceCaches;this.imageManager=t.imageManager,this.modelManager=t.modelManager,this.symbolFadeChange=t.placement.symbolFadeChange(s.q.now()),this.imageManager.beginFrame();let V=0,$=!1;for(const ze in F){const Te=F[ze];Te.used&&(Te.prepare(this.context),Te.getSource().usedInConflation&&++V)}let H=!1;for(const ze of B)ze.isHidden(this.transform.zoom)||(ze.type==="clip"&&(H=!0),this.prepareLayer(ze));const X={},Z={},te={},oe={},le={};for(const ze in F){const Te=F[ze];X[ze]=Te.getVisibleCoordinates(),Z[ze]=X[ze].slice().reverse(),te[ze]=Te.getVisibleCoordinates(!0).reverse(),oe[ze]=Te.getShadowCasterCoordinates(),le[ze]=Te.sortCoordinatesByDistance(X[ze])}const pe=ze=>{const Te=this.style.getLayerSourceCache(ze);return Te&&Te.used?Te.getSource():null};if(V||H||this._clippingActiveLastFrame){const ze=[],Te=[];let Ze=0;for(const Ue of B)this.isSourceForClippingOrConflation(Ue,pe(Ue))&&(ze.push(Ue),Te.push(Ze)),Ze++;if(ze&&(H||ze.length>1)||this._clippingActiveLastFrame){H=!1;const Ue=[];for(let dt=0;dt<ze.length;dt++){const ft=ze[dt],xt=Te[dt],It=this.style.getLayerSourceCache(ft);if(!It||!It.used||!It.getSource().usedInConflation&&ft.type!=="clip"&&ft.type!=="building")continue;let Qt=s.eF,oi=s.bW.None;const qt=[];let si=!0;if(ft.type==="building")Qt=s.eH;else if(ft.type==="clip"){Qt=xt;for(const Jt of ft.layout.get("clip-layer-types"))oi|=Jt==="model"?s.bW.Model:Jt==="symbol"?s.bW.Symbol:s.bW.FillExtrusion;for(const Jt of ft.layout.get("clip-layer-scope"))qt.push(Jt);ft.isHidden(this.transform.zoom)?si=!1:H=!0}si&&Ue.push({layer:ft.fqid,cache:It,order:Qt,clipMask:oi,clipScope:qt})}this.replacementSource.setSources(Ue),$=!0}}this._clippingActiveLastFrame=H,$||this.replacementSource.clear(),this.conflationActive=$,this.minCutoffZoom=0,this.longestCutoffRange=0,this.opaquePassCutoff=1/0,this._lastOcclusionLayer=-1,this.layersWithOcclusionOpacity=[];for(let ze=0;ze<B.length;ze++){const Te=B[ze],Ze=Te.cutoffRange();if(this.longestCutoffRange=Math.max(Ze,this.longestCutoffRange),Ze>0){const Ue=pe(Te);Ue&&(this.minCutoffZoom=Math.max(Ue.minzoom,this.minCutoffZoom)),Te.minzoom&&(this.minCutoffZoom=Math.max(Te.minzoom,this.minCutoffZoom))}Te.is3D(_)&&(this.opaquePassCutoff===1/0&&(this.opaquePassCutoff=ze),this._lastOcclusionLayer=ze)}const ye=this.style&&this.style.fog;ye?(this._fogVisible=ye.getOpacity(this.transform.pitch)!==0,this._fogVisible&&this.transform.projection.name!=="globe"&&(this._fogVisible=ye.isVisibleOnFrustum(this.transform.cameraFrustum))):this._fogVisible=!1,this._cachedTileFogOpacities={},this.terrain&&(this.terrain.updateTileBinding(te),this.opaquePassCutoff=0,b=v(),B=b.map((ze=>p[ze])));const we=this._shadowRenderer;if(we){we.updateShadowParameters(this.transform,this.style.directionalLight);for(const ze in F)for(const Te of X[ze]){let Ze={min:0,max:0};this.terrain&&(Ze=this.terrain.getMinMaxForTile(Te)||Ze),we.addShadowReceiver(Te.toUnwrapped(),Ze.min,Ze.max)}}this.transform.projection.name!=="globe"||this.globeSharedBuffers||(this.globeSharedBuffers=new s.eG(this.context)),this.style.fog&&this.transform.projection.supportsFog?(this._atmosphere||(this._atmosphere=new Le(this)),this._atmosphere.update(this)):this._atmosphere&&(this._atmosphere.destroy(),this._atmosphere=void 0);const me=this._debugParams.forceEnablePrecipitation||!(!this.style||!this.style.snow),_e=this._debugParams.forceEnablePrecipitation||!(!this.style||!this.style.rain);if(me&&!this._snow&&(this._snow=new $f(this)),!me&&this._snow&&(this._snow.destroy(),delete this._snow),_e&&!this._rain&&(this._rain=new Du(this)),!_e&&this._rain&&(this._rain.destroy(),delete this._rain),this._snow&&this._snow.update(this),this._rain&&this._rain.update(this),L){this.buildingTileBorderManager||(this.buildingTileBorderManager=new Ma);const ze=this.style.getLayerSourceCache(L);this.buildingTileBorderManager.updateBorders(ze,L)}if(!ao.has(this.context.gl))return;this.renderPass="offscreen";for(const ze of B){const Te=t.getLayerSourceCache(ze);if(!ze.hasOffscreenPass()||ze.isHidden(this.transform.zoom))continue;const Ze=Te?Z[Te.id]:void 0;(ze.type==="custom"||ze.type==="raster"||ze.type==="raster-particle"||ze.isSky()||Ze&&Ze.length)&&this.renderLayer(this,Te,ze,Ze)}this.depthRangeFor3D=[0,1-(B.length+2)*this.numSublayers*this.depthEpsilon],this._shadowRenderer&&(this.renderPass="shadow",this._shadowRenderer.drawShadowPass(this.style,oe)),this.context.bindFramebuffer.set(null),this.context.viewport.set([0,0,this.width,this.height]);const ge=this.transform.projection.name==="globe"||this.transform.isHorizonVisible(),Be=(()=>{if(r.showOverdrawInspector)return s.am.black;const ze=this.style.fog;if(ze&&this.transform.projection.supportsFog){const Te=this.style.getLut(ze.scope);if(!ge){const Ze=ze.properties.get("color-use-theme")==="none",Ue=ze.properties.get("color").toNonPremultipliedRenderColor(Ze?null:Te).toArray01();return new s.am(...Ue)}if(ge){const Ze=ze.properties.get("space-color-use-theme")==="none",Ue=ze.properties.get("space-color").toNonPremultipliedRenderColor(Ze?null:Te).toArray01();return new s.am(...Ue)}}return s.am.transparent})();if(this.context.clear({color:Be,depth:1}),this.clearStencil(),this._showOverdrawInspector=r.showOverdrawInspector,this.renderPass="opaque",this.style.fog&&this.transform.projection.supportsFog&&this._atmosphere&&!this._showOverdrawInspector&&ge&&this._atmosphere.drawStars(this,this.style.fog),!this.terrain)for(this.currentLayer=b.length-1;this.currentLayer>=0;this.currentLayer--){const ze=B[this.currentLayer],Te=t.getLayerSourceCache(ze);if(ze.isSky())continue;const Ze=Te?(ze.is3D(_)?le:Z)[Te.id]:void 0;this._renderTileClippingMasks(ze,Te,Ze),this.renderLayer(this,Te,ze,Ze)}if(this.style.fog&&this.transform.projection.supportsFog&&this._atmosphere&&!this._showOverdrawInspector&&ge&&this._atmosphere.drawAtmosphereGlow(this,this.style.fog),this.renderPass="sky",(!this._atmosphere||s.ah(this.transform.zoom)>0)&&(this.transform.projection.name==="globe"||this.transform.isHorizonVisible()))for(this.currentLayer=0;this.currentLayer<b.length;this.currentLayer++){const ze=B[this.currentLayer],Te=t.getLayerSourceCache(ze);ze.isSky()&&this.renderLayer(this,Te,ze,Te?Z[Te.id]:void 0)}function Ce(ze,Te){let Ze;return Te&&(Ze=(ze.type==="symbol"?te:ze.is3D(_)?le:Z)[Te.id]),Ze}if(this.renderPass="translucent",this.transform.projection.name==="globe"){for(this.renderElevatedRasterBackface=!0,this.currentLayer=0;this.currentLayer<b.length;){const ze=B[this.currentLayer];if(ze.type==="raster"||ze.type==="raster-particle"){const Te=t.getLayerSourceCache(ze);this.renderLayer(this,Te,ze,Ce(ze,Te))}++this.currentLayer}this.renderElevatedRasterBackface=!1}this.currentLayer=0,this.firstLightBeamLayer=Number.MAX_SAFE_INTEGER;let nt=0;we&&(nt=we.getShadowCastingLayerCount());let He=!1,at=-1;for(let ze=0;ze<b.length;++ze){const Te=B[ze];Te.isHidden(this.transform.zoom)||Te.is3D(_)&&(at=ze)}M&&at===-1&&(I=!0);let mt=!1;for(;this.currentLayer<b.length;){const ze=B[this.currentLayer],Te=t.getLayerSourceCache(ze);if(ze.isSky())++this.currentLayer;else if(this.terrain&&this.style.isLayerDraped(ze)){if(ze.isHidden(this.transform.zoom)){++this.currentLayer;continue}this.currentLayer=this.terrain.renderBatch(this.currentLayer),this._lastOcclusionLayer=Math.max(this.currentLayer,this._lastOcclusionLayer)}else{if(!mt&&ze.is3D(_)&&!_){const Ze=this.currentLayer,Ue=dt=>{for(this.currentLayer=0;this.currentLayer<B.length;this.currentLayer++){const ft=B[this.currentLayer];if(sd[ft.type]){const xt=this.style.getLayerSourceCache(ft);sd[ft.type](this,xt,ft,Ce(ft,xt),dt)}}};Ue("initialize"),Ue("reset"),this.currentLayer=Ze,mt=!0}if(I&&!He&&this.terrain&&!this.transform.isOrthographic&&(He=!0,this.blitDepth()),M&&at!==-1&&this.currentLayer===at+1&&!this.transform.isOrthographic&&this.blitDepth(),this.terrain||this._renderTileClippingMasks(ze,Te,Te?X[Te.id]:void 0),this.renderLayer(this,Te,ze,Ce(ze,Te)),!this.terrain&&we&&nt>0&&ze.hasShadowPass()&&--nt==0){{this.clearStencil(),this.resetStencilClippingMasks();const Ze=this.currentLayer;for(this.currentLayer=0;this.currentLayer<B.length;this.currentLayer++){const Ue=B[this.currentLayer];if(Do[Ue.type]){const dt=this.style.getLayerSourceCache(Ue);Do[Ue.type](this,dt,Ue,Ce(Ue,dt))}}this.currentLayer=Ze}if(we.drawGroundShadows(),this.firstLightBeamLayer<=this.currentLayer){const Ze=this.currentLayer;for(this.renderPass="light-beam",this.currentLayer=this.firstLightBeamLayer;this.currentLayer<=Ze;this.currentLayer++){const Ue=B[this.currentLayer];if(!Ue.hasLightBeamPass())continue;const dt=t.getLayerSourceCache(Ue);this.renderLayer(this,dt,Ue,dt?Z[dt.id]:void 0)}this.currentLayer=Ze,this.renderPass="translucent"}}if(this.currentLayer>=this._lastOcclusionLayer&&this.layersWithOcclusionOpacity.length>0){const Ze=this.currentLayer;this.depthOcclusion=!0;for(const Ue of this.layersWithOcclusionOpacity){this.currentLayer=Ue;const dt=B[this.currentLayer],ft=t.getLayerSourceCache(dt),xt=ft?Z[ft.id]:void 0;this.terrain||this._renderTileClippingMasks(dt,ft,ft?X[ft.id]:void 0),this.renderLayer(this,ft,dt,xt)}this.depthOcclusion=!1,this.currentLayer=Ze,this.renderPass="translucent",this.layersWithOcclusionOpacity=[]}++this.currentLayer}}if(this.terrain&&this.terrain.postRender(),this._snow&&this._snow.draw(this),this._rain&&this._rain.draw(this),this.options.showTileBoundaries||this.options.showQueryGeometry||this.options.showTileAABBs){let ze=null;B.forEach((Te=>{const Ze=t.getLayerSourceCache(Te);Ze&&!Te.isHidden(this.transform.zoom)&&Ze.getVisibleCoordinates().length&&(!ze||ze.getSource().maxzoom<Ze.getSource().maxzoom)&&(ze=Ze)})),ze&&this.options.showTileBoundaries&&Ra(this,ze,ze.getVisibleCoordinates(),s.am.red,!1,this.options.showParseStatus)}this.terrain&&this._debugParams.showTerrainProxyTiles&&Ra(this,this.terrain.proxySourceCache,this.terrain.proxyCoords,new s.am(1,.8,.1,1),!0,this.options.showParseStatus),this.options.showPadding&&(function(ze){const Te=ze.transform.padding;yl(ze,ze.transform.height-(Te.top||0),3,Vd),yl(ze,Te.bottom||0,3,ps),hs(ze,Te.left||0,3,oh),hs(ze,ze.transform.width-(Te.right||0),3,ed);const Ze=ze.transform.centerPoint;(function(Ue,dt,ft,xt){Ts(Ue,dt-1,ft-10,2,20,xt),Ts(Ue,dt-10,ft-1,20,2,xt)})(ze,Ze.x,ze.transform.height-Ze.y,Ud)})(this),this.context.setDefault(),this.frameCounter=(this.frameCounter+1)%Number.MAX_SAFE_INTEGER,this.tileLoaded&&this.options.speedIndexTiming&&(this.loadTimeStamps.push(performance.now()),this.saveCanvasCopy()),$||(this.conflationActive=!1)}prepareLayer(t){this.gpuTimingStart(t);const{unsupportedLayers:r}=this.transform.projection,c=!r||!r.includes(t.type);if(rd[t.type]&&(c||this.terrain&&t.type==="custom")){const p=this.style.getLayerSourceCache(t);rd[t.type](t,p,this)}this.gpuTimingEnd()}renderLayer(t,r,c,p){c.isHidden(this.transform.zoom)||(c.type==="background"||c.type==="sky"||c.type==="custom"||c.type==="model"||c.type==="raster"||c.type==="raster-particle"||p&&p.length)&&(this.id=c.id,this.gpuTimingStart(c),t.transform.projection.unsupportedLayers&&t.transform.projection.unsupportedLayers.includes(c.type)&&(!t.terrain||c.type!=="custom")||c.type==="clip"||Wd[c.type](t,r,c,p,this.style.placement.variableOffsets,this.options.isInitialLoad),this.gpuTimingEnd())}gpuTimingStart(t){if(!this.options.gpuTiming)return;const r=this.context.extTimerQuery,c=this.context.gl;let p=this.gpuTimers[t.id];p||(p=this.gpuTimers[t.id]={calls:0,cpuTime:0,query:c.createQuery()}),p.calls++,c.beginQuery(r.TIME_ELAPSED_EXT,p.query)}gpuTimingDeferredRenderStart(){if(this.options.gpuTimingDeferredRender){const t=this.context.extTimerQuery,r=this.context.gl,c=r.createQuery();this.deferredRenderGpuTimeQueries.push(c),r.beginQuery(t.TIME_ELAPSED_EXT,c)}}gpuTimingDeferredRenderEnd(){this.options.gpuTimingDeferredRender&&this.context.gl.endQuery(this.context.extTimerQuery.TIME_ELAPSED_EXT)}gpuTimingEnd(){this.options.gpuTiming&&this.context.gl.endQuery(this.context.extTimerQuery.TIME_ELAPSED_EXT)}collectGpuTimers(){const t=this.gpuTimers;return this.gpuTimers={},t}collectDeferredRenderGpuQueries(){const t=this.deferredRenderGpuTimeQueries;return this.deferredRenderGpuTimeQueries=[],t}queryGpuTimers(t){const r={};for(const c in t){const p=t[c],_=this.context.extTimerQuery,v=_.getQueryParameter(p.query,this.context.gl.QUERY_RESULT)/1e6;_.deleteQueryEXT(p.query),r[c]=v}return r}queryGpuTimeDeferredRender(t){if(!this.options.gpuTimingDeferredRender)return 0;const r=this.context.gl;let c=0;for(const p of t)c+=r.getQueryParameter(p,r.QUERY_RESULT)/1e6,r.deleteQuery(p);return c}translatePosMatrix(t,r,c,p,_){if(!c[0]&&!c[1])return t;const v=_?p==="map"?this.transform.angle:0:p==="viewport"?-this.transform.angle:0;if(v){const M=Math.sin(v),L=Math.cos(v);c=[c[0]*L-c[1]*M,c[0]*M+c[1]*L]}const b=[_?c[0]:s.aw(r,c[0],this.transform.zoom),_?c[1]:s.aw(r,c[1],this.transform.zoom),0],I=new Float32Array(16);return s.bo(I,t,b),I}saveTileTexture(t){if(t.context!==this.context)return;const r=t.size[0],c=this._tileTextures[r];c?c.push(t):this._tileTextures[r]=[t]}getTileTexture(t){const r=this._tileTextures[t];return r&&r.length>0?r.pop():null}terrainRenderModeElevated(){return this.style&&!!this.style.getTerrain()&&!!this.terrain&&!this.terrain.renderingToTexture||this.forceTerrainMode}linearFloatFilteringSupported(){return this.context.extTextureFloatLinear!=null}currentGlobalDefines(t,r,c){const p=c===void 0?this.terrain&&this.terrain.renderingToTexture:c,_=[];return this.style&&this.style.enable3dLights()&&(t==="globeRaster"||t==="terrainRaster"?(_.push("LIGHTING_3D_MODE"),_.push("LIGHTING_3D_ALPHA_EMISSIVENESS")):p||_.push("LIGHTING_3D_MODE")),this.renderPass==="shadow"&&(this._shadowMapDebug||_.push("DEPTH_TEXTURE")),this.terrainRenderModeElevated()&&(_.push("TERRAIN"),this.linearFloatFilteringSupported()&&_.push("TERRAIN_DEM_FLOAT_FORMAT")),this.transform.projection.name==="globe"&&_.push("GLOBE"),!this._fogVisible||p||r!==void 0&&!r||_.push("FOG","FOG_DITHERING"),p&&_.push("RENDER_TO_TEXTURE"),this._showOverdrawInspector&&_.push("OVERDRAW_INSPECTOR"),_}getOrCreateProgram(t,r){this.cache=this.cache||{};const c=r&&r.defines||[],p=r&&r.config,_=this.currentGlobalDefines(t,r&&r.overrideFog,r&&r.overrideRtt).concat(c),v=Za.cacheKey(du[t],t,_,p);return this.cache[v]||(this.cache[v]=new Za(this.context,t,du[t],p,Hf[t],_)),this.cache[v]}setCustomLayerDefaults(){this.context.unbindVAO(),this.context.cullFace.setDefault(),this.context.frontFace.setDefault(),this.context.cullFaceSide.setDefault(),this.context.activeTexture.setDefault(),this.context.pixelStoreUnpack.setDefault(),this.context.pixelStoreUnpackPremultiplyAlpha.setDefault(),this.context.pixelStoreUnpackFlipY.setDefault()}setBaseState(){const t=this.context.gl;this.context.cullFace.set(!1),this.context.viewport.set([0,0,this.width,this.height]),this.context.blendEquation.set(t.FUNC_ADD)}initDebugOverlayCanvas(){this.debugOverlayCanvas==null&&(this.debugOverlayCanvas=document.createElement("canvas"),this.debugOverlayCanvas.width=512,this.debugOverlayCanvas.height=512,this.debugOverlayTexture=new s.T(this.context,this.debugOverlayCanvas,this.context.gl.RGBA8))}destroy(){this._terrain&&this._terrain.destroy(),this._atmosphere&&(this._atmosphere.destroy(),this._atmosphere=void 0),this.globeSharedBuffers&&this.globeSharedBuffers.destroy(),this.emptyTexture.destroy(),this.debugOverlayTexture&&this.debugOverlayTexture.destroy(),this._wireframeDebugCache.destroy(),this.depthFBO&&(this.depthFBO.destroy(),this.depthFBO=void 0,this.depthTexture=void 0),this.emptyDepthTexture&&this.emptyDepthTexture.destroy()}prepareDrawTile(){this.terrain&&this.terrain.prepareDrawTile()}uploadCommonLightUniforms(t,r){if(this.style.enable3dLights()){const c=this.style.directionalLight,p=this.style.ambientLight;if(c&&p){const _=((v,b,I)=>{const M=v.properties.get("direction"),L=v.properties.get("color-use-theme")==="none",B=v.properties.get("color").toNonPremultipliedRenderColor(L?null:I.getLut(v.scope)).toArray01(),F=v.properties.get("intensity"),V=b.properties.get("color-use-theme")==="none",$=b.properties.get("color").toNonPremultipliedRenderColor(V?null:I.getLut(b.scope)).toArray01(),H=b.properties.get("intensity"),X=[M.x,M.y,M.z],Z=s.dI($,H),te=s.dI(B,F);return{u_lighting_ambient_color:Z,u_lighting_directional_dir:X,u_lighting_directional_color:te,u_ground_radiance:Ld(X,te,Z)}})(c,p,this.style);r.setLightsUniformValues(t,_)}}}uploadCommonUniforms(t,r,c,p,_){if(this.uploadCommonLightUniforms(t,r),this.terrain&&this.terrain.renderingToTexture)return;const v=this.style.fog;if(v){const b=v.getOpacity(this.transform.pitch),I=((M,L,B,F,V,$,H,X,Z,te,oe,le)=>{const pe=M.transform,ye=L.properties.get("color-use-theme")==="none",we=L.properties.get("color").toNonPremultipliedRenderColor(ye?null:M.style.getLut(L.scope)).toArray01();we[3]=F;const me=M.frameCounter/1e3%1,[_e,ge]=L.properties.get("vertical-range");return{u_fog_matrix:B?pe.calculateFogTileMatrix(B):le||M.identityMat,u_fog_range:L.getFovAdjustedRange(pe._fov),u_fog_color:we,u_fog_horizon_blend:L.properties.get("horizon-blend"),u_fog_vertical_limit:[Math.min(_e,ge),ge],u_fog_temporal_offset:me,u_frustum_tl:V,u_frustum_tr:$,u_frustum_br:H,u_frustum_bl:X,u_globe_pos:Z,u_globe_radius:te,u_viewport:oe,u_globe_transition:s.ah(pe.zoom),u_is_globe:+(pe.projection.name==="globe")}})(this,v,c,b,this.transform.frustumCorners.TL,this.transform.frustumCorners.TR,this.transform.frustumCorners.BR,this.transform.frustumCorners.BL,this.transform.globeCenterInViewSpace,this.transform.globeRadius,[this.transform.width*s.q.devicePixelRatio,this.transform.height*s.q.devicePixelRatio],p);r.setFogUniformValues(t,I)}_&&r.setCutoffUniformValues(t,_.uniformValues)}setTileLoadedFlag(t){this.tileLoaded=t}saveCanvasCopy(){const t=this.canvasCopy();t&&(this.frameCopies.push(t),this.tileLoaded=!1)}canvasCopy(){const t=this.context.gl,r=t.createTexture();return t.bindTexture(t.TEXTURE_2D,r),t.copyTexImage2D(t.TEXTURE_2D,0,t.RGBA,0,0,t.drawingBufferWidth,t.drawingBufferHeight,0),r}getCanvasCopiesAndTimestamps(){return{canvasCopies:this.frameCopies,timeStamps:this.loadTimeStamps}}averageElevationNeedsEasing(){if(!this.transform._elevation)return!1;const t=this.style&&this.style.fog;return!!t&&t.getOpacity(this.transform.pitch)!==0}getBackgroundTiles(){const t=this._backgroundTiles,r=this._backgroundTiles={},c=this.transform.coveringTiles({tileSize:512});for(const p of c)r[p.key]=t[p.key]||new Ol(p,512,this.transform.tileZoom,this,void 0,this.worldview);return r}clearBackgroundTiles(){this._backgroundTiles={}}isSourceForClippingOrConflation(t,r){return!(!t.is3D(!(!this.terrain||!this.terrain.enabled))||t.type!=="clip"&&t.type!=="building"&&(t.minzoom&&t.minzoom>this.transform.zoom||(this.style._clipLayerPresent||t.sourceLayer!=="building"&&t.sourceLayer!=="procedural_buildings")&&(!r||r.type!=="batched-model")))}isTileAffectedByFog(t){if(!this.style||!this.style.fog)return!1;if(this.transform.projection.name==="globe")return!0;let r=this._cachedTileFogOpacities[t.key];return r||(this._cachedTileFogOpacities[t.key]=r=this.style.fog.getOpacityForTile(t)),r[0]>=lt||r[1]>=lt}setupDepthForOcclusion(t,r,c){const p=this.context,_=p.gl,v=!!c;var b;c||(c={u_dem:2,u_dem_prev:4,u_dem_tl:[0,0],u_dem_tl_prev:[0,0],u_dem_scale:0,u_dem_scale_prev:0,u_dem_size:0,u_dem_lerp:1,u_depth:3,u_depth_size_inv:[0,0],u_depth_range_unpack:[0,1],u_occluder_half_size:16,u_occlusion_depth_offset:-1e-4,u_exaggeration:0}),p.activeTexture.set(_.TEXTURE3),t&&this.depthFBO&&this.depthTexture?(this.depthTexture.bind(_.NEAREST,_.CLAMP_TO_EDGE),c.u_depth_size_inv=[1/this.depthFBO.width,1/this.depthFBO.height],c.u_depth_range_unpack=[2/((b=this.depthRangeFor3D)[1]-b[0]),-1-2*b[0]/(b[1]-b[0])],c.u_occluder_half_size=.5*this.occlusionParams.occluderSize,c.u_occlusion_depth_offset=this.occlusionParams.depthOffset):this.emptyDepthTexture.bind(_.NEAREST,_.CLAMP_TO_EDGE),p.activeTexture.set(_.TEXTURE0),v||r.setTerrainUniformValues(p,c)}}function uh(l,t){let r=!1,c=null;const p=()=>{c=null,r&&(l(),c=setTimeout(p,t),r=!1)};return()=>(r=!0,c||p(),c)}class Zd{constructor(t){this._hashName=t&&encodeURIComponent(t),s.aV(["_getCurrentHash","_onHashChange","_updateHash"],this),this._updateHash=uh(this._updateHashUnthrottled.bind(this),300)}addTo(t){return this._map=t,window.addEventListener("hashchange",this._onHashChange,!1),t.on("moveend",this._updateHash),this}remove(){return this._map?(this._map.off("moveend",this._updateHash),window.removeEventListener("hashchange",this._onHashChange,!1),clearTimeout(this._updateHash()),this._map=void 0,this):this}getHashString(){const t=this._map;if(!t)return"";const r=sa(t);if(this._hashName){const c=this._hashName;let p=!1;const _=location.hash.slice(1).split("&").map((v=>{const b=v.split("=")[0];return b===c?(p=!0,`${b}=${r}`):v})).filter((v=>v));return p||_.push(`${c}=${r}`),`#${_.join("&")}`}return`#${r}`}_getCurrentHash(){const t=location.hash.replace("#","");if(this._hashName){let r;return t.split("&").map((c=>c.split("="))).forEach((c=>{c[0]===this._hashName&&(r=c)})),(r&&r[1]||"").split("/")}return t.split("/")}_onHashChange(){const t=this._map;if(!t)return!1;const r=this._getCurrentHash();if(r.length>=3&&!r.some((c=>isNaN(Number(c))))){const c=t.dragRotate.isEnabled()&&t.touchZoomRotate.isEnabled()?+(r[3]||0):t.getBearing();return t.jumpTo({center:[+r[2],+r[1]],zoom:+r[0],bearing:c,pitch:+(r[4]||0)}),!0}return!1}_updateHashUnthrottled(){history.replaceState(history.state,"",location.href.replace(/(#.+)?$/,this.getHashString()))}}function sa(l,t){const r=l.getCenter(),c=Math.round(100*l.getZoom())/100,p=Math.ceil((c*Math.LN2+Math.log(512/360/.5))/Math.LN10),_=Math.pow(10,p),v=Math.round(r.lng*_)/_,b=Math.round(r.lat*_)/_,I=l.getBearing(),M=l.getPitch();let L=t?`/${v}/${b}/${c}`:`${c}/${b}/${v}`;return(I||M)&&(L+="/"+Math.round(10*I)/10),M&&(L+=`/${Math.round(M)}`),L}const $c={linearity:.3,easing:s.eI(0,0,.3,1)},bl=s.h({deceleration:2500,maxSpeed:1400},$c),Xd=s.h({deceleration:20,maxSpeed:1400},$c),Tl=s.h({deceleration:1e3,maxSpeed:360},$c),Kd=s.h({deceleration:1e3,maxSpeed:90},$c);class hh{constructor(t){this._map=t,this.clear()}clear(){this._inertiaBuffer=[]}record(t){this._drainInertiaBuffer(),this._inertiaBuffer.push({time:s.q.now(),settings:t})}_drainInertiaBuffer(){const t=this._inertiaBuffer,r=s.q.now();for(;t.length>0&&r-t[0].time>160;)t.shift()}_onMoveEnd(t){if(this._map._prefersReducedMotion()||(this._drainInertiaBuffer(),this._inertiaBuffer.length<2))return;const r={zoom:0,bearing:0,pitch:0,pan:new s.P(0,0),pinchAround:void 0,around:void 0};for(const{settings:_}of this._inertiaBuffer)r.zoom+=_.zoomDelta||0,r.bearing+=_.bearingDelta||0,r.pitch+=_.pitchDelta||0,_.panDelta&&r.pan._add(_.panDelta),_.around&&(r.around=_.around),_.pinchAround&&(r.pinchAround=_.pinchAround);const c=this._inertiaBuffer[this._inertiaBuffer.length-1].time-this._inertiaBuffer[0].time,p={};if(r.pan.mag()){const _=Wc(r.pan.mag(),c,s.h({},bl,t||{}));p.offset=r.pan.mult(_.amount/r.pan.mag()),p.center=this._map.transform.center,El(p,_)}if(r.zoom){const _=Wc(r.zoom,c,Xd);p.zoom=this._map.transform.zoom+_.amount,El(p,_)}if(r.bearing){const _=Wc(r.bearing,c,Tl);p.bearing=this._map.transform.bearing+s.ay(_.amount,-179,179),El(p,_)}if(r.pitch){const _=Wc(r.pitch,c,Kd);p.pitch=this._map.transform.pitch+_.amount,El(p,_)}if(p.zoom||p.bearing){const _=r.pinchAround===void 0?r.around:r.pinchAround;p.around=_?this._map.unproject(_):this._map.getCenter()}return this.clear(),p.noMoveStart=!0,p}}function El(l,t){(!l.duration||l.duration<t.duration)&&(l.duration=t.duration,l.easing=t.easing)}function Wc(l,t,r){const{maxSpeed:c,linearity:p,deceleration:_}=r,v=s.ay(l*p/(t/1e3),-c,c),b=Math.abs(v)/(_*p);return{easing:r.easing,duration:1e3*b,amount:v*(b/2)}}class yr extends s.A{preventDefault(){this._defaultPrevented=!0}get defaultPrevented(){return this._defaultPrevented}constructor(t,r,c,p={}){const _=De(r.getCanvasContainer(),c),v=r.unproject(_);super(t,s.h({point:_,lngLat:v,originalEvent:c},p)),this._defaultPrevented=!1,this.target=r}}class dh extends s.A{preventDefault(){this._defaultPrevented=!0}get defaultPrevented(){return this._defaultPrevented}constructor(t,r,c){const p=t==="touchend"?c.changedTouches:c.touches,_=je(r.getCanvasContainer(),p),v=_.map((I=>r.unproject(I))),b=_.reduce(((I,M,L,B)=>I.add(M.div(B.length))),new s.P(0,0));super(t,{points:_,point:b,lngLats:v,lngLat:r.unproject(b),originalEvent:c}),this._defaultPrevented=!1}}class Yd extends s.A{preventDefault(){this._defaultPrevented=!0}get defaultPrevented(){return this._defaultPrevented}constructor(t,r){super("wheel",{originalEvent:r}),this._defaultPrevented=!1}}class Qd{constructor(t,r){this._map=t,this._clickTolerance=r.clickTolerance}reset(){this._mousedownPos=void 0}wheel(t){return this._firePreventable(new Yd(this._map,t))}mousedown(t,r){return this._mousedownPos=r,this._firePreventable(new yr(t.type,this._map,t))}mouseup(t){this._map.fire(new yr(t.type,this._map,t))}preclick(t){const r=s.h({},t);r.type="preclick",this._map.fire(new yr(r.type,this._map,r))}click(t,r){this._mousedownPos&&this._mousedownPos.dist(r)>=this._clickTolerance||(this.preclick(t),this._map.fire(new yr(t.type,this._map,t)))}dblclick(t){return this._firePreventable(new yr(t.type,this._map,t))}mouseover(t){this._map.fire(new yr(t.type,this._map,t))}mouseout(t){this._map.fire(new yr(t.type,this._map,t))}touchstart(t){return this._firePreventable(new dh(t.type,this._map,t))}touchmove(t){this._map.fire(new dh(t.type,this._map,t))}touchend(t){this._map.fire(new dh(t.type,this._map,t))}touchcancel(t){this._map.fire(new dh(t.type,this._map,t))}_firePreventable(t){if(this._map.fire(t),t.defaultPrevented)return{}}isEnabled(){return!0}isActive(){return!1}enable(){}disable(){}}class Zc{constructor(t){this._map=t}reset(){this._delayContextMenu=!1,this._contextMenuEvent=void 0}mousemove(t){this._map.fire(new yr(t.type,this._map,t))}mousedown(){this._delayContextMenu=!0}mouseup(){this._delayContextMenu=!1,this._contextMenuEvent&&(this._map.fire(new yr("contextmenu",this._map,this._contextMenuEvent)),delete this._contextMenuEvent)}contextmenu(t){this._delayContextMenu?this._contextMenuEvent=t:this._map.fire(new yr(t.type,this._map,t)),this._map.listens("contextmenu")&&t.preventDefault()}isEnabled(){return!0}isActive(){return!1}enable(){}disable(){}}class Jd{constructor(t,r){this._map=t,this._el=t.getCanvasContainer(),this._container=t.getContainer(),this._clickTolerance=r.clickTolerance||1}isEnabled(){return!!this._enabled}isActive(){return!!this._active}enable(){this.isEnabled()||(this._enabled=!0)}disable(){this.isEnabled()&&(this._enabled=!1)}mousedown(t,r){this.isEnabled()&&t.shiftKey&&t.button===0&&(en(),this._startPos=this._lastPos=r,this._active=!0)}mousemoveWindow(t,r){if(!this._active)return;const c=r,p=this._startPos,_=this._lastPos;if(!p||!_||_.equals(c)||!this._box&&c.dist(p)<this._clickTolerance)return;this._lastPos=c,this._box||(this._box=ct("div","mapboxgl-boxzoom",this._container),this._container.classList.add("mapboxgl-crosshair"),this._fireEvent("boxzoomstart",t));const v=Math.min(p.x,c.x),b=Math.max(p.x,c.x),I=Math.min(p.y,c.y),M=Math.max(p.y,c.y);this._map._requestDomTask((()=>{this._box&&(this._box.style.transform=`translate(${v}px,${I}px)`,this._box.style.width=b-v+"px",this._box.style.height=M-I+"px")}))}mouseupWindow(t,r){if(!this._active)return;const c=this._startPos,p=r;if(c&&t.button===0){if(this.reset(),rt(),c.x!==p.x||c.y!==p.y)return this._map.fire(new s.A("boxzoomend",{originalEvent:t})),{cameraAnimation:_=>_.fitScreenCoordinates(c,p,this._map.getBearing(),{linear:!1})};this._fireEvent("boxzoomcancel",t)}}keydown(t){this._active&&t.keyCode===27&&(this.reset(),this._fireEvent("boxzoomcancel",t))}blur(){this.reset()}reset(){this._active=!1,this._container.classList.remove("mapboxgl-crosshair"),this._box&&(this._box.remove(),this._box=null),Hn(),delete this._startPos,delete this._lastPos}_fireEvent(t,r){return this._map.fire(new s.A(t,{originalEvent:r}))}}function fh(l,t){const r={};for(let c=0;c<l.length;c++)r[l[c].identifier]=t[c];return r}class Wf{constructor(t){this.reset(),this.numTouches=t.numTouches}reset(){this.centroid=void 0,this.startTime=0,this.touches={},this.aborted=!1}touchstart(t,r,c){(this.centroid||c.length>this.numTouches)&&(this.aborted=!0),this.aborted||(this.startTime===0&&(this.startTime=t.timeStamp),c.length===this.numTouches&&(this.centroid=(function(p){const _=new s.P(0,0);for(const v of p)_._add(v);return _.div(p.length)})(r),this.touches=fh(c,r)))}touchmove(t,r,c){if(this.aborted||!this.centroid)return;const p=fh(c,r);for(const _ in this.touches){const v=p[_];(!v||v.dist(this.touches[_])>30)&&(this.aborted=!0)}}touchend(t,r,c){if((!this.centroid||t.timeStamp-this.startTime>500)&&(this.aborted=!0),c.length===0){const p=!this.aborted&&this.centroid;if(this.reset(),p)return p}}}class zs{constructor(t){this.singleTap=new Wf(t),this.numTaps=t.numTaps,this.reset()}reset(){this.lastTime=1/0,this.lastTap=void 0,this.count=0,this.singleTap.reset()}touchstart(t,r,c){this.singleTap.touchstart(t,r,c)}touchmove(t,r,c){this.singleTap.touchmove(t,r,c)}touchend(t,r,c){const p=this.singleTap.touchend(t,r,c);if(p){const _=t.timeStamp-this.lastTime<500,v=!this.lastTap||this.lastTap.dist(p)<30;if(_&&v||this.reset(),this.count++,this.lastTime=t.timeStamp,this.lastTap=p,this.count===this.numTaps)return this.reset(),p}}}class wo{constructor(){this._zoomIn=new zs({numTouches:1,numTaps:2}),this._zoomOut=new zs({numTouches:2,numTaps:1}),this.reset()}reset(){this._active=!1,this._zoomIn.reset(),this._zoomOut.reset()}touchstart(t,r,c){this._zoomIn.touchstart(t,r,c),this._zoomOut.touchstart(t,r,c)}touchmove(t,r,c){this._zoomIn.touchmove(t,r,c),this._zoomOut.touchmove(t,r,c)}touchend(t,r,c){const p=this._zoomIn.touchend(t,r,c),_=this._zoomOut.touchend(t,r,c);return p?(this._active=!0,t.preventDefault(),setTimeout((()=>this.reset()),0),{cameraAnimation:v=>v.easeTo({duration:300,zoom:v.getZoom()+1,around:v.unproject(p)},{originalEvent:t})}):_?(this._active=!0,t.preventDefault(),setTimeout((()=>this.reset()),0),{cameraAnimation:v=>v.easeTo({duration:300,zoom:v.getZoom()-1,around:v.unproject(_)},{originalEvent:t})}):void 0}touchcancel(){this.reset()}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}const ef={0:1,2:2},od={Control:"ctrlKey",Alt:"altKey",Shift:"shiftKey",Meta:"metaKey"};class ku{constructor(t){this.reset(),this._clickTolerance=t.clickTolerance||1}blur(){this.reset()}reset(){this._active=!1,this._moved=!1,this._lastPoint=void 0,this._eventButton=void 0}_correctButton(t,r){return!1}_move(t,r){return{}}mousedown(t,r){if(this._lastPoint)return;const c=Ke(t);this._correctButton(t,c)&&(this._lastPoint=r,this._eventButton=c)}mousemoveWindow(t,r){const c=this._lastPoint;if(c){if(t.preventDefault(),this._eventButton!=null&&(function(p,_){const v=ef[_];return p.buttons===void 0||(p.buttons&v)!==v})(t,this._eventButton))this.reset();else if(this._moved||!(r.dist(c)<this._clickTolerance))return this._moved=!0,this._lastPoint=r,this._move(c,r)}}mouseupWindow(t){this._lastPoint&&Ke(t)===this._eventButton&&(this._moved&&rt(),this.reset())}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}class tf extends ku{mousedown(t,r){super.mousedown(t,r),this._lastPoint&&(this._active=!0)}_correctButton(t,r){return r===0&&!t.ctrlKey}_move(t,r){return{around:r,panDelta:r.sub(t)}}}class ad extends ku{constructor(t){super(t),this._pitchRotateKey=t.pitchRotateKey?od[t.pitchRotateKey]:void 0}_correctButton(t,r){return this._pitchRotateKey?r===0&&t[this._pitchRotateKey]:r===0&&t.ctrlKey||r===2}_move(t,r){const c=.8*(r.x-t.x);if(c)return this._active=!0,{bearingDelta:c}}contextmenu(t){this._pitchRotateKey||t.preventDefault()}}class ld extends ku{constructor(t){super(t),this._pitchRotateKey=t.pitchRotateKey?od[t.pitchRotateKey]:void 0}_correctButton(t,r){return this._pitchRotateKey?r===0&&t[this._pitchRotateKey]:r===0&&t.ctrlKey||r===2}_move(t,r){const c=-.5*(r.y-t.y);if(c)return this._active=!0,{pitchDelta:c}}contextmenu(t){this._pitchRotateKey||t.preventDefault()}}class Zf{constructor(t,r){this._map=t,this._el=t.getCanvasContainer(),this._minTouches=1,this._clickTolerance=r.clickTolerance||1,this.reset(),s.aV(["_addTouchPanBlocker","_showTouchPanBlockerAlert"],this)}reset(){this._active=!1,this._touches={},this._sum=new s.P(0,0)}touchstart(t,r,c){return this._calculateTransform(t,r,c)}touchmove(t,r,c){if(this._active&&!(c.length<this._minTouches)){if(this._map._cooperativeGestures&&!this._map.isMoving()){if(c.length===1&&!s.eJ())return void this._showTouchPanBlockerAlert();this._alertContainer.style.visibility!=="hidden"&&(this._alertContainer.style.visibility="hidden",clearTimeout(this._alertTimer))}return t.cancelable&&t.preventDefault(),this._calculateTransform(t,r,c)}}touchend(t,r,c){this._calculateTransform(t,r,c),this._active&&c.length<this._minTouches&&this.reset()}touchcancel(){this.reset()}_calculateTransform(t,r,c){c.length>0&&(this._active=!0);const p=fh(c,r),_=new s.P(0,0),v=new s.P(0,0);let b=0;for(const M in p){const L=p[M],B=this._touches[M];B&&(_._add(L),v._add(L.sub(B)),b++,p[M]=L)}if(this._touches=p,b<this._minTouches||!v.mag())return;const I=v.div(b);return this._sum._add(I),this._sum.mag()<this._clickTolerance?void 0:{around:_.div(b),panDelta:I}}enable(){this._enabled=!0,this._map._cooperativeGestures&&(this._addTouchPanBlocker(),this._el.classList.add("mapboxgl-touch-pan-blocker-override","mapboxgl-scrollable-page"))}disable(){this._enabled=!1,this._map._cooperativeGestures&&(clearTimeout(this._alertTimer),this._alertContainer.remove(),this._el.classList.remove("mapboxgl-touch-pan-blocker-override","mapboxgl-scrollable-page")),this.reset()}isEnabled(){return!!this._enabled}isActive(){return!!this._active}_addTouchPanBlocker(){this._map&&!this._alertContainer&&(this._alertContainer=ct("div","mapboxgl-touch-pan-blocker",this._map._container),this._alertContainer.textContent=this._map._getUIString("TouchPanBlocker.Message"),this._alertContainer.style.fontSize=`${Math.max(10,Math.min(24,Math.floor(.05*this._el.clientWidth)))}px`)}_showTouchPanBlockerAlert(){this._alertContainer.style.visibility="visible",this._alertContainer.classList.add("mapboxgl-touch-pan-blocker-show"),this._alertContainer.setAttribute("role","alert"),clearTimeout(this._alertTimer),this._alertTimer=window.setTimeout((()=>{this._alertContainer.classList.remove("mapboxgl-touch-pan-blocker-show"),this._alertContainer.removeAttribute("role")}),500)}}class ph{constructor(){this.reset()}reset(){this._active=!1,this._firstTwoTouches=void 0}_start(t){}_move(t,r,c){return{}}touchstart(t,r,c){this._firstTwoTouches||c.length<2||(this._firstTwoTouches=[c[0].identifier,c[1].identifier],this._start([r[0],r[1]]))}touchmove(t,r,c){const p=this._firstTwoTouches;if(!p)return;t.preventDefault();const[_,v]=p,b=mh(c,r,_),I=mh(c,r,v);if(!b||!I)return;const M=this._aroundCenter?null:b.add(I).div(2);return this._move([b,I],M,t)}touchend(t,r,c){if(!this._firstTwoTouches)return;const[p,_]=this._firstTwoTouches,v=mh(c,r,p),b=mh(c,r,_);v&&b||(this._active&&rt(),this.reset())}touchcancel(){this.reset()}enable(t){this._enabled=!0,this._aroundCenter=!!t&&t.around==="center"}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}function mh(l,t,r){for(let c=0;c<l.length;c++)if(l[c].identifier===r)return t[c]}function nf(l,t){return Math.log(l/t)/Math.LN2}class rf extends ph{reset(){super.reset(),this._distance=0,this._startDistance=0}_start(t){this._startDistance=this._distance=t[0].dist(t[1])}_move(t,r){const c=this._distance;if(this._distance=t[0].dist(t[1]),this._active||!(Math.abs(nf(this._distance,this._startDistance))<.1))return this._active=!0,{zoomDelta:nf(this._distance,c),pinchAround:r}}}function cd(l,t){return 180*l.angleWith(t)/Math.PI}class Xf extends ph{reset(){super.reset(),this._minDiameter=0,this._startVector=void 0,this._vector=void 0}_start(t){this._startVector=this._vector=t[0].sub(t[1]),this._minDiameter=t[0].dist(t[1])}_move(t,r){const c=this._vector;if(this._vector=t[0].sub(t[1]),c&&(this._active||!this._isBelowThreshold(this._vector)))return this._active=!0,{bearingDelta:cd(this._vector,c),pinchAround:r}}_isBelowThreshold(t){this._minDiameter=Math.min(this._minDiameter,t.mag());const r=25/(Math.PI*this._minDiameter)*360,c=this._startVector;if(!c)return!1;const p=cd(t,c);return Math.abs(p)<r}}function _h(l){return Math.abs(l.y)>Math.abs(l.x)}class ud extends ph{constructor(t){super(),this._map=t}reset(){super.reset(),this._valid=void 0,this._firstMove=void 0,this._lastPoints=void 0}_start(t){this._lastPoints=t,_h(t[0].sub(t[1]))&&(this._valid=!1)}_move(t,r,c){const p=this._lastPoints;if(!p)return;const _=t[0].sub(p[0]),v=t[1].sub(p[1]);return this._map._cooperativeGestures&&!s.eJ()&&c.touches.length<3||(this._valid=this.gestureBeginsVertically(_,v,c.timeStamp),!this._valid)?void 0:(this._lastPoints=t,this._active=!0,{pitchDelta:(_.y+v.y)/2*-.5})}gestureBeginsVertically(t,r,c){if(this._valid!==void 0)return this._valid;const p=t.mag()>=2,_=r.mag()>=2;if(!p&&!_)return;if(!p||!_)return this._firstMove==null&&(this._firstMove=c),c-this._firstMove<100&&void 0;const v=t.y>0==r.y>0;return _h(t)&&_h(r)&&v}}const Rp={panStep:100,bearingStep:15,pitchStep:10};class Kf{constructor(){const t=Rp;this._panStep=t.panStep,this._bearingStep=t.bearingStep,this._pitchStep=t.pitchStep,this._rotationDisabled=!1}blur(){this.reset()}reset(){this._active=!1}keydown(t){if(t.altKey||t.ctrlKey||t.metaKey)return;let r=0,c=0,p=0,_=0,v=0;switch(t.keyCode){case 61:case 107:case 171:case 187:r=1;break;case 189:case 109:case 173:r=-1;break;case 37:t.shiftKey?c=-1:(t.preventDefault(),_=-1);break;case 39:t.shiftKey?c=1:(t.preventDefault(),_=1);break;case 38:t.shiftKey?p=1:(t.preventDefault(),v=-1);break;case 40:t.shiftKey?p=-1:(t.preventDefault(),v=1);break;default:return}return this._rotationDisabled&&(c=0,p=0),{cameraAnimation:b=>{const I=b.getZoom();b.easeTo({duration:300,easeId:"keyboardHandler",easing:sf,zoom:r?Math.round(I)+r*(t.shiftKey?2:1):I,bearing:b.getBearing()+c*this._bearingStep,pitch:b.getPitch()+p*this._pitchStep,offset:[-_*this._panStep,-v*this._panStep],center:b.getCenter()},{originalEvent:t})}}}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}disableRotation(){this._rotationDisabled=!0}enableRotation(){this._rotationDisabled=!1}}function sf(l){return l*(2-l)}const Yf=4.000244140625,of=1/450;class xc{constructor(t,r){this._map=t,this._el=t.getCanvasContainer(),this._handler=r,this._delta=0,this._lastDelta=0,this._defaultZoomRate=.01,this._wheelZoomRate=of,s.aV(["_onTimeout","_addScrollZoomBlocker","_showBlockerAlert"],this)}setZoomRate(t){this._defaultZoomRate=t}setWheelZoomRate(t){this._wheelZoomRate=t}isEnabled(){return!!this._enabled}isActive(){return this._active||this._finishTimeout!==void 0}isZooming(){return!!this._zooming}enable(t){this.isEnabled()||(this._enabled=!0,this._aroundCenter=!!t&&t.around==="center",this._map._cooperativeGestures&&this._addScrollZoomBlocker())}disable(){this.isEnabled()&&(this._enabled=!1,this._map._cooperativeGestures&&(clearTimeout(this._alertTimer),this._alertContainer.remove()))}wheel(t){if(!this.isEnabled())return;if(this._map._cooperativeGestures){if(!(t.ctrlKey||t.metaKey||this.isZooming()||s.eJ()))return void this._showBlockerAlert();this._alertContainer.style.visibility!=="hidden"&&(this._alertContainer.style.visibility="hidden",clearTimeout(this._alertTimer))}let r=t.deltaMode===WheelEvent.DOM_DELTA_LINE?40*t.deltaY:t.deltaY;const c=s.q.now(),p=c-(this._lastWheelEventTime||0);this._lastWheelEventTime=c,r!==0&&r%Yf==0?this._type="wheel":r!==0&&Math.abs(r)<4?this._type="trackpad":p>400?(this._type=null,this._lastValue=r,this._timeout=window.setTimeout(this._onTimeout,40,t)):this._type||(this._type=Math.abs(p*r)<200?"trackpad":"wheel",this._timeout&&(clearTimeout(this._timeout),this._timeout=null,r+=this._lastValue)),t.shiftKey&&r&&(r/=4),this._type&&(this._lastWheelEvent=t,this._delta-=r,this._active||this._start(t)),t.preventDefault()}_onTimeout(t){this._type="wheel",this._delta-=this._lastValue,this._active||this._start(t)}_start(t){if(!this._delta)return;this._frameId&&(this._frameId=null),this._active=!0,this.isZooming()||(this._zooming=!0),this._finishTimeout&&(clearTimeout(this._finishTimeout),delete this._finishTimeout);const r=De(this._el,t);this._aroundPoint=this._aroundCenter?this._map.transform.centerPoint:r,this._aroundCoord=this._map.transform.pointCoordinate3D(this._aroundPoint),this._targetZoom=void 0,this._frameId||(this._frameId=!0,this._handler._triggerRenderFrame())}renderFrame(){if(!this._frameId||(this._frameId=null,!this.isActive()))return;const t=this._map.transform;this._type==="wheel"&&t.projection.wrap&&(t._center.lng>=180||t._center.lng<=-180)&&(this._prevEase=null,this._easing=null,this._lastWheelEvent=null,this._lastWheelEventTime=0);const r=()=>t._terrainEnabled()&&this._aroundCoord?t.computeZoomRelativeTo(this._aroundCoord):t.zoom;if(this._delta!==0){const M=this._type==="wheel"&&Math.abs(this._delta)>Yf?this._wheelZoomRate:this._defaultZoomRate;let L=2/(1+Math.exp(-Math.abs(this._delta*M)));this._delta<0&&L!==0&&(L=1/L);const B=r(),F=Math.pow(2,B),V=typeof this._targetZoom=="number"?t.zoomScale(this._targetZoom):F;this._targetZoom=Math.min(t.maxZoom,Math.max(t.minZoom,t.scaleZoom(V*L))),this._type==="wheel"&&(this._startZoom=B,this._easing=this._smoothOutEasing(200)),this._lastDelta=this._delta,this._delta=0}const c=typeof this._targetZoom=="number"?this._targetZoom:r(),p=this._startZoom,_=this._easing;let v,b=!1;if(this._type==="wheel"&&p&&_){const M=Math.min((s.q.now()-this._lastWheelEventTime)/200,1),L=_(M);v=s.ai(p,c,L),M<1?this._frameId||(this._frameId=!0):b=!0}else v=c,b=!0;this._active=!0,b&&(this._active=!1,this._finishTimeout=window.setTimeout((()=>{this._zooming=!1,this._handler._triggerRenderFrame(),delete this._targetZoom,delete this._finishTimeout}),200));let I=v-r();return I*this._lastDelta<0&&(I=0),{noInertia:!0,needsRenderFrame:!b,zoomDelta:I,around:this._aroundPoint,aroundCoord:this._aroundCoord,originalEvent:this._lastWheelEvent}}_smoothOutEasing(t){let r=s.eK;if(this._prevEase){const c=this._prevEase,p=(s.q.now()-c.start)/c.duration,_=c.easing(p+.01)-c.easing(p),v=.27/Math.sqrt(_*_+1e-4)*.01,b=Math.sqrt(.0729-v*v);r=s.eI(v,b,.25,1)}return this._prevEase={start:s.q.now(),duration:t,easing:r},r}blur(){this.reset()}reset(){this._active=!1}_addScrollZoomBlocker(){this._map&&!this._alertContainer&&(this._alertContainer=ct("div","mapboxgl-scroll-zoom-blocker",this._map._container),this._alertContainer.textContent=/(Mac|iPad)/i.test(navigator.userAgent)?this._map._getUIString("ScrollZoomBlocker.CmdMessage"):this._map._getUIString("ScrollZoomBlocker.CtrlMessage"),this._alertContainer.style.fontSize=`${Math.max(10,Math.min(24,Math.floor(.05*this._el.clientWidth)))}px`)}_showBlockerAlert(){this._alertContainer.style.visibility="visible",this._alertContainer.classList.add("mapboxgl-scroll-zoom-blocker-show"),this._alertContainer.setAttribute("role","alert"),clearTimeout(this._alertTimer),this._alertTimer=window.setTimeout((()=>{this._alertContainer.classList.remove("mapboxgl-scroll-zoom-blocker-show"),this._alertContainer.removeAttribute("role")}),200)}}class kr{constructor(t,r){this._clickZoom=t,this._tapZoom=r}enable(){this._clickZoom.enable(),this._tapZoom.enable()}disable(){this._clickZoom.disable(),this._tapZoom.disable()}isEnabled(){return this._clickZoom.isEnabled()&&this._tapZoom.isEnabled()}isActive(){return this._clickZoom.isActive()||this._tapZoom.isActive()}}class Qf{constructor(){this.reset()}reset(){this._active=!1}blur(){this.reset()}dblclick(t,r){return t.preventDefault(),{cameraAnimation:c=>{c.easeTo({duration:300,zoom:c.getZoom()+(t.shiftKey?-1:1),around:c.unproject(r)},{originalEvent:t})}}}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}class Jf{constructor(){this._tap=new zs({numTouches:1,numTaps:1}),this.reset()}reset(){this._active=!1,this._swipePoint=void 0,this._swipeTouch=0,this._tapTime=0,this._tap.reset()}touchstart(t,r,c){this._swipePoint||(this._tapTime&&t.timeStamp-this._tapTime>500&&this.reset(),this._tapTime?c.length>0&&(this._swipePoint=r[0],this._swipeTouch=c[0].identifier):this._tap.touchstart(t,r,c))}touchmove(t,r,c){if(this._tapTime){if(this._swipePoint){if(c[0].identifier!==this._swipeTouch)return;const p=r[0],_=p.y-this._swipePoint.y;return this._swipePoint=p,t.preventDefault(),this._active=!0,{zoomDelta:_/128}}}else this._tap.touchmove(t,r,c)}touchend(t,r,c){this._tapTime?this._swipePoint&&c.length===0&&this.reset():this._tap.touchend(t,r,c)&&(this._tapTime=t.timeStamp)}touchcancel(){this.reset()}enable(){this._enabled=!0}disable(){this._enabled=!1,this.reset()}isEnabled(){return this._enabled}isActive(){return this._active}}class af{constructor(t,r,c){this._el=t,this._mousePan=r,this._touchPan=c}enable(t){this._inertiaOptions=t||{},this._mousePan.enable(),this._touchPan.enable(),this._el.classList.add("mapboxgl-touch-drag-pan")}disable(){this._mousePan.disable(),this._touchPan.disable(),this._el.classList.remove("mapboxgl-touch-drag-pan")}isEnabled(){return this._mousePan.isEnabled()&&this._touchPan.isEnabled()}isActive(){return this._mousePan.isActive()||this._touchPan.isActive()}}class Mp{constructor(t,r,c){this._pitchWithRotate=t.pitchWithRotate,this._mouseRotate=r,this._mousePitch=c}enable(){this._mouseRotate.enable(),this._pitchWithRotate&&this._mousePitch.enable()}disable(){this._mouseRotate.disable(),this._mousePitch.disable()}isEnabled(){return this._mouseRotate.isEnabled()&&(!this._pitchWithRotate||this._mousePitch.isEnabled())}isActive(){return this._mouseRotate.isActive()||this._mousePitch.isActive()}}class wc{constructor(t,r,c,p){this._el=t,this._touchZoom=r,this._touchRotate=c,this._tapDragZoom=p,this._rotationDisabled=!1,this._enabled=!0}enable(t){this._touchZoom.enable(t),this._rotationDisabled||this._touchRotate.enable(t),this._tapDragZoom.enable(),this._el.classList.add("mapboxgl-touch-zoom-rotate")}disable(){this._touchZoom.disable(),this._touchRotate.disable(),this._tapDragZoom.disable(),this._el.classList.remove("mapboxgl-touch-zoom-rotate")}isEnabled(){return this._touchZoom.isEnabled()&&(this._rotationDisabled||this._touchRotate.isEnabled())&&this._tapDragZoom.isEnabled()}isActive(){return this._touchZoom.isActive()||this._touchRotate.isActive()||this._tapDragZoom.isActive()}disableRotation(){this._rotationDisabled=!0,this._touchRotate.disable()}enableRotation(){this._rotationDisabled=!1,this._touchZoom.isEnabled()&&this._touchRotate.enable()}}const Gs=l=>l.zoom||l.drag||l.pitch||l.rotate;class ep extends s.A{}class lf{constructor(){this.constants=[1,1,.01],this.radius=0}setup(t,r){const c=s.at([],r,t);this.radius=s.ae(c[2]<0?s.eM([],c,this.constants):[c[0],c[1],0])}projectRay(t){s.eM(t,t,this.constants),s.au(t,t),s.eN(t,t,this.constants);const r=s.c1([],t,this.radius);if(r[2]>0){const c=s.c1([],[0,0,1],s.bG(r,[0,0,1])),p=s.c1([],s.au([],[r[0],r[1],0]),this.radius),_=s.d5([],r,s.c1([],s.at([],s.d5([],p,c),r),2));r[0]=_[0],r[1]=_[1]}return r}}function $o(l){return l.panDelta&&l.panDelta.mag()||l.zoomDelta||l.bearingDelta||l.pitchDelta}class io{constructor(t,r){this._map=t,this._el=this._map.getCanvasContainer(),this._handlers=[],this._handlersById={},this._changes=[],this._inertia=new hh(t),this._bearingSnap=r.bearingSnap,this._previousActiveHandlers={},this._trackingEllipsoid=new lf,this._dragOrigin=null,this._eventsInProgress={},this._addDefaultHandlers(r),s.aV(["handleEvent","handleWindowEvent"],this);const c=this._el;this._listeners=[[c,"touchstart",{passive:!0}],[c,"touchmove",{passive:!1}],[c,"touchend",void 0],[c,"touchcancel",void 0],[c,"mousedown",void 0],[c,"mousemove",void 0],[c,"mouseup",void 0],[document,"mousemove",{capture:!0}],[document,"mouseup",void 0],[c,"mouseover",void 0],[c,"mouseout",void 0],[c,"dblclick",void 0],[c,"click",void 0],[c,"keydown",{capture:!1}],[c,"keyup",void 0],[c,"wheel",{passive:!1}],[c,"contextmenu",void 0],[window,"blur",void 0]];for(const[p,_,v]of this._listeners){const b=p===document?this.handleWindowEvent:this.handleEvent;p.addEventListener(_,b,v)}}destroy(){for(const[t,r,c]of this._listeners){const p=t===document?this.handleWindowEvent:this.handleEvent;t.removeEventListener(r,p,c)}}_addDefaultHandlers(t){const r=this._map,c=r.getCanvasContainer();this._add("mapEvent",new Qd(r,t));const p=r.boxZoom=new Jd(r,t);this._add("boxZoom",p);const _=new wo,v=new Qf;r.doubleClickZoom=new kr(v,_),this._add("tapZoom",_),this._add("clickZoom",v);const b=new Jf;this._add("tapDragZoom",b);const I=r.touchPitch=new ud(r);this._add("touchPitch",I);const M=new ad(t),L=new ld(t);r.dragRotate=new Mp(t,M,L),this._add("mouseRotate",M,["mousePitch"]),this._add("mousePitch",L,["mouseRotate"]);const B=new tf(t),F=new Zf(r,t);r.dragPan=new af(c,B,F),this._add("mousePan",B),this._add("touchPan",F,["touchZoom","touchRotate"]);const V=new Xf,$=new rf;r.touchZoomRotate=new wc(c,$,V,b),this._add("touchRotate",V,["touchPan","touchZoom"]),this._add("touchZoom",$,["touchPan","touchRotate"]),this._add("blockableMapEvent",new Zc(r));const H=r.scrollZoom=new xc(r,this);this._add("scrollZoom",H,["mousePan"]);const X=r.keyboard=new Kf;this._add("keyboard",X);for(const Z of["boxZoom","doubleClickZoom","tapDragZoom","touchPitch","dragRotate","dragPan","touchZoomRotate","scrollZoom","keyboard"])t.interactive&&t[Z]&&r[Z].enable(t[Z])}_add(t,r,c){this._handlers.push({handlerName:t,handler:r,allowed:c}),this._handlersById[t]=r}stop(t){if(!this._updatingCamera){for(const{handler:r}of this._handlers)r.reset();this._inertia.clear(),this._fireEvents({},{},t),this._changes=[],this._originalZoom=void 0}}isActive(){for(const{handler:t}of this._handlers)if(t.isActive())return!0;return!1}isZooming(){return!!this._eventsInProgress.zoom||this._map.scrollZoom.isZooming()}isRotating(){return!!this._eventsInProgress.rotate}isMoving(){return!!Gs(this._eventsInProgress)||this.isZooming()}_isDragging(){return!!this._eventsInProgress.drag}_blockedByActive(t,r,c){for(const p in t)if(p!==c&&(!r||r.indexOf(p)<0))return!0;return!1}handleWindowEvent(t){this.handleEvent(t,`${t.type}Window`)}_getMapTouches(t){const r=[];for(const c of t)this._el.contains(c.target)&&r.push(c);return r}handleEvent(t,r){this._updatingCamera=!0;const c=t.type==="renderFrame",p=c?void 0:t,_={needsRenderFrame:!1},v={},b={},I=t.touches?this._getMapTouches(t.touches):void 0,M=I?je(this._el,I):c?void 0:De(this._el,t);for(const{handlerName:F,handler:V,allowed:$}of this._handlers){if(!V.isEnabled())continue;let H;this._blockedByActive(b,$,F)?V.reset():V[r||t.type]&&(H=V[r||t.type](t,M,I),this.mergeHandlerResult(_,v,H,F,p),H&&H.needsRenderFrame&&this._triggerRenderFrame()),(H||V.isActive())&&(b[F]=V)}const L={};for(const F in this._previousActiveHandlers)b[F]||(L[F]=p);this._previousActiveHandlers=b,(Object.keys(L).length||$o(_))&&(this._changes.push([_,v,L]),this._triggerRenderFrame()),(Object.keys(b).length||$o(_))&&this._map._stop(!0),this._updatingCamera=!1;const{cameraAnimation:B}=_;B&&(this._inertia.clear(),this._fireEvents({},{},!0),this._changes=[],B(this._map))}mergeHandlerResult(t,r,c,p,_){if(!c)return;s.h(t,c);const v={handlerName:p,originalEvent:c.originalEvent||_};c.zoomDelta!==void 0&&(r.zoom=v),c.panDelta!==void 0&&(r.drag=v),c.pitchDelta!==void 0&&(r.pitch=v),c.bearingDelta!==void 0&&(r.rotate=v)}_applyChanges(){const t={},r={},c={};for(const[p,_,v]of this._changes)p.panDelta&&(t.panDelta=(t.panDelta||new s.P(0,0))._add(p.panDelta)),p.zoomDelta&&(t.zoomDelta=(t.zoomDelta||0)+p.zoomDelta),p.bearingDelta&&(t.bearingDelta=(t.bearingDelta||0)+p.bearingDelta),p.pitchDelta&&(t.pitchDelta=(t.pitchDelta||0)+p.pitchDelta),p.around!==void 0&&(t.around=p.around),p.aroundCoord!==void 0&&(t.aroundCoord=p.aroundCoord),p.pinchAround!==void 0&&(t.pinchAround=p.pinchAround),p.noInertia&&(t.noInertia=p.noInertia),s.h(r,_),s.h(c,v);this._updateMapTransform(t,r,c),this._changes=[]}_updateMapTransform(t,r,c){const p=this._map,_=p.transform,v=te=>[te.x,te.y,te.z];if((te=>{const oe=this._eventsInProgress.drag;return oe&&!this._handlersById[oe.handlerName].isActive()})()&&!$o(t)){const te=_.zoom;_.cameraElevationReference="sea",this._originalZoom!=null&&_._orthographicProjectionAtLowPitch&&_.projection.name!=="globe"&&_.pitch===0?(_.cameraElevationReference="ground",_.zoom=this._originalZoom):(_.recenterOnTerrain(),_.cameraElevationReference="ground"),te!==_.zoom&&this._map._update(!0)}if(_._isCameraConstrained&&p._stop(!0),!$o(t))return void this._fireEvents(r,c,!0);let{panDelta:b,zoomDelta:I,bearingDelta:M,pitchDelta:L,around:B,aroundCoord:F,pinchAround:V}=t;_._isCameraConstrained&&(I>0&&(I=0),_._isCameraConstrained=!1),V!==void 0&&(B=V),(I||(te=>r[te]&&!this._eventsInProgress[te])("drag"))&&B&&(this._dragOrigin=v(_.pointCoordinate3D(B)),this._originalZoom=_.zoom,this._trackingEllipsoid.setup(_._camera.position,this._dragOrigin)),_.cameraElevationReference="sea",p._stop(!0),B=B||p.transform.centerPoint,M&&(_.bearing+=M),L&&(_.pitch+=L),_._updateCameraState();const $=[0,0,0];if(b)if(_.projection.name==="mercator"){const te=this._trackingEllipsoid.projectRay(_.screenPointToMercatorRay(B).dir),oe=this._trackingEllipsoid.projectRay(_.screenPointToMercatorRay(B.sub(b)).dir);$[0]=oe[0]-te[0],$[1]=oe[1]-te[1]}else{const te=_.pointCoordinate(B);if(_.projection.name==="globe"){b=b.rotate(-_.angle);const oe=_._pixelsPerMercatorPixel/_.worldSize;$[0]=-b.x*s.eL(s.aY(te.y))*oe,$[1]=-b.y*s.eL(_.center.lat)*oe}else{const oe=_.pointCoordinate(B.sub(b));te&&oe&&($[0]=oe.x-te.x,$[1]=oe.y-te.y)}}const H=_.zoom,X=[0,0,0];if(I){const te=v(F||_.pointCoordinate3D(B)),oe={dir:s.au([],s.at([],te,_._camera.position))};if(oe.dir[2]<0){const le=_.zoomDeltaToMovement(te,I);s.c1(X,oe.dir,le)}}const Z=s.d5($,$,X);_._translateCameraConstrained(Z),I&&Math.abs(_.zoom-H)>1e-4&&_.recenterOnTerrain(),_.cameraElevationReference="ground",this._map._update(),t.noInertia||this._inertia.record(t),this._fireEvents(r,c,!0)}_fireEvents(t,r,c){const p=Gs(this._eventsInProgress),_=Gs(t),v={};for(const L in t){const{originalEvent:B}=t[L];this._eventsInProgress[L]||(v[`${L}start`]=B),this._eventsInProgress[L]=t[L]}!p&&_&&this._fireEvent("movestart",_.originalEvent);for(const L in v)this._fireEvent(L,v[L]);_&&this._fireEvent("move",_.originalEvent);for(const L in t){const{originalEvent:B}=t[L];this._fireEvent(L,B)}const b={};let I;for(const L in this._eventsInProgress){const{handlerName:B,originalEvent:F}=this._eventsInProgress[L];this._handlersById[B].isActive()||(delete this._eventsInProgress[L],I=r[B]||F,b[`${L}end`]=I)}for(const L in b)this._fireEvent(L,b[L]);const M=Gs(this._eventsInProgress);if(c&&(p||_)&&!M){this._updatingCamera=!0;const L=this._inertia._onMoveEnd(this._map.dragPan._inertiaOptions),B=F=>F!==0&&-this._bearingSnap<F&&F<this._bearingSnap;L?(B(L.bearing||this._map.getBearing())&&(L.bearing=0),this._map.easeTo(L,{originalEvent:I})):(this._map.fire(new s.A("moveend",{originalEvent:I})),B(this._map.getBearing())&&this._map.resetNorth()),this._updatingCamera=!1}}_fireEvent(t,r){this._map.fire(new s.A(t,r?{originalEvent:r}:{}))}_requestFrame(){return this._map.triggerRepaint(),this._map._renderTaskQueue.add((t=>{this._frameId=void 0,this.handleEvent(new ep("renderFrame",{timeStamp:t})),this._applyChanges()}))}_triggerRenderFrame(){this._frameId===void 0&&(this._frameId=this._requestFrame())}}const as="map.setFreeCameraOptions(...) and map.getFreeCameraOptions() are not yet supported for non-mercator projections.";class Li extends s.E{constructor(t,r){super(),this._moving=!1,this._zooming=!1,this.transform=t,this._bearingSnap=r.bearingSnap,this._respectPrefersReducedMotion=r.respectPrefersReducedMotion!==!1,s.aV(["_renderFrameCallback"],this)}getCenter(){return new s.ci(this.transform.center.lng,this.transform.center.lat)}setCenter(t,r){return this.jumpTo({center:t},r)}panBy(t,r,c){return t=s.P.convert(t).mult(-1),this.panTo(this.transform.center,s.h({offset:t},r),c)}panTo(t,r,c){return this.easeTo(s.h({center:t},r),c)}getZoom(){return this.transform.zoom}setZoom(t,r){return this.jumpTo({zoom:t},r),this}zoomTo(t,r,c){return this.easeTo(s.h({zoom:t},r),c)}zoomIn(t,r){return this.zoomTo(this.getZoom()+1,t,r),this}zoomOut(t,r){return this.zoomTo(this.getZoom()-1,t,r),this}getBearing(){return this.transform.bearing}setBearing(t,r){return this.jumpTo({bearing:t},r),this}getPadding(){return this.transform.padding}setPadding(t,r){return this.jumpTo({padding:t},r),this}rotateTo(t,r,c){return this.easeTo(s.h({bearing:t},r),c)}resetNorth(t,r){return this.rotateTo(0,s.h({duration:1e3},t),r),this}resetNorthPitch(t,r){return this.easeTo(s.h({bearing:0,pitch:0,duration:1e3},t),r),this}snapToNorth(t,r){return Math.abs(this.getBearing())<this._bearingSnap?this.resetNorth(t,r):this}getPitch(){return this.transform.pitch}setPitch(t,r){return this.jumpTo({pitch:t},r),this}cameraForBounds(t,r){t=s.aG.convert(t);const c=r&&r.bearing||0,p=r&&r.pitch||0,_=t.getNorthWest(),v=t.getSouthEast();return this._cameraForBounds(this.transform,_,v,c,p,r)}_extendPadding(t){const r={top:0,right:0,bottom:0,left:0};return t==null?s.h({},r,this.transform.padding):typeof t=="number"?{top:t,bottom:t,right:t,left:t}:s.h({},r,t)}_extendCameraOptions(t){return(t=s.h({offset:[0,0],maxZoom:this.transform.maxZoom},t)).padding=this._extendPadding(t.padding),t}_minimumAABBFrustumDistance(t,r){const c=r.max[0]-r.min[0],p=r.max[1]-r.min[1];return c/p>t.aspect?c/(2*Math.tan(.5*t.fovX)*t.aspect):p/(2*Math.tan(.5*t.fovY)*t.aspect)}_cameraForBoundsOnGlobe(t,r,c,p,_,v){const b=t.clone(),I=this._extendCameraOptions(v);b.bearing=p,b.pitch=_;const M=s.ci.convert(r),L=s.ci.convert(c),B=.5*(M.lat+L.lat),F=.5*(M.lng+L.lng),V=s.eO(B,F),$=s.au([],V),H=s.au([],s.bF([],$,[0,1,0])),X=s.bF([],H,$),Z=[H[0],H[1],H[2],0,X[0],X[1],X[2],0,$[0],$[1],$[2],0,0,0,0,1],te=[V,s.eO(M.lat,M.lng),s.eO(L.lat,M.lng),s.eO(L.lat,L.lng),s.eO(M.lat,L.lng),s.eO(B,M.lng),s.eO(B,L.lng),s.eO(M.lat,F),s.eO(L.lat,F)];let oe=s.d6.fromPoints(te.map((Ue=>[s.bG(H,Ue),s.bG(X,Ue),s.bG($,Ue)])));const le=s.ad([],oe.center,Z);s.eP(le)===0&&s.eQ(le,0,0,1),s.au(le,le),s.c1(le,le,s.aB),b.center=s.eR(le);const pe=b.getWorldToCameraMatrix(),ye=s.bi(new Float64Array(16),pe);oe=s.d6.applyTransform(oe,s.az([],pe,Z));const we=this._extendAABB(oe,b,I,p);if(!we)return void s.w("Map cannot fit within canvas with the given bounds, padding, and/or offset.");oe=we,s.ad(le,le,pe);const me=.5*(oe.max[2]-oe.min[2]),_e=this._minimumAABBFrustumDistance(b,oe),ge=s.c1([],[0,0,1],me),Be=s.d5(ge,le,ge),Ce=_e+(b.pitch===0?0:s.bD(le,Be)),nt=b.globeCenterInViewSpace,He=s.at([],le,[nt[0],nt[1],nt[2]]);s.au(He,He),s.c1(He,He,Ce);const at=s.d5([],le,He);s.ad(at,at,ye);const mt=s.eB/s.aB,ze=s.ae(at),Te=s.cb(Math.max(ze*mt-s.eB,Number.EPSILON),0),Ze=Math.min(b.zoomFromMercatorZAdjusted(Te),I.maxZoom);return Ze>.5*(s.cX+s.cI)?(b.setProjection({name:"mercator"}),b.zoom=Ze,this._cameraForBounds(b,r,c,p,_,v)):{center:b.center,zoom:Ze,bearing:p,pitch:_}}_extendAABB(t,r,c,p){const _=.5*((c.padding.left||0)+(c.padding.right||0)),v=.5*((c.padding.top||0)+(c.padding.bottom||0)),b=v,I=_,M=_,L=v,B=r.width-(I+M),F=r.height-(b+L),V=s.at([],t.max,t.min),$=Math.min(B/V[0],F/V[1]),H=Math.min(r.scaleZoom(r.scale*$),c.maxZoom);if(isNaN(H))return null;const X=r.scale/r.zoomScale(H),Z=new s.d6([t.min[0]-I*X,t.min[1]-L*X,t.min[2]],[t.max[0]+M*X,t.max[1]+b*X,t.max[2]]),te=(typeof c.offset.x=="number"&&typeof c.offset.y=="number"?new s.P(c.offset.x,c.offset.y):s.P.convert(c.offset)).rotate(-s.al(p));return Z.center[0]-=te.x*X,Z.center[1]+=te.y*X,Z}queryTerrainElevation(t,r){const c=this.transform.elevation;return c?(r=s.h({},{exaggerated:!0},r),c.getAtPoint(s.ac.fromLngLat(t),null,r.exaggerated)):null}_cameraForBounds(t,r,c,p,_,v){if(t.projection.name==="globe")return this._cameraForBoundsOnGlobe(t,r,c,p,_,v);const b=t.clone(),I=this._extendCameraOptions(v);b.bearing=p,b.pitch=_;const M=s.ci.convert(r),L=s.ci.convert(c),B=new s.ci(M.lng,L.lat),F=new s.ci(L.lng,M.lat),V=b.project(M),$=b.project(L),H=this.queryTerrainElevation(M),X=this.queryTerrainElevation(L),Z=this.queryTerrainElevation(B),te=this.queryTerrainElevation(F),oe=[[V.x,V.y,Math.min(H||0,X||0,Z||0,te||0)],[$.x,$.y,Math.max(H||0,X||0,Z||0,te||0)]];let le=s.d6.fromPoints(oe);const pe=b.getWorldToCameraMatrix(),ye=s.bi(new Float64Array(16),pe);le=s.d6.applyTransform(le,pe);const we=this._extendAABB(le,b,I,p);if(!we)return void s.w("Map cannot fit within canvas with the given bounds, padding, and/or offset.");le=we;const me=.5*s.at([],le.max,le.min)[2],_e=this._minimumAABBFrustumDistance(b,le),ge=[0,0,1,0];s.aA(ge,ge,pe),s.eS(ge,ge);const Be=s.c1([],ge,_e+me),Ce=s.d5([],le.center,Be);s.ad(le.center,le.center,ye),s.ad(Ce,Ce,ye);const nt=b.unproject(new s.P(le.center[0],le.center[1])),He=s.eT(b.projection,nt),at=Math.pow(2,He),mt=Math.min(b._zoomFromMercatorZ(Ce[2]*b.pixelsPerMeter*at/b.worldSize),I.maxZoom);return b.mercatorFromTransition&&mt<.5*(s.cX+s.cI)?(b.setProjection({name:"globe"}),b.zoom=mt,this._cameraForBounds(b,r,c,p,_,v)):{center:nt,zoom:mt,bearing:p,pitch:_}}fitBounds(t,r,c){const p=this.cameraForBounds(t,r);return this._fitInternal(p,r,c)}fitScreenCoordinates(t,r,c,p,_){const v=s.P.convert(t),b=s.P.convert(r),I=new s.P(Math.min(v.x,b.x),Math.min(v.y,b.y)),M=new s.P(Math.max(v.x,b.x),Math.max(v.y,b.y));if(this.transform.projection.name==="mercator"&&this.transform.anyCornerOffEdge(v,b))return this;const L=this.transform.pointLocation3D(I),B=this.transform.pointLocation3D(M),F=this.transform.pointLocation3D(new s.P(I.x,M.y)),V=this.transform.pointLocation3D(new s.P(M.x,I.y)),$=[Math.min(L.lng,B.lng,F.lng,V.lng),Math.min(L.lat,B.lat,F.lat,V.lat)],H=[Math.max(L.lng,B.lng,F.lng,V.lng),Math.max(L.lat,B.lat,F.lat,V.lat)],X=p&&p.pitch?p.pitch:this.getPitch(),Z=this._cameraForBounds(this.transform,$,H,c,X,p);return this._fitInternal(Z,p,_)}_fitInternal(t,r,c){return t?(r=s.h(t,r)).linear?this.easeTo(r,c):this.flyTo(r,c):this}jumpTo(t,r){this.stop();const c=t.preloadOnly?this.transform.clone():this.transform;let p=!1,_=!1,v=!1;"zoom"in t&&c.zoom!==+t.zoom&&(p=!0,c.zoom=+t.zoom),t.center!==void 0&&(c.center=s.ci.convert(t.center)),"bearing"in t&&c.bearing!==+t.bearing&&(_=!0,c.bearing=+t.bearing),"pitch"in t&&c.pitch!==+t.pitch&&(v=!0,c.pitch=+t.pitch);const b=typeof t.padding=="number"?this._extendPadding(t.padding):t.padding;if(t.padding!=null&&!c.isPaddingEqual(b))if(t.retainPadding===!1){const I=c.clone();I.padding=b,c.setLocationAtPoint(c.center,I.centerPoint)}else c.padding=b;return t.preloadOnly?(this._preloadTiles(c),this):(this.fire(new s.A("movestart",r)).fire(new s.A("move",r)),p&&this.fire(new s.A("zoomstart",r)).fire(new s.A("zoom",r)).fire(new s.A("zoomend",r)),_&&this.fire(new s.A("rotatestart",r)).fire(new s.A("rotate",r)).fire(new s.A("rotateend",r)),v&&this.fire(new s.A("pitchstart",r)).fire(new s.A("pitch",r)).fire(new s.A("pitchend",r)),this.fire(new s.A("moveend",r)))}getFreeCameraOptions(){return this.transform.projection.supportsFreeCamera||s.w(as),this.transform.getFreeCameraOptions()}setFreeCameraOptions(t,r){const c=this.transform;if(!c.projection.supportsFreeCamera)return s.w(as),this;this.stop();const p=c.zoom,_=c.pitch,v=c.bearing;c.setFreeCameraOptions(t);const b=p!==c.zoom,I=_!==c.pitch,M=v!==c.bearing;return this.fire(new s.A("movestart",r)).fire(new s.A("move",r)),b&&this.fire(new s.A("zoomstart",r)).fire(new s.A("zoom",r)).fire(new s.A("zoomend",r)),M&&this.fire(new s.A("rotatestart",r)).fire(new s.A("rotate",r)).fire(new s.A("rotateend",r)),I&&this.fire(new s.A("pitchstart",r)).fire(new s.A("pitch",r)).fire(new s.A("pitchend",r)),this.fire(new s.A("moveend",r)),this}easeTo(t,r){this._stop(!1,t.easeId),((t=s.h({offset:[0,0],duration:500,easing:s.eK},t)).animate===!1||this._prefersReducedMotion(t))&&(t.duration=0);const c=this.transform,p=this.getZoom(),_=this.getBearing(),v=this.getPitch(),b=this.getPadding(),I="zoom"in t?+t.zoom:p,M="bearing"in t?this._normalizeBearing(t.bearing,_):_,L="pitch"in t?+t.pitch:v,B=this._extendPadding(t.padding),F=s.P.convert(t.offset);let V,$,H;if(c.projection.name==="globe"){const ge=s.ac.fromLngLat(c.center),Be=F.rotate(-c.angle);ge.x+=Be.x/c.worldSize,ge.y+=Be.y/c.worldSize;const Ce=ge.toLngLat(),nt=s.ci.convert(t.center||Ce);this._normalizeCenter(nt),V=c.centerPoint.add(Be),$=new s.P(ge.x,ge.y).mult(c.worldSize),H=new s.P(s.aD(nt.lng),s.aH(nt.lat)).mult(c.worldSize).sub($)}else{V=c.centerPoint.add(F);const ge=c.pointLocation(V),Be=s.ci.convert(t.center||ge);this._normalizeCenter(Be),$=c.project(ge),H=c.project(Be).sub($)}const X=c.zoomScale(I-p);let Z,te;t.around&&(Z=s.ci.convert(t.around),te=c.locationPoint(Z));const oe=this._zooming||I!==p,le=this._rotating||_!==M,pe=this._pitching||L!==v,ye=!c.isPaddingEqual(B),we=t.retainPadding===!1?c.clone():c,me=ge=>Be=>{if(oe&&(ge.zoom=s.ai(p,I,Be)),le&&(ge.bearing=s.ai(_,M,Be)),pe&&(ge.pitch=s.ai(v,L,Be)),ye&&(we.interpolatePadding(b,B,Be),V=we.centerPoint.add(F)),Z)ge.setLocationAtPoint(Z,te);else{const Ce=ge.zoomScale(ge.zoom-p),nt=I>p?Math.min(2,X):Math.max(.5,X),He=Math.pow(nt,1-Be),at=ge.unproject($.add(H.mult(Be*He)).mult(Ce));ge.setLocationAtPoint(ge.renderWorldCopies?at.wrap():at,V)}return t.preloadOnly||this._fireMoveEvents(r),ge};if(t.preloadOnly){const ge=this._emulate(me,t.duration,c);return this._preloadTiles(ge),this}const _e={moving:this._moving,zooming:this._zooming,rotating:this._rotating,pitching:this._pitching};return this._zooming=oe,this._rotating=le,this._pitching=pe,this._padding=ye,this._easeId=t.easeId,this._prepareEase(r,t.noMoveStart,_e),this._ease(me(c),(ge=>{c.cameraElevationReference==="sea"&&c.recenterOnTerrain(),this._afterEase(r,ge)}),t),this}_prepareEase(t,r,c={}){this._moving=!0,this.transform.cameraElevationReference="sea",this.transform._orthographicProjectionAtLowPitch&&this.transform.pitch===0&&this.transform.projection.name!=="globe"&&(this.transform.cameraElevationReference="ground"),r||c.moving||this.fire(new s.A("movestart",t)),this._zooming&&!c.zooming&&this.fire(new s.A("zoomstart",t)),this._rotating&&!c.rotating&&this.fire(new s.A("rotatestart",t)),this._pitching&&!c.pitching&&this.fire(new s.A("pitchstart",t))}_fireMoveEvents(t){this.fire(new s.A("move",t)),this._zooming&&this.fire(new s.A("zoom",t)),this._rotating&&this.fire(new s.A("rotate",t)),this._pitching&&this.fire(new s.A("pitch",t))}_afterEase(t,r){if(this._easeId&&r&&this._easeId===r)return;this._easeId=void 0,this.transform.cameraElevationReference="ground";const c=this._zooming,p=this._rotating,_=this._pitching;this._moving=!1,this._zooming=!1,this._rotating=!1,this._pitching=!1,this._padding=!1,c&&this.fire(new s.A("zoomend",t)),p&&this.fire(new s.A("rotateend",t)),_&&this.fire(new s.A("pitchend",t)),this.fire(new s.A("moveend",t))}flyTo(t,r){if(this._prefersReducedMotion(t)){const Ue=s.aF(t,["center","zoom","bearing","pitch","around","padding","retainPadding"]);return this.jumpTo(Ue,r)}this.stop(),t=s.h({offset:[0,0],speed:1.2,curve:1.42,easing:s.eK},t);const c=this.transform,p=this.getZoom(),_=this.getBearing(),v=this.getPitch(),b=this.getPadding(),I="zoom"in t?s.ay(+t.zoom,c.minZoom,c.maxZoom):p,M="bearing"in t?this._normalizeBearing(t.bearing,_):_,L="pitch"in t?+t.pitch:v,B=this._extendPadding(t.padding),F=c.zoomScale(I-p),V=s.P.convert(t.offset);let $=c.centerPoint.add(V);const H=c.pointLocation($),X=s.ci.convert(t.center||H);this._normalizeCenter(X);const Z=c.project(H),te=c.project(X).sub(Z);let oe=t.curve;const le=Math.max(c.width,c.height),pe=le/F,ye=te.mag();if("minZoom"in t){const Ue=s.ay(Math.min(t.minZoom,p,I),c.minZoom,c.maxZoom),dt=le/c.zoomScale(Ue-p);oe=Math.sqrt(dt/ye*2)}const we=oe*oe;function me(Ue){const dt=(pe*pe-le*le+(Ue?-1:1)*we*we*ye*ye)/(2*(Ue?pe:le)*we*ye);return Math.log(Math.sqrt(dt*dt+1)-dt)}function _e(Ue){return(Math.exp(Ue)-Math.exp(-Ue))/2}function ge(Ue){return(Math.exp(Ue)+Math.exp(-Ue))/2}const Be=me(0);let Ce=function(Ue){return ge(Be)/ge(Be+oe*Ue)},nt=function(Ue){return le*((ge(Be)*(_e(dt=Be+oe*Ue)/ge(dt))-_e(Be))/we)/ye;var dt},He=(me(1)-Be)/oe;if(Math.abs(ye)<1e-6||!isFinite(He)){if(Math.abs(le-pe)<1e-6)return this.easeTo(t,r);const Ue=pe<le?-1:1;He=Math.abs(Math.log(pe/le))/oe,nt=function(){return 0},Ce=function(dt){return Math.exp(Ue*oe*dt)}}t.duration="duration"in t?+t.duration:1e3*He/("screenSpeed"in t?+t.screenSpeed/oe:+t.speed),t.maxDuration&&t.duration>t.maxDuration&&(t.duration=0);const at=_!==M,mt=L!==v,ze=!c.isPaddingEqual(B),Te=t.retainPadding===!1?c.clone():c,Ze=Ue=>dt=>{const ft=dt*He,xt=1/Ce(ft);Ue.zoom=dt===1?I:p+Ue.scaleZoom(xt),at&&(Ue.bearing=s.ai(_,M,dt)),mt&&(Ue.pitch=s.ai(v,L,dt)),ze&&(Te.interpolatePadding(b,B,dt),$=Te.centerPoint.add(V));const It=dt===1?X:Ue.unproject(Z.add(te.mult(nt(ft))).mult(xt));return Ue.setLocationAtPoint(Ue.renderWorldCopies?It.wrap():It,$),Ue._updateCameraOnTerrain(),t.preloadOnly||this._fireMoveEvents(r),Ue};if(t.preloadOnly){const Ue=this._emulate(Ze,t.duration,c);return this._preloadTiles(Ue),this}return this._zooming=!0,this._rotating=at,this._pitching=mt,this._padding=ze,this._prepareEase(r,!1),this._ease(Ze(c),(()=>this._afterEase(r)),t),this}isEasing(){return!!this._easeFrameId}stop(){return this._stop()}_requestRenderFrame(t){}_cancelRenderFrame(t){}_stop(t,r){if(this._easeFrameId&&(this._cancelRenderFrame(this._easeFrameId),this._easeFrameId=void 0,this._onEaseFrame=void 0),this._onEaseEnd){const c=this._onEaseEnd;this._onEaseEnd=void 0,c.call(this,r)}if(!t){const c=this.handlers;c&&c.stop(!1)}return this}_ease(t,r,c){c.animate===!1||c.duration===0?(t(1),r()):(this._easeStart=s.q.now(),this._easeOptions=c,this._onEaseFrame=t,this._onEaseEnd=r,this._easeFrameId=this._requestRenderFrame(this._renderFrameCallback))}_renderFrameCallback(){const t=Math.min((s.q.now()-this._easeStart)/this._easeOptions.duration,1),r=this._onEaseFrame;r&&r(this._easeOptions.easing(t)),t<1?this._easeFrameId=this._requestRenderFrame(this._renderFrameCallback):this.stop()}_normalizeBearing(t,r){t=s.bQ(t,-180,180);const c=Math.abs(t-r);return Math.abs(t-360-r)<c&&(t-=360),Math.abs(t+360-r)<c&&(t+=360),t}_normalizeCenter(t){const r=this.transform;if(r.maxBounds||r.projection.name!=="globe"&&!r.renderWorldCopies)return;const c=t.lng-r.center.lng;t.lng+=c>180?-360:c<-180?360:0}_prefersReducedMotion(t){return this._respectPrefersReducedMotion&&s.q.prefersReducedMotion&&!(t&&t.essential)}_emulate(t,r,c){const p=Math.ceil(15*r/1e3),_=[],v=t(c.clone());for(let b=0;b<=p;b++){const I=v(b/p);_.push(I.clone())}return _}_preloadTiles(t,r){}}class Sl{constructor(t={}){this.options=t,s.aV(["_toggleAttribution","_updateEditLink","_updateData","_updateCompact"],this)}getDefaultPosition(){return"bottom-right"}onAdd(t){const r=this.options&&this.options.compact,c=t._getUIString("AttributionControl.ToggleAttribution");this._map=t,this._container=ct("div","mapboxgl-ctrl mapboxgl-ctrl-attrib"),this._compactButton=ct("button","mapboxgl-ctrl-attrib-button",this._container),this._compactButton.type="button",this._compactButton.addEventListener("click",this._toggleAttribution),this._compactButton.setAttribute("aria-label",c);const p=ct("span","mapboxgl-ctrl-icon",this._compactButton);return p.setAttribute("aria-hidden","true"),p.setAttribute("title",c),this._innerContainer=ct("div","mapboxgl-ctrl-attrib-inner",this._container),r&&this._container.classList.add("mapboxgl-compact"),this._updateAttributions(),this._updateEditLink(),this._map.on("styledata",this._updateData),this._map.on("sourcedata",this._updateData),this._map.on("moveend",this._updateEditLink),r===void 0&&(this._map.on("resize",this._updateCompact),this._updateCompact()),this._container}onRemove(){this._container.remove(),this._map.off("styledata",this._updateData),this._map.off("sourcedata",this._updateData),this._map.off("moveend",this._updateEditLink),this._map.off("resize",this._updateCompact),this._map=void 0,this._attribHTML=void 0}_toggleAttribution(){this._container.classList.contains("mapboxgl-compact-show")?(this._container.classList.remove("mapboxgl-compact-show"),this._compactButton.setAttribute("aria-expanded","false")):(this._container.classList.add("mapboxgl-compact-show"),this._compactButton.setAttribute("aria-expanded","true"))}_updateEditLink(){let t=this._editLink;t||(t=this._editLink=this._container.querySelector(".mapbox-improve-map"));const r=[{key:"owner",value:this.styleOwner},{key:"id",value:this.styleId},{key:"access_token",value:this._map._requestManager._customAccessToken||s.e.ACCESS_TOKEN}];if(t){const c=r.reduce(((p,_,v)=>(_.value&&(p+=`${_.key}=${_.value}${v<r.length-1?"&":""}`),p)),"?");t.href=`${s.e.FEEDBACK_URL}/${c}#${sa(this._map,!0)}`,t.rel="noopener nofollow"}}_updateData(t){!t||t.sourceDataType!=="metadata"&&t.sourceDataType!=="visibility"&&t.dataType!=="style"||(this._updateAttributions(),this._updateEditLink())}_updateAttributions(){if(!this._map.style)return;let t=[];if(this._map.style.stylesheet){const p=this._map.style.stylesheet;this.styleOwner=p.owner,this.styleId=p.id}const r=this._map.style._mergedSourceCaches;for(const p in r){const _=r[p];if(_.used){const v=_.getSource();v.attribution&&t.indexOf(v.attribution)<0&&t.push(v.attribution)}}t.sort(((p,_)=>p.length-_.length)),t=t.filter(((p,_)=>{for(let v=_+1;v<t.length;v++)if(t[v].indexOf(p)>=0)return!1;return!0})),this.options.customAttribution&&(Array.isArray(this.options.customAttribution)?t=[...this.options.customAttribution,...t]:t.unshift(this.options.customAttribution));const c=t.join(" | ");c!==this._attribHTML&&(this._attribHTML=c,t.length?(this._innerContainer.innerHTML=c,this._container.classList.remove("mapboxgl-attrib-empty")):this._container.classList.add("mapboxgl-attrib-empty"),this._editLink=null)}_updateCompact(){this._map.getCanvasContainer().offsetWidth<=640?this._container.classList.add("mapboxgl-compact"):this._container.classList.remove("mapboxgl-compact","mapboxgl-compact-show")}}class zu{constructor(){s.aV(["_updateLogo","_updateCompact"],this)}onAdd(t){this._map=t,this._container=ct("div","mapboxgl-ctrl");const r=ct("a","mapboxgl-ctrl-logo");return r.target="_blank",r.rel="noopener nofollow",r.href="https://www.mapbox.com/",r.setAttribute("aria-label",this._map._getUIString("LogoControl.Title")),r.setAttribute("rel","noopener nofollow"),this._container.appendChild(r),this._container.style.display="none",this._map.on("sourcedata",this._updateLogo),this._updateLogo(),this._map.on("resize",this._updateCompact),this._updateCompact(),this._container}onRemove(){this._container.remove(),this._map.off("sourcedata",this._updateLogo),this._map.off("resize",this._updateCompact)}getDefaultPosition(){return"bottom-left"}_updateLogo(t){t&&t.sourceDataType!=="metadata"||(this._container.style.display=this._logoRequired()?"block":"none")}_logoRequired(){if(!this._map.style)return!0;const t=this._map.style._sourceCaches;if(Object.entries(t).length===0)return!0;for(const r in t){const c=t[r].getSource();if(c.hasOwnProperty("mapbox_logo")&&!c.mapbox_logo)return!1}return!0}_updateCompact(){const t=this._container.children;if(t.length){const r=t[0];this._map.getCanvasContainer().offsetWidth<250?r.classList.add("mapboxgl-compact"):r.classList.remove("mapboxgl-compact")}}}class cf{constructor(){s.aV(["_onIndoorUpdate"],this)}onAdd(t){return this._map=t,this._container=ct("div","mapboxgl-ctrl mapboxgl-ctrl-group"),this._map.indoor.on("indoorupdate",(r=>this._onIndoorUpdate({selectedFloorId:r.selectedFloorId,floors:r.floors}))),this._container}_createButton(t,r){const c=ct("button",t,this._container);return c.type="button",c.addEventListener("click",r),c}_setButtonTitle(t,r){this._map&&(t.setAttribute("aria-label",r),t.innerHTML=`<strong>${r}</strong>`,t.firstElementChild&&t.firstElementChild.setAttribute("title",r))}onRemove(){this._container&&this._container.remove(),this._map&&this._map.indoor&&(this._map.indoor.off("indoorupdate",this._onIndoorUpdate),this._map=null)}getDefaultPosition(){return"right"}_onIndoorUpdate(t){if(!t||!t.floors)return void(this._container.style.display="none");const r=this._model;this._model=t,this._container.style.display="inline-block";const c=t.floors.sort(((p,_)=>p.levelOrder-_.levelOrder));r?(Array.from(this._container.children).forEach((p=>p.remove())),this.addCurrentFloors(c)):this.addCurrentFloors(c)}addCurrentFloors(t){for(const r of t){const c=this._createButton("mapboxgl-ctrl-level-button",(()=>{this._map._selectIndoorFloor(r.id),Array.from(this._container.children).forEach((p=>{p.classList.remove("mapboxgl-ctrl-level-button-selected")})),c.classList.add("mapboxgl-ctrl-level-button-selected")}));this._setButtonTitle(c,r.shortName),this._model&&r.id===this._model.selectedFloorId&&(this._map._selectIndoorFloor(r.id),c.classList.add("mapboxgl-ctrl-level-button-selected")),this._container.append(c)}}}class Dp{constructor(){this._queue=[],this._id=0,this._cleared=!1,this._currentlyRunning=!1}add(t){const r=++this._id;return this._queue.push({callback:t,id:r,cancelled:!1}),r}remove(t){const r=this._currentlyRunning,c=r?this._queue.concat(r):this._queue;for(const p of c)if(p.id===t)return void(p.cancelled=!0)}run(t=0){const r=this._currentlyRunning=this._queue;this._queue=[];for(const c of r)if(!c.cancelled&&(c.callback(t),this._cleared))break;this._cleared=!1,this._currentlyRunning=!1}clear(){this._currentlyRunning&&(this._cleared=!0),this._queue=[]}}class bc{constructor(t){this.jumpTo(t)}getValue(t){if(t<=this._startTime)return this._start;if(t>=this._endTime)return this._end;const r=s.dx((t-this._startTime)/(this._endTime-this._startTime));return this._start*(1-r)+this._end*r}isEasing(t){return t>=this._startTime&&t<=this._endTime}jumpTo(t){this._startTime=-1/0,this._endTime=-1/0,this._start=t,this._end=t}easeTo(t,r,c){this._start=this.getValue(r),this._end=t,this._startTime=r,this._endTime=r+c}}const uf={"AttributionControl.ToggleAttribution":"Toggle attribution","FullscreenControl.Enter":"Enter fullscreen","FullscreenControl.Exit":"Exit fullscreen","GeolocateControl.FindMyLocation":"Find my location","GeolocateControl.LocationNotAvailable":"Location not available","LogoControl.Title":"Mapbox homepage","Map.Title":"Map","NavigationControl.ResetBearing":"Reset bearing to north","NavigationControl.ZoomIn":"Zoom in","NavigationControl.ZoomOut":"Zoom out","ScrollZoomBlocker.CtrlMessage":"Use ctrl + scroll to zoom the map","ScrollZoomBlocker.CmdMessage":"Use ⌘ + scroll to zoom the map","TouchPanBlocker.Message":"Use two fingers to move the map"};class hf extends s.A{constructor(t,r,c,p){const{point:_,lngLat:v,originalEvent:b,target:I}=t;super(t.type,{point:_,lngLat:v,originalEvent:b,target:I}),this.preventDefault=()=>{t.preventDefault()},this.id=r,this.interaction=c,this.feature=p}}class df{constructor(t){this.map=t,this.interactionsByType=new Map,this.delegatedInteractions=new Map,this.typeById=new Map,this.filters=new Map,this.handleType=this.handleType.bind(this),this.handleMove=this.handleMove.bind(this),this.handleOut=this.handleOut.bind(this),this.hoveredFeatures=new Map,this.prevHoveredFeatures=new Map}add(t,r){if(this.typeById.has(t))throw new Error(`Interaction id "${t}" already exists.`);const c=r.filter;let p=r.type;c&&this.filters.set(t,s.b3(c)),p==="mouseover"&&(p="mouseenter"),p==="mouseout"&&(p="mouseleave");const _=this.interactionsByType.get(p)||new Map;p==="mouseenter"||p==="mouseleave"?(this.delegatedInteractions.size===0&&(this.map.on("mousemove",this.handleMove),this.map.on("mouseout",this.handleOut)),this.delegatedInteractions.set(t,r)):_.size===0&&this.map.on(p,this.handleType),_.size===0&&this.interactionsByType.set(p,_),_.set(t,r),this.typeById.set(t,p)}get(t){const r=this.typeById.get(t);if(!r)return;const c=this.interactionsByType.get(r);return c?c.get(t):void 0}remove(t){const r=this.typeById.get(t);if(!r)return;this.typeById.delete(t),this.filters.delete(t);const c=this.interactionsByType.get(r);c&&(c.delete(t),r==="mouseenter"||r==="mouseleave"?(this.delegatedInteractions.delete(t),this.delegatedInteractions.size===0&&(this.map.off("mousemove",this.handleMove),this.map.off("mouseout",this.handleOut))):c.size===0&&this.map.off(r,this.handleType))}queryTargets(t,r){const c=[];for(const[p,_]of r)_.target&&c.push({targetId:p,target:_.target,filter:this.filters.get(p)});return this.map.style.queryRenderedTargets(t,c,this.map.transform)}handleMove(t){this.prevHoveredFeatures=this.hoveredFeatures,this.hoveredFeatures=new Map;const r=this.queryTargets(t.point,Array.from(this.delegatedInteractions).reverse());r.length&&(t.type="mouseenter",this.handleType(t,r));const c=new Map;for(const[p,{feature:_}]of this.prevHoveredFeatures)this.hoveredFeatures.has(p)||c.set(_.id,_);c.size&&(t.type="mouseleave",this.handleType(t,Array.from(c.values())))}handleOut(t){const r=Array.from(this.hoveredFeatures.values()).map((({feature:c})=>c));r.length&&(t.type="mouseleave",this.handleType(t,r)),this.hoveredFeatures.clear()}handleType(t,r){const c=t.type==="mouseenter";if(c&&!this.interactionsByType.has(t.type))return void s.w("mouseenter interaction required for mouseleave to work.");const p=Array.from(this.interactionsByType.get(t.type)).reverse(),_=!!r;r=r||this.queryTargets(t.point,p);let v=!1;const b=new Set;for(const I of r){for(const[M,L]of p){if(!L.target)continue;const B=I.variants?I.variants[M]:null;if(B){for(const F of B){if(al(F,I,b,M))continue;const V=new s.dr(I,F),$=kl(F,I,M);_&&(V.state=this.map.getFeatureState(V));const H=c?this.prevHoveredFeatures.get($):null,X=new hf(t,M,L,V),Z=H?H.stop:L.handler(X);if(c&&this.hoveredFeatures.set($,{feature:I,stop:Z}),Z!==!1){v=!0;break}}if(v)break}}if(v)break}if(!v)for(const[I,M]of p){const{handler:L,target:B}=M;if(!B&&L(new hf(t,I,M,null))!==!1)break}}}function ff(l,t){if(Array.isArray(l)&&Array.isArray(t)){const r=new Set(l),c=new Set(t);return r.size===c.size&&l.every((p=>c.has(p)))}return s.bv(l,t)}const gh={center:[0,0],zoom:0,bearing:0,pitch:0,minZoom:-2,maxZoom:22,minPitch:0,maxPitch:85,interactive:!0,scrollZoom:!0,boxZoom:!0,dragRotate:!0,dragPan:!0,keyboard:!0,doubleClickZoom:!0,touchZoomRotate:!0,touchPitch:!0,cooperativeGestures:!1,performanceMetricsCollection:!0,bearingSnap:7,clickTolerance:3,pitchWithRotate:!0,hash:!1,attributionControl:!0,antialias:!1,failIfMajorPerformanceCaveat:!1,preserveDrawingBuffer:!1,trackResize:!0,renderWorldCopies:!0,refreshExpiredTiles:!0,minTileCacheSize:null,maxTileCacheSize:null,localIdeographFontFamily:"sans-serif",localFontFamily:null,transformRequest:null,accessToken:null,fadeDuration:300,respectPrefersReducedMotion:!0,crossSourceCollisions:!0,collectResourceTiming:!1,testMode:!1,precompilePrograms:!0,scaleFactor:1,spriteFormat:"auto"},Xc={showCompass:!0,showZoom:!0,visualizePitch:!1};class Il{constructor(t,r,c=!1){this._clickTolerance=10,this.element=r,this.mouseRotate=new ad({clickTolerance:t.dragRotate._mouseRotate._clickTolerance}),this.map=t,c&&(this.mousePitch=new ld({clickTolerance:t.dragRotate._mousePitch._clickTolerance})),s.aV(["mousedown","mousemove","mouseup","touchstart","touchmove","touchend","reset"],this),r.addEventListener("mousedown",this.mousedown),r.addEventListener("touchstart",this.touchstart,{passive:!1}),r.addEventListener("touchmove",this.touchmove),r.addEventListener("touchend",this.touchend),r.addEventListener("touchcancel",this.reset)}down(t,r){this.mouseRotate.mousedown(t,r),this.mousePitch&&this.mousePitch.mousedown(t,r),en()}move(t,r){const c=this.map,p=this.mouseRotate.mousemoveWindow(t,r),_=p&&p.bearingDelta;if(_&&c.setBearing(c.getBearing()+_),this.mousePitch){const v=this.mousePitch.mousemoveWindow(t,r),b=v&&v.pitchDelta;b&&c.setPitch(c.getPitch()+b)}}off(){const t=this.element;t.removeEventListener("mousedown",this.mousedown),t.removeEventListener("touchstart",this.touchstart),t.removeEventListener("touchmove",this.touchmove),t.removeEventListener("touchend",this.touchend),t.removeEventListener("touchcancel",this.reset),this.offTemp()}offTemp(){Hn(),window.removeEventListener("mousemove",this.mousemove),window.removeEventListener("mouseup",this.mouseup)}mousedown(t){this.down(s.h({},t,{ctrlKey:!0,preventDefault:()=>t.preventDefault()}),De(this.element,t)),window.addEventListener("mousemove",this.mousemove),window.addEventListener("mouseup",this.mouseup)}mousemove(t){this.move(t,De(this.element,t))}mouseup(t){this.mouseRotate.mouseupWindow(t),this.mousePitch&&this.mousePitch.mouseupWindow(t),this.offTemp()}touchstart(t){t.targetTouches.length!==1?this.reset():(this._startPos=this._lastPos=je(this.element,t.targetTouches)[0],this.down({type:"mousedown",button:0,ctrlKey:!0,preventDefault:()=>t.preventDefault()},this._startPos))}touchmove(t){t.targetTouches.length!==1?this.reset():(this._lastPos=je(this.element,t.targetTouches)[0],this.move({preventDefault:()=>t.preventDefault()},this._lastPos))}touchend(t){t.targetTouches.length===0&&this._startPos&&this._lastPos&&this._startPos.dist(this._lastPos)<this._clickTolerance&&this.element.click(),this.reset()}reset(){this.mouseRotate.reset(),this.mousePitch&&this.mousePitch.reset(),delete this._startPos,delete this._lastPos,this.offTemp()}}function es(l,t,r){if(l=new s.ci(l.lng,l.lat),t){const c=new s.ci(l.lng-360,l.lat),p=new s.ci(l.lng+360,l.lat),_=360*Math.ceil(Math.abs(l.lng-r.center.lng)/360),v=r.locationPoint3D(l).distSqr(t),b=t.x<0||t.y<0||t.x>r.width||t.y>r.height;r.locationPoint3D(c).distSqr(t)<v&&(b||Math.abs(c.lng-r.center.lng)<_)?l=c:r.locationPoint3D(p).distSqr(t)<v&&(b||Math.abs(p.lng-r.center.lng)<_)&&(l=p)}for(;Math.abs(l.lng-r.center.lng)>180;){const c=r.locationPoint3D(l);if(c.x>=0&&c.y>=0&&c.x<=r.width&&c.y<=r.height)break;l.lng>r.center.lng?l.lng-=360:l.lng+=360}return l}const Es={center:"translate(-50%,-50%)",top:"translate(-50%,0)","top-left":"translate(0,0)","top-right":"translate(-100%,0)",bottom:"translate(-50%,-100%)","bottom-left":"translate(0,-100%)","bottom-right":"translate(-100%,-100%)",left:"translate(0,-50%)",right:"translate(-100%,-50%)"},Ss={rotation:0,rotationAlignment:"auto",pitchAlignment:"auto",occludedOpacity:.2,altitude:0};class oa extends s.E{constructor(t,r){super(),(t instanceof HTMLElement||r)&&(t=s.h({element:t},r)),s.aV(["_update","_onMove","_onUp","_addDragHandler","_onMapClick","_onKeyPress","_clearFadeTimer"],this);const{anchor:c="center",color:p="#3FB1CE",scale:_=1,draggable:v=!1,clickTolerance:b=0,rotation:I=Ss.rotation,rotationAlignment:M=Ss.rotationAlignment,pitchAlignment:L=Ss.pitchAlignment,occludedOpacity:B=Ss.occludedOpacity,altitude:F=Ss.altitude}=t||{};this._anchor=c,this._color=p,this._scale=_,this._draggable=v,this._clickTolerance=b,this._rotation=I,this._rotationAlignment=M,this._pitchAlignment=L,this._occludedOpacity=B,this._altitude=F,this._state="inactive",this._isDragging=!1,this._updateMoving=()=>this._update(!0),t&&t.element?(this._element=t.element,this._offset=s.P.convert(t&&t.offset||[0,0])):(this._defaultMarker=!0,this._element=this._createDefaultMarker(),this._offset=s.P.convert(t&&t.offset||[0,-14])),this._element.hasAttribute("aria-label")||this._element.setAttribute("aria-label","Map marker"),this._element.hasAttribute("role")||this._element.setAttribute("role","img"),this._element.classList.add("mapboxgl-marker"),this._element.addEventListener("dragstart",(H=>{H.preventDefault()})),this._element.addEventListener("mousedown",(H=>{H.preventDefault()}));const V=this._element.classList;for(const H in Es)V.remove(`mapboxgl-marker-anchor-${H}`);V.add(`mapboxgl-marker-anchor-${this._anchor}`);const $=t&&t.className?t.className.trim().split(/\s+/):[];V.add(...$),this._popup=null}_createDefaultMarker(){const t=ct("div"),r=wt("svg",{display:"block",height:41*this._scale+"px",width:27*this._scale+"px",viewBox:"0 0 27 41"},t);if(this._altitude===0){const c=wt("radialGradient",{id:"shadowGradient"},wt("defs",{},r));wt("stop",{offset:"10%","stop-opacity":.4},c),wt("stop",{offset:"100%","stop-opacity":.05},c),wt("ellipse",{cx:13.5,cy:34.8,rx:10.5,ry:5.25,fill:"url(#shadowGradient)"},r)}return wt("path",{fill:this._color,d:"M27,13.5C27,19.07 20.25,27 14.75,34.5C14.02,35.5 12.98,35.5 12.25,34.5C6.75,27 0,19.22 0,13.5C0,6.04 6.04,0 13.5,0C20.96,0 27,6.04 27,13.5Z"},r),wt("path",{opacity:.25,d:"M13.5,0C6.04,0 0,6.04 0,13.5C0,19.22 6.75,27 12.25,34.5C13,35.52 14.02,35.5 14.75,34.5C20.25,27 27,19.07 27,13.5C27,6.04 20.96,0 13.5,0ZM13.5,1C20.42,1 26,6.58 26,13.5C26,15.9 24.5,19.18 22.22,22.74C19.95,26.3 16.71,30.14 13.94,33.91C13.74,34.18 13.61,34.32 13.5,34.44C13.39,34.32 13.26,34.18 13.06,33.91C10.28,30.13 7.41,26.31 5.02,22.77C2.62,19.23 1,15.95 1,13.5C1,6.58 6.58,1 13.5,1Z"},r),wt("circle",{fill:"white",cx:13.5,cy:13.5,r:5.5},r),t}addTo(t){return t===this._map||(this.remove(),this._map=t,t.getCanvasContainer().appendChild(this._element),t.on("move",this._updateMoving),t.on("moveend",this._update),t.on("remove",this._clearFadeTimer),t._addMarker(this),this.setDraggable(this._draggable),this._update(),t.on("click",this._onMapClick)),this}remove(){const t=this._map;return t&&(t.off("click",this._onMapClick),t.off("move",this._updateMoving),t.off("moveend",this._update),t.off("mousedown",this._addDragHandler),t.off("touchstart",this._addDragHandler),t.off("mouseup",this._onUp),t.off("touchend",this._onUp),t.off("mousemove",this._onMove),t.off("touchmove",this._onMove),t.off("remove",this._clearFadeTimer),t._removeMarker(this),this._map=void 0),this._clearFadeTimer(),this._element.remove(),this._popup&&this._popup.remove(),this}getLngLat(){return this._lngLat}setLngLat(t){return this._lngLat=s.ci.convert(t),this._pos=null,this._popup&&this._popup.setLngLat(this._lngLat),this._update(!0),this}setAltitude(t){return t===this._altitude||(this._defaultMarker&&(this._altitude===0&&t!==0||this._altitude!==0&&t===0)&&(this._element=this._createDefaultMarker()),this._altitude=t||Ss.altitude,this._update()),this}getAltitude(){return this._altitude}getElement(){return this._element}setPopup(t){if(this._popup&&(this._popup.remove(),this._popup=null,this._element.removeAttribute("role"),this._element.removeEventListener("keypress",this._onKeyPress),this._originalTabIndex||this._element.removeAttribute("tabindex")),t){if(!("offset"in t.options)){const p=Math.sqrt(Math.pow(13.5,2)/2);t.options.offset=this._defaultMarker?{top:[0,0],"top-left":[0,0],"top-right":[0,0],bottom:[0,-38.1],"bottom-left":[p,-1*(38.1-13.5+p)],"bottom-right":[-p,-1*(38.1-13.5+p)],left:[13.5,-1*(38.1-13.5)],right:[-13.5,-1*(38.1-13.5)]}:this._offset}this._popup=t,t._marker=this,t._altitude=this._altitude,this._lngLat&&this._popup.setLngLat(this._lngLat),this._element.setAttribute("role","button"),this._originalTabIndex=this._element.getAttribute("tabindex"),this._originalTabIndex||this._element.setAttribute("tabindex","0"),this._element.addEventListener("keypress",this._onKeyPress),this._element.setAttribute("aria-expanded","false")}return this}_onKeyPress(t){const r=t.code,c=t.charCode||t.keyCode;r!=="Space"&&r!=="Enter"&&c!==32&&c!==13||this.togglePopup()}_onMapClick(t){const r=t.originalEvent.target,c=this._element;this._popup&&(r===c||c.contains(r))&&this.togglePopup()}getPopup(){return this._popup}togglePopup(){const t=this._popup;return t?(t.isOpen()?(t.remove(),this._element.setAttribute("aria-expanded","false")):this._map&&(t.addTo(this._map),this._element.setAttribute("aria-expanded","true")),this):this}_behindTerrain(){const t=this._map,r=this._pos;if(!t||!r)return!1;const c=t.unproject(r,this._altitude),p=t.getFreeCameraOptions();if(!p.position)return!1;const _=p.position.toLngLat();return _.distanceTo(c)<.9*_.distanceTo(this._lngLat)}_evaluateOpacity(){const t=this._map;if(!t)return;const r=this._pos;if(!r||r.x<0||r.x>t.transform.width||r.y<0||r.y>t.transform.height)return void this._clearFadeTimer();const c=t.unproject(r,this._altitude);let p;t._showingGlobe()&&s.eW(t.transform,this._lngLat)?p=0:(p=1-t._queryFogOpacity(c),t.transform._terrainEnabled()&&t.getTerrain()&&this._behindTerrain()&&(p*=this._occludedOpacity)),this._element.style.opacity=`${p}`,this._element.style.pointerEvents=p>0?"auto":"none",this._popup&&this._popup._setOpacity(p),this._fadeTimer=null}_clearFadeTimer(){this._fadeTimer&&(clearTimeout(this._fadeTimer),this._fadeTimer=null)}_updateDOM(){const t=this._pos;if(!t||!this._map)return;const r=this._offset.mult(this._scale);this._element.style.transform=`
            translate(${t.x}px,${t.y}px)
            ${Es[this._anchor]}
            ${this._calculateXYTransform()} ${this._calculateZTransform()}
            translate(${r.x}px,${r.y}px)
        `}_calculateXYTransform(){const t=this._pos,r=this._map,c=this.getPitchAlignment();if(!r||!t||c!=="map")return"";if(!r._showingGlobe()){const I=r.getPitch();return I?`rotateX(${I}deg)`:""}const p=s.cU(s.eX(r.transform,this._lngLat)),_=t.sub(s.eY(r.transform)),v=Math.abs(_.x)+Math.abs(_.y);if(v===0)return"";const b=p/v;return`rotateX(${-_.y*b}deg) rotateY(${_.x*b}deg)`}_calculateZTransform(){const t=this._pos,r=this._map;if(!r||!t)return"";let c=0;const p=this.getRotationAlignment();if(p==="map")if(r._showingGlobe()){const _=r.project(new s.ci(this._lngLat.lng,this._lngLat.lat+.001),this._altitude),v=r.project(new s.ci(this._lngLat.lng,this._lngLat.lat-.001),this._altitude).sub(_);c=s.cU(Math.atan2(v.y,v.x))-90}else c=-r.getBearing();else if(p==="horizon"){const _=s.af(4,6,r.getZoom()),v=s.eY(r.transform);v.y+=_*r.transform.height;const b=t.sub(v),I=s.cU(Math.atan2(b.y,b.x));c=(I>90?I-270:I+90)*(1-_)}return c+=this._rotation,c?`rotateZ(${c}deg)`:""}_update(t){cancelAnimationFrame(this._updateFrameId);const r=this._map;r&&(r.transform.renderWorldCopies&&(this._lngLat=es(this._lngLat,this._pos,r.transform)),this._pos=r.project(this._lngLat,this._altitude),t===!0?this._updateFrameId=requestAnimationFrame((()=>{this._element&&this._pos&&this._anchor&&(this._pos=this._pos.round(),this._updateDOM())})):this._pos=this._pos.round(),r._requestDomTask((()=>{this._map&&(this._element&&this._pos&&this._anchor&&this._updateDOM(),(r._showingGlobe()||r.getTerrain()||r.getFog())&&!this._fadeTimer&&(this._fadeTimer=window.setTimeout(this._evaluateOpacity.bind(this),60)))})))}getOffset(){return this._offset}setOffset(t){return this._offset=s.P.convert(t),this._update(),this}addClassName(t){return this._element.classList.add(t),this}removeClassName(t){return this._element.classList.remove(t),this}toggleClassName(t){return this._element.classList.toggle(t)}_onMove(t){const r=this._map;if(!r)return;const c=this._pointerdownPos,p=this._positionDelta;if(c&&p){if(!this._isDragging){const _=this._clickTolerance||r._clickTolerance;if(t.point.dist(c)<_)return;this._isDragging=!0}this._pos=t.point.sub(p),this._lngLat=r.unproject(this._pos,this._altitude),this.setLngLat(this._lngLat),this._element.style.pointerEvents="none",this._state==="pending"&&(this._state="active",this.fire(new s.A("dragstart"))),this.fire(new s.A("drag"))}}_onUp(){this._element.style.pointerEvents="auto",this._positionDelta=null,this._pointerdownPos=null,this._isDragging=!1;const t=this._map;t&&(t.off("mousemove",this._onMove),t.off("touchmove",this._onMove)),this._state==="active"&&this.fire(new s.A("dragend")),this._state="inactive"}_addDragHandler(t){const r=this._map,c=this._pos;r&&c&&this._element.contains(t.originalEvent.target)&&(t.preventDefault(),this._positionDelta=t.point.sub(c),this._pointerdownPos=t.point,this._state="pending",r.on("mousemove",this._onMove),r.on("touchmove",this._onMove),r.once("mouseup",this._onUp),r.once("touchend",this._onUp))}setDraggable(t){this._draggable=!!t;const r=this._map;return r&&(t?(r.on("mousedown",this._addDragHandler),r.on("touchstart",this._addDragHandler)):(r.off("mousedown",this._addDragHandler),r.off("touchstart",this._addDragHandler))),this}isDraggable(){return this._draggable}setRotation(t){return this._rotation=t||Ss.rotation,this._update(),this}getRotation(){return this._rotation}setRotationAlignment(t){return this._rotationAlignment=t||Ss.rotationAlignment,this._update(),this}getRotationAlignment(){return this._rotationAlignment==="auto"||this._rotationAlignment==="horizon"&&this._map&&!this._map._showingGlobe()?"viewport":this._rotationAlignment}setPitchAlignment(t){return this._pitchAlignment=t||Ss.pitchAlignment,this._update(),this}getPitchAlignment(){return this._pitchAlignment==="auto"?this.getRotationAlignment():this._pitchAlignment}setOccludedOpacity(t){return this._occludedOpacity=t||Ss.occludedOpacity,this._update(),this}getOccludedOpacity(){return this._occludedOpacity}}const Lp={positionOptions:{enableHighAccuracy:!1,maximumAge:0,timeout:6e3},fitBoundsOptions:{maxZoom:15},trackUserLocation:!1,showAccuracyCircle:!0,showUserLocation:!0,showUserHeading:!1},Al={maxWidth:100,unit:"metric"},kp={kilometer:"km",meter:"m",mile:"mi",foot:"ft","nautical-mile":"nm"},Kl={closeButton:!0,closeOnClick:!0,focusAfterOpen:!0,className:"",maxWidth:"240px",altitude:0},zp=["a[href]","[tabindex]:not([tabindex='-1'])","[contenteditable]:not([contenteditable='false'])","button:not([disabled])","input:not([disabled])","select:not([disabled])","textarea:not([disabled])"].join(", ");function fo(l=new s.P(0,0),t="bottom"){if(typeof l=="number"){const r=Math.round(Math.sqrt(.5*Math.pow(l,2)));switch(t){case"top":return new s.P(0,l);case"top-left":return new s.P(r,r);case"top-right":return new s.P(-r,r);case"bottom":return new s.P(0,-l);case"bottom-left":return new s.P(r,-r);case"bottom-right":return new s.P(-r,-r);case"left":return new s.P(l,0);case"right":return new s.P(-l,0)}return new s.P(0,0)}return l instanceof s.P||Array.isArray(l)?s.P.convert(l):s.P.convert(l[t]||[0,0])}return{version:ee,supported:$t.supported,setRTLTextPlugin:s.f0,getRTLTextPluginStatus:s.e$,Map:class extends Li{constructor(l){Ie.mark(ne.create);const t=l;if((l=s.h({},gh,l)).minZoom!=null&&l.maxZoom!=null&&l.minZoom>l.maxZoom)throw new Error("maxZoom must be greater than or equal to minZoom");if(l.minPitch!=null&&l.maxPitch!=null&&l.minPitch>l.maxPitch)throw new Error("maxPitch must be greater than or equal to minPitch");if(l.minPitch!=null&&l.minPitch<0)throw new Error("minPitch must be greater than or equal to 0");if(l.maxPitch!=null&&l.maxPitch>85)throw new Error("maxPitch must be less than or equal to 85");if(l.antialias&&s.eU(window)&&(l.antialias=!1,s.w("Antialiasing is disabled for this WebGL context to avoid browser bug: https://github.com/mapbox/mapbox-gl-js/issues/11609")),super(new bd(l.minZoom,l.maxZoom,l.minPitch,l.maxPitch,l.renderWorldCopies,null,null),l),this._repaint=!!l.repaint,this._interactive=l.interactive,this._minTileCacheSize=l.minTileCacheSize,this._maxTileCacheSize=l.maxTileCacheSize,this._failIfMajorPerformanceCaveat=l.failIfMajorPerformanceCaveat,this._preserveDrawingBuffer=l.preserveDrawingBuffer,this._antialias=l.antialias,this._trackResize=l.trackResize,this._bearingSnap=l.bearingSnap,this._refreshExpiredTiles=l.refreshExpiredTiles,this._fadeDuration=l.fadeDuration,this._isInitialLoad=!0,this._crossSourceCollisions=l.crossSourceCollisions,this._collectResourceTiming=l.collectResourceTiming,this._language=this._parseLanguage(l.language),this._worldview=l.worldview,this._renderTaskQueue=new Dp,this._domRenderTaskQueue=new Dp,this._controls=[],this._markers=[],this._popups=[],this._mapId=s.a$(),this._locale=s.h({},uf,l.locale),this._clickTolerance=l.clickTolerance,this._cooperativeGestures=l.cooperativeGestures,this._performanceMetricsCollection=l.performanceMetricsCollection,this._tessellationStep=l.tessellationStep,this._containerWidth=0,this._containerHeight=0,this._showParseStatus=!0,this._precompilePrograms=l.precompilePrograms,this._scaleFactorChanged=!1,this._averageElevationLastSampledAt=-1/0,this._averageElevationExaggeration=0,this._averageElevation=new bc(0),this._interactionRange=[1/0,-1/0],this._visibilityHidden=0,this._useExplicitProjection=!1,this._frameId=0,this._scaleFactor=l.scaleFactor,this._requestManager=new kn(l.transformRequest,l.accessToken,l.testMode),this._silenceAuthErrors=!!l.testMode,this._contextCreateOptions=l.contextCreateOptions?Object.assign({},l.contextCreateOptions):{},typeof l.container=="string"){const r=document.getElementById(l.container);if(!r)throw new Error(`Container '${l.container.toString()}' not found.`);this._container=r}else{if(!(l.container instanceof HTMLElement))throw new Error("Invalid type: 'container' must be a String or HTMLElement.");this._container=l.container}if(this._container.childNodes.length>0&&s.w("The map container element should be empty, otherwise the map's interactivity will be negatively impacted. If you want to display a message when WebGL is not supported, use the Mapbox GL Supported plugin instead."),l.maxBounds&&this.setMaxBounds(l.maxBounds),this._spriteFormat=l.spriteFormat,s.aV(["_onWindowOnline","_onWindowResize","_onVisibilityChange","_onMapScroll","_contextLost","_contextRestored"],this),this._setupContainer(),this._tp||(this._tp=new Cp),this._tp.registerParameter(this,["Debug"],"showOverdrawInspector"),this._tp.registerParameter(this,["Debug"],"showTileBoundaries"),this._tp.registerParameter(this,["Debug"],"showParseStatus"),this._tp.registerParameter(this,["Debug"],"repaint"),this._tp.registerParameter(this,["Debug"],"showTileAABBs"),this._tp.registerParameter(this,["Debug"],"showPadding"),this._tp.registerParameter(this,["Debug"],"showCollisionBoxes",{noSave:!0}),this._tp.registerParameter(this.transform,["Debug"],"freezeTileCoverage",{noSave:!0},(()=>{this._update()})),this._tp.registerParameter(this,["Debug","Wireframe"],"showTerrainWireframe"),this._tp.registerParameter(this,["Debug","Wireframe"],"showLayers2DWireframe"),this._tp.registerParameter(this,["Debug","Wireframe"],"showLayers3DWireframe"),this._tp.registerParameter(this,["Scaling"],"_scaleFactor",{min:.1,max:10,step:.1},(()=>{this.setScaleFactor(this._scaleFactor)})),this._setupPainter(),this.painter===void 0)throw new Error("Failed to initialize WebGL.");if(this.on("move",(()=>this._update(!1))),this.on("moveend",(()=>this._update(!1))),this.on("zoom",(()=>this._update(!0))),this._fullscreenchangeEvent="onfullscreenchange"in document?"fullscreenchange":"webkitfullscreenchange",window.addEventListener("online",this._onWindowOnline,!1),window.addEventListener("resize",this._onWindowResize,!1),window.addEventListener("orientationchange",this._onWindowResize,!1),window.addEventListener(this._fullscreenchangeEvent,this._onWindowResize,!1),window.addEventListener("visibilitychange",this._onVisibilityChange,!1),this.handlers=new io(this,l),this._localFontFamily=l.localFontFamily,this._localIdeographFontFamily=l.localIdeographFontFamily,(l.style||!l.testMode)&&this.setStyle(l.style||s.e.DEFAULT_STYLE,{config:l.config,localFontFamily:this._localFontFamily,localIdeographFontFamily:this._localIdeographFontFamily}),l.projection&&this.setProjection(l.projection),this.indoor=new wm(this),l.hash&&(this._hash=new Zd(typeof l.hash=="string"&&l.hash||void 0).addTo(this)),!this._hash||!this._hash._onHashChange()){t.center==null&&t.zoom==null||(this.transform._unmodified=!1),this.jumpTo({center:l.center,zoom:l.zoom,bearing:l.bearing,pitch:l.pitch});const r=l.bounds;r&&(this.resize(),this.fitBounds(r,s.h({},l.fitBoundsOptions,{duration:0})))}this.resize(),l.attributionControl&&this.addControl(new Sl({customAttribution:l.customAttribution})),this._logoControl=new zu,this.addControl(this._logoControl,l.logoPosition),this.on("style.load",(()=>{this.transform.unmodified&&this.jumpTo(this.style.stylesheet),this._postStyleLoadEvent()})),this.on("data",(r=>{this._update(r.dataType==="style"),this.fire(new s.A(`${r.dataType}data`,r))})),this.on("dataloading",(r=>{this.fire(new s.A(`${r.dataType}dataloading`,r))})),this._interactions=new df(this)}_getMapId(){return this._mapId}addControl(l,t){if(t===void 0&&(t=l.getDefaultPosition?l.getDefaultPosition():"top-right"),!l||!l.onAdd)return this.fire(new s.z(new Error("Invalid argument to map.addControl(). Argument must be a control with onAdd and onRemove methods.")));const r=l.onAdd(this);this._controls.push(l);const c=this._controlPositions[t];return t.indexOf("bottom")!==-1?c.insertBefore(r,c.firstChild):c.appendChild(r),this}removeControl(l){if(!l||!l.onRemove)return this.fire(new s.z(new Error("Invalid argument to map.removeControl(). Argument must be a control with onAdd and onRemove methods.")));const t=this._controls.indexOf(l);return t>-1&&this._controls.splice(t,1),l.onRemove(this),this}hasControl(l){return this._controls.indexOf(l)>-1}getContainer(){return this._container}getCanvasContainer(){return this._canvasContainer}getCanvas(){return this._canvas}resize(l){if(this._updateContainerDimensions(),this._containerWidth===this.transform.width&&this._containerHeight===this.transform.height)return this;this._resizeCanvas(this._containerWidth,this._containerHeight),this.transform.resize(this._containerWidth,this._containerHeight),this.painter.resize(Math.ceil(this._containerWidth),Math.ceil(this._containerHeight));const t=!this._moving;return t&&this.fire(new s.A("movestart",l)).fire(new s.A("move",l)),this.fire(new s.A("resize",l)),t&&this.fire(new s.A("moveend",l)),this}getBounds(){return this.transform.getBounds()}getMaxBounds(){return this.transform.getMaxBounds()||null}setMaxBounds(l){return this.transform.setMaxBounds(s.aG.convert(l)),this._update()}setMinZoom(l){if((l=l??-2)>=-2&&l<=this.transform.maxZoom)return this.transform.minZoom=l,this._update(),this.getZoom()<l?this.setZoom(l):this.fire(new s.A("zoomstart")).fire(new s.A("zoom")).fire(new s.A("zoomend")),this;throw new Error("minZoom must be between -2 and the current maxZoom, inclusive")}getMinZoom(){return this.transform.minZoom}setMaxZoom(l){if((l=l??22)>=this.transform.minZoom)return this.transform.maxZoom=l,this._update(),this.getZoom()>l?this.setZoom(l):this.fire(new s.A("zoomstart")).fire(new s.A("zoom")).fire(new s.A("zoomend")),this;throw new Error("maxZoom must be greater than the current minZoom")}getMaxZoom(){return this.transform.maxZoom}setMinPitch(l){if((l=l??0)<0)throw new Error("minPitch must be greater than or equal to 0");if(l>=0&&l<=this.transform.maxPitch)return this.transform.minPitch=l,this._update(),this.getPitch()<l?this.setPitch(l):this.fire(new s.A("pitchstart")).fire(new s.A("pitch")).fire(new s.A("pitchend")),this;throw new Error("minPitch must be between 0 and the current maxPitch, inclusive")}getMinPitch(){return this.transform.minPitch}setMaxPitch(l){if((l=l??85)>85)throw new Error("maxPitch must be less than or equal to 85");if(l>=this.transform.minPitch)return this.transform.maxPitch=l,this._update(),this.getPitch()>l?this.setPitch(l):this.fire(new s.A("pitchstart")).fire(new s.A("pitch")).fire(new s.A("pitchend")),this;throw new Error("maxPitch must be greater than or equal to minPitch")}getMaxPitch(){return this.transform.maxPitch}getScaleFactor(){return this._scaleFactor}setScaleFactor(l){return this._scaleFactor=l,this.painter.scaleFactor=l,this._tp.refreshUI(),this._scaleFactorChanged=!0,this.style._updateFilteredLayers((t=>t.type==="symbol")),this._update(!0),this}getRenderWorldCopies(){return this.transform.renderWorldCopies}setRenderWorldCopies(l){return this.transform.renderWorldCopies=l,this.transform.renderWorldCopies||this._forceMarkerAndPopupUpdate(!0),this._update()}getLanguage(){return this._language}_parseLanguage(l){return l==="auto"?navigator.language:Array.isArray(l)?l.length===0?void 0:l.map((t=>t==="auto"?navigator.language:t)):l}setLanguage(l){const t=this._parseLanguage(l);if(!this.style||t===this._language)return this;this._language=t,this.style.reloadSources();for(const r of this._controls)r._setLanguage&&r._setLanguage(this._language);return this}getWorldview(){return this._worldview}setWorldview(l){return this.style&&l!==this._worldview?(this._worldview=l,this._styleDirty=!0,this.style.reloadSources(),this):this}getProjection(){return this.transform.mercatorFromTransition?{name:"globe",center:[0,0]}:this.transform.getProjection()}_showingGlobe(){return this.transform.projection.name==="globe"}setProjection(l){return this._lazyInitEmptyStyle(),l?typeof l=="string"&&(l={name:l}):l=null,this._useExplicitProjection=!!l,this._prioritizeAndUpdateProjection(l,this.style.projection)}_updateProjectionTransition(){if(this.getProjection().name!=="globe")return;const l=this.transform,t=l.projection.name;let r;t==="globe"&&l.zoom>=s.cI?(l.setMercatorFromTransition(),r=!0):t==="mercator"&&l.zoom<s.cI&&(l.setProjection({name:"globe"}),r=!0),r&&(this.style.applyProjectionUpdate(),this.style._forceSymbolLayerUpdate(),this._update(!0))}_prioritizeAndUpdateProjection(l,t){return this._updateProjection(l||t||{name:"mercator"})}_updateProjection(l){let t;return t=l.name==="globe"&&this.transform.zoom>=s.cI?this.transform.setMercatorFromTransition():this.transform.setProjection(l),this.style.applyProjectionUpdate(),t&&(this.painter.clearBackgroundTiles(),this.style.clearSources(),this._update(!0),this._forceMarkerAndPopupUpdate(!0)),this}project(l,t){return this.transform.locationPoint3D(s.ci.convert(l),t)}unproject(l,t){return this.transform.pointLocation3D(s.P.convert(l),t)}isMoving(){return this._moving||this.handlers&&this.handlers.isMoving()||!1}isZooming(){return this._zooming||this.handlers&&this.handlers.isZooming()||!1}isRotating(){return this._rotating||this.handlers&&this.handlers.isRotating()||!1}_isDragging(){return this.handlers&&this.handlers._isDragging()||!1}_createDelegatedListener(l,t,r){const c=p=>{let _=[];if(Array.isArray(t)){const v=t.filter((b=>this.getLayer(b)));_=v.length?this.queryRenderedFeatures(p,{layers:v}):[]}else _=this.queryRenderedFeatures(p,{target:t});return _};if(l==="mouseenter"||l==="mouseover"){let p=!1;return{listener:r,targets:t,delegates:{mousemove:v=>{const b=c(v.point);b.length?p||(p=!0,r.call(this,new yr(l,this,v.originalEvent,{features:b}))):p=!1},mouseout:()=>{p=!1}}}}if(l==="mouseleave"||l==="mouseout"){let p=!1;return{listener:r,targets:t,delegates:{mousemove:b=>{c(b.point).length?p=!0:p&&(p=!1,r.call(this,new yr(l,this,b.originalEvent)))},mouseout:b=>{p&&(p=!1,r.call(this,new yr(l,this,b.originalEvent)))}}}}{const p=_=>{const v=c(_.point);v.length&&(_.features=v,r.call(this,_),delete _.features)};return{listener:r,targets:t,delegates:{[l]:p}}}}on(l,t,r){if(typeof t=="function"||r===void 0)return super.on(l,t);if(typeof t=="string"&&(t=[t]),!this._areTargetsValid(t))return this;const c=this._createDelegatedListener(l,t,r);this._delegatedListeners=this._delegatedListeners||{},this._delegatedListeners[l]=this._delegatedListeners[l]||[],this._delegatedListeners[l].push(c);for(const p in c.delegates)this.on(p,c.delegates[p]);return this}once(l,t,r){if(typeof t=="function"||r===void 0)return super.once(l,t);if(typeof t=="string"&&(t=[t]),!this._areTargetsValid(t))return this;const c=this._createDelegatedListener(l,t,r);for(const p in c.delegates)this.once(p,c.delegates[p]);return this}off(l,t,r){if(typeof t=="function"||r===void 0)return super.off(l,t);if(typeof t=="string"&&(t=[t]),!this._areTargetsValid(t))return this;const c=this._delegatedListeners?this._delegatedListeners[l]:void 0;return c&&(p=>{for(let _=0;_<p.length;_++){const v=p[_];if(v.listener===r&&ff(v.targets,t)){for(const b in v.delegates)this.off(b,v.delegates[b]);return p.splice(_,1),this}}})(c),this}queryRenderedFeatures(l,t){if(!this.style)return[];if(l===void 0||l instanceof s.P||Array.isArray(l)||t!==void 0||(t=l,l=void 0),l=l||[[0,0],[this.transform.width,this.transform.height]],!t){const _=this.style.queryRenderedFeatures(l,void 0,this.transform),v=this.style.queryRenderedFeatureset(l,void 0,this.transform);return _.concat(v)}let r=!0;if(t.target&&(r=this._isTargetValid(t.target),r&&!t.layers))return this.style.queryRenderedFeatureset(l,t,this.transform);let c=!0;if(t.layers&&Array.isArray(t.layers)){for(const _ of t.layers)if(!this._isValidId(_)){c=!1;break}if(c&&!t.target)return this.style.queryRenderedFeatures(l,t,this.transform)}let p=[];return c&&(p=p.concat(this.style.queryRenderedFeatures(l,t,this.transform))),r&&(p=p.concat(this.style.queryRenderedFeatureset(l,t,this.transform))),p}querySourceFeatures(l,t){return!l||typeof l=="string"&&!this._isValidId(l)?[]:this.style.querySourceFeatures(l,t)}isPointOnSurface(l){const{name:t}=this.transform.projection;return t!=="globe"&&t!=="mercator"&&s.w(`${t} projection does not support isPointOnSurface, this API may behave unexpectedly.`),this.transform.isPointOnSurface(s.P.convert(l))}addInteraction(l,t){return this._interactions.add(l,t),this}removeInteraction(l){return this._interactions.remove(l),this}getCooperativeGestures(){return this._cooperativeGestures}setCooperativeGestures(l){return this._cooperativeGestures=l,this}setStyle(l,t){return t=s.h({},{localIdeographFontFamily:this._localIdeographFontFamily,localFontFamily:this._localFontFamily},t),this.style&&l&&t.diff!==!1&&t.localFontFamily===this._localFontFamily&&t.localIdeographFontFamily===this._localIdeographFontFamily&&!t.config?(this.style._diffStyle(l,((r,c)=>{if(r){const p=typeof r=="string"?r:r instanceof Error?r.message:r.error;s.w(`Unable to perform style diff: ${p}. Rebuilding the style from scratch.`),this._updateStyle(l,t)}else c&&this._update(!0)}),(()=>this._postStyleLoadEvent())),this):(this._localIdeographFontFamily=t.localIdeographFontFamily,this._localFontFamily=t.localFontFamily,this._updateStyle(l,t))}_getUIString(l){const t=this._locale[l];if(t==null)throw new Error(`Missing UI string '${l}'`);return t}_updateStyle(l,t){if(this.style&&(this.style.setEventedParent(null),this.style._remove(),this.style=void 0),l){const r=s.h({},t);t&&t.config&&(r.initialConfig=t.config,delete r.config),this.style=new yo(this,r).load(l),this.style.setEventedParent(this,{style:this.style})}return this._updateTerrain(),this}_lazyInitEmptyStyle(){this.style||(this.style=new yo(this,{}),this.style.setEventedParent(this,{style:this.style}),this.style.loadEmpty())}getStyle(){if(this.style)return this.style.serialize()}isStyleLoaded(){return this.style?this.style.loaded():(s.w("There is no style added to the map."),!1)}_isValidId(l){return l==null?(this.fire(new s.z(new Error("IDs can't be empty."))),!1):!s.dk(l)||(this.fire(new s.z(new Error(`IDs can't contain special symbols: "${l}".`))),!1)}_isTargetValid(l){return"featuresetId"in l?this._isValidId("importId"in l?l.importId:l.featuresetId):"layerId"in l&&this._isValidId(l.layerId)}_areTargetsValid(l){if(Array.isArray(l)){for(const t of l)if(!this._isValidId(t))return!1;return!0}return this._isTargetValid(l)}addSource(l,t){return this._isValidId(l)?(this._lazyInitEmptyStyle(),this.style.addSource(l,t),this._update(!0)):this}isSourceLoaded(l){return!!this._isValidId(l)&&!!this.style&&this.style._isSourceCacheLoaded(l)}areTilesLoaded(){return this.style.areTilesLoaded()}addSourceType(l,t,r){this._lazyInitEmptyStyle(),this.style.addSourceType(l,t,r)}removeSource(l){return this._isValidId(l)?(this.style.removeSource(l),this._updateTerrain(),this._update(!0)):this}getSource(l){return this._isValidId(l)?this.style.getOwnSource(l):null}addImage(l,t,{pixelRatio:r=1,sdf:c=!1,stretchX:p,stretchY:_,content:v}={}){this._lazyInitEmptyStyle();const b=s.I.from(l);if(t instanceof HTMLImageElement||ImageBitmap&&t instanceof ImageBitmap){const{width:I,height:M,data:L}=s.q.getImageData(t);this.style.addImage(b,{data:new s.r({width:I,height:M},L),pixelRatio:r,stretchX:p,stretchY:_,content:v,sdf:c,version:0,usvg:!1})}else if(t.width===void 0||t.height===void 0)this.fire(new s.z(new Error("Invalid arguments to map.addImage(). The second argument must be an `HTMLImageElement`, `ImageData`, `ImageBitmap`, or object with `width`, `height`, and `data` properties with the same format as `ImageData`")));else{const{width:I,height:M}=t,L=t;this.style.addImage(b,{data:new s.r({width:I,height:M},new Uint8Array(L.data)),pixelRatio:r,stretchX:p,stretchY:_,content:v,sdf:c,usvg:!1,version:0,userImage:L}),L.onAdd&&L.onAdd(this,l)}}updateImage(l,t){this._lazyInitEmptyStyle();const r=s.I.from(l),c=this.style.getImage(r);if(!c)return void this.fire(new s.z(new Error("The map has no image with that id. If you are adding a new image use `map.addImage(...)` instead.")));const p=t instanceof HTMLImageElement||ImageBitmap&&t instanceof ImageBitmap?s.q.getImageData(t):t,{width:_,height:v,data:b}=p;if(_===void 0||v===void 0)return void this.fire(new s.z(new Error("Invalid arguments to map.updateImage(). The second argument must be an `HTMLImageElement`, `ImageData`, `ImageBitmap`, or object with `width`, `height`, and `data` properties with the same format as `ImageData`")));if(_!==(c.usvg?c.icon.usvg_tree.width:c.data.width)||v!==(c.usvg?c.icon.usvg_tree.height:c.data.height))return void this.fire(new s.z(new Error(`The width and height of the updated image (${_}, ${v})
                must be that same as the previous version of the image
                (${c.data.width}, ${c.data.height})`)));const I=!(t instanceof HTMLImageElement||ImageBitmap&&t instanceof ImageBitmap);let M=!1;c.usvg?(c.data=new s.r({width:_,height:v},new Uint8Array(b)),c.usvg=!1,c.icon=void 0,M=!0):c.data.replace(b,I),this.style.updateImage(r,c,M)}hasImage(l){return l?!!this.style&&!!this.style.getImage(s.I.from(l)):(this.fire(new s.z(new Error("Missing required image id"))),!1)}removeImage(l){this.style.removeImage(s.I.from(l))}loadImage(l,t){s.o(this._requestManager.transformRequest(l,s.R.Image),((r,c)=>{t(r,c instanceof HTMLImageElement?s.q.getImageData(c):c)}))}listImages(){return this.style.listImages().map((l=>l.name))}addModel(l,t){this._lazyInitEmptyStyle(),this.style.addModel(l,t)}hasModel(l){return l?this.style.hasModel(l):(this.fire(new s.z(new Error("Missing required model id"))),!1)}removeModel(l){this.style.removeModel(l)}listModels(){return this.style.listModels()}addLayer(l,t){return this._isValidId(l.id)?(this._lazyInitEmptyStyle(),this.style.addLayer(l,t),this._update(!0)):this}getSlot(l){const t=this.getLayer(l);return t&&t.slot||null}setSlot(l,t){return this.style.setSlot(l,t),this.style.mergeLayers(),this._update(!0)}addImport(l,t){return this.style.addImport(l,t).catch((r=>this.fire(new s.z(new Error("Failed to add import",r))))),this}updateImport(l,t){return typeof t!="string"&&t.id!==l?(this.removeImport(l),this.addImport(t)):(this.style.updateImport(l,t),this._update(!0))}removeImport(l){return this.style.removeImport(l),this}moveImport(l,t){return this.style.moveImport(l,t),this._update(!0)}moveLayer(l,t){return this._isValidId(l)?(this.style.moveLayer(l,t),this._update(!0)):this}removeLayer(l){return this._isValidId(l)?(this.style.removeLayer(l),this._update(!0)):this}getLayer(l){if(!this._isValidId(l))return null;const t=this.style.getOwnLayer(l);return t?t.type==="custom"?t.implementation:t.serialize():void 0}getSlots(){return this.style.getSlots()}setLayerZoomRange(l,t,r){return this._isValidId(l)?(this.style.setLayerZoomRange(l,t,r),this._update(!0)):this}setFilter(l,t,r={}){return this._isValidId(l)?(this.style.setFilter(l,t,r),this._update(!0)):this}getFilter(l){return this._isValidId(l)?this.style.getFilter(l):null}setPaintProperty(l,t,r,c={}){return this._isValidId(l)?(this.style.setPaintProperty(l,t,r,c),this._update(!0)):this}getPaintProperty(l,t){return this._isValidId(l)?this.style.getPaintProperty(l,t):null}setLayoutProperty(l,t,r,c={}){return this._isValidId(l)?(this.style.setLayoutProperty(l,t,r,c),this._update(!0)):this}getLayoutProperty(l,t){return this._isValidId(l)?this.style.getLayoutProperty(l,t):null}getGlyphsUrl(){return this.style.getGlyphsUrl()}setGlyphsUrl(l){return this.style.setGlyphsUrl(l),this._update(!0)}getSchema(l){return this.style.getSchema(l)}setSchema(l,t){return this.style.setSchema(l,t),this._update(!0)}getConfig(l){return this.style.getConfig(l)}setConfig(l,t){return this.style.setConfig(l,t),this._update(!0)}getConfigProperty(l,t){return this.style.getConfigProperty(l,t)}setConfigProperty(l,t,r){return this.style.setConfigProperty(l,t,r),this._update(!0)}getFeaturesetDescriptors(l){return this.style.getFeaturesetDescriptors(l)}setLights(l){if(this._lazyInitEmptyStyle(),l&&l.length===1&&l[0].type==="flat"){const t=l[0];t.properties?this.style.setFlatLight(t.properties,t.id,{}):this.style.setFlatLight({},"flat")}else this.style.setLights(l),this.painter.terrain&&(this.painter.terrain.invalidateRenderCache=!0);return this._update(!0)}getLights(){const l=this.style.getLights()||[];return l.length===0&&l.push({id:this.style.light.id,type:"flat",properties:this.style.getFlatLight()}),l}setLight(l,t={}){return console.log("The `map.setLight` function is deprecated, prefer using `map.setLights` with `flat` light type instead."),this.setLights([{id:"flat",type:"flat",properties:l}])}getLight(){return console.log("The `map.getLight` function is deprecated, prefer using `map.getLights` instead."),this.style.getFlatLight()}setTerrain(l){return this._lazyInitEmptyStyle(),!l&&this.transform.projection.requiresDraping?this.style.setTerrainForDraping():this.style.setTerrain(l),this._averageElevationLastSampledAt=-1/0,this._update(!0)}getTerrain(){return this.style?this.style.getTerrain():null}setFog(l){return this._lazyInitEmptyStyle(),this.style.setFog(l),this._update(!0)}getFog(){return this.style?this.style.getFog():null}setSnow(l){return this._lazyInitEmptyStyle(),this.style.setSnow(l),this._update(!0)}getSnow(){return this.style?this.style.getSnow():null}setRain(l){return this._lazyInitEmptyStyle(),this.style.setRain(l),this._update(!0)}getRain(){return this.style?this.style.getRain():null}setColorTheme(l){return this._lazyInitEmptyStyle(),this.style.setColorTheme(l),this._update(!0)}setImportColorTheme(l,t){return this._lazyInitEmptyStyle(),this.style.setImportColorTheme(l,t),this._update(!0)}setCamera(l){return this.style.setCamera(l),this._triggerCameraUpdate(l)}_triggerCameraUpdate(l){return this._update(this.transform.setOrthographicProjectionAtLowPitch(l["camera-projection"]==="orthographic"))}getCamera(){return this.style.camera}_queryFogOpacity(l){return this.style&&this.style.fog?this.style.fog.getOpacityAtLatLng(s.ci.convert(l),this.transform):0}setFeatureState(l,t){return l.source&&!this._isValidId(l.source)?this:(this.style.setFeatureState(l,t),this._update())}removeFeatureState(l,t){return l.source&&!this._isValidId(l.source)?this:(this.style.removeFeatureState(l,t),this._update())}getFeatureState(l){return l.source&&!this._isValidId(l.source)?null:this.style.getFeatureState(l)}_selectIndoorFloor(l){this.indoor.selectFloor(l)}_addIndoorControl(){this._indoorControl||(this._indoorControl=new cf),this.addControl(this._indoorControl,"right")}_removeIndoorControl(){this._indoorControl&&this.removeControl(this._indoorControl)}_updateContainerDimensions(){if(!this._container)return;const l=this._container.getBoundingClientRect().width||400,t=this._container.getBoundingClientRect().height||300;let r,c,p,_=this._container;for(;_&&(!c||!p);){const v=window.getComputedStyle(_).transform;v&&v!=="none"&&(r=v.match(/matrix.*\((.+)\)/)[1].split(", "),r[0]&&r[0]!=="0"&&r[0]!=="1"&&(c=r[0]),r[3]&&r[3]!=="0"&&r[3]!=="1"&&(p=r[3])),_=_.parentElement}this._containerWidth=c?Math.abs(l/c):l,this._containerHeight=p?Math.abs(t/p):t}_detectMissingCSS(){window.getComputedStyle(this._missingCSSCanary).getPropertyValue("background-color")!=="rgb(250, 128, 114)"&&s.w("This page appears to be missing CSS declarations for Mapbox GL JS, which may cause the map to display incorrectly. Please ensure your page includes mapbox-gl.css, as described in https://www.mapbox.com/mapbox-gl-js/api/.")}_setupContainer(){const l=this._container;l.classList.add("mapboxgl-map"),(this._missingCSSCanary=ct("div","mapboxgl-canary",l)).style.visibility="hidden",this._detectMissingCSS();const t=this._canvasContainer=ct("div","mapboxgl-canvas-container",l);this._canvas=ct("canvas","mapboxgl-canvas",t),this._interactive&&(t.classList.add("mapboxgl-interactive"),this._canvas.setAttribute("tabindex","0")),this._canvas.addEventListener("webglcontextlost",this._contextLost,!1),this._canvas.addEventListener("webglcontextrestored",this._contextRestored,!1),this._canvas.setAttribute("aria-label",this._getUIString("Map.Title")),this._canvas.setAttribute("role","region"),this._updateContainerDimensions(),this._resizeCanvas(this._containerWidth,this._containerHeight);const r=this._controlContainer=ct("div","mapboxgl-control-container",l),c=this._controlPositions={};["top-left","top","top-right","right","bottom-right","bottom","bottom-left","left"].forEach((p=>{c[p]=ct("div",`mapboxgl-ctrl-${p}`,r)})),this._container.addEventListener("scroll",this._onMapScroll,!1)}_resizeCanvas(l,t){const r=s.q.devicePixelRatio||1;this._canvas.width=r*Math.ceil(l),this._canvas.height=r*Math.ceil(t),this._canvas.style.width=`${l}px`,this._canvas.style.height=`${t}px`}_addMarker(l){this._markers.push(l)}_removeMarker(l){const t=this._markers.indexOf(l);t!==-1&&this._markers.splice(t,1)}_addPopup(l){this._popups.push(l)}_removePopup(l){const t=this._popups.indexOf(l);t!==-1&&this._popups.splice(t,1)}_setupPainter(){const l=s.h({},$t.supported.webGLContextAttributes,{failIfMajorPerformanceCaveat:this._failIfMajorPerformanceCaveat,preserveDrawingBuffer:this._preserveDrawingBuffer,antialias:this._antialias||!1}),t=this._canvas.getContext("webgl2",l);t?(Bo(t,!0),this.painter=new qc(t,this._contextCreateOptions,this.transform,this._scaleFactor,this._tp,this._worldview),this.on("data",(r=>{r.dataType==="source"&&this.painter.setTileLoadedFlag(!0)})),s.l.testSupport(t)):this.fire(new s.z(new Error("Failed to initialize WebGL")))}_contextLost(l){l.preventDefault(),this._frame&&(this._frame.cancel(),this._frame=null),this.fire(new s.A("webglcontextlost",{originalEvent:l}))}_contextRestored(l){this._setupPainter(),this.painter.resize(Math.ceil(this._containerWidth),Math.ceil(this._containerHeight)),this._updateTerrain(),this.style&&(this.style.clearLayers(),this.style.imageManager.destroyAtlasTextures(),this.style.reloadModels(),this.style.clearSources()),this._update(),this.fire(new s.A("webglcontextrestored",{originalEvent:l}))}_onMapScroll(l){if(l.target===this._container)return this._container.scrollTop=0,this._container.scrollLeft=0,!1}idle(){return!this.isMoving()&&this.loaded()}loaded(){return!this._styleDirty&&!this._sourcesDirty&&!!this.style&&this.style.loaded()}frameReady(){return this.loaded()&&!this._placementDirty}_update(l){return this.style?(this._styleDirty=this._styleDirty||l,this._sourcesDirty=!0,this.triggerRepaint(),this):this}_requestRenderFrame(l){return this._update(),this._renderTaskQueue.add(l)}_cancelRenderFrame(l){this._renderTaskQueue.remove(l)}_requestDomTask(l){!this.loaded()||this.loaded()&&!this.isMoving()?l():this._domRenderTaskQueue.add(l)}_render(l){let t;this.fire(new s.A("renderstart")),++this._frameId;const r=this.painter.context.extTimerQuery,c=s.q.now(),p=this.painter.context.gl;if(this.listens("gpu-timing-frame")&&(t=p.createQuery(),p.beginQuery(r.TIME_ELAPSED_EXT,t)),this.painter.context.setDirty(),this.painter.setBaseState(),(this.isMoving()||this.isRotating()||this.isZooming())&&(this._interactionRange[0]=Math.min(this._interactionRange[0],performance.now()),this._interactionRange[1]=Math.max(this._interactionRange[1],performance.now())),this._renderTaskQueue.run(l),this._domRenderTaskQueue.run(l),this._removed)return;this._updateProjectionTransition();const _=this._isInitialLoad?0:this._fadeDuration;if(this.style&&this._styleDirty){this._styleDirty=!1;const M=this.transform.zoom,L=this.transform.pitch,B=s.q.now(),F=new s.aa(M,{now:B,fadeDuration:_,pitch:L,transition:this.style.transition,worldview:this._worldview});this.style.update(F)}this.style&&this.style.hasFogTransition()&&(this.style._markersNeedUpdate=!0,this._sourcesDirty=!0);let v=!1;this.style&&this._sourcesDirty?(this._sourcesDirty=!1,this.painter._updateFog(this.style),this._updateTerrain(),v=this._updateAverageElevation(c),this.style.updateSources(this.transform),this.style.updateImageProviders(),this.isMoving()||this._forceMarkerAndPopupUpdate()):v=this._updateAverageElevation(c);const b=this.style&&this.style._updatePlacement(this.painter,this.painter.transform,this.showCollisionBoxes,_,this._crossSourceCollisions,this.painter.replacementSource,this._scaleFactorChanged);if(this._scaleFactorChanged&&(this._scaleFactorChanged=!1),b&&(this._placementDirty=b.needsRerender),this.style&&this.painter.render(this.style,{showTileBoundaries:this.showTileBoundaries,showParseStatus:this.showParseStatus,wireframe:{terrain:this.showTerrainWireframe,layers2D:this.showLayers2DWireframe,layers3D:this.showLayers3DWireframe},showOverdrawInspector:this._showOverdrawInspector,showQueryGeometry:!!this._showQueryGeometry,showTileAABBs:this.showTileAABBs,rotating:this.isRotating(),zooming:this.isZooming(),moving:this.isMoving(),fadeDuration:_,isInitialLoad:this._isInitialLoad,showPadding:this.showPadding,gpuTiming:!!this.listens("gpu-timing-layer"),gpuTimingDeferredRender:!!this.listens("gpu-timing-deferred-render"),speedIndexTiming:this.speedIndexTiming}),this.fire(new s.A("render")),this.loaded()&&!this._loaded&&(this._loaded=!0,Ie.mark(ne.load),this.fire(new s.A("load"))),this.style&&this.style.hasTransitions()&&(this._styleDirty=!0),this.style&&(this.style.snow||this.style.rain)&&(this._styleDirty=!0),this.style&&this.style.imageManager.hasPatternsInFlight()&&(this._styleDirty=!0),this.style&&!this.style.modelManager.isLoaded()&&(this._styleDirty=!0),this.style&&!this._placementDirty&&this.style._releaseSymbolFadeTiles(),t){const M=s.q.now()-c;p.endQuery(r.TIME_ELAPSED_EXT),setTimeout((()=>{const L=p.getQueryParameter(t,p.QUERY_RESULT)/1e6;p.deleteQuery(t),this.fire(new s.A("gpu-timing-frame",{cpuTime:M,gpuTime:L}))}),50)}if(this.listens("gpu-timing-layer")){const M=this.painter.collectGpuTimers();setTimeout((()=>{const L=this.painter.queryGpuTimers(M);this.fire(new s.A("gpu-timing-layer",{layerTimes:L}))}),50)}if(this.listens("gpu-timing-deferred-render")){const M=this.painter.collectDeferredRenderGpuQueries();setTimeout((()=>{const L=this.painter.queryGpuTimeDeferredRender(M);this.fire(new s.A("gpu-timing-deferred-render",{gpuTime:L}))}),50)}const I=this._sourcesDirty||this._styleDirty||this._placementDirty||v;if(I||this._repaint)this.triggerRepaint();else{const M=this.idle();if(M&&(v=this._updateAverageElevation(c,!0)),v)this.triggerRepaint();else if(this._triggerFrame(!1),M&&(this.fire(new s.A("idle")),this._isInitialLoad=!1,this.speedIndexTiming)){const L=this._calculateSpeedIndex();this.fire(new s.A("speedindexcompleted",{speedIndex:L})),this.speedIndexTiming=!1}}!this._loaded||this._fullyLoaded||I||(this._fullyLoaded=!0,Ie.mark(ne.fullLoad),this._performanceMetricsCollection&&on(this._requestManager._customAccessToken,{width:this.painter.width,height:this.painter.height,interactionRange:this._interactionRange,visibilityHidden:this._visibilityHidden,terrainEnabled:!!this.painter.style.getTerrain(),fogEnabled:!!this.painter.style.getFog(),projection:this.getProjection().name,zoom:this.transform.zoom,renderer:this.painter.context.renderer,vendor:this.painter.context.vendor}),this._authenticate())}_forceMarkerAndPopupUpdate(l){for(const t of this._markers)l&&!this.getRenderWorldCopies()&&(t._lngLat=t._lngLat.wrap()),t._update();for(const t of this._popups)!l||this.getRenderWorldCopies()||t._trackPointer||(t._lngLat=t._lngLat.wrap()),t._update()}_updateAverageElevation(l,t=!1){const r=p=>(this.transform.averageElevation=p,this._update(!1),!0);if(!this.painter.averageElevationNeedsEasing())return this.transform.averageElevation!==0&&r(0);const c=this.transform.elevation&&this.transform.elevation.exaggeration()!==this._averageElevationExaggeration;if(c||(t||l-this._averageElevationLastSampledAt>500)&&!this._averageElevation.isEasing(l)){const p=this.transform.averageElevation;let _=this.transform.sampleAverageElevation();this.transform.elevation!=null&&(this._averageElevationExaggeration=this.transform.elevation.exaggeration()),isNaN(_)?_=0:this._averageElevationLastSampledAt=l;const v=Math.abs(p-_);if(v>1){if(this._isInitialLoad||c)return this._averageElevation.jumpTo(_),r(_);this._averageElevation.easeTo(_,l,300)}else if(v>1e-4)return this._averageElevation.jumpTo(_),r(_)}return!!this._averageElevation.isEasing(l)&&r(this._averageElevation.getValue(l))}_authenticate(){Pn(this._getMapId(),this._requestManager._skuToken,this._requestManager._customAccessToken,(l=>{if(l&&(l.message===Oe||l.status===401)){const t=this.painter.context.gl;Bo(t,!1),this._logoControl instanceof zu&&this._logoControl._updateLogo(),t&&t.clear(t.DEPTH_BUFFER_BIT|t.COLOR_BUFFER_BIT|t.STENCIL_BUFFER_BIT),this._silenceAuthErrors||this.fire(new s.z(new Error("A valid Mapbox access token is required to use Mapbox GL JS. To create an account or a new access token, visit https://account.mapbox.com/")))}})),Un(this._getMapId(),this._requestManager._skuToken,this._requestManager._customAccessToken,(()=>{}))}_postStyleLoadEvent(){this.style.globalId&&zi(this._requestManager._customAccessToken,{map:this,style:this.style.globalId,importedStyles:this.style.getImportGlobalIds()})}_updateTerrain(){const l=this._isDragging();this.painter.updateTerrain(this.style,l)}_calculateSpeedIndex(){const l=this.painter.canvasCopy(),t=this.painter.getCanvasCopiesAndTimestamps();t.timeStamps.push(performance.now());const r=this.painter.context.gl,c=r.createFramebuffer();function p(_){r.framebufferTexture2D(r.FRAMEBUFFER,r.COLOR_ATTACHMENT0,r.TEXTURE_2D,_,0);const v=new Uint8Array(r.drawingBufferWidth*r.drawingBufferHeight*4);return r.readPixels(0,0,r.drawingBufferWidth,r.drawingBufferHeight,r.RGBA,r.UNSIGNED_BYTE,v),v}return r.bindFramebuffer(r.FRAMEBUFFER,c),this._canvasPixelComparison(p(l),t.canvasCopies.map(p),t.timeStamps)}_canvasPixelComparison(l,t,r){let c=r[1]-r[0];const p=l.length/4;for(let _=0;_<t.length;_++){const v=t[_];let b=0;for(let I=0;I<v.length;I+=4)v[I]===l[I]&&v[I+1]===l[I+1]&&v[I+2]===l[I+2]&&v[I+3]===l[I+3]&&(b+=1);c+=(r[_+2]-r[_+1])*(1-b/p)}return c}remove(){this._hash&&this._hash.remove();for(const t of this._controls)t.onRemove(this);this._controls=[],this._frame&&(this._frame.cancel(),this._frame=null),this._renderTaskQueue.clear(),this._domRenderTaskQueue.clear(),this.style&&this.style.destroy(),this.indoor.destroy(),this.painter.destroy(),this.handlers&&this.handlers.destroy(),this.handlers=void 0,this.setStyle(null),window.removeEventListener("resize",this._onWindowResize,!1),window.removeEventListener("orientationchange",this._onWindowResize,!1),window.removeEventListener(this._fullscreenchangeEvent,this._onWindowResize,!1),window.removeEventListener("online",this._onWindowOnline,!1),window.removeEventListener("visibilitychange",this._onVisibilityChange,!1);const l=this.painter.context.gl.getExtension("WEBGL_lose_context");l&&l.loseContext(),this._canvas.removeEventListener("webglcontextlost",this._contextLost,!1),this._canvas.removeEventListener("webglcontextrestored",this._contextRestored,!1),this._canvasContainer.remove(),this._controlContainer.remove(),this._missingCSSCanary.remove(),this._canvas=void 0,this._canvasContainer=void 0,this._controlContainer=void 0,this._missingCSSCanary=void 0,this._container.classList.remove("mapboxgl-map"),this._container.removeEventListener("scroll",this._onMapScroll,!1),ao.delete(this.painter.context.gl),er.remove(),ji.remove(),this._removed=!0,this.fire(new s.A("remove"))}triggerRepaint(){this._triggerFrame(!0)}_triggerFrame(l){this._renderNextFrame=this._renderNextFrame||l,this.style&&!this._frame&&(this._frame=s.q.frame((t=>{const r=!!this._renderNextFrame;this._frame=null,this._renderNextFrame=null,r&&this._render(t)})))}_preloadTiles(l){const t=this.style?this.style.getSourceCaches():[];return s.bt(t,((r,c)=>r._preloadTiles(l,c)),(()=>{this.triggerRepaint()})),this}_onWindowOnline(){this._update()}_onWindowResize(l){this._trackResize&&this.resize({originalEvent:l})._update()}_onVisibilityChange(){document.visibilityState==="hidden"&&this._visibilityHidden++}get showTileBoundaries(){return!!this._showTileBoundaries}set showTileBoundaries(l){this._showTileBoundaries!==l&&(this._showTileBoundaries=l,this._tp.refreshUI(),this._update())}get showParseStatus(){return!!this._showParseStatus}set showParseStatus(l){this._showParseStatus!==l&&(this._showParseStatus=l,this._tp.refreshUI(),this._update())}get showTerrainWireframe(){return!!this._showTerrainWireframe}set showTerrainWireframe(l){this._showTerrainWireframe!==l&&(this._showTerrainWireframe=l,this._tp.refreshUI(),this._update())}get showLayers2DWireframe(){return!!this._showLayers2DWireframe}set showLayers2DWireframe(l){this._showLayers2DWireframe!==l&&(this._showLayers2DWireframe=l,this._tp.refreshUI(),this._update())}get showLayers3DWireframe(){return!!this._showLayers3DWireframe}set showLayers3DWireframe(l){this._showLayers3DWireframe!==l&&(this._showLayers3DWireframe=l,this._tp.refreshUI(),this._update())}get speedIndexTiming(){return!!this._speedIndexTiming}set speedIndexTiming(l){this._speedIndexTiming!==l&&(this._speedIndexTiming=l,this._update())}get showPadding(){return!!this._showPadding}set showPadding(l){this._showPadding!==l&&(this._showPadding=l,this._tp.refreshUI(),this._update())}get showCollisionBoxes(){return!!this._showCollisionBoxes}set showCollisionBoxes(l){this._showCollisionBoxes!==l&&(this._showCollisionBoxes=l,this._tp.refreshUI(),l?this.style._generateCollisionBoxes():this._update())}get showOverdrawInspector(){return!!this._showOverdrawInspector}set showOverdrawInspector(l){this._showOverdrawInspector!==l&&(this._showOverdrawInspector=l,this._tp.refreshUI(),this._update())}get repaint(){return!!this._repaint}set repaint(l){this._repaint!==l&&(this._repaint=l,this._tp.refreshUI(),this.triggerRepaint())}get vertices(){return!!this._vertices}set vertices(l){this._vertices=l,this._update()}get showTileAABBs(){return!!this._showTileAABBs}set showTileAABBs(l){this._showTileAABBs!==l&&(this._showTileAABBs=l,this._tp.refreshUI(),l&&this._update())}_setCacheLimits(l,t){s.eV(l,t)}get version(){return ee}},NavigationControl:class{constructor(l={}){this.options=s.h({},Xc,l),this._container=ct("div","mapboxgl-ctrl mapboxgl-ctrl-group"),this._container.addEventListener("contextmenu",(t=>t.preventDefault())),this.options.showZoom&&(s.aV(["_setButtonTitle","_updateZoomButtons"],this),this._zoomInButton=this._createButton("mapboxgl-ctrl-zoom-in",(t=>{this._map&&this._map.zoomIn({},{originalEvent:t})})),ct("span","mapboxgl-ctrl-icon",this._zoomInButton).setAttribute("aria-hidden","true"),this._zoomOutButton=this._createButton("mapboxgl-ctrl-zoom-out",(t=>{this._map&&this._map.zoomOut({},{originalEvent:t})})),ct("span","mapboxgl-ctrl-icon",this._zoomOutButton).setAttribute("aria-hidden","true")),this.options.showCompass&&(s.aV(["_rotateCompassArrow"],this),this._compass=this._createButton("mapboxgl-ctrl-compass",(t=>{const r=this._map;r&&(this.options.visualizePitch?r.resetNorthPitch({},{originalEvent:t}):r.resetNorth({},{originalEvent:t}))})),this._compassIcon=ct("span","mapboxgl-ctrl-icon",this._compass),this._compassIcon.setAttribute("aria-hidden","true"))}_updateZoomButtons(){const l=this._map;if(!l)return;const t=l.getZoom(),r=t===l.getMaxZoom(),c=t===l.getMinZoom();this._zoomInButton.disabled=r,this._zoomOutButton.disabled=c,this._zoomInButton.setAttribute("aria-disabled",r.toString()),this._zoomOutButton.setAttribute("aria-disabled",c.toString())}_rotateCompassArrow(){const l=this._map;if(!l)return;const t=this.options.visualizePitch?`scale(${1/Math.pow(Math.cos(l.transform.pitch*(Math.PI/180)),.5)}) rotateX(${l.transform.pitch}deg) rotateZ(${l.transform.angle*(180/Math.PI)}deg)`:`rotate(${l.transform.angle*(180/Math.PI)}deg)`;l._requestDomTask((()=>{this._compassIcon&&(this._compassIcon.style.transform=t)}))}onAdd(l){return this._map=l,this.options.showZoom&&(this._setButtonTitle(this._zoomInButton,"ZoomIn"),this._setButtonTitle(this._zoomOutButton,"ZoomOut"),l.on("zoom",this._updateZoomButtons),this._updateZoomButtons()),this.options.showCompass&&(this._setButtonTitle(this._compass,"ResetBearing"),this.options.visualizePitch&&l.on("pitch",this._rotateCompassArrow),l.on("rotate",this._rotateCompassArrow),this._rotateCompassArrow(),this._handler=new Il(l,this._compass,this.options.visualizePitch)),this._container}onRemove(){const l=this._map;l&&(this._container.remove(),this.options.showZoom&&l.off("zoom",this._updateZoomButtons),this.options.showCompass&&(this.options.visualizePitch&&l.off("pitch",this._rotateCompassArrow),l.off("rotate",this._rotateCompassArrow),this._handler&&this._handler.off(),this._handler=void 0),this._map=void 0)}_createButton(l,t){const r=ct("button",l,this._container);return r.type="button",r.addEventListener("click",t),r}_setButtonTitle(l,t){if(!this._map)return;const r=this._map._getUIString(`NavigationControl.${t}`);l.setAttribute("aria-label",r),l.firstElementChild&&l.firstElementChild.setAttribute("title",r)}},GeolocateControl:class extends s.E{constructor(l={}){super();const t=navigator.geolocation;this.options=s.h({geolocation:t},Lp,l),s.aV(["_onSuccess","_onError","_onZoom","_finish","_setupUI","_updateCamera","_updateMarker","_updateMarkerRotation","_onDeviceOrientation"],this),this._updateMarkerRotationThrottled=uh(this._updateMarkerRotation,20),this._numberOfWatches=0}onAdd(l){return this._map=l,this._container=ct("div","mapboxgl-ctrl mapboxgl-ctrl-group"),this._checkGeolocationSupport(this._setupUI),this._container}onRemove(){this._geolocationWatchID!==void 0&&(this.options.geolocation.clearWatch(this._geolocationWatchID),this._geolocationWatchID=void 0),this.options.showUserLocation&&this._userLocationDotMarker&&this._userLocationDotMarker.remove(),this.options.showAccuracyCircle&&this._accuracyCircleMarker&&this._accuracyCircleMarker.remove(),this._container.remove(),this._map.off("zoom",this._onZoom),this._map=void 0,this._numberOfWatches=0,this._noTimeout=!1}_checkGeolocationSupport(l){const t=(r=!!this.options.geolocation)=>{this._supportsGeolocation=r,l(r)};this._supportsGeolocation!==void 0?l(this._supportsGeolocation):navigator.permissions!==void 0?navigator.permissions.query({name:"geolocation"}).then((r=>t(r.state!=="denied"))).catch((()=>t())):t()}_isOutOfMapMaxBounds(l){const t=this._map.getMaxBounds(),r=l.coords;return!!t&&(r.longitude<t.getWest()||r.longitude>t.getEast()||r.latitude<t.getSouth()||r.latitude>t.getNorth())}_setErrorState(){switch(this._watchState){case"WAITING_ACTIVE":this._watchState="ACTIVE_ERROR",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active-error");break;case"ACTIVE_LOCK":this._watchState="ACTIVE_ERROR",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active-error"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting");break;case"BACKGROUND":this._watchState="BACKGROUND_ERROR",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background-error"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting")}}_onSuccess(l){if(this._map){if(this._isOutOfMapMaxBounds(l))return this._setErrorState(),this.fire(new s.A("outofmaxbounds",l)),this._updateMarker(),void this._finish();if(this.options.trackUserLocation)switch(this._lastKnownPosition=l,this._watchState){case"WAITING_ACTIVE":case"ACTIVE_LOCK":case"ACTIVE_ERROR":this._watchState="ACTIVE_LOCK",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active-error"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active");break;case"BACKGROUND":case"BACKGROUND_ERROR":this._watchState="BACKGROUND",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background-error"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background")}this.options.showUserLocation&&this._watchState!=="OFF"&&this._updateMarker(l),this.options.trackUserLocation&&this._watchState!=="ACTIVE_LOCK"||this._updateCamera(l),this.options.showUserLocation&&this._userLocationDotMarker.removeClassName("mapboxgl-user-location-dot-stale"),this.fire(new s.A("geolocate",l)),this._finish()}}_updateCamera(l){const t=new s.ci(l.coords.longitude,l.coords.latitude),r=l.coords.accuracy,c=this._map.getBearing(),p=s.h({bearing:c},this.options.fitBoundsOptions);this._map.fitBounds(t.toBounds(r),p,{geolocateSource:!0})}_updateMarker(l){if(l){const t=new s.ci(l.coords.longitude,l.coords.latitude);this._accuracyCircleMarker.setLngLat(t).addTo(this._map),this._userLocationDotMarker.setLngLat(t).addTo(this._map),this._accuracy=l.coords.accuracy,this.options.showUserLocation&&this.options.showAccuracyCircle&&this._updateCircleRadius()}else this._userLocationDotMarker.remove(),this._accuracyCircleMarker.remove()}_updateCircleRadius(){const l=this._map.transform,t=s.cb(1,l._center.lat)*l.worldSize,r=Math.ceil(2*this._accuracy*t);this._circleElement.style.width=`${r}px`,this._circleElement.style.height=`${r}px`}_onZoom(){this.options.showUserLocation&&this.options.showAccuracyCircle&&this._updateCircleRadius()}_updateMarkerRotation(){this._userLocationDotMarker&&typeof this._heading=="number"?(this._userLocationDotMarker.setRotation(this._heading),this._userLocationDotMarker.addClassName("mapboxgl-user-location-show-heading")):(this._userLocationDotMarker.removeClassName("mapboxgl-user-location-show-heading"),this._userLocationDotMarker.setRotation(0))}_onError(l){if(this._map){if(this.options.trackUserLocation)if(l.code===1){this._watchState="OFF",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active-error"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background-error"),this._geolocateButton.disabled=!0;const t=this._map._getUIString("GeolocateControl.LocationNotAvailable");this._geolocateButton.setAttribute("aria-label",t),this._geolocateButton.firstElementChild&&this._geolocateButton.firstElementChild.setAttribute("title",t),this._geolocationWatchID!==void 0&&this._clearWatch()}else{if(l.code===3&&this._noTimeout)return;this._setErrorState()}this._watchState!=="OFF"&&this.options.showUserLocation&&this._userLocationDotMarker.addClassName("mapboxgl-user-location-dot-stale"),this.fire(new s.A("error",l)),this._finish()}}_finish(){this._timeoutId&&clearTimeout(this._timeoutId),this._timeoutId=void 0}_setupUI(l){if(this._map!==void 0){if(this._container.addEventListener("contextmenu",(t=>t.preventDefault())),this._geolocateButton=ct("button","mapboxgl-ctrl-geolocate",this._container),ct("span","mapboxgl-ctrl-icon",this._geolocateButton).setAttribute("aria-hidden","true"),this._geolocateButton.type="button",l===!1){s.w("Geolocation support is not available so the GeolocateControl will be disabled.");const t=this._map._getUIString("GeolocateControl.LocationNotAvailable");this._geolocateButton.disabled=!0,this._geolocateButton.setAttribute("aria-label",t),this._geolocateButton.firstElementChild&&this._geolocateButton.firstElementChild.setAttribute("title",t)}else{const t=this._map._getUIString("GeolocateControl.FindMyLocation");this._geolocateButton.setAttribute("aria-label",t),this._geolocateButton.firstElementChild&&this._geolocateButton.firstElementChild.setAttribute("title",t)}this.options.trackUserLocation&&(this._geolocateButton.setAttribute("aria-pressed","false"),this._watchState="OFF"),this.options.showUserLocation&&(this._dotElement=ct("div","mapboxgl-user-location"),this._dotElement.appendChild(ct("div","mapboxgl-user-location-dot")),this._dotElement.appendChild(ct("div","mapboxgl-user-location-heading")),this._userLocationDotMarker=new oa({element:this._dotElement,rotationAlignment:"map",pitchAlignment:"map"}),this._circleElement=ct("div","mapboxgl-user-location-accuracy-circle"),this._accuracyCircleMarker=new oa({element:this._circleElement,pitchAlignment:"map"}),this.options.trackUserLocation&&(this._watchState="OFF"),this._map.on("zoom",this._onZoom)),this._geolocateButton.addEventListener("click",this.trigger.bind(this)),this._setup=!0,this.options.trackUserLocation&&this._map.on("movestart",(t=>{t.geolocateSource||this._watchState!=="ACTIVE_LOCK"||t.originalEvent&&t.originalEvent.type==="resize"||(this._watchState="BACKGROUND",this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this.fire(new s.A("trackuserlocationend")))}))}}_onDeviceOrientation(l){this._userLocationDotMarker&&(l.webkitCompassHeading?this._heading=l.webkitCompassHeading:l.absolute===!0&&(this._heading=-1*l.alpha),this._updateMarkerRotationThrottled())}trigger(){if(!this._setup)return s.w("Geolocate control triggered before added to a map"),!1;if(this.options.trackUserLocation){switch(this._watchState){case"OFF":this._watchState="WAITING_ACTIVE",this.fire(new s.A("trackuserlocationstart"));break;case"WAITING_ACTIVE":case"ACTIVE_LOCK":case"ACTIVE_ERROR":case"BACKGROUND_ERROR":this._numberOfWatches--,this._noTimeout=!1,this._watchState="OFF",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-active-error"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background"),this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background-error"),this.fire(new s.A("trackuserlocationend"));break;case"BACKGROUND":this._watchState="ACTIVE_LOCK",this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-background"),this._lastKnownPosition&&this._updateCamera(this._lastKnownPosition),this.fire(new s.A("trackuserlocationstart"))}switch(this._watchState){case"WAITING_ACTIVE":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active");break;case"ACTIVE_LOCK":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active");break;case"ACTIVE_ERROR":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-active-error");break;case"BACKGROUND":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background");break;case"BACKGROUND_ERROR":this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-background-error")}if(this._watchState==="OFF"&&this._geolocationWatchID!==void 0)this._clearWatch();else if(this._geolocationWatchID===void 0){let l;this._geolocateButton.classList.add("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.setAttribute("aria-pressed","true"),this._numberOfWatches++,this._numberOfWatches>1?(l={maximumAge:6e5,timeout:0},this._noTimeout=!0):(l=this.options.positionOptions,this._noTimeout=!1),this._geolocationWatchID=this.options.geolocation.watchPosition(this._onSuccess,this._onError,l),this.options.showUserHeading&&this._addDeviceOrientationListener()}}else this.options.geolocation.getCurrentPosition(this._onSuccess,this._onError,this.options.positionOptions),this._timeoutId=window.setTimeout(this._finish,1e4);return!0}_addDeviceOrientationListener(){const l=()=>{"ondeviceorientationabsolute"in window?window.addEventListener("deviceorientationabsolute",this._onDeviceOrientation):window.addEventListener("deviceorientation",this._onDeviceOrientation)};typeof DeviceMotionEvent<"u"&&typeof DeviceMotionEvent.requestPermission=="function"?DeviceOrientationEvent.requestPermission().then((t=>{t==="granted"&&l()})).catch(console.error):l()}_clearWatch(){this.options.geolocation.clearWatch(this._geolocationWatchID),window.removeEventListener("deviceorientation",this._onDeviceOrientation),window.removeEventListener("deviceorientationabsolute",this._onDeviceOrientation),this._geolocationWatchID=void 0,this._geolocateButton.classList.remove("mapboxgl-ctrl-geolocate-waiting"),this._geolocateButton.setAttribute("aria-pressed","false"),this.options.showUserLocation&&this._updateMarker(null)}},AttributionControl:Sl,ScaleControl:class{constructor(l={}){this.options=s.h({},Al,l),this._isNumberFormatSupported=(function(){try{return new Intl.NumberFormat("en",{style:"unit",unitDisplay:"short",unit:"meter"}),!0}catch{return!1}})(),s.aV(["_update","_setScale","setUnit"],this)}getDefaultPosition(){return"bottom-left"}_update(){const l=this.options.maxWidth||100,t=this._map,r=t._containerHeight/2,c=t._containerWidth/2-l/2,p=t.unproject([c,r]),_=t.unproject([c+l,r]),v=p.distanceTo(_);if(this.options.unit==="imperial"){const b=3.2808*v;b>5280?this._setScale(l,b/5280,"mile"):this._setScale(l,b,"foot")}else this.options.unit==="nautical"?this._setScale(l,v/1852,"nautical-mile"):v>=1e3?this._setScale(l,v/1e3,"kilometer"):this._setScale(l,v,"meter")}_setScale(l,t,r){this._map._requestDomTask((()=>{const c=(function(_){const v=Math.pow(10,`${Math.floor(_)}`.length-1);let b=_/v;return b=b>=10?10:b>=5?5:b>=3?3:b>=2?2:b>=1?1:(function(I){const M=Math.pow(10,Math.ceil(-Math.log(I)/Math.LN10));return Math.round(I*M)/M})(b),v*b})(t),p=c/t;this._container.innerHTML=this._isNumberFormatSupported&&r!=="nautical-mile"?new Intl.NumberFormat(this._language,{style:"unit",unitDisplay:"short",unit:r}).format(c):`${c}&nbsp;${kp[r]}`,this._container.style.width=l*p+"px"}))}onAdd(l){return this._map=l,this._language=l.getLanguage(),this._container=ct("div","mapboxgl-ctrl mapboxgl-ctrl-scale",l.getContainer()),this._container.dir="auto",this._map.on("move",this._update),this._update(),this._container}onRemove(){this._container.remove(),this._map.off("move",this._update),this._map=void 0}_setLanguage(l){this._language=l,this._update()}setUnit(l){this.options.unit=l,this._update()}},FullscreenControl:class{constructor(l={}){this._fullscreen=!1,l&&l.container&&(l.container instanceof HTMLElement?this._container=l.container:s.w("Full screen control 'container' must be a DOM element.")),s.aV(["_onClickFullscreen","_changeIcon"],this),"onfullscreenchange"in document?this._fullscreenchange="fullscreenchange":"onwebkitfullscreenchange"in document&&(this._fullscreenchange="webkitfullscreenchange")}onAdd(l){return this._map=l,this._container||(this._container=this._map.getContainer()),this._controlContainer=ct("div","mapboxgl-ctrl mapboxgl-ctrl-group"),this._checkFullscreenSupport()?this._setupUI():(this._controlContainer.style.display="none",s.w("This device does not support fullscreen mode.")),this._controlContainer}onRemove(){this._controlContainer.remove(),this._map=null,document.removeEventListener(this._fullscreenchange,this._changeIcon)}_checkFullscreenSupport(){return!(!document.fullscreenEnabled&&!document.webkitFullscreenEnabled)}_setupUI(){const l=this._fullscreenButton=ct("button","mapboxgl-ctrl-fullscreen",this._controlContainer);ct("span","mapboxgl-ctrl-icon",l).setAttribute("aria-hidden","true"),l.type="button",this._updateTitle(),this._fullscreenButton.addEventListener("click",this._onClickFullscreen),document.addEventListener(this._fullscreenchange,this._changeIcon)}_updateTitle(){const l=this._getTitle();this._fullscreenButton.setAttribute("aria-label",l),this._fullscreenButton.firstElementChild&&this._fullscreenButton.firstElementChild.setAttribute("title",l)}_getTitle(){return this._map._getUIString(this._isFullscreen()?"FullscreenControl.Exit":"FullscreenControl.Enter")}_isFullscreen(){return this._fullscreen}_changeIcon(){(document.fullscreenElement||document.webkitFullscreenElement)===this._container!==this._fullscreen&&(this._fullscreen=!this._fullscreen,this._fullscreenButton.classList.toggle("mapboxgl-ctrl-shrink"),this._fullscreenButton.classList.toggle("mapboxgl-ctrl-fullscreen"),this._updateTitle())}_onClickFullscreen(){this._isFullscreen()?document.exitFullscreen?document.exitFullscreen():document.webkitCancelFullScreen&&document.webkitCancelFullScreen():this._container.requestFullscreen?this._container.requestFullscreen():this._container.webkitRequestFullscreen&&this._container.webkitRequestFullscreen()}},IndoorControl:cf,Popup:class extends s.E{constructor(l){super(),this.options=s.h(Object.create(Kl),l),this._altitude=this.options.altitude,s.aV(["_update","_onClose","remove","_onMouseEvent"],this),this._classList=new Set(l&&l.className?l.className.trim().split(/\s+/):[])}addTo(l){return this._map&&this.remove(),this._map=l,this.options.closeOnClick&&l.on("preclick",this._onClose),this.options.closeOnMove&&l.on("move",this._onClose),l.on("remove",this.remove),this._update(),l._addPopup(this),this._focusFirstElement(),this._trackPointer?(l.on("mousemove",this._onMouseEvent),l.on("mouseup",this._onMouseEvent),l._canvasContainer.classList.add("mapboxgl-track-pointer")):l.on("move",this._update),this.fire(new s.A("open")),this}isOpen(){return!!this._map}remove(){this._content&&this._content.remove(),this._container&&(this._container.remove(),this._container=void 0);const l=this._map;return l&&(l.off("move",this._update),l.off("move",this._onClose),l.off("preclick",this._onClose),l.off("click",this._onClose),l.off("remove",this.remove),l.off("mousemove",this._onMouseEvent),l.off("mouseup",this._onMouseEvent),l.off("drag",this._onMouseEvent),l._canvasContainer&&l._canvasContainer.classList.remove("mapboxgl-track-pointer"),l._removePopup(this),this._map=void 0),this.fire(new s.A("close")),this}getLngLat(){return this._lngLat}setLngLat(l){this._lngLat=s.ci.convert(l),this._pos=null,this._trackPointer=!1,this._update();const t=this._map;return t&&(t.on("move",this._update),t.off("mousemove",this._onMouseEvent),t._canvasContainer.classList.remove("mapboxgl-track-pointer")),this}getAltitude(){return this._altitude}setAltitude(l){return this._altitude=l,this._update(),this}trackPointer(){this._trackPointer=!0,this._pos=null,this._update();const l=this._map;return l&&(l.off("move",this._update),l.on("mousemove",this._onMouseEvent),l.on("drag",this._onMouseEvent),l._canvasContainer.classList.add("mapboxgl-track-pointer")),this}getElement(){return this._container}setText(l){return this.setDOMContent(document.createTextNode(l))}setHTML(l){const t=document.createDocumentFragment(),r=document.createElement("body");let c;for(r.innerHTML=l;c=r.firstChild,c;)t.appendChild(c);return this.setDOMContent(t)}getMaxWidth(){return this._container&&this._container.style.maxWidth}setMaxWidth(l){return this.options.maxWidth=l,this._update(),this}setDOMContent(l){let t=this._content;if(t)for(;t.hasChildNodes();)t.firstChild&&t.removeChild(t.firstChild);else t=this._content=ct("div","mapboxgl-popup-content",this._container||void 0);if(t.appendChild(l),this.options.closeButton){const r=this._closeButton=ct("button","mapboxgl-popup-close-button",t);r.type="button",r.setAttribute("aria-label","Close popup"),r.innerHTML='<span aria-hidden="true">&#215;</span>',r.addEventListener("click",this._onClose)}return this._update(),this._focusFirstElement(),this}addClassName(l){return this._classList.add(l),this._updateClassList(),this}removeClassName(l){return this._classList.delete(l),this._updateClassList(),this}setOffset(l){return this.options.offset=l,this._update(),this}toggleClassName(l){let t;return this._classList.delete(l)?t=!1:(this._classList.add(l),t=!0),this._updateClassList(),t}_onMouseEvent(l){this._update(l.point)}_getAnchor(l){if(this.options.anchor)return this.options.anchor;const t=this._map,r=this._container,c=this._pos;if(!t||!r||!c)return"bottom";const p=r.offsetWidth,_=r.offsetHeight,v=c.x<p/2,b=c.x>t.transform.width-p/2;if(c.y+l<_)return v?"top-left":b?"top-right":"top";if(c.y>t.transform.height-_){if(v)return"bottom-left";if(b)return"bottom-right"}return v?"left":b?"right":"bottom"}_updateClassList(){const l=this._container;if(!l)return;const t=[...this._classList];t.push("mapboxgl-popup"),this._anchor&&t.push(`mapboxgl-popup-anchor-${this._anchor}`),this._trackPointer&&t.push("mapboxgl-popup-track-pointer"),l.className=t.join(" ")}_update(l){const t=this._map,r=this._content;if(!t||!this._lngLat&&!this._trackPointer||!r)return;let c=this._container;if(c||(c=this._container=ct("div","mapboxgl-popup",t.getContainer()),this._tip=ct("div","mapboxgl-popup-tip",c),c.appendChild(r)),this.options.maxWidth&&c.style.maxWidth!==this.options.maxWidth&&(c.style.maxWidth=this.options.maxWidth),t.transform.renderWorldCopies&&!this._trackPointer&&(this._lngLat=es(this._lngLat,this._pos,t.transform)),!this._trackPointer||l){const p=this._pos=this._trackPointer&&l instanceof s.P?l:t.project(this._lngLat,this._altitude),_=fo(this.options.offset),v=this._anchor=this._getAnchor(_.y),b=fo(this.options.offset,v),I=p.add(b).round();t._requestDomTask((()=>{this._container&&v&&(this._container.style.transform=`${Es[v]} translate(${I.x}px,${I.y}px)`)}))}if(!this._marker&&t._showingGlobe()){const p=s.eW(t.transform,this._lngLat)?0:1;this._setOpacity(p)}this._updateClassList()}_focusFirstElement(){if(!this.options.focusAfterOpen||!this._container)return;const l=this._container.querySelector(zp);l&&l.focus()}_onClose(){this.remove()}_setOpacity(l){this._container&&(this._container.style.opacity=`${l}`),this._content&&(this._content.style.pointerEvents=l?"auto":"none")}},Marker:oa,Style:yo,LngLat:s.ci,LngLatBounds:s.aG,Point:s.P,MercatorCoordinate:s.ac,FreeCameraOptions:cu,Evented:s.E,config:s.e,prewarm:s.e_,clearPrewarmedResources:s.eZ,get accessToken(){return s.e.ACCESS_TOKEN},set accessToken(l){s.e.ACCESS_TOKEN=l},get baseApiUrl(){return s.e.API_URL},set baseApiUrl(l){s.e.API_URL=l},get workerCount(){return s.f7.workerCount},set workerCount(l){s.f7.workerCount=l},get maxParallelImageRequests(){return s.e.MAX_PARALLEL_IMAGE_REQUESTS},set maxParallelImageRequests(l){s.e.MAX_PARALLEL_IMAGE_REQUESTS=l},clearStorage(l){s.f6(l)},get workerUrl(){return s.f5.workerUrl},set workerUrl(l){s.f5.workerUrl=l},get workerClass(){return s.f5.workerClass},set workerClass(l){s.f5.workerClass=l},get workerParams(){return s.f5.workerParams},set workerParams(l){s.f5.workerParams=l},get dracoUrl(){return s.f4()},set dracoUrl(l){s.f3(l)},get meshoptUrl(){return s.f2()},set meshoptUrl(l){s.f1(l)},setNow:s.q.setNow,restoreNow:s.q.restoreNow}}));var U=A;return U}))})(jg)),jg.exports}var q4=H4();const hp=J2(q4);var t2={};/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const vT=function(x){const u=[];let m=0;for(let E=0;E<x.length;E++){let A=x.charCodeAt(E);A<128?u[m++]=A:A<2048?(u[m++]=A>>6|192,u[m++]=A&63|128):(A&64512)===55296&&E+1<x.length&&(x.charCodeAt(E+1)&64512)===56320?(A=65536+((A&1023)<<10)+(x.charCodeAt(++E)&1023),u[m++]=A>>18|240,u[m++]=A>>12&63|128,u[m++]=A>>6&63|128,u[m++]=A&63|128):(u[m++]=A>>12|224,u[m++]=A>>6&63|128,u[m++]=A&63|128)}return u},$4=function(x){const u=[];let m=0,E=0;for(;m<x.length;){const A=x[m++];if(A<128)u[E++]=String.fromCharCode(A);else if(A>191&&A<224){const z=x[m++];u[E++]=String.fromCharCode((A&31)<<6|z&63)}else if(A>239&&A<365){const z=x[m++],U=x[m++],s=x[m++],ee=((A&7)<<18|(z&63)<<12|(U&63)<<6|s&63)-65536;u[E++]=String.fromCharCode(55296+(ee>>10)),u[E++]=String.fromCharCode(56320+(ee&1023))}else{const z=x[m++],U=x[m++];u[E++]=String.fromCharCode((A&15)<<12|(z&63)<<6|U&63)}}return u.join("")},xT={byteToCharMap_:null,charToByteMap_:null,byteToCharMapWebSafe_:null,charToByteMapWebSafe_:null,ENCODED_VALS_BASE:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",get ENCODED_VALS(){return this.ENCODED_VALS_BASE+"+/="},get ENCODED_VALS_WEBSAFE(){return this.ENCODED_VALS_BASE+"-_."},HAS_NATIVE_SUPPORT:typeof atob=="function",encodeByteArray(x,u){if(!Array.isArray(x))throw Error("encodeByteArray takes an array as a parameter");this.init_();const m=u?this.byteToCharMapWebSafe_:this.byteToCharMap_,E=[];for(let A=0;A<x.length;A+=3){const z=x[A],U=A+1<x.length,s=U?x[A+1]:0,ee=A+2<x.length,ne=ee?x[A+2]:0,Ie=z>>2,qe=(z&3)<<4|s>>4;let Xe=(s&15)<<2|ne>>6,St=ne&63;ee||(St=64,U||(Xe=64)),E.push(m[Ie],m[qe],m[Xe],m[St])}return E.join("")},encodeString(x,u){return this.HAS_NATIVE_SUPPORT&&!u?btoa(x):this.encodeByteArray(vT(x),u)},decodeString(x,u){return this.HAS_NATIVE_SUPPORT&&!u?atob(x):$4(this.decodeStringToByteArray(x,u))},decodeStringToByteArray(x,u){this.init_();const m=u?this.charToByteMapWebSafe_:this.charToByteMap_,E=[];for(let A=0;A<x.length;){const z=m[x.charAt(A++)],s=A<x.length?m[x.charAt(A)]:0;++A;const ne=A<x.length?m[x.charAt(A)]:64;++A;const qe=A<x.length?m[x.charAt(A)]:64;if(++A,z==null||s==null||ne==null||qe==null)throw new W4;const Xe=z<<2|s>>4;if(E.push(Xe),ne!==64){const St=s<<4&240|ne>>2;if(E.push(St),qe!==64){const $t=ne<<6&192|qe;E.push($t)}}}return E},init_(){if(!this.byteToCharMap_){this.byteToCharMap_={},this.charToByteMap_={},this.byteToCharMapWebSafe_={},this.charToByteMapWebSafe_={};for(let x=0;x<this.ENCODED_VALS.length;x++)this.byteToCharMap_[x]=this.ENCODED_VALS.charAt(x),this.charToByteMap_[this.byteToCharMap_[x]]=x,this.byteToCharMapWebSafe_[x]=this.ENCODED_VALS_WEBSAFE.charAt(x),this.charToByteMapWebSafe_[this.byteToCharMapWebSafe_[x]]=x,x>=this.ENCODED_VALS_BASE.length&&(this.charToByteMap_[this.ENCODED_VALS_WEBSAFE.charAt(x)]=x,this.charToByteMapWebSafe_[this.ENCODED_VALS.charAt(x)]=x)}}};class W4 extends Error{constructor(){super(...arguments),this.name="DecodeBase64StringError"}}const Z4=function(x){const u=vT(x);return xT.encodeByteArray(u,!0)},Xg=function(x){return Z4(x).replace(/\./g,"")},X4=function(x){try{return xT.decodeString(x,!0)}catch(u){console.error("base64Decode failed: ",u)}return null};/**
 * @license
 * Copyright 2022 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function K4(){if(typeof self<"u")return self;if(typeof window<"u")return window;if(typeof global<"u")return global;throw new Error("Unable to locate global object.")}/**
 * @license
 * Copyright 2022 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const Y4=()=>K4().__FIREBASE_DEFAULTS__,Q4=()=>{if(typeof process>"u"||typeof t2>"u")return;const x=t2.__FIREBASE_DEFAULTS__;if(x)return JSON.parse(x)},J4=()=>{if(typeof document>"u")return;let x;try{x=document.cookie.match(/__FIREBASE_DEFAULTS__=([^;]+)/)}catch{return}const u=x&&X4(x[1]);return u&&JSON.parse(u)},Av=()=>{try{return Y4()||Q4()||J4()}catch(x){console.info(`Unable to get __FIREBASE_DEFAULTS__ due to: ${x}`);return}},e5=x=>{var u,m;return(m=(u=Av())===null||u===void 0?void 0:u.emulatorHosts)===null||m===void 0?void 0:m[x]},t5=x=>{const u=e5(x);if(!u)return;const m=u.lastIndexOf(":");if(m<=0||m+1===u.length)throw new Error(`Invalid host ${u} with no separate hostname and port!`);const E=parseInt(u.substring(m+1),10);return u[0]==="["?[u.substring(1,m-1),E]:[u.substring(0,m),E]},wT=()=>{var x;return(x=Av())===null||x===void 0?void 0:x.config};/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class i5{constructor(){this.reject=()=>{},this.resolve=()=>{},this.promise=new Promise((u,m)=>{this.resolve=u,this.reject=m})}wrapCallback(u){return(m,E)=>{m?this.reject(m):this.resolve(E),typeof u=="function"&&(this.promise.catch(()=>{}),u.length===1?u(m):u(m,E))}}}/**
 * @license
 * Copyright 2021 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function n5(x,u){if(x.uid)throw new Error('The "uid" field is no longer supported by mockUserToken. Please use "sub" instead for Firebase Auth User ID.');const m={alg:"none",type:"JWT"},E=u||"demo-project",A=x.iat||0,z=x.sub||x.user_id;if(!z)throw new Error("mockUserToken must contain 'sub' or 'user_id' field!");const U=Object.assign({iss:`https://securetoken.google.com/${E}`,aud:E,iat:A,exp:A+3600,auth_time:A,sub:z,user_id:z,firebase:{sign_in_provider:"custom",identities:{}}},x);return[Xg(JSON.stringify(m)),Xg(JSON.stringify(U)),""].join(".")}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function r5(){return typeof navigator<"u"&&typeof navigator.userAgent=="string"?navigator.userAgent:""}function s5(){var x;const u=(x=Av())===null||x===void 0?void 0:x.forceEnvironment;if(u==="node")return!0;if(u==="browser")return!1;try{return Object.prototype.toString.call(global.process)==="[object process]"}catch{return!1}}function o5(){return!s5()&&!!navigator.userAgent&&navigator.userAgent.includes("Safari")&&!navigator.userAgent.includes("Chrome")}function a5(){try{return typeof indexedDB=="object"}catch{return!1}}function l5(){return new Promise((x,u)=>{try{let m=!0;const E="validate-browser-context-for-indexeddb-analytics-module",A=self.indexedDB.open(E);A.onsuccess=()=>{A.result.close(),m||self.indexedDB.deleteDatabase(E),x(!0)},A.onupgradeneeded=()=>{m=!1},A.onerror=()=>{var z;u(((z=A.error)===null||z===void 0?void 0:z.message)||"")}}catch(m){u(m)}})}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const c5="FirebaseError";class mm extends Error{constructor(u,m,E){super(m),this.code=u,this.customData=E,this.name=c5,Object.setPrototypeOf(this,mm.prototype),Error.captureStackTrace&&Error.captureStackTrace(this,bT.prototype.create)}}class bT{constructor(u,m,E){this.service=u,this.serviceName=m,this.errors=E}create(u,...m){const E=m[0]||{},A=`${this.service}/${u}`,z=this.errors[u],U=z?u5(z,E):"Error",s=`${this.serviceName}: ${U} (${A}).`;return new mm(A,s,E)}}function u5(x,u){return x.replace(h5,(m,E)=>{const A=u[E];return A!=null?String(A):`<${E}?>`})}const h5=/\{\$([^}]+)}/g;function ev(x,u){if(x===u)return!0;const m=Object.keys(x),E=Object.keys(u);for(const A of m){if(!E.includes(A))return!1;const z=x[A],U=u[A];if(i2(z)&&i2(U)){if(!ev(z,U))return!1}else if(z!==U)return!1}for(const A of E)if(!m.includes(A))return!1;return!0}function i2(x){return x!==null&&typeof x=="object"}/**
 * @license
 * Copyright 2021 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function md(x){return x&&x._delegate?x._delegate:x}class x_{constructor(u,m,E){this.name=u,this.instanceFactory=m,this.type=E,this.multipleInstances=!1,this.serviceProps={},this.instantiationMode="LAZY",this.onInstanceCreated=null}setInstantiationMode(u){return this.instantiationMode=u,this}setMultipleInstances(u){return this.multipleInstances=u,this}setServiceProps(u){return this.serviceProps=u,this}setInstanceCreatedCallback(u){return this.onInstanceCreated=u,this}}/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const dp="[DEFAULT]";/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class d5{constructor(u,m){this.name=u,this.container=m,this.component=null,this.instances=new Map,this.instancesDeferred=new Map,this.instancesOptions=new Map,this.onInitCallbacks=new Map}get(u){const m=this.normalizeInstanceIdentifier(u);if(!this.instancesDeferred.has(m)){const E=new i5;if(this.instancesDeferred.set(m,E),this.isInitialized(m)||this.shouldAutoInitialize())try{const A=this.getOrInitializeService({instanceIdentifier:m});A&&E.resolve(A)}catch{}}return this.instancesDeferred.get(m).promise}getImmediate(u){var m;const E=this.normalizeInstanceIdentifier(u?.identifier),A=(m=u?.optional)!==null&&m!==void 0?m:!1;if(this.isInitialized(E)||this.shouldAutoInitialize())try{return this.getOrInitializeService({instanceIdentifier:E})}catch(z){if(A)return null;throw z}else{if(A)return null;throw Error(`Service ${this.name} is not available`)}}getComponent(){return this.component}setComponent(u){if(u.name!==this.name)throw Error(`Mismatching Component ${u.name} for Provider ${this.name}.`);if(this.component)throw Error(`Component for ${this.name} has already been provided`);if(this.component=u,!!this.shouldAutoInitialize()){if(p5(u))try{this.getOrInitializeService({instanceIdentifier:dp})}catch{}for(const[m,E]of this.instancesDeferred.entries()){const A=this.normalizeInstanceIdentifier(m);try{const z=this.getOrInitializeService({instanceIdentifier:A});E.resolve(z)}catch{}}}}clearInstance(u=dp){this.instancesDeferred.delete(u),this.instancesOptions.delete(u),this.instances.delete(u)}async delete(){const u=Array.from(this.instances.values());await Promise.all([...u.filter(m=>"INTERNAL"in m).map(m=>m.INTERNAL.delete()),...u.filter(m=>"_delete"in m).map(m=>m._delete())])}isComponentSet(){return this.component!=null}isInitialized(u=dp){return this.instances.has(u)}getOptions(u=dp){return this.instancesOptions.get(u)||{}}initialize(u={}){const{options:m={}}=u,E=this.normalizeInstanceIdentifier(u.instanceIdentifier);if(this.isInitialized(E))throw Error(`${this.name}(${E}) has already been initialized`);if(!this.isComponentSet())throw Error(`Component ${this.name} has not been registered yet`);const A=this.getOrInitializeService({instanceIdentifier:E,options:m});for(const[z,U]of this.instancesDeferred.entries()){const s=this.normalizeInstanceIdentifier(z);E===s&&U.resolve(A)}return A}onInit(u,m){var E;const A=this.normalizeInstanceIdentifier(m),z=(E=this.onInitCallbacks.get(A))!==null&&E!==void 0?E:new Set;z.add(u),this.onInitCallbacks.set(A,z);const U=this.instances.get(A);return U&&u(U,A),()=>{z.delete(u)}}invokeOnInitCallbacks(u,m){const E=this.onInitCallbacks.get(m);if(E)for(const A of E)try{A(u,m)}catch{}}getOrInitializeService({instanceIdentifier:u,options:m={}}){let E=this.instances.get(u);if(!E&&this.component&&(E=this.component.instanceFactory(this.container,{instanceIdentifier:f5(u),options:m}),this.instances.set(u,E),this.instancesOptions.set(u,m),this.invokeOnInitCallbacks(E,u),this.component.onInstanceCreated))try{this.component.onInstanceCreated(this.container,u,E)}catch{}return E||null}normalizeInstanceIdentifier(u=dp){return this.component?this.component.multipleInstances?u:dp:u}shouldAutoInitialize(){return!!this.component&&this.component.instantiationMode!=="EXPLICIT"}}function f5(x){return x===dp?void 0:x}function p5(x){return x.instantiationMode==="EAGER"}/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class m5{constructor(u){this.name=u,this.providers=new Map}addComponent(u){const m=this.getProvider(u.name);if(m.isComponentSet())throw new Error(`Component ${u.name} has already been registered with ${this.name}`);m.setComponent(u)}addOrOverwriteComponent(u){this.getProvider(u.name).isComponentSet()&&this.providers.delete(u.name),this.addComponent(u)}getProvider(u){if(this.providers.has(u))return this.providers.get(u);const m=new d5(u,this);return this.providers.set(u,m),m}getProviders(){return Array.from(this.providers.values())}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */var Jr;(function(x){x[x.DEBUG=0]="DEBUG",x[x.VERBOSE=1]="VERBOSE",x[x.INFO=2]="INFO",x[x.WARN=3]="WARN",x[x.ERROR=4]="ERROR",x[x.SILENT=5]="SILENT"})(Jr||(Jr={}));const _5={debug:Jr.DEBUG,verbose:Jr.VERBOSE,info:Jr.INFO,warn:Jr.WARN,error:Jr.ERROR,silent:Jr.SILENT},g5=Jr.INFO,y5={[Jr.DEBUG]:"log",[Jr.VERBOSE]:"log",[Jr.INFO]:"info",[Jr.WARN]:"warn",[Jr.ERROR]:"error"},v5=(x,u,...m)=>{if(u<x.logLevel)return;const E=new Date().toISOString(),A=y5[u];if(A)console[A](`[${E}]  ${x.name}:`,...m);else throw new Error(`Attempted to log a message with an invalid logType (value: ${u})`)};class TT{constructor(u){this.name=u,this._logLevel=g5,this._logHandler=v5,this._userLogHandler=null}get logLevel(){return this._logLevel}set logLevel(u){if(!(u in Jr))throw new TypeError(`Invalid value "${u}" assigned to \`logLevel\``);this._logLevel=u}setLogLevel(u){this._logLevel=typeof u=="string"?_5[u]:u}get logHandler(){return this._logHandler}set logHandler(u){if(typeof u!="function")throw new TypeError("Value assigned to `logHandler` must be a function");this._logHandler=u}get userLogHandler(){return this._userLogHandler}set userLogHandler(u){this._userLogHandler=u}debug(...u){this._userLogHandler&&this._userLogHandler(this,Jr.DEBUG,...u),this._logHandler(this,Jr.DEBUG,...u)}log(...u){this._userLogHandler&&this._userLogHandler(this,Jr.VERBOSE,...u),this._logHandler(this,Jr.VERBOSE,...u)}info(...u){this._userLogHandler&&this._userLogHandler(this,Jr.INFO,...u),this._logHandler(this,Jr.INFO,...u)}warn(...u){this._userLogHandler&&this._userLogHandler(this,Jr.WARN,...u),this._logHandler(this,Jr.WARN,...u)}error(...u){this._userLogHandler&&this._userLogHandler(this,Jr.ERROR,...u),this._logHandler(this,Jr.ERROR,...u)}}const x5=(x,u)=>u.some(m=>x instanceof m);let n2,r2;function w5(){return n2||(n2=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction])}function b5(){return r2||(r2=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey])}const ET=new WeakMap,tv=new WeakMap,ST=new WeakMap,j0=new WeakMap,Cv=new WeakMap;function T5(x){const u=new Promise((m,E)=>{const A=()=>{x.removeEventListener("success",z),x.removeEventListener("error",U)},z=()=>{m(Tf(x.result)),A()},U=()=>{E(x.error),A()};x.addEventListener("success",z),x.addEventListener("error",U)});return u.then(m=>{m instanceof IDBCursor&&ET.set(m,x)}).catch(()=>{}),Cv.set(u,x),u}function E5(x){if(tv.has(x))return;const u=new Promise((m,E)=>{const A=()=>{x.removeEventListener("complete",z),x.removeEventListener("error",U),x.removeEventListener("abort",U)},z=()=>{m(),A()},U=()=>{E(x.error||new DOMException("AbortError","AbortError")),A()};x.addEventListener("complete",z),x.addEventListener("error",U),x.addEventListener("abort",U)});tv.set(x,u)}let iv={get(x,u,m){if(x instanceof IDBTransaction){if(u==="done")return tv.get(x);if(u==="objectStoreNames")return x.objectStoreNames||ST.get(x);if(u==="store")return m.objectStoreNames[1]?void 0:m.objectStore(m.objectStoreNames[0])}return Tf(x[u])},set(x,u,m){return x[u]=m,!0},has(x,u){return x instanceof IDBTransaction&&(u==="done"||u==="store")?!0:u in x}};function S5(x){iv=x(iv)}function I5(x){return x===IDBDatabase.prototype.transaction&&!("objectStoreNames"in IDBTransaction.prototype)?function(u,...m){const E=x.call(G0(this),u,...m);return ST.set(E,u.sort?u.sort():[u]),Tf(E)}:b5().includes(x)?function(...u){return x.apply(G0(this),u),Tf(ET.get(this))}:function(...u){return Tf(x.apply(G0(this),u))}}function A5(x){return typeof x=="function"?I5(x):(x instanceof IDBTransaction&&E5(x),x5(x,w5())?new Proxy(x,iv):x)}function Tf(x){if(x instanceof IDBRequest)return T5(x);if(j0.has(x))return j0.get(x);const u=A5(x);return u!==x&&(j0.set(x,u),Cv.set(u,x)),u}const G0=x=>Cv.get(x);function C5(x,u,{blocked:m,upgrade:E,blocking:A,terminated:z}={}){const U=indexedDB.open(x,u),s=Tf(U);return E&&U.addEventListener("upgradeneeded",ee=>{E(Tf(U.result),ee.oldVersion,ee.newVersion,Tf(U.transaction),ee)}),m&&U.addEventListener("blocked",ee=>m(ee.oldVersion,ee.newVersion,ee)),s.then(ee=>{z&&ee.addEventListener("close",()=>z()),A&&ee.addEventListener("versionchange",ne=>A(ne.oldVersion,ne.newVersion,ne))}).catch(()=>{}),s}const P5=["get","getKey","getAll","getAllKeys","count"],R5=["put","add","delete","clear"],H0=new Map;function s2(x,u){if(!(x instanceof IDBDatabase&&!(u in x)&&typeof u=="string"))return;if(H0.get(u))return H0.get(u);const m=u.replace(/FromIndex$/,""),E=u!==m,A=R5.includes(m);if(!(m in(E?IDBIndex:IDBObjectStore).prototype)||!(A||P5.includes(m)))return;const z=async function(U,...s){const ee=this.transaction(U,A?"readwrite":"readonly");let ne=ee.store;return E&&(ne=ne.index(s.shift())),(await Promise.all([ne[m](...s),A&&ee.done]))[0]};return H0.set(u,z),z}S5(x=>({...x,get:(u,m,E)=>s2(u,m)||x.get(u,m,E),has:(u,m)=>!!s2(u,m)||x.has(u,m)}));/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class M5{constructor(u){this.container=u}getPlatformInfoString(){return this.container.getProviders().map(m=>{if(D5(m)){const E=m.getImmediate();return`${E.library}/${E.version}`}else return null}).filter(m=>m).join(" ")}}function D5(x){const u=x.getComponent();return u?.type==="VERSION"}const nv="@firebase/app",o2="0.10.13";/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const _d=new TT("@firebase/app"),L5="@firebase/app-compat",k5="@firebase/analytics-compat",z5="@firebase/analytics",F5="@firebase/app-check-compat",O5="@firebase/app-check",B5="@firebase/auth",N5="@firebase/auth-compat",V5="@firebase/database",U5="@firebase/data-connect",j5="@firebase/database-compat",G5="@firebase/functions",H5="@firebase/functions-compat",q5="@firebase/installations",$5="@firebase/installations-compat",W5="@firebase/messaging",Z5="@firebase/messaging-compat",X5="@firebase/performance",K5="@firebase/performance-compat",Y5="@firebase/remote-config",Q5="@firebase/remote-config-compat",J5="@firebase/storage",eC="@firebase/storage-compat",tC="@firebase/firestore",iC="@firebase/vertexai-preview",nC="@firebase/firestore-compat",rC="firebase",sC="10.14.1";/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const rv="[DEFAULT]",oC={[nv]:"fire-core",[L5]:"fire-core-compat",[z5]:"fire-analytics",[k5]:"fire-analytics-compat",[O5]:"fire-app-check",[F5]:"fire-app-check-compat",[B5]:"fire-auth",[N5]:"fire-auth-compat",[V5]:"fire-rtdb",[U5]:"fire-data-connect",[j5]:"fire-rtdb-compat",[G5]:"fire-fn",[H5]:"fire-fn-compat",[q5]:"fire-iid",[$5]:"fire-iid-compat",[W5]:"fire-fcm",[Z5]:"fire-fcm-compat",[X5]:"fire-perf",[K5]:"fire-perf-compat",[Y5]:"fire-rc",[Q5]:"fire-rc-compat",[J5]:"fire-gcs",[eC]:"fire-gcs-compat",[tC]:"fire-fst",[nC]:"fire-fst-compat",[iC]:"fire-vertex","fire-js":"fire-js",[rC]:"fire-js-all"};/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const Kg=new Map,aC=new Map,sv=new Map;function a2(x,u){try{x.container.addComponent(u)}catch(m){_d.debug(`Component ${u.name} failed to register with FirebaseApp ${x.name}`,m)}}function Yg(x){const u=x.name;if(sv.has(u))return _d.debug(`There were multiple attempts to register component ${u}.`),!1;sv.set(u,x);for(const m of Kg.values())a2(m,x);for(const m of aC.values())a2(m,x);return!0}function lC(x,u){const m=x.container.getProvider("heartbeat").getImmediate({optional:!0});return m&&m.triggerHeartbeat(),x.container.getProvider(u)}/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const cC={"no-app":"No Firebase App '{$appName}' has been created - call initializeApp() first","bad-app-name":"Illegal App name: '{$appName}'","duplicate-app":"Firebase App named '{$appName}' already exists with different options or config","app-deleted":"Firebase App named '{$appName}' already deleted","server-app-deleted":"Firebase Server App has been deleted","no-options":"Need to provide options, when not being deployed to hosting via source.","invalid-app-argument":"firebase.{$appName}() takes either no argument or a Firebase App instance.","invalid-log-argument":"First argument to `onLog` must be null or a function.","idb-open":"Error thrown when opening IndexedDB. Original error: {$originalErrorMessage}.","idb-get":"Error thrown when reading from IndexedDB. Original error: {$originalErrorMessage}.","idb-set":"Error thrown when writing to IndexedDB. Original error: {$originalErrorMessage}.","idb-delete":"Error thrown when deleting from IndexedDB. Original error: {$originalErrorMessage}.","finalization-registry-not-supported":"FirebaseServerApp deleteOnDeref field defined but the JS runtime does not support FinalizationRegistry.","invalid-server-app-environment":"FirebaseServerApp is not for use in browser environments."},Ef=new bT("app","Firebase",cC);/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class uC{constructor(u,m,E){this._isDeleted=!1,this._options=Object.assign({},u),this._config=Object.assign({},m),this._name=m.name,this._automaticDataCollectionEnabled=m.automaticDataCollectionEnabled,this._container=E,this.container.addComponent(new x_("app",()=>this,"PUBLIC"))}get automaticDataCollectionEnabled(){return this.checkDestroyed(),this._automaticDataCollectionEnabled}set automaticDataCollectionEnabled(u){this.checkDestroyed(),this._automaticDataCollectionEnabled=u}get name(){return this.checkDestroyed(),this._name}get options(){return this.checkDestroyed(),this._options}get config(){return this.checkDestroyed(),this._config}get container(){return this._container}get isDeleted(){return this._isDeleted}set isDeleted(u){this._isDeleted=u}checkDestroyed(){if(this.isDeleted)throw Ef.create("app-deleted",{appName:this._name})}}/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const hC=sC;function IT(x,u={}){let m=x;typeof u!="object"&&(u={name:u});const E=Object.assign({name:rv,automaticDataCollectionEnabled:!1},u),A=E.name;if(typeof A!="string"||!A)throw Ef.create("bad-app-name",{appName:String(A)});if(m||(m=wT()),!m)throw Ef.create("no-options");const z=Kg.get(A);if(z){if(ev(m,z.options)&&ev(E,z.config))return z;throw Ef.create("duplicate-app",{appName:A})}const U=new m5(A);for(const ee of sv.values())U.addComponent(ee);const s=new uC(m,E,U);return Kg.set(A,s),s}function dC(x=rv){const u=Kg.get(x);if(!u&&x===rv&&wT())return IT();if(!u)throw Ef.create("no-app",{appName:x});return u}function rm(x,u,m){var E;let A=(E=oC[x])!==null&&E!==void 0?E:x;m&&(A+=`-${m}`);const z=A.match(/\s|\//),U=u.match(/\s|\//);if(z||U){const s=[`Unable to register library "${A}" with version "${u}":`];z&&s.push(`library name "${A}" contains illegal characters (whitespace or "/")`),z&&U&&s.push("and"),U&&s.push(`version name "${u}" contains illegal characters (whitespace or "/")`),_d.warn(s.join(" "));return}Yg(new x_(`${A}-version`,()=>({library:A,version:u}),"VERSION"))}/**
 * @license
 * Copyright 2021 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const fC="firebase-heartbeat-database",pC=1,w_="firebase-heartbeat-store";let q0=null;function AT(){return q0||(q0=C5(fC,pC,{upgrade:(x,u)=>{switch(u){case 0:try{x.createObjectStore(w_)}catch(m){console.warn(m)}}}}).catch(x=>{throw Ef.create("idb-open",{originalErrorMessage:x.message})})),q0}async function mC(x){try{const m=(await AT()).transaction(w_),E=await m.objectStore(w_).get(CT(x));return await m.done,E}catch(u){if(u instanceof mm)_d.warn(u.message);else{const m=Ef.create("idb-get",{originalErrorMessage:u?.message});_d.warn(m.message)}}}async function l2(x,u){try{const E=(await AT()).transaction(w_,"readwrite");await E.objectStore(w_).put(u,CT(x)),await E.done}catch(m){if(m instanceof mm)_d.warn(m.message);else{const E=Ef.create("idb-set",{originalErrorMessage:m?.message});_d.warn(E.message)}}}function CT(x){return`${x.name}!${x.options.appId}`}/**
 * @license
 * Copyright 2021 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const _C=1024,gC=720*60*60*1e3;class yC{constructor(u){this.container=u,this._heartbeatsCache=null;const m=this.container.getProvider("app").getImmediate();this._storage=new xC(m),this._heartbeatsCachePromise=this._storage.read().then(E=>(this._heartbeatsCache=E,E))}async triggerHeartbeat(){var u,m;try{const A=this.container.getProvider("platform-logger").getImmediate().getPlatformInfoString(),z=c2();return((u=this._heartbeatsCache)===null||u===void 0?void 0:u.heartbeats)==null&&(this._heartbeatsCache=await this._heartbeatsCachePromise,((m=this._heartbeatsCache)===null||m===void 0?void 0:m.heartbeats)==null)||this._heartbeatsCache.lastSentHeartbeatDate===z||this._heartbeatsCache.heartbeats.some(U=>U.date===z)?void 0:(this._heartbeatsCache.heartbeats.push({date:z,agent:A}),this._heartbeatsCache.heartbeats=this._heartbeatsCache.heartbeats.filter(U=>{const s=new Date(U.date).valueOf();return Date.now()-s<=gC}),this._storage.overwrite(this._heartbeatsCache))}catch(E){_d.warn(E)}}async getHeartbeatsHeader(){var u;try{if(this._heartbeatsCache===null&&await this._heartbeatsCachePromise,((u=this._heartbeatsCache)===null||u===void 0?void 0:u.heartbeats)==null||this._heartbeatsCache.heartbeats.length===0)return"";const m=c2(),{heartbeatsToSend:E,unsentEntries:A}=vC(this._heartbeatsCache.heartbeats),z=Xg(JSON.stringify({version:2,heartbeats:E}));return this._heartbeatsCache.lastSentHeartbeatDate=m,A.length>0?(this._heartbeatsCache.heartbeats=A,await this._storage.overwrite(this._heartbeatsCache)):(this._heartbeatsCache.heartbeats=[],this._storage.overwrite(this._heartbeatsCache)),z}catch(m){return _d.warn(m),""}}}function c2(){return new Date().toISOString().substring(0,10)}function vC(x,u=_C){const m=[];let E=x.slice();for(const A of x){const z=m.find(U=>U.agent===A.agent);if(z){if(z.dates.push(A.date),u2(m)>u){z.dates.pop();break}}else if(m.push({agent:A.agent,dates:[A.date]}),u2(m)>u){m.pop();break}E=E.slice(1)}return{heartbeatsToSend:m,unsentEntries:E}}class xC{constructor(u){this.app=u,this._canUseIndexedDBPromise=this.runIndexedDBEnvironmentCheck()}async runIndexedDBEnvironmentCheck(){return a5()?l5().then(()=>!0).catch(()=>!1):!1}async read(){if(await this._canUseIndexedDBPromise){const m=await mC(this.app);return m?.heartbeats?m:{heartbeats:[]}}else return{heartbeats:[]}}async overwrite(u){var m;if(await this._canUseIndexedDBPromise){const A=await this.read();return l2(this.app,{lastSentHeartbeatDate:(m=u.lastSentHeartbeatDate)!==null&&m!==void 0?m:A.lastSentHeartbeatDate,heartbeats:u.heartbeats})}else return}async add(u){var m;if(await this._canUseIndexedDBPromise){const A=await this.read();return l2(this.app,{lastSentHeartbeatDate:(m=u.lastSentHeartbeatDate)!==null&&m!==void 0?m:A.lastSentHeartbeatDate,heartbeats:[...A.heartbeats,...u.heartbeats]})}else return}}function u2(x){return Xg(JSON.stringify({version:2,heartbeats:x})).length}/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function wC(x){Yg(new x_("platform-logger",u=>new M5(u),"PRIVATE")),Yg(new x_("heartbeat",u=>new yC(u),"PRIVATE")),rm(nv,o2,x),rm(nv,o2,"esm2017"),rm("fire-js","")}wC("");var bC="firebase",TC="10.14.1";/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */rm(bC,TC,"app");var h2=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};/** @license
Copyright The Closure Library Authors.
SPDX-License-Identifier: Apache-2.0
*/var mp,PT;(function(){var x;/** @license

 Copyright The Closure Library Authors.
 SPDX-License-Identifier: Apache-2.0
*/function u(rt,De){function je(){}je.prototype=De.prototype,rt.D=De.prototype,rt.prototype=new je,rt.prototype.constructor=rt,rt.C=function(Ke,We,ut){for(var Oe=Array(arguments.length-2),kn=2;kn<arguments.length;kn++)Oe[kn-2]=arguments[kn];return De.prototype[We].apply(Ke,Oe)}}function m(){this.blockSize=-1}function E(){this.blockSize=-1,this.blockSize=64,this.g=Array(4),this.B=Array(this.blockSize),this.o=this.h=0,this.s()}u(E,m),E.prototype.s=function(){this.g[0]=1732584193,this.g[1]=4023233417,this.g[2]=2562383102,this.g[3]=271733878,this.o=this.h=0};function A(rt,De,je){je||(je=0);var Ke=Array(16);if(typeof De=="string")for(var We=0;16>We;++We)Ke[We]=De.charCodeAt(je++)|De.charCodeAt(je++)<<8|De.charCodeAt(je++)<<16|De.charCodeAt(je++)<<24;else for(We=0;16>We;++We)Ke[We]=De[je++]|De[je++]<<8|De[je++]<<16|De[je++]<<24;De=rt.g[0],je=rt.g[1],We=rt.g[2];var ut=rt.g[3],Oe=De+(ut^je&(We^ut))+Ke[0]+3614090360&4294967295;De=je+(Oe<<7&4294967295|Oe>>>25),Oe=ut+(We^De&(je^We))+Ke[1]+3905402710&4294967295,ut=De+(Oe<<12&4294967295|Oe>>>20),Oe=We+(je^ut&(De^je))+Ke[2]+606105819&4294967295,We=ut+(Oe<<17&4294967295|Oe>>>15),Oe=je+(De^We&(ut^De))+Ke[3]+3250441966&4294967295,je=We+(Oe<<22&4294967295|Oe>>>10),Oe=De+(ut^je&(We^ut))+Ke[4]+4118548399&4294967295,De=je+(Oe<<7&4294967295|Oe>>>25),Oe=ut+(We^De&(je^We))+Ke[5]+1200080426&4294967295,ut=De+(Oe<<12&4294967295|Oe>>>20),Oe=We+(je^ut&(De^je))+Ke[6]+2821735955&4294967295,We=ut+(Oe<<17&4294967295|Oe>>>15),Oe=je+(De^We&(ut^De))+Ke[7]+4249261313&4294967295,je=We+(Oe<<22&4294967295|Oe>>>10),Oe=De+(ut^je&(We^ut))+Ke[8]+1770035416&4294967295,De=je+(Oe<<7&4294967295|Oe>>>25),Oe=ut+(We^De&(je^We))+Ke[9]+2336552879&4294967295,ut=De+(Oe<<12&4294967295|Oe>>>20),Oe=We+(je^ut&(De^je))+Ke[10]+4294925233&4294967295,We=ut+(Oe<<17&4294967295|Oe>>>15),Oe=je+(De^We&(ut^De))+Ke[11]+2304563134&4294967295,je=We+(Oe<<22&4294967295|Oe>>>10),Oe=De+(ut^je&(We^ut))+Ke[12]+1804603682&4294967295,De=je+(Oe<<7&4294967295|Oe>>>25),Oe=ut+(We^De&(je^We))+Ke[13]+4254626195&4294967295,ut=De+(Oe<<12&4294967295|Oe>>>20),Oe=We+(je^ut&(De^je))+Ke[14]+2792965006&4294967295,We=ut+(Oe<<17&4294967295|Oe>>>15),Oe=je+(De^We&(ut^De))+Ke[15]+1236535329&4294967295,je=We+(Oe<<22&4294967295|Oe>>>10),Oe=De+(We^ut&(je^We))+Ke[1]+4129170786&4294967295,De=je+(Oe<<5&4294967295|Oe>>>27),Oe=ut+(je^We&(De^je))+Ke[6]+3225465664&4294967295,ut=De+(Oe<<9&4294967295|Oe>>>23),Oe=We+(De^je&(ut^De))+Ke[11]+643717713&4294967295,We=ut+(Oe<<14&4294967295|Oe>>>18),Oe=je+(ut^De&(We^ut))+Ke[0]+3921069994&4294967295,je=We+(Oe<<20&4294967295|Oe>>>12),Oe=De+(We^ut&(je^We))+Ke[5]+3593408605&4294967295,De=je+(Oe<<5&4294967295|Oe>>>27),Oe=ut+(je^We&(De^je))+Ke[10]+38016083&4294967295,ut=De+(Oe<<9&4294967295|Oe>>>23),Oe=We+(De^je&(ut^De))+Ke[15]+3634488961&4294967295,We=ut+(Oe<<14&4294967295|Oe>>>18),Oe=je+(ut^De&(We^ut))+Ke[4]+3889429448&4294967295,je=We+(Oe<<20&4294967295|Oe>>>12),Oe=De+(We^ut&(je^We))+Ke[9]+568446438&4294967295,De=je+(Oe<<5&4294967295|Oe>>>27),Oe=ut+(je^We&(De^je))+Ke[14]+3275163606&4294967295,ut=De+(Oe<<9&4294967295|Oe>>>23),Oe=We+(De^je&(ut^De))+Ke[3]+4107603335&4294967295,We=ut+(Oe<<14&4294967295|Oe>>>18),Oe=je+(ut^De&(We^ut))+Ke[8]+1163531501&4294967295,je=We+(Oe<<20&4294967295|Oe>>>12),Oe=De+(We^ut&(je^We))+Ke[13]+2850285829&4294967295,De=je+(Oe<<5&4294967295|Oe>>>27),Oe=ut+(je^We&(De^je))+Ke[2]+4243563512&4294967295,ut=De+(Oe<<9&4294967295|Oe>>>23),Oe=We+(De^je&(ut^De))+Ke[7]+1735328473&4294967295,We=ut+(Oe<<14&4294967295|Oe>>>18),Oe=je+(ut^De&(We^ut))+Ke[12]+2368359562&4294967295,je=We+(Oe<<20&4294967295|Oe>>>12),Oe=De+(je^We^ut)+Ke[5]+4294588738&4294967295,De=je+(Oe<<4&4294967295|Oe>>>28),Oe=ut+(De^je^We)+Ke[8]+2272392833&4294967295,ut=De+(Oe<<11&4294967295|Oe>>>21),Oe=We+(ut^De^je)+Ke[11]+1839030562&4294967295,We=ut+(Oe<<16&4294967295|Oe>>>16),Oe=je+(We^ut^De)+Ke[14]+4259657740&4294967295,je=We+(Oe<<23&4294967295|Oe>>>9),Oe=De+(je^We^ut)+Ke[1]+2763975236&4294967295,De=je+(Oe<<4&4294967295|Oe>>>28),Oe=ut+(De^je^We)+Ke[4]+1272893353&4294967295,ut=De+(Oe<<11&4294967295|Oe>>>21),Oe=We+(ut^De^je)+Ke[7]+4139469664&4294967295,We=ut+(Oe<<16&4294967295|Oe>>>16),Oe=je+(We^ut^De)+Ke[10]+3200236656&4294967295,je=We+(Oe<<23&4294967295|Oe>>>9),Oe=De+(je^We^ut)+Ke[13]+681279174&4294967295,De=je+(Oe<<4&4294967295|Oe>>>28),Oe=ut+(De^je^We)+Ke[0]+3936430074&4294967295,ut=De+(Oe<<11&4294967295|Oe>>>21),Oe=We+(ut^De^je)+Ke[3]+3572445317&4294967295,We=ut+(Oe<<16&4294967295|Oe>>>16),Oe=je+(We^ut^De)+Ke[6]+76029189&4294967295,je=We+(Oe<<23&4294967295|Oe>>>9),Oe=De+(je^We^ut)+Ke[9]+3654602809&4294967295,De=je+(Oe<<4&4294967295|Oe>>>28),Oe=ut+(De^je^We)+Ke[12]+3873151461&4294967295,ut=De+(Oe<<11&4294967295|Oe>>>21),Oe=We+(ut^De^je)+Ke[15]+530742520&4294967295,We=ut+(Oe<<16&4294967295|Oe>>>16),Oe=je+(We^ut^De)+Ke[2]+3299628645&4294967295,je=We+(Oe<<23&4294967295|Oe>>>9),Oe=De+(We^(je|~ut))+Ke[0]+4096336452&4294967295,De=je+(Oe<<6&4294967295|Oe>>>26),Oe=ut+(je^(De|~We))+Ke[7]+1126891415&4294967295,ut=De+(Oe<<10&4294967295|Oe>>>22),Oe=We+(De^(ut|~je))+Ke[14]+2878612391&4294967295,We=ut+(Oe<<15&4294967295|Oe>>>17),Oe=je+(ut^(We|~De))+Ke[5]+4237533241&4294967295,je=We+(Oe<<21&4294967295|Oe>>>11),Oe=De+(We^(je|~ut))+Ke[12]+1700485571&4294967295,De=je+(Oe<<6&4294967295|Oe>>>26),Oe=ut+(je^(De|~We))+Ke[3]+2399980690&4294967295,ut=De+(Oe<<10&4294967295|Oe>>>22),Oe=We+(De^(ut|~je))+Ke[10]+4293915773&4294967295,We=ut+(Oe<<15&4294967295|Oe>>>17),Oe=je+(ut^(We|~De))+Ke[1]+2240044497&4294967295,je=We+(Oe<<21&4294967295|Oe>>>11),Oe=De+(We^(je|~ut))+Ke[8]+1873313359&4294967295,De=je+(Oe<<6&4294967295|Oe>>>26),Oe=ut+(je^(De|~We))+Ke[15]+4264355552&4294967295,ut=De+(Oe<<10&4294967295|Oe>>>22),Oe=We+(De^(ut|~je))+Ke[6]+2734768916&4294967295,We=ut+(Oe<<15&4294967295|Oe>>>17),Oe=je+(ut^(We|~De))+Ke[13]+1309151649&4294967295,je=We+(Oe<<21&4294967295|Oe>>>11),Oe=De+(We^(je|~ut))+Ke[4]+4149444226&4294967295,De=je+(Oe<<6&4294967295|Oe>>>26),Oe=ut+(je^(De|~We))+Ke[11]+3174756917&4294967295,ut=De+(Oe<<10&4294967295|Oe>>>22),Oe=We+(De^(ut|~je))+Ke[2]+718787259&4294967295,We=ut+(Oe<<15&4294967295|Oe>>>17),Oe=je+(ut^(We|~De))+Ke[9]+3951481745&4294967295,rt.g[0]=rt.g[0]+De&4294967295,rt.g[1]=rt.g[1]+(We+(Oe<<21&4294967295|Oe>>>11))&4294967295,rt.g[2]=rt.g[2]+We&4294967295,rt.g[3]=rt.g[3]+ut&4294967295}E.prototype.u=function(rt,De){De===void 0&&(De=rt.length);for(var je=De-this.blockSize,Ke=this.B,We=this.h,ut=0;ut<De;){if(We==0)for(;ut<=je;)A(this,rt,ut),ut+=this.blockSize;if(typeof rt=="string"){for(;ut<De;)if(Ke[We++]=rt.charCodeAt(ut++),We==this.blockSize){A(this,Ke),We=0;break}}else for(;ut<De;)if(Ke[We++]=rt[ut++],We==this.blockSize){A(this,Ke),We=0;break}}this.h=We,this.o+=De},E.prototype.v=function(){var rt=Array((56>this.h?this.blockSize:2*this.blockSize)-this.h);rt[0]=128;for(var De=1;De<rt.length-8;++De)rt[De]=0;var je=8*this.o;for(De=rt.length-8;De<rt.length;++De)rt[De]=je&255,je/=256;for(this.u(rt),rt=Array(16),De=je=0;4>De;++De)for(var Ke=0;32>Ke;Ke+=8)rt[je++]=this.g[De]>>>Ke&255;return rt};function z(rt,De){var je=s;return Object.prototype.hasOwnProperty.call(je,rt)?je[rt]:je[rt]=De(rt)}function U(rt,De){this.h=De;for(var je=[],Ke=!0,We=rt.length-1;0<=We;We--){var ut=rt[We]|0;Ke&&ut==De||(je[We]=ut,Ke=!1)}this.g=je}var s={};function ee(rt){return-128<=rt&&128>rt?z(rt,function(De){return new U([De|0],0>De?-1:0)}):new U([rt|0],0>rt?-1:0)}function ne(rt){if(isNaN(rt)||!isFinite(rt))return qe;if(0>rt)return wt(ne(-rt));for(var De=[],je=1,Ke=0;rt>=je;Ke++)De[Ke]=rt/je|0,je*=4294967296;return new U(De,0)}function Ie(rt,De){if(rt.length==0)throw Error("number format error: empty string");if(De=De||10,2>De||36<De)throw Error("radix out of range: "+De);if(rt.charAt(0)=="-")return wt(Ie(rt.substring(1),De));if(0<=rt.indexOf("-"))throw Error('number format error: interior "-" character');for(var je=ne(Math.pow(De,8)),Ke=qe,We=0;We<rt.length;We+=8){var ut=Math.min(8,rt.length-We),Oe=parseInt(rt.substring(We,We+ut),De);8>ut?(ut=ne(Math.pow(De,ut)),Ke=Ke.j(ut).add(ne(Oe))):(Ke=Ke.j(je),Ke=Ke.add(ne(Oe)))}return Ke}var qe=ee(0),Xe=ee(1),St=ee(16777216);x=U.prototype,x.m=function(){if(ct(this))return-wt(this).m();for(var rt=0,De=1,je=0;je<this.g.length;je++){var Ke=this.i(je);rt+=(0<=Ke?Ke:4294967296+Ke)*De,De*=4294967296}return rt},x.toString=function(rt){if(rt=rt||10,2>rt||36<rt)throw Error("radix out of range: "+rt);if($t(this))return"0";if(ct(this))return"-"+wt(this).toString(rt);for(var De=ne(Math.pow(rt,6)),je=this,Ke="";;){var We=en(je,De).g;je=Nt(je,We.j(De));var ut=((0<je.g.length?je.g[0]:je.h)>>>0).toString(rt);if(je=We,$t(je))return ut+Ke;for(;6>ut.length;)ut="0"+ut;Ke=ut+Ke}},x.i=function(rt){return 0>rt?0:rt<this.g.length?this.g[rt]:this.h};function $t(rt){if(rt.h!=0)return!1;for(var De=0;De<rt.g.length;De++)if(rt.g[De]!=0)return!1;return!0}function ct(rt){return rt.h==-1}x.l=function(rt){return rt=Nt(this,rt),ct(rt)?-1:$t(rt)?0:1};function wt(rt){for(var De=rt.g.length,je=[],Ke=0;Ke<De;Ke++)je[Ke]=~rt.g[Ke];return new U(je,~rt.h).add(Xe)}x.abs=function(){return ct(this)?wt(this):this},x.add=function(rt){for(var De=Math.max(this.g.length,rt.g.length),je=[],Ke=0,We=0;We<=De;We++){var ut=Ke+(this.i(We)&65535)+(rt.i(We)&65535),Oe=(ut>>>16)+(this.i(We)>>>16)+(rt.i(We)>>>16);Ke=Oe>>>16,ut&=65535,Oe&=65535,je[We]=Oe<<16|ut}return new U(je,je[je.length-1]&-2147483648?-1:0)};function Nt(rt,De){return rt.add(wt(De))}x.j=function(rt){if($t(this)||$t(rt))return qe;if(ct(this))return ct(rt)?wt(this).j(wt(rt)):wt(wt(this).j(rt));if(ct(rt))return wt(this.j(wt(rt)));if(0>this.l(St)&&0>rt.l(St))return ne(this.m()*rt.m());for(var De=this.g.length+rt.g.length,je=[],Ke=0;Ke<2*De;Ke++)je[Ke]=0;for(Ke=0;Ke<this.g.length;Ke++)for(var We=0;We<rt.g.length;We++){var ut=this.i(Ke)>>>16,Oe=this.i(Ke)&65535,kn=rt.i(We)>>>16,$n=rt.i(We)&65535;je[2*Ke+2*We]+=Oe*$n,Ti(je,2*Ke+2*We),je[2*Ke+2*We+1]+=ut*$n,Ti(je,2*Ke+2*We+1),je[2*Ke+2*We+1]+=Oe*kn,Ti(je,2*Ke+2*We+1),je[2*Ke+2*We+2]+=ut*kn,Ti(je,2*Ke+2*We+2)}for(Ke=0;Ke<De;Ke++)je[Ke]=je[2*Ke+1]<<16|je[2*Ke];for(Ke=De;Ke<2*De;Ke++)je[Ke]=0;return new U(je,0)};function Ti(rt,De){for(;(rt[De]&65535)!=rt[De];)rt[De+1]+=rt[De]>>>16,rt[De]&=65535,De++}function Ei(rt,De){this.g=rt,this.h=De}function en(rt,De){if($t(De))throw Error("division by zero");if($t(rt))return new Ei(qe,qe);if(ct(rt))return De=en(wt(rt),De),new Ei(wt(De.g),wt(De.h));if(ct(De))return De=en(rt,wt(De)),new Ei(wt(De.g),De.h);if(30<rt.g.length){if(ct(rt)||ct(De))throw Error("slowDivide_ only works with positive integers.");for(var je=Xe,Ke=De;0>=Ke.l(rt);)je=Hn(je),Ke=Hn(Ke);var We=_n(je,1),ut=_n(Ke,1);for(Ke=_n(Ke,2),je=_n(je,2);!$t(Ke);){var Oe=ut.add(Ke);0>=Oe.l(rt)&&(We=We.add(je),ut=Oe),Ke=_n(Ke,1),je=_n(je,1)}return De=Nt(rt,We.j(De)),new Ei(We,De)}for(We=qe;0<=rt.l(De);){for(je=Math.max(1,Math.floor(rt.m()/De.m())),Ke=Math.ceil(Math.log(je)/Math.LN2),Ke=48>=Ke?1:Math.pow(2,Ke-48),ut=ne(je),Oe=ut.j(De);ct(Oe)||0<Oe.l(rt);)je-=Ke,ut=ne(je),Oe=ut.j(De);$t(ut)&&(ut=Xe),We=We.add(ut),rt=Nt(rt,Oe)}return new Ei(We,rt)}x.A=function(rt){return en(this,rt).h},x.and=function(rt){for(var De=Math.max(this.g.length,rt.g.length),je=[],Ke=0;Ke<De;Ke++)je[Ke]=this.i(Ke)&rt.i(Ke);return new U(je,this.h&rt.h)},x.or=function(rt){for(var De=Math.max(this.g.length,rt.g.length),je=[],Ke=0;Ke<De;Ke++)je[Ke]=this.i(Ke)|rt.i(Ke);return new U(je,this.h|rt.h)},x.xor=function(rt){for(var De=Math.max(this.g.length,rt.g.length),je=[],Ke=0;Ke<De;Ke++)je[Ke]=this.i(Ke)^rt.i(Ke);return new U(je,this.h^rt.h)};function Hn(rt){for(var De=rt.g.length+1,je=[],Ke=0;Ke<De;Ke++)je[Ke]=rt.i(Ke)<<1|rt.i(Ke-1)>>>31;return new U(je,rt.h)}function _n(rt,De){var je=De>>5;De%=32;for(var Ke=rt.g.length-je,We=[],ut=0;ut<Ke;ut++)We[ut]=0<De?rt.i(ut+je)>>>De|rt.i(ut+je+1)<<32-De:rt.i(ut+je);return new U(We,rt.h)}E.prototype.digest=E.prototype.v,E.prototype.reset=E.prototype.s,E.prototype.update=E.prototype.u,PT=E,U.prototype.add=U.prototype.add,U.prototype.multiply=U.prototype.j,U.prototype.modulo=U.prototype.A,U.prototype.compare=U.prototype.l,U.prototype.toNumber=U.prototype.m,U.prototype.toString=U.prototype.toString,U.prototype.getBits=U.prototype.i,U.fromNumber=ne,U.fromString=Ie,mp=U}).apply(typeof h2<"u"?h2:typeof self<"u"?self:typeof window<"u"?window:{});var kg=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};/** @license
Copyright The Closure Library Authors.
SPDX-License-Identifier: Apache-2.0
*/var RT,h_,MT,Gg,ov,DT,LT,kT;(function(){var x,u=typeof Object.defineProperties=="function"?Object.defineProperty:function(R,W,ie){return R==Array.prototype||R==Object.prototype||(R[W]=ie.value),R};function m(R){R=[typeof globalThis=="object"&&globalThis,R,typeof window=="object"&&window,typeof self=="object"&&self,typeof kg=="object"&&kg];for(var W=0;W<R.length;++W){var ie=R[W];if(ie&&ie.Math==Math)return ie}throw Error("Cannot find global object")}var E=m(this);function A(R,W){if(W)e:{var ie=E;R=R.split(".");for(var Se=0;Se<R.length-1;Se++){var pt=R[Se];if(!(pt in ie))break e;ie=ie[pt]}R=R[R.length-1],Se=ie[R],W=W(Se),W!=Se&&W!=null&&u(ie,R,{configurable:!0,writable:!0,value:W})}}function z(R,W){R instanceof String&&(R+="");var ie=0,Se=!1,pt={next:function(){if(!Se&&ie<R.length){var Mt=ie++;return{value:W(Mt,R[Mt]),done:!1}}return Se=!0,{done:!0,value:void 0}}};return pt[Symbol.iterator]=function(){return pt},pt}A("Array.prototype.values",function(R){return R||function(){return z(this,function(W,ie){return ie})}});/** @license

 Copyright The Closure Library Authors.
 SPDX-License-Identifier: Apache-2.0
*/var U=U||{},s=this||self;function ee(R){var W=typeof R;return W=W!="object"?W:R?Array.isArray(R)?"array":W:"null",W=="array"||W=="object"&&typeof R.length=="number"}function ne(R){var W=typeof R;return W=="object"&&R!=null||W=="function"}function Ie(R,W,ie){return R.call.apply(R.bind,arguments)}function qe(R,W,ie){if(!R)throw Error();if(2<arguments.length){var Se=Array.prototype.slice.call(arguments,2);return function(){var pt=Array.prototype.slice.call(arguments);return Array.prototype.unshift.apply(pt,Se),R.apply(W,pt)}}return function(){return R.apply(W,arguments)}}function Xe(R,W,ie){return Xe=Function.prototype.bind&&Function.prototype.bind.toString().indexOf("native code")!=-1?Ie:qe,Xe.apply(null,arguments)}function St(R,W){var ie=Array.prototype.slice.call(arguments,1);return function(){var Se=ie.slice();return Se.push.apply(Se,arguments),R.apply(this,Se)}}function $t(R,W){function ie(){}ie.prototype=W.prototype,R.aa=W.prototype,R.prototype=new ie,R.prototype.constructor=R,R.Qb=function(Se,pt,Mt){for(var vi=Array(arguments.length-2),Yn=2;Yn<arguments.length;Yn++)vi[Yn-2]=arguments[Yn];return W.prototype[pt].apply(Se,vi)}}function ct(R){const W=R.length;if(0<W){const ie=Array(W);for(let Se=0;Se<W;Se++)ie[Se]=R[Se];return ie}return[]}function wt(R,W){for(let ie=1;ie<arguments.length;ie++){const Se=arguments[ie];if(ee(Se)){const pt=R.length||0,Mt=Se.length||0;R.length=pt+Mt;for(let vi=0;vi<Mt;vi++)R[pt+vi]=Se[vi]}else R.push(Se)}}class Nt{constructor(W,ie){this.i=W,this.j=ie,this.h=0,this.g=null}get(){let W;return 0<this.h?(this.h--,W=this.g,this.g=W.next,W.next=null):W=this.i(),W}}function Ti(R){return/^[\s\xa0]*$/.test(R)}function Ei(){var R=s.navigator;return R&&(R=R.userAgent)?R:""}function en(R){return en[" "](R),R}en[" "]=function(){};var Hn=Ei().indexOf("Gecko")!=-1&&!(Ei().toLowerCase().indexOf("webkit")!=-1&&Ei().indexOf("Edge")==-1)&&!(Ei().indexOf("Trident")!=-1||Ei().indexOf("MSIE")!=-1)&&Ei().indexOf("Edge")==-1;function _n(R,W,ie){for(const Se in R)W.call(ie,R[Se],Se,R)}function rt(R,W){for(const ie in R)W.call(void 0,R[ie],ie,R)}function De(R){const W={};for(const ie in R)W[ie]=R[ie];return W}const je="constructor hasOwnProperty isPrototypeOf propertyIsEnumerable toLocaleString toString valueOf".split(" ");function Ke(R,W){let ie,Se;for(let pt=1;pt<arguments.length;pt++){Se=arguments[pt];for(ie in Se)R[ie]=Se[ie];for(let Mt=0;Mt<je.length;Mt++)ie=je[Mt],Object.prototype.hasOwnProperty.call(Se,ie)&&(R[ie]=Se[ie])}}function We(R){var W=1;R=R.split(":");const ie=[];for(;0<W&&R.length;)ie.push(R.shift()),W--;return R.length&&ie.push(R.join(":")),ie}function ut(R){s.setTimeout(()=>{throw R},0)}function Oe(){var R=Ui;let W=null;return R.g&&(W=R.g,R.g=R.g.next,R.g||(R.h=null),W.next=null),W}class kn{constructor(){this.h=this.g=null}add(W,ie){const Se=$n.get();Se.set(W,ie),this.h?this.h.next=Se:this.g=Se,this.h=Se}}var $n=new Nt(()=>new wn,R=>R.reset());class wn{constructor(){this.next=this.g=this.h=null}set(W,ie){this.h=W,this.g=ie,this.next=null}reset(){this.next=this.g=this.h=null}}let Gn,wi=!1,Ui=new kn,Ai=()=>{const R=s.Promise.resolve(void 0);Gn=()=>{R.then(Qe)}};var Qe=()=>{for(var R;R=Oe();){try{R.h.call(R.g)}catch(ie){ut(ie)}var W=$n;W.j(R),100>W.h&&(W.h++,R.next=W.g,W.g=R)}wi=!1};function Gt(){this.s=this.s,this.C=this.C}Gt.prototype.s=!1,Gt.prototype.ma=function(){this.s||(this.s=!0,this.N())},Gt.prototype.N=function(){if(this.C)for(;this.C.length;)this.C.shift()()};function ji(R,W){this.type=R,this.g=this.target=W,this.defaultPrevented=!1}ji.prototype.h=function(){this.defaultPrevented=!0};var Un=(function(){if(!s.addEventListener||!Object.defineProperty)return!1;var R=!1,W=Object.defineProperty({},"passive",{get:function(){R=!0}});try{const ie=()=>{};s.addEventListener("test",ie,W),s.removeEventListener("test",ie,W)}catch{}return R})();function zn(R,W){if(ji.call(this,R?R.type:""),this.relatedTarget=this.g=this.target=null,this.button=this.screenY=this.screenX=this.clientY=this.clientX=0,this.key="",this.metaKey=this.shiftKey=this.altKey=this.ctrlKey=!1,this.state=null,this.pointerId=0,this.pointerType="",this.i=null,R){var ie=this.type=R.type,Se=R.changedTouches&&R.changedTouches.length?R.changedTouches[0]:null;if(this.target=R.target||R.srcElement,this.g=W,W=R.relatedTarget){if(Hn){e:{try{en(W.nodeName);var pt=!0;break e}catch{}pt=!1}pt||(W=null)}}else ie=="mouseover"?W=R.fromElement:ie=="mouseout"&&(W=R.toElement);this.relatedTarget=W,Se?(this.clientX=Se.clientX!==void 0?Se.clientX:Se.pageX,this.clientY=Se.clientY!==void 0?Se.clientY:Se.pageY,this.screenX=Se.screenX||0,this.screenY=Se.screenY||0):(this.clientX=R.clientX!==void 0?R.clientX:R.pageX,this.clientY=R.clientY!==void 0?R.clientY:R.pageY,this.screenX=R.screenX||0,this.screenY=R.screenY||0),this.button=R.button,this.key=R.key||"",this.ctrlKey=R.ctrlKey,this.altKey=R.altKey,this.shiftKey=R.shiftKey,this.metaKey=R.metaKey,this.pointerId=R.pointerId||0,this.pointerType=typeof R.pointerType=="string"?R.pointerType:zi[R.pointerType]||"",this.state=R.state,this.i=R,R.defaultPrevented&&zn.aa.h.call(this)}}$t(zn,ji);var zi={2:"touch",3:"pen",4:"mouse"};zn.prototype.h=function(){zn.aa.h.call(this);var R=this.i;R.preventDefault?R.preventDefault():R.returnValue=!1};var Ji="closure_listenable_"+(1e6*Math.random()|0),on=0;function er(R,W,ie,Se,pt){this.listener=R,this.proxy=null,this.src=W,this.type=ie,this.capture=!!Se,this.ha=pt,this.key=++on,this.da=this.fa=!1}function Pn(R){R.da=!0,R.listener=null,R.proxy=null,R.src=null,R.ha=null}function ao(R){this.src=R,this.g={},this.h=0}ao.prototype.add=function(R,W,ie,Se,pt){var Mt=R.toString();R=this.g[Mt],R||(R=this.g[Mt]=[],this.h++);var vi=Yo(R,W,Se,pt);return-1<vi?(W=R[vi],ie||(W.fa=!1)):(W=new er(W,this.src,Mt,!!Se,pt),W.fa=ie,R.push(W)),W};function Bo(R,W){var ie=W.type;if(ie in R.g){var Se=R.g[ie],pt=Array.prototype.indexOf.call(Se,W,void 0),Mt;(Mt=0<=pt)&&Array.prototype.splice.call(Se,pt,1),Mt&&(Pn(W),R.g[ie].length==0&&(delete R.g[ie],R.h--))}}function Yo(R,W,ie,Se){for(var pt=0;pt<R.length;++pt){var Mt=R[pt];if(!Mt.da&&Mt.listener==W&&Mt.capture==!!ie&&Mt.ha==Se)return pt}return-1}var Bs="closure_lm_"+(1e6*Math.random()|0),Ut={};function Di(R,W,ie,Se,pt){if(Array.isArray(W)){for(var Mt=0;Mt<W.length;Mt++)Di(R,W[Mt],ie,Se,pt);return null}return ie=Fa(ie),R&&R[Ji]?R.K(W,ie,ne(Se)?!!Se.capture:!1,pt):cn(R,W,ie,!1,Se,pt)}function cn(R,W,ie,Se,pt,Mt){if(!W)throw Error("Invalid event type");var vi=ne(pt)?!!pt.capture:!!pt,Yn=vs(R);if(Yn||(R[Bs]=Yn=new ao(R)),ie=Yn.add(W,ie,Se,vi,Mt),ie.proxy)return ie;if(Se=wr(),ie.proxy=Se,Se.src=R,Se.listener=ie,R.addEventListener)Un||(pt=vi),pt===void 0&&(pt=!1),R.addEventListener(W.toString(),Se,pt);else if(R.attachEvent)R.attachEvent(Rn(W.toString()),Se);else if(R.addListener&&R.removeListener)R.addListener(Se);else throw Error("addEventListener and attachEvent are unavailable.");return ie}function wr(){function R(ie){return W.call(R.src,R.listener,ie)}const W=ar;return R}function Zn(R,W,ie,Se,pt){if(Array.isArray(W))for(var Mt=0;Mt<W.length;Mt++)Zn(R,W[Mt],ie,Se,pt);else Se=ne(Se)?!!Se.capture:!!Se,ie=Fa(ie),R&&R[Ji]?(R=R.i,W=String(W).toString(),W in R.g&&(Mt=R.g[W],ie=Yo(Mt,ie,Se,pt),-1<ie&&(Pn(Mt[ie]),Array.prototype.splice.call(Mt,ie,1),Mt.length==0&&(delete R.g[W],R.h--)))):R&&(R=vs(R))&&(W=R.g[W.toString()],R=-1,W&&(R=Yo(W,ie,Se,pt)),(ie=-1<R?W[R]:null)&&fr(ie))}function fr(R){if(typeof R!="number"&&R&&!R.da){var W=R.src;if(W&&W[Ji])Bo(W.i,R);else{var ie=R.type,Se=R.proxy;W.removeEventListener?W.removeEventListener(ie,Se,R.capture):W.detachEvent?W.detachEvent(Rn(ie),Se):W.addListener&&W.removeListener&&W.removeListener(Se),(ie=vs(W))?(Bo(ie,R),ie.h==0&&(ie.src=null,W[Bs]=null)):Pn(R)}}}function Rn(R){return R in Ut?Ut[R]:Ut[R]="on"+R}function ar(R,W){if(R.da)R=!0;else{W=new zn(W,this);var ie=R.listener,Se=R.ha||R.src;R.fa&&fr(R),R=ie.call(Se,W)}return R}function vs(R){return R=R[Bs],R instanceof ao?R:null}var Qo="__closure_events_fn_"+(1e9*Math.random()>>>0);function Fa(R){return typeof R=="function"?R:(R[Qo]||(R[Qo]=function(W){return R.handleEvent(W)}),R[Qo])}function Sr(){Gt.call(this),this.i=new ao(this),this.M=this,this.F=null}$t(Sr,Gt),Sr.prototype[Ji]=!0,Sr.prototype.removeEventListener=function(R,W,ie,Se){Zn(this,R,W,ie,Se)};function Lr(R,W){var ie,Se=R.F;if(Se)for(ie=[];Se;Se=Se.F)ie.push(Se);if(R=R.M,Se=W.type||W,typeof W=="string")W=new ji(W,R);else if(W instanceof ji)W.target=W.target||R;else{var pt=W;W=new ji(Se,R),Ke(W,pt)}if(pt=!0,ie)for(var Mt=ie.length-1;0<=Mt;Mt--){var vi=W.g=ie[Mt];pt=da(vi,Se,!0,W)&&pt}if(vi=W.g=R,pt=da(vi,Se,!0,W)&&pt,pt=da(vi,Se,!1,W)&&pt,ie)for(Mt=0;Mt<ie.length;Mt++)vi=W.g=ie[Mt],pt=da(vi,Se,!1,W)&&pt}Sr.prototype.N=function(){if(Sr.aa.N.call(this),this.i){var R=this.i,W;for(W in R.g){for(var ie=R.g[W],Se=0;Se<ie.length;Se++)Pn(ie[Se]);delete R.g[W],R.h--}}this.F=null},Sr.prototype.K=function(R,W,ie,Se){return this.i.add(String(R),W,!1,ie,Se)},Sr.prototype.L=function(R,W,ie,Se){return this.i.add(String(R),W,!0,ie,Se)};function da(R,W,ie,Se){if(W=R.i.g[String(W)],!W)return!0;W=W.concat();for(var pt=!0,Mt=0;Mt<W.length;++Mt){var vi=W[Mt];if(vi&&!vi.da&&vi.capture==ie){var Yn=vi.listener,fs=vi.ha||vi.src;vi.fa&&Bo(R.i,vi),pt=Yn.call(fs,Se)!==!1&&pt}}return pt&&!Se.defaultPrevented}function fa(R,W,ie){if(typeof R=="function")ie&&(R=Xe(R,ie));else if(R&&typeof R.handleEvent=="function")R=Xe(R.handleEvent,R);else throw Error("Invalid listener argument");return 2147483647<Number(W)?-1:s.setTimeout(R,W||0)}function pa(R){R.g=fa(()=>{R.g=null,R.i&&(R.i=!1,pa(R))},R.l);const W=R.h;R.h=null,R.m.apply(null,W)}class xs extends Gt{constructor(W,ie){super(),this.m=W,this.l=ie,this.h=null,this.i=!1,this.g=null}j(W){this.h=arguments,this.g?this.i=!0:pa(this)}N(){super.N(),this.g&&(s.clearTimeout(this.g),this.g=null,this.i=!1,this.h=null)}}function Xs(R){Gt.call(this),this.h=R,this.g={}}$t(Xs,Gt);var Oa=[];function ma(R){_n(R.g,function(W,ie){this.g.hasOwnProperty(ie)&&fr(W)},R),R.g={}}Xs.prototype.N=function(){Xs.aa.N.call(this),ma(this)},Xs.prototype.handleEvent=function(){throw Error("EventHandler.handleEvent not implemented")};var Ba=s.JSON.stringify,Na=s.JSON.parse,Rl=class{stringify(R){return s.JSON.stringify(R,void 0)}parse(R){return s.JSON.parse(R,void 0)}};function nr(){}nr.prototype.h=null;function Ml(R){return R.h||(R.h=R.i())}function Dl(){}var gs={OPEN:"a",kb:"b",Ja:"c",wb:"d"};function Jo(){ji.call(this,"d")}$t(Jo,ji);function Ac(){ji.call(this,"c")}$t(Ac,ji);var No={},gt=null;function Vo(){return gt=gt||new Sr}No.La="serverreachability";function eu(R){ji.call(this,No.La,R)}$t(eu,ji);function _a(R){const W=Vo();Lr(W,new eu(W))}No.STAT_EVENT="statevent";function vn(R,W){ji.call(this,No.STAT_EVENT,R),this.stat=W}$t(vn,ji);function ke(R){const W=Vo();Lr(W,new vn(W,R))}No.Ma="timingevent";function Q(R,W){ji.call(this,No.Ma,R),this.size=W}$t(Q,ji);function J(R,W){if(typeof R!="function")throw Error("Fn must not be null and must be a function");return s.setTimeout(function(){R()},W)}function ce(){this.g=!0}ce.prototype.xa=function(){this.g=!1};function be(R,W,ie,Se,pt,Mt){R.info(function(){if(R.g)if(Mt)for(var vi="",Yn=Mt.split("&"),fs=0;fs<Yn.length;fs++){var ui=Yn[fs].split("=");if(1<ui.length){var Vt=ui[0];ui=ui[1];var Ur=Vt.split("_");vi=2<=Ur.length&&Ur[1]=="type"?vi+(Vt+"="+ui+"&"):vi+(Vt+"=redacted&")}}else vi=null;else vi=Mt;return"XMLHTTP REQ ("+Se+") [attempt "+pt+"]: "+W+`
`+ie+`
`+vi})}function de(R,W,ie,Se,pt,Mt,vi){R.info(function(){return"XMLHTTP RESP ("+Se+") [ attempt "+pt+"]: "+W+`
`+ie+`
`+Mt+" "+vi})}function Ae(R,W,ie,Se){R.info(function(){return"XMLHTTP TEXT ("+W+"): "+Re(R,ie)+(Se?" "+Se:"")})}function $e(R,W){R.info(function(){return"TIMEOUT: "+W})}ce.prototype.info=function(){};function Re(R,W){if(!R.g)return W;if(!W)return null;try{var ie=JSON.parse(W);if(ie){for(R=0;R<ie.length;R++)if(Array.isArray(ie[R])){var Se=ie[R];if(!(2>Se.length)){var pt=Se[1];if(Array.isArray(pt)&&!(1>pt.length)){var Mt=pt[0];if(Mt!="noop"&&Mt!="stop"&&Mt!="close")for(var vi=1;vi<pt.length;vi++)pt[vi]=""}}}}return Ba(ie)}catch{return W}}var Ge={NO_ERROR:0,gb:1,tb:2,sb:3,nb:4,rb:5,ub:6,Ia:7,TIMEOUT:8,xb:9},Ct={lb:"complete",Hb:"success",Ja:"error",Ia:"abort",zb:"ready",Ab:"readystatechange",TIMEOUT:"timeout",vb:"incrementaldata",yb:"progress",ob:"downloadprogress",Pb:"uploadprogress"},lt;function ri(){}$t(ri,nr),ri.prototype.g=function(){return new XMLHttpRequest},ri.prototype.i=function(){return{}},lt=new ri;function yi(R,W,ie,Se){this.j=R,this.i=W,this.l=ie,this.R=Se||1,this.U=new Xs(this),this.I=45e3,this.H=null,this.o=!1,this.m=this.A=this.v=this.L=this.F=this.S=this.B=null,this.D=[],this.g=null,this.C=0,this.s=this.u=null,this.X=-1,this.J=!1,this.O=0,this.M=null,this.W=this.K=this.T=this.P=!1,this.h=new Ri}function Ri(){this.i=null,this.g="",this.h=!1}var Ki={},Vi={};function Yi(R,W,ie){R.L=1,R.v=lo(So(W)),R.m=ie,R.P=!0,Xn(R,null)}function Xn(R,W){R.F=Date.now(),Fn(R),R.A=So(R.v);var ie=R.A,Se=R.R;Array.isArray(Se)||(Se=[String(Se)]),tc(ie.i,"t",Se),R.C=0,ie=R.j.J,R.h=new Ri,R.g=ou(R.j,ie?W:null,!R.m),0<R.O&&(R.M=new xs(Xe(R.Y,R,R.g),R.O)),W=R.U,ie=R.g,Se=R.ca;var pt="readystatechange";Array.isArray(pt)||(pt&&(Oa[0]=pt.toString()),pt=Oa);for(var Mt=0;Mt<pt.length;Mt++){var vi=Di(ie,pt[Mt],Se||W.handleEvent,!1,W.h||W);if(!vi)break;W.g[vi.key]=vi}W=R.H?De(R.H):{},R.m?(R.u||(R.u="POST"),W["Content-Type"]="application/x-www-form-urlencoded",R.g.ea(R.A,R.u,R.m,W)):(R.u="GET",R.g.ea(R.A,R.u,null,W)),_a(),be(R.i,R.u,R.A,R.l,R.R,R.m)}yi.prototype.ca=function(R){R=R.target;const W=this.M;W&&Ao(R)==3?W.j():this.Y(R)},yi.prototype.Y=function(R){try{if(R==this.g)e:{const Ur=Ao(this.g);var W=this.g.Ba();const _i=this.g.Z();if(!(3>Ur)&&(Ur!=3||this.g&&(this.h.h||this.g.oa()||hl(this.g)))){this.J||Ur!=4||W==7||(W==8||0>=_i?_a(3):_a(2)),jn(this);var ie=this.g.Z();this.X=ie;t:if(tn(this)){var Se=hl(this.g);R="";var pt=Se.length,Mt=Ao(this.g)==4;if(!this.h.i){if(typeof TextDecoder>"u"){rr(this),dn(this);var vi="";break t}this.h.i=new s.TextDecoder}for(W=0;W<pt;W++)this.h.h=!0,R+=this.h.i.decode(Se[W],{stream:!(Mt&&W==pt-1)});Se.length=0,this.h.g+=R,this.C=0,vi=this.h.g}else vi=this.g.oa();if(this.o=ie==200,de(this.i,this.u,this.A,this.l,this.R,Ur,ie),this.o){if(this.T&&!this.K){t:{if(this.g){var Yn,fs=this.g;if((Yn=fs.g?fs.g.getResponseHeader("X-HTTP-Initial-Response"):null)&&!Ti(Yn)){var ui=Yn;break t}}ui=null}if(ie=ui)Ae(this.i,this.l,ie,"Initial handshake response via X-HTTP-Initial-Response"),this.K=!0,br(this,ie);else{this.o=!1,this.s=3,ke(12),rr(this),dn(this);break e}}if(this.P){ie=!0;let gr;for(;!this.J&&this.C<vi.length;)if(gr=Nr(this,vi),gr==Vi){Ur==4&&(this.s=4,ke(14),ie=!1),Ae(this.i,this.l,null,"[Incomplete Response]");break}else if(gr==Ki){this.s=4,ke(15),Ae(this.i,this.l,vi,"[Invalid Chunk]"),ie=!1;break}else Ae(this.i,this.l,gr,null),br(this,gr);if(tn(this)&&this.C!=0&&(this.h.g=this.h.g.slice(this.C),this.C=0),Ur!=4||vi.length!=0||this.h.h||(this.s=1,ke(16),ie=!1),this.o=this.o&&ie,!ie)Ae(this.i,this.l,vi,"[Invalid Chunked Response]"),rr(this),dn(this);else if(0<vi.length&&!this.W){this.W=!0;var Vt=this.j;Vt.g==this&&Vt.ba&&!Vt.M&&(Vt.j.info("Great, no buffering proxy detected. Bytes received: "+vi.length),su(Vt),Vt.M=!0,ke(11))}}else Ae(this.i,this.l,vi,null),br(this,vi);Ur==4&&rr(this),this.o&&!this.J&&(Ur==4?bn(this.j,this):(this.o=!1,Fn(this)))}else Js(this.g),ie==400&&0<vi.indexOf("Unknown SID")?(this.s=3,ke(12)):(this.s=0,ke(13)),rr(this),dn(this)}}}catch{}finally{}};function tn(R){return R.g?R.u=="GET"&&R.L!=2&&R.j.Ca:!1}function Nr(R,W){var ie=R.C,Se=W.indexOf(`
`,ie);return Se==-1?Vi:(ie=Number(W.substring(ie,Se)),isNaN(ie)?Ki:(Se+=1,Se+ie>W.length?Vi:(W=W.slice(Se,Se+ie),R.C=Se+ie,W)))}yi.prototype.cancel=function(){this.J=!0,rr(this)};function Fn(R){R.S=Date.now()+R.I,ns(R,R.I)}function ns(R,W){if(R.B!=null)throw Error("WatchDog timer not null");R.B=J(Xe(R.ba,R),W)}function jn(R){R.B&&(s.clearTimeout(R.B),R.B=null)}yi.prototype.ba=function(){this.B=null;const R=Date.now();0<=R-this.S?($e(this.i,this.A),this.L!=2&&(_a(),ke(17)),rr(this),this.s=2,dn(this)):ns(this,this.S-R)};function dn(R){R.j.G==0||R.J||bn(R.j,R)}function rr(R){jn(R);var W=R.M;W&&typeof W.ma=="function"&&W.ma(),R.M=null,ma(R.U),R.g&&(W=R.g,R.g=null,W.abort(),W.ma())}function br(R,W){try{var ie=R.j;if(ie.G!=0&&(ie.g==R||Ks(ie.h,R))){if(!R.K&&Ks(ie.h,R)&&ie.G==3){try{var Se=ie.Da.g.parse(W)}catch{Se=null}if(Array.isArray(Se)&&Se.length==3){var pt=Se;if(pt[0]==0){e:if(!ie.u){if(ie.g)if(ie.g.F+3e3<R.F)ni(ie),un(ie);else break e;co(ie),ke(18)}}else ie.za=pt[1],0<ie.za-ie.T&&37500>pt[2]&&ie.F&&ie.v==0&&!ie.C&&(ie.C=J(Xe(ie.Za,ie),6e3));if(1>=Ns(ie.h)&&ie.ca){try{ie.ca()}catch{}ie.ca=void 0}}else Cs(ie,11)}else if((R.K||ie.g==R)&&ni(ie),!Ti(W))for(pt=ie.Da.g.parse(W),W=0;W<pt.length;W++){let ui=pt[W];if(ie.T=ui[0],ui=ui[1],ie.G==2)if(ui[0]=="c"){ie.K=ui[1],ie.ia=ui[2];const Vt=ui[3];Vt!=null&&(ie.la=Vt,ie.j.info("VER="+ie.la));const Ur=ui[4];Ur!=null&&(ie.Aa=Ur,ie.j.info("SVER="+ie.Aa));const _i=ui[5];_i!=null&&typeof _i=="number"&&0<_i&&(Se=1.5*_i,ie.L=Se,ie.j.info("backChannelRequestTimeoutMs_="+Se)),Se=ie;const gr=R.g;if(gr){const dl=gr.g?gr.g.getResponseHeader("X-Client-Wire-Protocol"):null;if(dl){var Mt=Se.h;Mt.g||dl.indexOf("spdy")==-1&&dl.indexOf("quic")==-1&&dl.indexOf("h2")==-1||(Mt.j=Mt.l,Mt.g=new Set,Mt.h&&(ws(Mt,Mt.h),Mt.h=null))}if(Se.D){const gi=gr.g?gr.g.getResponseHeader("X-HTTP-Session-Id"):null;gi&&(Se.ya=gi,Ir(Se.I,Se.D,gi))}}ie.G=3,ie.l&&ie.l.ua(),ie.ba&&(ie.R=Date.now()-R.F,ie.j.info("Handshake RTT: "+ie.R+"ms")),Se=ie;var vi=R;if(Se.qa=On(Se,Se.J?Se.ia:null,Se.W),vi.K){ol(Se.h,vi);var Yn=vi,fs=Se.L;fs&&(Yn.I=fs),Yn.B&&(jn(Yn),Fn(Yn)),Se.g=vi}else Ta(Se);0<ie.i.length&&Go(ie)}else ui[0]!="stop"&&ui[0]!="close"||Cs(ie,7);else ie.G==3&&(ui[0]=="stop"||ui[0]=="close"?ui[0]=="stop"?Cs(ie,7):eo(ie):ui[0]!="noop"&&ie.l&&ie.l.ta(ui),ie.v=0)}}_a(4)}catch{}}var Tr=class{constructor(R,W){this.g=R,this.map=W}};function us(R){this.l=R||10,s.PerformanceNavigationTiming?(R=s.performance.getEntriesByType("navigation"),R=0<R.length&&(R[0].nextHopProtocol=="hq"||R[0].nextHopProtocol=="h2")):R=!!(s.chrome&&s.chrome.loadTimes&&s.chrome.loadTimes()&&s.chrome.loadTimes().wasFetchedViaSpdy),this.j=R?this.l:1,this.g=null,1<this.j&&(this.g=new Set),this.h=null,this.i=[]}function rs(R){return R.h?!0:R.g?R.g.size>=R.j:!1}function Ns(R){return R.h?1:R.g?R.g.size:0}function Ks(R,W){return R.h?R.h==W:R.g?R.g.has(W):!1}function ws(R,W){R.g?R.g.add(W):R.h=W}function ol(R,W){R.h&&R.h==W?R.h=null:R.g&&R.g.has(W)&&R.g.delete(W)}us.prototype.cancel=function(){if(this.i=tu(this),this.h)this.h.cancel(),this.h=null;else if(this.g&&this.g.size!==0){for(const R of this.g.values())R.cancel();this.g.clear()}};function tu(R){if(R.h!=null)return R.i.concat(R.h.D);if(R.g!=null&&R.g.size!==0){let W=R.i;for(const ie of R.g.values())W=W.concat(ie.D);return W}return ct(R.i)}function Ll(R){if(R.V&&typeof R.V=="function")return R.V();if(typeof Map<"u"&&R instanceof Map||typeof Set<"u"&&R instanceof Set)return Array.from(R.values());if(typeof R=="string")return R.split("");if(ee(R)){for(var W=[],ie=R.length,Se=0;Se<ie;Se++)W.push(R[Se]);return W}W=[],ie=0;for(Se in R)W[ie++]=R[Se];return W}function kl(R){if(R.na&&typeof R.na=="function")return R.na();if(!R.V||typeof R.V!="function"){if(typeof Map<"u"&&R instanceof Map)return Array.from(R.keys());if(!(typeof Set<"u"&&R instanceof Set)){if(ee(R)||typeof R=="string"){var W=[];R=R.length;for(var ie=0;ie<R;ie++)W.push(ie);return W}W=[],ie=0;for(const Se in R)W[ie++]=Se;return W}}}function al(R,W){if(R.forEach&&typeof R.forEach=="function")R.forEach(W,void 0);else if(ee(R)||typeof R=="string")Array.prototype.forEach.call(R,W,void 0);else for(var ie=kl(R),Se=Ll(R),pt=Se.length,Mt=0;Mt<pt;Mt++)W.call(void 0,Se[Mt],ie&&ie[Mt],R)}var zl=RegExp("^(?:([^:/?#.]+):)?(?://(?:([^\\\\/?#]*)@)?([^\\\\/?#]*?)(?::([0-9]+))?(?=[\\\\/?#]|$))?([^?#]+)?(?:\\?([^#]*))?(?:#([\\s\\S]*))?$");function Jl(R,W){if(R){R=R.split("&");for(var ie=0;ie<R.length;ie++){var Se=R[ie].indexOf("="),pt=null;if(0<=Se){var Mt=R[ie].substring(0,Se);pt=R[ie].substring(Se+1)}else Mt=R[ie];W(Mt,pt?decodeURIComponent(pt.replace(/\+/g," ")):"")}}}function ga(R){if(this.g=this.o=this.j="",this.s=null,this.m=this.l="",this.h=!1,R instanceof ga){this.h=R.h,go(this,R.j),this.o=R.o,this.g=R.g,Vs(this,R.s),this.l=R.l;var W=R.i,ie=new ys;ie.i=W.i,W.g&&(ie.g=new Map(W.g),ie.h=W.h),Ys(this,ie),this.m=R.m}else R&&(W=String(R).match(zl))?(this.h=!1,go(this,W[1]||"",!0),this.o=Kn(W[2]||""),this.g=Kn(W[3]||"",!0),Vs(this,W[4]),this.l=Kn(W[5]||"",!0),Ys(this,W[6]||"",!0),this.m=Kn(W[7]||"")):(this.h=!1,this.i=new ys(null,this.h))}ga.prototype.toString=function(){var R=[],W=this.j;W&&R.push(Va(W,Fl,!0),":");var ie=this.g;return(ie||W=="file")&&(R.push("//"),(W=this.o)&&R.push(Va(W,Fl,!0),"@"),R.push(encodeURIComponent(String(ie)).replace(/%25([0-9a-fA-F]{2})/g,"%$1")),ie=this.s,ie!=null&&R.push(":",String(ie))),(ie=this.l)&&(this.g&&ie.charAt(0)!="/"&&R.push("/"),R.push(Va(ie,ie.charAt(0)=="/"?ec:Ol,!0))),(ie=this.i.toString())&&R.push("?",ie),(ie=this.m)&&R.push("#",Va(ie,iu)),R.join("")};function So(R){return new ga(R)}function go(R,W,ie){R.j=ie?Kn(W,!0):W,R.j&&(R.j=R.j.replace(/:$/,""))}function Vs(R,W){if(W){if(W=Number(W),isNaN(W)||0>W)throw Error("Bad port number "+W);R.s=W}else R.s=null}function Ys(R,W,ie){W instanceof ys?(R.i=W,ea(R.i,R.h)):(ie||(W=Va(W,ju)),R.i=new ys(W,R.h))}function Ir(R,W,ie){R.i.set(W,ie)}function lo(R){return Ir(R,"zx",Math.floor(2147483648*Math.random()).toString(36)+Math.abs(Math.floor(2147483648*Math.random())^Date.now()).toString(36)),R}function Kn(R,W){return R?W?decodeURI(R.replace(/%25/g,"%2525")):decodeURIComponent(R):""}function Va(R,W,ie){return typeof R=="string"?(R=encodeURI(R).replace(W,ya),ie&&(R=R.replace(/%25([0-9a-fA-F]{2})/g,"%$1")),R):null}function ya(R){return R=R.charCodeAt(0),"%"+(R>>4&15).toString(16)+(R&15).toString(16)}var Fl=/[#\/\?@]/g,Ol=/[#\?:]/g,ec=/[#\?]/g,ju=/[#\?@]/g,iu=/#/g;function ys(R,W){this.h=this.g=null,this.i=R||null,this.j=!!W}function bs(R){R.g||(R.g=new Map,R.h=0,R.i&&Jl(R.i,function(W,ie){R.add(decodeURIComponent(W.replace(/\+/g," ")),ie)}))}x=ys.prototype,x.add=function(R,W){bs(this),this.i=null,R=va(this,R);var ie=this.g.get(R);return ie||this.g.set(R,ie=[]),ie.push(W),this.h+=1,this};function Uo(R,W){bs(R),W=va(R,W),R.g.has(W)&&(R.i=null,R.h-=R.g.get(W).length,R.g.delete(W))}function Io(R,W){return bs(R),W=va(R,W),R.g.has(W)}x.forEach=function(R,W){bs(this),this.g.forEach(function(ie,Se){ie.forEach(function(pt){R.call(W,pt,Se,this)},this)},this)},x.na=function(){bs(this);const R=Array.from(this.g.values()),W=Array.from(this.g.keys()),ie=[];for(let Se=0;Se<W.length;Se++){const pt=R[Se];for(let Mt=0;Mt<pt.length;Mt++)ie.push(W[Se])}return ie},x.V=function(R){bs(this);let W=[];if(typeof R=="string")Io(this,R)&&(W=W.concat(this.g.get(va(this,R))));else{R=Array.from(this.g.values());for(let ie=0;ie<R.length;ie++)W=W.concat(R[ie])}return W},x.set=function(R,W){return bs(this),this.i=null,R=va(this,R),Io(this,R)&&(this.h-=this.g.get(R).length),this.g.set(R,[W]),this.h+=1,this},x.get=function(R,W){return R?(R=this.V(R),0<R.length?String(R[0]):W):W};function tc(R,W,ie){Uo(R,W),0<ie.length&&(R.i=null,R.g.set(va(R,W),ct(ie)),R.h+=ie.length)}x.toString=function(){if(this.i)return this.i;if(!this.g)return"";const R=[],W=Array.from(this.g.keys());for(var ie=0;ie<W.length;ie++){var Se=W[ie];const Mt=encodeURIComponent(String(Se)),vi=this.V(Se);for(Se=0;Se<vi.length;Se++){var pt=Mt;vi[Se]!==""&&(pt+="="+encodeURIComponent(String(vi[Se]))),R.push(pt)}}return this.i=R.join("&")};function va(R,W){return W=String(W),R.j&&(W=W.toLowerCase()),W}function ea(R,W){W&&!R.j&&(bs(R),R.i=null,R.g.forEach(function(ie,Se){var pt=Se.toLowerCase();Se!=pt&&(Uo(this,Se),tc(this,pt,ie))},R)),R.j=W}function xn(R,W){const ie=new ce;if(s.Image){const Se=new Image;Se.onload=St(Qs,ie,"TestLoadImage: loaded",!0,W,Se),Se.onerror=St(Qs,ie,"TestLoadImage: error",!1,W,Se),Se.onabort=St(Qs,ie,"TestLoadImage: abort",!1,W,Se),Se.ontimeout=St(Qs,ie,"TestLoadImage: timeout",!1,W,Se),s.setTimeout(function(){Se.ontimeout&&Se.ontimeout()},1e4),Se.src=R}else W(!1)}function nu(R,W){const ie=new ce,Se=new AbortController,pt=setTimeout(()=>{Se.abort(),Qs(ie,"TestPingServer: timeout",!1,W)},1e4);fetch(R,{signal:Se.signal}).then(Mt=>{clearTimeout(pt),Mt.ok?Qs(ie,"TestPingServer: ok",!0,W):Qs(ie,"TestPingServer: server error",!1,W)}).catch(()=>{clearTimeout(pt),Qs(ie,"TestPingServer: error",!1,W)})}function Qs(R,W,ie,Se,pt){try{pt&&(pt.onload=null,pt.onerror=null,pt.onabort=null,pt.ontimeout=null),Se(ie)}catch{}}function ru(){this.g=new Rl}function vd(R,W,ie){const Se=ie||"";try{al(R,function(pt,Mt){let vi=pt;ne(pt)&&(vi=Ba(pt)),W.push(Se+Mt+"="+encodeURIComponent(vi))})}catch(pt){throw W.push(Se+"type="+encodeURIComponent("_badmap")),pt}}function xa(R){this.l=R.Ub||null,this.j=R.eb||!1}$t(xa,nr),xa.prototype.g=function(){return new wa(this.l,this.j)},xa.prototype.i=(function(R){return function(){return R}})({});function wa(R,W){Sr.call(this),this.D=R,this.o=W,this.m=void 0,this.status=this.readyState=0,this.responseType=this.responseText=this.response=this.statusText="",this.onreadystatechange=null,this.u=new Headers,this.h=null,this.B="GET",this.A="",this.g=!1,this.v=this.j=this.l=null}$t(wa,Sr),x=wa.prototype,x.open=function(R,W){if(this.readyState!=0)throw this.abort(),Error("Error reopening a connection");this.B=R,this.A=W,this.readyState=1,Ua(this)},x.send=function(R){if(this.readyState!=1)throw this.abort(),Error("need to call open() first. ");this.g=!0;const W={headers:this.u,method:this.B,credentials:this.m,cache:void 0};R&&(W.body=R),(this.D||s).fetch(new Request(this.A,W)).then(this.Sa.bind(this),this.ga.bind(this))},x.abort=function(){this.response=this.responseText="",this.u=new Headers,this.status=0,this.j&&this.j.cancel("Request was aborted.").catch(()=>{}),1<=this.readyState&&this.g&&this.readyState!=4&&(this.g=!1,jo(this)),this.readyState=0},x.Sa=function(R){if(this.g&&(this.l=R,this.h||(this.status=this.l.status,this.statusText=this.l.statusText,this.h=R.headers,this.readyState=2,Ua(this)),this.g&&(this.readyState=3,Ua(this),this.g)))if(this.responseType==="arraybuffer")R.arrayBuffer().then(this.Qa.bind(this),this.ga.bind(this));else if(typeof s.ReadableStream<"u"&&"body"in R){if(this.j=R.body.getReader(),this.o){if(this.responseType)throw Error('responseType must be empty for "streamBinaryChunks" mode responses.');this.response=[]}else this.response=this.responseText="",this.v=new TextDecoder;ll(this)}else R.text().then(this.Ra.bind(this),this.ga.bind(this))};function ll(R){R.j.read().then(R.Pa.bind(R)).catch(R.ga.bind(R))}x.Pa=function(R){if(this.g){if(this.o&&R.value)this.response.push(R.value);else if(!this.o){var W=R.value?R.value:new Uint8Array(0);(W=this.v.decode(W,{stream:!R.done}))&&(this.response=this.responseText+=W)}R.done?jo(this):Ua(this),this.readyState==3&&ll(this)}},x.Ra=function(R){this.g&&(this.response=this.responseText=R,jo(this))},x.Qa=function(R){this.g&&(this.response=R,jo(this))},x.ga=function(){this.g&&jo(this)};function jo(R){R.readyState=4,R.l=null,R.j=null,R.v=null,Ua(R)}x.setRequestHeader=function(R,W){this.u.append(R,W)},x.getResponseHeader=function(R){return this.h&&this.h.get(R.toLowerCase())||""},x.getAllResponseHeaders=function(){if(!this.h)return"";const R=[],W=this.h.entries();for(var ie=W.next();!ie.done;)ie=ie.value,R.push(ie[0]+": "+ie[1]),ie=W.next();return R.join(`\r
`)};function Ua(R){R.onreadystatechange&&R.onreadystatechange.call(R)}Object.defineProperty(wa.prototype,"withCredentials",{get:function(){return this.m==="include"},set:function(R){this.m=R?"include":"same-origin"}});function ja(R){let W="";return _n(R,function(ie,Se){W+=Se,W+=":",W+=ie,W+=`\r
`}),W}function ic(R,W,ie){e:{for(Se in ie){var Se=!1;break e}Se=!0}Se||(ie=ja(ie),typeof R=="string"?ie!=null&&encodeURIComponent(String(ie)):Ir(R,W,ie))}function Yr(R){Sr.call(this),this.headers=new Map,this.o=R||null,this.h=!1,this.v=this.g=null,this.D="",this.m=0,this.l="",this.j=this.B=this.u=this.A=!1,this.I=null,this.H="",this.J=!1}$t(Yr,Sr);var nc=/^https?$/i,Gu=["POST","PUT"];x=Yr.prototype,x.Ha=function(R){this.J=R},x.ea=function(R,W,ie,Se){if(this.g)throw Error("[goog.net.XhrIo] Object is active with another request="+this.D+"; newUri="+R);W=W?W.toUpperCase():"GET",this.D=R,this.l="",this.m=0,this.A=!1,this.h=!0,this.g=this.o?this.o.g():lt.g(),this.v=this.o?Ml(this.o):Ml(lt),this.g.onreadystatechange=Xe(this.Ea,this);try{this.B=!0,this.g.open(W,String(R),!0),this.B=!1}catch(Mt){cl(this,Mt);return}if(R=ie||"",ie=new Map(this.headers),Se)if(Object.getPrototypeOf(Se)===Object.prototype)for(var pt in Se)ie.set(pt,Se[pt]);else if(typeof Se.keys=="function"&&typeof Se.get=="function")for(const Mt of Se.keys())ie.set(Mt,Se.get(Mt));else throw Error("Unknown input type for opt_headers: "+String(Se));Se=Array.from(ie.keys()).find(Mt=>Mt.toLowerCase()=="content-type"),pt=s.FormData&&R instanceof s.FormData,!(0<=Array.prototype.indexOf.call(Gu,W,void 0))||Se||pt||ie.set("Content-Type","application/x-www-form-urlencoded;charset=utf-8");for(const[Mt,vi]of ie)this.g.setRequestHeader(Mt,vi);this.H&&(this.g.responseType=this.H),"withCredentials"in this.g&&this.g.withCredentials!==this.J&&(this.g.withCredentials=this.J);try{Cc(this),this.u=!0,this.g.send(R),this.u=!1}catch(Mt){cl(this,Mt)}};function cl(R,W){R.h=!1,R.g&&(R.j=!0,R.g.abort(),R.j=!1),R.l=W,R.m=5,ul(R),ds(R)}function ul(R){R.A||(R.A=!0,Lr(R,"complete"),Lr(R,"error"))}x.abort=function(R){this.g&&this.h&&(this.h=!1,this.j=!0,this.g.abort(),this.j=!1,this.m=R||7,Lr(this,"complete"),Lr(this,"abort"),ds(this))},x.N=function(){this.g&&(this.h&&(this.h=!1,this.j=!0,this.g.abort(),this.j=!1),ds(this,!0)),Yr.aa.N.call(this)},x.Ea=function(){this.s||(this.B||this.u||this.j?ba(this):this.bb())},x.bb=function(){ba(this)};function ba(R){if(R.h&&typeof U<"u"&&(!R.v[1]||Ao(R)!=4||R.Z()!=2)){if(R.u&&Ao(R)==4)fa(R.Ea,0,R);else if(Lr(R,"readystatechange"),Ao(R)==4){R.h=!1;try{const vi=R.Z();e:switch(vi){case 200:case 201:case 202:case 204:case 206:case 304:case 1223:var W=!0;break e;default:W=!1}var ie;if(!(ie=W)){var Se;if(Se=vi===0){var pt=String(R.D).match(zl)[1]||null;!pt&&s.self&&s.self.location&&(pt=s.self.location.protocol.slice(0,-1)),Se=!nc.test(pt?pt.toLowerCase():"")}ie=Se}if(ie)Lr(R,"complete"),Lr(R,"success");else{R.m=6;try{var Mt=2<Ao(R)?R.g.statusText:""}catch{Mt=""}R.l=Mt+" ["+R.Z()+"]",ul(R)}}finally{ds(R)}}}}function ds(R,W){if(R.g){Cc(R);const ie=R.g,Se=R.v[0]?()=>{}:null;R.g=null,R.v=null,W||Lr(R,"ready");try{ie.onreadystatechange=Se}catch{}}}function Cc(R){R.I&&(s.clearTimeout(R.I),R.I=null)}x.isActive=function(){return!!this.g};function Ao(R){return R.g?R.g.readyState:0}x.Z=function(){try{return 2<Ao(this)?this.g.status:-1}catch{return-1}},x.oa=function(){try{return this.g?this.g.responseText:""}catch{return""}},x.Oa=function(R){if(this.g){var W=this.g.responseText;return R&&W.indexOf(R)==0&&(W=W.substring(R.length)),Na(W)}};function hl(R){try{if(!R.g)return null;if("response"in R.g)return R.g.response;switch(R.H){case"":case"text":return R.g.responseText;case"arraybuffer":if("mozResponseArrayBuffer"in R.g)return R.g.mozResponseArrayBuffer}return null}catch{return null}}function Js(R){const W={};R=(R.g&&2<=Ao(R)&&R.g.getAllResponseHeaders()||"").split(`\r
`);for(let Se=0;Se<R.length;Se++){if(Ti(R[Se]))continue;var ie=We(R[Se]);const pt=ie[0];if(ie=ie[1],typeof ie!="string")continue;ie=ie.trim();const Mt=W[pt]||[];W[pt]=Mt,Mt.push(ie)}rt(W,function(Se){return Se.join(", ")})}x.Ba=function(){return this.m},x.Ka=function(){return typeof this.l=="string"?this.l:String(this.l)};function Ga(R,W,ie){return ie&&ie.internalChannelParams&&ie.internalChannelParams[R]||W}function Pc(R){this.Aa=0,this.i=[],this.j=new ce,this.ia=this.qa=this.I=this.W=this.g=this.ya=this.D=this.H=this.m=this.S=this.o=null,this.Ya=this.U=0,this.Va=Ga("failFast",!1,R),this.F=this.C=this.u=this.s=this.l=null,this.X=!0,this.za=this.T=-1,this.Y=this.v=this.B=0,this.Ta=Ga("baseRetryDelayMs",5e3,R),this.cb=Ga("retryDelaySeedMs",1e4,R),this.Wa=Ga("forwardChannelMaxRetries",2,R),this.wa=Ga("forwardChannelRequestTimeoutMs",2e4,R),this.pa=R&&R.xmlHttpFactory||void 0,this.Xa=R&&R.Tb||void 0,this.Ca=R&&R.useFetchStreams||!1,this.L=void 0,this.J=R&&R.supportsCrossDomainXhr||!1,this.K="",this.h=new us(R&&R.concurrentRequestLimit),this.Da=new ru,this.P=R&&R.fastHandshake||!1,this.O=R&&R.encodeInitMessageHeaders||!1,this.P&&this.O&&(this.O=!1),this.Ua=R&&R.Rb||!1,R&&R.xa&&this.j.xa(),R&&R.forceLongPolling&&(this.X=!1),this.ba=!this.P&&this.X&&R&&R.detectBufferingProxy||!1,this.ja=void 0,R&&R.longPollingTimeout&&0<R.longPollingTimeout&&(this.ja=R.longPollingTimeout),this.ca=void 0,this.R=0,this.M=!1,this.ka=this.A=null}x=Pc.prototype,x.la=8,x.G=1,x.connect=function(R,W,ie,Se){ke(0),this.W=R,this.H=W||{},ie&&Se!==void 0&&(this.H.OSID=ie,this.H.OAID=Se),this.F=this.X,this.I=On(this,null,this.W),Go(this)};function eo(R){if(Bl(R),R.G==3){var W=R.U++,ie=So(R.I);if(Ir(ie,"SID",R.K),Ir(ie,"RID",W),Ir(ie,"TYPE","terminate"),Nl(R,ie),W=new yi(R,R.j,W),W.L=2,W.v=lo(So(ie)),ie=!1,s.navigator&&s.navigator.sendBeacon)try{ie=s.navigator.sendBeacon(W.v.toString(),"")}catch{}!ie&&s.Image&&(new Image().src=W.v,ie=!0),ie||(W.g=ou(W.j,null),W.g.ea(W.v)),W.F=Date.now(),Fn(W)}qa(R)}function un(R){R.g&&(su(R),R.g.cancel(),R.g=null)}function Bl(R){un(R),R.u&&(s.clearTimeout(R.u),R.u=null),ni(R),R.h.cancel(),R.s&&(typeof R.s=="number"&&s.clearTimeout(R.s),R.s=null)}function Go(R){if(!rs(R.h)&&!R.s){R.s=!0;var W=R.Ga;Gn||Ai(),wi||(Gn(),wi=!0),Ui.add(W,R),R.B=0}}function xd(R,W){return Ns(R.h)>=R.h.j-(R.s?1:0)?!1:R.s?(R.i=W.D.concat(R.i),!0):R.G==1||R.G==2||R.B>=(R.Va?0:R.Wa)?!1:(R.s=J(Xe(R.Ga,R,W),Mn(R,R.B)),R.B++,!0)}x.Ga=function(R){if(this.s)if(this.s=null,this.G==1){if(!R){this.U=Math.floor(1e5*Math.random()),R=this.U++;const pt=new yi(this,this.j,R);let Mt=this.o;if(this.S&&(Mt?(Mt=De(Mt),Ke(Mt,this.S)):Mt=this.S),this.m!==null||this.O||(pt.H=Mt,Mt=null),this.P)e:{for(var W=0,ie=0;ie<this.i.length;ie++){t:{var Se=this.i[ie];if("__data__"in Se.map&&(Se=Se.map.__data__,typeof Se=="string")){Se=Se.length;break t}Se=void 0}if(Se===void 0)break;if(W+=Se,4096<W){W=ie;break e}if(W===4096||ie===this.i.length-1){W=ie+1;break e}}W=1e3}else W=1e3;W=Ha(this,pt,W),ie=So(this.I),Ir(ie,"RID",R),Ir(ie,"CVER",22),this.D&&Ir(ie,"X-HTTP-Session-Id",this.D),Nl(this,ie),Mt&&(this.O?W="headers="+encodeURIComponent(String(ja(Mt)))+"&"+W:this.m&&ic(ie,this.m,Mt)),ws(this.h,pt),this.Ua&&Ir(ie,"TYPE","init"),this.P?(Ir(ie,"$req",W),Ir(ie,"SID","null"),pt.T=!0,Yi(pt,ie,null)):Yi(pt,ie,W),this.G=2}}else this.G==3&&(R?di(this,R):this.i.length==0||rs(this.h)||di(this))};function di(R,W){var ie;W?ie=W.l:ie=R.U++;const Se=So(R.I);Ir(Se,"SID",R.K),Ir(Se,"RID",ie),Ir(Se,"AID",R.T),Nl(R,Se),R.m&&R.o&&ic(Se,R.m,R.o),ie=new yi(R,R.j,ie,R.B+1),R.m===null&&(ie.H=R.o),W&&(R.i=W.D.concat(R.i)),W=Ha(R,ie,1e3),ie.I=Math.round(.5*R.wa)+Math.round(.5*R.wa*Math.random()),ws(R.h,ie),Yi(ie,Se,W)}function Nl(R,W){R.H&&_n(R.H,function(ie,Se){Ir(W,Se,ie)}),R.l&&al({},function(ie,Se){Ir(W,Se,ie)})}function Ha(R,W,ie){ie=Math.min(R.i.length,ie);var Se=R.l?Xe(R.l.Na,R.l,R):null;e:{var pt=R.i;let Mt=-1;for(;;){const vi=["count="+ie];Mt==-1?0<ie?(Mt=pt[0].g,vi.push("ofs="+Mt)):Mt=0:vi.push("ofs="+Mt);let Yn=!0;for(let fs=0;fs<ie;fs++){let ui=pt[fs].g;const Vt=pt[fs].map;if(ui-=Mt,0>ui)Mt=Math.max(0,pt[fs].g-100),Yn=!1;else try{vd(Vt,vi,"req"+ui+"_")}catch{Se&&Se(Vt)}}if(Yn){Se=vi.join("&");break e}}}return R=R.i.splice(0,ie),W.D=R,Se}function Ta(R){if(!R.g&&!R.u){R.Y=1;var W=R.Fa;Gn||Ai(),wi||(Gn(),wi=!0),Ui.add(W,R),R.v=0}}function co(R){return R.g||R.u||3<=R.v?!1:(R.Y++,R.u=J(Xe(R.Fa,R),Mn(R,R.v)),R.v++,!0)}x.Fa=function(){if(this.u=null,rc(this),this.ba&&!(this.M||this.g==null||0>=this.R)){var R=2*this.R;this.j.info("BP detection timer enabled: "+R),this.A=J(Xe(this.ab,this),R)}},x.ab=function(){this.A&&(this.A=null,this.j.info("BP detection timeout reached."),this.j.info("Buffering proxy detected and switch to long-polling!"),this.F=!1,this.M=!0,ke(10),un(this),rc(this))};function su(R){R.A!=null&&(s.clearTimeout(R.A),R.A=null)}function rc(R){R.g=new yi(R,R.j,"rpc",R.Y),R.m===null&&(R.g.H=R.o),R.g.O=0;var W=So(R.qa);Ir(W,"RID","rpc"),Ir(W,"SID",R.K),Ir(W,"AID",R.T),Ir(W,"CI",R.F?"0":"1"),!R.F&&R.ja&&Ir(W,"TO",R.ja),Ir(W,"TYPE","xmlhttp"),Nl(R,W),R.m&&R.o&&ic(W,R.m,R.o),R.L&&(R.g.I=R.L);var ie=R.g;R=R.ia,ie.L=1,ie.v=lo(So(W)),ie.m=null,ie.P=!0,Xn(ie,R)}x.Za=function(){this.C!=null&&(this.C=null,un(this),co(this),ke(19))};function ni(R){R.C!=null&&(s.clearTimeout(R.C),R.C=null)}function bn(R,W){var ie=null;if(R.g==W){ni(R),su(R),R.g=null;var Se=2}else if(Ks(R.h,W))ie=W.D,ol(R.h,W),Se=1;else return;if(R.G!=0){if(W.o)if(Se==1){ie=W.m?W.m.length:0,W=Date.now()-W.F;var pt=R.B;Se=Vo(),Lr(Se,new Q(Se,ie)),Go(R)}else Ta(R);else if(pt=W.s,pt==3||pt==0&&0<W.X||!(Se==1&&xd(R,W)||Se==2&&co(R)))switch(ie&&0<ie.length&&(W=R.h,W.i=W.i.concat(ie)),pt){case 1:Cs(R,5);break;case 4:Cs(R,10);break;case 3:Cs(R,6);break;default:Cs(R,2)}}}function Mn(R,W){let ie=R.Ta+Math.floor(Math.random()*R.cb);return R.isActive()||(ie*=2),ie*W}function Cs(R,W){if(R.j.info("Error code "+W),W==2){var ie=Xe(R.fb,R),Se=R.Xa;const pt=!Se;Se=new ga(Se||"//www.google.com/images/cleardot.gif"),s.location&&s.location.protocol=="http"||go(Se,"https"),lo(Se),pt?xn(Se.toString(),ie):nu(Se.toString(),ie)}else ke(2);R.G=0,R.l&&R.l.sa(W),qa(R),Bl(R)}x.fb=function(R){R?(this.j.info("Successfully pinged google.com"),ke(2)):(this.j.info("Failed to ping google.com"),ke(1))};function qa(R){if(R.G=0,R.ka=[],R.l){const W=tu(R.h);(W.length!=0||R.i.length!=0)&&(wt(R.ka,W),wt(R.ka,R.i),R.h.i.length=0,ct(R.i),R.i.length=0),R.l.ra()}}function On(R,W,ie){var Se=ie instanceof ga?So(ie):new ga(ie);if(Se.g!="")W&&(Se.g=W+"."+Se.g),Vs(Se,Se.s);else{var pt=s.location;Se=pt.protocol,W=W?W+"."+pt.hostname:pt.hostname,pt=+pt.port;var Mt=new ga(null);Se&&go(Mt,Se),W&&(Mt.g=W),pt&&Vs(Mt,pt),ie&&(Mt.l=ie),Se=Mt}return ie=R.D,W=R.ya,ie&&W&&Ir(Se,ie,W),Ir(Se,"VER",R.la),Nl(R,Se),Se}function ou(R,W,ie){if(W&&!R.J)throw Error("Can't create secondary domain capable XhrIo object.");return W=R.Ca&&!R.pa?new Yr(new xa({eb:ie})):new Yr(R.pa),W.Ha(R.J),W}x.isActive=function(){return!!this.l&&this.l.isActive(this)};function sc(){}x=sc.prototype,x.ua=function(){},x.ta=function(){},x.sa=function(){},x.ra=function(){},x.isActive=function(){return!0},x.Na=function(){};function Vl(){}Vl.prototype.g=function(R,W){return new Vr(R,W)};function Vr(R,W){Sr.call(this),this.g=new Pc(W),this.l=R,this.h=W&&W.messageUrlParams||null,R=W&&W.messageHeaders||null,W&&W.clientProtocolHeaderRequired&&(R?R["X-Client-Protocol"]="webchannel":R={"X-Client-Protocol":"webchannel"}),this.g.o=R,R=W&&W.initMessageHeaders||null,W&&W.messageContentType&&(R?R["X-WebChannel-Content-Type"]=W.messageContentType:R={"X-WebChannel-Content-Type":W.messageContentType}),W&&W.va&&(R?R["X-WebChannel-Client-Profile"]=W.va:R={"X-WebChannel-Client-Profile":W.va}),this.g.S=R,(R=W&&W.Sb)&&!Ti(R)&&(this.g.m=R),this.v=W&&W.supportsCrossDomainXhr||!1,this.u=W&&W.sendRawJson||!1,(W=W&&W.httpSessionIdParam)&&!Ti(W)&&(this.g.D=W,R=this.h,R!==null&&W in R&&(R=this.h,W in R&&delete R[W])),this.j=new Ho(this)}$t(Vr,Sr),Vr.prototype.m=function(){this.g.l=this.j,this.v&&(this.g.J=!0),this.g.connect(this.l,this.h||void 0)},Vr.prototype.close=function(){eo(this.g)},Vr.prototype.o=function(R){var W=this.g;if(typeof R=="string"){var ie={};ie.__data__=R,R=ie}else this.u&&(ie={},ie.__data__=Ba(R),R=ie);W.i.push(new Tr(W.Ya++,R)),W.G==3&&Go(W)},Vr.prototype.N=function(){this.g.l=null,delete this.j,eo(this.g),delete this.g,Vr.aa.N.call(this)};function ss(R){Jo.call(this),R.__headers__&&(this.headers=R.__headers__,this.statusCode=R.__status__,delete R.__headers__,delete R.__status__);var W=R.__sm__;if(W){e:{for(const ie in W){R=ie;break e}R=void 0}(this.i=R)&&(R=this.i,W=W!==null&&R in W?W[R]:void 0),this.data=W}else this.data=R}$t(ss,Jo);function wd(){Ac.call(this),this.status=1}$t(wd,Ac);function Ho(R){this.g=R}$t(Ho,sc),Ho.prototype.ua=function(){Lr(this.g,"a")},Ho.prototype.ta=function(R){Lr(this.g,new ss(R))},Ho.prototype.sa=function(R){Lr(this.g,new wd)},Ho.prototype.ra=function(){Lr(this.g,"b")},Vl.prototype.createWebChannel=Vl.prototype.g,Vr.prototype.send=Vr.prototype.o,Vr.prototype.open=Vr.prototype.m,Vr.prototype.close=Vr.prototype.close,kT=function(){return new Vl},LT=function(){return Vo()},DT=No,ov={mb:0,pb:1,qb:2,Jb:3,Ob:4,Lb:5,Mb:6,Kb:7,Ib:8,Nb:9,PROXY:10,NOPROXY:11,Gb:12,Cb:13,Db:14,Bb:15,Eb:16,Fb:17,ib:18,hb:19,jb:20},Ge.NO_ERROR=0,Ge.TIMEOUT=8,Ge.HTTP_ERROR=6,Gg=Ge,Ct.COMPLETE="complete",MT=Ct,Dl.EventType=gs,gs.OPEN="a",gs.CLOSE="b",gs.ERROR="c",gs.MESSAGE="d",Sr.prototype.listen=Sr.prototype.K,h_=Dl,Yr.prototype.listenOnce=Yr.prototype.L,Yr.prototype.getLastError=Yr.prototype.Ka,Yr.prototype.getLastErrorCode=Yr.prototype.Ba,Yr.prototype.getStatus=Yr.prototype.Z,Yr.prototype.getResponseJson=Yr.prototype.Oa,Yr.prototype.getResponseText=Yr.prototype.oa,Yr.prototype.send=Yr.prototype.ea,Yr.prototype.setWithCredentials=Yr.prototype.Ha,RT=Yr}).apply(typeof kg<"u"?kg:typeof self<"u"?self:typeof window<"u"?window:{});const d2="@firebase/firestore";/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class rl{constructor(u){this.uid=u}isAuthenticated(){return this.uid!=null}toKey(){return this.isAuthenticated()?"uid:"+this.uid:"anonymous-user"}isEqual(u){return u.uid===this.uid}}rl.UNAUTHENTICATED=new rl(null),rl.GOOGLE_CREDENTIALS=new rl("google-credentials-uid"),rl.FIRST_PARTY=new rl("first-party-uid"),rl.MOCK_USER=new rl("mock-user");/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */let _m="10.14.0";/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const _p=new TT("@firebase/firestore");function c_(){return _p.logLevel}function sn(x,...u){if(_p.logLevel<=Jr.DEBUG){const m=u.map(Pv);_p.debug(`Firestore (${_m}): ${x}`,...m)}}function gd(x,...u){if(_p.logLevel<=Jr.ERROR){const m=u.map(Pv);_p.error(`Firestore (${_m}): ${x}`,...m)}}function om(x,...u){if(_p.logLevel<=Jr.WARN){const m=u.map(Pv);_p.warn(`Firestore (${_m}): ${x}`,...m)}}function Pv(x){if(typeof x=="string")return x;try{/**
* @license
* Copyright 2020 Google LLC
*
* Licensed under the Apache License, Version 2.0 (the "License");
* you may not use this file except in compliance with the License.
* You may obtain a copy of the License at
*
*   http://www.apache.org/licenses/LICENSE-2.0
*
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an "AS IS" BASIS,
* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
* See the License for the specific language governing permissions and
* limitations under the License.
*/return(function(m){return JSON.stringify(m)})(x)}catch{return x}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function ir(x="Unexpected state"){const u=`FIRESTORE (${_m}) INTERNAL ASSERTION FAILED: `+x;throw gd(u),new Error(u)}function _s(x,u){x||ir()}function dr(x,u){return x}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const pi={OK:"ok",CANCELLED:"cancelled",UNKNOWN:"unknown",INVALID_ARGUMENT:"invalid-argument",DEADLINE_EXCEEDED:"deadline-exceeded",NOT_FOUND:"not-found",ALREADY_EXISTS:"already-exists",PERMISSION_DENIED:"permission-denied",UNAUTHENTICATED:"unauthenticated",RESOURCE_EXHAUSTED:"resource-exhausted",FAILED_PRECONDITION:"failed-precondition",ABORTED:"aborted",OUT_OF_RANGE:"out-of-range",UNIMPLEMENTED:"unimplemented",INTERNAL:"internal",UNAVAILABLE:"unavailable",DATA_LOSS:"data-loss"};class yn extends mm{constructor(u,m){super(u,m),this.code=u,this.message=m,this.toString=()=>`${this.name}: [code=${this.code}]: ${this.message}`}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Sf{constructor(){this.promise=new Promise(((u,m)=>{this.resolve=u,this.reject=m}))}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class zT{constructor(u,m){this.user=m,this.type="OAuth",this.headers=new Map,this.headers.set("Authorization",`Bearer ${u}`)}}class EC{getToken(){return Promise.resolve(null)}invalidateToken(){}start(u,m){u.enqueueRetryable((()=>m(rl.UNAUTHENTICATED)))}shutdown(){}}class SC{constructor(u){this.token=u,this.changeListener=null}getToken(){return Promise.resolve(this.token)}invalidateToken(){}start(u,m){this.changeListener=m,u.enqueueRetryable((()=>m(this.token.user)))}shutdown(){this.changeListener=null}}class IC{constructor(u){this.t=u,this.currentUser=rl.UNAUTHENTICATED,this.i=0,this.forceRefresh=!1,this.auth=null}start(u,m){_s(this.o===void 0);let E=this.i;const A=ee=>this.i!==E?(E=this.i,m(ee)):Promise.resolve();let z=new Sf;this.o=()=>{this.i++,this.currentUser=this.u(),z.resolve(),z=new Sf,u.enqueueRetryable((()=>A(this.currentUser)))};const U=()=>{const ee=z;u.enqueueRetryable((async()=>{await ee.promise,await A(this.currentUser)}))},s=ee=>{sn("FirebaseAuthCredentialsProvider","Auth detected"),this.auth=ee,this.o&&(this.auth.addAuthTokenListener(this.o),U())};this.t.onInit((ee=>s(ee))),setTimeout((()=>{if(!this.auth){const ee=this.t.getImmediate({optional:!0});ee?s(ee):(sn("FirebaseAuthCredentialsProvider","Auth not yet detected"),z.resolve(),z=new Sf)}}),0),U()}getToken(){const u=this.i,m=this.forceRefresh;return this.forceRefresh=!1,this.auth?this.auth.getToken(m).then((E=>this.i!==u?(sn("FirebaseAuthCredentialsProvider","getToken aborted due to token change."),this.getToken()):E?(_s(typeof E.accessToken=="string"),new zT(E.accessToken,this.currentUser)):null)):Promise.resolve(null)}invalidateToken(){this.forceRefresh=!0}shutdown(){this.auth&&this.o&&this.auth.removeAuthTokenListener(this.o),this.o=void 0}u(){const u=this.auth&&this.auth.getUid();return _s(u===null||typeof u=="string"),new rl(u)}}class AC{constructor(u,m,E){this.l=u,this.h=m,this.P=E,this.type="FirstParty",this.user=rl.FIRST_PARTY,this.I=new Map}T(){return this.P?this.P():null}get headers(){this.I.set("X-Goog-AuthUser",this.l);const u=this.T();return u&&this.I.set("Authorization",u),this.h&&this.I.set("X-Goog-Iam-Authorization-Token",this.h),this.I}}class CC{constructor(u,m,E){this.l=u,this.h=m,this.P=E}getToken(){return Promise.resolve(new AC(this.l,this.h,this.P))}start(u,m){u.enqueueRetryable((()=>m(rl.FIRST_PARTY)))}shutdown(){}invalidateToken(){}}class PC{constructor(u){this.value=u,this.type="AppCheck",this.headers=new Map,u&&u.length>0&&this.headers.set("x-firebase-appcheck",this.value)}}class RC{constructor(u){this.A=u,this.forceRefresh=!1,this.appCheck=null,this.R=null}start(u,m){_s(this.o===void 0);const E=z=>{z.error!=null&&sn("FirebaseAppCheckTokenProvider",`Error getting App Check token; using placeholder token instead. Error: ${z.error.message}`);const U=z.token!==this.R;return this.R=z.token,sn("FirebaseAppCheckTokenProvider",`Received ${U?"new":"existing"} token.`),U?m(z.token):Promise.resolve()};this.o=z=>{u.enqueueRetryable((()=>E(z)))};const A=z=>{sn("FirebaseAppCheckTokenProvider","AppCheck detected"),this.appCheck=z,this.o&&this.appCheck.addTokenListener(this.o)};this.A.onInit((z=>A(z))),setTimeout((()=>{if(!this.appCheck){const z=this.A.getImmediate({optional:!0});z?A(z):sn("FirebaseAppCheckTokenProvider","AppCheck not yet detected")}}),0)}getToken(){const u=this.forceRefresh;return this.forceRefresh=!1,this.appCheck?this.appCheck.getToken(u).then((m=>m?(_s(typeof m.token=="string"),this.R=m.token,new PC(m.token)):null)):Promise.resolve(null)}invalidateToken(){this.forceRefresh=!0}shutdown(){this.appCheck&&this.o&&this.appCheck.removeTokenListener(this.o),this.o=void 0}}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function MC(x){const u=typeof self<"u"&&(self.crypto||self.msCrypto),m=new Uint8Array(x);if(u&&typeof u.getRandomValues=="function")u.getRandomValues(m);else for(let E=0;E<x;E++)m[E]=Math.floor(256*Math.random());return m}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class FT{static newId(){const u="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",m=Math.floor(256/u.length)*u.length;let E="";for(;E.length<20;){const A=MC(40);for(let z=0;z<A.length;++z)E.length<20&&A[z]<m&&(E+=u.charAt(A[z]%u.length))}return E}}function is(x,u){return x<u?-1:x>u?1:0}function am(x,u,m){return x.length===u.length&&x.every(((E,A)=>m(E,u[A])))}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Ko{constructor(u,m){if(this.seconds=u,this.nanoseconds=m,m<0)throw new yn(pi.INVALID_ARGUMENT,"Timestamp nanoseconds out of range: "+m);if(m>=1e9)throw new yn(pi.INVALID_ARGUMENT,"Timestamp nanoseconds out of range: "+m);if(u<-62135596800)throw new yn(pi.INVALID_ARGUMENT,"Timestamp seconds out of range: "+u);if(u>=253402300800)throw new yn(pi.INVALID_ARGUMENT,"Timestamp seconds out of range: "+u)}static now(){return Ko.fromMillis(Date.now())}static fromDate(u){return Ko.fromMillis(u.getTime())}static fromMillis(u){const m=Math.floor(u/1e3),E=Math.floor(1e6*(u-1e3*m));return new Ko(m,E)}toDate(){return new Date(this.toMillis())}toMillis(){return 1e3*this.seconds+this.nanoseconds/1e6}_compareTo(u){return this.seconds===u.seconds?is(this.nanoseconds,u.nanoseconds):is(this.seconds,u.seconds)}isEqual(u){return u.seconds===this.seconds&&u.nanoseconds===this.nanoseconds}toString(){return"Timestamp(seconds="+this.seconds+", nanoseconds="+this.nanoseconds+")"}toJSON(){return{seconds:this.seconds,nanoseconds:this.nanoseconds}}valueOf(){const u=this.seconds- -62135596800;return String(u).padStart(12,"0")+"."+String(this.nanoseconds).padStart(9,"0")}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class hr{constructor(u){this.timestamp=u}static fromTimestamp(u){return new hr(u)}static min(){return new hr(new Ko(0,0))}static max(){return new hr(new Ko(253402300799,999999999))}compareTo(u){return this.timestamp._compareTo(u.timestamp)}isEqual(u){return this.timestamp.isEqual(u.timestamp)}toMicroseconds(){return 1e6*this.timestamp.seconds+this.timestamp.nanoseconds/1e3}toString(){return"SnapshotVersion("+this.timestamp.toString()+")"}toTimestamp(){return this.timestamp}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class b_{constructor(u,m,E){m===void 0?m=0:m>u.length&&ir(),E===void 0?E=u.length-m:E>u.length-m&&ir(),this.segments=u,this.offset=m,this.len=E}get length(){return this.len}isEqual(u){return b_.comparator(this,u)===0}child(u){const m=this.segments.slice(this.offset,this.limit());return u instanceof b_?u.forEach((E=>{m.push(E)})):m.push(u),this.construct(m)}limit(){return this.offset+this.length}popFirst(u){return u=u===void 0?1:u,this.construct(this.segments,this.offset+u,this.length-u)}popLast(){return this.construct(this.segments,this.offset,this.length-1)}firstSegment(){return this.segments[this.offset]}lastSegment(){return this.get(this.length-1)}get(u){return this.segments[this.offset+u]}isEmpty(){return this.length===0}isPrefixOf(u){if(u.length<this.length)return!1;for(let m=0;m<this.length;m++)if(this.get(m)!==u.get(m))return!1;return!0}isImmediateParentOf(u){if(this.length+1!==u.length)return!1;for(let m=0;m<this.length;m++)if(this.get(m)!==u.get(m))return!1;return!0}forEach(u){for(let m=this.offset,E=this.limit();m<E;m++)u(this.segments[m])}toArray(){return this.segments.slice(this.offset,this.limit())}static comparator(u,m){const E=Math.min(u.length,m.length);for(let A=0;A<E;A++){const z=u.get(A),U=m.get(A);if(z<U)return-1;if(z>U)return 1}return u.length<m.length?-1:u.length>m.length?1:0}}class Zs extends b_{construct(u,m,E){return new Zs(u,m,E)}canonicalString(){return this.toArray().join("/")}toString(){return this.canonicalString()}toUriEncodedString(){return this.toArray().map(encodeURIComponent).join("/")}static fromString(...u){const m=[];for(const E of u){if(E.indexOf("//")>=0)throw new yn(pi.INVALID_ARGUMENT,`Invalid segment (${E}). Paths must not contain // in them.`);m.push(...E.split("/").filter((A=>A.length>0)))}return new Zs(m)}static emptyPath(){return new Zs([])}}const DC=/^[_a-zA-Z][_a-zA-Z0-9]*$/;class La extends b_{construct(u,m,E){return new La(u,m,E)}static isValidIdentifier(u){return DC.test(u)}canonicalString(){return this.toArray().map((u=>(u=u.replace(/\\/g,"\\\\").replace(/`/g,"\\`"),La.isValidIdentifier(u)||(u="`"+u+"`"),u))).join(".")}toString(){return this.canonicalString()}isKeyField(){return this.length===1&&this.get(0)==="__name__"}static keyField(){return new La(["__name__"])}static fromServerFormat(u){const m=[];let E="",A=0;const z=()=>{if(E.length===0)throw new yn(pi.INVALID_ARGUMENT,`Invalid field path (${u}). Paths must not be empty, begin with '.', end with '.', or contain '..'`);m.push(E),E=""};let U=!1;for(;A<u.length;){const s=u[A];if(s==="\\"){if(A+1===u.length)throw new yn(pi.INVALID_ARGUMENT,"Path has trailing escape character: "+u);const ee=u[A+1];if(ee!=="\\"&&ee!=="."&&ee!=="`")throw new yn(pi.INVALID_ARGUMENT,"Path has invalid escape sequence: "+u);E+=ee,A+=2}else s==="`"?(U=!U,A++):s!=="."||U?(E+=s,A++):(z(),A++)}if(z(),U)throw new yn(pi.INVALID_ARGUMENT,"Unterminated ` in path: "+u);return new La(m)}static emptyPath(){return new La([])}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Vn{constructor(u){this.path=u}static fromPath(u){return new Vn(Zs.fromString(u))}static fromName(u){return new Vn(Zs.fromString(u).popFirst(5))}static empty(){return new Vn(Zs.emptyPath())}get collectionGroup(){return this.path.popLast().lastSegment()}hasCollectionId(u){return this.path.length>=2&&this.path.get(this.path.length-2)===u}getCollectionGroup(){return this.path.get(this.path.length-2)}getCollectionPath(){return this.path.popLast()}isEqual(u){return u!==null&&Zs.comparator(this.path,u.path)===0}toString(){return this.path.toString()}static comparator(u,m){return Zs.comparator(u.path,m.path)}static isDocumentKey(u){return u.length%2==0}static fromSegments(u){return new Vn(new Zs(u.slice()))}}function LC(x,u){const m=x.toTimestamp().seconds,E=x.toTimestamp().nanoseconds+1,A=hr.fromTimestamp(E===1e9?new Ko(m+1,0):new Ko(m,E));return new Af(A,Vn.empty(),u)}function kC(x){return new Af(x.readTime,x.key,-1)}class Af{constructor(u,m,E){this.readTime=u,this.documentKey=m,this.largestBatchId=E}static min(){return new Af(hr.min(),Vn.empty(),-1)}static max(){return new Af(hr.max(),Vn.empty(),-1)}}function zC(x,u){let m=x.readTime.compareTo(u.readTime);return m!==0?m:(m=Vn.comparator(x.documentKey,u.documentKey),m!==0?m:is(x.largestBatchId,u.largestBatchId))}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const FC="The current tab is not in the required state to perform this operation. It might be necessary to refresh the browser tab.";class OC{constructor(){this.onCommittedListeners=[]}addOnCommittedListener(u){this.onCommittedListeners.push(u)}raiseOnCommittedEvent(){this.onCommittedListeners.forEach((u=>u()))}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */async function k_(x){if(x.code!==pi.FAILED_PRECONDITION||x.message!==FC)throw x;sn("LocalStore","Unexpectedly lost primary lease")}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class mi{constructor(u){this.nextCallback=null,this.catchCallback=null,this.result=void 0,this.error=void 0,this.isDone=!1,this.callbackAttached=!1,u((m=>{this.isDone=!0,this.result=m,this.nextCallback&&this.nextCallback(m)}),(m=>{this.isDone=!0,this.error=m,this.catchCallback&&this.catchCallback(m)}))}catch(u){return this.next(void 0,u)}next(u,m){return this.callbackAttached&&ir(),this.callbackAttached=!0,this.isDone?this.error?this.wrapFailure(m,this.error):this.wrapSuccess(u,this.result):new mi(((E,A)=>{this.nextCallback=z=>{this.wrapSuccess(u,z).next(E,A)},this.catchCallback=z=>{this.wrapFailure(m,z).next(E,A)}}))}toPromise(){return new Promise(((u,m)=>{this.next(u,m)}))}wrapUserFunction(u){try{const m=u();return m instanceof mi?m:mi.resolve(m)}catch(m){return mi.reject(m)}}wrapSuccess(u,m){return u?this.wrapUserFunction((()=>u(m))):mi.resolve(m)}wrapFailure(u,m){return u?this.wrapUserFunction((()=>u(m))):mi.reject(m)}static resolve(u){return new mi(((m,E)=>{m(u)}))}static reject(u){return new mi(((m,E)=>{E(u)}))}static waitFor(u){return new mi(((m,E)=>{let A=0,z=0,U=!1;u.forEach((s=>{++A,s.next((()=>{++z,U&&z===A&&m()}),(ee=>E(ee)))})),U=!0,z===A&&m()}))}static or(u){let m=mi.resolve(!1);for(const E of u)m=m.next((A=>A?mi.resolve(A):E()));return m}static forEach(u,m){const E=[];return u.forEach(((A,z)=>{E.push(m.call(this,A,z))})),this.waitFor(E)}static mapArray(u,m){return new mi(((E,A)=>{const z=u.length,U=new Array(z);let s=0;for(let ee=0;ee<z;ee++){const ne=ee;m(u[ne]).next((Ie=>{U[ne]=Ie,++s,s===z&&E(U)}),(Ie=>A(Ie)))}}))}static doWhile(u,m){return new mi(((E,A)=>{const z=()=>{u()===!0?m().next((()=>{z()}),A):E()};z()}))}}function BC(x){const u=x.match(/Android ([\d.]+)/i),m=u?u[1].split(".").slice(0,2).join("."):"-1";return Number(m)}function z_(x){return x.name==="IndexedDbTransactionError"}/**
 * @license
 * Copyright 2018 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Rv{constructor(u,m){this.previousValue=u,m&&(m.sequenceNumberHandler=E=>this.ie(E),this.se=E=>m.writeSequenceNumber(E))}ie(u){return this.previousValue=Math.max(u,this.previousValue),this.previousValue}next(){const u=++this.previousValue;return this.se&&this.se(u),u}}Rv.oe=-1;function cy(x){return x==null}function Qg(x){return x===0&&1/x==-1/0}function NC(x){return typeof x=="number"&&Number.isInteger(x)&&!Qg(x)&&x<=Number.MAX_SAFE_INTEGER&&x>=Number.MIN_SAFE_INTEGER}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function f2(x){let u=0;for(const m in x)Object.prototype.hasOwnProperty.call(x,m)&&u++;return u}function wp(x,u){for(const m in x)Object.prototype.hasOwnProperty.call(x,m)&&u(m,x[m])}function OT(x){for(const u in x)if(Object.prototype.hasOwnProperty.call(x,u))return!1;return!0}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class oo{constructor(u,m){this.comparator=u,this.root=m||Da.EMPTY}insert(u,m){return new oo(this.comparator,this.root.insert(u,m,this.comparator).copy(null,null,Da.BLACK,null,null))}remove(u){return new oo(this.comparator,this.root.remove(u,this.comparator).copy(null,null,Da.BLACK,null,null))}get(u){let m=this.root;for(;!m.isEmpty();){const E=this.comparator(u,m.key);if(E===0)return m.value;E<0?m=m.left:E>0&&(m=m.right)}return null}indexOf(u){let m=0,E=this.root;for(;!E.isEmpty();){const A=this.comparator(u,E.key);if(A===0)return m+E.left.size;A<0?E=E.left:(m+=E.left.size+1,E=E.right)}return-1}isEmpty(){return this.root.isEmpty()}get size(){return this.root.size}minKey(){return this.root.minKey()}maxKey(){return this.root.maxKey()}inorderTraversal(u){return this.root.inorderTraversal(u)}forEach(u){this.inorderTraversal(((m,E)=>(u(m,E),!1)))}toString(){const u=[];return this.inorderTraversal(((m,E)=>(u.push(`${m}:${E}`),!1))),`{${u.join(", ")}}`}reverseTraversal(u){return this.root.reverseTraversal(u)}getIterator(){return new zg(this.root,null,this.comparator,!1)}getIteratorFrom(u){return new zg(this.root,u,this.comparator,!1)}getReverseIterator(){return new zg(this.root,null,this.comparator,!0)}getReverseIteratorFrom(u){return new zg(this.root,u,this.comparator,!0)}}class zg{constructor(u,m,E,A){this.isReverse=A,this.nodeStack=[];let z=1;for(;!u.isEmpty();)if(z=m?E(u.key,m):1,m&&A&&(z*=-1),z<0)u=this.isReverse?u.left:u.right;else{if(z===0){this.nodeStack.push(u);break}this.nodeStack.push(u),u=this.isReverse?u.right:u.left}}getNext(){let u=this.nodeStack.pop();const m={key:u.key,value:u.value};if(this.isReverse)for(u=u.left;!u.isEmpty();)this.nodeStack.push(u),u=u.right;else for(u=u.right;!u.isEmpty();)this.nodeStack.push(u),u=u.left;return m}hasNext(){return this.nodeStack.length>0}peek(){if(this.nodeStack.length===0)return null;const u=this.nodeStack[this.nodeStack.length-1];return{key:u.key,value:u.value}}}class Da{constructor(u,m,E,A,z){this.key=u,this.value=m,this.color=E??Da.RED,this.left=A??Da.EMPTY,this.right=z??Da.EMPTY,this.size=this.left.size+1+this.right.size}copy(u,m,E,A,z){return new Da(u??this.key,m??this.value,E??this.color,A??this.left,z??this.right)}isEmpty(){return!1}inorderTraversal(u){return this.left.inorderTraversal(u)||u(this.key,this.value)||this.right.inorderTraversal(u)}reverseTraversal(u){return this.right.reverseTraversal(u)||u(this.key,this.value)||this.left.reverseTraversal(u)}min(){return this.left.isEmpty()?this:this.left.min()}minKey(){return this.min().key}maxKey(){return this.right.isEmpty()?this.key:this.right.maxKey()}insert(u,m,E){let A=this;const z=E(u,A.key);return A=z<0?A.copy(null,null,null,A.left.insert(u,m,E),null):z===0?A.copy(null,m,null,null,null):A.copy(null,null,null,null,A.right.insert(u,m,E)),A.fixUp()}removeMin(){if(this.left.isEmpty())return Da.EMPTY;let u=this;return u.left.isRed()||u.left.left.isRed()||(u=u.moveRedLeft()),u=u.copy(null,null,null,u.left.removeMin(),null),u.fixUp()}remove(u,m){let E,A=this;if(m(u,A.key)<0)A.left.isEmpty()||A.left.isRed()||A.left.left.isRed()||(A=A.moveRedLeft()),A=A.copy(null,null,null,A.left.remove(u,m),null);else{if(A.left.isRed()&&(A=A.rotateRight()),A.right.isEmpty()||A.right.isRed()||A.right.left.isRed()||(A=A.moveRedRight()),m(u,A.key)===0){if(A.right.isEmpty())return Da.EMPTY;E=A.right.min(),A=A.copy(E.key,E.value,null,null,A.right.removeMin())}A=A.copy(null,null,null,null,A.right.remove(u,m))}return A.fixUp()}isRed(){return this.color}fixUp(){let u=this;return u.right.isRed()&&!u.left.isRed()&&(u=u.rotateLeft()),u.left.isRed()&&u.left.left.isRed()&&(u=u.rotateRight()),u.left.isRed()&&u.right.isRed()&&(u=u.colorFlip()),u}moveRedLeft(){let u=this.colorFlip();return u.right.left.isRed()&&(u=u.copy(null,null,null,null,u.right.rotateRight()),u=u.rotateLeft(),u=u.colorFlip()),u}moveRedRight(){let u=this.colorFlip();return u.left.left.isRed()&&(u=u.rotateRight(),u=u.colorFlip()),u}rotateLeft(){const u=this.copy(null,null,Da.RED,null,this.right.left);return this.right.copy(null,null,this.color,u,null)}rotateRight(){const u=this.copy(null,null,Da.RED,this.left.right,null);return this.left.copy(null,null,this.color,null,u)}colorFlip(){const u=this.left.copy(null,null,!this.left.color,null,null),m=this.right.copy(null,null,!this.right.color,null,null);return this.copy(null,null,!this.color,u,m)}checkMaxDepth(){const u=this.check();return Math.pow(2,u)<=this.size+1}check(){if(this.isRed()&&this.left.isRed()||this.right.isRed())throw ir();const u=this.left.check();if(u!==this.right.check())throw ir();return u+(this.isRed()?0:1)}}Da.EMPTY=null,Da.RED=!0,Da.BLACK=!1;Da.EMPTY=new class{constructor(){this.size=0}get key(){throw ir()}get value(){throw ir()}get color(){throw ir()}get left(){throw ir()}get right(){throw ir()}copy(u,m,E,A,z){return this}insert(u,m,E){return new Da(u,m)}remove(u,m){return this}isEmpty(){return!0}inorderTraversal(u){return!1}reverseTraversal(u){return!1}minKey(){return null}maxKey(){return null}isRed(){return!1}checkMaxDepth(){return!0}check(){return 0}};/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class ka{constructor(u){this.comparator=u,this.data=new oo(this.comparator)}has(u){return this.data.get(u)!==null}first(){return this.data.minKey()}last(){return this.data.maxKey()}get size(){return this.data.size}indexOf(u){return this.data.indexOf(u)}forEach(u){this.data.inorderTraversal(((m,E)=>(u(m),!1)))}forEachInRange(u,m){const E=this.data.getIteratorFrom(u[0]);for(;E.hasNext();){const A=E.getNext();if(this.comparator(A.key,u[1])>=0)return;m(A.key)}}forEachWhile(u,m){let E;for(E=m!==void 0?this.data.getIteratorFrom(m):this.data.getIterator();E.hasNext();)if(!u(E.getNext().key))return}firstAfterOrEqual(u){const m=this.data.getIteratorFrom(u);return m.hasNext()?m.getNext().key:null}getIterator(){return new p2(this.data.getIterator())}getIteratorFrom(u){return new p2(this.data.getIteratorFrom(u))}add(u){return this.copy(this.data.remove(u).insert(u,!0))}delete(u){return this.has(u)?this.copy(this.data.remove(u)):this}isEmpty(){return this.data.isEmpty()}unionWith(u){let m=this;return m.size<u.size&&(m=u,u=this),u.forEach((E=>{m=m.add(E)})),m}isEqual(u){if(!(u instanceof ka)||this.size!==u.size)return!1;const m=this.data.getIterator(),E=u.data.getIterator();for(;m.hasNext();){const A=m.getNext().key,z=E.getNext().key;if(this.comparator(A,z)!==0)return!1}return!0}toArray(){const u=[];return this.forEach((m=>{u.push(m)})),u}toString(){const u=[];return this.forEach((m=>u.push(m))),"SortedSet("+u.toString()+")"}copy(u){const m=new ka(this.comparator);return m.data=u,m}}class p2{constructor(u){this.iter=u}getNext(){return this.iter.getNext().key}hasNext(){return this.iter.hasNext()}}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Sc{constructor(u){this.fields=u,u.sort(La.comparator)}static empty(){return new Sc([])}unionWith(u){let m=new ka(La.comparator);for(const E of this.fields)m=m.add(E);for(const E of u)m=m.add(E);return new Sc(m.toArray())}covers(u){for(const m of this.fields)if(m.isPrefixOf(u))return!0;return!1}isEqual(u){return am(this.fields,u.fields,((m,E)=>m.isEqual(E)))}}/**
 * @license
 * Copyright 2023 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class BT extends Error{constructor(){super(...arguments),this.name="Base64DecodeError"}}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class za{constructor(u){this.binaryString=u}static fromBase64String(u){const m=(function(A){try{return atob(A)}catch(z){throw typeof DOMException<"u"&&z instanceof DOMException?new BT("Invalid base64 string: "+z):z}})(u);return new za(m)}static fromUint8Array(u){const m=(function(A){let z="";for(let U=0;U<A.length;++U)z+=String.fromCharCode(A[U]);return z})(u);return new za(m)}[Symbol.iterator](){let u=0;return{next:()=>u<this.binaryString.length?{value:this.binaryString.charCodeAt(u++),done:!1}:{value:void 0,done:!0}}}toBase64(){return(function(m){return btoa(m)})(this.binaryString)}toUint8Array(){return(function(m){const E=new Uint8Array(m.length);for(let A=0;A<m.length;A++)E[A]=m.charCodeAt(A);return E})(this.binaryString)}approximateByteSize(){return 2*this.binaryString.length}compareTo(u){return is(this.binaryString,u.binaryString)}isEqual(u){return this.binaryString===u.binaryString}}za.EMPTY_BYTE_STRING=new za("");const VC=new RegExp(/^\d{4}-\d\d-\d\dT\d\d:\d\d:\d\d(?:\.(\d+))?Z$/);function Cf(x){if(_s(!!x),typeof x=="string"){let u=0;const m=VC.exec(x);if(_s(!!m),m[1]){let A=m[1];A=(A+"000000000").substr(0,9),u=Number(A)}const E=new Date(x);return{seconds:Math.floor(E.getTime()/1e3),nanos:u}}return{seconds:Eo(x.seconds),nanos:Eo(x.nanos)}}function Eo(x){return typeof x=="number"?x:typeof x=="string"?Number(x):0}function gp(x){return typeof x=="string"?za.fromBase64String(x):za.fromUint8Array(x)}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function Mv(x){var u,m;return((m=(((u=x?.mapValue)===null||u===void 0?void 0:u.fields)||{}).__type__)===null||m===void 0?void 0:m.stringValue)==="server_timestamp"}function Dv(x){const u=x.mapValue.fields.__previous_value__;return Mv(u)?Dv(u):u}function T_(x){const u=Cf(x.mapValue.fields.__local_write_time__.timestampValue);return new Ko(u.seconds,u.nanos)}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class UC{constructor(u,m,E,A,z,U,s,ee,ne){this.databaseId=u,this.appId=m,this.persistenceKey=E,this.host=A,this.ssl=z,this.forceLongPolling=U,this.autoDetectLongPolling=s,this.longPollingOptions=ee,this.useFetchStreams=ne}}class E_{constructor(u,m){this.projectId=u,this.database=m||"(default)"}static empty(){return new E_("","")}get isDefaultDatabase(){return this.database==="(default)"}isEqual(u){return u instanceof E_&&u.projectId===this.projectId&&u.database===this.database}}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const Fg={mapValue:{}};function yp(x){return"nullValue"in x?0:"booleanValue"in x?1:"integerValue"in x||"doubleValue"in x?2:"timestampValue"in x?3:"stringValue"in x?5:"bytesValue"in x?6:"referenceValue"in x?7:"geoPointValue"in x?8:"arrayValue"in x?9:"mapValue"in x?Mv(x)?4:GC(x)?9007199254740991:jC(x)?10:11:ir()}function Sh(x,u){if(x===u)return!0;const m=yp(x);if(m!==yp(u))return!1;switch(m){case 0:case 9007199254740991:return!0;case 1:return x.booleanValue===u.booleanValue;case 4:return T_(x).isEqual(T_(u));case 3:return(function(A,z){if(typeof A.timestampValue=="string"&&typeof z.timestampValue=="string"&&A.timestampValue.length===z.timestampValue.length)return A.timestampValue===z.timestampValue;const U=Cf(A.timestampValue),s=Cf(z.timestampValue);return U.seconds===s.seconds&&U.nanos===s.nanos})(x,u);case 5:return x.stringValue===u.stringValue;case 6:return(function(A,z){return gp(A.bytesValue).isEqual(gp(z.bytesValue))})(x,u);case 7:return x.referenceValue===u.referenceValue;case 8:return(function(A,z){return Eo(A.geoPointValue.latitude)===Eo(z.geoPointValue.latitude)&&Eo(A.geoPointValue.longitude)===Eo(z.geoPointValue.longitude)})(x,u);case 2:return(function(A,z){if("integerValue"in A&&"integerValue"in z)return Eo(A.integerValue)===Eo(z.integerValue);if("doubleValue"in A&&"doubleValue"in z){const U=Eo(A.doubleValue),s=Eo(z.doubleValue);return U===s?Qg(U)===Qg(s):isNaN(U)&&isNaN(s)}return!1})(x,u);case 9:return am(x.arrayValue.values||[],u.arrayValue.values||[],Sh);case 10:case 11:return(function(A,z){const U=A.mapValue.fields||{},s=z.mapValue.fields||{};if(f2(U)!==f2(s))return!1;for(const ee in U)if(U.hasOwnProperty(ee)&&(s[ee]===void 0||!Sh(U[ee],s[ee])))return!1;return!0})(x,u);default:return ir()}}function S_(x,u){return(x.values||[]).find((m=>Sh(m,u)))!==void 0}function lm(x,u){if(x===u)return 0;const m=yp(x),E=yp(u);if(m!==E)return is(m,E);switch(m){case 0:case 9007199254740991:return 0;case 1:return is(x.booleanValue,u.booleanValue);case 2:return(function(z,U){const s=Eo(z.integerValue||z.doubleValue),ee=Eo(U.integerValue||U.doubleValue);return s<ee?-1:s>ee?1:s===ee?0:isNaN(s)?isNaN(ee)?0:-1:1})(x,u);case 3:return m2(x.timestampValue,u.timestampValue);case 4:return m2(T_(x),T_(u));case 5:return is(x.stringValue,u.stringValue);case 6:return(function(z,U){const s=gp(z),ee=gp(U);return s.compareTo(ee)})(x.bytesValue,u.bytesValue);case 7:return(function(z,U){const s=z.split("/"),ee=U.split("/");for(let ne=0;ne<s.length&&ne<ee.length;ne++){const Ie=is(s[ne],ee[ne]);if(Ie!==0)return Ie}return is(s.length,ee.length)})(x.referenceValue,u.referenceValue);case 8:return(function(z,U){const s=is(Eo(z.latitude),Eo(U.latitude));return s!==0?s:is(Eo(z.longitude),Eo(U.longitude))})(x.geoPointValue,u.geoPointValue);case 9:return _2(x.arrayValue,u.arrayValue);case 10:return(function(z,U){var s,ee,ne,Ie;const qe=z.fields||{},Xe=U.fields||{},St=(s=qe.value)===null||s===void 0?void 0:s.arrayValue,$t=(ee=Xe.value)===null||ee===void 0?void 0:ee.arrayValue,ct=is(((ne=St?.values)===null||ne===void 0?void 0:ne.length)||0,((Ie=$t?.values)===null||Ie===void 0?void 0:Ie.length)||0);return ct!==0?ct:_2(St,$t)})(x.mapValue,u.mapValue);case 11:return(function(z,U){if(z===Fg.mapValue&&U===Fg.mapValue)return 0;if(z===Fg.mapValue)return 1;if(U===Fg.mapValue)return-1;const s=z.fields||{},ee=Object.keys(s),ne=U.fields||{},Ie=Object.keys(ne);ee.sort(),Ie.sort();for(let qe=0;qe<ee.length&&qe<Ie.length;++qe){const Xe=is(ee[qe],Ie[qe]);if(Xe!==0)return Xe;const St=lm(s[ee[qe]],ne[Ie[qe]]);if(St!==0)return St}return is(ee.length,Ie.length)})(x.mapValue,u.mapValue);default:throw ir()}}function m2(x,u){if(typeof x=="string"&&typeof u=="string"&&x.length===u.length)return is(x,u);const m=Cf(x),E=Cf(u),A=is(m.seconds,E.seconds);return A!==0?A:is(m.nanos,E.nanos)}function _2(x,u){const m=x.values||[],E=u.values||[];for(let A=0;A<m.length&&A<E.length;++A){const z=lm(m[A],E[A]);if(z)return z}return is(m.length,E.length)}function cm(x){return av(x)}function av(x){return"nullValue"in x?"null":"booleanValue"in x?""+x.booleanValue:"integerValue"in x?""+x.integerValue:"doubleValue"in x?""+x.doubleValue:"timestampValue"in x?(function(m){const E=Cf(m);return`time(${E.seconds},${E.nanos})`})(x.timestampValue):"stringValue"in x?x.stringValue:"bytesValue"in x?(function(m){return gp(m).toBase64()})(x.bytesValue):"referenceValue"in x?(function(m){return Vn.fromName(m).toString()})(x.referenceValue):"geoPointValue"in x?(function(m){return`geo(${m.latitude},${m.longitude})`})(x.geoPointValue):"arrayValue"in x?(function(m){let E="[",A=!0;for(const z of m.values||[])A?A=!1:E+=",",E+=av(z);return E+"]"})(x.arrayValue):"mapValue"in x?(function(m){const E=Object.keys(m.fields||{}).sort();let A="{",z=!0;for(const U of E)z?z=!1:A+=",",A+=`${U}:${av(m.fields[U])}`;return A+"}"})(x.mapValue):ir()}function lv(x){return!!x&&"integerValue"in x}function Lv(x){return!!x&&"arrayValue"in x}function g2(x){return!!x&&"nullValue"in x}function y2(x){return!!x&&"doubleValue"in x&&isNaN(Number(x.doubleValue))}function Hg(x){return!!x&&"mapValue"in x}function jC(x){var u,m;return((m=(((u=x?.mapValue)===null||u===void 0?void 0:u.fields)||{}).__type__)===null||m===void 0?void 0:m.stringValue)==="__vector__"}function p_(x){if(x.geoPointValue)return{geoPointValue:Object.assign({},x.geoPointValue)};if(x.timestampValue&&typeof x.timestampValue=="object")return{timestampValue:Object.assign({},x.timestampValue)};if(x.mapValue){const u={mapValue:{fields:{}}};return wp(x.mapValue.fields,((m,E)=>u.mapValue.fields[m]=p_(E))),u}if(x.arrayValue){const u={arrayValue:{values:[]}};for(let m=0;m<(x.arrayValue.values||[]).length;++m)u.arrayValue.values[m]=p_(x.arrayValue.values[m]);return u}return Object.assign({},x)}function GC(x){return(((x.mapValue||{}).fields||{}).__type__||{}).stringValue==="__max__"}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Ql{constructor(u){this.value=u}static empty(){return new Ql({mapValue:{}})}field(u){if(u.isEmpty())return this.value;{let m=this.value;for(let E=0;E<u.length-1;++E)if(m=(m.mapValue.fields||{})[u.get(E)],!Hg(m))return null;return m=(m.mapValue.fields||{})[u.lastSegment()],m||null}}set(u,m){this.getFieldsMap(u.popLast())[u.lastSegment()]=p_(m)}setAll(u){let m=La.emptyPath(),E={},A=[];u.forEach(((U,s)=>{if(!m.isImmediateParentOf(s)){const ee=this.getFieldsMap(m);this.applyChanges(ee,E,A),E={},A=[],m=s.popLast()}U?E[s.lastSegment()]=p_(U):A.push(s.lastSegment())}));const z=this.getFieldsMap(m);this.applyChanges(z,E,A)}delete(u){const m=this.field(u.popLast());Hg(m)&&m.mapValue.fields&&delete m.mapValue.fields[u.lastSegment()]}isEqual(u){return Sh(this.value,u.value)}getFieldsMap(u){let m=this.value;m.mapValue.fields||(m.mapValue={fields:{}});for(let E=0;E<u.length;++E){let A=m.mapValue.fields[u.get(E)];Hg(A)&&A.mapValue.fields||(A={mapValue:{fields:{}}},m.mapValue.fields[u.get(E)]=A),m=A}return m.mapValue.fields}applyChanges(u,m,E){wp(m,((A,z)=>u[A]=z));for(const A of E)delete u[A]}clone(){return new Ql(p_(this.value))}}function NT(x){const u=[];return wp(x.fields,((m,E)=>{const A=new La([m]);if(Hg(E)){const z=NT(E.mapValue).fields;if(z.length===0)u.push(A);else for(const U of z)u.push(A.child(U))}else u.push(A)})),new Sc(u)}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class sl{constructor(u,m,E,A,z,U,s){this.key=u,this.documentType=m,this.version=E,this.readTime=A,this.createTime=z,this.data=U,this.documentState=s}static newInvalidDocument(u){return new sl(u,0,hr.min(),hr.min(),hr.min(),Ql.empty(),0)}static newFoundDocument(u,m,E,A){return new sl(u,1,m,hr.min(),E,A,0)}static newNoDocument(u,m){return new sl(u,2,m,hr.min(),hr.min(),Ql.empty(),0)}static newUnknownDocument(u,m){return new sl(u,3,m,hr.min(),hr.min(),Ql.empty(),2)}convertToFoundDocument(u,m){return!this.createTime.isEqual(hr.min())||this.documentType!==2&&this.documentType!==0||(this.createTime=u),this.version=u,this.documentType=1,this.data=m,this.documentState=0,this}convertToNoDocument(u){return this.version=u,this.documentType=2,this.data=Ql.empty(),this.documentState=0,this}convertToUnknownDocument(u){return this.version=u,this.documentType=3,this.data=Ql.empty(),this.documentState=2,this}setHasCommittedMutations(){return this.documentState=2,this}setHasLocalMutations(){return this.documentState=1,this.version=hr.min(),this}setReadTime(u){return this.readTime=u,this}get hasLocalMutations(){return this.documentState===1}get hasCommittedMutations(){return this.documentState===2}get hasPendingWrites(){return this.hasLocalMutations||this.hasCommittedMutations}isValidDocument(){return this.documentType!==0}isFoundDocument(){return this.documentType===1}isNoDocument(){return this.documentType===2}isUnknownDocument(){return this.documentType===3}isEqual(u){return u instanceof sl&&this.key.isEqual(u.key)&&this.version.isEqual(u.version)&&this.documentType===u.documentType&&this.documentState===u.documentState&&this.data.isEqual(u.data)}mutableCopy(){return new sl(this.key,this.documentType,this.version,this.readTime,this.createTime,this.data.clone(),this.documentState)}toString(){return`Document(${this.key}, ${this.version}, ${JSON.stringify(this.data.value)}, {createTime: ${this.createTime}}), {documentType: ${this.documentType}}), {documentState: ${this.documentState}})`}}/**
 * @license
 * Copyright 2022 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Jg{constructor(u,m){this.position=u,this.inclusive=m}}function v2(x,u,m){let E=0;for(let A=0;A<x.position.length;A++){const z=u[A],U=x.position[A];if(z.field.isKeyField()?E=Vn.comparator(Vn.fromName(U.referenceValue),m.key):E=lm(U,m.data.field(z.field)),z.dir==="desc"&&(E*=-1),E!==0)break}return E}function x2(x,u){if(x===null)return u===null;if(u===null||x.inclusive!==u.inclusive||x.position.length!==u.position.length)return!1;for(let m=0;m<x.position.length;m++)if(!Sh(x.position[m],u.position[m]))return!1;return!0}/**
 * @license
 * Copyright 2022 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class ey{constructor(u,m="asc"){this.field=u,this.dir=m}}function HC(x,u){return x.dir===u.dir&&x.field.isEqual(u.field)}/**
 * @license
 * Copyright 2022 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class VT{}class Xo extends VT{constructor(u,m,E){super(),this.field=u,this.op=m,this.value=E}static create(u,m,E){return u.isKeyField()?m==="in"||m==="not-in"?this.createKeyFieldInFilter(u,m,E):new $C(u,m,E):m==="array-contains"?new XC(u,E):m==="in"?new KC(u,E):m==="not-in"?new YC(u,E):m==="array-contains-any"?new QC(u,E):new Xo(u,m,E)}static createKeyFieldInFilter(u,m,E){return m==="in"?new WC(u,E):new ZC(u,E)}matches(u){const m=u.data.field(this.field);return this.op==="!="?m!==null&&this.matchesComparison(lm(m,this.value)):m!==null&&yp(this.value)===yp(m)&&this.matchesComparison(lm(m,this.value))}matchesComparison(u){switch(this.op){case"<":return u<0;case"<=":return u<=0;case"==":return u===0;case"!=":return u!==0;case">":return u>0;case">=":return u>=0;default:return ir()}}isInequality(){return["<","<=",">",">=","!=","not-in"].indexOf(this.op)>=0}getFlattenedFilters(){return[this]}getFilters(){return[this]}}class Ih extends VT{constructor(u,m){super(),this.filters=u,this.op=m,this.ae=null}static create(u,m){return new Ih(u,m)}matches(u){return UT(this)?this.filters.find((m=>!m.matches(u)))===void 0:this.filters.find((m=>m.matches(u)))!==void 0}getFlattenedFilters(){return this.ae!==null||(this.ae=this.filters.reduce(((u,m)=>u.concat(m.getFlattenedFilters())),[])),this.ae}getFilters(){return Object.assign([],this.filters)}}function UT(x){return x.op==="and"}function jT(x){return qC(x)&&UT(x)}function qC(x){for(const u of x.filters)if(u instanceof Ih)return!1;return!0}function cv(x){if(x instanceof Xo)return x.field.canonicalString()+x.op.toString()+cm(x.value);if(jT(x))return x.filters.map((u=>cv(u))).join(",");{const u=x.filters.map((m=>cv(m))).join(",");return`${x.op}(${u})`}}function GT(x,u){return x instanceof Xo?(function(E,A){return A instanceof Xo&&E.op===A.op&&E.field.isEqual(A.field)&&Sh(E.value,A.value)})(x,u):x instanceof Ih?(function(E,A){return A instanceof Ih&&E.op===A.op&&E.filters.length===A.filters.length?E.filters.reduce(((z,U,s)=>z&&GT(U,A.filters[s])),!0):!1})(x,u):void ir()}function HT(x){return x instanceof Xo?(function(m){return`${m.field.canonicalString()} ${m.op} ${cm(m.value)}`})(x):x instanceof Ih?(function(m){return m.op.toString()+" {"+m.getFilters().map(HT).join(" ,")+"}"})(x):"Filter"}class $C extends Xo{constructor(u,m,E){super(u,m,E),this.key=Vn.fromName(E.referenceValue)}matches(u){const m=Vn.comparator(u.key,this.key);return this.matchesComparison(m)}}class WC extends Xo{constructor(u,m){super(u,"in",m),this.keys=qT("in",m)}matches(u){return this.keys.some((m=>m.isEqual(u.key)))}}class ZC extends Xo{constructor(u,m){super(u,"not-in",m),this.keys=qT("not-in",m)}matches(u){return!this.keys.some((m=>m.isEqual(u.key)))}}function qT(x,u){var m;return(((m=u.arrayValue)===null||m===void 0?void 0:m.values)||[]).map((E=>Vn.fromName(E.referenceValue)))}class XC extends Xo{constructor(u,m){super(u,"array-contains",m)}matches(u){const m=u.data.field(this.field);return Lv(m)&&S_(m.arrayValue,this.value)}}class KC extends Xo{constructor(u,m){super(u,"in",m)}matches(u){const m=u.data.field(this.field);return m!==null&&S_(this.value.arrayValue,m)}}class YC extends Xo{constructor(u,m){super(u,"not-in",m)}matches(u){if(S_(this.value.arrayValue,{nullValue:"NULL_VALUE"}))return!1;const m=u.data.field(this.field);return m!==null&&!S_(this.value.arrayValue,m)}}class QC extends Xo{constructor(u,m){super(u,"array-contains-any",m)}matches(u){const m=u.data.field(this.field);return!(!Lv(m)||!m.arrayValue.values)&&m.arrayValue.values.some((E=>S_(this.value.arrayValue,E)))}}/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class JC{constructor(u,m=null,E=[],A=[],z=null,U=null,s=null){this.path=u,this.collectionGroup=m,this.orderBy=E,this.filters=A,this.limit=z,this.startAt=U,this.endAt=s,this.ue=null}}function w2(x,u=null,m=[],E=[],A=null,z=null,U=null){return new JC(x,u,m,E,A,z,U)}function kv(x){const u=dr(x);if(u.ue===null){let m=u.path.canonicalString();u.collectionGroup!==null&&(m+="|cg:"+u.collectionGroup),m+="|f:",m+=u.filters.map((E=>cv(E))).join(","),m+="|ob:",m+=u.orderBy.map((E=>(function(z){return z.field.canonicalString()+z.dir})(E))).join(","),cy(u.limit)||(m+="|l:",m+=u.limit),u.startAt&&(m+="|lb:",m+=u.startAt.inclusive?"b:":"a:",m+=u.startAt.position.map((E=>cm(E))).join(",")),u.endAt&&(m+="|ub:",m+=u.endAt.inclusive?"a:":"b:",m+=u.endAt.position.map((E=>cm(E))).join(",")),u.ue=m}return u.ue}function zv(x,u){if(x.limit!==u.limit||x.orderBy.length!==u.orderBy.length)return!1;for(let m=0;m<x.orderBy.length;m++)if(!HC(x.orderBy[m],u.orderBy[m]))return!1;if(x.filters.length!==u.filters.length)return!1;for(let m=0;m<x.filters.length;m++)if(!GT(x.filters[m],u.filters[m]))return!1;return x.collectionGroup===u.collectionGroup&&!!x.path.isEqual(u.path)&&!!x2(x.startAt,u.startAt)&&x2(x.endAt,u.endAt)}function uv(x){return Vn.isDocumentKey(x.path)&&x.collectionGroup===null&&x.filters.length===0}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class uy{constructor(u,m=null,E=[],A=[],z=null,U="F",s=null,ee=null){this.path=u,this.collectionGroup=m,this.explicitOrderBy=E,this.filters=A,this.limit=z,this.limitType=U,this.startAt=s,this.endAt=ee,this.ce=null,this.le=null,this.he=null,this.startAt,this.endAt}}function eP(x,u,m,E,A,z,U,s){return new uy(x,u,m,E,A,z,U,s)}function $T(x){return new uy(x)}function b2(x){return x.filters.length===0&&x.limit===null&&x.startAt==null&&x.endAt==null&&(x.explicitOrderBy.length===0||x.explicitOrderBy.length===1&&x.explicitOrderBy[0].field.isKeyField())}function tP(x){return x.collectionGroup!==null}function m_(x){const u=dr(x);if(u.ce===null){u.ce=[];const m=new Set;for(const z of u.explicitOrderBy)u.ce.push(z),m.add(z.field.canonicalString());const E=u.explicitOrderBy.length>0?u.explicitOrderBy[u.explicitOrderBy.length-1].dir:"asc";(function(U){let s=new ka(La.comparator);return U.filters.forEach((ee=>{ee.getFlattenedFilters().forEach((ne=>{ne.isInequality()&&(s=s.add(ne.field))}))})),s})(u).forEach((z=>{m.has(z.canonicalString())||z.isKeyField()||u.ce.push(new ey(z,E))})),m.has(La.keyField().canonicalString())||u.ce.push(new ey(La.keyField(),E))}return u.ce}function bh(x){const u=dr(x);return u.le||(u.le=iP(u,m_(x))),u.le}function iP(x,u){if(x.limitType==="F")return w2(x.path,x.collectionGroup,u,x.filters,x.limit,x.startAt,x.endAt);{u=u.map((A=>{const z=A.dir==="desc"?"asc":"desc";return new ey(A.field,z)}));const m=x.endAt?new Jg(x.endAt.position,x.endAt.inclusive):null,E=x.startAt?new Jg(x.startAt.position,x.startAt.inclusive):null;return w2(x.path,x.collectionGroup,u,x.filters,x.limit,m,E)}}function hv(x,u,m){return new uy(x.path,x.collectionGroup,x.explicitOrderBy.slice(),x.filters.slice(),u,m,x.startAt,x.endAt)}function hy(x,u){return zv(bh(x),bh(u))&&x.limitType===u.limitType}function WT(x){return`${kv(bh(x))}|lt:${x.limitType}`}function tm(x){return`Query(target=${(function(m){let E=m.path.canonicalString();return m.collectionGroup!==null&&(E+=" collectionGroup="+m.collectionGroup),m.filters.length>0&&(E+=`, filters: [${m.filters.map((A=>HT(A))).join(", ")}]`),cy(m.limit)||(E+=", limit: "+m.limit),m.orderBy.length>0&&(E+=`, orderBy: [${m.orderBy.map((A=>(function(U){return`${U.field.canonicalString()} (${U.dir})`})(A))).join(", ")}]`),m.startAt&&(E+=", startAt: ",E+=m.startAt.inclusive?"b:":"a:",E+=m.startAt.position.map((A=>cm(A))).join(",")),m.endAt&&(E+=", endAt: ",E+=m.endAt.inclusive?"a:":"b:",E+=m.endAt.position.map((A=>cm(A))).join(",")),`Target(${E})`})(bh(x))}; limitType=${x.limitType})`}function dy(x,u){return u.isFoundDocument()&&(function(E,A){const z=A.key.path;return E.collectionGroup!==null?A.key.hasCollectionId(E.collectionGroup)&&E.path.isPrefixOf(z):Vn.isDocumentKey(E.path)?E.path.isEqual(z):E.path.isImmediateParentOf(z)})(x,u)&&(function(E,A){for(const z of m_(E))if(!z.field.isKeyField()&&A.data.field(z.field)===null)return!1;return!0})(x,u)&&(function(E,A){for(const z of E.filters)if(!z.matches(A))return!1;return!0})(x,u)&&(function(E,A){return!(E.startAt&&!(function(U,s,ee){const ne=v2(U,s,ee);return U.inclusive?ne<=0:ne<0})(E.startAt,m_(E),A)||E.endAt&&!(function(U,s,ee){const ne=v2(U,s,ee);return U.inclusive?ne>=0:ne>0})(E.endAt,m_(E),A))})(x,u)}function nP(x){return x.collectionGroup||(x.path.length%2==1?x.path.lastSegment():x.path.get(x.path.length-2))}function ZT(x){return(u,m)=>{let E=!1;for(const A of m_(x)){const z=rP(A,u,m);if(z!==0)return z;E=E||A.field.isKeyField()}return 0}}function rP(x,u,m){const E=x.field.isKeyField()?Vn.comparator(u.key,m.key):(function(z,U,s){const ee=U.data.field(z),ne=s.data.field(z);return ee!==null&&ne!==null?lm(ee,ne):ir()})(x.field,u,m);switch(x.dir){case"asc":return E;case"desc":return-1*E;default:return ir()}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class gm{constructor(u,m){this.mapKeyFn=u,this.equalsFn=m,this.inner={},this.innerSize=0}get(u){const m=this.mapKeyFn(u),E=this.inner[m];if(E!==void 0){for(const[A,z]of E)if(this.equalsFn(A,u))return z}}has(u){return this.get(u)!==void 0}set(u,m){const E=this.mapKeyFn(u),A=this.inner[E];if(A===void 0)return this.inner[E]=[[u,m]],void this.innerSize++;for(let z=0;z<A.length;z++)if(this.equalsFn(A[z][0],u))return void(A[z]=[u,m]);A.push([u,m]),this.innerSize++}delete(u){const m=this.mapKeyFn(u),E=this.inner[m];if(E===void 0)return!1;for(let A=0;A<E.length;A++)if(this.equalsFn(E[A][0],u))return E.length===1?delete this.inner[m]:E.splice(A,1),this.innerSize--,!0;return!1}forEach(u){wp(this.inner,((m,E)=>{for(const[A,z]of E)u(A,z)}))}isEmpty(){return OT(this.inner)}size(){return this.innerSize}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const sP=new oo(Vn.comparator);function yd(){return sP}const XT=new oo(Vn.comparator);function d_(...x){let u=XT;for(const m of x)u=u.insert(m.key,m);return u}function KT(x){let u=XT;return x.forEach(((m,E)=>u=u.insert(m,E.overlayedDocument))),u}function pp(){return __()}function YT(){return __()}function __(){return new gm((x=>x.toString()),((x,u)=>x.isEqual(u)))}const oP=new oo(Vn.comparator),aP=new ka(Vn.comparator);function Br(...x){let u=aP;for(const m of x)u=u.add(m);return u}const lP=new ka(is);function cP(){return lP}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function Fv(x,u){if(x.useProto3Json){if(isNaN(u))return{doubleValue:"NaN"};if(u===1/0)return{doubleValue:"Infinity"};if(u===-1/0)return{doubleValue:"-Infinity"}}return{doubleValue:Qg(u)?"-0":u}}function QT(x){return{integerValue:""+x}}function uP(x,u){return NC(u)?QT(u):Fv(x,u)}/**
 * @license
 * Copyright 2018 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class fy{constructor(){this._=void 0}}function hP(x,u,m){return x instanceof I_?(function(A,z){const U={fields:{__type__:{stringValue:"server_timestamp"},__local_write_time__:{timestampValue:{seconds:A.seconds,nanos:A.nanoseconds}}}};return z&&Mv(z)&&(z=Dv(z)),z&&(U.fields.__previous_value__=z),{mapValue:U}})(m,u):x instanceof A_?e3(x,u):x instanceof C_?t3(x,u):(function(A,z){const U=JT(A,z),s=T2(U)+T2(A.Pe);return lv(U)&&lv(A.Pe)?QT(s):Fv(A.serializer,s)})(x,u)}function dP(x,u,m){return x instanceof A_?e3(x,u):x instanceof C_?t3(x,u):m}function JT(x,u){return x instanceof ty?(function(E){return lv(E)||(function(z){return!!z&&"doubleValue"in z})(E)})(u)?u:{integerValue:0}:null}class I_ extends fy{}class A_ extends fy{constructor(u){super(),this.elements=u}}function e3(x,u){const m=i3(u);for(const E of x.elements)m.some((A=>Sh(A,E)))||m.push(E);return{arrayValue:{values:m}}}class C_ extends fy{constructor(u){super(),this.elements=u}}function t3(x,u){let m=i3(u);for(const E of x.elements)m=m.filter((A=>!Sh(A,E)));return{arrayValue:{values:m}}}class ty extends fy{constructor(u,m){super(),this.serializer=u,this.Pe=m}}function T2(x){return Eo(x.integerValue||x.doubleValue)}function i3(x){return Lv(x)&&x.arrayValue.values?x.arrayValue.values.slice():[]}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class fP{constructor(u,m){this.field=u,this.transform=m}}function pP(x,u){return x.field.isEqual(u.field)&&(function(E,A){return E instanceof A_&&A instanceof A_||E instanceof C_&&A instanceof C_?am(E.elements,A.elements,Sh):E instanceof ty&&A instanceof ty?Sh(E.Pe,A.Pe):E instanceof I_&&A instanceof I_})(x.transform,u.transform)}class mP{constructor(u,m){this.version=u,this.transformResults=m}}class Ic{constructor(u,m){this.updateTime=u,this.exists=m}static none(){return new Ic}static exists(u){return new Ic(void 0,u)}static updateTime(u){return new Ic(u)}get isNone(){return this.updateTime===void 0&&this.exists===void 0}isEqual(u){return this.exists===u.exists&&(this.updateTime?!!u.updateTime&&this.updateTime.isEqual(u.updateTime):!u.updateTime)}}function qg(x,u){return x.updateTime!==void 0?u.isFoundDocument()&&u.version.isEqual(x.updateTime):x.exists===void 0||x.exists===u.isFoundDocument()}class py{}function n3(x,u){if(!x.hasLocalMutations||u&&u.fields.length===0)return null;if(u===null)return x.isNoDocument()?new Ov(x.key,Ic.none()):new F_(x.key,x.data,Ic.none());{const m=x.data,E=Ql.empty();let A=new ka(La.comparator);for(let z of u.fields)if(!A.has(z)){let U=m.field(z);U===null&&z.length>1&&(z=z.popLast(),U=m.field(z)),U===null?E.delete(z):E.set(z,U),A=A.add(z)}return new Rf(x.key,E,new Sc(A.toArray()),Ic.none())}}function _P(x,u,m){x instanceof F_?(function(A,z,U){const s=A.value.clone(),ee=S2(A.fieldTransforms,z,U.transformResults);s.setAll(ee),z.convertToFoundDocument(U.version,s).setHasCommittedMutations()})(x,u,m):x instanceof Rf?(function(A,z,U){if(!qg(A.precondition,z))return void z.convertToUnknownDocument(U.version);const s=S2(A.fieldTransforms,z,U.transformResults),ee=z.data;ee.setAll(r3(A)),ee.setAll(s),z.convertToFoundDocument(U.version,ee).setHasCommittedMutations()})(x,u,m):(function(A,z,U){z.convertToNoDocument(U.version).setHasCommittedMutations()})(0,u,m)}function g_(x,u,m,E){return x instanceof F_?(function(z,U,s,ee){if(!qg(z.precondition,U))return s;const ne=z.value.clone(),Ie=I2(z.fieldTransforms,ee,U);return ne.setAll(Ie),U.convertToFoundDocument(U.version,ne).setHasLocalMutations(),null})(x,u,m,E):x instanceof Rf?(function(z,U,s,ee){if(!qg(z.precondition,U))return s;const ne=I2(z.fieldTransforms,ee,U),Ie=U.data;return Ie.setAll(r3(z)),Ie.setAll(ne),U.convertToFoundDocument(U.version,Ie).setHasLocalMutations(),s===null?null:s.unionWith(z.fieldMask.fields).unionWith(z.fieldTransforms.map((qe=>qe.field)))})(x,u,m,E):(function(z,U,s){return qg(z.precondition,U)?(U.convertToNoDocument(U.version).setHasLocalMutations(),null):s})(x,u,m)}function gP(x,u){let m=null;for(const E of x.fieldTransforms){const A=u.data.field(E.field),z=JT(E.transform,A||null);z!=null&&(m===null&&(m=Ql.empty()),m.set(E.field,z))}return m||null}function E2(x,u){return x.type===u.type&&!!x.key.isEqual(u.key)&&!!x.precondition.isEqual(u.precondition)&&!!(function(E,A){return E===void 0&&A===void 0||!(!E||!A)&&am(E,A,((z,U)=>pP(z,U)))})(x.fieldTransforms,u.fieldTransforms)&&(x.type===0?x.value.isEqual(u.value):x.type!==1||x.data.isEqual(u.data)&&x.fieldMask.isEqual(u.fieldMask))}class F_ extends py{constructor(u,m,E,A=[]){super(),this.key=u,this.value=m,this.precondition=E,this.fieldTransforms=A,this.type=0}getFieldMask(){return null}}class Rf extends py{constructor(u,m,E,A,z=[]){super(),this.key=u,this.data=m,this.fieldMask=E,this.precondition=A,this.fieldTransforms=z,this.type=1}getFieldMask(){return this.fieldMask}}function r3(x){const u=new Map;return x.fieldMask.fields.forEach((m=>{if(!m.isEmpty()){const E=x.data.field(m);u.set(m,E)}})),u}function S2(x,u,m){const E=new Map;_s(x.length===m.length);for(let A=0;A<m.length;A++){const z=x[A],U=z.transform,s=u.data.field(z.field);E.set(z.field,dP(U,s,m[A]))}return E}function I2(x,u,m){const E=new Map;for(const A of x){const z=A.transform,U=m.data.field(A.field);E.set(A.field,hP(z,U,u))}return E}class Ov extends py{constructor(u,m){super(),this.key=u,this.precondition=m,this.type=2,this.fieldTransforms=[]}getFieldMask(){return null}}class yP extends py{constructor(u,m){super(),this.key=u,this.precondition=m,this.type=3,this.fieldTransforms=[]}getFieldMask(){return null}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class vP{constructor(u,m,E,A){this.batchId=u,this.localWriteTime=m,this.baseMutations=E,this.mutations=A}applyToRemoteDocument(u,m){const E=m.mutationResults;for(let A=0;A<this.mutations.length;A++){const z=this.mutations[A];z.key.isEqual(u.key)&&_P(z,u,E[A])}}applyToLocalView(u,m){for(const E of this.baseMutations)E.key.isEqual(u.key)&&(m=g_(E,u,m,this.localWriteTime));for(const E of this.mutations)E.key.isEqual(u.key)&&(m=g_(E,u,m,this.localWriteTime));return m}applyToLocalDocumentSet(u,m){const E=YT();return this.mutations.forEach((A=>{const z=u.get(A.key),U=z.overlayedDocument;let s=this.applyToLocalView(U,z.mutatedFields);s=m.has(A.key)?null:s;const ee=n3(U,s);ee!==null&&E.set(A.key,ee),U.isValidDocument()||U.convertToNoDocument(hr.min())})),E}keys(){return this.mutations.reduce(((u,m)=>u.add(m.key)),Br())}isEqual(u){return this.batchId===u.batchId&&am(this.mutations,u.mutations,((m,E)=>E2(m,E)))&&am(this.baseMutations,u.baseMutations,((m,E)=>E2(m,E)))}}class Bv{constructor(u,m,E,A){this.batch=u,this.commitVersion=m,this.mutationResults=E,this.docVersions=A}static from(u,m,E){_s(u.mutations.length===E.length);let A=(function(){return oP})();const z=u.mutations;for(let U=0;U<z.length;U++)A=A.insert(z[U].key,E[U].version);return new Bv(u,m,E,A)}}/**
 * @license
 * Copyright 2022 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class xP{constructor(u,m){this.largestBatchId=u,this.mutation=m}getKey(){return this.mutation.key}isEqual(u){return u!==null&&this.mutation===u.mutation}toString(){return`Overlay{
      largestBatchId: ${this.largestBatchId},
      mutation: ${this.mutation.toString()}
    }`}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class wP{constructor(u,m){this.count=u,this.unchangedNames=m}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */var Oo,Kr;function bP(x){switch(x){default:return ir();case pi.CANCELLED:case pi.UNKNOWN:case pi.DEADLINE_EXCEEDED:case pi.RESOURCE_EXHAUSTED:case pi.INTERNAL:case pi.UNAVAILABLE:case pi.UNAUTHENTICATED:return!1;case pi.INVALID_ARGUMENT:case pi.NOT_FOUND:case pi.ALREADY_EXISTS:case pi.PERMISSION_DENIED:case pi.FAILED_PRECONDITION:case pi.ABORTED:case pi.OUT_OF_RANGE:case pi.UNIMPLEMENTED:case pi.DATA_LOSS:return!0}}function s3(x){if(x===void 0)return gd("GRPC error has no .code"),pi.UNKNOWN;switch(x){case Oo.OK:return pi.OK;case Oo.CANCELLED:return pi.CANCELLED;case Oo.UNKNOWN:return pi.UNKNOWN;case Oo.DEADLINE_EXCEEDED:return pi.DEADLINE_EXCEEDED;case Oo.RESOURCE_EXHAUSTED:return pi.RESOURCE_EXHAUSTED;case Oo.INTERNAL:return pi.INTERNAL;case Oo.UNAVAILABLE:return pi.UNAVAILABLE;case Oo.UNAUTHENTICATED:return pi.UNAUTHENTICATED;case Oo.INVALID_ARGUMENT:return pi.INVALID_ARGUMENT;case Oo.NOT_FOUND:return pi.NOT_FOUND;case Oo.ALREADY_EXISTS:return pi.ALREADY_EXISTS;case Oo.PERMISSION_DENIED:return pi.PERMISSION_DENIED;case Oo.FAILED_PRECONDITION:return pi.FAILED_PRECONDITION;case Oo.ABORTED:return pi.ABORTED;case Oo.OUT_OF_RANGE:return pi.OUT_OF_RANGE;case Oo.UNIMPLEMENTED:return pi.UNIMPLEMENTED;case Oo.DATA_LOSS:return pi.DATA_LOSS;default:return ir()}}(Kr=Oo||(Oo={}))[Kr.OK=0]="OK",Kr[Kr.CANCELLED=1]="CANCELLED",Kr[Kr.UNKNOWN=2]="UNKNOWN",Kr[Kr.INVALID_ARGUMENT=3]="INVALID_ARGUMENT",Kr[Kr.DEADLINE_EXCEEDED=4]="DEADLINE_EXCEEDED",Kr[Kr.NOT_FOUND=5]="NOT_FOUND",Kr[Kr.ALREADY_EXISTS=6]="ALREADY_EXISTS",Kr[Kr.PERMISSION_DENIED=7]="PERMISSION_DENIED",Kr[Kr.UNAUTHENTICATED=16]="UNAUTHENTICATED",Kr[Kr.RESOURCE_EXHAUSTED=8]="RESOURCE_EXHAUSTED",Kr[Kr.FAILED_PRECONDITION=9]="FAILED_PRECONDITION",Kr[Kr.ABORTED=10]="ABORTED",Kr[Kr.OUT_OF_RANGE=11]="OUT_OF_RANGE",Kr[Kr.UNIMPLEMENTED=12]="UNIMPLEMENTED",Kr[Kr.INTERNAL=13]="INTERNAL",Kr[Kr.UNAVAILABLE=14]="UNAVAILABLE",Kr[Kr.DATA_LOSS=15]="DATA_LOSS";/**
 * @license
 * Copyright 2023 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function TP(){return new TextEncoder}/**
 * @license
 * Copyright 2022 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const EP=new mp([4294967295,4294967295],0);function A2(x){const u=TP().encode(x),m=new PT;return m.update(u),new Uint8Array(m.digest())}function C2(x){const u=new DataView(x.buffer),m=u.getUint32(0,!0),E=u.getUint32(4,!0),A=u.getUint32(8,!0),z=u.getUint32(12,!0);return[new mp([m,E],0),new mp([A,z],0)]}class Nv{constructor(u,m,E){if(this.bitmap=u,this.padding=m,this.hashCount=E,m<0||m>=8)throw new f_(`Invalid padding: ${m}`);if(E<0)throw new f_(`Invalid hash count: ${E}`);if(u.length>0&&this.hashCount===0)throw new f_(`Invalid hash count: ${E}`);if(u.length===0&&m!==0)throw new f_(`Invalid padding when bitmap length is 0: ${m}`);this.Ie=8*u.length-m,this.Te=mp.fromNumber(this.Ie)}Ee(u,m,E){let A=u.add(m.multiply(mp.fromNumber(E)));return A.compare(EP)===1&&(A=new mp([A.getBits(0),A.getBits(1)],0)),A.modulo(this.Te).toNumber()}de(u){return(this.bitmap[Math.floor(u/8)]&1<<u%8)!=0}mightContain(u){if(this.Ie===0)return!1;const m=A2(u),[E,A]=C2(m);for(let z=0;z<this.hashCount;z++){const U=this.Ee(E,A,z);if(!this.de(U))return!1}return!0}static create(u,m,E){const A=u%8==0?0:8-u%8,z=new Uint8Array(Math.ceil(u/8)),U=new Nv(z,A,m);return E.forEach((s=>U.insert(s))),U}insert(u){if(this.Ie===0)return;const m=A2(u),[E,A]=C2(m);for(let z=0;z<this.hashCount;z++){const U=this.Ee(E,A,z);this.Ae(U)}}Ae(u){const m=Math.floor(u/8),E=u%8;this.bitmap[m]|=1<<E}}class f_ extends Error{constructor(){super(...arguments),this.name="BloomFilterError"}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class my{constructor(u,m,E,A,z){this.snapshotVersion=u,this.targetChanges=m,this.targetMismatches=E,this.documentUpdates=A,this.resolvedLimboDocuments=z}static createSynthesizedRemoteEventForCurrentChange(u,m,E){const A=new Map;return A.set(u,O_.createSynthesizedTargetChangeForCurrentChange(u,m,E)),new my(hr.min(),A,new oo(is),yd(),Br())}}class O_{constructor(u,m,E,A,z){this.resumeToken=u,this.current=m,this.addedDocuments=E,this.modifiedDocuments=A,this.removedDocuments=z}static createSynthesizedTargetChangeForCurrentChange(u,m,E){return new O_(E,m,Br(),Br(),Br())}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class $g{constructor(u,m,E,A){this.Re=u,this.removedTargetIds=m,this.key=E,this.Ve=A}}class o3{constructor(u,m){this.targetId=u,this.me=m}}class a3{constructor(u,m,E=za.EMPTY_BYTE_STRING,A=null){this.state=u,this.targetIds=m,this.resumeToken=E,this.cause=A}}class P2{constructor(){this.fe=0,this.ge=M2(),this.pe=za.EMPTY_BYTE_STRING,this.ye=!1,this.we=!0}get current(){return this.ye}get resumeToken(){return this.pe}get Se(){return this.fe!==0}get be(){return this.we}De(u){u.approximateByteSize()>0&&(this.we=!0,this.pe=u)}ve(){let u=Br(),m=Br(),E=Br();return this.ge.forEach(((A,z)=>{switch(z){case 0:u=u.add(A);break;case 2:m=m.add(A);break;case 1:E=E.add(A);break;default:ir()}})),new O_(this.pe,this.ye,u,m,E)}Ce(){this.we=!1,this.ge=M2()}Fe(u,m){this.we=!0,this.ge=this.ge.insert(u,m)}Me(u){this.we=!0,this.ge=this.ge.remove(u)}xe(){this.fe+=1}Oe(){this.fe-=1,_s(this.fe>=0)}Ne(){this.we=!0,this.ye=!0}}class SP{constructor(u){this.Le=u,this.Be=new Map,this.ke=yd(),this.qe=R2(),this.Qe=new oo(is)}Ke(u){for(const m of u.Re)u.Ve&&u.Ve.isFoundDocument()?this.$e(m,u.Ve):this.Ue(m,u.key,u.Ve);for(const m of u.removedTargetIds)this.Ue(m,u.key,u.Ve)}We(u){this.forEachTarget(u,(m=>{const E=this.Ge(m);switch(u.state){case 0:this.ze(m)&&E.De(u.resumeToken);break;case 1:E.Oe(),E.Se||E.Ce(),E.De(u.resumeToken);break;case 2:E.Oe(),E.Se||this.removeTarget(m);break;case 3:this.ze(m)&&(E.Ne(),E.De(u.resumeToken));break;case 4:this.ze(m)&&(this.je(m),E.De(u.resumeToken));break;default:ir()}}))}forEachTarget(u,m){u.targetIds.length>0?u.targetIds.forEach(m):this.Be.forEach(((E,A)=>{this.ze(A)&&m(A)}))}He(u){const m=u.targetId,E=u.me.count,A=this.Je(m);if(A){const z=A.target;if(uv(z))if(E===0){const U=new Vn(z.path);this.Ue(m,U,sl.newNoDocument(U,hr.min()))}else _s(E===1);else{const U=this.Ye(m);if(U!==E){const s=this.Ze(u),ee=s?this.Xe(s,u,U):1;if(ee!==0){this.je(m);const ne=ee===2?"TargetPurposeExistenceFilterMismatchBloom":"TargetPurposeExistenceFilterMismatch";this.Qe=this.Qe.insert(m,ne)}}}}}Ze(u){const m=u.me.unchangedNames;if(!m||!m.bits)return null;const{bits:{bitmap:E="",padding:A=0},hashCount:z=0}=m;let U,s;try{U=gp(E).toUint8Array()}catch(ee){if(ee instanceof BT)return om("Decoding the base64 bloom filter in existence filter failed ("+ee.message+"); ignoring the bloom filter and falling back to full re-query."),null;throw ee}try{s=new Nv(U,A,z)}catch(ee){return om(ee instanceof f_?"BloomFilter error: ":"Applying bloom filter failed: ",ee),null}return s.Ie===0?null:s}Xe(u,m,E){return m.me.count===E-this.nt(u,m.targetId)?0:2}nt(u,m){const E=this.Le.getRemoteKeysForTarget(m);let A=0;return E.forEach((z=>{const U=this.Le.tt(),s=`projects/${U.projectId}/databases/${U.database}/documents/${z.path.canonicalString()}`;u.mightContain(s)||(this.Ue(m,z,null),A++)})),A}rt(u){const m=new Map;this.Be.forEach(((z,U)=>{const s=this.Je(U);if(s){if(z.current&&uv(s.target)){const ee=new Vn(s.target.path);this.ke.get(ee)!==null||this.it(U,ee)||this.Ue(U,ee,sl.newNoDocument(ee,u))}z.be&&(m.set(U,z.ve()),z.Ce())}}));let E=Br();this.qe.forEach(((z,U)=>{let s=!0;U.forEachWhile((ee=>{const ne=this.Je(ee);return!ne||ne.purpose==="TargetPurposeLimboResolution"||(s=!1,!1)})),s&&(E=E.add(z))})),this.ke.forEach(((z,U)=>U.setReadTime(u)));const A=new my(u,m,this.Qe,this.ke,E);return this.ke=yd(),this.qe=R2(),this.Qe=new oo(is),A}$e(u,m){if(!this.ze(u))return;const E=this.it(u,m.key)?2:0;this.Ge(u).Fe(m.key,E),this.ke=this.ke.insert(m.key,m),this.qe=this.qe.insert(m.key,this.st(m.key).add(u))}Ue(u,m,E){if(!this.ze(u))return;const A=this.Ge(u);this.it(u,m)?A.Fe(m,1):A.Me(m),this.qe=this.qe.insert(m,this.st(m).delete(u)),E&&(this.ke=this.ke.insert(m,E))}removeTarget(u){this.Be.delete(u)}Ye(u){const m=this.Ge(u).ve();return this.Le.getRemoteKeysForTarget(u).size+m.addedDocuments.size-m.removedDocuments.size}xe(u){this.Ge(u).xe()}Ge(u){let m=this.Be.get(u);return m||(m=new P2,this.Be.set(u,m)),m}st(u){let m=this.qe.get(u);return m||(m=new ka(is),this.qe=this.qe.insert(u,m)),m}ze(u){const m=this.Je(u)!==null;return m||sn("WatchChangeAggregator","Detected inactive target",u),m}Je(u){const m=this.Be.get(u);return m&&m.Se?null:this.Le.ot(u)}je(u){this.Be.set(u,new P2),this.Le.getRemoteKeysForTarget(u).forEach((m=>{this.Ue(u,m,null)}))}it(u,m){return this.Le.getRemoteKeysForTarget(u).has(m)}}function R2(){return new oo(Vn.comparator)}function M2(){return new oo(Vn.comparator)}const IP={asc:"ASCENDING",desc:"DESCENDING"},AP={"<":"LESS_THAN","<=":"LESS_THAN_OR_EQUAL",">":"GREATER_THAN",">=":"GREATER_THAN_OR_EQUAL","==":"EQUAL","!=":"NOT_EQUAL","array-contains":"ARRAY_CONTAINS",in:"IN","not-in":"NOT_IN","array-contains-any":"ARRAY_CONTAINS_ANY"},CP={and:"AND",or:"OR"};class PP{constructor(u,m){this.databaseId=u,this.useProto3Json=m}}function dv(x,u){return x.useProto3Json||cy(u)?u:{value:u}}function iy(x,u){return x.useProto3Json?`${new Date(1e3*u.seconds).toISOString().replace(/\.\d*/,"").replace("Z","")}.${("000000000"+u.nanoseconds).slice(-9)}Z`:{seconds:""+u.seconds,nanos:u.nanoseconds}}function l3(x,u){return x.useProto3Json?u.toBase64():u.toUint8Array()}function RP(x,u){return iy(x,u.toTimestamp())}function Th(x){return _s(!!x),hr.fromTimestamp((function(m){const E=Cf(m);return new Ko(E.seconds,E.nanos)})(x))}function Vv(x,u){return fv(x,u).canonicalString()}function fv(x,u){const m=(function(A){return new Zs(["projects",A.projectId,"databases",A.database])})(x).child("documents");return u===void 0?m:m.child(u)}function c3(x){const u=Zs.fromString(x);return _s(p3(u)),u}function pv(x,u){return Vv(x.databaseId,u.path)}function $0(x,u){const m=c3(u);if(m.get(1)!==x.databaseId.projectId)throw new yn(pi.INVALID_ARGUMENT,"Tried to deserialize key from different project: "+m.get(1)+" vs "+x.databaseId.projectId);if(m.get(3)!==x.databaseId.database)throw new yn(pi.INVALID_ARGUMENT,"Tried to deserialize key from different database: "+m.get(3)+" vs "+x.databaseId.database);return new Vn(h3(m))}function u3(x,u){return Vv(x.databaseId,u)}function MP(x){const u=c3(x);return u.length===4?Zs.emptyPath():h3(u)}function mv(x){return new Zs(["projects",x.databaseId.projectId,"databases",x.databaseId.database]).canonicalString()}function h3(x){return _s(x.length>4&&x.get(4)==="documents"),x.popFirst(5)}function D2(x,u,m){return{name:pv(x,u),fields:m.value.mapValue.fields}}function DP(x,u){let m;if("targetChange"in u){u.targetChange;const E=(function(ne){return ne==="NO_CHANGE"?0:ne==="ADD"?1:ne==="REMOVE"?2:ne==="CURRENT"?3:ne==="RESET"?4:ir()})(u.targetChange.targetChangeType||"NO_CHANGE"),A=u.targetChange.targetIds||[],z=(function(ne,Ie){return ne.useProto3Json?(_s(Ie===void 0||typeof Ie=="string"),za.fromBase64String(Ie||"")):(_s(Ie===void 0||Ie instanceof Buffer||Ie instanceof Uint8Array),za.fromUint8Array(Ie||new Uint8Array))})(x,u.targetChange.resumeToken),U=u.targetChange.cause,s=U&&(function(ne){const Ie=ne.code===void 0?pi.UNKNOWN:s3(ne.code);return new yn(Ie,ne.message||"")})(U);m=new a3(E,A,z,s||null)}else if("documentChange"in u){u.documentChange;const E=u.documentChange;E.document,E.document.name,E.document.updateTime;const A=$0(x,E.document.name),z=Th(E.document.updateTime),U=E.document.createTime?Th(E.document.createTime):hr.min(),s=new Ql({mapValue:{fields:E.document.fields}}),ee=sl.newFoundDocument(A,z,U,s),ne=E.targetIds||[],Ie=E.removedTargetIds||[];m=new $g(ne,Ie,ee.key,ee)}else if("documentDelete"in u){u.documentDelete;const E=u.documentDelete;E.document;const A=$0(x,E.document),z=E.readTime?Th(E.readTime):hr.min(),U=sl.newNoDocument(A,z),s=E.removedTargetIds||[];m=new $g([],s,U.key,U)}else if("documentRemove"in u){u.documentRemove;const E=u.documentRemove;E.document;const A=$0(x,E.document),z=E.removedTargetIds||[];m=new $g([],z,A,null)}else{if(!("filter"in u))return ir();{u.filter;const E=u.filter;E.targetId;const{count:A=0,unchangedNames:z}=E,U=new wP(A,z),s=E.targetId;m=new o3(s,U)}}return m}function LP(x,u){let m;if(u instanceof F_)m={update:D2(x,u.key,u.value)};else if(u instanceof Ov)m={delete:pv(x,u.key)};else if(u instanceof Rf)m={update:D2(x,u.key,u.data),updateMask:jP(u.fieldMask)};else{if(!(u instanceof yP))return ir();m={verify:pv(x,u.key)}}return u.fieldTransforms.length>0&&(m.updateTransforms=u.fieldTransforms.map((E=>(function(z,U){const s=U.transform;if(s instanceof I_)return{fieldPath:U.field.canonicalString(),setToServerValue:"REQUEST_TIME"};if(s instanceof A_)return{fieldPath:U.field.canonicalString(),appendMissingElements:{values:s.elements}};if(s instanceof C_)return{fieldPath:U.field.canonicalString(),removeAllFromArray:{values:s.elements}};if(s instanceof ty)return{fieldPath:U.field.canonicalString(),increment:s.Pe};throw ir()})(0,E)))),u.precondition.isNone||(m.currentDocument=(function(A,z){return z.updateTime!==void 0?{updateTime:RP(A,z.updateTime)}:z.exists!==void 0?{exists:z.exists}:ir()})(x,u.precondition)),m}function kP(x,u){return x&&x.length>0?(_s(u!==void 0),x.map((m=>(function(A,z){let U=A.updateTime?Th(A.updateTime):Th(z);return U.isEqual(hr.min())&&(U=Th(z)),new mP(U,A.transformResults||[])})(m,u)))):[]}function zP(x,u){return{documents:[u3(x,u.path)]}}function FP(x,u){const m={structuredQuery:{}},E=u.path;let A;u.collectionGroup!==null?(A=E,m.structuredQuery.from=[{collectionId:u.collectionGroup,allDescendants:!0}]):(A=E.popLast(),m.structuredQuery.from=[{collectionId:E.lastSegment()}]),m.parent=u3(x,A);const z=(function(ne){if(ne.length!==0)return f3(Ih.create(ne,"and"))})(u.filters);z&&(m.structuredQuery.where=z);const U=(function(ne){if(ne.length!==0)return ne.map((Ie=>(function(Xe){return{field:im(Xe.field),direction:NP(Xe.dir)}})(Ie)))})(u.orderBy);U&&(m.structuredQuery.orderBy=U);const s=dv(x,u.limit);return s!==null&&(m.structuredQuery.limit=s),u.startAt&&(m.structuredQuery.startAt=(function(ne){return{before:ne.inclusive,values:ne.position}})(u.startAt)),u.endAt&&(m.structuredQuery.endAt=(function(ne){return{before:!ne.inclusive,values:ne.position}})(u.endAt)),{_t:m,parent:A}}function OP(x){let u=MP(x.parent);const m=x.structuredQuery,E=m.from?m.from.length:0;let A=null;if(E>0){_s(E===1);const Ie=m.from[0];Ie.allDescendants?A=Ie.collectionId:u=u.child(Ie.collectionId)}let z=[];m.where&&(z=(function(qe){const Xe=d3(qe);return Xe instanceof Ih&&jT(Xe)?Xe.getFilters():[Xe]})(m.where));let U=[];m.orderBy&&(U=(function(qe){return qe.map((Xe=>(function($t){return new ey(nm($t.field),(function(wt){switch(wt){case"ASCENDING":return"asc";case"DESCENDING":return"desc";default:return}})($t.direction))})(Xe)))})(m.orderBy));let s=null;m.limit&&(s=(function(qe){let Xe;return Xe=typeof qe=="object"?qe.value:qe,cy(Xe)?null:Xe})(m.limit));let ee=null;m.startAt&&(ee=(function(qe){const Xe=!!qe.before,St=qe.values||[];return new Jg(St,Xe)})(m.startAt));let ne=null;return m.endAt&&(ne=(function(qe){const Xe=!qe.before,St=qe.values||[];return new Jg(St,Xe)})(m.endAt)),eP(u,A,U,z,s,"F",ee,ne)}function BP(x,u){const m=(function(A){switch(A){case"TargetPurposeListen":return null;case"TargetPurposeExistenceFilterMismatch":return"existence-filter-mismatch";case"TargetPurposeExistenceFilterMismatchBloom":return"existence-filter-mismatch-bloom";case"TargetPurposeLimboResolution":return"limbo-document";default:return ir()}})(u.purpose);return m==null?null:{"goog-listen-tags":m}}function d3(x){return x.unaryFilter!==void 0?(function(m){switch(m.unaryFilter.op){case"IS_NAN":const E=nm(m.unaryFilter.field);return Xo.create(E,"==",{doubleValue:NaN});case"IS_NULL":const A=nm(m.unaryFilter.field);return Xo.create(A,"==",{nullValue:"NULL_VALUE"});case"IS_NOT_NAN":const z=nm(m.unaryFilter.field);return Xo.create(z,"!=",{doubleValue:NaN});case"IS_NOT_NULL":const U=nm(m.unaryFilter.field);return Xo.create(U,"!=",{nullValue:"NULL_VALUE"});default:return ir()}})(x):x.fieldFilter!==void 0?(function(m){return Xo.create(nm(m.fieldFilter.field),(function(A){switch(A){case"EQUAL":return"==";case"NOT_EQUAL":return"!=";case"GREATER_THAN":return">";case"GREATER_THAN_OR_EQUAL":return">=";case"LESS_THAN":return"<";case"LESS_THAN_OR_EQUAL":return"<=";case"ARRAY_CONTAINS":return"array-contains";case"IN":return"in";case"NOT_IN":return"not-in";case"ARRAY_CONTAINS_ANY":return"array-contains-any";default:return ir()}})(m.fieldFilter.op),m.fieldFilter.value)})(x):x.compositeFilter!==void 0?(function(m){return Ih.create(m.compositeFilter.filters.map((E=>d3(E))),(function(A){switch(A){case"AND":return"and";case"OR":return"or";default:return ir()}})(m.compositeFilter.op))})(x):ir()}function NP(x){return IP[x]}function VP(x){return AP[x]}function UP(x){return CP[x]}function im(x){return{fieldPath:x.canonicalString()}}function nm(x){return La.fromServerFormat(x.fieldPath)}function f3(x){return x instanceof Xo?(function(m){if(m.op==="=="){if(y2(m.value))return{unaryFilter:{field:im(m.field),op:"IS_NAN"}};if(g2(m.value))return{unaryFilter:{field:im(m.field),op:"IS_NULL"}}}else if(m.op==="!="){if(y2(m.value))return{unaryFilter:{field:im(m.field),op:"IS_NOT_NAN"}};if(g2(m.value))return{unaryFilter:{field:im(m.field),op:"IS_NOT_NULL"}}}return{fieldFilter:{field:im(m.field),op:VP(m.op),value:m.value}}})(x):x instanceof Ih?(function(m){const E=m.getFilters().map((A=>f3(A)));return E.length===1?E[0]:{compositeFilter:{op:UP(m.op),filters:E}}})(x):ir()}function jP(x){const u=[];return x.fields.forEach((m=>u.push(m.canonicalString()))),{fieldPaths:u}}function p3(x){return x.length>=4&&x.get(0)==="projects"&&x.get(2)==="databases"}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class bf{constructor(u,m,E,A,z=hr.min(),U=hr.min(),s=za.EMPTY_BYTE_STRING,ee=null){this.target=u,this.targetId=m,this.purpose=E,this.sequenceNumber=A,this.snapshotVersion=z,this.lastLimboFreeSnapshotVersion=U,this.resumeToken=s,this.expectedCount=ee}withSequenceNumber(u){return new bf(this.target,this.targetId,this.purpose,u,this.snapshotVersion,this.lastLimboFreeSnapshotVersion,this.resumeToken,this.expectedCount)}withResumeToken(u,m){return new bf(this.target,this.targetId,this.purpose,this.sequenceNumber,m,this.lastLimboFreeSnapshotVersion,u,null)}withExpectedCount(u){return new bf(this.target,this.targetId,this.purpose,this.sequenceNumber,this.snapshotVersion,this.lastLimboFreeSnapshotVersion,this.resumeToken,u)}withLastLimboFreeSnapshotVersion(u){return new bf(this.target,this.targetId,this.purpose,this.sequenceNumber,this.snapshotVersion,u,this.resumeToken,this.expectedCount)}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class GP{constructor(u){this.ct=u}}function HP(x){const u=OP({parent:x.parent,structuredQuery:x.structuredQuery});return x.limitType==="LAST"?hv(u,u.limit,"L"):u}/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class qP{constructor(){this.un=new $P}addToCollectionParentIndex(u,m){return this.un.add(m),mi.resolve()}getCollectionParents(u,m){return mi.resolve(this.un.getEntries(m))}addFieldIndex(u,m){return mi.resolve()}deleteFieldIndex(u,m){return mi.resolve()}deleteAllFieldIndexes(u){return mi.resolve()}createTargetIndexes(u,m){return mi.resolve()}getDocumentsMatchingTarget(u,m){return mi.resolve(null)}getIndexType(u,m){return mi.resolve(0)}getFieldIndexes(u,m){return mi.resolve([])}getNextCollectionGroupToUpdate(u){return mi.resolve(null)}getMinOffset(u,m){return mi.resolve(Af.min())}getMinOffsetFromCollectionGroup(u,m){return mi.resolve(Af.min())}updateCollectionGroup(u,m,E){return mi.resolve()}updateIndexEntries(u,m){return mi.resolve()}}class $P{constructor(){this.index={}}add(u){const m=u.lastSegment(),E=u.popLast(),A=this.index[m]||new ka(Zs.comparator),z=!A.has(E);return this.index[m]=A.add(E),z}has(u){const m=u.lastSegment(),E=u.popLast(),A=this.index[m];return A&&A.has(E)}getEntries(u){return(this.index[u]||new ka(Zs.comparator)).toArray()}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class um{constructor(u){this.Ln=u}next(){return this.Ln+=2,this.Ln}static Bn(){return new um(0)}static kn(){return new um(-1)}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class WP{constructor(){this.changes=new gm((u=>u.toString()),((u,m)=>u.isEqual(m))),this.changesApplied=!1}addEntry(u){this.assertNotApplied(),this.changes.set(u.key,u)}removeEntry(u,m){this.assertNotApplied(),this.changes.set(u,sl.newInvalidDocument(u).setReadTime(m))}getEntry(u,m){this.assertNotApplied();const E=this.changes.get(m);return E!==void 0?mi.resolve(E):this.getFromCache(u,m)}getEntries(u,m){return this.getAllFromCache(u,m)}apply(u){return this.assertNotApplied(),this.changesApplied=!0,this.applyChanges(u)}assertNotApplied(){}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *//**
 * @license
 * Copyright 2022 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class ZP{constructor(u,m){this.overlayedDocument=u,this.mutatedFields=m}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class XP{constructor(u,m,E,A){this.remoteDocumentCache=u,this.mutationQueue=m,this.documentOverlayCache=E,this.indexManager=A}getDocument(u,m){let E=null;return this.documentOverlayCache.getOverlay(u,m).next((A=>(E=A,this.remoteDocumentCache.getEntry(u,m)))).next((A=>(E!==null&&g_(E.mutation,A,Sc.empty(),Ko.now()),A)))}getDocuments(u,m){return this.remoteDocumentCache.getEntries(u,m).next((E=>this.getLocalViewOfDocuments(u,E,Br()).next((()=>E))))}getLocalViewOfDocuments(u,m,E=Br()){const A=pp();return this.populateOverlays(u,A,m).next((()=>this.computeViews(u,m,A,E).next((z=>{let U=d_();return z.forEach(((s,ee)=>{U=U.insert(s,ee.overlayedDocument)})),U}))))}getOverlayedDocuments(u,m){const E=pp();return this.populateOverlays(u,E,m).next((()=>this.computeViews(u,m,E,Br())))}populateOverlays(u,m,E){const A=[];return E.forEach((z=>{m.has(z)||A.push(z)})),this.documentOverlayCache.getOverlays(u,A).next((z=>{z.forEach(((U,s)=>{m.set(U,s)}))}))}computeViews(u,m,E,A){let z=yd();const U=__(),s=(function(){return __()})();return m.forEach(((ee,ne)=>{const Ie=E.get(ne.key);A.has(ne.key)&&(Ie===void 0||Ie.mutation instanceof Rf)?z=z.insert(ne.key,ne):Ie!==void 0?(U.set(ne.key,Ie.mutation.getFieldMask()),g_(Ie.mutation,ne,Ie.mutation.getFieldMask(),Ko.now())):U.set(ne.key,Sc.empty())})),this.recalculateAndSaveOverlays(u,z).next((ee=>(ee.forEach(((ne,Ie)=>U.set(ne,Ie))),m.forEach(((ne,Ie)=>{var qe;return s.set(ne,new ZP(Ie,(qe=U.get(ne))!==null&&qe!==void 0?qe:null))})),s)))}recalculateAndSaveOverlays(u,m){const E=__();let A=new oo(((U,s)=>U-s)),z=Br();return this.mutationQueue.getAllMutationBatchesAffectingDocumentKeys(u,m).next((U=>{for(const s of U)s.keys().forEach((ee=>{const ne=m.get(ee);if(ne===null)return;let Ie=E.get(ee)||Sc.empty();Ie=s.applyToLocalView(ne,Ie),E.set(ee,Ie);const qe=(A.get(s.batchId)||Br()).add(ee);A=A.insert(s.batchId,qe)}))})).next((()=>{const U=[],s=A.getReverseIterator();for(;s.hasNext();){const ee=s.getNext(),ne=ee.key,Ie=ee.value,qe=YT();Ie.forEach((Xe=>{if(!z.has(Xe)){const St=n3(m.get(Xe),E.get(Xe));St!==null&&qe.set(Xe,St),z=z.add(Xe)}})),U.push(this.documentOverlayCache.saveOverlays(u,ne,qe))}return mi.waitFor(U)})).next((()=>E))}recalculateAndSaveOverlaysForDocumentKeys(u,m){return this.remoteDocumentCache.getEntries(u,m).next((E=>this.recalculateAndSaveOverlays(u,E)))}getDocumentsMatchingQuery(u,m,E,A){return(function(U){return Vn.isDocumentKey(U.path)&&U.collectionGroup===null&&U.filters.length===0})(m)?this.getDocumentsMatchingDocumentQuery(u,m.path):tP(m)?this.getDocumentsMatchingCollectionGroupQuery(u,m,E,A):this.getDocumentsMatchingCollectionQuery(u,m,E,A)}getNextDocuments(u,m,E,A){return this.remoteDocumentCache.getAllFromCollectionGroup(u,m,E,A).next((z=>{const U=A-z.size>0?this.documentOverlayCache.getOverlaysForCollectionGroup(u,m,E.largestBatchId,A-z.size):mi.resolve(pp());let s=-1,ee=z;return U.next((ne=>mi.forEach(ne,((Ie,qe)=>(s<qe.largestBatchId&&(s=qe.largestBatchId),z.get(Ie)?mi.resolve():this.remoteDocumentCache.getEntry(u,Ie).next((Xe=>{ee=ee.insert(Ie,Xe)}))))).next((()=>this.populateOverlays(u,ne,z))).next((()=>this.computeViews(u,ee,ne,Br()))).next((Ie=>({batchId:s,changes:KT(Ie)})))))}))}getDocumentsMatchingDocumentQuery(u,m){return this.getDocument(u,new Vn(m)).next((E=>{let A=d_();return E.isFoundDocument()&&(A=A.insert(E.key,E)),A}))}getDocumentsMatchingCollectionGroupQuery(u,m,E,A){const z=m.collectionGroup;let U=d_();return this.indexManager.getCollectionParents(u,z).next((s=>mi.forEach(s,(ee=>{const ne=(function(qe,Xe){return new uy(Xe,null,qe.explicitOrderBy.slice(),qe.filters.slice(),qe.limit,qe.limitType,qe.startAt,qe.endAt)})(m,ee.child(z));return this.getDocumentsMatchingCollectionQuery(u,ne,E,A).next((Ie=>{Ie.forEach(((qe,Xe)=>{U=U.insert(qe,Xe)}))}))})).next((()=>U))))}getDocumentsMatchingCollectionQuery(u,m,E,A){let z;return this.documentOverlayCache.getOverlaysForCollection(u,m.path,E.largestBatchId).next((U=>(z=U,this.remoteDocumentCache.getDocumentsMatchingQuery(u,m,E,z,A)))).next((U=>{z.forEach(((ee,ne)=>{const Ie=ne.getKey();U.get(Ie)===null&&(U=U.insert(Ie,sl.newInvalidDocument(Ie)))}));let s=d_();return U.forEach(((ee,ne)=>{const Ie=z.get(ee);Ie!==void 0&&g_(Ie.mutation,ne,Sc.empty(),Ko.now()),dy(m,ne)&&(s=s.insert(ee,ne))})),s}))}}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class KP{constructor(u){this.serializer=u,this.hr=new Map,this.Pr=new Map}getBundleMetadata(u,m){return mi.resolve(this.hr.get(m))}saveBundleMetadata(u,m){return this.hr.set(m.id,(function(A){return{id:A.id,version:A.version,createTime:Th(A.createTime)}})(m)),mi.resolve()}getNamedQuery(u,m){return mi.resolve(this.Pr.get(m))}saveNamedQuery(u,m){return this.Pr.set(m.name,(function(A){return{name:A.name,query:HP(A.bundledQuery),readTime:Th(A.readTime)}})(m)),mi.resolve()}}/**
 * @license
 * Copyright 2022 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class YP{constructor(){this.overlays=new oo(Vn.comparator),this.Ir=new Map}getOverlay(u,m){return mi.resolve(this.overlays.get(m))}getOverlays(u,m){const E=pp();return mi.forEach(m,(A=>this.getOverlay(u,A).next((z=>{z!==null&&E.set(A,z)})))).next((()=>E))}saveOverlays(u,m,E){return E.forEach(((A,z)=>{this.ht(u,m,z)})),mi.resolve()}removeOverlaysForBatchId(u,m,E){const A=this.Ir.get(E);return A!==void 0&&(A.forEach((z=>this.overlays=this.overlays.remove(z))),this.Ir.delete(E)),mi.resolve()}getOverlaysForCollection(u,m,E){const A=pp(),z=m.length+1,U=new Vn(m.child("")),s=this.overlays.getIteratorFrom(U);for(;s.hasNext();){const ee=s.getNext().value,ne=ee.getKey();if(!m.isPrefixOf(ne.path))break;ne.path.length===z&&ee.largestBatchId>E&&A.set(ee.getKey(),ee)}return mi.resolve(A)}getOverlaysForCollectionGroup(u,m,E,A){let z=new oo(((ne,Ie)=>ne-Ie));const U=this.overlays.getIterator();for(;U.hasNext();){const ne=U.getNext().value;if(ne.getKey().getCollectionGroup()===m&&ne.largestBatchId>E){let Ie=z.get(ne.largestBatchId);Ie===null&&(Ie=pp(),z=z.insert(ne.largestBatchId,Ie)),Ie.set(ne.getKey(),ne)}}const s=pp(),ee=z.getIterator();for(;ee.hasNext()&&(ee.getNext().value.forEach(((ne,Ie)=>s.set(ne,Ie))),!(s.size()>=A)););return mi.resolve(s)}ht(u,m,E){const A=this.overlays.get(E.key);if(A!==null){const U=this.Ir.get(A.largestBatchId).delete(E.key);this.Ir.set(A.largestBatchId,U)}this.overlays=this.overlays.insert(E.key,new xP(m,E));let z=this.Ir.get(m);z===void 0&&(z=Br(),this.Ir.set(m,z)),this.Ir.set(m,z.add(E.key))}}/**
 * @license
 * Copyright 2024 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class QP{constructor(){this.sessionToken=za.EMPTY_BYTE_STRING}getSessionToken(u){return mi.resolve(this.sessionToken)}setSessionToken(u,m){return this.sessionToken=m,mi.resolve()}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Uv{constructor(){this.Tr=new ka(ha.Er),this.dr=new ka(ha.Ar)}isEmpty(){return this.Tr.isEmpty()}addReference(u,m){const E=new ha(u,m);this.Tr=this.Tr.add(E),this.dr=this.dr.add(E)}Rr(u,m){u.forEach((E=>this.addReference(E,m)))}removeReference(u,m){this.Vr(new ha(u,m))}mr(u,m){u.forEach((E=>this.removeReference(E,m)))}gr(u){const m=new Vn(new Zs([])),E=new ha(m,u),A=new ha(m,u+1),z=[];return this.dr.forEachInRange([E,A],(U=>{this.Vr(U),z.push(U.key)})),z}pr(){this.Tr.forEach((u=>this.Vr(u)))}Vr(u){this.Tr=this.Tr.delete(u),this.dr=this.dr.delete(u)}yr(u){const m=new Vn(new Zs([])),E=new ha(m,u),A=new ha(m,u+1);let z=Br();return this.dr.forEachInRange([E,A],(U=>{z=z.add(U.key)})),z}containsKey(u){const m=new ha(u,0),E=this.Tr.firstAfterOrEqual(m);return E!==null&&u.isEqual(E.key)}}class ha{constructor(u,m){this.key=u,this.wr=m}static Er(u,m){return Vn.comparator(u.key,m.key)||is(u.wr,m.wr)}static Ar(u,m){return is(u.wr,m.wr)||Vn.comparator(u.key,m.key)}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class JP{constructor(u,m){this.indexManager=u,this.referenceDelegate=m,this.mutationQueue=[],this.Sr=1,this.br=new ka(ha.Er)}checkEmpty(u){return mi.resolve(this.mutationQueue.length===0)}addMutationBatch(u,m,E,A){const z=this.Sr;this.Sr++,this.mutationQueue.length>0&&this.mutationQueue[this.mutationQueue.length-1];const U=new vP(z,m,E,A);this.mutationQueue.push(U);for(const s of A)this.br=this.br.add(new ha(s.key,z)),this.indexManager.addToCollectionParentIndex(u,s.key.path.popLast());return mi.resolve(U)}lookupMutationBatch(u,m){return mi.resolve(this.Dr(m))}getNextMutationBatchAfterBatchId(u,m){const E=m+1,A=this.vr(E),z=A<0?0:A;return mi.resolve(this.mutationQueue.length>z?this.mutationQueue[z]:null)}getHighestUnacknowledgedBatchId(){return mi.resolve(this.mutationQueue.length===0?-1:this.Sr-1)}getAllMutationBatches(u){return mi.resolve(this.mutationQueue.slice())}getAllMutationBatchesAffectingDocumentKey(u,m){const E=new ha(m,0),A=new ha(m,Number.POSITIVE_INFINITY),z=[];return this.br.forEachInRange([E,A],(U=>{const s=this.Dr(U.wr);z.push(s)})),mi.resolve(z)}getAllMutationBatchesAffectingDocumentKeys(u,m){let E=new ka(is);return m.forEach((A=>{const z=new ha(A,0),U=new ha(A,Number.POSITIVE_INFINITY);this.br.forEachInRange([z,U],(s=>{E=E.add(s.wr)}))})),mi.resolve(this.Cr(E))}getAllMutationBatchesAffectingQuery(u,m){const E=m.path,A=E.length+1;let z=E;Vn.isDocumentKey(z)||(z=z.child(""));const U=new ha(new Vn(z),0);let s=new ka(is);return this.br.forEachWhile((ee=>{const ne=ee.key.path;return!!E.isPrefixOf(ne)&&(ne.length===A&&(s=s.add(ee.wr)),!0)}),U),mi.resolve(this.Cr(s))}Cr(u){const m=[];return u.forEach((E=>{const A=this.Dr(E);A!==null&&m.push(A)})),m}removeMutationBatch(u,m){_s(this.Fr(m.batchId,"removed")===0),this.mutationQueue.shift();let E=this.br;return mi.forEach(m.mutations,(A=>{const z=new ha(A.key,m.batchId);return E=E.delete(z),this.referenceDelegate.markPotentiallyOrphaned(u,A.key)})).next((()=>{this.br=E}))}On(u){}containsKey(u,m){const E=new ha(m,0),A=this.br.firstAfterOrEqual(E);return mi.resolve(m.isEqual(A&&A.key))}performConsistencyCheck(u){return this.mutationQueue.length,mi.resolve()}Fr(u,m){return this.vr(u)}vr(u){return this.mutationQueue.length===0?0:u-this.mutationQueue[0].batchId}Dr(u){const m=this.vr(u);return m<0||m>=this.mutationQueue.length?null:this.mutationQueue[m]}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class eR{constructor(u){this.Mr=u,this.docs=(function(){return new oo(Vn.comparator)})(),this.size=0}setIndexManager(u){this.indexManager=u}addEntry(u,m){const E=m.key,A=this.docs.get(E),z=A?A.size:0,U=this.Mr(m);return this.docs=this.docs.insert(E,{document:m.mutableCopy(),size:U}),this.size+=U-z,this.indexManager.addToCollectionParentIndex(u,E.path.popLast())}removeEntry(u){const m=this.docs.get(u);m&&(this.docs=this.docs.remove(u),this.size-=m.size)}getEntry(u,m){const E=this.docs.get(m);return mi.resolve(E?E.document.mutableCopy():sl.newInvalidDocument(m))}getEntries(u,m){let E=yd();return m.forEach((A=>{const z=this.docs.get(A);E=E.insert(A,z?z.document.mutableCopy():sl.newInvalidDocument(A))})),mi.resolve(E)}getDocumentsMatchingQuery(u,m,E,A){let z=yd();const U=m.path,s=new Vn(U.child("")),ee=this.docs.getIteratorFrom(s);for(;ee.hasNext();){const{key:ne,value:{document:Ie}}=ee.getNext();if(!U.isPrefixOf(ne.path))break;ne.path.length>U.length+1||zC(kC(Ie),E)<=0||(A.has(Ie.key)||dy(m,Ie))&&(z=z.insert(Ie.key,Ie.mutableCopy()))}return mi.resolve(z)}getAllFromCollectionGroup(u,m,E,A){ir()}Or(u,m){return mi.forEach(this.docs,(E=>m(E)))}newChangeBuffer(u){return new tR(this)}getSize(u){return mi.resolve(this.size)}}class tR extends WP{constructor(u){super(),this.cr=u}applyChanges(u){const m=[];return this.changes.forEach(((E,A)=>{A.isValidDocument()?m.push(this.cr.addEntry(u,A)):this.cr.removeEntry(E)})),mi.waitFor(m)}getFromCache(u,m){return this.cr.getEntry(u,m)}getAllFromCache(u,m){return this.cr.getEntries(u,m)}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class iR{constructor(u){this.persistence=u,this.Nr=new gm((m=>kv(m)),zv),this.lastRemoteSnapshotVersion=hr.min(),this.highestTargetId=0,this.Lr=0,this.Br=new Uv,this.targetCount=0,this.kr=um.Bn()}forEachTarget(u,m){return this.Nr.forEach(((E,A)=>m(A))),mi.resolve()}getLastRemoteSnapshotVersion(u){return mi.resolve(this.lastRemoteSnapshotVersion)}getHighestSequenceNumber(u){return mi.resolve(this.Lr)}allocateTargetId(u){return this.highestTargetId=this.kr.next(),mi.resolve(this.highestTargetId)}setTargetsMetadata(u,m,E){return E&&(this.lastRemoteSnapshotVersion=E),m>this.Lr&&(this.Lr=m),mi.resolve()}Kn(u){this.Nr.set(u.target,u);const m=u.targetId;m>this.highestTargetId&&(this.kr=new um(m),this.highestTargetId=m),u.sequenceNumber>this.Lr&&(this.Lr=u.sequenceNumber)}addTargetData(u,m){return this.Kn(m),this.targetCount+=1,mi.resolve()}updateTargetData(u,m){return this.Kn(m),mi.resolve()}removeTargetData(u,m){return this.Nr.delete(m.target),this.Br.gr(m.targetId),this.targetCount-=1,mi.resolve()}removeTargets(u,m,E){let A=0;const z=[];return this.Nr.forEach(((U,s)=>{s.sequenceNumber<=m&&E.get(s.targetId)===null&&(this.Nr.delete(U),z.push(this.removeMatchingKeysForTargetId(u,s.targetId)),A++)})),mi.waitFor(z).next((()=>A))}getTargetCount(u){return mi.resolve(this.targetCount)}getTargetData(u,m){const E=this.Nr.get(m)||null;return mi.resolve(E)}addMatchingKeys(u,m,E){return this.Br.Rr(m,E),mi.resolve()}removeMatchingKeys(u,m,E){this.Br.mr(m,E);const A=this.persistence.referenceDelegate,z=[];return A&&m.forEach((U=>{z.push(A.markPotentiallyOrphaned(u,U))})),mi.waitFor(z)}removeMatchingKeysForTargetId(u,m){return this.Br.gr(m),mi.resolve()}getMatchingKeysForTargetId(u,m){const E=this.Br.yr(m);return mi.resolve(E)}containsKey(u,m){return mi.resolve(this.Br.containsKey(m))}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class nR{constructor(u,m){this.qr={},this.overlays={},this.Qr=new Rv(0),this.Kr=!1,this.Kr=!0,this.$r=new QP,this.referenceDelegate=u(this),this.Ur=new iR(this),this.indexManager=new qP,this.remoteDocumentCache=(function(A){return new eR(A)})((E=>this.referenceDelegate.Wr(E))),this.serializer=new GP(m),this.Gr=new KP(this.serializer)}start(){return Promise.resolve()}shutdown(){return this.Kr=!1,Promise.resolve()}get started(){return this.Kr}setDatabaseDeletedListener(){}setNetworkEnabled(){}getIndexManager(u){return this.indexManager}getDocumentOverlayCache(u){let m=this.overlays[u.toKey()];return m||(m=new YP,this.overlays[u.toKey()]=m),m}getMutationQueue(u,m){let E=this.qr[u.toKey()];return E||(E=new JP(m,this.referenceDelegate),this.qr[u.toKey()]=E),E}getGlobalsCache(){return this.$r}getTargetCache(){return this.Ur}getRemoteDocumentCache(){return this.remoteDocumentCache}getBundleCache(){return this.Gr}runTransaction(u,m,E){sn("MemoryPersistence","Starting transaction:",u);const A=new rR(this.Qr.next());return this.referenceDelegate.zr(),E(A).next((z=>this.referenceDelegate.jr(A).next((()=>z)))).toPromise().then((z=>(A.raiseOnCommittedEvent(),z)))}Hr(u,m){return mi.or(Object.values(this.qr).map((E=>()=>E.containsKey(u,m))))}}class rR extends OC{constructor(u){super(),this.currentSequenceNumber=u}}class jv{constructor(u){this.persistence=u,this.Jr=new Uv,this.Yr=null}static Zr(u){return new jv(u)}get Xr(){if(this.Yr)return this.Yr;throw ir()}addReference(u,m,E){return this.Jr.addReference(E,m),this.Xr.delete(E.toString()),mi.resolve()}removeReference(u,m,E){return this.Jr.removeReference(E,m),this.Xr.add(E.toString()),mi.resolve()}markPotentiallyOrphaned(u,m){return this.Xr.add(m.toString()),mi.resolve()}removeTarget(u,m){this.Jr.gr(m.targetId).forEach((A=>this.Xr.add(A.toString())));const E=this.persistence.getTargetCache();return E.getMatchingKeysForTargetId(u,m.targetId).next((A=>{A.forEach((z=>this.Xr.add(z.toString())))})).next((()=>E.removeTargetData(u,m)))}zr(){this.Yr=new Set}jr(u){const m=this.persistence.getRemoteDocumentCache().newChangeBuffer();return mi.forEach(this.Xr,(E=>{const A=Vn.fromPath(E);return this.ei(u,A).next((z=>{z||m.removeEntry(A,hr.min())}))})).next((()=>(this.Yr=null,m.apply(u))))}updateLimboDocument(u,m){return this.ei(u,m).next((E=>{E?this.Xr.delete(m.toString()):this.Xr.add(m.toString())}))}Wr(u){return 0}ei(u,m){return mi.or([()=>mi.resolve(this.Jr.containsKey(m)),()=>this.persistence.getTargetCache().containsKey(u,m),()=>this.persistence.Hr(u,m)])}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Gv{constructor(u,m,E,A){this.targetId=u,this.fromCache=m,this.$i=E,this.Ui=A}static Wi(u,m){let E=Br(),A=Br();for(const z of m.docChanges)switch(z.type){case 0:E=E.add(z.doc.key);break;case 1:A=A.add(z.doc.key)}return new Gv(u,m.fromCache,E,A)}}/**
 * @license
 * Copyright 2023 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class sR{constructor(){this._documentReadCount=0}get documentReadCount(){return this._documentReadCount}incrementDocumentReadCount(u){this._documentReadCount+=u}}/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class oR{constructor(){this.Gi=!1,this.zi=!1,this.ji=100,this.Hi=(function(){return o5()?8:BC(r5())>0?6:4})()}initialize(u,m){this.Ji=u,this.indexManager=m,this.Gi=!0}getDocumentsMatchingQuery(u,m,E,A){const z={result:null};return this.Yi(u,m).next((U=>{z.result=U})).next((()=>{if(!z.result)return this.Zi(u,m,A,E).next((U=>{z.result=U}))})).next((()=>{if(z.result)return;const U=new sR;return this.Xi(u,m,U).next((s=>{if(z.result=s,this.zi)return this.es(u,m,U,s.size)}))})).next((()=>z.result))}es(u,m,E,A){return E.documentReadCount<this.ji?(c_()<=Jr.DEBUG&&sn("QueryEngine","SDK will not create cache indexes for query:",tm(m),"since it only creates cache indexes for collection contains","more than or equal to",this.ji,"documents"),mi.resolve()):(c_()<=Jr.DEBUG&&sn("QueryEngine","Query:",tm(m),"scans",E.documentReadCount,"local documents and returns",A,"documents as results."),E.documentReadCount>this.Hi*A?(c_()<=Jr.DEBUG&&sn("QueryEngine","The SDK decides to create cache indexes for query:",tm(m),"as using cache indexes may help improve performance."),this.indexManager.createTargetIndexes(u,bh(m))):mi.resolve())}Yi(u,m){if(b2(m))return mi.resolve(null);let E=bh(m);return this.indexManager.getIndexType(u,E).next((A=>A===0?null:(m.limit!==null&&A===1&&(m=hv(m,null,"F"),E=bh(m)),this.indexManager.getDocumentsMatchingTarget(u,E).next((z=>{const U=Br(...z);return this.Ji.getDocuments(u,U).next((s=>this.indexManager.getMinOffset(u,E).next((ee=>{const ne=this.ts(m,s);return this.ns(m,ne,U,ee.readTime)?this.Yi(u,hv(m,null,"F")):this.rs(u,ne,m,ee)}))))})))))}Zi(u,m,E,A){return b2(m)||A.isEqual(hr.min())?mi.resolve(null):this.Ji.getDocuments(u,E).next((z=>{const U=this.ts(m,z);return this.ns(m,U,E,A)?mi.resolve(null):(c_()<=Jr.DEBUG&&sn("QueryEngine","Re-using previous result from %s to execute query: %s",A.toString(),tm(m)),this.rs(u,U,m,LC(A,-1)).next((s=>s)))}))}ts(u,m){let E=new ka(ZT(u));return m.forEach(((A,z)=>{dy(u,z)&&(E=E.add(z))})),E}ns(u,m,E,A){if(u.limit===null)return!1;if(E.size!==m.size)return!0;const z=u.limitType==="F"?m.last():m.first();return!!z&&(z.hasPendingWrites||z.version.compareTo(A)>0)}Xi(u,m,E){return c_()<=Jr.DEBUG&&sn("QueryEngine","Using full collection scan to execute query:",tm(m)),this.Ji.getDocumentsMatchingQuery(u,m,Af.min(),E)}rs(u,m,E,A){return this.Ji.getDocumentsMatchingQuery(u,E,A).next((z=>(m.forEach((U=>{z=z.insert(U.key,U)})),z)))}}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class aR{constructor(u,m,E,A){this.persistence=u,this.ss=m,this.serializer=A,this.os=new oo(is),this._s=new gm((z=>kv(z)),zv),this.us=new Map,this.cs=u.getRemoteDocumentCache(),this.Ur=u.getTargetCache(),this.Gr=u.getBundleCache(),this.ls(E)}ls(u){this.documentOverlayCache=this.persistence.getDocumentOverlayCache(u),this.indexManager=this.persistence.getIndexManager(u),this.mutationQueue=this.persistence.getMutationQueue(u,this.indexManager),this.localDocuments=new XP(this.cs,this.mutationQueue,this.documentOverlayCache,this.indexManager),this.cs.setIndexManager(this.indexManager),this.ss.initialize(this.localDocuments,this.indexManager)}collectGarbage(u){return this.persistence.runTransaction("Collect garbage","readwrite-primary",(m=>u.collect(m,this.os)))}}function lR(x,u,m,E){return new aR(x,u,m,E)}async function m3(x,u){const m=dr(x);return await m.persistence.runTransaction("Handle user change","readonly",(E=>{let A;return m.mutationQueue.getAllMutationBatches(E).next((z=>(A=z,m.ls(u),m.mutationQueue.getAllMutationBatches(E)))).next((z=>{const U=[],s=[];let ee=Br();for(const ne of A){U.push(ne.batchId);for(const Ie of ne.mutations)ee=ee.add(Ie.key)}for(const ne of z){s.push(ne.batchId);for(const Ie of ne.mutations)ee=ee.add(Ie.key)}return m.localDocuments.getDocuments(E,ee).next((ne=>({hs:ne,removedBatchIds:U,addedBatchIds:s})))}))}))}function cR(x,u){const m=dr(x);return m.persistence.runTransaction("Acknowledge batch","readwrite-primary",(E=>{const A=u.batch.keys(),z=m.cs.newChangeBuffer({trackRemovals:!0});return(function(s,ee,ne,Ie){const qe=ne.batch,Xe=qe.keys();let St=mi.resolve();return Xe.forEach(($t=>{St=St.next((()=>Ie.getEntry(ee,$t))).next((ct=>{const wt=ne.docVersions.get($t);_s(wt!==null),ct.version.compareTo(wt)<0&&(qe.applyToRemoteDocument(ct,ne),ct.isValidDocument()&&(ct.setReadTime(ne.commitVersion),Ie.addEntry(ct)))}))})),St.next((()=>s.mutationQueue.removeMutationBatch(ee,qe)))})(m,E,u,z).next((()=>z.apply(E))).next((()=>m.mutationQueue.performConsistencyCheck(E))).next((()=>m.documentOverlayCache.removeOverlaysForBatchId(E,A,u.batch.batchId))).next((()=>m.localDocuments.recalculateAndSaveOverlaysForDocumentKeys(E,(function(s){let ee=Br();for(let ne=0;ne<s.mutationResults.length;++ne)s.mutationResults[ne].transformResults.length>0&&(ee=ee.add(s.batch.mutations[ne].key));return ee})(u)))).next((()=>m.localDocuments.getDocuments(E,A)))}))}function _3(x){const u=dr(x);return u.persistence.runTransaction("Get last remote snapshot version","readonly",(m=>u.Ur.getLastRemoteSnapshotVersion(m)))}function uR(x,u){const m=dr(x),E=u.snapshotVersion;let A=m.os;return m.persistence.runTransaction("Apply remote event","readwrite-primary",(z=>{const U=m.cs.newChangeBuffer({trackRemovals:!0});A=m.os;const s=[];u.targetChanges.forEach(((Ie,qe)=>{const Xe=A.get(qe);if(!Xe)return;s.push(m.Ur.removeMatchingKeys(z,Ie.removedDocuments,qe).next((()=>m.Ur.addMatchingKeys(z,Ie.addedDocuments,qe))));let St=Xe.withSequenceNumber(z.currentSequenceNumber);u.targetMismatches.get(qe)!==null?St=St.withResumeToken(za.EMPTY_BYTE_STRING,hr.min()).withLastLimboFreeSnapshotVersion(hr.min()):Ie.resumeToken.approximateByteSize()>0&&(St=St.withResumeToken(Ie.resumeToken,E)),A=A.insert(qe,St),(function(ct,wt,Nt){return ct.resumeToken.approximateByteSize()===0||wt.snapshotVersion.toMicroseconds()-ct.snapshotVersion.toMicroseconds()>=3e8?!0:Nt.addedDocuments.size+Nt.modifiedDocuments.size+Nt.removedDocuments.size>0})(Xe,St,Ie)&&s.push(m.Ur.updateTargetData(z,St))}));let ee=yd(),ne=Br();if(u.documentUpdates.forEach((Ie=>{u.resolvedLimboDocuments.has(Ie)&&s.push(m.persistence.referenceDelegate.updateLimboDocument(z,Ie))})),s.push(hR(z,U,u.documentUpdates).next((Ie=>{ee=Ie.Ps,ne=Ie.Is}))),!E.isEqual(hr.min())){const Ie=m.Ur.getLastRemoteSnapshotVersion(z).next((qe=>m.Ur.setTargetsMetadata(z,z.currentSequenceNumber,E)));s.push(Ie)}return mi.waitFor(s).next((()=>U.apply(z))).next((()=>m.localDocuments.getLocalViewOfDocuments(z,ee,ne))).next((()=>ee))})).then((z=>(m.os=A,z)))}function hR(x,u,m){let E=Br(),A=Br();return m.forEach((z=>E=E.add(z))),u.getEntries(x,E).next((z=>{let U=yd();return m.forEach(((s,ee)=>{const ne=z.get(s);ee.isFoundDocument()!==ne.isFoundDocument()&&(A=A.add(s)),ee.isNoDocument()&&ee.version.isEqual(hr.min())?(u.removeEntry(s,ee.readTime),U=U.insert(s,ee)):!ne.isValidDocument()||ee.version.compareTo(ne.version)>0||ee.version.compareTo(ne.version)===0&&ne.hasPendingWrites?(u.addEntry(ee),U=U.insert(s,ee)):sn("LocalStore","Ignoring outdated watch update for ",s,". Current version:",ne.version," Watch version:",ee.version)})),{Ps:U,Is:A}}))}function dR(x,u){const m=dr(x);return m.persistence.runTransaction("Get next mutation batch","readonly",(E=>(u===void 0&&(u=-1),m.mutationQueue.getNextMutationBatchAfterBatchId(E,u))))}function fR(x,u){const m=dr(x);return m.persistence.runTransaction("Allocate target","readwrite",(E=>{let A;return m.Ur.getTargetData(E,u).next((z=>z?(A=z,mi.resolve(A)):m.Ur.allocateTargetId(E).next((U=>(A=new bf(u,U,"TargetPurposeListen",E.currentSequenceNumber),m.Ur.addTargetData(E,A).next((()=>A)))))))})).then((E=>{const A=m.os.get(E.targetId);return(A===null||E.snapshotVersion.compareTo(A.snapshotVersion)>0)&&(m.os=m.os.insert(E.targetId,E),m._s.set(u,E.targetId)),E}))}async function _v(x,u,m){const E=dr(x),A=E.os.get(u),z=m?"readwrite":"readwrite-primary";try{m||await E.persistence.runTransaction("Release target",z,(U=>E.persistence.referenceDelegate.removeTarget(U,A)))}catch(U){if(!z_(U))throw U;sn("LocalStore",`Failed to update sequence numbers for target ${u}: ${U}`)}E.os=E.os.remove(u),E._s.delete(A.target)}function L2(x,u,m){const E=dr(x);let A=hr.min(),z=Br();return E.persistence.runTransaction("Execute query","readwrite",(U=>(function(ee,ne,Ie){const qe=dr(ee),Xe=qe._s.get(Ie);return Xe!==void 0?mi.resolve(qe.os.get(Xe)):qe.Ur.getTargetData(ne,Ie)})(E,U,bh(u)).next((s=>{if(s)return A=s.lastLimboFreeSnapshotVersion,E.Ur.getMatchingKeysForTargetId(U,s.targetId).next((ee=>{z=ee}))})).next((()=>E.ss.getDocumentsMatchingQuery(U,u,m?A:hr.min(),m?z:Br()))).next((s=>(pR(E,nP(u),s),{documents:s,Ts:z})))))}function pR(x,u,m){let E=x.us.get(u)||hr.min();m.forEach(((A,z)=>{z.readTime.compareTo(E)>0&&(E=z.readTime)})),x.us.set(u,E)}class k2{constructor(){this.activeTargetIds=cP()}fs(u){this.activeTargetIds=this.activeTargetIds.add(u)}gs(u){this.activeTargetIds=this.activeTargetIds.delete(u)}Vs(){const u={activeTargetIds:this.activeTargetIds.toArray(),updateTimeMs:Date.now()};return JSON.stringify(u)}}class mR{constructor(){this.so=new k2,this.oo={},this.onlineStateHandler=null,this.sequenceNumberHandler=null}addPendingMutation(u){}updateMutationState(u,m,E){}addLocalQueryTarget(u,m=!0){return m&&this.so.fs(u),this.oo[u]||"not-current"}updateQueryState(u,m,E){this.oo[u]=m}removeLocalQueryTarget(u){this.so.gs(u)}isLocalQueryTarget(u){return this.so.activeTargetIds.has(u)}clearQueryState(u){delete this.oo[u]}getAllActiveQueryTargets(){return this.so.activeTargetIds}isActiveQueryTarget(u){return this.so.activeTargetIds.has(u)}start(){return this.so=new k2,Promise.resolve()}handleUserChange(u,m,E){}setOnlineState(u){}shutdown(){}writeSequenceNumber(u){}notifyBundleLoaded(u){}}/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class _R{_o(u){}shutdown(){}}/**
 * @license
 * Copyright 2019 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class z2{constructor(){this.ao=()=>this.uo(),this.co=()=>this.lo(),this.ho=[],this.Po()}_o(u){this.ho.push(u)}shutdown(){window.removeEventListener("online",this.ao),window.removeEventListener("offline",this.co)}Po(){window.addEventListener("online",this.ao),window.addEventListener("offline",this.co)}uo(){sn("ConnectivityMonitor","Network connectivity changed: AVAILABLE");for(const u of this.ho)u(0)}lo(){sn("ConnectivityMonitor","Network connectivity changed: UNAVAILABLE");for(const u of this.ho)u(1)}static D(){return typeof window<"u"&&window.addEventListener!==void 0&&window.removeEventListener!==void 0}}/**
 * @license
 * Copyright 2023 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */let Og=null;function W0(){return Og===null?Og=(function(){return 268435456+Math.round(2147483648*Math.random())})():Og++,"0x"+Og.toString(16)}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const gR={BatchGetDocuments:"batchGet",Commit:"commit",RunQuery:"runQuery",RunAggregationQuery:"runAggregationQuery"};/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class yR{constructor(u){this.Io=u.Io,this.To=u.To}Eo(u){this.Ao=u}Ro(u){this.Vo=u}mo(u){this.fo=u}onMessage(u){this.po=u}close(){this.To()}send(u){this.Io(u)}yo(){this.Ao()}wo(){this.Vo()}So(u){this.fo(u)}bo(u){this.po(u)}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const nl="WebChannelConnection";class vR extends class{constructor(m){this.databaseInfo=m,this.databaseId=m.databaseId;const E=m.ssl?"https":"http",A=encodeURIComponent(this.databaseId.projectId),z=encodeURIComponent(this.databaseId.database);this.Do=E+"://"+m.host,this.vo=`projects/${A}/databases/${z}`,this.Co=this.databaseId.database==="(default)"?`project_id=${A}`:`project_id=${A}&database_id=${z}`}get Fo(){return!1}Mo(m,E,A,z,U){const s=W0(),ee=this.xo(m,E.toUriEncodedString());sn("RestConnection",`Sending RPC '${m}' ${s}:`,ee,A);const ne={"google-cloud-resource-prefix":this.vo,"x-goog-request-params":this.Co};return this.Oo(ne,z,U),this.No(m,ee,ne,A).then((Ie=>(sn("RestConnection",`Received RPC '${m}' ${s}: `,Ie),Ie)),(Ie=>{throw om("RestConnection",`RPC '${m}' ${s} failed with error: `,Ie,"url: ",ee,"request:",A),Ie}))}Lo(m,E,A,z,U,s){return this.Mo(m,E,A,z,U)}Oo(m,E,A){m["X-Goog-Api-Client"]=(function(){return"gl-js/ fire/"+_m})(),m["Content-Type"]="text/plain",this.databaseInfo.appId&&(m["X-Firebase-GMPID"]=this.databaseInfo.appId),E&&E.headers.forEach(((z,U)=>m[U]=z)),A&&A.headers.forEach(((z,U)=>m[U]=z))}xo(m,E){const A=gR[m];return`${this.Do}/v1/${E}:${A}`}terminate(){}}{constructor(u){super(u),this.forceLongPolling=u.forceLongPolling,this.autoDetectLongPolling=u.autoDetectLongPolling,this.useFetchStreams=u.useFetchStreams,this.longPollingOptions=u.longPollingOptions}No(u,m,E,A){const z=W0();return new Promise(((U,s)=>{const ee=new RT;ee.setWithCredentials(!0),ee.listenOnce(MT.COMPLETE,(()=>{try{switch(ee.getLastErrorCode()){case Gg.NO_ERROR:const Ie=ee.getResponseJson();sn(nl,`XHR for RPC '${u}' ${z} received:`,JSON.stringify(Ie)),U(Ie);break;case Gg.TIMEOUT:sn(nl,`RPC '${u}' ${z} timed out`),s(new yn(pi.DEADLINE_EXCEEDED,"Request time out"));break;case Gg.HTTP_ERROR:const qe=ee.getStatus();if(sn(nl,`RPC '${u}' ${z} failed with status:`,qe,"response text:",ee.getResponseText()),qe>0){let Xe=ee.getResponseJson();Array.isArray(Xe)&&(Xe=Xe[0]);const St=Xe?.error;if(St&&St.status&&St.message){const $t=(function(wt){const Nt=wt.toLowerCase().replace(/_/g,"-");return Object.values(pi).indexOf(Nt)>=0?Nt:pi.UNKNOWN})(St.status);s(new yn($t,St.message))}else s(new yn(pi.UNKNOWN,"Server responded with status "+ee.getStatus()))}else s(new yn(pi.UNAVAILABLE,"Connection failed."));break;default:ir()}}finally{sn(nl,`RPC '${u}' ${z} completed.`)}}));const ne=JSON.stringify(A);sn(nl,`RPC '${u}' ${z} sending request:`,A),ee.send(m,"POST",ne,E,15)}))}Bo(u,m,E){const A=W0(),z=[this.Do,"/","google.firestore.v1.Firestore","/",u,"/channel"],U=kT(),s=LT(),ee={httpSessionIdParam:"gsessionid",initMessageHeaders:{},messageUrlParams:{database:`projects/${this.databaseId.projectId}/databases/${this.databaseId.database}`},sendRawJson:!0,supportsCrossDomainXhr:!0,internalChannelParams:{forwardChannelRequestTimeoutMs:6e5},forceLongPolling:this.forceLongPolling,detectBufferingProxy:this.autoDetectLongPolling},ne=this.longPollingOptions.timeoutSeconds;ne!==void 0&&(ee.longPollingTimeout=Math.round(1e3*ne)),this.useFetchStreams&&(ee.useFetchStreams=!0),this.Oo(ee.initMessageHeaders,m,E),ee.encodeInitMessageHeaders=!0;const Ie=z.join("");sn(nl,`Creating RPC '${u}' stream ${A}: ${Ie}`,ee);const qe=U.createWebChannel(Ie,ee);let Xe=!1,St=!1;const $t=new yR({Io:wt=>{St?sn(nl,`Not sending because RPC '${u}' stream ${A} is closed:`,wt):(Xe||(sn(nl,`Opening RPC '${u}' stream ${A} transport.`),qe.open(),Xe=!0),sn(nl,`RPC '${u}' stream ${A} sending:`,wt),qe.send(wt))},To:()=>qe.close()}),ct=(wt,Nt,Ti)=>{wt.listen(Nt,(Ei=>{try{Ti(Ei)}catch(en){setTimeout((()=>{throw en}),0)}}))};return ct(qe,h_.EventType.OPEN,(()=>{St||(sn(nl,`RPC '${u}' stream ${A} transport opened.`),$t.yo())})),ct(qe,h_.EventType.CLOSE,(()=>{St||(St=!0,sn(nl,`RPC '${u}' stream ${A} transport closed`),$t.So())})),ct(qe,h_.EventType.ERROR,(wt=>{St||(St=!0,om(nl,`RPC '${u}' stream ${A} transport errored:`,wt),$t.So(new yn(pi.UNAVAILABLE,"The operation could not be completed")))})),ct(qe,h_.EventType.MESSAGE,(wt=>{var Nt;if(!St){const Ti=wt.data[0];_s(!!Ti);const Ei=Ti,en=Ei.error||((Nt=Ei[0])===null||Nt===void 0?void 0:Nt.error);if(en){sn(nl,`RPC '${u}' stream ${A} received error:`,en);const Hn=en.status;let _n=(function(je){const Ke=Oo[je];if(Ke!==void 0)return s3(Ke)})(Hn),rt=en.message;_n===void 0&&(_n=pi.INTERNAL,rt="Unknown error status: "+Hn+" with message "+en.message),St=!0,$t.So(new yn(_n,rt)),qe.close()}else sn(nl,`RPC '${u}' stream ${A} received:`,Ti),$t.bo(Ti)}})),ct(s,DT.STAT_EVENT,(wt=>{wt.stat===ov.PROXY?sn(nl,`RPC '${u}' stream ${A} detected buffering proxy`):wt.stat===ov.NOPROXY&&sn(nl,`RPC '${u}' stream ${A} detected no buffering proxy`)})),setTimeout((()=>{$t.wo()}),0),$t}}function Z0(){return typeof document<"u"?document:null}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function _y(x){return new PP(x,!0)}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class g3{constructor(u,m,E=1e3,A=1.5,z=6e4){this.ui=u,this.timerId=m,this.ko=E,this.qo=A,this.Qo=z,this.Ko=0,this.$o=null,this.Uo=Date.now(),this.reset()}reset(){this.Ko=0}Wo(){this.Ko=this.Qo}Go(u){this.cancel();const m=Math.floor(this.Ko+this.zo()),E=Math.max(0,Date.now()-this.Uo),A=Math.max(0,m-E);A>0&&sn("ExponentialBackoff",`Backing off for ${A} ms (base delay: ${this.Ko} ms, delay with jitter: ${m} ms, last attempt: ${E} ms ago)`),this.$o=this.ui.enqueueAfterDelay(this.timerId,A,(()=>(this.Uo=Date.now(),u()))),this.Ko*=this.qo,this.Ko<this.ko&&(this.Ko=this.ko),this.Ko>this.Qo&&(this.Ko=this.Qo)}jo(){this.$o!==null&&(this.$o.skipDelay(),this.$o=null)}cancel(){this.$o!==null&&(this.$o.cancel(),this.$o=null)}zo(){return(Math.random()-.5)*this.Ko}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class y3{constructor(u,m,E,A,z,U,s,ee){this.ui=u,this.Ho=E,this.Jo=A,this.connection=z,this.authCredentialsProvider=U,this.appCheckCredentialsProvider=s,this.listener=ee,this.state=0,this.Yo=0,this.Zo=null,this.Xo=null,this.stream=null,this.e_=0,this.t_=new g3(u,m)}n_(){return this.state===1||this.state===5||this.r_()}r_(){return this.state===2||this.state===3}start(){this.e_=0,this.state!==4?this.auth():this.i_()}async stop(){this.n_()&&await this.close(0)}s_(){this.state=0,this.t_.reset()}o_(){this.r_()&&this.Zo===null&&(this.Zo=this.ui.enqueueAfterDelay(this.Ho,6e4,(()=>this.__())))}a_(u){this.u_(),this.stream.send(u)}async __(){if(this.r_())return this.close(0)}u_(){this.Zo&&(this.Zo.cancel(),this.Zo=null)}c_(){this.Xo&&(this.Xo.cancel(),this.Xo=null)}async close(u,m){this.u_(),this.c_(),this.t_.cancel(),this.Yo++,u!==4?this.t_.reset():m&&m.code===pi.RESOURCE_EXHAUSTED?(gd(m.toString()),gd("Using maximum backoff delay to prevent overloading the backend."),this.t_.Wo()):m&&m.code===pi.UNAUTHENTICATED&&this.state!==3&&(this.authCredentialsProvider.invalidateToken(),this.appCheckCredentialsProvider.invalidateToken()),this.stream!==null&&(this.l_(),this.stream.close(),this.stream=null),this.state=u,await this.listener.mo(m)}l_(){}auth(){this.state=1;const u=this.h_(this.Yo),m=this.Yo;Promise.all([this.authCredentialsProvider.getToken(),this.appCheckCredentialsProvider.getToken()]).then((([E,A])=>{this.Yo===m&&this.P_(E,A)}),(E=>{u((()=>{const A=new yn(pi.UNKNOWN,"Fetching auth token failed: "+E.message);return this.I_(A)}))}))}P_(u,m){const E=this.h_(this.Yo);this.stream=this.T_(u,m),this.stream.Eo((()=>{E((()=>this.listener.Eo()))})),this.stream.Ro((()=>{E((()=>(this.state=2,this.Xo=this.ui.enqueueAfterDelay(this.Jo,1e4,(()=>(this.r_()&&(this.state=3),Promise.resolve()))),this.listener.Ro())))})),this.stream.mo((A=>{E((()=>this.I_(A)))})),this.stream.onMessage((A=>{E((()=>++this.e_==1?this.E_(A):this.onNext(A)))}))}i_(){this.state=5,this.t_.Go((async()=>{this.state=0,this.start()}))}I_(u){return sn("PersistentStream",`close with error: ${u}`),this.stream=null,this.close(4,u)}h_(u){return m=>{this.ui.enqueueAndForget((()=>this.Yo===u?m():(sn("PersistentStream","stream callback skipped by getCloseGuardedDispatcher."),Promise.resolve())))}}}class xR extends y3{constructor(u,m,E,A,z,U){super(u,"listen_stream_connection_backoff","listen_stream_idle","health_check_timeout",m,E,A,U),this.serializer=z}T_(u,m){return this.connection.Bo("Listen",u,m)}E_(u){return this.onNext(u)}onNext(u){this.t_.reset();const m=DP(this.serializer,u),E=(function(z){if(!("targetChange"in z))return hr.min();const U=z.targetChange;return U.targetIds&&U.targetIds.length?hr.min():U.readTime?Th(U.readTime):hr.min()})(u);return this.listener.d_(m,E)}A_(u){const m={};m.database=mv(this.serializer),m.addTarget=(function(z,U){let s;const ee=U.target;if(s=uv(ee)?{documents:zP(z,ee)}:{query:FP(z,ee)._t},s.targetId=U.targetId,U.resumeToken.approximateByteSize()>0){s.resumeToken=l3(z,U.resumeToken);const ne=dv(z,U.expectedCount);ne!==null&&(s.expectedCount=ne)}else if(U.snapshotVersion.compareTo(hr.min())>0){s.readTime=iy(z,U.snapshotVersion.toTimestamp());const ne=dv(z,U.expectedCount);ne!==null&&(s.expectedCount=ne)}return s})(this.serializer,u);const E=BP(this.serializer,u);E&&(m.labels=E),this.a_(m)}R_(u){const m={};m.database=mv(this.serializer),m.removeTarget=u,this.a_(m)}}class wR extends y3{constructor(u,m,E,A,z,U){super(u,"write_stream_connection_backoff","write_stream_idle","health_check_timeout",m,E,A,U),this.serializer=z}get V_(){return this.e_>0}start(){this.lastStreamToken=void 0,super.start()}l_(){this.V_&&this.m_([])}T_(u,m){return this.connection.Bo("Write",u,m)}E_(u){return _s(!!u.streamToken),this.lastStreamToken=u.streamToken,_s(!u.writeResults||u.writeResults.length===0),this.listener.f_()}onNext(u){_s(!!u.streamToken),this.lastStreamToken=u.streamToken,this.t_.reset();const m=kP(u.writeResults,u.commitTime),E=Th(u.commitTime);return this.listener.g_(E,m)}p_(){const u={};u.database=mv(this.serializer),this.a_(u)}m_(u){const m={streamToken:this.lastStreamToken,writes:u.map((E=>LP(this.serializer,E)))};this.a_(m)}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class bR extends class{}{constructor(u,m,E,A){super(),this.authCredentials=u,this.appCheckCredentials=m,this.connection=E,this.serializer=A,this.y_=!1}w_(){if(this.y_)throw new yn(pi.FAILED_PRECONDITION,"The client has already been terminated.")}Mo(u,m,E,A){return this.w_(),Promise.all([this.authCredentials.getToken(),this.appCheckCredentials.getToken()]).then((([z,U])=>this.connection.Mo(u,fv(m,E),A,z,U))).catch((z=>{throw z.name==="FirebaseError"?(z.code===pi.UNAUTHENTICATED&&(this.authCredentials.invalidateToken(),this.appCheckCredentials.invalidateToken()),z):new yn(pi.UNKNOWN,z.toString())}))}Lo(u,m,E,A,z){return this.w_(),Promise.all([this.authCredentials.getToken(),this.appCheckCredentials.getToken()]).then((([U,s])=>this.connection.Lo(u,fv(m,E),A,U,s,z))).catch((U=>{throw U.name==="FirebaseError"?(U.code===pi.UNAUTHENTICATED&&(this.authCredentials.invalidateToken(),this.appCheckCredentials.invalidateToken()),U):new yn(pi.UNKNOWN,U.toString())}))}terminate(){this.y_=!0,this.connection.terminate()}}class TR{constructor(u,m){this.asyncQueue=u,this.onlineStateHandler=m,this.state="Unknown",this.S_=0,this.b_=null,this.D_=!0}v_(){this.S_===0&&(this.C_("Unknown"),this.b_=this.asyncQueue.enqueueAfterDelay("online_state_timeout",1e4,(()=>(this.b_=null,this.F_("Backend didn't respond within 10 seconds."),this.C_("Offline"),Promise.resolve()))))}M_(u){this.state==="Online"?this.C_("Unknown"):(this.S_++,this.S_>=1&&(this.x_(),this.F_(`Connection failed 1 times. Most recent error: ${u.toString()}`),this.C_("Offline")))}set(u){this.x_(),this.S_=0,u==="Online"&&(this.D_=!1),this.C_(u)}C_(u){u!==this.state&&(this.state=u,this.onlineStateHandler(u))}F_(u){const m=`Could not reach Cloud Firestore backend. ${u}
This typically indicates that your device does not have a healthy Internet connection at the moment. The client will operate in offline mode until it is able to successfully connect to the backend.`;this.D_?(gd(m),this.D_=!1):sn("OnlineStateTracker",m)}x_(){this.b_!==null&&(this.b_.cancel(),this.b_=null)}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class ER{constructor(u,m,E,A,z){this.localStore=u,this.datastore=m,this.asyncQueue=E,this.remoteSyncer={},this.O_=[],this.N_=new Map,this.L_=new Set,this.B_=[],this.k_=z,this.k_._o((U=>{E.enqueueAndForget((async()=>{bp(this)&&(sn("RemoteStore","Restarting streams for network reachability change."),await(async function(ee){const ne=dr(ee);ne.L_.add(4),await B_(ne),ne.q_.set("Unknown"),ne.L_.delete(4),await gy(ne)})(this))}))})),this.q_=new TR(E,A)}}async function gy(x){if(bp(x))for(const u of x.B_)await u(!0)}async function B_(x){for(const u of x.B_)await u(!1)}function v3(x,u){const m=dr(x);m.N_.has(u.targetId)||(m.N_.set(u.targetId,u),Wv(m)?$v(m):ym(m).r_()&&qv(m,u))}function Hv(x,u){const m=dr(x),E=ym(m);m.N_.delete(u),E.r_()&&x3(m,u),m.N_.size===0&&(E.r_()?E.o_():bp(m)&&m.q_.set("Unknown"))}function qv(x,u){if(x.Q_.xe(u.targetId),u.resumeToken.approximateByteSize()>0||u.snapshotVersion.compareTo(hr.min())>0){const m=x.remoteSyncer.getRemoteKeysForTarget(u.targetId).size;u=u.withExpectedCount(m)}ym(x).A_(u)}function x3(x,u){x.Q_.xe(u),ym(x).R_(u)}function $v(x){x.Q_=new SP({getRemoteKeysForTarget:u=>x.remoteSyncer.getRemoteKeysForTarget(u),ot:u=>x.N_.get(u)||null,tt:()=>x.datastore.serializer.databaseId}),ym(x).start(),x.q_.v_()}function Wv(x){return bp(x)&&!ym(x).n_()&&x.N_.size>0}function bp(x){return dr(x).L_.size===0}function w3(x){x.Q_=void 0}async function SR(x){x.q_.set("Online")}async function IR(x){x.N_.forEach(((u,m)=>{qv(x,u)}))}async function AR(x,u){w3(x),Wv(x)?(x.q_.M_(u),$v(x)):x.q_.set("Unknown")}async function CR(x,u,m){if(x.q_.set("Online"),u instanceof a3&&u.state===2&&u.cause)try{await(async function(A,z){const U=z.cause;for(const s of z.targetIds)A.N_.has(s)&&(await A.remoteSyncer.rejectListen(s,U),A.N_.delete(s),A.Q_.removeTarget(s))})(x,u)}catch(E){sn("RemoteStore","Failed to remove targets %s: %s ",u.targetIds.join(","),E),await ny(x,E)}else if(u instanceof $g?x.Q_.Ke(u):u instanceof o3?x.Q_.He(u):x.Q_.We(u),!m.isEqual(hr.min()))try{const E=await _3(x.localStore);m.compareTo(E)>=0&&await(function(z,U){const s=z.Q_.rt(U);return s.targetChanges.forEach(((ee,ne)=>{if(ee.resumeToken.approximateByteSize()>0){const Ie=z.N_.get(ne);Ie&&z.N_.set(ne,Ie.withResumeToken(ee.resumeToken,U))}})),s.targetMismatches.forEach(((ee,ne)=>{const Ie=z.N_.get(ee);if(!Ie)return;z.N_.set(ee,Ie.withResumeToken(za.EMPTY_BYTE_STRING,Ie.snapshotVersion)),x3(z,ee);const qe=new bf(Ie.target,ee,ne,Ie.sequenceNumber);qv(z,qe)})),z.remoteSyncer.applyRemoteEvent(s)})(x,m)}catch(E){sn("RemoteStore","Failed to raise snapshot:",E),await ny(x,E)}}async function ny(x,u,m){if(!z_(u))throw u;x.L_.add(1),await B_(x),x.q_.set("Offline"),m||(m=()=>_3(x.localStore)),x.asyncQueue.enqueueRetryable((async()=>{sn("RemoteStore","Retrying IndexedDB access"),await m(),x.L_.delete(1),await gy(x)}))}function b3(x,u){return u().catch((m=>ny(x,m,u)))}async function yy(x){const u=dr(x),m=Pf(u);let E=u.O_.length>0?u.O_[u.O_.length-1].batchId:-1;for(;PR(u);)try{const A=await dR(u.localStore,E);if(A===null){u.O_.length===0&&m.o_();break}E=A.batchId,RR(u,A)}catch(A){await ny(u,A)}T3(u)&&E3(u)}function PR(x){return bp(x)&&x.O_.length<10}function RR(x,u){x.O_.push(u);const m=Pf(x);m.r_()&&m.V_&&m.m_(u.mutations)}function T3(x){return bp(x)&&!Pf(x).n_()&&x.O_.length>0}function E3(x){Pf(x).start()}async function MR(x){Pf(x).p_()}async function DR(x){const u=Pf(x);for(const m of x.O_)u.m_(m.mutations)}async function LR(x,u,m){const E=x.O_.shift(),A=Bv.from(E,u,m);await b3(x,(()=>x.remoteSyncer.applySuccessfulWrite(A))),await yy(x)}async function kR(x,u){u&&Pf(x).V_&&await(async function(E,A){if((function(U){return bP(U)&&U!==pi.ABORTED})(A.code)){const z=E.O_.shift();Pf(E).s_(),await b3(E,(()=>E.remoteSyncer.rejectFailedWrite(z.batchId,A))),await yy(E)}})(x,u),T3(x)&&E3(x)}async function F2(x,u){const m=dr(x);m.asyncQueue.verifyOperationInProgress(),sn("RemoteStore","RemoteStore received new credentials");const E=bp(m);m.L_.add(3),await B_(m),E&&m.q_.set("Unknown"),await m.remoteSyncer.handleCredentialChange(u),m.L_.delete(3),await gy(m)}async function zR(x,u){const m=dr(x);u?(m.L_.delete(2),await gy(m)):u||(m.L_.add(2),await B_(m),m.q_.set("Unknown"))}function ym(x){return x.K_||(x.K_=(function(m,E,A){const z=dr(m);return z.w_(),new xR(E,z.connection,z.authCredentials,z.appCheckCredentials,z.serializer,A)})(x.datastore,x.asyncQueue,{Eo:SR.bind(null,x),Ro:IR.bind(null,x),mo:AR.bind(null,x),d_:CR.bind(null,x)}),x.B_.push((async u=>{u?(x.K_.s_(),Wv(x)?$v(x):x.q_.set("Unknown")):(await x.K_.stop(),w3(x))}))),x.K_}function Pf(x){return x.U_||(x.U_=(function(m,E,A){const z=dr(m);return z.w_(),new wR(E,z.connection,z.authCredentials,z.appCheckCredentials,z.serializer,A)})(x.datastore,x.asyncQueue,{Eo:()=>Promise.resolve(),Ro:MR.bind(null,x),mo:kR.bind(null,x),f_:DR.bind(null,x),g_:LR.bind(null,x)}),x.B_.push((async u=>{u?(x.U_.s_(),await yy(x)):(await x.U_.stop(),x.O_.length>0&&(sn("RemoteStore",`Stopping write stream with ${x.O_.length} pending writes`),x.O_=[]))}))),x.U_}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Zv{constructor(u,m,E,A,z){this.asyncQueue=u,this.timerId=m,this.targetTimeMs=E,this.op=A,this.removalCallback=z,this.deferred=new Sf,this.then=this.deferred.promise.then.bind(this.deferred.promise),this.deferred.promise.catch((U=>{}))}get promise(){return this.deferred.promise}static createAndSchedule(u,m,E,A,z){const U=Date.now()+E,s=new Zv(u,m,U,A,z);return s.start(E),s}start(u){this.timerHandle=setTimeout((()=>this.handleDelayElapsed()),u)}skipDelay(){return this.handleDelayElapsed()}cancel(u){this.timerHandle!==null&&(this.clearTimeout(),this.deferred.reject(new yn(pi.CANCELLED,"Operation cancelled"+(u?": "+u:""))))}handleDelayElapsed(){this.asyncQueue.enqueueAndForget((()=>this.timerHandle!==null?(this.clearTimeout(),this.op().then((u=>this.deferred.resolve(u)))):Promise.resolve()))}clearTimeout(){this.timerHandle!==null&&(this.removalCallback(this),clearTimeout(this.timerHandle),this.timerHandle=null)}}function Xv(x,u){if(gd("AsyncQueue",`${u}: ${x}`),z_(x))return new yn(pi.UNAVAILABLE,`${u}: ${x}`);throw x}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class sm{constructor(u){this.comparator=u?(m,E)=>u(m,E)||Vn.comparator(m.key,E.key):(m,E)=>Vn.comparator(m.key,E.key),this.keyedMap=d_(),this.sortedSet=new oo(this.comparator)}static emptySet(u){return new sm(u.comparator)}has(u){return this.keyedMap.get(u)!=null}get(u){return this.keyedMap.get(u)}first(){return this.sortedSet.minKey()}last(){return this.sortedSet.maxKey()}isEmpty(){return this.sortedSet.isEmpty()}indexOf(u){const m=this.keyedMap.get(u);return m?this.sortedSet.indexOf(m):-1}get size(){return this.sortedSet.size}forEach(u){this.sortedSet.inorderTraversal(((m,E)=>(u(m),!1)))}add(u){const m=this.delete(u.key);return m.copy(m.keyedMap.insert(u.key,u),m.sortedSet.insert(u,null))}delete(u){const m=this.get(u);return m?this.copy(this.keyedMap.remove(u),this.sortedSet.remove(m)):this}isEqual(u){if(!(u instanceof sm)||this.size!==u.size)return!1;const m=this.sortedSet.getIterator(),E=u.sortedSet.getIterator();for(;m.hasNext();){const A=m.getNext().key,z=E.getNext().key;if(!A.isEqual(z))return!1}return!0}toString(){const u=[];return this.forEach((m=>{u.push(m.toString())})),u.length===0?"DocumentSet ()":`DocumentSet (
  `+u.join(`  
`)+`
)`}copy(u,m){const E=new sm;return E.comparator=this.comparator,E.keyedMap=u,E.sortedSet=m,E}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class O2{constructor(){this.W_=new oo(Vn.comparator)}track(u){const m=u.doc.key,E=this.W_.get(m);E?u.type!==0&&E.type===3?this.W_=this.W_.insert(m,u):u.type===3&&E.type!==1?this.W_=this.W_.insert(m,{type:E.type,doc:u.doc}):u.type===2&&E.type===2?this.W_=this.W_.insert(m,{type:2,doc:u.doc}):u.type===2&&E.type===0?this.W_=this.W_.insert(m,{type:0,doc:u.doc}):u.type===1&&E.type===0?this.W_=this.W_.remove(m):u.type===1&&E.type===2?this.W_=this.W_.insert(m,{type:1,doc:E.doc}):u.type===0&&E.type===1?this.W_=this.W_.insert(m,{type:2,doc:u.doc}):ir():this.W_=this.W_.insert(m,u)}G_(){const u=[];return this.W_.inorderTraversal(((m,E)=>{u.push(E)})),u}}class hm{constructor(u,m,E,A,z,U,s,ee,ne){this.query=u,this.docs=m,this.oldDocs=E,this.docChanges=A,this.mutatedKeys=z,this.fromCache=U,this.syncStateChanged=s,this.excludesMetadataChanges=ee,this.hasCachedResults=ne}static fromInitialDocuments(u,m,E,A,z){const U=[];return m.forEach((s=>{U.push({type:0,doc:s})})),new hm(u,m,sm.emptySet(m),U,E,A,!0,!1,z)}get hasPendingWrites(){return!this.mutatedKeys.isEmpty()}isEqual(u){if(!(this.fromCache===u.fromCache&&this.hasCachedResults===u.hasCachedResults&&this.syncStateChanged===u.syncStateChanged&&this.mutatedKeys.isEqual(u.mutatedKeys)&&hy(this.query,u.query)&&this.docs.isEqual(u.docs)&&this.oldDocs.isEqual(u.oldDocs)))return!1;const m=this.docChanges,E=u.docChanges;if(m.length!==E.length)return!1;for(let A=0;A<m.length;A++)if(m[A].type!==E[A].type||!m[A].doc.isEqual(E[A].doc))return!1;return!0}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class FR{constructor(){this.z_=void 0,this.j_=[]}H_(){return this.j_.some((u=>u.J_()))}}class OR{constructor(){this.queries=B2(),this.onlineState="Unknown",this.Y_=new Set}terminate(){(function(m,E){const A=dr(m),z=A.queries;A.queries=B2(),z.forEach(((U,s)=>{for(const ee of s.j_)ee.onError(E)}))})(this,new yn(pi.ABORTED,"Firestore shutting down"))}}function B2(){return new gm((x=>WT(x)),hy)}async function BR(x,u){const m=dr(x);let E=3;const A=u.query;let z=m.queries.get(A);z?!z.H_()&&u.J_()&&(E=2):(z=new FR,E=u.J_()?0:1);try{switch(E){case 0:z.z_=await m.onListen(A,!0);break;case 1:z.z_=await m.onListen(A,!1);break;case 2:await m.onFirstRemoteStoreListen(A)}}catch(U){const s=Xv(U,`Initialization of query '${tm(u.query)}' failed`);return void u.onError(s)}m.queries.set(A,z),z.j_.push(u),u.Z_(m.onlineState),z.z_&&u.X_(z.z_)&&Kv(m)}async function NR(x,u){const m=dr(x),E=u.query;let A=3;const z=m.queries.get(E);if(z){const U=z.j_.indexOf(u);U>=0&&(z.j_.splice(U,1),z.j_.length===0?A=u.J_()?0:1:!z.H_()&&u.J_()&&(A=2))}switch(A){case 0:return m.queries.delete(E),m.onUnlisten(E,!0);case 1:return m.queries.delete(E),m.onUnlisten(E,!1);case 2:return m.onLastRemoteStoreUnlisten(E);default:return}}function VR(x,u){const m=dr(x);let E=!1;for(const A of u){const z=A.query,U=m.queries.get(z);if(U){for(const s of U.j_)s.X_(A)&&(E=!0);U.z_=A}}E&&Kv(m)}function UR(x,u,m){const E=dr(x),A=E.queries.get(u);if(A)for(const z of A.j_)z.onError(m);E.queries.delete(u)}function Kv(x){x.Y_.forEach((u=>{u.next()}))}var gv,N2;(N2=gv||(gv={})).ea="default",N2.Cache="cache";class jR{constructor(u,m,E){this.query=u,this.ta=m,this.na=!1,this.ra=null,this.onlineState="Unknown",this.options=E||{}}X_(u){if(!this.options.includeMetadataChanges){const E=[];for(const A of u.docChanges)A.type!==3&&E.push(A);u=new hm(u.query,u.docs,u.oldDocs,E,u.mutatedKeys,u.fromCache,u.syncStateChanged,!0,u.hasCachedResults)}let m=!1;return this.na?this.ia(u)&&(this.ta.next(u),m=!0):this.sa(u,this.onlineState)&&(this.oa(u),m=!0),this.ra=u,m}onError(u){this.ta.error(u)}Z_(u){this.onlineState=u;let m=!1;return this.ra&&!this.na&&this.sa(this.ra,u)&&(this.oa(this.ra),m=!0),m}sa(u,m){if(!u.fromCache||!this.J_())return!0;const E=m!=="Offline";return(!this.options._a||!E)&&(!u.docs.isEmpty()||u.hasCachedResults||m==="Offline")}ia(u){if(u.docChanges.length>0)return!0;const m=this.ra&&this.ra.hasPendingWrites!==u.hasPendingWrites;return!(!u.syncStateChanged&&!m)&&this.options.includeMetadataChanges===!0}oa(u){u=hm.fromInitialDocuments(u.query,u.docs,u.mutatedKeys,u.fromCache,u.hasCachedResults),this.na=!0,this.ta.next(u)}J_(){return this.options.source!==gv.Cache}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class S3{constructor(u){this.key=u}}class I3{constructor(u){this.key=u}}class GR{constructor(u,m){this.query=u,this.Ta=m,this.Ea=null,this.hasCachedResults=!1,this.current=!1,this.da=Br(),this.mutatedKeys=Br(),this.Aa=ZT(u),this.Ra=new sm(this.Aa)}get Va(){return this.Ta}ma(u,m){const E=m?m.fa:new O2,A=m?m.Ra:this.Ra;let z=m?m.mutatedKeys:this.mutatedKeys,U=A,s=!1;const ee=this.query.limitType==="F"&&A.size===this.query.limit?A.last():null,ne=this.query.limitType==="L"&&A.size===this.query.limit?A.first():null;if(u.inorderTraversal(((Ie,qe)=>{const Xe=A.get(Ie),St=dy(this.query,qe)?qe:null,$t=!!Xe&&this.mutatedKeys.has(Xe.key),ct=!!St&&(St.hasLocalMutations||this.mutatedKeys.has(St.key)&&St.hasCommittedMutations);let wt=!1;Xe&&St?Xe.data.isEqual(St.data)?$t!==ct&&(E.track({type:3,doc:St}),wt=!0):this.ga(Xe,St)||(E.track({type:2,doc:St}),wt=!0,(ee&&this.Aa(St,ee)>0||ne&&this.Aa(St,ne)<0)&&(s=!0)):!Xe&&St?(E.track({type:0,doc:St}),wt=!0):Xe&&!St&&(E.track({type:1,doc:Xe}),wt=!0,(ee||ne)&&(s=!0)),wt&&(St?(U=U.add(St),z=ct?z.add(Ie):z.delete(Ie)):(U=U.delete(Ie),z=z.delete(Ie)))})),this.query.limit!==null)for(;U.size>this.query.limit;){const Ie=this.query.limitType==="F"?U.last():U.first();U=U.delete(Ie.key),z=z.delete(Ie.key),E.track({type:1,doc:Ie})}return{Ra:U,fa:E,ns:s,mutatedKeys:z}}ga(u,m){return u.hasLocalMutations&&m.hasCommittedMutations&&!m.hasLocalMutations}applyChanges(u,m,E,A){const z=this.Ra;this.Ra=u.Ra,this.mutatedKeys=u.mutatedKeys;const U=u.fa.G_();U.sort(((Ie,qe)=>(function(St,$t){const ct=wt=>{switch(wt){case 0:return 1;case 2:case 3:return 2;case 1:return 0;default:return ir()}};return ct(St)-ct($t)})(Ie.type,qe.type)||this.Aa(Ie.doc,qe.doc))),this.pa(E),A=A!=null&&A;const s=m&&!A?this.ya():[],ee=this.da.size===0&&this.current&&!A?1:0,ne=ee!==this.Ea;return this.Ea=ee,U.length!==0||ne?{snapshot:new hm(this.query,u.Ra,z,U,u.mutatedKeys,ee===0,ne,!1,!!E&&E.resumeToken.approximateByteSize()>0),wa:s}:{wa:s}}Z_(u){return this.current&&u==="Offline"?(this.current=!1,this.applyChanges({Ra:this.Ra,fa:new O2,mutatedKeys:this.mutatedKeys,ns:!1},!1)):{wa:[]}}Sa(u){return!this.Ta.has(u)&&!!this.Ra.has(u)&&!this.Ra.get(u).hasLocalMutations}pa(u){u&&(u.addedDocuments.forEach((m=>this.Ta=this.Ta.add(m))),u.modifiedDocuments.forEach((m=>{})),u.removedDocuments.forEach((m=>this.Ta=this.Ta.delete(m))),this.current=u.current)}ya(){if(!this.current)return[];const u=this.da;this.da=Br(),this.Ra.forEach((E=>{this.Sa(E.key)&&(this.da=this.da.add(E.key))}));const m=[];return u.forEach((E=>{this.da.has(E)||m.push(new I3(E))})),this.da.forEach((E=>{u.has(E)||m.push(new S3(E))})),m}ba(u){this.Ta=u.Ts,this.da=Br();const m=this.ma(u.documents);return this.applyChanges(m,!0)}Da(){return hm.fromInitialDocuments(this.query,this.Ra,this.mutatedKeys,this.Ea===0,this.hasCachedResults)}}class HR{constructor(u,m,E){this.query=u,this.targetId=m,this.view=E}}class qR{constructor(u){this.key=u,this.va=!1}}class $R{constructor(u,m,E,A,z,U){this.localStore=u,this.remoteStore=m,this.eventManager=E,this.sharedClientState=A,this.currentUser=z,this.maxConcurrentLimboResolutions=U,this.Ca={},this.Fa=new gm((s=>WT(s)),hy),this.Ma=new Map,this.xa=new Set,this.Oa=new oo(Vn.comparator),this.Na=new Map,this.La=new Uv,this.Ba={},this.ka=new Map,this.qa=um.kn(),this.onlineState="Unknown",this.Qa=void 0}get isPrimaryClient(){return this.Qa===!0}}async function WR(x,u,m=!0){const E=D3(x);let A;const z=E.Fa.get(u);return z?(E.sharedClientState.addLocalQueryTarget(z.targetId),A=z.view.Da()):A=await A3(E,u,m,!0),A}async function ZR(x,u){const m=D3(x);await A3(m,u,!0,!1)}async function A3(x,u,m,E){const A=await fR(x.localStore,bh(u)),z=A.targetId,U=x.sharedClientState.addLocalQueryTarget(z,m);let s;return E&&(s=await XR(x,u,z,U==="current",A.resumeToken)),x.isPrimaryClient&&m&&v3(x.remoteStore,A),s}async function XR(x,u,m,E,A){x.Ka=(qe,Xe,St)=>(async function(ct,wt,Nt,Ti){let Ei=wt.view.ma(Nt);Ei.ns&&(Ei=await L2(ct.localStore,wt.query,!1).then((({documents:rt})=>wt.view.ma(rt,Ei))));const en=Ti&&Ti.targetChanges.get(wt.targetId),Hn=Ti&&Ti.targetMismatches.get(wt.targetId)!=null,_n=wt.view.applyChanges(Ei,ct.isPrimaryClient,en,Hn);return U2(ct,wt.targetId,_n.wa),_n.snapshot})(x,qe,Xe,St);const z=await L2(x.localStore,u,!0),U=new GR(u,z.Ts),s=U.ma(z.documents),ee=O_.createSynthesizedTargetChangeForCurrentChange(m,E&&x.onlineState!=="Offline",A),ne=U.applyChanges(s,x.isPrimaryClient,ee);U2(x,m,ne.wa);const Ie=new HR(u,m,U);return x.Fa.set(u,Ie),x.Ma.has(m)?x.Ma.get(m).push(u):x.Ma.set(m,[u]),ne.snapshot}async function KR(x,u,m){const E=dr(x),A=E.Fa.get(u),z=E.Ma.get(A.targetId);if(z.length>1)return E.Ma.set(A.targetId,z.filter((U=>!hy(U,u)))),void E.Fa.delete(u);E.isPrimaryClient?(E.sharedClientState.removeLocalQueryTarget(A.targetId),E.sharedClientState.isActiveQueryTarget(A.targetId)||await _v(E.localStore,A.targetId,!1).then((()=>{E.sharedClientState.clearQueryState(A.targetId),m&&Hv(E.remoteStore,A.targetId),yv(E,A.targetId)})).catch(k_)):(yv(E,A.targetId),await _v(E.localStore,A.targetId,!0))}async function YR(x,u){const m=dr(x),E=m.Fa.get(u),A=m.Ma.get(E.targetId);m.isPrimaryClient&&A.length===1&&(m.sharedClientState.removeLocalQueryTarget(E.targetId),Hv(m.remoteStore,E.targetId))}async function QR(x,u,m){const E=s9(x);try{const A=await(function(U,s){const ee=dr(U),ne=Ko.now(),Ie=s.reduce(((St,$t)=>St.add($t.key)),Br());let qe,Xe;return ee.persistence.runTransaction("Locally write mutations","readwrite",(St=>{let $t=yd(),ct=Br();return ee.cs.getEntries(St,Ie).next((wt=>{$t=wt,$t.forEach(((Nt,Ti)=>{Ti.isValidDocument()||(ct=ct.add(Nt))}))})).next((()=>ee.localDocuments.getOverlayedDocuments(St,$t))).next((wt=>{qe=wt;const Nt=[];for(const Ti of s){const Ei=gP(Ti,qe.get(Ti.key).overlayedDocument);Ei!=null&&Nt.push(new Rf(Ti.key,Ei,NT(Ei.value.mapValue),Ic.exists(!0)))}return ee.mutationQueue.addMutationBatch(St,ne,Nt,s)})).next((wt=>{Xe=wt;const Nt=wt.applyToLocalDocumentSet(qe,ct);return ee.documentOverlayCache.saveOverlays(St,wt.batchId,Nt)}))})).then((()=>({batchId:Xe.batchId,changes:KT(qe)})))})(E.localStore,u);E.sharedClientState.addPendingMutation(A.batchId),(function(U,s,ee){let ne=U.Ba[U.currentUser.toKey()];ne||(ne=new oo(is)),ne=ne.insert(s,ee),U.Ba[U.currentUser.toKey()]=ne})(E,A.batchId,m),await N_(E,A.changes),await yy(E.remoteStore)}catch(A){const z=Xv(A,"Failed to persist write");m.reject(z)}}async function C3(x,u){const m=dr(x);try{const E=await uR(m.localStore,u);u.targetChanges.forEach(((A,z)=>{const U=m.Na.get(z);U&&(_s(A.addedDocuments.size+A.modifiedDocuments.size+A.removedDocuments.size<=1),A.addedDocuments.size>0?U.va=!0:A.modifiedDocuments.size>0?_s(U.va):A.removedDocuments.size>0&&(_s(U.va),U.va=!1))})),await N_(m,E,u)}catch(E){await k_(E)}}function V2(x,u,m){const E=dr(x);if(E.isPrimaryClient&&m===0||!E.isPrimaryClient&&m===1){const A=[];E.Fa.forEach(((z,U)=>{const s=U.view.Z_(u);s.snapshot&&A.push(s.snapshot)})),(function(U,s){const ee=dr(U);ee.onlineState=s;let ne=!1;ee.queries.forEach(((Ie,qe)=>{for(const Xe of qe.j_)Xe.Z_(s)&&(ne=!0)})),ne&&Kv(ee)})(E.eventManager,u),A.length&&E.Ca.d_(A),E.onlineState=u,E.isPrimaryClient&&E.sharedClientState.setOnlineState(u)}}async function JR(x,u,m){const E=dr(x);E.sharedClientState.updateQueryState(u,"rejected",m);const A=E.Na.get(u),z=A&&A.key;if(z){let U=new oo(Vn.comparator);U=U.insert(z,sl.newNoDocument(z,hr.min()));const s=Br().add(z),ee=new my(hr.min(),new Map,new oo(is),U,s);await C3(E,ee),E.Oa=E.Oa.remove(z),E.Na.delete(u),Yv(E)}else await _v(E.localStore,u,!1).then((()=>yv(E,u,m))).catch(k_)}async function e9(x,u){const m=dr(x),E=u.batch.batchId;try{const A=await cR(m.localStore,u);R3(m,E,null),P3(m,E),m.sharedClientState.updateMutationState(E,"acknowledged"),await N_(m,A)}catch(A){await k_(A)}}async function t9(x,u,m){const E=dr(x);try{const A=await(function(U,s){const ee=dr(U);return ee.persistence.runTransaction("Reject batch","readwrite-primary",(ne=>{let Ie;return ee.mutationQueue.lookupMutationBatch(ne,s).next((qe=>(_s(qe!==null),Ie=qe.keys(),ee.mutationQueue.removeMutationBatch(ne,qe)))).next((()=>ee.mutationQueue.performConsistencyCheck(ne))).next((()=>ee.documentOverlayCache.removeOverlaysForBatchId(ne,Ie,s))).next((()=>ee.localDocuments.recalculateAndSaveOverlaysForDocumentKeys(ne,Ie))).next((()=>ee.localDocuments.getDocuments(ne,Ie)))}))})(E.localStore,u);R3(E,u,m),P3(E,u),E.sharedClientState.updateMutationState(u,"rejected",m),await N_(E,A)}catch(A){await k_(A)}}function P3(x,u){(x.ka.get(u)||[]).forEach((m=>{m.resolve()})),x.ka.delete(u)}function R3(x,u,m){const E=dr(x);let A=E.Ba[E.currentUser.toKey()];if(A){const z=A.get(u);z&&(m?z.reject(m):z.resolve(),A=A.remove(u)),E.Ba[E.currentUser.toKey()]=A}}function yv(x,u,m=null){x.sharedClientState.removeLocalQueryTarget(u);for(const E of x.Ma.get(u))x.Fa.delete(E),m&&x.Ca.$a(E,m);x.Ma.delete(u),x.isPrimaryClient&&x.La.gr(u).forEach((E=>{x.La.containsKey(E)||M3(x,E)}))}function M3(x,u){x.xa.delete(u.path.canonicalString());const m=x.Oa.get(u);m!==null&&(Hv(x.remoteStore,m),x.Oa=x.Oa.remove(u),x.Na.delete(m),Yv(x))}function U2(x,u,m){for(const E of m)E instanceof S3?(x.La.addReference(E.key,u),i9(x,E)):E instanceof I3?(sn("SyncEngine","Document no longer in limbo: "+E.key),x.La.removeReference(E.key,u),x.La.containsKey(E.key)||M3(x,E.key)):ir()}function i9(x,u){const m=u.key,E=m.path.canonicalString();x.Oa.get(m)||x.xa.has(E)||(sn("SyncEngine","New document in limbo: "+m),x.xa.add(E),Yv(x))}function Yv(x){for(;x.xa.size>0&&x.Oa.size<x.maxConcurrentLimboResolutions;){const u=x.xa.values().next().value;x.xa.delete(u);const m=new Vn(Zs.fromString(u)),E=x.qa.next();x.Na.set(E,new qR(m)),x.Oa=x.Oa.insert(m,E),v3(x.remoteStore,new bf(bh($T(m.path)),E,"TargetPurposeLimboResolution",Rv.oe))}}async function N_(x,u,m){const E=dr(x),A=[],z=[],U=[];E.Fa.isEmpty()||(E.Fa.forEach(((s,ee)=>{U.push(E.Ka(ee,u,m).then((ne=>{var Ie;if((ne||m)&&E.isPrimaryClient){const qe=ne?!ne.fromCache:(Ie=m?.targetChanges.get(ee.targetId))===null||Ie===void 0?void 0:Ie.current;E.sharedClientState.updateQueryState(ee.targetId,qe?"current":"not-current")}if(ne){A.push(ne);const qe=Gv.Wi(ee.targetId,ne);z.push(qe)}})))})),await Promise.all(U),E.Ca.d_(A),await(async function(ee,ne){const Ie=dr(ee);try{await Ie.persistence.runTransaction("notifyLocalViewChanges","readwrite",(qe=>mi.forEach(ne,(Xe=>mi.forEach(Xe.$i,(St=>Ie.persistence.referenceDelegate.addReference(qe,Xe.targetId,St))).next((()=>mi.forEach(Xe.Ui,(St=>Ie.persistence.referenceDelegate.removeReference(qe,Xe.targetId,St)))))))))}catch(qe){if(!z_(qe))throw qe;sn("LocalStore","Failed to update sequence numbers: "+qe)}for(const qe of ne){const Xe=qe.targetId;if(!qe.fromCache){const St=Ie.os.get(Xe),$t=St.snapshotVersion,ct=St.withLastLimboFreeSnapshotVersion($t);Ie.os=Ie.os.insert(Xe,ct)}}})(E.localStore,z))}async function n9(x,u){const m=dr(x);if(!m.currentUser.isEqual(u)){sn("SyncEngine","User change. New user:",u.toKey());const E=await m3(m.localStore,u);m.currentUser=u,(function(z,U){z.ka.forEach((s=>{s.forEach((ee=>{ee.reject(new yn(pi.CANCELLED,U))}))})),z.ka.clear()})(m,"'waitForPendingWrites' promise is rejected due to a user change."),m.sharedClientState.handleUserChange(u,E.removedBatchIds,E.addedBatchIds),await N_(m,E.hs)}}function r9(x,u){const m=dr(x),E=m.Na.get(u);if(E&&E.va)return Br().add(E.key);{let A=Br();const z=m.Ma.get(u);if(!z)return A;for(const U of z){const s=m.Fa.get(U);A=A.unionWith(s.view.Va)}return A}}function D3(x){const u=dr(x);return u.remoteStore.remoteSyncer.applyRemoteEvent=C3.bind(null,u),u.remoteStore.remoteSyncer.getRemoteKeysForTarget=r9.bind(null,u),u.remoteStore.remoteSyncer.rejectListen=JR.bind(null,u),u.Ca.d_=VR.bind(null,u.eventManager),u.Ca.$a=UR.bind(null,u.eventManager),u}function s9(x){const u=dr(x);return u.remoteStore.remoteSyncer.applySuccessfulWrite=e9.bind(null,u),u.remoteStore.remoteSyncer.rejectFailedWrite=t9.bind(null,u),u}class ry{constructor(){this.kind="memory",this.synchronizeTabs=!1}async initialize(u){this.serializer=_y(u.databaseInfo.databaseId),this.sharedClientState=this.Wa(u),this.persistence=this.Ga(u),await this.persistence.start(),this.localStore=this.za(u),this.gcScheduler=this.ja(u,this.localStore),this.indexBackfillerScheduler=this.Ha(u,this.localStore)}ja(u,m){return null}Ha(u,m){return null}za(u){return lR(this.persistence,new oR,u.initialUser,this.serializer)}Ga(u){return new nR(jv.Zr,this.serializer)}Wa(u){return new mR}async terminate(){var u,m;(u=this.gcScheduler)===null||u===void 0||u.stop(),(m=this.indexBackfillerScheduler)===null||m===void 0||m.stop(),this.sharedClientState.shutdown(),await this.persistence.shutdown()}}ry.provider={build:()=>new ry};class vv{async initialize(u,m){this.localStore||(this.localStore=u.localStore,this.sharedClientState=u.sharedClientState,this.datastore=this.createDatastore(m),this.remoteStore=this.createRemoteStore(m),this.eventManager=this.createEventManager(m),this.syncEngine=this.createSyncEngine(m,!u.synchronizeTabs),this.sharedClientState.onlineStateHandler=E=>V2(this.syncEngine,E,1),this.remoteStore.remoteSyncer.handleCredentialChange=n9.bind(null,this.syncEngine),await zR(this.remoteStore,this.syncEngine.isPrimaryClient))}createEventManager(u){return(function(){return new OR})()}createDatastore(u){const m=_y(u.databaseInfo.databaseId),E=(function(z){return new vR(z)})(u.databaseInfo);return(function(z,U,s,ee){return new bR(z,U,s,ee)})(u.authCredentials,u.appCheckCredentials,E,m)}createRemoteStore(u){return(function(E,A,z,U,s){return new ER(E,A,z,U,s)})(this.localStore,this.datastore,u.asyncQueue,(m=>V2(this.syncEngine,m,0)),(function(){return z2.D()?new z2:new _R})())}createSyncEngine(u,m){return(function(A,z,U,s,ee,ne,Ie){const qe=new $R(A,z,U,s,ee,ne);return Ie&&(qe.Qa=!0),qe})(this.localStore,this.remoteStore,this.eventManager,this.sharedClientState,u.initialUser,u.maxConcurrentLimboResolutions,m)}async terminate(){var u,m;await(async function(A){const z=dr(A);sn("RemoteStore","RemoteStore shutting down."),z.L_.add(5),await B_(z),z.k_.shutdown(),z.q_.set("Unknown")})(this.remoteStore),(u=this.datastore)===null||u===void 0||u.terminate(),(m=this.eventManager)===null||m===void 0||m.terminate()}}vv.provider={build:()=>new vv};/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *//**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class o9{constructor(u){this.observer=u,this.muted=!1}next(u){this.muted||this.observer.next&&this.Ya(this.observer.next,u)}error(u){this.muted||(this.observer.error?this.Ya(this.observer.error,u):gd("Uncaught Error in snapshot listener:",u.toString()))}Za(){this.muted=!0}Ya(u,m){setTimeout((()=>{this.muted||u(m)}),0)}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class a9{constructor(u,m,E,A,z){this.authCredentials=u,this.appCheckCredentials=m,this.asyncQueue=E,this.databaseInfo=A,this.user=rl.UNAUTHENTICATED,this.clientId=FT.newId(),this.authCredentialListener=()=>Promise.resolve(),this.appCheckCredentialListener=()=>Promise.resolve(),this._uninitializedComponentsProvider=z,this.authCredentials.start(E,(async U=>{sn("FirestoreClient","Received user=",U.uid),await this.authCredentialListener(U),this.user=U})),this.appCheckCredentials.start(E,(U=>(sn("FirestoreClient","Received new app check token=",U),this.appCheckCredentialListener(U,this.user))))}get configuration(){return{asyncQueue:this.asyncQueue,databaseInfo:this.databaseInfo,clientId:this.clientId,authCredentials:this.authCredentials,appCheckCredentials:this.appCheckCredentials,initialUser:this.user,maxConcurrentLimboResolutions:100}}setCredentialChangeListener(u){this.authCredentialListener=u}setAppCheckTokenChangeListener(u){this.appCheckCredentialListener=u}terminate(){this.asyncQueue.enterRestrictedMode();const u=new Sf;return this.asyncQueue.enqueueAndForgetEvenWhileRestricted((async()=>{try{this._onlineComponents&&await this._onlineComponents.terminate(),this._offlineComponents&&await this._offlineComponents.terminate(),this.authCredentials.shutdown(),this.appCheckCredentials.shutdown(),u.resolve()}catch(m){const E=Xv(m,"Failed to shutdown persistence");u.reject(E)}})),u.promise}}async function X0(x,u){x.asyncQueue.verifyOperationInProgress(),sn("FirestoreClient","Initializing OfflineComponentProvider");const m=x.configuration;await u.initialize(m);let E=m.initialUser;x.setCredentialChangeListener((async A=>{E.isEqual(A)||(await m3(u.localStore,A),E=A)})),u.persistence.setDatabaseDeletedListener((()=>x.terminate())),x._offlineComponents=u}async function j2(x,u){x.asyncQueue.verifyOperationInProgress();const m=await l9(x);sn("FirestoreClient","Initializing OnlineComponentProvider"),await u.initialize(m,x.configuration),x.setCredentialChangeListener((E=>F2(u.remoteStore,E))),x.setAppCheckTokenChangeListener(((E,A)=>F2(u.remoteStore,A))),x._onlineComponents=u}async function l9(x){if(!x._offlineComponents)if(x._uninitializedComponentsProvider){sn("FirestoreClient","Using user provided OfflineComponentProvider");try{await X0(x,x._uninitializedComponentsProvider._offline)}catch(u){const m=u;if(!(function(A){return A.name==="FirebaseError"?A.code===pi.FAILED_PRECONDITION||A.code===pi.UNIMPLEMENTED:!(typeof DOMException<"u"&&A instanceof DOMException)||A.code===22||A.code===20||A.code===11})(m))throw m;om("Error using user provided cache. Falling back to memory cache: "+m),await X0(x,new ry)}}else sn("FirestoreClient","Using default OfflineComponentProvider"),await X0(x,new ry);return x._offlineComponents}async function L3(x){return x._onlineComponents||(x._uninitializedComponentsProvider?(sn("FirestoreClient","Using user provided OnlineComponentProvider"),await j2(x,x._uninitializedComponentsProvider._online)):(sn("FirestoreClient","Using default OnlineComponentProvider"),await j2(x,new vv))),x._onlineComponents}function c9(x){return L3(x).then((u=>u.syncEngine))}async function u9(x){const u=await L3(x),m=u.eventManager;return m.onListen=WR.bind(null,u.syncEngine),m.onUnlisten=KR.bind(null,u.syncEngine),m.onFirstRemoteStoreListen=ZR.bind(null,u.syncEngine),m.onLastRemoteStoreUnlisten=YR.bind(null,u.syncEngine),m}function h9(x,u,m={}){const E=new Sf;return x.asyncQueue.enqueueAndForget((async()=>(function(z,U,s,ee,ne){const Ie=new o9({next:Xe=>{Ie.Za(),U.enqueueAndForget((()=>NR(z,qe))),Xe.fromCache&&ee.source==="server"?ne.reject(new yn(pi.UNAVAILABLE,'Failed to get documents from server. (However, these documents may exist in the local cache. Run again without setting source to "server" to retrieve the cached documents.)')):ne.resolve(Xe)},error:Xe=>ne.reject(Xe)}),qe=new jR(s,Ie,{includeMetadataChanges:!0,_a:!0});return BR(z,qe)})(await u9(x),x.asyncQueue,u,m,E))),E.promise}/**
 * @license
 * Copyright 2023 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function k3(x){const u={};return x.timeoutSeconds!==void 0&&(u.timeoutSeconds=x.timeoutSeconds),u}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const G2=new Map;/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function z3(x,u,m){if(!m)throw new yn(pi.INVALID_ARGUMENT,`Function ${x}() cannot be called with an empty ${u}.`)}function d9(x,u,m,E){if(u===!0&&E===!0)throw new yn(pi.INVALID_ARGUMENT,`${x} and ${m} cannot be used together.`)}function H2(x){if(!Vn.isDocumentKey(x))throw new yn(pi.INVALID_ARGUMENT,`Invalid document reference. Document references must have an even number of segments, but ${x} has ${x.length}.`)}function q2(x){if(Vn.isDocumentKey(x))throw new yn(pi.INVALID_ARGUMENT,`Invalid collection reference. Collection references must have an odd number of segments, but ${x} has ${x.length}.`)}function Qv(x){if(x===void 0)return"undefined";if(x===null)return"null";if(typeof x=="string")return x.length>20&&(x=`${x.substring(0,20)}...`),JSON.stringify(x);if(typeof x=="number"||typeof x=="boolean")return""+x;if(typeof x=="object"){if(x instanceof Array)return"an array";{const u=(function(E){return E.constructor?E.constructor.name:null})(x);return u?`a custom ${u} object`:"an object"}}return typeof x=="function"?"a function":ir()}function vp(x,u){if("_delegate"in x&&(x=x._delegate),!(x instanceof u)){if(u.name===x.constructor.name)throw new yn(pi.INVALID_ARGUMENT,"Type does not match the expected instance. Did you pass a reference from a different Firestore SDK?");{const m=Qv(x);throw new yn(pi.INVALID_ARGUMENT,`Expected type '${u.name}', but it was: ${m}`)}}return x}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class $2{constructor(u){var m,E;if(u.host===void 0){if(u.ssl!==void 0)throw new yn(pi.INVALID_ARGUMENT,"Can't provide ssl option if host option is not set");this.host="firestore.googleapis.com",this.ssl=!0}else this.host=u.host,this.ssl=(m=u.ssl)===null||m===void 0||m;if(this.credentials=u.credentials,this.ignoreUndefinedProperties=!!u.ignoreUndefinedProperties,this.localCache=u.localCache,u.cacheSizeBytes===void 0)this.cacheSizeBytes=41943040;else{if(u.cacheSizeBytes!==-1&&u.cacheSizeBytes<1048576)throw new yn(pi.INVALID_ARGUMENT,"cacheSizeBytes must be at least 1048576");this.cacheSizeBytes=u.cacheSizeBytes}d9("experimentalForceLongPolling",u.experimentalForceLongPolling,"experimentalAutoDetectLongPolling",u.experimentalAutoDetectLongPolling),this.experimentalForceLongPolling=!!u.experimentalForceLongPolling,this.experimentalForceLongPolling?this.experimentalAutoDetectLongPolling=!1:u.experimentalAutoDetectLongPolling===void 0?this.experimentalAutoDetectLongPolling=!0:this.experimentalAutoDetectLongPolling=!!u.experimentalAutoDetectLongPolling,this.experimentalLongPollingOptions=k3((E=u.experimentalLongPollingOptions)!==null&&E!==void 0?E:{}),(function(z){if(z.timeoutSeconds!==void 0){if(isNaN(z.timeoutSeconds))throw new yn(pi.INVALID_ARGUMENT,`invalid long polling timeout: ${z.timeoutSeconds} (must not be NaN)`);if(z.timeoutSeconds<5)throw new yn(pi.INVALID_ARGUMENT,`invalid long polling timeout: ${z.timeoutSeconds} (minimum allowed value is 5)`);if(z.timeoutSeconds>30)throw new yn(pi.INVALID_ARGUMENT,`invalid long polling timeout: ${z.timeoutSeconds} (maximum allowed value is 30)`)}})(this.experimentalLongPollingOptions),this.useFetchStreams=!!u.useFetchStreams}isEqual(u){return this.host===u.host&&this.ssl===u.ssl&&this.credentials===u.credentials&&this.cacheSizeBytes===u.cacheSizeBytes&&this.experimentalForceLongPolling===u.experimentalForceLongPolling&&this.experimentalAutoDetectLongPolling===u.experimentalAutoDetectLongPolling&&(function(E,A){return E.timeoutSeconds===A.timeoutSeconds})(this.experimentalLongPollingOptions,u.experimentalLongPollingOptions)&&this.ignoreUndefinedProperties===u.ignoreUndefinedProperties&&this.useFetchStreams===u.useFetchStreams}}class vy{constructor(u,m,E,A){this._authCredentials=u,this._appCheckCredentials=m,this._databaseId=E,this._app=A,this.type="firestore-lite",this._persistenceKey="(lite)",this._settings=new $2({}),this._settingsFrozen=!1,this._terminateTask="notTerminated"}get app(){if(!this._app)throw new yn(pi.FAILED_PRECONDITION,"Firestore was not initialized using the Firebase SDK. 'app' is not available");return this._app}get _initialized(){return this._settingsFrozen}get _terminated(){return this._terminateTask!=="notTerminated"}_setSettings(u){if(this._settingsFrozen)throw new yn(pi.FAILED_PRECONDITION,"Firestore has already been started and its settings can no longer be changed. You can only modify settings before calling any other methods on a Firestore object.");this._settings=new $2(u),u.credentials!==void 0&&(this._authCredentials=(function(E){if(!E)return new EC;switch(E.type){case"firstParty":return new CC(E.sessionIndex||"0",E.iamToken||null,E.authTokenFactory||null);case"provider":return E.client;default:throw new yn(pi.INVALID_ARGUMENT,"makeAuthCredentialsProvider failed due to invalid credential type")}})(u.credentials))}_getSettings(){return this._settings}_freezeSettings(){return this._settingsFrozen=!0,this._settings}_delete(){return this._terminateTask==="notTerminated"&&(this._terminateTask=this._terminate()),this._terminateTask}async _restart(){this._terminateTask==="notTerminated"?await this._terminate():this._terminateTask="notTerminated"}toJSON(){return{app:this._app,databaseId:this._databaseId,settings:this._settings}}_terminate(){return(function(m){const E=G2.get(m);E&&(sn("ComponentProvider","Removing Datastore"),G2.delete(m),E.terminate())})(this),Promise.resolve()}}function f9(x,u,m,E={}){var A;const z=(x=vp(x,vy))._getSettings(),U=`${u}:${m}`;if(z.host!=="firestore.googleapis.com"&&z.host!==U&&om("Host has been set in both settings() and connectFirestoreEmulator(), emulator host will be used."),x._setSettings(Object.assign(Object.assign({},z),{host:U,ssl:!1})),E.mockUserToken){let s,ee;if(typeof E.mockUserToken=="string")s=E.mockUserToken,ee=rl.MOCK_USER;else{s=n5(E.mockUserToken,(A=x._app)===null||A===void 0?void 0:A.options.projectId);const ne=E.mockUserToken.sub||E.mockUserToken.user_id;if(!ne)throw new yn(pi.INVALID_ARGUMENT,"mockUserToken must contain 'sub' or 'user_id' field!");ee=new rl(ne)}x._authCredentials=new SC(new zT(s,ee))}}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class xy{constructor(u,m,E){this.converter=m,this._query=E,this.type="query",this.firestore=u}withConverter(u){return new xy(this.firestore,u,this._query)}}class Jc{constructor(u,m,E){this.converter=m,this._key=E,this.type="document",this.firestore=u}get _path(){return this._key.path}get id(){return this._key.path.lastSegment()}get path(){return this._key.path.canonicalString()}get parent(){return new If(this.firestore,this.converter,this._key.path.popLast())}withConverter(u){return new Jc(this.firestore,u,this._key)}}class If extends xy{constructor(u,m,E){super(u,m,$T(E)),this._path=E,this.type="collection"}get id(){return this._query.path.lastSegment()}get path(){return this._query.path.canonicalString()}get parent(){const u=this._path.popLast();return u.isEmpty()?null:new Jc(this.firestore,null,new Vn(u))}withConverter(u){return new If(this.firestore,u,this._path)}}function Bg(x,u,...m){if(x=md(x),z3("collection","path",u),x instanceof vy){const E=Zs.fromString(u,...m);return q2(E),new If(x,null,E)}{if(!(x instanceof Jc||x instanceof If))throw new yn(pi.INVALID_ARGUMENT,"Expected first argument to collection() to be a CollectionReference, a DocumentReference or FirebaseFirestore");const E=x._path.child(Zs.fromString(u,...m));return q2(E),new If(x.firestore,null,E)}}function P_(x,u,...m){if(x=md(x),arguments.length===1&&(u=FT.newId()),z3("doc","path",u),x instanceof vy){const E=Zs.fromString(u,...m);return H2(E),new Jc(x,null,new Vn(E))}{if(!(x instanceof Jc||x instanceof If))throw new yn(pi.INVALID_ARGUMENT,"Expected first argument to collection() to be a CollectionReference, a DocumentReference or FirebaseFirestore");const E=x._path.child(Zs.fromString(u,...m));return H2(E),new Jc(x.firestore,x instanceof If?x.converter:null,new Vn(E))}}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class W2{constructor(u=Promise.resolve()){this.Pu=[],this.Iu=!1,this.Tu=[],this.Eu=null,this.du=!1,this.Au=!1,this.Ru=[],this.t_=new g3(this,"async_queue_retry"),this.Vu=()=>{const E=Z0();E&&sn("AsyncQueue","Visibility state changed to "+E.visibilityState),this.t_.jo()},this.mu=u;const m=Z0();m&&typeof m.addEventListener=="function"&&m.addEventListener("visibilitychange",this.Vu)}get isShuttingDown(){return this.Iu}enqueueAndForget(u){this.enqueue(u)}enqueueAndForgetEvenWhileRestricted(u){this.fu(),this.gu(u)}enterRestrictedMode(u){if(!this.Iu){this.Iu=!0,this.Au=u||!1;const m=Z0();m&&typeof m.removeEventListener=="function"&&m.removeEventListener("visibilitychange",this.Vu)}}enqueue(u){if(this.fu(),this.Iu)return new Promise((()=>{}));const m=new Sf;return this.gu((()=>this.Iu&&this.Au?Promise.resolve():(u().then(m.resolve,m.reject),m.promise))).then((()=>m.promise))}enqueueRetryable(u){this.enqueueAndForget((()=>(this.Pu.push(u),this.pu())))}async pu(){if(this.Pu.length!==0){try{await this.Pu[0](),this.Pu.shift(),this.t_.reset()}catch(u){if(!z_(u))throw u;sn("AsyncQueue","Operation failed with retryable error: "+u)}this.Pu.length>0&&this.t_.Go((()=>this.pu()))}}gu(u){const m=this.mu.then((()=>(this.du=!0,u().catch((E=>{this.Eu=E,this.du=!1;const A=(function(U){let s=U.message||"";return U.stack&&(s=U.stack.includes(U.message)?U.stack:U.message+`
`+U.stack),s})(E);throw gd("INTERNAL UNHANDLED ERROR: ",A),E})).then((E=>(this.du=!1,E))))));return this.mu=m,m}enqueueAfterDelay(u,m,E){this.fu(),this.Ru.indexOf(u)>-1&&(m=0);const A=Zv.createAndSchedule(this,u,m,E,(z=>this.yu(z)));return this.Tu.push(A),A}fu(){this.Eu&&ir()}verifyOperationInProgress(){}async wu(){let u;do u=this.mu,await u;while(u!==this.mu)}Su(u){for(const m of this.Tu)if(m.timerId===u)return!0;return!1}bu(u){return this.wu().then((()=>{this.Tu.sort(((m,E)=>m.targetTimeMs-E.targetTimeMs));for(const m of this.Tu)if(m.skipDelay(),u!=="all"&&m.timerId===u)break;return this.wu()}))}Du(u){this.Ru.push(u)}yu(u){const m=this.Tu.indexOf(u);this.Tu.splice(m,1)}}class V_ extends vy{constructor(u,m,E,A){super(u,m,E,A),this.type="firestore",this._queue=new W2,this._persistenceKey=A?.name||"[DEFAULT]"}async _terminate(){if(this._firestoreClient){const u=this._firestoreClient.terminate();this._queue=new W2(u),this._firestoreClient=void 0,await u}}}function p9(x,u){const m=typeof x=="object"?x:dC(),E=typeof x=="string"?x:"(default)",A=lC(m,"firestore").getImmediate({identifier:E});if(!A._initialized){const z=t5("firestore");z&&f9(A,...z)}return A}function Jv(x){if(x._terminated)throw new yn(pi.FAILED_PRECONDITION,"The client has already been terminated.");return x._firestoreClient||m9(x),x._firestoreClient}function m9(x){var u,m,E;const A=x._freezeSettings(),z=(function(s,ee,ne,Ie){return new UC(s,ee,ne,Ie.host,Ie.ssl,Ie.experimentalForceLongPolling,Ie.experimentalAutoDetectLongPolling,k3(Ie.experimentalLongPollingOptions),Ie.useFetchStreams)})(x._databaseId,((u=x._app)===null||u===void 0?void 0:u.options.appId)||"",x._persistenceKey,A);x._componentsProvider||!((m=A.localCache)===null||m===void 0)&&m._offlineComponentProvider&&(!((E=A.localCache)===null||E===void 0)&&E._onlineComponentProvider)&&(x._componentsProvider={_offline:A.localCache._offlineComponentProvider,_online:A.localCache._onlineComponentProvider}),x._firestoreClient=new a9(x._authCredentials,x._appCheckCredentials,x._queue,z,x._componentsProvider&&(function(s){const ee=s?._online.build();return{_offline:s?._offline.build(ee),_online:ee}})(x._componentsProvider))}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class dm{constructor(u){this._byteString=u}static fromBase64String(u){try{return new dm(za.fromBase64String(u))}catch(m){throw new yn(pi.INVALID_ARGUMENT,"Failed to construct data from Base64 string: "+m)}}static fromUint8Array(u){return new dm(za.fromUint8Array(u))}toBase64(){return this._byteString.toBase64()}toUint8Array(){return this._byteString.toUint8Array()}toString(){return"Bytes(base64: "+this.toBase64()+")"}isEqual(u){return this._byteString.isEqual(u._byteString)}}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class wy{constructor(...u){for(let m=0;m<u.length;++m)if(u[m].length===0)throw new yn(pi.INVALID_ARGUMENT,"Invalid field name at argument $(i + 1). Field names must not be empty.");this._internalPath=new La(u)}isEqual(u){return this._internalPath.isEqual(u._internalPath)}}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class by{constructor(u){this._methodName=u}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class R_{constructor(u,m){if(!isFinite(u)||u<-90||u>90)throw new yn(pi.INVALID_ARGUMENT,"Latitude must be a number between -90 and 90, but was: "+u);if(!isFinite(m)||m<-180||m>180)throw new yn(pi.INVALID_ARGUMENT,"Longitude must be a number between -180 and 180, but was: "+m);this._lat=u,this._long=m}get latitude(){return this._lat}get longitude(){return this._long}isEqual(u){return this._lat===u._lat&&this._long===u._long}toJSON(){return{latitude:this._lat,longitude:this._long}}_compareTo(u){return is(this._lat,u._lat)||is(this._long,u._long)}}/**
 * @license
 * Copyright 2024 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class ex{constructor(u){this._values=(u||[]).map((m=>m))}toArray(){return this._values.map((u=>u))}isEqual(u){return(function(E,A){if(E.length!==A.length)return!1;for(let z=0;z<E.length;++z)if(E[z]!==A[z])return!1;return!0})(this._values,u._values)}}/**
 * @license
 * Copyright 2017 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */const _9=/^__.*__$/;class g9{constructor(u,m,E){this.data=u,this.fieldMask=m,this.fieldTransforms=E}toMutation(u,m){return this.fieldMask!==null?new Rf(u,this.data,this.fieldMask,m,this.fieldTransforms):new F_(u,this.data,m,this.fieldTransforms)}}class F3{constructor(u,m,E){this.data=u,this.fieldMask=m,this.fieldTransforms=E}toMutation(u,m){return new Rf(u,this.data,this.fieldMask,m,this.fieldTransforms)}}function O3(x){switch(x){case 0:case 2:case 1:return!0;case 3:case 4:return!1;default:throw ir()}}class tx{constructor(u,m,E,A,z,U){this.settings=u,this.databaseId=m,this.serializer=E,this.ignoreUndefinedProperties=A,z===void 0&&this.vu(),this.fieldTransforms=z||[],this.fieldMask=U||[]}get path(){return this.settings.path}get Cu(){return this.settings.Cu}Fu(u){return new tx(Object.assign(Object.assign({},this.settings),u),this.databaseId,this.serializer,this.ignoreUndefinedProperties,this.fieldTransforms,this.fieldMask)}Mu(u){var m;const E=(m=this.path)===null||m===void 0?void 0:m.child(u),A=this.Fu({path:E,xu:!1});return A.Ou(u),A}Nu(u){var m;const E=(m=this.path)===null||m===void 0?void 0:m.child(u),A=this.Fu({path:E,xu:!1});return A.vu(),A}Lu(u){return this.Fu({path:void 0,xu:!0})}Bu(u){return sy(u,this.settings.methodName,this.settings.ku||!1,this.path,this.settings.qu)}contains(u){return this.fieldMask.find((m=>u.isPrefixOf(m)))!==void 0||this.fieldTransforms.find((m=>u.isPrefixOf(m.field)))!==void 0}vu(){if(this.path)for(let u=0;u<this.path.length;u++)this.Ou(this.path.get(u))}Ou(u){if(u.length===0)throw this.Bu("Document fields must not be empty");if(O3(this.Cu)&&_9.test(u))throw this.Bu('Document fields cannot begin and end with "__"')}}class y9{constructor(u,m,E){this.databaseId=u,this.ignoreUndefinedProperties=m,this.serializer=E||_y(u)}Qu(u,m,E,A=!1){return new tx({Cu:u,methodName:m,qu:E,path:La.emptyPath(),xu:!1,ku:A},this.databaseId,this.serializer,this.ignoreUndefinedProperties)}}function ix(x){const u=x._freezeSettings(),m=_y(x._databaseId);return new y9(x._databaseId,!!u.ignoreUndefinedProperties,m)}function nx(x,u,m,E,A,z={}){const U=x.Qu(z.merge||z.mergeFields?2:0,u,m,A);sx("Data must be an object, but it was:",U,E);const s=B3(E,U);let ee,ne;if(z.merge)ee=new Sc(U.fieldMask),ne=U.fieldTransforms;else if(z.mergeFields){const Ie=[];for(const qe of z.mergeFields){const Xe=xv(u,qe,m);if(!U.contains(Xe))throw new yn(pi.INVALID_ARGUMENT,`Field '${Xe}' is specified in your field mask but missing from your input data.`);V3(Ie,Xe)||Ie.push(Xe)}ee=new Sc(Ie),ne=U.fieldTransforms.filter((qe=>ee.covers(qe.field)))}else ee=null,ne=U.fieldTransforms;return new g9(new Ql(s),ee,ne)}class Ty extends by{_toFieldTransform(u){if(u.Cu!==2)throw u.Cu===1?u.Bu(`${this._methodName}() can only appear at the top level of your update data`):u.Bu(`${this._methodName}() cannot be used with set() unless you pass {merge:true}`);return u.fieldMask.push(u.path),null}isEqual(u){return u instanceof Ty}}class rx extends by{_toFieldTransform(u){return new fP(u.path,new I_)}isEqual(u){return u instanceof rx}}function v9(x,u,m,E){const A=x.Qu(1,u,m);sx("Data must be an object, but it was:",A,E);const z=[],U=Ql.empty();wp(E,((ee,ne)=>{const Ie=ox(u,ee,m);ne=md(ne);const qe=A.Nu(Ie);if(ne instanceof Ty)z.push(Ie);else{const Xe=Ey(ne,qe);Xe!=null&&(z.push(Ie),U.set(Ie,Xe))}}));const s=new Sc(z);return new F3(U,s,A.fieldTransforms)}function x9(x,u,m,E,A,z){const U=x.Qu(1,u,m),s=[xv(u,E,m)],ee=[A];if(z.length%2!=0)throw new yn(pi.INVALID_ARGUMENT,`Function ${u}() needs to be called with an even number of arguments that alternate between field names and values.`);for(let Xe=0;Xe<z.length;Xe+=2)s.push(xv(u,z[Xe])),ee.push(z[Xe+1]);const ne=[],Ie=Ql.empty();for(let Xe=s.length-1;Xe>=0;--Xe)if(!V3(ne,s[Xe])){const St=s[Xe];let $t=ee[Xe];$t=md($t);const ct=U.Nu(St);if($t instanceof Ty)ne.push(St);else{const wt=Ey($t,ct);wt!=null&&(ne.push(St),Ie.set(St,wt))}}const qe=new Sc(ne);return new F3(Ie,qe,U.fieldTransforms)}function Ey(x,u){if(N3(x=md(x)))return sx("Unsupported field value:",u,x),B3(x,u);if(x instanceof by)return(function(E,A){if(!O3(A.Cu))throw A.Bu(`${E._methodName}() can only be used with update() and set()`);if(!A.path)throw A.Bu(`${E._methodName}() is not currently supported inside arrays`);const z=E._toFieldTransform(A);z&&A.fieldTransforms.push(z)})(x,u),null;if(x===void 0&&u.ignoreUndefinedProperties)return null;if(u.path&&u.fieldMask.push(u.path),x instanceof Array){if(u.settings.xu&&u.Cu!==4)throw u.Bu("Nested arrays are not supported");return(function(E,A){const z=[];let U=0;for(const s of E){let ee=Ey(s,A.Lu(U));ee==null&&(ee={nullValue:"NULL_VALUE"}),z.push(ee),U++}return{arrayValue:{values:z}}})(x,u)}return(function(E,A){if((E=md(E))===null)return{nullValue:"NULL_VALUE"};if(typeof E=="number")return uP(A.serializer,E);if(typeof E=="boolean")return{booleanValue:E};if(typeof E=="string")return{stringValue:E};if(E instanceof Date){const z=Ko.fromDate(E);return{timestampValue:iy(A.serializer,z)}}if(E instanceof Ko){const z=new Ko(E.seconds,1e3*Math.floor(E.nanoseconds/1e3));return{timestampValue:iy(A.serializer,z)}}if(E instanceof R_)return{geoPointValue:{latitude:E.latitude,longitude:E.longitude}};if(E instanceof dm)return{bytesValue:l3(A.serializer,E._byteString)};if(E instanceof Jc){const z=A.databaseId,U=E.firestore._databaseId;if(!U.isEqual(z))throw A.Bu(`Document reference is for database ${U.projectId}/${U.database} but should be for database ${z.projectId}/${z.database}`);return{referenceValue:Vv(E.firestore._databaseId||A.databaseId,E._key.path)}}if(E instanceof ex)return(function(U,s){return{mapValue:{fields:{__type__:{stringValue:"__vector__"},value:{arrayValue:{values:U.toArray().map((ee=>{if(typeof ee!="number")throw s.Bu("VectorValues must only contain numeric values.");return Fv(s.serializer,ee)}))}}}}}})(E,A);throw A.Bu(`Unsupported field value: ${Qv(E)}`)})(x,u)}function B3(x,u){const m={};return OT(x)?u.path&&u.path.length>0&&u.fieldMask.push(u.path):wp(x,((E,A)=>{const z=Ey(A,u.Mu(E));z!=null&&(m[E]=z)})),{mapValue:{fields:m}}}function N3(x){return!(typeof x!="object"||x===null||x instanceof Array||x instanceof Date||x instanceof Ko||x instanceof R_||x instanceof dm||x instanceof Jc||x instanceof by||x instanceof ex)}function sx(x,u,m){if(!N3(m)||!(function(A){return typeof A=="object"&&A!==null&&(Object.getPrototypeOf(A)===Object.prototype||Object.getPrototypeOf(A)===null)})(m)){const E=Qv(m);throw E==="an object"?u.Bu(x+" a custom object"):u.Bu(x+" "+E)}}function xv(x,u,m){if((u=md(u))instanceof wy)return u._internalPath;if(typeof u=="string")return ox(x,u);throw sy("Field path arguments must be of type string or ",x,!1,void 0,m)}const w9=new RegExp("[~\\*/\\[\\]]");function ox(x,u,m){if(u.search(w9)>=0)throw sy(`Invalid field path (${u}). Paths must not contain '~', '*', '/', '[', or ']'`,x,!1,void 0,m);try{return new wy(...u.split("."))._internalPath}catch{throw sy(`Invalid field path (${u}). Paths must not be empty, begin with '.', end with '.', or contain '..'`,x,!1,void 0,m)}}function sy(x,u,m,E,A){const z=E&&!E.isEmpty(),U=A!==void 0;let s=`Function ${u}() called with invalid data`;m&&(s+=" (via `toFirestore()`)"),s+=". ";let ee="";return(z||U)&&(ee+=" (found",z&&(ee+=` in field ${E}`),U&&(ee+=` in document ${A}`),ee+=")"),new yn(pi.INVALID_ARGUMENT,s+x+ee)}function V3(x,u){return x.some((m=>m.isEqual(u)))}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class U3{constructor(u,m,E,A,z){this._firestore=u,this._userDataWriter=m,this._key=E,this._document=A,this._converter=z}get id(){return this._key.path.lastSegment()}get ref(){return new Jc(this._firestore,this._converter,this._key)}exists(){return this._document!==null}data(){if(this._document){if(this._converter){const u=new b9(this._firestore,this._userDataWriter,this._key,this._document,null);return this._converter.fromFirestore(u)}return this._userDataWriter.convertValue(this._document.data.value)}}get(u){if(this._document){const m=this._document.data.field(j3("DocumentSnapshot.get",u));if(m!==null)return this._userDataWriter.convertValue(m)}}}class b9 extends U3{data(){return super.data()}}function j3(x,u){return typeof u=="string"?ox(x,u):u instanceof wy?u._internalPath:u._delegate._internalPath}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function T9(x){if(x.limitType==="L"&&x.explicitOrderBy.length===0)throw new yn(pi.UNIMPLEMENTED,"limitToLast() queries require specifying at least one orderBy() clause")}class E9{convertValue(u,m="none"){switch(yp(u)){case 0:return null;case 1:return u.booleanValue;case 2:return Eo(u.integerValue||u.doubleValue);case 3:return this.convertTimestamp(u.timestampValue);case 4:return this.convertServerTimestamp(u,m);case 5:return u.stringValue;case 6:return this.convertBytes(gp(u.bytesValue));case 7:return this.convertReference(u.referenceValue);case 8:return this.convertGeoPoint(u.geoPointValue);case 9:return this.convertArray(u.arrayValue,m);case 11:return this.convertObject(u.mapValue,m);case 10:return this.convertVectorValue(u.mapValue);default:throw ir()}}convertObject(u,m){return this.convertObjectMap(u.fields,m)}convertObjectMap(u,m="none"){const E={};return wp(u,((A,z)=>{E[A]=this.convertValue(z,m)})),E}convertVectorValue(u){var m,E,A;const z=(A=(E=(m=u.fields)===null||m===void 0?void 0:m.value.arrayValue)===null||E===void 0?void 0:E.values)===null||A===void 0?void 0:A.map((U=>Eo(U.doubleValue)));return new ex(z)}convertGeoPoint(u){return new R_(Eo(u.latitude),Eo(u.longitude))}convertArray(u,m){return(u.values||[]).map((E=>this.convertValue(E,m)))}convertServerTimestamp(u,m){switch(m){case"previous":const E=Dv(u);return E==null?null:this.convertValue(E,m);case"estimate":return this.convertTimestamp(T_(u));default:return null}}convertTimestamp(u){const m=Cf(u);return new Ko(m.seconds,m.nanos)}convertDocumentKey(u,m){const E=Zs.fromString(u);_s(p3(E));const A=new E_(E.get(1),E.get(3)),z=new Vn(E.popFirst(5));return A.isEqual(m)||gd(`Document ${z} contains a document reference within a different database (${A.projectId}/${A.database}) which is not supported. It will be treated as a reference in the current database (${m.projectId}/${m.database}) instead.`),z}}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function ax(x,u,m){let E;return E=x?m&&(m.merge||m.mergeFields)?x.toFirestore(u,m):x.toFirestore(u):u,E}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class Ng{constructor(u,m){this.hasPendingWrites=u,this.fromCache=m}isEqual(u){return this.hasPendingWrites===u.hasPendingWrites&&this.fromCache===u.fromCache}}class S9 extends U3{constructor(u,m,E,A,z,U){super(u,m,E,A,U),this._firestore=u,this._firestoreImpl=u,this.metadata=z}exists(){return super.exists()}data(u={}){if(this._document){if(this._converter){const m=new Wg(this._firestore,this._userDataWriter,this._key,this._document,this.metadata,null);return this._converter.fromFirestore(m,u)}return this._userDataWriter.convertValue(this._document.data.value,u.serverTimestamps)}}get(u,m={}){if(this._document){const E=this._document.data.field(j3("DocumentSnapshot.get",u));if(E!==null)return this._userDataWriter.convertValue(E,m.serverTimestamps)}}}class Wg extends S9{data(u={}){return super.data(u)}}class I9{constructor(u,m,E,A){this._firestore=u,this._userDataWriter=m,this._snapshot=A,this.metadata=new Ng(A.hasPendingWrites,A.fromCache),this.query=E}get docs(){const u=[];return this.forEach((m=>u.push(m))),u}get size(){return this._snapshot.docs.size}get empty(){return this.size===0}forEach(u,m){this._snapshot.docs.forEach((E=>{u.call(m,new Wg(this._firestore,this._userDataWriter,E.key,E,new Ng(this._snapshot.mutatedKeys.has(E.key),this._snapshot.fromCache),this.query.converter))}))}docChanges(u={}){const m=!!u.includeMetadataChanges;if(m&&this._snapshot.excludesMetadataChanges)throw new yn(pi.INVALID_ARGUMENT,"To include metadata changes with your document changes, you must also pass { includeMetadataChanges:true } to onSnapshot().");return this._cachedChanges&&this._cachedChangesIncludeMetadataChanges===m||(this._cachedChanges=(function(A,z){if(A._snapshot.oldDocs.isEmpty()){let U=0;return A._snapshot.docChanges.map((s=>{const ee=new Wg(A._firestore,A._userDataWriter,s.doc.key,s.doc,new Ng(A._snapshot.mutatedKeys.has(s.doc.key),A._snapshot.fromCache),A.query.converter);return s.doc,{type:"added",doc:ee,oldIndex:-1,newIndex:U++}}))}{let U=A._snapshot.oldDocs;return A._snapshot.docChanges.filter((s=>z||s.type!==3)).map((s=>{const ee=new Wg(A._firestore,A._userDataWriter,s.doc.key,s.doc,new Ng(A._snapshot.mutatedKeys.has(s.doc.key),A._snapshot.fromCache),A.query.converter);let ne=-1,Ie=-1;return s.type!==0&&(ne=U.indexOf(s.doc.key),U=U.delete(s.doc.key)),s.type!==1&&(U=U.add(s.doc),Ie=U.indexOf(s.doc.key)),{type:A9(s.type),doc:ee,oldIndex:ne,newIndex:Ie}}))}})(this,m),this._cachedChangesIncludeMetadataChanges=m),this._cachedChanges}}function A9(x){switch(x){case 0:return"added";case 2:case 3:return"modified";case 1:return"removed";default:return ir()}}class C9 extends E9{constructor(u){super(),this.firestore=u}convertBytes(u){return new dm(u)}convertReference(u){const m=this.convertDocumentKey(u,this.firestore._databaseId);return new Jc(this.firestore,null,m)}}function u_(x){x=vp(x,xy);const u=vp(x.firestore,V_),m=Jv(u),E=new C9(u);return T9(x._query),h9(m,x._query).then((A=>new I9(u,E,x,A)))}function oy(x,u,m){x=vp(x,Jc);const E=vp(x.firestore,V_),A=ax(x.converter,u,m);return lx(E,[nx(ix(E),"setDoc",x._key,A,x.converter!==null,m).toMutation(x._key,Ic.none())])}function Z2(x,u){const m=vp(x.firestore,V_),E=P_(x),A=ax(x.converter,u);return lx(m,[nx(ix(x.firestore),"addDoc",E._key,A,x.converter!==null,{}).toMutation(E._key,Ic.exists(!1))]).then((()=>E))}function lx(x,u){return(function(E,A){const z=new Sf;return E.asyncQueue.enqueueAndForget((async()=>QR(await c9(E),A,z))),z.promise})(Jv(x),u)}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */class P9{constructor(u,m){this._firestore=u,this._commitHandler=m,this._mutations=[],this._committed=!1,this._dataReader=ix(u)}set(u,m,E){this._verifyNotCommitted();const A=K0(u,this._firestore),z=ax(A.converter,m,E),U=nx(this._dataReader,"WriteBatch.set",A._key,z,A.converter!==null,E);return this._mutations.push(U.toMutation(A._key,Ic.none())),this}update(u,m,E,...A){this._verifyNotCommitted();const z=K0(u,this._firestore);let U;return U=typeof(m=md(m))=="string"||m instanceof wy?x9(this._dataReader,"WriteBatch.update",z._key,m,E,A):v9(this._dataReader,"WriteBatch.update",z._key,m),this._mutations.push(U.toMutation(z._key,Ic.exists(!0))),this}delete(u){this._verifyNotCommitted();const m=K0(u,this._firestore);return this._mutations=this._mutations.concat(new Ov(m._key,Ic.none())),this}commit(){return this._verifyNotCommitted(),this._committed=!0,this._mutations.length>0?this._commitHandler(this._mutations):Promise.resolve()}_verifyNotCommitted(){if(this._committed)throw new yn(pi.FAILED_PRECONDITION,"A write batch can no longer be used after commit() has been called.")}}function K0(x,u){if((x=md(x)).firestore!==u)throw new yn(pi.INVALID_ARGUMENT,"Provided document reference is from a different Firestore instance.");return x}function X2(){return new rx("serverTimestamp")}/**
 * @license
 * Copyright 2020 Google LLC
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */function R9(x){return Jv(x=vp(x,V_)),new P9(x,(u=>lx(x,u)))}(function(u,m=!0){(function(A){_m=A})(hC),Yg(new x_("firestore",((E,{instanceIdentifier:A,options:z})=>{const U=E.getProvider("app").getImmediate(),s=new V_(new IC(E.getProvider("auth-internal")),new RC(E.getProvider("app-check-internal")),(function(ne,Ie){if(!Object.prototype.hasOwnProperty.apply(ne.options,["projectId"]))throw new yn(pi.INVALID_ARGUMENT,'"projectId" not provided in firebase.initializeApp.');return new E_(ne.options.projectId,Ie)})(U,A),U);return z=Object.assign({useFetchStreams:m},z),s._setSettings(z),s}),"PUBLIC").setMultipleInstances(!0)),rm(d2,"4.7.3",u),rm(d2,"4.7.3","esm2017")})();const M9={apiKey:"AIzaSyDqdNAi8z3vx8TJcbVwUN37GJtt4vGH_Cs",authDomain:"stakeholder-map-a4bdc.firebaseapp.com",projectId:"stakeholder-map-a4bdc",storageBucket:"stakeholder-map-a4bdc.firebasestorage.app",messagingSenderId:"201968932417D",appId:"1:201968932417:web:c6053a304f5dc5f2ffd8c0",measurementId:"G-BEB17GFMBJ"},D9=IT(M9),fp=p9(D9),L9=[{value:5,label:"5 - Excellent"},{value:4,label:"4 - Good"},{value:3,label:"3 - Adequate"},{value:2,label:"2 - Poor"},{value:1,label:"1 - Very Poor"},{value:0,label:"0 - Not Set"}],K2={buildingName:"",notes:"",scores:{architecture:{exterior:0,entrances:0,interiorFinishes:0,lifeSafety:0,codesAndAccessibility:0},engineering:{superstructure:0,conveyingSystems:0,fireProtection:0,plumbing:0,mechanical:0,power:0,lighting:0},functionality:{telecomm:0,fireAlarm:0,spaceSize:0,technology:0}}},k9=({buildingId:x,assessments:u,onClose:m,onSave:E})=>{const[A,z]=Ot.useState(K2);Ot.useEffect(()=>{if(x&&u){const ne=u[x]||{...K2,buildingName:x};z(ne)}},[x,u]);const U=(ne,Ie,qe)=>{z(Xe=>({...Xe,scores:{...Xe.scores,[ne]:{...Xe.scores[ne],[Ie]:Number(qe)}}}))},s=ne=>{z(Ie=>({...Ie,notes:ne.target.value}))},ee=async()=>{if(!x)return;const ne=x.replace(/\//g,"__"),Ie=P_(fp,"buildingAssessments",ne),qe={...A,originalId:x};try{await oy(Ie,qe),E(qe),alert("Assessment saved successfully!"),m()}catch(Xe){console.error("Error saving assessment:",Xe),alert("Failed to save assessment. See console for details.")}};return x?ii.jsxs("div",{className:"assessment-panel",children:[ii.jsxs("div",{className:"panel-header",children:[ii.jsx("h3",{children:"Technical Assessment"}),ii.jsx("button",{onClick:m,className:"close-button",children:"×"})]}),ii.jsxs("div",{className:"panel-content",children:[ii.jsx("h4",{children:A.buildingName||x}),A.scores&&Object.entries(A.scores).map(([ne,Ie])=>ii.jsxs("div",{className:"category-section",children:[ii.jsx("h5",{children:ne.charAt(0).toUpperCase()+ne.slice(1)}),Object.entries(Ie).map(([qe,Xe])=>ii.jsxs("div",{className:"score-item",children:[ii.jsx("label",{children:qe.replace(/([A-Z])/g," $1").trim()}),ii.jsx("select",{value:Xe,onChange:St=>U(ne,qe,St.target.value),children:L9.map(St=>ii.jsx("option",{value:St.value,children:St.label},St.value))})]},qe))]},ne)),ii.jsxs("div",{className:"notes-section",children:[ii.jsx("h5",{children:"Notes"}),ii.jsx("textarea",{value:A.notes||"",onChange:s,rows:"4"})]}),ii.jsx("button",{className:"save-button",onClick:ee,children:"Save Changes"})]})]}):null},z9={5:{label:"5 = Excellent condition"},4:{label:"4 = Good condition"},3:{label:"3 = Adequate condition"},2:{label:"2 = Poor condition"},1:{label:"1 = Very poor condition"}},F9=({buildingId:x,buildingName:u,currentCondition:m,onSave:E,onOpenTechnical:A,onClose:z})=>{const[U,s]=Ot.useState(m||""),ee=async()=>{if(!U){alert("Please select a condition before saving.");return}try{const ne=x.replace(/\//g,"__");await oy(P_(fp,"buildingConditions",ne),{condition:U,originalId:x}),alert(`Condition for ${u} saved!`),E(x,U),z()}catch(ne){console.error("Error saving condition: ",ne),alert("Failed to save condition. See console for details.")}};return x?ii.jsxs("div",{className:"interaction-panel",children:[ii.jsxs("div",{className:"panel-header",children:[ii.jsx("h4",{children:u||x}),ii.jsx("button",{onClick:z,className:"close-button",children:"×"})]}),ii.jsxs("div",{className:"panel-content",children:[ii.jsxs("div",{className:"condition-section",children:[ii.jsx("label",{htmlFor:"condition-select",children:"Set Stakeholder Condition:"}),ii.jsxs("select",{id:"condition-select",value:U,onChange:ne=>s(ne.target.value),children:[ii.jsx("option",{value:"",disabled:!0,children:"Select a condition..."}),Object.entries(z9).reverse().map(([ne,{label:Ie}])=>ii.jsx("option",{value:ne,children:Ie},ne))]}),ii.jsx("button",{onClick:ee,children:"Save Condition"})]}),ii.jsx("hr",{}),ii.jsxs("div",{className:"assessment-section",children:[ii.jsx("p",{children:"Or perform a detailed review:"}),ii.jsx("button",{onClick:A,children:"Open Technical Assessment"})]})]})]}):null},Y2={5:{label:"5 = Excellent condition",color:"#4CAF50"},4:{label:"4 = Good condition",color:"#8BC34A"},3:{label:"3 = Adequate condition",color:"#FFEB3B"},2:{label:"2 = Poor condition",color:"#FF9800"},1:{label:"1 = Very poor condition",color:"#F44336"}},Q2={0:"#85474b",1:"#aed6f1",2:"#5dade2",3:"#2e86c1"},Y0="#85474b",G3=({config:x,universityId:u,mode:m="public"})=>{const E=Ot.useRef(null),A=Ot.useRef(null),z=Ot.useRef(null);if(!u)return ii.jsx("div",{children:"Loading University..."});const[U,s]=Ot.useState(!1),[ee,ne]=Ot.useState("select"),[Ie,qe]=Ot.useState(!0),[Xe,St]=Ot.useState(!0),[$t,ct]=Ot.useState(!0),[wt,Nt]=Ot.useState([]),[Ti,Ei]=Ot.useState([]),[en,Hn]=Ot.useState([]),[_n,rt]=Ot.useState({}),[De,je]=Ot.useState({}),[Ke,We]=Ot.useState(null),[ut,Oe]=Ot.useState("progress"),[kn,$n]=Ot.useState(!0),[wn,Gn]=Ot.useState(!1),wi=Ot.useMemo(()=>({"This is my favorite spot":"#006400","I meet friends here":"#008000","I study here":"#9ACD32","I feel safe here":"#20B2AA","This place is too busy":"#FFFF00","This place needs improvement":"#FF9800","I don't feel safe here":"#F44336","Just leave a comment":"#9E9E9E"}),[]),Ui=Ot.useMemo(()=>({"Preferred Route":{color:"#008000"},"Avoided Route":{color:"#F44336"}}),[]),[Ai]=Ot.useState(()=>Object.keys(Ui)[0]),Qe=Ot.useMemo(()=>Bg(fp,"universities",u,"markers"),[u]),Gt=Ot.useMemo(()=>Bg(fp,"universities",u,"paths"),[u]),ji=Ot.useMemo(()=>Bg(fp,"universities",u,"buildingConditions"),[u]),Un=Ot.useMemo(()=>Bg(fp,"universities",u,"buildingAssessments"),[u]),zn=Ot.useCallback(Ut=>{if(!A.current)return;const Di=document.createElement("div");Di.className="marker-prompt-popup",Di.innerHTML=`<h4>Add a Marker</h4><select id="marker-type">${Object.keys(wi).map(wr=>`<option value="${wr}">${wr}</option>`).join("")}</select><textarea id="marker-comment" placeholder="Optional comment..."></textarea><div class="button-group"><button id="confirm-marker">Add</button><button id="cancel-marker">Cancel</button></div>`;const cn=new hp.Popup({closeOnClick:!1,maxWidth:"280px"}).setDOMContent(Di).setLngLat(Ut).addTo(A.current);Di.querySelector("#confirm-marker").addEventListener("click",async()=>{const wr=Di.querySelector("#marker-type").value,Zn=Di.querySelector("#marker-comment").value.trim(),fr={coordinates:new R_(Ut.lat,Ut.lng),type:wr,comment:Zn,createdAt:X2()},Rn=await Z2(Qe,fr);Nt(ar=>[...ar,{...fr,id:Rn.id,coordinates:[Ut.lng,Ut.lat]}]),cn.remove()}),Di.querySelector("#cancel-marker").addEventListener("click",()=>cn.remove())},[wi,Qe]),zi=Ot.useCallback(async()=>{if(en.length<2){Hn([]);return}const Ut={coordinates:en.map(cn=>new R_(cn[1],cn[0])),type:Ai,createdAt:X2()},Di=await Z2(Gt,Ut);Ei(cn=>[...cn,{...Ut,id:Di.id,coordinates:en}]),Hn([])},[en,Ai,Gt]),Ji=Ot.useCallback(async Ut=>{const Di=Ut.originalId;if(!Di){console.error("Cannot save assessment: missing originalId.");return}const cn=P_(Un,Di.replace(/\//g,"__"));await oy(cn,Ut,{merge:!0}),je(wr=>({...wr,[Di]:Ut}))},[Un]),on=async(Ut,Di)=>{const cn=P_(ji,Ut.replace(/\//g,"__"));await oy(cn,{condition:Di,originalId:Ut},{merge:!0}),rt(wr=>({...wr,[Ut]:Di}))},er=()=>Gn(!0),Pn=Ot.useCallback(async(Ut,Di,cn)=>{if(!window.confirm(`Are you sure you want to delete all ${Di} for ${u}? This cannot be undone.`))return;cn([]);const wr=R9(fp);(await u_(Ut)).forEach(fr=>wr.delete(fr.ref)),await wr.commit()},[u]),ao=()=>Pn(Qe,"markers",Nt),Bo=()=>Pn(Gt,"paths",Ei),Yo=()=>Pn(ji,"building conditions",rt),Bs=Ot.useCallback(()=>{if(wt.length===0&&Ti.length===0&&Object.keys(_n).length===0&&Object.keys(De).length===0)return alert("No data to export.");const Ut=Rn=>`"${String(Rn||"").replace(/"/g,'""')}"`,Di=[];Di.push(["DataType","BuildingID","Category","SubCategory","Score","Notes"].join(",")),Object.entries(De).forEach(([Rn,ar])=>{const vs=ar.notes||"";ar.scores&&Object.entries(ar.scores).forEach(([Qo,Fa])=>{Object.entries(Fa).forEach(([Sr,Lr])=>{Di.push([Ut("TechnicalAssessment"),Ut(ar.buildingName||Rn),Ut(Qo),Ut(Sr),Ut(Lr),Ut(vs)].join(","))})})}),Di.push([]),Di.push(["DataType","ID","Type","Latitude","Longitude","Comment","PathCoordinatesJSON"].join(",")),wt.forEach(Rn=>{Di.push([Ut("Marker"),Ut(Rn.id),Ut(Rn.type),Ut(Rn.coordinates[1]),Ut(Rn.coordinates[0]),Ut(Rn.comment),""].join(","))}),Ti.forEach(Rn=>{Di.push([Ut("Path"),Ut(Rn.id),Ut(Rn.type),"","","",Ut(JSON.stringify(Rn.coordinates))].join(","))}),Object.entries(_n).forEach(([Rn,ar])=>{ar&&Di.push([Ut("StakeholderCondition"),Ut(Rn),Ut(ar),"","","",""].join(","))});const cn=Di.join(`
`),wr=new Blob([cn],{type:"text/csv;charset=utf-8;"}),Zn=document.createElement("a"),fr=URL.createObjectURL(wr);Zn.setAttribute("href",fr),Zn.setAttribute("download",`${u}-map-data-export-${new Date().toISOString().slice(0,10)}.csv`),Zn.style.visibility="hidden",document.body.appendChild(Zn),Zn.click(),document.body.removeChild(Zn)},[wt,Ti,_n,De,u]);return Ot.useEffect(()=>{if(A.current||!E.current||!x)return;hp.accessToken="pk.eyJ1IjoiamFjazExMzAiLCJhIjoiY205Y3kwbHJuMHBjczJrb2R6Mm44NmFkYSJ9.ZR3q-IyOfNZEjB3MKqWQTw";const Ut=new hp.Map({container:E.current,style:x.style,center:[x.lng,x.lat],zoom:x.zoom,pitch:x.pitch,bearing:x.bearing});return A.current=Ut,Ut.addControl(new hp.NavigationControl,"top-right"),Ut.addControl(new hp.FullscreenControl),Ut.on("load",()=>s(!0)),()=>Ut.remove()},[x]),Ot.useEffect(()=>{if(!u)return;(async()=>{try{const Di=await u_(Qe);if(Nt(Di.docs.map(ar=>({id:ar.id,...ar.data(),coordinates:[ar.data().coordinates.longitude,ar.data().coordinates.latitude]}))),m!=="admin"){Ei([]),rt({}),je({});return}const[cn,wr,Zn]=await Promise.all([u_(Gt),u_(ji),u_(Un)]);Ei(cn.docs.map(ar=>({id:ar.id,...ar.data(),coordinates:ar.data().coordinates.map(vs=>[vs.longitude,vs.latitude])})));const fr={};wr.forEach(ar=>{const vs=ar.data().originalId||ar.id.replace(/__/g,"/");fr[vs]=ar.data().condition}),rt(fr);const Rn={};Zn.forEach(ar=>{const vs=ar.data().originalId||ar.id.replace(/__/g,"/");Rn[vs]=ar.data()}),je(Rn)}catch(Di){console.error("Failed to fetch data:",Di),Ei([]),rt({}),je({})}})()},[m,u,Qe,Gt,ji,Un]),Ot.useEffect(()=>{if(!U||!A.current||!x)return;const Ut=A.current;Ut.getSource("buildings")||(Ut.addSource("buildings",{type:"geojson",data:x.buildings,promoteId:"id"}),Ut.addLayer({id:"buildings-layer",type:"fill-extrusion",source:"buildings",paint:{"fill-extrusion-color":Y0,"fill-extrusion-height":15,"fill-extrusion-opacity":.7}}),Ut.addLayer({id:"buildings-outline",type:"line",source:"buildings",paint:{"line-color":"#007bff","line-width":2.5,"line-opacity":["case",["boolean",["feature-state","selected"],!1],1,0]}})),x.boundary&&!Ut.getSource("boundary")&&(Ut.addSource("boundary",{type:"geojson",data:x.boundary}),Ut.addLayer({id:"boundary-layer",type:"line",source:"boundary",paint:{"line-color":"#a9040e","line-width":3,"line-dasharray":[2,2]}}))},[U,x]),Ot.useEffect(()=>{if(!U||!A.current)return;const Ut=A.current;m!=="admin"&&Ke&&We(null),z.current&&Ut.setFeatureState({source:"buildings",id:z.current},{selected:!1}),Ke&&m==="admin"&&Ut.setFeatureState({source:"buildings",id:Ke},{selected:!0}),z.current=Ke},[Ke,U,m]),Ot.useEffect(()=>{if(!U||!A.current)return;const Ut=A.current;Ut.getCanvas().parentElement.querySelectorAll(".custom-mapbox-marker").forEach(Di=>Di.remove()),Ie&&wt.forEach(Di=>{const cn=document.createElement("div");cn.className="custom-marker custom-mapbox-marker",cn.style.backgroundColor=wi[Di.type]||"#9E9E9E",new hp.Marker(cn).setLngLat(Di.coordinates).setPopup(new hp.Popup({offset:25}).setText(Di.comment||Di.type)).addTo(Ut)})},[wt,Ie,wi,U]),Ot.useEffect(()=>{if(!U||!A.current)return;const Ut=A.current;Ut.getStyle().layers.filter(cn=>cn.id.startsWith("path-")).forEach(cn=>{Ut.getLayer(cn.id)&&Ut.removeLayer(cn.id),Ut.getSource(cn.source)&&Ut.removeSource(cn.source)}),m==="admin"&&Xe&&Ti.forEach(cn=>{const wr=`path-source-${cn.id}`,Zn=`path-layer-${cn.id}`;Ut.getSource(wr)||(Ut.addSource(wr,{type:"geojson",data:{type:"Feature",geometry:{type:"LineString",coordinates:cn.coordinates}}}),Ut.addLayer({id:Zn,type:"line",source:wr,paint:{"line-color":Ui[cn.type]?.color||"#000","line-width":4}}))})},[Ti,Xe,Ui,U,m]),Ot.useEffect(()=>{if(!U||!A.current||!A.current.getSource("buildings"))return;const Ut=A.current,Di=["match",["get","id"]];let cn=!1;m==="admin"&&ut==="progress"&&Object.keys(De).length>0?Object.entries(De).forEach(([wr,Zn])=>{let fr=0;Zn.scores?.architecture&&Object.values(Zn.scores.architecture).some(Rn=>Rn>0)&&fr++,Zn.scores?.engineering&&Object.values(Zn.scores.engineering).some(Rn=>Rn>0)&&fr++,Zn.scores?.functionality&&Object.values(Zn.scores.functionality).some(Rn=>Rn>0)&&fr++,Di.push(Zn.originalId||wr,Q2[fr]),cn=!0}):m==="admin"&&ut==="stakeholder"&&Object.keys(_n).length>0&&Object.entries(_n).forEach(([wr,Zn])=>{const fr=Y2[Zn];fr&&(Di.push(wr,fr.color),cn=!0)}),Di.push(Y0),cn?Ut.setPaintProperty("buildings-layer","fill-extrusion-color",Di):Ut.setPaintProperty("buildings-layer","fill-extrusion-color",Y0)},[_n,De,U,m,ut]),Ot.useEffect(()=>{if(!U||!A.current)return;const Ut=A.current,Di=wr=>{if(ee==="drawPath"&&m==="admin"){Hn(Zn=>[...Zn,wr.lngLat.toArray()]);return}if(ee==="select"&&m==="admin"){const Zn=Ut.queryRenderedFeatures(wr.point,{layers:["buildings-layer"]});if(Zn.length>0){We(Zn[0].properties.id),Gn(!1);return}}We(null),zn(wr.lngLat)},cn=()=>{ee==="drawPath"&&m==="admin"&&zi()};return Ut.on("click",Di),Ut.on("dblclick",cn),()=>{Ut.off("click",Di),Ut.off("dblclick",cn)}},[U,m,ee,zi,zn]),x?ii.jsxs("div",{className:"map-page-container",children:[ii.jsx("div",{ref:E,className:"map-container"}),m==="admin"&&ii.jsx("button",{className:"controls-toggle-button",onClick:()=>$n(Ut=>!Ut),children:kn?"Hide Controls":"Show Controls"}),ii.jsxs("div",{className:"logo-panel-right",children:[ii.jsxs("div",{className:"logo-box",children:[ii.jsx("div",{className:"mapfluence-title",children:"MAPFLUENCE"}),ii.jsx("img",{src:x.logos.clarkEnersen,alt:"Clark & Enersen Logo"})]}),ii.jsx("div",{className:"logo-box",children:ii.jsx("img",{src:x.logos.university,alt:`${x.universityName} Logo`})})]}),$t&&ii.jsxs("div",{className:"help-panel",children:[ii.jsx("button",{className:"close-button",onClick:()=>ct(!1),children:"×"}),ii.jsx("h4",{children:"How to Use This Map"}),ii.jsxs("ul",{children:[ii.jsx("li",{children:"Click on the map to add a marker."}),m==="admin"&&ii.jsxs(ii.Fragment,{children:[ii.jsx("li",{children:"Double-click to finish drawing a path."}),ii.jsx("li",{children:"Click on a building to select and update its condition."})]}),ii.jsx("li",{children:"Use the controls to toggle markers."})]}),ii.jsx("button",{className:"close-button-main",onClick:()=>ct(!1),children:"Close"})]}),m==="admin"&&ii.jsxs(ii.Fragment,{children:[Ke&&!wn&&ii.jsx(F9,{buildingId:Ke,buildingName:x?.buildings?.features?.find(Ut=>Ut.properties.id===Ke)?.properties?.name,currentCondition:_n[Ke],onSave:on,onOpenTechnical:er,onClose:()=>{We(null),Gn(!1)}}),Ke&&wn&&ii.jsx(k9,{buildingId:Ke,assessments:De,onClose:()=>Gn(!1),onSave:Ji})]}),kn&&ii.jsxs("div",{className:"map-controls-panel",children:[m==="admin"&&ii.jsxs("div",{className:"control-section theme-selector",children:[ii.jsx("label",{htmlFor:"theme-select",children:"Map View:"}),ii.jsxs("select",{id:"theme-select",value:ut,onChange:Ut=>Oe(Ut.target.value),children:[ii.jsx("option",{value:"stakeholder",children:"Stakeholder Condition"}),ii.jsx("option",{value:"progress",children:"Assessment Progress"})]})]}),ii.jsxs("div",{className:"mode-selector",children:[ii.jsx("button",{className:ee==="select"?"active":"",onClick:()=>ne("select"),children:"Select/Marker"}),m==="admin"&&ii.jsx("button",{className:ee==="drawPath"?"active":"",onClick:()=>ne("drawPath"),children:"Draw Path"})]}),ii.jsx("div",{className:"control-section",children:ii.jsxs("div",{className:"button-row",children:[ii.jsx("button",{onClick:()=>qe(Ut=>!Ut),children:Ie?`Hide Markers (${wt.length})`:`Show Markers (${wt.length})`}),m==="admin"&&ii.jsx("button",{onClick:()=>St(Ut=>!Ut),children:Xe?`Hide Paths (${Ti.length})`:`Show Paths (${Ti.length})`})]})}),m==="admin"&&ii.jsxs("div",{className:"control-section admin-controls",children:[ii.jsxs("div",{className:"button-row",children:[ii.jsx("button",{onClick:Bs,children:"Export Data"}),ii.jsx("button",{onClick:ao,children:"Clear Markers"})]}),ii.jsxs("div",{className:"button-row",children:[ii.jsx("button",{onClick:Bo,children:"Clear Paths"}),ii.jsx("button",{onClick:Yo,children:"Clear Conditions"})]})]}),ii.jsxs("div",{className:"legend",children:[ii.jsx("h4",{children:"Legend"}),ii.jsxs("div",{className:"legend-section",children:[ii.jsx("h5",{children:"Marker Types"}),Object.entries(wi).map(([Ut,Di])=>ii.jsxs("div",{className:"legend-item",children:[ii.jsx("span",{className:"legend-color-box",style:{backgroundColor:Di}}),Ut]},Ut))]}),m==="admin"&&ii.jsxs(ii.Fragment,{children:[ii.jsxs("div",{className:"legend-section",children:[ii.jsx("h5",{children:"Path Types"}),Object.entries(Ui).map(([Ut,{color:Di}])=>ii.jsxs("div",{className:"legend-item",children:[ii.jsx("span",{className:"legend-color-box",style:{backgroundColor:Di,border:`2px solid ${Di}`}}),Ut]},Ut))]}),ut==="stakeholder"?ii.jsxs("div",{className:"legend-section",children:[ii.jsx("h5",{children:"Building Conditions"}),Object.entries(Y2).map(([Ut,{label:Di,color:cn}])=>ii.jsxs("div",{className:"legend-item",children:[ii.jsx("span",{className:"legend-color-box",style:{backgroundColor:cn}}),Di]},Ut))]}):ii.jsxs("div",{className:"legend-section",children:[ii.jsx("h5",{children:"Assessment Progress"}),Object.entries(Q2).filter(([Ut])=>Ut>0).map(([Ut,Di])=>ii.jsxs("div",{className:"legend-item",children:[ii.jsx("span",{className:"legend-color-box",style:{backgroundColor:Di}}),Ut,"/3 Complete"]},Ut))]})]})]})]})]}):ii.jsx("div",{children:"Loading Map Configuration..."})},O9=({config:x,universityId:u})=>ii.jsx("div",{style:{width:"100%",height:"100%",position:"relative"},children:ii.jsx(G3,{config:x,universityId:u,mode:"public"})}),B9=({config:x,universityId:u})=>ii.jsx("div",{className:"admin-page",style:{width:"100%",height:"100%"},children:ii.jsx(G3,{config:x,universityId:u,mode:"admin"})}),N9="Hastings College",V9="mapbox://styles/mapbox/streets-v12",U9=-98.371164,j9=40.592958,G9=15.8,H9=39,q9=0,$9={clarkEnersen:"Clark_Enersen_Logo.png",university:"HC_image.png"},W9={universityName:N9,style:V9,lng:U9,lat:j9,zoom:G9,pitch:H9,bearing:q9,logos:$9},Z9="rockhurst",X9="Rockhurst University",K9=39.030531,Y9=-94.57182,Q9=16.2,J9=45,eM=-17.6,tM="mapbox://styles/mapbox/streets-v12",iM={clarkEnersen:"Clark_Enersen_Logo.png",university:"RockhurstU_Logo.png"},nM={universityId:Z9,universityName:X9,lat:K9,lng:Y9,zoom:Q9,pitch:J9,bearing:eM,style:tM,logos:iM},rM="FeatureCollection",sM=JSON.parse(`[{"type":"Feature","geometry":{"type":"Polygon","coordinates":[[[-98.37413233965788,40.590313487951285],[-98.37471259730057,40.59032045203848],[-98.37471509841112,40.5901317883289],[-98.3741348407684,40.590126090423354],[-98.37413233965788,40.590313487951285]]]},"properties":{"id":"Perkins Library"}},{"type":"Feature","geometry":{"type":"Polygon","coordinates":[[[-98.3736191179045,40.59064334156154],[-98.37362033072382,40.59056689953065],[-98.37387380996378,40.59057058348595],[-98.37387866124111,40.5903256000165],[-98.3736639922197,40.59032283703991],[-98.37366520503903,40.59030073322319],[-98.37333455263524,40.590296927283184],[-98.37333901987164,40.59001629518303],[-98.37333621176148,40.59001558437107],[-98.37294307634048,40.59001416274713],[-98.37294319965034,40.59029870430257],[-98.37297039172454,40.59029870430257],[-98.37297048222555,40.590645772706125],[-98.3736191179045,40.59064334156154]]]},"properties":{"id":"Kiewit Building"}},{"type":"Feature","geometry":{"type":"Polygon","coordinates":[[[-98.37470203634304,40.59087627765015],[-98.37471045132412,40.59047904286837],[-98.3744961893785,40.59047775154998],[-98.3744877169096,40.590874449011885],[-98.37470203634304,40.59087627765015]]]},"properties":{"id":"Hurley-McDonald Hall"}},{"type":"Feature","geometry":{"type":"Polygon","coordinates":[[[-98.37353314553962,40.59087905110178],[-98.37353314553962,40.590708779882675],[-98.37343235743603,40.590709639839424],[-98.37342896008421,40.59087905110178],[-98.37353314553962,40.59087905110178]]]},"properties":{"id":"Name1"}},{"type":"Feature","geometry":{"type":"Polygon","coordinates":[[[-98.37382750296666,40.591193020762205],[-98.37382980649612,40.59115891068626],[-98.37386551120254,40.59115891068626],[-98.37387127002614,40.590980488467004],[-98.37383211002555,40.59097961384712],[-98.37382980649612,40.59094812752329],[-98.37358217708065,40.59094462904195],[-98.37357987355122,40.5911921461451],[-98.37382750296666,40.591193020762205]]]},"properties":{"id":"Daugherty Student Engagement Center"}},{"type":"Feature","geometry":{"type":"Polygon","coordinates":[[[-98.37229446140842,40.59159148756918],[-98.37223367991126,40.591483310642786],[-98.37238183481058,40.59144580926746],[-98.37226027181626,40.59117752958438],[-98.37226217123805,40.59064529412409],[-98.37211591576053,40.59063952461079],[-98.3721178151823,40.59070587398362],[-98.372022844093,40.59070731636056],[-98.372022844093,40.590756357157964],[-98.37191647647298,40.590759241909645],[-98.3719107782076,40.59114002803756],[-98.37187278977188,40.591154451711894],[-98.37211211691694,40.59164773950174],[-98.37229446140842,40.59159148756918]]]},"properties":{"id":"Morrison-Reeves Science Center"}},{"type":"Feature","geometry":{"type":"Polygon","coordinates":[[[-98.37336463965526,40.591802138119164],[-98.37337046026076,40.59172257877987],[-98.37363587987099,40.59172611475252],[-98.3736393722343,40.59156345981731],[-98.37337046026076,40.59155903984072],[-98.37337395262405,40.59147948021219],[-98.37323658633453,40.591475060230046],[-98.37323891457672,40.59155903984072],[-98.373206319186,40.59155815584537],[-98.37320748330708,40.591719042807036],[-98.37323891457672,40.591719042807036],[-98.37323658633453,40.59179860215054],[-98.37336463965526,40.591802138119164]]]},"properties":{"id":"Calvin H. French Memorial Chapel "}},{"type":"Feature","geometry":{"type":"Polygon","coordinates":[[[-98.37201576628836,40.59262743658687],[-98.37201700980901,40.592578334337375],[-98.37203317557764,40.592578334337375],[-98.37204312374293,40.59206842423039],[-98.37202695797433,40.59206747994882],[-98.37202944501566,40.59201271159418],[-98.3719846782718,40.59201271159418],[-98.37198343475114,40.592025931545955],[-98.37195607729657,40.592026875828125],[-98.37195483377592,40.5920627585407],[-98.37188768366015,40.592063702822344],[-98.3718789790155,40.592578334337375],[-98.37194364208995,40.59257927861174],[-98.37194239856929,40.59260666256263],[-98.3719809477098,40.59260666256263],[-98.37197970418916,40.59262743658687],[-98.37201576628836,40.59262743658687]]]},"properties":{"id":"Altman Hall Residency"}},{"type":"Feature","geometry":{"type":"Polygon","coordinates":[[[-98.37345908377378,40.592428311631785],[-98.37346414649254,40.592127677901516],[-98.37348540991137,40.592127677901516],[-98.37354717508036,40.59209077136578],[-98.37348844754263,40.59203771818496],[-98.3731381074038,40.59203694929797],[-98.3731340572288,40.592211486417455],[-98.37322214853538,40.59221379307237],[-98.3732170858166,40.592428311631785],[-98.37345908377378,40.592428311631785]]]},"properties":{"id":"Scott Studio Theatre"}},{"type":"Feature","geometry":{"type":"Polygon","coordinates":[[[-98.37378031069133,40.59233336628362],[-98.37378112606382,40.592306742401384],[-98.37381863319813,40.59230736156156],[-98.37382271006055,40.592159382117295],[-98.37378520292624,40.59215876295575],[-98.37378520292624,40.59213151984219],[-98.37363680513397,40.59212966235677],[-98.37363680513397,40.59215133301679],[-98.37359522113724,40.59215133301679],[-98.37359032890232,40.59231107652247],[-98.37363272827155,40.59231107652247],[-98.37363354364403,40.59233336628362],[-98.37378031069133,40.59233336628362]]]},"properties":{"id":"McCormick Hall"}},{"type":"Feature","geometry":{"type":"Polygon","coordinates":[[[-98.37472106546831,40.59285396151976],[-98.3747264832459,40.59266057179469],[-98.3747658645213,40.59266160297934],[-98.37476450654628,40.59255229731774],[-98.37474549489609,40.59255126613141],[-98.37474549489609,40.59250692510384],[-98.37467895412038,40.59250692510384],[-98.37467895412038,40.592480114235705],[-98.37464228879502,40.592479083048254],[-98.37464093082,40.59250795629086],[-98.37457846396934,40.59250795629086],[-98.37457826932462,40.59254912199468],[-98.37452034258709,40.59254809904091],[-98.37451764832021,40.59265857795722],[-98.37457018652402,40.59265755500513],[-98.37456479799032,40.59285498446884],[-98.37472106546831,40.59285396151976]]]},"properties":{"id":"Taylor Hall Residence"}},{"type":"Feature","geometry":{"type":"Polygon","coordinates":[[[-98.3737386139963,40.592822505804655],[-98.3737406459065,40.592765417120646],[-98.37377315646964,40.59276618858968],[-98.37377417242475,40.59266744048179],[-98.37374369377179,40.59266666901163],[-98.37374470972688,40.59260417989853],[-98.37339826903835,40.59259955107303],[-98.37339217330776,40.592818648462675],[-98.3737386139963,40.592822505804655]]]},"properties":{"id":"Wilson Center"}},{"type":"Feature","geometry":{"type":"Polygon","coordinates":[[[-98.3710880581408,40.59285384881594],[-98.37108495134117,40.59269460559814],[-98.37111757273735,40.59269460559814],[-98.37111912613716,40.592625010294974],[-98.37109116494044,40.59262265113089],[-98.37109116494044,40.592462227777595],[-98.37088766956425,40.59245986860776],[-98.37088922296408,40.59250115406781],[-98.3708488345688,40.59249997448359],[-98.37084572776917,40.59285384881594],[-98.3710880581408,40.59285384881594]]]},"properties":{"id":"Batchelder General Services"}},{"type":"Feature","geometry":{"type":"Polygon","coordinates":[[[-98.37139804641792,40.59329458891759],[-98.37139804641792,40.59319899088562],[-98.37129990788338,40.59319823814465],[-98.3712969339884,40.59329308343783],[-98.37139804641792,40.59329458891759]]]},"properties":{"id":"Campus Safety"}},{"type":"Feature","geometry":{"type":"Polygon","coordinates":[[[-98.37252975651616,40.593156827790594],[-98.37252881637454,40.59312398858383],[-98.37250813325893,40.59312327468785],[-98.37251095368379,40.59305259894826],[-98.37230600281096,40.59304902946449],[-98.37230882323581,40.59292195571781],[-98.37217062241788,40.59292195571781],[-98.37217062241788,40.593047601670925],[-98.37191960460574,40.593045459980516],[-98.37191866446413,40.59312184689587],[-98.37189234049882,40.59312184689587],[-98.37189328064044,40.593152544416704],[-98.3719572102705,40.593152544416704],[-98.3719572102705,40.59316468064199],[-98.37217062241788,40.59316468064199],[-98.37217156255952,40.59315325831238],[-98.37224959431384,40.593155399999326],[-98.37224865417222,40.59316682232858],[-98.37246206631963,40.59316967791059],[-98.37246394660288,40.59315468610369],[-98.37252975651616,40.593156827790594]]]},"properties":{"id":"Bronc Hall Residence"}},{"type":"Feature","geometry":{"type":"Polygon","coordinates":[[[-98.3719064320083,40.59411748386439],[-98.3719042258795,40.593967720122386],[-98.37117739164582,40.59396468762685],[-98.3711813852405,40.59380093266361],[-98.3719042258795,40.59379486765727],[-98.37191298350861,40.59360363963602],[-98.37092978877502,40.59359775465171],[-98.37093115856794,40.59412493085915],[-98.3719064320083,40.59411748386439]]]},"properties":{"id":"The 1882 Residence Hall"}},{"type":"Feature","geometry":{"type":"Polygon","coordinates":[[[-98.37297358496218,40.594287236848594],[-98.37302656725574,40.594179361354826],[-98.37318062346203,40.59422593696438],[-98.37321057883548,40.59415661511511],[-98.37328903338498,40.594179361354826],[-98.3734202664496,40.59391832071013],[-98.37334181190009,40.59389665754029],[-98.37335892925634,40.5938717448863],[-98.37293670113542,40.593748264638194],[-98.37292243667187,40.59377317733819],[-98.37255726640511,40.593660528533846],[-98.37249307631916,40.59376559521309],[-98.37264713252546,40.593813254270884],[-98.37260576558117,40.59390857228456],[-98.37245313582125,40.59386199645395],[-98.37236130461655,40.5940333213648],[-98.37244344372661,40.594057941663856],[-98.37243407698598,40.59407927924903],[-98.3725123372465,40.594103359502135],[-98.37250152675315,40.59412524968894],[-98.37257936230517,40.59414878163177],[-98.37257071391052,40.594169030041066],[-98.37297358496218,40.594287236848594]]]},"properties":{"id":"Hazelrigg Student Union"}},{"type":"Feature","geometry":{"type":"Polygon","coordinates":[[[-98.37003093644454,40.59489319890186],[-98.37002539427893,40.594554427576305],[-98.36991824574359,40.594554427576305],[-98.36991824574359,40.594491302294855],[-98.36939635848097,40.59449551064881],[-98.36939635848097,40.59456985819158],[-98.36930768383104,40.59456915680006],[-98.36931045491386,40.5949002127828],[-98.37003093644454,40.59489319890186]]]},"properties":{"id":"Physical Fitness Facility"}},{"type":"Feature","geometry":{"type":"Polygon","coordinates":[[[-98.3707569741431,40.595997812186724],[-98.3707609796432,40.59595345634213],[-98.37093925863765,40.59595608489197],[-98.37093579690959,40.59587065696967],[-98.37126985366618,40.59587459979926],[-98.37126985366618,40.595589401192704],[-98.37099983887846,40.59558677262847],[-98.37099983887846,40.595392258587665],[-98.36994747355205,40.59538963001566],[-98.3699455880793,40.59587362637473],[-98.3702990362079,40.59587224653109],[-98.37030085342192,40.59595296733678],[-98.37043169283199,40.59595227741577],[-98.37042896701095,40.595997812186724],[-98.3707569741431,40.595997812186724]]]},"properties":{"id":"Lynn Farrell Arena/Fleharty Educational Center"}},{"type":"Feature","geometry":{"type":"Polygon","coordinates":[[[-98.37211946976164,40.595036751142146],[-98.37209853033835,40.595007397045535],[-98.37215327445425,40.59498984579718],[-98.37194527282195,40.59469129454744],[-98.37194712982472,40.594305952303756],[-98.37169736008775,40.5943052575816],[-98.37169708368509,40.594470035453604],[-98.37176513394347,40.59446865751005],[-98.37176604128025,40.5945802708457],[-98.37153514181085,40.59467504115343],[-98.37155328864164,40.59470053315958],[-98.37153877117701,40.59470397802453],[-98.37157052813086,40.594785965758],[-98.37158504559547,40.59478114295293],[-98.37158595293702,40.59481421360927],[-98.37186178476472,40.594816280524746],[-98.37186178476472,40.59482661510118],[-98.3718844683032,40.59482799304458],[-98.3718826536201,40.59485210704955],[-98.37185180400779,40.59486313059177],[-98.37190170779242,40.59493685048371],[-98.3718871903278,40.594941673277546],[-98.37198881258011,40.59508980177594],[-98.37211946976164,40.595036751142146]]]},"properties":{"id":"Hayes M. Fuhr Hall of Music"}},{"type":"Feature","geometry":{"type":"Polygon","coordinates":[[[-98.37538555821986,40.59328018799004],[-98.37538724870973,40.59309726484104],[-98.37520974727416,40.59309405565852],[-98.37521059251908,40.5931608066232],[-98.37519875909004,40.5931608066232],[-98.37519537811033,40.59327890432057],[-98.37538555821986,40.59328018799004]]]},"properties":{"id":"The Stone Health Center"}},{"type":"Feature","geometry":{"type":"Polygon","coordinates":[[[-98.37471015347589,40.59324279822121],[-98.37471437942709,40.592969393604285],[-98.37457407784693,40.5929681100119],[-98.37457069708597,40.59313433502105],[-98.37436278028643,40.59313369322644],[-98.3743602447157,40.59324023104691],[-98.37471015347589,40.59324279822121]]]},"properties":{"id":"Babcock Hall Residence"}},{"type":"Feature","geometry":{"type":"Polygon","coordinates":[[[-98.37464990421633,40.59375608706591],[-98.37465352180178,40.593639797917334],[-98.37456187630376,40.59363888225395],[-98.3745570528565,40.59375608706591],[-98.37464990421633,40.59375608706591]]]},"properties":{"id":"611 E. 9th St"}},{"type":"Feature","geometry":{"type":"Polygon","coordinates":[[[-98.3742242349953,40.593824761664976],[-98.3742242349953,40.593780809929704],[-98.37426523429703,40.593780809929704],[-98.37427005774431,40.593658111182506],[-98.37412414846457,40.59365627985621],[-98.37412173674093,40.593824761664976],[-98.3742242349953,40.593824761664976]]]},"properties":{"id":"905 N Elm Ave"}},{"type":"Feature","geometry":{"type":"Polygon","coordinates":[[[-98.37328303907076,40.59576922084294],[-98.37317465862661,40.595267009011295],[-98.37290194299486,40.59530583646519],[-98.37292020520233,40.595377020072085],[-98.3728508088139,40.595386264690795],[-98.37291395234293,40.595698179498136],[-98.37300321983061,40.59568449262486],[-98.37301866997268,40.59575031994207],[-98.37316630466383,40.59573076728035],[-98.37316973802872,40.59576335504669],[-98.37323926366815,40.59575227520792],[-98.37324527205675,40.59577573839374],[-98.37328303907076,40.59576922084294]]]},"properties":{"id":"Gray Center"}},{"type":"Feature","geometry":{"type":"Polygon","coordinates":[[[-98.37355669887391,40.59683971651677],[-98.37346882100307,40.59659623606328],[-98.37349312764819,40.59659197692209],[-98.3734622769063,40.596499695463045],[-98.37332952522907,40.596526670056555],[-98.37330428371297,40.59644929553547],[-98.37297801374571,40.59651176304569],[-98.37254797310115,40.59649259688399],[-98.37254516848826,40.596542996778915],[-98.37256106129469,40.59659481634959],[-98.37255171258502,40.596682128686005],[-98.37264706942358,40.59668425825375],[-98.37264426481069,40.596737497425636],[-98.3727667329073,40.59674175655755],[-98.37276766777826,40.59669277652411],[-98.37282376003624,40.596682128686005],[-98.37300979935856,40.59668851738907],[-98.37300512500373,40.596779378877706],[-98.37291163790708,40.59679499568363],[-98.3729247261006,40.59683758695397],[-98.37296586042312,40.5968361672454],[-98.37296586042312,40.596802094230576],[-98.37299110193923,40.596887986588825],[-98.37307617519718,40.59686882053498],[-98.37309393774554,40.596929158093324],[-98.37355669887391,40.59683971651677]]]},"properties":{"id":"Jackson Dinsdale Art Center"}},{"type":"Feature","geometry":{"type":"Polygon","coordinates":[[[-98.36946922209306,40.59663009808219],[-98.36946309192157,40.59646951080968],[-98.36938339969201,40.596471838164206],[-98.36938646477778,40.59621582868018],[-98.36946922209306,40.59621582868018],[-98.36946309192157,40.59595516347105],[-98.36938952986353,40.59595516347105],[-98.36938646477778,40.59568984248238],[-98.36946615700731,40.59568984248238],[-98.36946309192157,40.59554321727376],[-98.36923321049021,40.595536235112945],[-98.36923321049021,40.596632425431125],[-98.36946922209306,40.59663009808219]]]},"properties":{"id":"Lloyd Wilson Field/Stadium"}},{"type":"Feature","geometry":{"type":"Polygon","coordinates":[[[-98.36635224661157,40.5952162806942],[-98.36635339463838,40.594929482162954],[-98.36611345703568,40.594929482162954],[-98.36611116098207,40.595215408968],[-98.36635224661157,40.5952162806942]]]},"properties":{"id":"Bronco Village Apartments 3"}},{"type":"Feature","geometry":{"type":"Polygon","coordinates":[[[-98.36594778233456,40.59521075896037],[-98.36594433215241,40.595025407005174],[-98.36560448920957,40.59502671691478],[-98.36560621430067,40.595043090782795],[-98.36556481211473,40.595043090782795],[-98.36556912484242,40.59519242027393],[-98.36560362666404,40.595191765320756],[-98.36560362666404,40.59521337877231],[-98.36594778233456,40.59521075896037]]]},"properties":{"id":"Bronco Village Apartments 4"}},{"type":"Feature","geometry":{"type":"Polygon","coordinates":[[[-98.36581753737377,40.59488116136897],[-98.36582035820989,40.594594140268],[-98.36557917672252,40.594593069291435],[-98.36557776630447,40.59489829691811],[-98.36562431010026,40.59489936788978],[-98.36562431010026,40.594879019425015],[-98.36581753737377,40.59488116136897]]]},"properties":{"id":"Bronco Village Apartments 1"}},{"type":"Feature","geometry":{"type":"Polygon","coordinates":[[[-98.36636763296093,40.59478975582371],[-98.3663640756504,40.59460499524451],[-98.36598486634739,40.594606075717216],[-98.36598842365792,40.59476814642561],[-98.36602186237695,40.59476868666066],[-98.36602186237695,40.59479029605858],[-98.36636763296093,40.59478975582371]]]},"properties":{"id":"Bronco Village Apartments 2"}},{"type":"Feature","geometry":{"type":"Polygon","coordinates":[[[-98.36542716760385,40.59439543172675],[-98.36542432429836,40.59422414915383],[-98.36538736132702,40.594225588505026],[-98.36538830909551,40.59420543758567],[-98.36508217987125,40.59420543758567],[-98.36508407540826,40.59422630818061],[-98.3650442691314,40.59422630818061],[-98.3650433213629,40.59437815955442],[-98.36508217987125,40.59437815955442],[-98.36508312763975,40.59439615140052],[-98.36542716760385,40.59439543172675]]]},"properties":{"id":"Bronco Village Apartments 5"}},{"type":"Feature","geometry":{"type":"Polygon","coordinates":[[[-98.36597687333165,40.594175930871394],[-98.36597687333165,40.59398737546289],[-98.3655949226277,40.59398881481917],[-98.36559302709068,40.594155060260746],[-98.36563188559904,40.5941543405844],[-98.36563283336753,40.59417521119527],[-98.36597687333165,40.594175930871394]]]},"properties":{"id":"Bronco Village Apartments 6"}},{"type":"Feature","geometry":{"type":"Polygon","coordinates":[[[-98.3646686039858,40.595412581009995],[-98.36494650785933,40.595223709584495],[-98.36492058096735,40.59520402262996],[-98.36498701862807,40.595156035653986],[-98.36490680730597,40.595086515999505],[-98.36483631856838,40.59513450302537],[-98.36481120189175,40.59511481604457],[-98.36470911475455,40.595181874799174],[-98.36465645075519,40.59513327258924],[-98.36458110072535,40.595182490016796],[-98.36463295450933,40.59522801610503],[-98.3645316775875,40.59529938126202],[-98.3646686039858,40.595412581009995]]]},"properties":{"id":"Barrett Alumni Center"}},{"type":"Feature","geometry":{"type":"Polygon","coordinates":[[[-98.37338949046577,40.58959597891962],[-98.3733933780237,40.58945132240717],[-98.37327675128608,40.589449551101],[-98.37327286372816,40.58959361718315],[-98.37338949046577,40.58959597891962]]]},"properties":{"id":"706 E. 7th St. Residence"}},{"type":"Feature","geometry":{"type":"Polygon","coordinates":[[[-98.37321144031304,40.58958535110486],[-98.37321299533619,40.589450141536396],[-98.37309792362176,40.5894489606656],[-98.37309559108701,40.58958535110486],[-98.37321144031304,40.58958535110486]]]},"properties":{"id":"710 E. 7th St. Residence"}},{"type":"Feature","geometry":{"type":"Polygon","coordinates":[[[-98.37301550739384,40.58959538848551],[-98.3730225049981,40.58935803355154],[-98.37315079440947,40.58935921442396],[-98.37315312694422,40.58927655330535],[-98.37305827053098,40.58927537243149],[-98.37305749301939,40.58930607514516],[-98.37299218204632,40.58930489427181],[-98.37299140453474,40.5893633474772],[-98.37294008877019,40.5893633474772],[-98.37294164379337,40.58939582145811],[-98.37290976581842,40.58939523102224],[-98.3729058782605,40.58959538848551],[-98.37301550739384,40.58959538848551]]]},"properties":{"id":"714 E. 7th St. Residence"}},{"type":"Feature","geometry":{"type":"Polygon","coordinates":[[[-98.37481677520717,40.59378243356543],[-98.3748159702016,40.59364459103049],[-98.37470492415694,40.59364364015712],[-98.37470219608254,40.59378243356543],[-98.37481677520717,40.59378243356543]]]},"properties":{"id":"607 E 9th St"}},{"type":"Feature","geometry":{"type":"Polygon","coordinates":[[[-98.37505232877834,40.59378603329276],[-98.37505232877834,40.59363389370436],[-98.3749411932886,40.59363270511246],[-98.37493806271144,40.59378603329276],[-98.37505232877834,40.59378603329276]]]},"properties":{"id":"McKay House"}},{"type":"Feature","geometry":{"type":"Polygon","coordinates":[[[-98.37020808429642,40.59325096070355],[-98.3702087922692,40.59304678270344],[-98.37007215242993,40.593048143336304],[-98.37007148052594,40.59305373388376],[-98.37007497105584,40.59325096070355],[-98.37020808429642,40.59325096070355]]]},"properties":{"id":"906 E 9th St"}},{"type":"Feature","geometry":{"type":"Polygon","coordinates":[[[-98.3713716620568,40.59216760861196],[-98.3713716620568,40.59208501885758],[-98.37123658640381,40.592083686763935],[-98.37123658640381,40.592170272795876],[-98.3713716620568,40.59216760861196]]]},"properties":{"id":"812 N Ash Ave"}},{"type":"Feature","geometry":{"type":"Polygon","coordinates":[[[-98.36464455503827,40.59679561799539],[-98.36463932654875,40.596677310926374],[-98.36453998524793,40.5966765169185],[-98.36454207664373,40.59679561799539],[-98.36464455503827,40.59679561799539]]]},"properties":{"id":"Track and Field Bldg"}},{"type":"Feature","geometry":{"type":"Polygon","coordinates":[[[-98.36965398066555,40.593744199868496],[-98.36965405093474,40.59365994990944],[-98.36954361128338,40.59365812658123],[-98.3695406283271,40.593617354985426],[-98.36948842659228,40.59361962007473],[-98.36947649476718,40.59365472894918],[-98.36939595494776,40.5936592591252],[-98.36940192086031,40.59372834427127],[-98.36956150902101,40.593729476814055],[-98.36956001754288,40.593744199868496],[-98.36965398066555,40.593744199868496]]]},"properties":{"id":"919 E 9th St"}},{"type":"Feature","geometry":{"type":"Polygon","coordinates":[[[-98.37008066320352,40.593013815355334],[-98.37007499198425,40.59285662996286],[-98.36996865662302,40.59285555334931],[-98.36996865662302,40.59301596857732],[-98.37008066320352,40.593013815355334]]]},"properties":{"id":"906 E 9th Shop"}},{"type":"Feature","geometry":{"type":"Polygon","coordinates":[[[-98.36470483485375,40.59630123687602],[-98.36470531685886,40.59624427196405],[-98.36464879410502,40.59624342564423],[-98.36464822803686,40.59630123687602],[-98.36470483485375,40.59630123687602]]]},"properties":{"id":"Track Crow's Nest"}},{"type":"Feature","geometry":{"type":"Polygon","coordinates":[[[-98.37023372914739,40.595094721688106],[-98.37023150722197,40.59495581137795],[-98.37016336817577,40.59495524898744],[-98.37016484945937,40.595094721688106],[-98.37023372914739,40.595094721688106]]]},"properties":{"id":"PFF Garage"}},{"type":"Feature","geometry":{"type":"Polygon","coordinates":[[[-98.3705735039571,40.592940809149134],[-98.37057352063869,40.59285868774397],[-98.37041476202107,40.59285813038717],[-98.37041272686803,40.592940809149134],[-98.3705735039571,40.592940809149134]]]},"properties":{"id":"Batchelder Garage"}}]`),oM={type:rM,features:sM},aM="GeometryCollection",lM=[{type:"Polygon",coordinates:[[[-98.3702723467576,40.59295246060802],[-98.3712898200761,40.59296962250515],[-98.37127145248702,40.593452202532475],[-98.3693821617939,40.59343919245249],[-98.3693821617939,40.59396210621867],[-98.36898697694681,40.59395690670241],[-98.36897317608825,40.595313897438444],[-98.36666104991127,40.59530626415921],[-98.3666645004967,40.59434137689304],[-98.3660775631237,40.594328458560554],[-98.3660903226318,40.59391184099969],[-98.36552890427502,40.593908611396046],[-98.3655251986316,40.59414249211982],[-98.36432525734347,40.59413791286647],[-98.36427367897022,40.59707709495426],[-98.37377329389933,40.59709097965043],[-98.37386191086847,40.59401359006412],[-98.37508078915154,40.594020829208134],[-98.37509913072566,40.59343618356128],[-98.37541607762186,40.59342916474601],[-98.37541607762186,40.59304686495786],[-98.37491595389913,40.593044333163895],[-98.37497941341485,40.58982081072618],[-98.37347119813148,40.58981164082747],[-98.373477248548,40.58922812309826],[-98.37287220689669,40.589232717745936],[-98.37286010606364,40.58981164082747],[-98.37161977067842,40.58981164082747],[-98.37159980641273,40.59071814140597],[-98.37034264550859,40.590714592488666],[-98.37035943903622,40.59162321748957],[-98.37107540475405,40.59163250297191],[-98.37106656585733,40.592037456704084],[-98.37065419418758,40.59203614756078],[-98.37065535506281,40.59209797250316],[-98.37051258408789,40.59209551837214],[-98.37051409247337,40.59219975052995],[-98.37028934303831,40.59219975052995],[-98.3702875945045,40.59227459272085],[-98.37028731105269,40.59253351783216],[-98.37009609918391,40.59252977623261],[-98.36990069493494,40.59252314685871],[-98.36990818515268,40.5933535522459],[-98.37026022538576,40.59335639608224],[-98.3702723467576,40.59295246060802]]]}],cM={type:aM,geometries:lM},uM="FeatureCollection",hM=JSON.parse(`[{"type":"Feature","geometry":{"type":"Polygon","coordinates":[[[-94.5732546949417,39.033957896346706],[-94.57326522382158,39.033796212560006],[-94.5729226302682,39.033781742786736],[-94.57291453112981,39.03394783044083],[-94.5732546949417,39.033957896346706]]]},"properties":{"id":"Physical Plant Operations"}},{"type":"Feature","geometry":{"type":"Polygon","coordinates":[[[-94.57330618126248,39.03329184109743],[-94.57333069079144,39.032868879640596],[-94.57332112401924,39.03286702180975],[-94.57332590740536,39.03279828203385],[-94.57289061927166,39.032835438677765],[-94.57286046661933,39.03328233695542],[-94.57330618126248,39.03329184109743]]]},"properties":{"id":"St. Luke's Urgent Care"}},{"type":"Feature","geometry":{"type":"Polygon","coordinates":[[[-94.57151501542803,39.03292423985276],[-94.57151293405649,39.032993004805604],[-94.57184717798721,39.03300418514015],[-94.57184478733176,39.03304318257621],[-94.57179856799333,39.03305618171678],[-94.57179298979729,39.03312055837771],[-94.571829646514,39.033121177383784],[-94.57181849012196,39.033266024655184],[-94.5720280709153,39.03327654773599],[-94.57204321173309,39.033054943703505],[-94.5720575556657,39.03305556271014],[-94.5720631338617,39.03295156951771],[-94.572026477145,39.032949093487446],[-94.57203205534103,39.03290576294391],[-94.57191730388003,39.03289895385609],[-94.57191252256916,39.0329466174571],[-94.57185434995351,39.03294537944191],[-94.57185275618323,39.03297261577139],[-94.57165911309279,39.032966425697424],[-94.57166230063338,39.032929904250025],[-94.57151501542803,39.03292423985276]]]},"properties":{"id":"St. Peter Claver Jesuit Community"}},{"type":"Feature","geometry":{"type":"Polygon","coordinates":[[[-94.57320143143617,39.03248280295288],[-94.5732236476623,39.03206766728228],[-94.57287806192237,39.03205807982458],[-94.57285214299189,39.0324693805906],[-94.57320143143617,39.03248280295288]]]},"properties":{"id":"Greenlease Library"}},{"type":"Feature","geometry":{"type":"Polygon","coordinates":[[[-94.57258061133909,39.03244157711775],[-94.57259171945215,39.03223353009446],[-94.57203878226827,39.03221147899157],[-94.57202520568563,39.03242240230252],[-94.57258061133909,39.03244157711775]]]},"properties":{"id":"Conway Hall"}},{"type":"Feature","geometry":{"type":"Polygon","coordinates":[[[-94.5729983573256,39.031851550588144],[-94.57299756184071,39.031777457537544],[-94.57321564931763,39.03178334435931],[-94.57323249004943,39.03143209646873],[-94.57296205948676,39.031423909721845],[-94.57296447934267,39.03135905846342],[-94.57280960856365,39.03135529896836],[-94.5728071887077,39.03138819454341],[-94.57269708526324,39.03138631479668],[-94.57269708526324,39.03142109010315],[-94.57267409663196,39.03142015023023],[-94.572672886704,39.03149158053676],[-94.57274790223761,39.0314934602807],[-94.57273580295798,39.03168519389932],[-94.5727950894281,39.031686133768716],[-94.57279387950013,39.031724668403285],[-94.5728701049617,39.03172748800987],[-94.57286526524985,39.03184873098651],[-94.5729983573256,39.031851550588144]]]},"properties":{"id":"Sedgewick Hall"}},{"type":"Feature","geometry":{"type":"Polygon","coordinates":[[[-94.57326241323847,39.03143368161774],[-94.57327626990363,39.03124423732891],[-94.5730261570974,39.03123347343362],[-94.57301275849636,39.0314254445335],[-94.57326241323847,39.03143368161774]]]},"properties":{"id":"Greenlease Gallery"}},{"type":"Feature","geometry":{"type":"Polygon","coordinates":[[[-94.573095990435,39.03111733680814],[-94.57308496704151,39.031231510274026],[-94.57308922652759,39.0312361877],[-94.57325910712441,39.03124349870881],[-94.57328155089225,39.03098889143854],[-94.57264954299825,39.03095820723238],[-94.57262565897899,39.031273611693024],[-94.57279744019438,39.0312828882735],[-94.57281213805237,39.03110377869681],[-94.573095990435,39.03111733680814]]]},"properties":{"id":"Van Ackeren Hall"}},{"type":"Feature","geometry":{"type":"Polygon","coordinates":[[[-94.57168446809365,39.032022569107156],[-94.57169184016705,39.03180937961588],[-94.57179868570213,39.031816109120946],[-94.57180734885364,39.0318116227843],[-94.57183045059094,39.03127774669104],[-94.57147526137969,39.031266530763475],[-94.57148969996551,39.030961456851074],[-94.57133665095579,39.03095921365567],[-94.57130690259424,39.031697853704856],[-94.57146028857838,39.031697853704856],[-94.57144848965653,39.032017331773794],[-94.57168446809365,39.032022569107156]]]},"properties":{"id":"Massman Hall"}},{"type":"Feature","geometry":{"type":"Polygon","coordinates":[[[-94.57102622899816,39.03227668523504],[-94.57041136868395,39.032248511124756],[-94.57038028024108,39.03258659970685],[-94.57099514055531,39.03261611529995],[-94.57102622899816,39.03227668523504]]]},"properties":{"id":"Mason-Halpin Fieldhouse"}},{"type":"Feature","geometry":{"type":"Polygon","coordinates":[[[-94.57102622899816,39.03227668523504],[-94.5710435003553,39.03201775132257],[-94.57017475109112,39.0319855522205],[-94.57016266114111,39.03223509487781],[-94.57102622899816,39.03227668523504]]]},"properties":{"id":"Convocation Center"}},{"type":"Feature","geometry":{"type":"Polygon","coordinates":[[[-94.57003078591215,39.032220762006155],[-94.57011418121974,39.032159390693046],[-94.57010430545964,39.032152571654976],[-94.57011857044647,39.0321355240569],[-94.57007906740601,39.03210654313074],[-94.57011857044647,39.03207244790827],[-94.57010211084628,39.03205880981468],[-94.57012515428654,39.03204005743169],[-94.57007687279265,39.03200340503239],[-94.57005492665907,39.03201960028093],[-94.57003627244553,39.03200425741399],[-94.56983546532327,39.03214575261624],[-94.56986180068357,39.03216620973048],[-94.56983985454998,39.03218837159754],[-94.56987935759042,39.03221479535305],[-94.56989910911065,39.032200304907704],[-94.56992434716427,39.03221905724818],[-94.56996714212474,39.03218496207999],[-94.57000993708525,39.032220762006155],[-94.57001981284535,39.03221309059493],[-94.57003078591215,39.032220762006155]]]},"properties":{"id":"Student Activities Hall"}},{"type":"Feature","geometry":{"type":"Polygon","coordinates":[[[-94.5700079120054,39.03251153999033],[-94.57007391952787,39.03239788275361],[-94.56962616850038,39.03226029743301],[-94.56963937000486,39.03224064236535],[-94.56956236122863,39.03221756901809],[-94.569545859348,39.0322355149555],[-94.56911791057726,39.032091092758456],[-94.56905630355628,39.03220047764487],[-94.56942814593293,39.03231926260322],[-94.56943254643443,39.03240899211564],[-94.56956566160477,39.032447447586094],[-94.56962836875111,39.03238335512371],[-94.5700079120054,39.03251153999033]]]},"properties":{"id":"Corcoran Residence Hall"}},{"type":"Feature","geometry":{"type":"Polygon","coordinates":[[[-94.56854799775466,39.03168092891154],[-94.56855120851591,39.03148472512313],[-94.5683842489311,39.03148306237683],[-94.56838210842359,39.031552066315285],[-94.56833501725863,39.03155040357058],[-94.5683318064974,39.03160527412545],[-94.56837889766234,39.031604442753725],[-94.5683756869011,39.03167843479901],[-94.56854799775466,39.03168092891154]]]},"properties":{"id":"Town House Village"}},{"type":"Feature","geometry":{"type":"Polygon","coordinates":[[[-94.5694451877561,39.031137040617324],[-94.56944931800915,39.031079289457125],[-94.56924142860419,39.03107180319216],[-94.56923729835111,39.031130623824076],[-94.5694451877561,39.031137040617324]]]},"properties":{"id":"The Birdhouse"}},{"type":"Feature","geometry":{"type":"Polygon","coordinates":[[[-94.57023544284519,39.03101832984793],[-94.57024370335134,39.03090603569337],[-94.56974669623084,39.03088999365672],[-94.56974531947982,39.03083117282454],[-94.56960626762614,39.03082582547373],[-94.56960351412411,39.03088250737171],[-94.56911752101182,39.03087074320795],[-94.56911201400773,39.03097982901504],[-94.57023544284519,39.03101832984793]]]},"properties":{"id":"Xavier-Loyola Residence Hall"}},{"type":"Feature","geometry":{"type":"Polygon","coordinates":[[[-94.57110683934017,39.030625006944845],[-94.5711103812666,39.03058465303729],[-94.57115524566798,39.03058648730631],[-94.57116351016298,39.030412231536324],[-94.57103836209599,39.030407645852364],[-94.57103836209599,39.03042507144983],[-94.57075146605564,39.030415900083284],[-94.5707502854135,39.03054338197162],[-94.57072076935995,39.03054429910667],[-94.57071722743352,39.03061583560425],[-94.57110683934017,39.030625006944845]]]},"properties":{"id":"Magis Activity Center"}},{"type":"Feature","geometry":{"type":"Polygon","coordinates":[[[-94.57198788526269,39.03047484462258],[-94.57200861727132,39.03025032364125],[-94.57210130154519,39.03026832323989],[-94.57212569214357,39.03018021989759],[-94.57206837423735,39.02993485624719],[-94.57194154312575,39.02995664533168],[-94.57194032359583,39.029975592356216],[-94.57188544474947,39.02997275030286],[-94.57188544474947,39.029948119168985],[-94.57170739338125,39.029948119168985],[-94.57155373261142,39.029932961543864],[-94.57155373261142,39.02994906652044],[-94.57146348739738,39.0299414877084],[-94.57145373115803,39.03010916873508],[-94.57150129282489,39.03011201078295],[-94.57148665846586,39.03031758527588],[-94.57179885812519,39.03032705874041],[-94.5717927604756,39.030445476939825],[-94.57185373697156,39.03044831897417],[-94.57185495650148,39.030468213211414],[-94.57198788526269,39.03047484462258]]]},"properties":{"id":"Pedro Arrupe, S.J., Hall"}},{"type":"Feature","geometry":{"type":"Polygon","coordinates":[[[-94.57284047860178,39.0302797832297],[-94.57286427952926,39.029831426558175],[-94.5727080859427,39.02982911543394],[-94.572694697921,39.03005444969102],[-94.5725905688633,39.03005329413256],[-94.57258164351548,39.030234716579436],[-94.57268279745728,39.030237027690404],[-94.57267982234133,39.03027631656532],[-94.57284047860178,39.0302797832297]]]},"properties":{"id":"McGee Residence Hall"}},{"type":"Feature","geometry":{"type":"Polygon","coordinates":[[[-94.5730942108803,39.03066445893382],[-94.57317199672308,39.030664613464],[-94.57325985414333,39.030643791903515],[-94.57335366799886,39.03057901367613],[-94.57337898284875,39.03051307863372],[-94.57340366198356,39.02995448923646],[-94.57335443753462,39.029949304371044],[-94.57335193459656,39.029918843279034],[-94.57318507205777,39.02991495462804],[-94.57317172305467,39.03002707731239],[-94.57310581235186,39.03002837352735],[-94.5730700106048,39.030426554038584],[-94.57268280619707,39.03041812687501],[-94.57267696475127,39.03046998632717],[-94.57261938478547,39.03048035821303],[-94.57261604681642,39.03052508695338],[-94.57264692302996,39.03053999652721],[-94.57264692302996,39.030585373471666],[-94.57268864764288,39.03067936847824],[-94.5730858659577,39.03068714736974],[-94.5730942108803,39.03066445893382]]]},"properties":{"id":"St. Ignatius Science Center"}},{"type":"Feature","geometry":{"type":"Polygon","coordinates":[[[-94.57292884511348,39.02885017929442],[-94.57292884511348,39.02878607947923],[-94.57289583924593,39.02878607947923],[-94.57289790211264,39.02876043953688],[-94.57268542684032,39.02875242705299],[-94.57268336397358,39.02881973188946],[-94.57272049557459,39.02881973188946],[-94.57271843270787,39.02884697430505],[-94.57292884511348,39.02885017929442]]]},"properties":{"id":"University Marketing and Communication"}},{"type":"Feature","geometry":{"type":"Polygon","coordinates":[[[-94.57283326901032,39.028729445595104],[-94.57284341632814,39.02854814224998],[-94.57270405983009,39.028544463626574],[-94.57270270685437,39.028568111916584],[-94.57268511817016,39.028568111916584],[-94.57268308870658,39.028620663643835],[-94.5727020303665,39.028622240195055],[-94.57270000090294,39.02865902638007],[-94.57268241221873,39.02865902638007],[-94.57268173573087,39.02870684839195],[-94.5727006773908,39.028707899424816],[-94.5726993244151,39.028725766981125],[-94.57283326901032,39.028729445595104]]]},"properties":{"id":"Rock Row Housing N"}},{"type":"Feature","geometry":{"type":"Polygon","coordinates":[[[-94.57284691787102,39.02851897602392],[-94.57285908326953,39.0283383666503],[-94.57271782947576,39.02833311637091],[-94.57271715362029,39.02835674262511],[-94.5726975538116,39.02835726765288],[-94.57269417453423,39.02840924538392],[-94.57271512605388,39.02840924538392],[-94.572712422632,39.02844599729188],[-94.5726975538116,39.02844809740033],[-94.5726948503897,39.0284948247972],[-94.572712422632,39.028496399877454],[-94.57271174677652,39.02851582586437],[-94.57284691787102,39.02851897602392]]]},"properties":{"id":"Rock Row Housing S"}},{"type":"Feature","geometry":{"type":"Polygon","coordinates":[[[-94.57359514381248,39.02847208180017],[-94.57361271431651,39.028083475715746],[-94.57327990829927,39.02807143210462],[-94.57325923711807,39.028461644061366],[-94.57359514381248,39.02847208180017]]]},"properties":{"id":"Security Department"}},{"type":"Feature","geometry":{"type":"Polygon","coordinates":[[[-94.57480409573863,39.03238485708068],[-94.57475834188774,39.03234294052741],[-94.57478743748095,39.0323230514835],[-94.57466523598949,39.03222270213117],[-94.57465592539967,39.03222903047291],[-94.57456281950141,39.032149474135494],[-94.57455234508787,39.032154898434065],[-94.57453256008448,39.03213591338722],[-94.5745418706743,39.03212868098708],[-94.57443596271503,39.03204189212767],[-94.57444294565741,39.03200392196817],[-94.57448600713533,39.031963239631786],[-94.57446854977943,39.03195419910939],[-94.57445691154213,39.0319668558404],[-94.57437893535234,39.031978608517164],[-94.57437078858625,39.03197318420506],[-94.57426022533207,39.03199216929562],[-94.57421018091178,39.031950582900116],[-94.57410660059993,39.03202561920467],[-94.5741217303084,39.03203737187166],[-94.57391816391097,39.03218429006349],[-94.5739193483118,39.03221373112918],[-94.57398567475879,39.03222937169034],[-94.57396790874621,39.03229653406067],[-94.57383525585222,39.03238485708068],[-94.5738127522363,39.03243637879136],[-94.57379024862033,39.03244833918312],[-94.57380209262874,39.03245661945314],[-94.573822227443,39.03244281900256],[-94.57387552548074,39.03242901854928],[-94.57400462517222,39.032327815142885],[-94.57410885244606,39.03231401466714],[-94.57411122124773,39.032375656771244],[-94.57415030647543,39.03237933689516],[-94.5743552078206,39.03223397185472],[-94.574367051829,39.03224501224803],[-94.57443811587935,39.03218705016392],[-94.57453642114899,39.032267093029475],[-94.57452220833892,39.03227813341762],[-94.57461577600522,39.03235817618002],[-94.57462880441446,39.032348055835755],[-94.57464538602619,39.03236553642948],[-94.57466078323709,39.03235541608627],[-94.57474369129585,39.03242809851896],[-94.57480409573863,39.03238485708068]]]},"properties":{"id":"St. Francis Xavier Church"}},{"type":"Feature","geometry":{"type":"Polygon","coordinates":[[[-94.57151501542803,39.03292423985276],[-94.57133748256577,39.032919396176545],[-94.57133184858787,39.03302943092199],[-94.57151052617259,39.03303443249725],[-94.57151501542803,39.03292423985276]]]},"properties":{"id":"Campus Ministry Center"}},{"type":"Feature","geometry":{"type":"Polygon","coordinates":[[[-94.57133184858787,39.03302943092199],[-94.57132503847693,39.033133258595875],[-94.57150408963523,39.03313923484835],[-94.57151052617259,39.03303443249725],[-94.57133184858787,39.03302943092199]]]},"properties":{"id":"Kateri Community Residence"}},{"type":"Feature","geometry":{"type":"Polygon","coordinates":[[[-94.57286010900144,39.03328693338342],[-94.57283532620258,39.03371719964933],[-94.5732878874704,39.0337356369808],[-94.57330546295397,39.03329801918155],[-94.57286010900144,39.03328693338342]]]},"properties":{"id":"Prosperity Center for Financial Opportunity"}}]`),dM={type:uM,features:hM},fM="GeometryCollection",pM=[{type:"Polygon",coordinates:[[[-94.5733601221702,39.033991702842954],[-94.57343057843688,39.032627336829854],[-94.57483618218124,39.03266045740923],[-94.57483618218124,39.03225653248882],[-94.57456975228335,39.031925844267924],[-94.57443769998508,39.031865057522765],[-94.5734766527032,39.03184416206704],[-94.5737667714431,39.02721317928421],[-94.57318118713299,39.027186419902776],[-94.5731396822614,39.02830719202791],[-94.5726236948803,39.02827994478758],[-94.57256476148764,39.028963612429386],[-94.5679483123955,39.02883237317173],[-94.56774097288552,39.032390935290124],[-94.5688957036816,39.03245419936561],[-94.57042657308332,39.032720791128675],[-94.57108453863592,39.03274057444863],[-94.57121364975842,39.03280827134139],[-94.57119428309004,39.03315176939054],[-94.57150092200602,39.03315929122695],[-94.57153965534276,39.03306150729117],[-94.57173977758268,39.03306652185526],[-94.57178173869748,39.03329719141926],[-94.57214002206244,39.033307220513656],[-94.57216584428696,39.0332119440594],[-94.57283722212401,39.03322949499484],[-94.57279848878727,39.033964123097064],[-94.5733601221702,39.033991702842954]]]}],mM={type:fM,geometries:pM},H3="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASsAAACoCAMAAACPKThEAAAAw1BMVEUfISD///8AAAAcHh0ZGxpPUVAXGRgTFhT6+vpHSUgqLCttbm5VVlb19fUJDQsNEA6cnJyTk5O1tbXh4eE3OTg9Pj2+v7/r6+uJiokvMTB8fXwAHiH3UCTR0tIkJiUjIiHpTCQVICBiLiHIyMjn5+fa2tqsrKxmZ2e8vLx0dXWOjo4NHyGkpKRrbGuhPCP6USThSyTCRCNrMCK3QSONNyOsPyOLNyJWLCJHKCHUSCM9JyExJCF2MiLWSCNOKiIAGiGANCLlIKPoAAAMCElEQVR4nO2caXubOhOGQcKAF8Br8IJdu7bj2E6aLkmXdDn9/7/qaCQBksBb3vSEXu/cX9qAwdKT0TAzGmJZCIIgCIIgCIIgCIIgCIIgCIIgCIIgCIIgCIIgCIIgCIIgCIIgCIIgCIIgCPLf4BGOR9WDlB76eP6JwkdoTuHMGZdXnii8u572etPrZhQqh2ezE9fR2aww21mGFTLxj9zO8WaNUXr5G5NnTeSPQ8k4tiXxkKSjd+qBPYyOXUi6vr8m+r0agUKve0fSO0RD2x6pwrqznh/UHPHD/t1cI/m8f5nJvSyULplI/nq5XAfsP1NHDt+p28e1Yrqwz7dc/ZhvawRDKaaplWvFtt9K7z95lyTJfU5SSbuipMdmNG6Au2qM2ezX0rJOagWzt+2uZlig1XW9xmndteG3cEWyTytauY2VbdeyFb94e598+vI248viJef4UhA2n6sw5LOgYTS17RsxuZNaMZGX7OKCVm3icFwvJCP2gVv+CV0rdwZWpTjHyWOSfN0vMl5ugi9HyKawzHyUsLIN98intILzd1vjM1wrRQKHrG27D6ta08ptMA+pSsV4n3yb/K+z+bMQ347VSMGtwyqE/53SinTtgLDLNe9uamV5LXkXVauCVTH2H5PkodJihTvbbmqCkCvbroMhnNCKzgL7mpBr5nUU717QCj7GF7WilVdiVWwVfkrmT5VcexK25GL9qe8yQ+CzPaFVNAZN3Zru3QtaWdHKnupacak2plTWYjGv9CoEPfSpWTRi9nKGVswRwepj//iXaeWNyqzKWlgfWNjwu7pigXHUXP0YrXln+CtnYNvjSNxhnH+quAatQEQNqVYeRGUlVvX0Pknmyfx7ZbMe8M+FLMU5J74CR8UlJbbq3QtawV12cEBqxa2qKBU8BpPP3+fJh8oaFpnaPXLg3FGtwFyEn2Jyi2eBOG5qBZoO8piBW9Wq+JUTtgA/Tiafk+RHJZMbBlmx4OrAuaNawdIT2Q08C66zexhauWSbBu5cq6gf20EanSosWMDwmVnU5Fsyf1PRVUgCI0dROKoVc+mpQbJHqa9p1SEZtRuWjotFDlrNmFXF3rLoI5lG/BG4eEqSTxVdhSRQbMLgmFbg2XfSfCDyz7w7aNW7EohcfD0SuoBW9diOrWgUmAt/8XSffOSh1eSBrcVqrsLnagVeKJJrhUa2iAr4D0adYTUk0peBVoG9arhc3J32rfuHZC6tafIzeV/NgJTEaRmgyBGtKA2U68hN7t1Bq/V1l3G9YooMwsx38arEygEjg5hs4Cj3Y4lz+vxb/EqSx0quQjbq6TO04p4990r13FuLOoPwVWBuuZ8GrXozJ72z9rXsKZjpA5WsSlZkWPIXl8Q6nCNaQfEgzsufLGIKVK3EHWGdDvOb8+egdOmkzVycWpBRtLL2bBVW0WOFHRn9qDCbgH8Oa+X07QJNUVlXtKJebPuzzLC0mgyLVYJGbnMsbc5j0MXbJHlXwVUIwdFY14NN0ecL5LBWYDGdtkInW1NqfBVtbCV607SCSo0S2Cm+3RJlv19sFVbMuKgTmA4LJDqeO1M3ZhMNFaCOI8xTi0Xh8LZ8bwKi/bvs5otf96qPWkDZjz49vKmW24Ix97VFCEbDC6MHtYq22ZKTeMyCbrlCmlZQu8rSTaPezqKVwMp+ZJGCkgjyst8/j/fzamkFrkfLciDRC477K5ZExp5xKJYX6TkORFJpXmBoFTXVwtf+N6SD2Uko+/2ontcCw1IDQwiWOnyyh7QCec2EDp4R3NSMfJDJKqv3hT0vWKCtTHJIBH8pDmqeJNWLSfkm3zYNrh3CJi3r71yrkGrAcXJrLltYbdI8Da0gF4pJlg+qWlHKQtM09ueJ4PztRKqz+Ocz+7F6UZbHYkb7ZkTCKArJiP2y7br4bXOtiKcC4RF49mL8CjtnIKBZkwHtr0v2vBjhWC1Q7L8wU/r0dTLZ7yeTJ/YkTObfK6eVFW5YCudP28NhewnJXFqIA62CWCPYRZbXLIQZDDgKGhXrV7BlCuIXtOILtJ6twv3X90ygb48PD+++MdneV7PsF82meUw57ac6gFYmLLRkMXuxlJp5d9pIn4gSMFv+JIh2plbOiK3C/Mhi8gBqcebvJr/v739XLMICHNK64d0f8c2G5CXOUcdkzCbtdTrbEo/v3XXaIMWs09E7HKJxp11nJ5xWp200ykRNcSplYn18/PDz54fHH28m7NH48Lt6i9CC+iUhb2ZE7wGiUWjANYpCr+wWntznj0K3/IQTFjLP9FTGYsLhGu33lZSK8xf2jSEI8n+GV8DNzrjmh13PSf9z4Cr1SLGZlvfwhmYb7/OG8N/TaBaQGRw7szGiA2ezFR2e7qZ4FZ/VTDnQ6hOizSv0ml2+ueP3bppRdu/ZtngzJz1jDsHbbFuvJFZZxJnXGey6/msNY9n1B+G4QU/kg+ohP+7W1T64YaycjJtp3XlQHILYFIN0UkT9OSQ+vP37hwFF/ECnl2tlbOSFq3RnHppMNUQxFXKcLDHi219Xs3SLJ2I5o7/c3dXqtbsOpAoyG6T9whD8qSh1gFYrPQZj33xw6+kPA4p0rIZOVmdg57RxqVpNvZKrxD6Oy7FGtR2TNJYlPSjCXLEc3XN5J2l9nd4ctNrpQxjJIXCLa2tDeG2tjMpL3ifjG1sXmlak5CqRO6dH3JBkpXjIrq8V9+WCafKbg1Zm8UcOYcCHoDmCV9fq0JmhsZGna1VyUbHO0JVNImTK/KD2LkBNFva5VuUbRgM+BK0jtbJabdraHt8ztILp8mKNFZhzjDaipnFcq+1QdwSV1arJnnf+KF84l2tFqXhu0b6vF2sYrrjxca3GsHGrDKG6WoX6Rt7lWlmh+CQdFbVKrzmhlb6jX12tPNgC2+YbM5drJXtrqXWwzeSEVhEU+HNHUGGtKAs/g2yn/RlrcCbb4Zhv96PSgPuUVpSZpp1GaVXWiu+T3qSDu1wrL+0CgN6apVnbE9ec0Erf0X9trWTwKFHeiYM9P3jqp0mZrlXJVaZWFMxJmCVvrhk2CIkcXTCuVfkQZGM4dwRyCK+s1a18iS0lPwNaQc9D+sqOqtV6oF9V7GdgsWjYzV42oGILZN0d1mYhCfPlCFq1jSHksShoRR3mCOQQXlkrk1GW4/C9ZGU7XcsHDbI9+rS3Npy1OrGyeijZpblzb7mrZ7V9WtKiJORNteItN9IRVEsrv6FrxTdKxXb6Ea38TKs0D/Z57nyrBOth1LrupQ2lva08U6KVb2jFWwdEX02l1yCsHl9m+2etQQWoyajfRl3mrmrj2yUv6cjXhU+vwbQlhVqvrtVx326J7XTe7nGWb79pbhnNJfRJkGKUQN0oJFH/lona45XT077dEo1MvIbz2lodixk4fDvdPTdm4E0QETPGODq4j+aQ2VpuUZ+MGcQQpCOovFbQRwRlv0viK723o4gLHTq8PniWVnQU8FcdK6+VRXY8278oFgVjbJXuUcvzslxznlapI6i+VjyS7LsXaQUzLXmlKwM6Z0CjM7Xi2tfcv0ArdwDZ/mU5DrSxZwVg6pn5DVRK4avP1Qp+6pG/QCs+8SG5LB+EpFcWgGl/027oYl1qV9IR/AVa8WzfvUwrSHplARjar4wWN8jyLvBX4lvt2V+gFe86W/YuqzPwtwayZu5Yq7fDexXB+c9BAP54xHL9yrGoo2PkOBKYuK1qVXKVoRU0l8oCMKzhpbIz78BjsJPFV+VDMLTiN/FfVav2oG5ArRKtqLdStVr3jYsGtFiTie6yAjA8xlYbD5p4oY13wGJLsWMKWnXMIQz4EEytxH53hXJnpkf6jon+egRk+4frDAd6a5fpK100gibn+Ko9HI+Ht1CfmQorK6szyNdcClqBB6yWVtnfSNkavQTdI1rx8gT0M+g1ZIjORZGHkq16VTw+XGeQHfRFrbgjeC2trFmriJeeGZn5XKslmmGdWuEiGRy0WgPtIq/eavXTd3JIq7Ncx0EQT7t3+Z+7KxmC/HtrJUOg7JteranILZKdKaS+2SGncJFz4CJHPeKG6cusqsUWR+BkZw4PAUEQBEEQBEEQBEEQBEEQBEEQBEEQBEEQBEEQBEEQBEEQBEEQBEEQBEEQBPgXMfn8xaThU/gAAAAASUVORK5CYII=",_M="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAOEAAADhCAMAAAAJbSJIAAAAk1BMVEWZAAD///+VAACWAACSAADVqanp0dHlxcX+/PzPnJzJioqcDAy9aWnNl5f58fHftraiHR3z3t6fICCiCwvLkpLnysqfAADBenrhvLzz5eX46+ukLS3Gg4P99/eiEhL68fGlMTG+cXGgJyeqPz+rRUWwU1PXpqa0X1+0V1egFxfCd3e6Y2Pt0dGpOTmoNzepKSmyQUF3e9OwAAAOTklEQVR4nO2dCXeqPBPHSSauVRErKiqltq6tbZ/v/+leskwIaDW2VV9y+Z9zz62IkB/ZZiYLnlepUqV/UA/3TsC19RrSeyfhuoKl84SrOtw7DdcVrIJ7J+HKgo3zhJ2p440pLJL+vdNwXcE4frl3Gq4rNm7OnG5MYZWQ/e7eqbimWEgIWbicidRPCd9dJvQGAak5Degxn2wcJwzdroZpRayTsdvOBQvI3GlC2DZJMLh3Kq4p2oobZOVyRaS1+oJsXSZkk/rY7R6f1Rtj8uZyUwORPydtlwm9qDUnLZcJH5J2m0zYvZNxRc3itzapO5yHsCTvbeJytA02ZNUmkcPRNliQ1zZJHI5F0XY8aBPy6m6XT2uJlxI6bLbRekRTQpeNmqjOhsTlLn+Q+JzQ3SHEtDtsc0J3O0TokAUnnDo7OJO2MitO6G53wRrxTBC66wMHkUc5YdfVpualFzLeHzrbmMIqzTyRh642pnROFkBbKSH5vHdariPaIEugXU7YcbSpiaYjj645Yc3JigivJGSpe8EJ6/dOzFVE38iQ8gHEVE0nneC0Gm7AYxPibEXcTXs7NVeBkImDFTHtDeuMx/UF4fTeybmC0iaGh/MhEoRpv3HvBP29IjlwqAjd6y/SQhpxwNGUOFpM6USGZwaJJHTPgxrEopDCa6wIXfMvUnM04kiwJSjX5igm3KARcX2U71Qmpl5hLCaZCAdY6cWlTHyIiS/GRZXRJmuiQyOlnEt28djhCy2cKadsTnBo+zkxCMnAkXKauk2EfMosXJiAad10AZGyr5RlyCiX8iy0poyWnpGuG5wqnAgVAElz0ngrOyKNyGmV3gSngfOEfj05wRcE87KXUo+xtonUm8bmxxErPaAnx2KUJkuPjTpG1Xy8d+r+QgbhXOQY9RquEtaUIQre1E3CbF0enbtJWNe+BDw3nSQ05pWO4oqwTKoIy6+KsPyqCMuvirD8qgjLr4qw/KoIyy9N6DNQop6bhMF7BzV208c/poqwFKoIyy4AdopwRKHsAxfBft87QRjs6+tyD6+NTtAp1cs96cSCcO88YVBuQq87PKNuqXfGSk1Qdl5Q3uYUMkP0tEq74pKer4RSflmrIm2ehxOqVYT/r3K/lMLibX4eL1mMy7u8BKh3njBk5e0tvMpq+0cIy26Xnjdoyr5RJJzXvZNYqVKlSlcQVSoecKbNY2Esha8w2DXl50bJe2YttWCeENy/8Ul9do6w+Y8THlRW/YWMn9HiiXl5+doNhYvBYc3HoN3BHUHe8YJmworwpSvVGuXvxvptfx8E9Un7UZ7db3WPaLjzntQF+JsSYCXPesbLLFr6O5Wo0ZhfNwj9+VNuDQrzFn6YftFofVqvTbEhzOba51bV0w9jbdpkxNP+fNyfmMFA/cXHZXD8DfdTZGo9Bq6FhpFv/DZ81fkIXs3wUZaWQzxWhGu8rDlwxMY5ivgTPJgdBYxfoN/MqHD5M+6zgIuF1aIvuozzP8ftsuEj/8XYrqWwIWR6QZqxWpkuihxPFxLirjV5Qng9+L16gUS/QE46VrloQ/iYXTo7OCjej0dgLiNUzytPSKeHv++bKTWOW72GyILQ2BiBfGFFlNuU5TW7kDCWq4VzhEcHycU+MKvjx/+C0Nw2IHsfB65Im8zn2OCs2SdpCuHp8kP8fJxQ7rtQIMQsjIbjNRYT/opBhs1P0B5jgxP8EaG5bQAGc3Vt8Vm2oDktdZ/PqWZfquKG/WehtA4dJYxy1+eE8Km/Sq+L+4YEaeKYWrk55SuoVUYnNm8HsSmlRs3AOBJ01AEedqGqVY2YimJ4AV4D4xbHCeWLhExCXUhFK4KPjr+e7lF9IbaZVJ1P0ya2bEE4M9sUdQy7yJhvGAgb9Xj1T4LiNb4hFLP7coTq71jYFljZ07yCD/UTMcK6kxnatAlrnSfMbxugril3C0zvPfsVYe+lSKhyLWImYW+QNTSdvydEGCm1FykebPLRzp8TitbQJGR7+Xf9W8KxKPR/SqjOCGTjqWaNakNu8zvCAAqE2EYdEGIpFWbV3xKO5NV82Von8rDuI0UD2PkxIS/15wnFZjfqB6L8KkKr9xCdJYSlTNxQ3e1JHsbmhzdzsImEsjdZ2BOm5vYJwuFUXJi/M0qbNHwT+34g73hRW+rJkwFbZU2ouoKV+l/NFgHdzR/rde0J0yf0PaGpbGbuhdPGNOHnTHTOM+xyMXVMGRC7zxwRvGMaN0fuaE9I3qgdoTdCS6l1WfRBZ36ihBPvMHVqL4+pB/I4jo4B/rB3ZPLIBYR1sCRk2hJ+uwjx0GIvEPYlcgjq5k3Fk1nC0cdBLtoQNlVrsbQk9AB33GguLkE8R4g9QY2i6fufQsy8gOmBu22Vh115bP0NIeQDPWKffpSl82tFiMnpABJplwX0bhDxtoBoRdhRO3/CUUJ4n2eSjiDLJkJcsAn6OUJ8wM+AxdKYK5L9trCPlxXhQv2/PUpIs9009C69WVW8YJ8bTThF5QmVH5g86CHsKHM6HjLE/ItIrAjHL7JPnayPEhrhqB56SSwLRVnv4ad7i8Guz7XDqJhMHXzKVOwh89CykKKJmMtFO0LlHCWhNaERFLPOxYMe/yFPuMieGEb9jDfjgFFQTQvKkrBDTNkQmtETy37xjNWGPgQPd+HzM2s5eHu8YWJc1Y6QPuSiTt/XQ4PQRLR7CdEZQvz6gwLQ92K6vVwuGk2QHSEYZe6AEOZ+rVY/JDQQIxvAs5a3fMrNzZZL3U/7VTBK/yGOEYizJczHzw77Q9bNE1I2GjHjuVi9p/Y0IayOzaj8krcb1FJzZ/8M6MoYdd+S0ANz87OT/iFPDAzT5x1tQBfgyKaYniak+ci9ktg3j25FK9t78bD0ou94ASE1JzOeIxzJjiv1uR8wcvR7/9Dofwxx9wKUg9g2Gln0He0JvZmxwuYMofqKW/76wdi8MPpMKT26SSAPoqiSkovTZI2bNSEzWszThEgl6t5Dkj3r3xG+HN1Ar5l+o7Z+imT3r0rN28WEYHSJpwnxm2dRRdSDsXkD6ElCzJw4lMIHvgR0gAM58hAZz/ciQi/b6ewMIcYeZCC19keEmJYQV4Oo+7cpfiNDM7T30zw0Y5WnY23oOonLocHza0KsJVjc0UX0Gd5bBZ9UKb28HupAF8nHS4MDQgzuScJCwn5MiANMnYLTGzFMpXjREbyqVH5dTmi4byLmrZIey8StD/OwD8YNbLr8U4R6z3iMxOBtmk96BHjDAHSfcnGP75ldriDES/FYDOAT5vVwp75o8RtiD7z5ZX+oI73Zy+/wyhRH1+L2aoteQOMnhN4Ou0QRXMa099LOfIAtm2hL8bT1djVUT35qMwh8ilBXtuxs1fINqWfaW0qLS+1SeU18QNLo01cLsjsIwiPGh9XSlJOE6rvsLTEY02iwfEhQPtGsUlxCqO0FOQY8ObiuJDwyg8HuzSenCHcqxzLbSDdu4B1mouGuXUKoDSdBeHQqgLTaDjJxbeUCnyDUvk1m32Kb3fwAeC5MmjCnDVxEiC20mothGuNhOyPUY4uoid2sqBNzE7GVi2fZ6WhZcM9nZobp4lwg+rI8/GwahJ6xoD/oy0ijGq+HXC7WLKd9sXpPKJtfGsvPKaEv/9wbp9Op/JanFGARygYujlqDXM+0x2vgga8kEUe6glBcN9YWEAv5gRi7b7oKRVuZrNP+AuZR0ptiNHHp98TTaCa+7aSvlKgvpQ+ozzvzr29OB9rfjsfjxatXuN3hL9URUVIejL+FRuKz9r2Azjrj8WYnSy0/XX/DRstFesPVDTeVBqDXWCXy/dKTallKpUqVyis5gTw/2Zyy9KBxpDjVHY58zo95Hrvy0ZOuL/Y6bARB2NrqlID3vq4HgT9+wHTQeas1NIc0Oq1W1wjHw3Ld0hqiPUOX3dC8MnSzk9avVwfDtHk+hhrq6uVidIuGd4L2KA9ARIbpxoPv8bNxlYVhcvXU5LGZjibWpZtNzeiejYP7F4KBGTUVRmrOPPaVnxfmF/lyPyQxTNpsfoomhKXBIwMXuUnQtyKUdnTYanHbXhj0VDj/iT+sCXZpUB4QdguE/EdhQ0o+FRGObTaGa35lGQzihNFEnXWjrQmEcxOveM3/nEbZiJT/yNsC4QiIlFgRfjFjfYzwdoMP/vEjGKqZEVPu9924peE40pKHJ2EDizKKMxm4TyyCAFaEH0auiBBdT75wDjx0Fqc33xlEBBnyb7vlc9qyCchTFRGyIvzv8UlInMAfFG99wVjjxAn9UXbSDSTSUdjcKa19ETKLQBLPGitCbGjE0J0vCzhsG+L9Vy1RxY2W5kbvSRYeeX6cjo/86G3XRDV9vZBQVGceUefzxPGLvYhEGYQ3akpFHnYO81APddd+kIexIPRlYYc3eTAsEt4oD0XC8oFJ2ItYlPoQyWm0lvVw9CgkTuClg8fxPufzcWAQ+p4451b10BvxWIx6xSYd6fEiNewj5po1ftaW8ljelDeilPISqwlvvcuSGB5J+nxtjBcmolXfcSMu7bVSq1kUvVXWHxqrRjnhjunPuf5Qdj7clAg9PpGFm3yaUPeHNwtWCNPKfxtz6zThYS9ptEWtRVsMhtW0TdOr+UI80scJm77SAIt7TWrNBzrlQE+87nRakdnSBGt5kn+rfVD04Jkw1Zb8UG7lWiOzS3VLAoVzZvmWhsSiJuYXaXaLvYXNRAR4+IunAAMd+w2V7UHHOOGj2TV8C3tCOf7Pthoo2shBUdO3sJlq8TcCtvGjOA78lW4D6KjdmMZJOOzrjrHra9X4j94m+vOEl9JV9tn31X67AIuJuPIG/UPjnIndxLW/Yjzw8WlxOTnNdn+k2W+kip/pt1c2ruLCqwQrVapUqVKlSpUqVapUqVKlSpUqVapUqVKlH+p/P+kCnnSLhjcAAAAASUVORK5CYII=",gM="/StakeholderMap/assets/RockurstU_Logo-tS39_Eg2.png",yM={...W9,buildings:oM,boundary:cM,logos:{clarkEnersen:H3,university:_M}},vM={...nM,buildings:dM,boundary:mM,logos:{clarkEnersen:H3,university:gM}},xM={hastings:yM,rockhurst:vM};function wM(x){return xM[x]}function bM(){const{universityId:x}=KA(),u=wM(x);return u?ii.jsxs(hT,{children:[ii.jsx(v_,{path:"/admin",element:ii.jsx(B9,{config:u,universityId:x})}),ii.jsx(v_,{path:"/",element:ii.jsx(O9,{config:u,universityId:x})})]}):ii.jsxs("div",{children:['Error: Configuration not found for "',x,'".']})}function TM(){return ii.jsx(L4,{basename:"/StakeholderMap",children:ii.jsxs(hT,{children:[ii.jsx(v_,{path:"/:universityId/*",element:ii.jsx(bM,{})}),ii.jsx(v_,{path:"/",element:ii.jsx("div",{children:"Please select a university (e.g., /hastings or /rockhurst)"})})]})})}const EM=vA.createRoot(document.getElementById("root"));EM.render(ii.jsx(TM,{}));
